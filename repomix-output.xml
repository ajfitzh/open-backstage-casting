This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
app/(main)/(casting)/auditions/page.tsx
app/(main)/(casting)/callbacks/page.tsx
app/(main)/(casting)/casting/page.tsx
app/(main)/(casting)/conflicts/page.tsx
app/(main)/(casting)/layout.tsx
app/(main)/(staff)/committees/page.tsx
app/(main)/(staff)/layout.tsx
app/(main)/(staff)/page.tsx
app/(main)/(staff)/reports/page.tsx
app/(main)/(staff)/roster/page.tsx
app/(main)/education/page.tsx
app/(main)/layout.tsx
app/(main)/loading.tsx
app/(main)/page.tsx
app/(main)/schedule/page.tsx
app/(main)/settings/page.tsx
app/actions.ts
app/api/upload/route.ts
app/components/ActorProfileModal.tsx
app/components/auditions/AuditionsClient.tsx
app/components/casting/CallbackClient.tsx
app/components/casting/CastingClient.tsx
app/components/casting/CastingInspector.tsx
app/components/casting/CastWorkspace.tsx
app/components/casting/ChemistryWorkspace.tsx
app/components/ChoreoWorkspace.tsx
app/components/committees/CommitteeClient.tsx
app/components/ComplianceDashboard.tsx
app/components/ConflictMatrix.tsx
app/components/conflicts/ConflictAnalysisDashboard.tsx
app/components/conflicts/ConflictClient.tsx
app/components/ContextSwitcher.tsx
app/components/education/ClassManager.tsx
app/components/globalappheader/client.tsx
app/components/globalappheader/globalappheader.tsx
app/components/globalappheader/index.tsx
app/components/logo.svg
app/components/logo.tsx
app/components/reports/ReportsClient.tsx
app/components/schedule/SchedulerClient.tsx
app/components/settings/SettingsClient.tsx
app/components/staff/StaffClient.tsx
app/components/StaffSidebar.tsx
app/favicon.ico
app/globals.css
app/layout.tsx
app/lib/baserow.ts
app/lib/CastingContext.tsx
app/lib/educationFillerData.ts
app/lib/permissions.ts
app/login/page.tsx
app/plan.md
app/test-sync/page.tsx
eslint.config.mjs
get-schema.js
lib/CastingContext.tsx
lib/PeopleContext.tsx
lib/types.ts
LICENSE
middleware.ts
next.config.ts
package.json
postcss.config.mjs
public/file.svg
public/globe.svg
public/next.svg
public/vercel.svg
public/window.svg
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="app/api/upload/route.ts">
import { NextResponse } from 'next/server';
import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';

const s3Client = new S3Client({
  region: process.env.DO_SPACES_REGION || "us-east-1",
  endpoint: process.env.DO_SPACES_ENDPOINT,
  credentials: {
    accessKeyId: process.env.DO_SPACES_KEY || "",
    secretAccessKey: process.env.DO_SPACES_SECRET || "",
  },
});

export async function POST(request: Request) {
  try {
    const { filename, fileType } = await request.json();

    // 1. Create a unique file name (e.g., 17156223-video.mp4)
    const uniqueFilename = `${Date.now()}-${filename.replace(/\s/g, '-')}`;

    // 2. Prepare the command
    const command = new PutObjectCommand({
      Bucket: process.env.DO_SPACES_BUCKET,
      Key: uniqueFilename,
      ContentType: fileType,
      ACL: 'public-read', // Makes the video viewable by your staff
    });

    // 3. Generate the Pre-Signed URL (Valid for 60 seconds)
    const uploadUrl = await getSignedUrl(s3Client, command, { expiresIn: 60 });

    // 4. Construct the final public URL for Baserow
    const publicUrl = `${process.env.DO_SPACES_ENDPOINT}/${process.env.DO_SPACES_BUCKET}/${uniqueFilename}`;

    return NextResponse.json({ uploadUrl, publicUrl });
  } catch (error) {
    console.error("Presign Error:", error);
    return NextResponse.json({ error: "Failed to sign URL" }, { status: 500 });
  }
}
</file>

<file path="app/components/ActorProfileModal.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import React, { useState, useMemo } from "react";
import { 
  X, Star, History, Calendar, Ruler, AlertCircle, User, 
  AlertOctagon, Clock, Mic2, Move, FileText, Clapperboard, CheckCircle2
} from "lucide-react";
import { 
  Radar, RadarChart, PolarGrid, PolarAngleAxis, 
  ResponsiveContainer, RadarProps 
} from "recharts";

// Fix for Recharts TS error
const RechartsRadar = Radar as unknown as React.FC<RadarProps>;

interface ActorProfileModalProps {
  actor: any;
  grades: any; // Expected keys: actingNotes, vocalNotes, danceNotes, adminNotes
  onClose: () => void;
}

export default function ActorProfileModal({ actor, grades, onClose }: ActorProfileModalProps) {
  const [activeTab, setActiveTab] = useState<"insights" | "history">("insights");

  // --- CHART DATA ---
  const chartData = [
    { subject: "Vocal", A: grades?.vocal || 0 },
    { subject: "Acting", A: grades?.acting || 0 },
    { subject: "Dance", A: grades?.dance || 0 },
    { subject: "Presence", A: grades?.presence || 0 },
  ];

  // --- DATA HELPERS ---
  const getRolesList = (roles: any) => {
    if (!roles) return ["No previous productions listed"];
    if (Array.isArray(roles)) return roles; 
    if (typeof roles === 'string') return roles.split(',').map((s: string) => s.trim());
    return [String(roles)];
  };

  const pastRolesList = getRolesList(actor.pastRoles);

  return (
    <div className="fixed inset-0 z-[200] bg-black/95 backdrop-blur-sm flex items-center justify-center p-0 md:p-4">
      <div className="bg-zinc-950 w-full h-full md:max-w-4xl md:h-[700px] md:rounded-3xl md:border md:border-white/10 overflow-hidden shadow-2xl flex flex-col md:flex-row relative">
        
        {/* CLOSE BUTTON (Mobile: Top Right floating, Desktop: Inside content area) */}
        <button 
            onClick={onClose} 
            className="absolute top-4 right-4 z-50 p-2 bg-black/50 backdrop-blur rounded-full text-zinc-400 hover:text-white md:hidden"
        >
            <X size={24} />
        </button>

        {/* --- LEFT (MOBILE: TOP): IDENTITY & RADAR --- */}
        <div className="p-6 md:p-8 border-b md:border-b-0 md:border-r border-white/5 bg-zinc-900/50 w-full md:w-[35%] flex flex-row md:flex-col items-center md:justify-start gap-6 shrink-0">
          
          {/* Avatar */}
          <div className="relative w-20 h-20 md:w-32 md:h-32 shrink-0">
            {actor.avatar ? (
              <img 
                src={actor.avatar} 
                alt={actor.name} 
                className="w-full h-full object-cover rounded-2xl border-2 border-white/10 shadow-xl"
              />
            ) : (
              <div className="w-full h-full bg-zinc-800 rounded-2xl flex items-center justify-center border-2 border-dashed border-white/10">
                <User size={32} className="text-zinc-600 md:w-12 md:h-12" />
              </div>
            )}
          </div>
          
          <div className="flex-1 md:w-full md:text-center">
              <h2 className="text-xl md:text-2xl font-black italic uppercase tracking-tight leading-tight">{actor.name}</h2>
              
              {/* Vitals Grid */}
              <div className="flex md:grid md:grid-cols-3 gap-2 mt-2 md:mt-6">
                 <div className="bg-black/40 px-3 py-1 md:p-2 rounded-lg text-center border border-white/5">
                    <p className="text-[8px] md:text-[9px] text-zinc-500 font-black uppercase tracking-widest">Height</p>
                    <p className="text-xs font-bold text-white">{actor.height || "-"}</p>
                 </div>
                 <div className="bg-black/40 px-3 py-1 md:p-2 rounded-lg text-center border border-white/5">
                    <p className="text-[8px] md:text-[9px] text-zinc-500 font-black uppercase tracking-widest">Age</p>
                    <p className="text-xs font-bold text-white">{actor.age}</p>
                 </div>
                 <div className="bg-black/40 px-3 py-1 md:p-2 rounded-lg text-center border border-white/5 hidden md:block">
                    <p className="text-[9px] text-zinc-500 font-black uppercase tracking-widest">Range</p>
                    <p className="text-xs font-bold text-white">{actor.vocalRange || "-"}</p>
                 </div>
              </div>
          </div>

          {/* Radar Chart (Hidden on small phones in landscape, visible on portrait/desktop) */}
          <div className="hidden md:block w-full h-40 mt-auto relative">
             <p className="absolute -top-2 w-full text-[9px] text-center text-zinc-500 font-black uppercase tracking-[0.2em]">Live Analysis</p>
             <ResponsiveContainer width="100%" height="100%">
              <RadarChart cx="50%" cy="55%" outerRadius="70%" data={chartData}>
                <PolarGrid stroke="#27272a" />
                <PolarAngleAxis dataKey="subject" tick={{ fill: '#71717a', fontSize: 10, fontWeight: '900' }} />
                <RechartsRadar dataKey="A" stroke="#3b82f6" fill="#3b82f6" fillOpacity={0.4} />
              </RadarChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* --- RIGHT (MOBILE: BOTTOM): CONTENT AREA --- */}
        <div className="flex-1 flex flex-col bg-zinc-950 relative min-w-0 overflow-hidden">
          
          {/* Desktop Close Button */}
          <button onClick={onClose} className="absolute top-6 right-6 text-zinc-500 hover:text-white z-10 transition-colors hidden md:block">
            <X size={20} />
          </button>

          {/* Tabs */}
          <div className="flex border-b border-white/5 p-4 gap-4 shrink-0 bg-zinc-950 sticky top-0 z-10">
            <button 
              onClick={() => setActiveTab("insights")}
              className={`pb-2 text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'insights' ? 'text-white border-b-2 border-blue-500' : 'text-zinc-500 hover:text-zinc-300'}`}
            >
              Casting Insights
            </button>
            <button 
              onClick={() => setActiveTab("history")}
              className={`pb-2 text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'history' ? 'text-white border-b-2 border-blue-500' : 'text-zinc-500 hover:text-zinc-300'}`}
            >
              Bio & Logistics
            </button>
          </div>

          <div className="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar pb-24 md:pb-8">
            {activeTab === "insights" ? (
              <div className="space-y-6 md:space-y-8">
                
                {/* 1. Song & Monologue Info */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="p-3 bg-zinc-900 rounded-xl border border-white/5">
                    <p className="text-[9px] font-black text-purple-400 uppercase mb-1 tracking-tighter">Planned Song</p>
                    <p className="text-xs font-bold text-zinc-300 line-clamp-1">{actor.song}</p>
                  </div>
                  <div className="p-3 bg-zinc-900 rounded-xl border border-white/5">
                    <p className="text-[9px] font-black text-emerald-400 uppercase mb-1 tracking-tighter">Monologue</p>
                    <p className="text-xs font-bold text-zinc-300 line-clamp-1">{actor.monologue}</p>
                  </div>
                </div>

                {/* 2. FEEDBACK GRID */}
                <section>
                   <div className="flex items-center gap-2 text-zinc-400 mb-4">
                    <Star size={14} className="text-blue-500" />
                    <span className="text-[10px] font-black uppercase tracking-widest">Panel Feedback</span>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {/* Acting Notes */}
                    <div className="bg-zinc-900/40 p-4 rounded-xl border border-white/5 hover:bg-zinc-900/60 transition-colors">
                        <div className="flex items-center gap-2 mb-2">
                            <Clapperboard size={12} className="text-blue-400" />
                            <p className="text-[10px] font-bold text-blue-400 uppercase">Director (Acting)</p>
                        </div>
                        <p className="text-xs text-zinc-300 italic leading-relaxed">
                            "{grades?.actingNotes || "No notes logged."}"
                        </p>
                    </div>

                    {/* Vocal Notes */}
                    <div className="bg-zinc-900/40 p-4 rounded-xl border border-white/5 hover:bg-zinc-900/60 transition-colors">
                        <div className="flex items-center gap-2 mb-2">
                            <Mic2 size={12} className="text-purple-400" />
                            <p className="text-[10px] font-bold text-purple-400 uppercase">Musical Director</p>
                        </div>
                        <p className="text-xs text-zinc-300 italic leading-relaxed">
                            "{grades?.vocalNotes || "No notes logged."}"
                        </p>
                    </div>

                    {/* Dance Notes */}
                    <div className="bg-zinc-900/40 p-4 rounded-xl border border-white/5 hover:bg-zinc-900/60 transition-colors">
                        <div className="flex items-center gap-2 mb-2">
                            <Move size={12} className="text-emerald-400" />
                            <p className="text-[10px] font-bold text-emerald-400 uppercase">Choreographer</p>
                        </div>
                        <p className="text-xs text-zinc-300 italic leading-relaxed">
                            "{grades?.choreoNotes || "No notes logged."}"
                        </p>
                    </div>

                    {/* Admin/Drop-In */}
                    <div className="bg-zinc-900/40 p-4 rounded-xl border border-white/5 hover:bg-zinc-900/60 transition-colors">
                        <div className="flex items-center gap-2 mb-2">
                            <FileText size={12} className="text-amber-400" />
                            <p className="text-[10px] font-bold text-amber-400 uppercase">Admin / Drop-In</p>
                        </div>
                        <p className="text-xs text-zinc-300 italic leading-relaxed">
                            "{grades?.adminNotes || "No flags."}"
                        </p>
                    </div>
                  </div>
                </section>

                {/* 3. CONFLICTS DASHBOARD */}
                <section className="pt-2">
                  <h4 className="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                    <AlertCircle size={14} /> Schedule Conflicts
                  </h4>
                  <ConflictAnalyzer conflicts={actor.conflicts} />
                </section>

              </div>
            ) : (
              <div className="space-y-8">
                {/* Bio Details */}
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-zinc-900 p-4 rounded-2xl border border-white/5">
                    <p className="text-[10px] font-black text-zinc-500 uppercase flex items-center gap-2 mb-1">
                      <Calendar size={12} /> Birthdate
                    </p>
                    <p className="text-sm font-bold text-white">{actor.dob || "N/A"}</p>
                  </div>
                  <div className="bg-zinc-900 p-4 rounded-2xl border border-white/5">
                    <p className="text-[10px] font-black text-zinc-500 uppercase flex items-center gap-2 mb-1">
                      <Ruler size={12} /> CYT Experience
                    </p>
                    <p className="text-sm font-bold text-white">{actor.tenure}</p>
                  </div>
                </div>

                {/* History */}
                <section>
                  <h4 className="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                    <History size={14} /> Production History
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {pastRolesList.map((role: string, i: number) => (
                      <div key={i} className="text-[11px] bg-zinc-900 text-zinc-300 px-3 py-2 rounded-lg border border-white/5 font-bold">
                        {role}
                      </div>
                    ))}
                  </div>
                </section>
              </div>
            )}
          </div>

          <div className="p-4 md:p-6 border-t border-white/5 bg-zinc-900/20 shrink-0 absolute bottom-0 w-full md:relative">
            <button 
              onClick={onClose}
              className="w-full bg-white text-black py-4 rounded-2xl font-black uppercase text-[10px] tracking-[0.2em] hover:invert transition-all active:scale-[0.98]"
            >
              Return to Deck
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// --- SUB-COMPONENT: SMART CONFLICT ANALYZER ---
function ConflictAnalyzer({ conflicts }: { conflicts: any }) {
  const data = useMemo(() => {
    let rawList: string[] = [];
    if (Array.isArray(conflicts)) {
        rawList = conflicts.map(c => typeof c === 'object' ? c.value : String(c));
    } else if (typeof conflicts === 'string') {
        rawList = conflicts.split(',').map(s => s.trim()).filter(Boolean);
    }

    if (rawList.length === 0 || (rawList.length === 1 && rawList[0].toLowerCase().includes("no known"))) {
        return { severe: 0, minor: 0, items: [] };
    }

    const items = rawList.map((str, i) => {
        const lower = str.toLowerCase();
        const isSevere = lower.includes("absent") || lower.includes("missing") || lower.includes("vacation") || lower.includes("out of town");
        const isMinor = lower.includes("late") || lower.includes("early") || lower.includes("leave") || lower.includes("tardy");
        
        return {
            id: i,
            text: str,
            severity: isSevere ? 'severe' : (isMinor ? 'minor' : 'unknown')
        };
    });

    return { 
        severe: items.filter(i => i.severity === 'severe').length, 
        minor: items.filter(i => i.severity !== 'severe').length, 
        items 
    };
  }, [conflicts]);

  if (data.items.length === 0) {
      return (
        <div className="p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-2xl flex items-center gap-3">
            <CheckCircle2 size={18} className="text-emerald-500" />
            <p className="text-xs font-bold text-emerald-400">No known conflicts</p>
        </div>
      );
  }

  return (
    <div className="space-y-4">
        {/* Summary Dashboard */}
        <div className="flex gap-3">
            <div className={`flex-1 p-3 rounded-xl border flex items-center gap-3 ${data.severe > 0 ? 'bg-red-500/10 border-red-500/30' : 'bg-zinc-900 border-white/5'}`}>
                <div className={`p-2 rounded-lg ${data.severe > 0 ? 'bg-red-500 text-white' : 'bg-zinc-800 text-zinc-500'}`}>
                    <AlertOctagon size={16} />
                </div>
                <div>
                    <p className="text-[10px] uppercase font-black tracking-widest opacity-60">Severe</p>
                    <p className={`text-xl font-black leading-none ${data.severe > 0 ? 'text-red-400' : 'text-zinc-600'}`}>{data.severe}</p>
                </div>
            </div>

            <div className={`flex-1 p-3 rounded-xl border flex items-center gap-3 ${data.minor > 0 ? 'bg-amber-500/10 border-amber-500/30' : 'bg-zinc-900 border-white/5'}`}>
                <div className={`p-2 rounded-lg ${data.minor > 0 ? 'bg-amber-500 text-black' : 'bg-zinc-800 text-zinc-500'}`}>
                    <Clock size={16} />
                </div>
                <div>
                    <p className="text-[10px] uppercase font-black tracking-widest opacity-60">Minor</p>
                    <p className={`text-xl font-black leading-none ${data.minor > 0 ? 'text-amber-400' : 'text-zinc-600'}`}>{data.minor}</p>
                </div>
            </div>
        </div>

        {/* Detailed List */}
        <div className="bg-zinc-900/50 border border-white/5 rounded-xl overflow-hidden">
            <div className="px-4 py-2 bg-zinc-900 border-b border-white/5">
                <p className="text-[9px] uppercase font-bold text-zinc-500">Conflict Details</p>
            </div>
            <div className="max-h-[120px] overflow-y-auto p-2 space-y-1 custom-scrollbar">
                {data.items.map((item) => (
                    <div key={item.id} className="flex items-start gap-2 p-2 rounded hover:bg-white/5 transition-colors">
                        <div className={`mt-1 w-1.5 h-1.5 rounded-full flex-shrink-0 ${item.severity === 'severe' ? 'bg-red-500' : 'bg-amber-500'}`} />
                        <p className="text-xs text-zinc-300 leading-snug">{item.text}</p>
                    </div>
                ))}
            </div>
        </div>
    </div>
  );
}
</file>

<file path="app/components/casting/CastingInspector.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import { useState } from "react";
import { X, CheckCircle2, Mic2, Move, FileText, ExternalLink, Clock } from "lucide-react";
import ActorProfileModal from "@/app/components/ActorProfileModal";

// Helper to generate consistent colors for roles
const getRoleColor = (roleName: string) => {
  if (!roleName) return "bg-zinc-800 border-zinc-700";
  const name = roleName.toLowerCase();
  if (name.includes("ariel") || name.includes("lead")) return "bg-blue-500 border-blue-400 shadow-[0_0_10px_rgba(59,130,246,0.4)]";
  if (name.includes("ursula") || name.includes("villain")) return "bg-purple-600 border-purple-400 shadow-[0_0_10px_rgba(147,51,234,0.4)]";
  if (name.includes("ensemble")) return "bg-emerald-600 border-emerald-400";
  if (name.includes("new role")) return "bg-amber-600 border-amber-400";
  // Default hash-like fallback
  const colors = [
    "bg-cyan-600 border-cyan-400", 
    "bg-indigo-600 border-indigo-400", 
    "bg-pink-600 border-pink-400",
    "bg-lime-600 border-lime-400"
  ];
  return colors[roleName.length % colors.length];
};

export default function CastingInspector({ actor, allScenes, stats, onClose }: any) {
  const [showFullProfile, setShowFullProfile] = useState(false);

  if (!actor) return null;

  return (
    <>
      {/* MOBILE: Fixed full screen overlay (z-50)
          DESKTOP: Relative sidebar (z-20) 
      */}
      <div className="fixed inset-0 md:static md:inset-auto z-50 md:z-20 w-full md:w-[350px] h-full flex flex-col bg-zinc-900 md:border-l border-white/5 shadow-2xl transition-all">
        
        {/* HEADER */}
        <div className="p-6 pb-4 border-b border-white/5 relative bg-zinc-900 z-10 shrink-0">
          <button onClick={onClose} className="absolute top-4 right-4 text-zinc-500 hover:text-white transition-colors p-2 bg-black/20 rounded-full md:bg-transparent"><X size={20} /></button>
          
          <div className="flex items-start gap-4">
             <div className="w-16 h-16 rounded-full overflow-hidden border-2 border-white/10 shrink-0">
               <img src={actor.Headshot} className="w-full h-full object-cover" />
             </div>
             <div>
                <h2 className="text-lg font-black text-white leading-tight">{actor.Performer}</h2>
                <div className="flex items-center gap-2 mt-1">
                    {actor.Gender && actor.Gender !== "N/A" && (
                        <span className="px-2 py-0.5 bg-zinc-800 text-zinc-400 text-[10px] font-bold uppercase rounded border border-white/5">{actor.Gender}</span>
                    )}
                    <span className="px-2 py-0.5 bg-zinc-800 text-zinc-400 text-[10px] font-bold uppercase rounded border border-white/5">{actor.Age || "Age ?"}</span>
                </div>
                <div className="flex gap-2 mt-3">
                   {actor.grades?.actingNotes && <FileText size={14} className="text-blue-500" title="Has Acting Notes" />}
                   {actor.grades?.vocalNotes && <Mic2 size={14} className="text-purple-500" title="Has Vocal Notes" />}
                   {actor.grades?.danceNotes && <Move size={14} className="text-emerald-500" title="Has Dance Notes" />}
                </div>
             </div>
          </div>
        </div>

        {/* SCROLLABLE TIMELINE BODY */}
        <div className="flex-1 overflow-y-auto custom-scrollbar relative bg-zinc-950/50">
            {/* Timeline Line */}
            <div className="absolute left-[27px] top-0 bottom-0 w-px bg-white/5 z-0" />

            <div className="p-4 space-y-1 relative z-10">
                 {allScenes.map((scene: any) => {
                     const roleInScene = stats.assignments[scene.id];
                     const isCast = !!roleInScene;
                     const isConflict = roleInScene && roleInScene.includes('+'); 
                     const dotColor = isConflict ? "bg-red-500 border-red-400 animate-pulse" : getRoleColor(roleInScene);

                     return (
                         <div 
                            key={scene.id} 
                            className={`group flex items-center gap-3 py-2 px-2 rounded-lg transition-all
                                ${isCast ? 'bg-zinc-800/80 border border-white/10 my-1 shadow-sm' : 'opacity-40 hover:opacity-80 hover:bg-white/5'}`
                            }
                         >
                             <div className="w-8 flex flex-col items-end shrink-0">
                                 <span className={`text-[9px] font-black uppercase ${isCast ? 'text-white' : 'text-zinc-600'}`}>{scene.Act}</span>
                             </div>

                             <div className={`w-3 h-3 rounded-full border-2 shrink-0 transition-transform ${isCast ? dotColor : 'bg-zinc-900 border-zinc-700'}`} />

                             <div className="min-w-0 flex-1">
                                 <div className="flex justify-between items-baseline">
                                     <p className={`text-xs font-bold truncate ${isCast ? 'text-zinc-200' : 'text-zinc-500'}`}>{scene["Scene Name"]}</p>
                                     {!isCast && <span className="text-[9px] text-zinc-700 uppercase hidden group-hover:block">{scene["Scene Type"]}</span>}
                                 </div>
                                 
                                 {isCast && (
                                     <div className="flex items-center gap-1.5 mt-0.5 animate-in slide-in-from-left-2 duration-300">
                                         <span className={`text-[9px] font-black uppercase px-1.5 rounded-sm bg-zinc-950 text-white border border-white/5 truncate max-w-full ${isConflict ? 'text-red-400 border-red-500/30' : ''}`}>
                                            {roleInScene}
                                         </span>
                                         {isConflict && <Clock size={10} className="text-red-500" />}
                                     </div>
                                 )}
                             </div>
                         </div>
                     );
                 })}
            </div>
            <div className="h-20" />
        </div>

        {/* FOOTER ACTIONS */}
        <div className="p-4 border-t border-white/5 bg-zinc-900 z-20 shrink-0 space-y-3 pb-safe">
             {stats.assignedRoleNames.length > 0 && (
                <div className="flex flex-wrap gap-1.5 pb-2">
                    {stats.assignedRoleNames.map((role: string) => (
                        <span key={role} className="text-[9px] font-bold text-zinc-300 bg-zinc-800 px-2 py-1 rounded border border-white/5 flex items-center gap-1">
                            <div className={`w-1.5 h-1.5 rounded-full ${getRoleColor(role).split(' ')[0]}`} />
                            {role}
                        </span>
                    ))}
                </div>
             )}

            <button 
                onClick={() => setShowFullProfile(true)}
                className="w-full flex items-center justify-center gap-2 py-3 bg-white text-black text-xs font-black uppercase tracking-widest rounded-xl hover:scale-[1.02] active:scale-[0.98] transition-all"
            >
                <ExternalLink size={14} />
                View Full Profile
            </button>
        </div>

      </div>

      {/* MODAL (Now matches Callback Logic EXACTLY) */}
      {showFullProfile && (
        <ActorProfileModal 
          actor={{
            ...actor,
            name: actor.Performer,  // Modal expects 'name', we have 'Performer'
            avatar: actor.Headshot, // Modal expects 'avatar', we have 'Headshot'
          }}
          grades={actor.grades} 
          onClose={() => setShowFullProfile(false)}
        />
      )}
    </>
  );
}
</file>

<file path="app/components/casting/CastWorkspace.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import { Plus, Trash2, X, Copy } from "lucide-react";

interface Props {
  roles: any[];
  scenes: any[];
  onAddRole: () => void;
  onRemoveRole: (id: string) => void;
  onDuplicateRole: (id: string) => void;
  onDropActor: (e: React.DragEvent, roleId: string) => void;
  onRemoveActor: (roleId: string, actorId: number) => void;
  onToggleScene: (roleId: string, sceneId: number) => void;
  onSelectRole: (role: any) => void;
  onConfirmRole: (roleId: string, actorId: number) => void;
}

export default function CastWorkspace({ 
  roles, scenes, onAddRole, onRemoveRole, onDuplicateRole, onDropActor, onRemoveActor, onToggleScene, onSelectRole, onConfirmRole 
}: Props) {

  const safeString = (val: any): string => {
    if (val === null || val === undefined) return "";
    if (typeof val === 'string') return val;
    if (typeof val === 'number') return String(val);
    if (Array.isArray(val)) return val.length > 0 ? safeString(val[0].value || val[0]) : "";
    if (typeof val === 'object') return val.value ? safeString(val.value) : "";
    return String(val);
  };

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  };

  const getSceneColor = (type: string) => {
    const t = String(type).toLowerCase();
    if (t.includes('song')) return 'bg-blue-500 border-blue-400';
    if (t.includes('dance')) return 'bg-purple-500 border-purple-400';
    return 'bg-emerald-600 border-emerald-500'; 
  };

  return (
    <main className="bg-zinc-950 flex flex-col overflow-hidden relative h-full">
      <header className="p-4 border-b border-white/5 bg-zinc-900/80 backdrop-blur-md z-10 flex justify-between items-center shrink-0">
        <div className="flex items-center gap-4">
            <h1 className="text-xl font-black italic uppercase hidden md:block">Cast Grid</h1>
            <div className="flex items-center gap-3 px-3 py-1 bg-zinc-900 rounded-full border border-white/5 overflow-x-auto">
                <div className="flex items-center gap-1.5 shrink-0"><div className="w-2 h-2 rounded-full bg-emerald-500"></div><span className="text-[9px] font-bold text-zinc-400 uppercase">Scene</span></div>
                <div className="flex items-center gap-1.5 shrink-0"><div className="w-2 h-2 rounded-full bg-blue-500"></div><span className="text-[9px] font-bold text-zinc-400 uppercase">Song</span></div>
                <div className="flex items-center gap-1.5 shrink-0"><div className="w-2 h-2 rounded-full bg-purple-500"></div><span className="text-[9px] font-bold text-zinc-400 uppercase">Dance</span></div>
            </div>
        </div>

        <button onClick={onAddRole} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wide transition-all shadow-lg shadow-blue-900/20">
           <Plus size={14} /> <span className="hidden md:inline">Add Role</span>
        </button>
      </header>

      <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
        <div className="space-y-4 pb-20">
            <div className="grid grid-cols-[140px_1fr_30px] md:grid-cols-[280px_1fr_30px] gap-4 mb-2 sticky top-0 z-20 pr-2">
                <div className="bg-zinc-950/80 backdrop-blur-sm rounded-lg"></div> 
                <div className="flex gap-0.5 h-8">
                    {scenes.map((scene, i) => (
                        <div key={scene.id} className="flex-1 min-w-0 group relative bg-zinc-800 border border-white/5 hover:bg-zinc-700 transition-colors cursor-help rounded-sm flex flex-col items-center justify-end pb-1">
                            <span className="text-[9px] font-bold text-zinc-500 group-hover:text-white truncate px-0.5">{i + 1}</span>
                            <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max max-w-[180px] hidden group-hover:block bg-black border border-white/20 text-white text-[10px] p-2 rounded shadow-2xl z-50 pointer-events-none">
                                <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-black border-t border-l border-white/20 rotate-45"></div>
                                <p className="font-bold text-blue-200">{safeString(scene["Scene Name"])}</p>
                                <div className="h-px bg-white/10 my-1"></div>
                                <div className="flex justify-between gap-4 text-[9px] text-zinc-400">
                                    <span>{safeString(scene.Act)}</span>
                                    <span className={`${getSceneColor(safeString(scene["Scene Type"])).split(' ')[0]} bg-clip-text text-transparent font-black uppercase`}>{safeString(scene["Scene Type"])}</span>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
                <div></div> 
            </div>

            {roles.map((role) => (
                <div key={role.id} className="group grid grid-cols-[140px_1fr_30px] md:grid-cols-[280px_1fr_30px] gap-4 p-2 bg-zinc-900/30 border border-white/5 rounded-xl hover:bg-zinc-900 transition-all items-start">
                    
                    {/* LEFT: ROLE CARD */}
                    <div 
                        onDragOver={handleDragOver}
                        onDrop={(e) => onDropActor(e, role.id)}
                        onClick={() => onSelectRole(role)}
                        className={`min-h-[4rem] rounded-lg border-2 border-dashed transition-all cursor-pointer flex flex-col p-2 gap-2 relative
                             ${role.actors.length > 0 ? 'bg-zinc-800 border-white/10' : 'bg-black/20 border-white/5 hover:border-blue-500/50 hover:bg-blue-500/5'}
                             ${role.selectedActorIds.length > 0 ? 'ring-1 ring-purple-500/50' : ''}
                        `}
                    >
                         <div className="flex justify-between items-center mb-1">
                            <span className="text-xs font-black uppercase text-zinc-400 truncate max-w-[120px] md:max-w-[180px]" title={safeString(role.name)}>{safeString(role.name)}</span>
                            <span className="text-[9px] font-bold px-1.5 rounded bg-black/40 text-zinc-500 shrink-0 hidden md:block">{role.sceneIds.length} Scn</span>
                         </div>

                        <div className="flex flex-wrap gap-1.5">
                            {role.actors.length === 0 && <p className="text-[10px] text-zinc-600 italic py-1 w-full text-center hidden md:block">Drag actors here...</p>}
                            
                            {role.actors.map((actor: any) => {
                                const isSelected = role.selectedActorIds.includes(actor.id);
                                return (
                                    <div 
                                        key={actor.id} 
                                        onClick={(e) => { e.stopPropagation(); onConfirmRole(role.id, actor.id); }} 
                                        className={`flex items-center gap-1.5 rounded-full pr-2 pl-1 py-0.5 shadow-sm max-w-full cursor-pointer transition-all border
                                            ${isSelected 
                                                ? 'bg-purple-600 border-purple-400 text-white shadow-lg shadow-purple-900/50' 
                                                : 'bg-zinc-900 border-white/10 text-zinc-400 hover:border-white/30 hover:text-white'
                                            }
                                        `}
                                        title={isSelected ? "Cast (Click to Uncast)" : "Candidate (Click to Cast)"}
                                    >
                                        <img src={actor.Headshot || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-4 h-4 rounded-full object-cover shrink-0" />
                                        <span className="text-[9px] font-bold truncate max-w-[60px] md:max-w-full">{safeString(actor.Performer)}</span>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); onRemoveActor(role.id, actor.id); }}
                                            className={`hover:text-red-400 shrink-0 ${isSelected ? 'text-purple-200' : 'text-zinc-500'}`}
                                        >
                                            <X size={10} />
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* MIDDLE: BARCODE */}
                    <div className="flex gap-0.5 h-auto min-h-[4rem] relative bg-zinc-950/30 p-1 rounded-lg border border-white/5">
                        {scenes.map((scene) => {
                            const isActive = role.sceneIds.includes(scene.id);
                            return (
                                <button
                                    key={scene.id}
                                    onClick={() => onToggleScene(role.id, scene.id)}
                                    className={`flex-1 min-w-0 transition-all rounded-sm relative overflow-hidden border
                                        ${isActive ? `opacity-100 ${getSceneColor(safeString(scene["Scene Type"]))}` : 'bg-zinc-800/30 border-white/5 hover:bg-zinc-700/50 hover:border-white/20'}
                                    `}
                                >
                                    {isActive && <div className="absolute inset-0 bg-gradient-to-b from-white/30 to-transparent"></div>}
                                </button>
                            );
                        })}
                    </div>
                    
                    <div className="flex flex-col gap-1 items-center opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity pt-1">
                         <button onClick={() => onDuplicateRole(role.id)} className="p-1.5 text-zinc-500 hover:text-blue-400 hover:bg-blue-500/10 rounded"><Copy size={14} /></button>
                        <button onClick={() => onRemoveRole(role.id)} className="p-1.5 text-zinc-500 hover:text-red-500 hover:bg-red-500/10 rounded"><Trash2 size={14} /></button>
                    </div>
                </div>
            ))}
        </div>
      </div>
    </main>
  );
}
</file>

<file path="app/components/ChoreoWorkspace.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import React, { useState, useEffect, useRef, useMemo } from "react";
import { 
  ArrowLeft, ArrowRight, Move, 
  AlertTriangle, Star, Zap, Smile, ThumbsUp, MessageSquare,
  Video, Users, Loader2, RefreshCw, ChevronDown, Trash2, Eraser
} from "lucide-react";

// --- CONFIG ---
const STANDARD_TAGS = [
  { id: "#Featured", label: "Featured", icon: Star, color: "bg-purple-600 border-purple-400" },
  { id: "#Tap", label: "Tap", icon: Zap, color: "bg-blue-600 border-blue-400" },
  { id: "#Acro", label: "Acro", icon: Move, color: "bg-emerald-600 border-emerald-400" },
];

const LEVELS = [
  { val: 2, label: "Non-Mover", color: "bg-zinc-800 text-zinc-400 border-zinc-600" },
  { val: 3, label: "Mover", color: "bg-blue-900/30 text-blue-300 border-blue-500/50" },
  { val: 4, label: "Dancer", color: "bg-purple-900/30 text-purple-300 border-purple-500/50" },
  { val: 5, label: "Advanced", color: "bg-emerald-900/30 text-emerald-300 border-emerald-500/50" },
];

export default function ChoreoWorkspace({ 
  people, 
  initialGrades, 
  onSave 
}: { 
  people: any[]; 
  initialGrades: any; 
  onSave: (id: number, score: number, tags: string, videoUrl?: string) => void;
}) {
  // --- STATE ---
  const [activeSlot, setActiveSlot] = useState<string>("");
  const [viewMode, setViewMode] = useState<'group' | 'grade'>('group');
  const [selectedIndex, setSelectedIndex] = useState(0);
  const [localNotes, setLocalNotes] = useState("");
  
  // UPLOAD STATE
  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState("0%");

  // SWIPE REFS
  const touchStartX = useRef<number | null>(null);
  const touchEndX = useRef<number | null>(null);

  // --- GROUPING LOGIC ---
  const groupedPeople = useMemo(() => {
      const groups: Record<string, any[]> = {};
      people.forEach(p => {
          const slot = p.timeSlot || "Unscheduled";
          if (!groups[slot]) groups[slot] = [];
          groups[slot].push(p);
      });
      return groups;
  }, [people]);

  const slots = Object.keys(groupedPeople).sort();
  
  useEffect(() => {
      if (slots.length > 0 && !activeSlot) setActiveSlot(slots[0]);
  }, [slots, activeSlot]);

  const currentGroup = groupedPeople[activeSlot] || [];
  const activeStudent = currentGroup[selectedIndex];
  const activeGrade = initialGrades[activeStudent?.id] || {};

  const groupVideoUrl = currentGroup.length > 0 
      ? (initialGrades[currentGroup[0].id]?.video || currentGroup[0].video) 
      : null;

  useEffect(() => {
      setLocalNotes(activeGrade.choreoNotes || "");
  }, [activeStudent?.id, activeGrade.choreoNotes]);


  // --- ACTIONS ---
  const handleScore = (score: number) => onSave(activeStudent.id, score, localNotes);
  
  // NEW: Full Reset Handler
  const handleClear = () => {
      setLocalNotes(""); // Wipe text UI
      onSave(activeStudent.id, 0, ""); // Wipe DB
  };

  const handleManualNoteChange = (text: string) => setLocalNotes(text);
  const saveNotes = () => onSave(activeStudent.id, activeGrade.dance || 0, localNotes);

  const handleToggleTag = (tag: string) => {
    let newNotes = localNotes;
    if (newNotes.includes(tag)) newNotes = newNotes.replace(tag, "").trim();
    else newNotes = `${newNotes} ${tag}`.trim();
    setLocalNotes(newNotes); 
    onSave(activeStudent.id, activeGrade.dance || 0, newNotes); 
  };

  const handleAttitudeCycle = () => {
    let newNotes = localNotes;
    if (newNotes.includes("#GreatAttitude")) newNotes = newNotes.replace("#GreatAttitude", "#BadAttitude");
    else if (newNotes.includes("#BadAttitude")) newNotes = newNotes.replace("#BadAttitude", "").trim();
    else newNotes = `${newNotes} #GreatAttitude`.trim();
    setLocalNotes(newNotes);
    onSave(activeStudent.id, activeGrade.dance || 0, newNotes);
  };

  const getAttitudeState = () => {
      if (localNotes.includes("#GreatAttitude")) return "good";
      if (localNotes.includes("#BadAttitude")) return "bad";
      return "none";
  };
  const attState = getAttitudeState();

  const handleBatchVideoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
      const file = e.target.files?.[0];
      if (!file) return;
      setIsUploading(true);
      setUploadProgress("Start");
      try {
          const res = await fetch('/api/upload', {
              method: 'POST',
              body: JSON.stringify({ filename: `GROUP-${activeSlot}-${file.name}`, fileType: file.type }),
          });
          if (!res.ok) throw new Error("Failed to sign");
          const { uploadUrl, publicUrl } = await res.json();

          setUploadProgress("Uploading...");
          const uploadRes = await fetch(uploadUrl, {
              method: 'PUT',
              body: file,
              headers: { "Content-Type": file.type, "x-amz-acl": "public-read" },
          });
          if (!uploadRes.ok) throw new Error("Upload failed");

          alert("Video Uploaded! Linking to all dancers in this group...");
          currentGroup.forEach(student => {
              const oldNotes = initialGrades[student.id]?.choreoNotes || "";
              const oldScore = initialGrades[student.id]?.dance || 0;
              if (!oldNotes.includes(publicUrl)) {
                  const newNotes = `${oldNotes} [GROUP VIDEO]`.trim();
                  onSave(student.id, oldScore, newNotes, publicUrl);
              }
          });
      } catch (err) {
          console.error(err);
          alert("Upload failed. Use Camera Roll.");
      } finally {
          setIsUploading(false);
          setUploadProgress("0%");
      }
  };

  const handleDeleteVideo = () => {
      if(!confirm("Delete this group video? This cannot be undone.")) return;
      currentGroup.forEach(student => {
          const oldScore = initialGrades[student.id]?.dance || 0;
          const oldNotes = initialGrades[student.id]?.choreoNotes || "";
          const cleanNotes = oldNotes.replace("[GROUP VIDEO]", "").trim();
          onSave(student.id, oldScore, cleanNotes, "DELETE");
      });
  };

  const changeStudent = (delta: number) => {
      const newIndex = selectedIndex + delta;
      if (newIndex >= 0 && newIndex < currentGroup.length) setSelectedIndex(newIndex);
  };

  const handleTouchStart = (e: React.TouchEvent) => { touchStartX.current = e.targetTouches[0].clientX; };
  const handleTouchMove = (e: React.TouchEvent) => { touchEndX.current = e.targetTouches[0].clientX; };
  const handleTouchEnd = () => {
      if (!touchStartX.current || !touchEndX.current) return;
      const distance = touchStartX.current - touchEndX.current;
      if (distance > 50) changeStudent(1);
      if (distance < -50) changeStudent(-1);
      touchStartX.current = null;
      touchEndX.current = null;
  };

  if (!activeSlot) return <div className="p-8 text-center text-zinc-500">Loading Groups...</div>;

  return (
    <div className="flex flex-col h-full bg-black overflow-hidden relative">
      
      {/* 0. TIME SLOTS */}
      <div className={`h-14 bg-zinc-900 border-b border-white/5 flex items-center px-2 gap-2 overflow-x-auto shrink-0 custom-scrollbar transition-all duration-300 ${viewMode === 'grade' ? 'h-0 opacity-0 overflow-hidden border-none' : ''}`}>
          {slots.map((slot) => {
              const isActive = slot === activeSlot;
              const count = groupedPeople[slot].length;
              return (
                  <button
                    key={slot}
                    onClick={() => { setActiveSlot(slot); setViewMode('group'); setSelectedIndex(0); }}
                    className={`px-4 py-2 rounded-full text-[11px] font-black uppercase whitespace-nowrap transition-all flex-shrink-0 flex flex-col items-center leading-none gap-1
                        ${isActive ? 'bg-blue-600 text-white shadow-lg' : 'bg-zinc-800 text-zinc-500 border border-white/5'}
                    `}
                  >
                      <span>{slot}</span>
                      <span className={`text-[8px] ${isActive ? 'text-blue-200' : 'text-zinc-600'}`}>{count} Dancers</span>
                  </button>
              )
          })}
      </div>

      {/* === PERSISTENT VIDEO PLAYER === */}
      <div className={`w-full bg-black border-b border-white/10 shrink-0 relative transition-all duration-500 ease-in-out
          ${viewMode === 'group' ? 'flex-1 max-h-[40vh]' : 'h-36 md:h-64'}
      `}>
          {groupVideoUrl ? (
              <div className="relative w-full h-full group">
                  <video 
                      src={groupVideoUrl} 
                      controls 
                      playsInline
                      className="w-full h-full object-contain bg-zinc-950"
                  />
                  <div className="absolute top-2 right-2 flex gap-2 z-10">
                     <label className="flex items-center gap-2 bg-black/60 hover:bg-black/80 backdrop-blur text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase cursor-pointer border border-white/10 transition-colors">
                         <RefreshCw size={12} /> Retake
                         <input type="file" accept="video/*" capture="environment" className="hidden" onChange={handleBatchVideoUpload} disabled={isUploading} />
                     </label>
                     <button 
                        onClick={handleDeleteVideo}
                        className="flex items-center gap-2 bg-red-600/80 hover:bg-red-600 backdrop-blur text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase cursor-pointer border border-white/10 transition-colors"
                     >
                         <Trash2 size={12} /> Delete
                     </button>
                  </div>
              </div>
          ) : (
              <label className={`w-full h-full flex flex-col items-center justify-center gap-3 transition-all cursor-pointer bg-zinc-900 ${isUploading ? 'opacity-50 cursor-wait' : ''}`}>
                  {isUploading ? (
                      <>
                        <Loader2 size={32} className="text-blue-500 animate-spin" />
                        <span className="text-blue-500 font-black uppercase tracking-widest text-xs">{uploadProgress}</span>
                      </>
                  ) : (
                      <>
                        <div className="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center shadow-lg shadow-red-900/40">
                            <Video size={24} className="text-white" />
                        </div>
                        <div className="text-center">
                            <p className="text-white font-black uppercase tracking-wider text-xs">Record Group Video</p>
                        </div>
                        <input type="file" accept="video/*" capture="environment" className="hidden" onChange={handleBatchVideoUpload} disabled={isUploading} />
                      </>
                  )}
              </label>
          )}

          {viewMode === 'grade' && (
              <button 
                  onClick={() => setViewMode('group')}
                  className="absolute top-2 left-2 z-20 flex items-center gap-1 text-white text-[10px] font-black uppercase bg-black/60 px-3 py-1.5 rounded-full backdrop-blur border border-white/10 hover:bg-black/80"
              >
                  <ChevronDown size={12} /> Show Roster
              </button>
          )}
      </div>

      {/* === CONTENT AREA === */}
      <div className="flex-1 overflow-y-auto relative bg-zinc-950 flex flex-col">
          
          {viewMode === 'group' && (
              <div className="p-4">
                  <div className="flex justify-between items-end mb-3">
                      <h3 className="text-zinc-400 font-black uppercase text-xs tracking-widest flex items-center gap-2">
                          <Users size={14} /> {activeSlot} Roster
                      </h3>
                      {currentGroup.length > 0 && (
                          <button 
                            onClick={() => { setSelectedIndex(0); setViewMode('grade'); }} 
                            className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wide flex items-center gap-2"
                          >
                              Start Grading
                          </button>
                      )}
                  </div>
                  <div className="grid grid-cols-4 gap-2 pb-24">
                      {currentGroup.map((p, i) => {
                          const grade = initialGrades[p.id]?.dance || 0;
                          return (
                              <div 
                                key={p.id} 
                                onClick={() => { setSelectedIndex(i); setViewMode('grade'); }}
                                className={`aspect-square relative rounded-lg overflow-hidden border cursor-pointer transition-all
                                    ${grade > 0 ? 'border-blue-500/50' : 'border-white/10 hover:border-white/30'}
                                `}
                              >
                                  <img src={p.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-full h-full object-cover" />
                                  {grade > 0 && (
                                      <div className="absolute inset-0 bg-blue-900/60 flex items-center justify-center">
                                          <span className="text-xl font-black text-white">{grade}</span>
                                      </div>
                                  )}
                                  <div className="absolute bottom-0 inset-x-0 bg-black/60 p-1">
                                      <p className="text-[8px] font-bold text-white truncate text-center">{p.name}</p>
                                  </div>
                              </div>
                          )
                      })}
                  </div>
              </div>
          )}

          {viewMode === 'grade' && activeStudent && (
              <div className="flex flex-col flex-1 h-full min-h-0">
                  
                  {/* COMPACT STUDENT HEADER */}
                  <div className="flex items-center justify-between p-3 border-b border-white/5 bg-zinc-900/50 shrink-0">
                      <button onClick={() => changeStudent(-1)} disabled={selectedIndex === 0} className="p-2 text-zinc-400 hover:text-white disabled:opacity-20"><ArrowLeft size={20} /></button>
                      
                      <div className="flex items-center gap-3">
                          <div className="w-10 h-10 rounded-full overflow-hidden border border-white/10 shrink-0">
                              <img src={activeStudent.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-full h-full object-cover" />
                          </div>
                          <div className="text-center">
                              <h2 className="text-sm font-black uppercase text-white leading-none">{activeStudent.name}</h2>
                              <p className="text-[9px] text-zinc-500 font-bold uppercase mt-0.5">#{activeStudent.id.toString().slice(-3)}  {activeStudent.age}</p>
                          </div>
                          {activeGrade.dance > 0 && (
                             <div className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center border-2 border-black shadow-lg ml-2">
                                 <span className="text-sm font-black text-white">{activeGrade.dance}</span>
                             </div>
                          )}
                      </div>

                      <button onClick={() => changeStudent(1)} disabled={selectedIndex === currentGroup.length - 1} className="p-2 text-zinc-400 hover:text-white disabled:opacity-20"><ArrowRight size={20} /></button>
                  </div>

                  {/* CONTROL PAD */}
                  <div 
                    className="flex-1 bg-zinc-900 border-t border-white/10 p-4 pb-48 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)] flex flex-col justify-start"
                    onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}
                  >
                      <div className="grid grid-cols-4 gap-2 mb-1 mt-2">
                          {LEVELS.map((lvl) => (
                              <button key={lvl.val} onClick={() => handleScore(lvl.val)} className={`h-14 rounded-xl flex flex-col items-center justify-center border-2 transition-all active:scale-95 ${activeGrade.dance === lvl.val ? `${lvl.color.replace('/30', '')} text-white shadow-lg scale-105` : `bg-transparent border-white/5 text-zinc-500 hover:bg-white/5`}`}>
                                  <span className="text-lg font-black">{lvl.val}</span>
                                  <span className="text-[8px] font-bold uppercase whitespace-nowrap">{lvl.label}</span>
                              </button>
                          ))}
                      </div>

                      {/* FULL RESET BUTTON */}
                      <div className="flex justify-end mb-3 h-5">
                          {activeGrade.dance > 0 && (
                              <button 
                                  onClick={handleClear} 
                                  className="flex items-center gap-1 text-[10px] font-bold uppercase text-zinc-500 hover:text-red-400 transition-colors"
                              >
                                  <Eraser size={12} /> Clear All (Score & Notes)
                              </button>
                          )}
                      </div>

                      <div className="mb-3 relative">
                          <input value={localNotes} onChange={(e) => handleManualNoteChange(e.target.value)} onBlur={saveNotes} placeholder="Type note..." className="w-full bg-black/40 border border-white/5 rounded-lg pl-9 pr-4 py-3 text-sm text-white placeholder:text-zinc-600 focus:border-blue-500 outline-none" />
                          <MessageSquare size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-600" />
                      </div>

                      <div className="flex flex-wrap justify-center gap-2">
                          {STANDARD_TAGS.map((tag) => {
                              const isActive = (localNotes || "").includes(tag.id);
                              return (
                                  <button key={tag.id} onClick={() => handleToggleTag(tag.id)} className={`flex items-center gap-1.5 px-3 py-3 rounded-full border transition-all active:scale-95 flex-grow justify-center ${isActive ? `${tag.color} text-white shadow-lg` : "bg-zinc-950 border-white/10 text-zinc-400"}`}>
                                      <tag.icon size={14} fill={isActive ? "currentColor" : "none"} />
                                      <span className="text-[10px] font-bold uppercase tracking-wide">{tag.label}</span>
                                  </button>
                              );
                          })}
                          <button onClick={handleAttitudeCycle} className={`flex items-center gap-1.5 px-3 py-3 rounded-full border transition-all active:scale-95 flex-grow justify-center ${attState === 'good' ? "bg-emerald-600 border-emerald-400 text-white shadow-lg" : attState === 'bad' ? "bg-red-600 border-red-400 text-white shadow-lg" : "bg-zinc-950 border-white/10 text-zinc-400"}`}>
                              {attState === 'good' ? <ThumbsUp size={14} fill="currentColor" /> : attState === 'bad' ? <AlertTriangle size={14} fill="currentColor" /> : <Smile size={14} />}
                              <span className="text-[10px] font-bold uppercase tracking-wide">{attState === 'good' ? "Good Att." : attState === 'bad' ? "Bad Att." : "Attitude"}</span>
                          </button>
                      </div>
                  </div>
              </div>
          )}
      </div>
    </div>
  );
}
</file>

<file path="app/globals.css">
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}
</file>

<file path="app/lib/CastingContext.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";
import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import { getAuditionees, submitAudition } from './baserow';

// 1. Define the shape of our data to kill the "redlines"
export interface Performer {
  id: number;
  name: string;
  age: number | string;
  height: string;
  dob: string;
  headshotUrl: string | null;
  tenure: string;
  conflicts: string;
  pastRoles: string[];
}

interface CastingContextType {
  performers: Performer[];
  grades: Record<number, any>;
  loading: boolean;
  saveAssessment: (performerId: number, productionId: number, newGrades: any) => Promise<void>;
  refreshData: () => Promise<void>;
}

const CastingContext = createContext<CastingContextType | null>(null);

export function CastingProvider({ children }: { children: React.ReactNode }) {
  const [performers, setPerformers] = useState<Performer[]>([]);
  const [grades, setGrades] = useState<Record<number, any>>({});
  const [loading, setLoading] = useState(true);

  const refreshData = useCallback(async () => {
    setLoading(true);
    try {
      const data = await getAuditionees();
      
      // 2. Map raw Baserow People (599) fields to our App's Performer interface
      const mapped: Performer[] = data.map((row: any) => ({
        id: row.id,
        // Match these exactly to your Baserow field names
        name: row["Full Name"] || "Unnamed Performer",
        age: row["Age"] || "N/A",
        height: row["Height (Feet)"] || "-", 
        dob: row["Date of Birth"] || "",
        headshotUrl: row["Headshot"]?.[0]?.url || null,
        // Status is often a single-select in Baserow, which returns an object
        tenure: typeof row["Status"] === 'object' ? row["Status"]?.value : row["Status"] || "Student",
        conflicts: row["Rehearsal Conflicts"] || "No known conflicts",
        pastRoles: row["Cast/Crew Assignments"] 
          ? row["Cast/Crew Assignments"].map((a: any) => a.value) 
          : [],
      }));

      setPerformers(mapped);
    } catch (e) {
      console.error("Baserow Sync Error:", e);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    refreshData();
  }, [refreshData]);

  // 3. The new "Save" logic that creates a record in the Auditions (630) table
  const saveAssessment = async (performerId: number, productionId: number, newGrades: any) => {
    // Optimistic Update: Show the score in the UI immediately
    setGrades(prev => ({
      ...prev,
      [performerId]: newGrades
    }));

    try {
      // POSTs a new row to the Auditions table
      await submitAudition(performerId, productionId, newGrades);
      console.log(`Audition record created for performer ${performerId}`);
    } catch (e) {
      console.error("Failed to save audition record:", e);
      alert("Error saving to Baserow. Check console.");
    }
  };

  return (
    <CastingContext.Provider value={{ 
      performers, 
      grades, 
      saveAssessment, 
      loading, 
      refreshData 
    }}>
      {children}
    </CastingContext.Provider>
  );
}

export const useCasting = () => {
  const context = useContext(CastingContext);
  if (!context) {
    throw new Error("useCasting must be used within a CastingProvider");
  }
  return context;
};
</file>

<file path="app/plan.md">
# PROJECT: Open Backstage (CYT Fredericksburg)

## 1. CORE MISSION
Build a localized, self-hosted operational dashboard to bypass the limitations of the legacy National website.
**Goal:** Relieve staff burnout, ensure data safety, and create a mobile-friendly "Home Hub" for operations.

## 2. THE TECH STACK
- **Backend:** Self-Hosted Baserow (Docker).
- **Frontend:** React / Next.js (Mobile-first).
- **Payment:** Payment Agnostic. We use external links (Zeffy/Square). We do NOT process credit cards in-app.
- **Hosting:** DigitalOcean (Coolify/Portainer).

## 3. POLITICAL & COMPLIANCE CONSTRAINTS (Non-Negotiable)
1.  **The "National" Wall:** We cannot integrate with the National Website via API. The legacy system is fragile and unmaintained.
2.  **The "CSV" Rule:** We must eventually export data to CSV to satisfy National's royalty/insurance requirements. The National DB is the "Legal Source of Truth." Open Backstage is the "Operational Source of Truth."
3.  **The "Zeffy" Protocol:** We use Zeffy for payments to save fees. We must explicitly warn parents about the "Optional Tip" model.
4.  **No "Shadow" Accounts:** We do not create "new" accounts. We map to the existing National ID (manually if needed) to prevent data fragmentation.

## 4. BRANDING
- **Name:** Open Backstage
- **Metaphor:** "Front of House" is the National Site (Public/Tickets). "Backstage" is our tool (Staff/Operations).
- **Domain:** open-backstage.org

## 5. CURRENT STATUS (Jan 2026)
- **Phase:** Spring Pilot.
- **Scope:** Casting, Class Registration, Payment Tracking, Rosters.
- **Not in Scope:** Automated Emails, Costume Inventory (Push to Summer).
</file>

<file path="app/test-sync/page.tsx">
/* eslint-disable react-hooks/rules-of-hooks */
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import { useState } from 'react';
import { 
  getAuditionees, 
  getSeasonsAndShows, 
  getAuditionSlots, 
  updateAuditionSlot 
} from '@/app/lib/baserow';

export default function TestSyncPage() {
  const [results, setResults] = useState<any>(null);
  const [lastAction, setLastAction] = useState<string>(""); // To track what we pulled
  const [loading, setLoading] = useState(false);
  const [status, setStatus] = useState<string>("Idle");

  // TEST 1: Pull People (Table 599)
  const runPullPeople = async () => {
    setLoading(true);
    setStatus("Pulling People (Table 599)...");
    try {
      const data = await getAuditionees();
      setResults(data);
      setLastAction("people");
      setStatus(` Success! Loaded ${data.length} people.`);
    } catch (e: any) {
      setResults({ error: e.message });
      setStatus(" Pull Failed");
    } finally {
      setLoading(false);
    }
  };

  // TEST 2: Pull Audition Slots (Table 630)
  const runPullSlots = async () => {
    setLoading(true);
    setStatus("Pulling Audition Slots (Table 630)...");
    try {
      const data = await getAuditionSlots();
      setResults(data);
      setLastAction("slots");
      setStatus(` Success! Loaded ${data.length} slots.`);
    } catch (e: any) {
      setResults({ error: e.message });
      setStatus(" Pull Failed");
    } finally {
      setLoading(false);
    }
  };

  // TEST 3: Verify Show ID (Table 600)
  const verifyWonkaID = async () => {
    setLoading(true);
    setStatus("Searching for 'Little Mermaid' in Table 600...");
    try {
      const { productions } = await getSeasonsAndShows();
      
      // Note: Baserow usually uses "Title" or "Name". We check both.
      const show = productions.find((p: any) => {
        const name = p.Title || p.Name || "";
        return name.toLowerCase().includes("mermaid");
      });

      if (show) {
        setResults(show);
        setStatus(` Found it! ID: ${show.id} | Title: ${show.Title || show.Name}`);
      } else {
        setResults({ available_productions: productions });
        setStatus(" Could not find 'Mermaid' in the list.");
      }
    } catch (e: any) {
      setResults({ error: e.message });
      setStatus(" Error fetching productions.");
    } finally {
      setLoading(false);
    }
  };

  // TEST 4: Patch (Table 630)
  const runPatchTest = async () => {
    // Safety Check: Force user to pull SLOTS first
    if (lastAction !== "slots" || !results || !results[0]?.id) {
      alert(" STOP: Please click 'Test PULL (Slots)' first.\n\nWe need a valid Audition Slot ID to patch. Patching a Person ID will break things!");
      return;
    }

    const targetId = results[0].id; // Patch the first slot in the list
    
    setLoading(true);
    setStatus(`Patching Slot #${targetId} (Table 630)...`);
    
    try {
      const testGrades = {
        acting: 5,
        vocal: 5,
        dance: 5,
        notes: "DIAGNOSTIC TEST: " + new Date().toLocaleTimeString()
      };
      
      const response = await updateAuditionSlot(targetId, testGrades);
      setResults(response);
      setStatus(" Patch Successful! Check Baserow for update.");
    } catch (e: any) {
      setResults({ error: e.message });
      setStatus(" Patch Failed");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="p-10 space-y-8 bg-zinc-950 min-h-screen text-white overflow-auto">
      <header>
        <h1 className="text-3xl font-black uppercase italic text-blue-500">Baserow Diagnostics</h1>
        <div className={`mt-2 inline-block px-3 py-1 rounded-full text-xs font-bold ${status.includes('') ? 'bg-emerald-500/20 text-emerald-400' : 'bg-zinc-800 text-zinc-400'}`}>
          Status: {status}
        </div>
      </header>

      <div className="flex flex-wrap gap-4">
        <button onClick={runPullPeople} disabled={loading} className="px-6 py-3 bg-zinc-800 text-white font-black uppercase text-xs rounded-xl hover:bg-zinc-700 disabled:opacity-50">
          1. Test PULL (People)
        </button>

        <button onClick={runPullSlots} disabled={loading} className="px-6 py-3 bg-white text-black font-black uppercase text-xs rounded-xl hover:bg-zinc-200 disabled:opacity-50">
          2. Test PULL (Slots)
        </button>
        
        <button onClick={runPatchTest} disabled={loading} className="px-6 py-3 bg-blue-600 text-white font-black uppercase text-xs rounded-xl hover:bg-blue-500 disabled:opacity-50">
          3. Test PATCH (First Slot)
        </button>

        <button onClick={verifyWonkaID} disabled={loading} className="px-6 py-3 bg-amber-500 text-black font-black uppercase text-xs rounded-xl hover:bg-amber-400 disabled:opacity-50">
          4. Verify Show ID
        </button>
      </div>

      <div className="bg-black border border-white/10 rounded-2xl p-6">
        <h2 className="text-xs font-bold uppercase text-zinc-500 mb-4 tracking-widest">API Response</h2>
        <pre className="text-[10px] text-blue-300 overflow-auto max-h-[500px] p-4 bg-zinc-900/50 rounded-lg whitespace-pre-wrap font-mono">
          {JSON.stringify(results, null, 2)}
        </pre>
      </div>
    </div>
  );
}
</file>

<file path="lib/CastingContext.tsx">
"use client";
import React, { createContext, useContext, useState } from 'react';
import { Performer, Role, Scene, Assignment, SceneAssignment } from './types';
const generateMockStudents = () => {
  const names = ["James", "Emma", "Liam", "Olivia", "Noah", "Ava", "Lucas", "Mia", "Ethan", "Sophia"];
  const lastNames = ["Smith", "Johnson", "Brown", "Taylor", "Miller", "Wilson", "Moore", "Anderson"];
  const tenures = ["New Student", "1-2 Shows", "3+ Shows"];
  const ranges = ["Soprano", "Alto", "Tenor", "Bass"];
  const songs = ["Part of Your World", "Giants in the Sky", "Tomorrow", "Santa Fe", "On My Own"];

  return Array.from({ length: 80 }).map((_, i) => ({
    id: i + 1,
    name: `${names[i % 10]} ${lastNames[i % 8]}`,
    age: Math.floor(Math.random() * 10) + 8, // Ages 8-18
    vocalRange: ranges[i % 4],
    tenure: tenures[i % 3],
    batch: (i < 30) ? 1 : (i < 60) ? 2 : 3, // Grouped by 30s
    auditionDetails: {
      song: songs[i % 5],
      monologue: i % 2 === 0 ? "Comedic A" : "Dramatic B"
    }
  }));
};
interface CastingContextType {
  performers: Performer[];
  roles: Role[];
  scenes: Scene[];
  assignments: Assignment[];
  sceneAssignments: SceneAssignment[];
  getPerformerStats: (personId: number) => Performer['stats'];
}

const CastingContext = createContext<CastingContextType | undefined>(undefined);

export function CastingProvider({ children }: { children: React.ReactNode }) {
  // Mock Data for Phase 1 - We will replace with Baserow API later
const [performers] = useState(generateMockStudents());
  
  const [scenes] = useState<Scene[]>([
    { id: 101, name: "Kansas", act: 1, weight: 'Medium' },
    { id: 102, name: "Munchkinland", act: 1, weight: 'Large' },
    { id: 201, name: "Emerald City", act: 2, weight: 'Large' }
  ]);

  const [assignments] = useState<Assignment[]>([
    { id: 1, personId: 1, roleId: 501 }
  ]);

  const [sceneAssignments] = useState<SceneAssignment[]>([
    { id: 1, roleId: 501, sceneId: 101 },
    { id: 2, roleId: 501, sceneId: 201 }
  ]);

  const getPerformerStats = (personId: number) => {
    const roles = assignments.filter(a => a.personId === personId).map(a => a.roleId);
    const sceneIds = sceneAssignments.filter(sa => roles.includes(sa.roleId)).map(sa => sa.sceneId);
    const assignedScenes = scenes.filter(s => sceneIds.includes(s.id));

    return {
      sceneCount: assignedScenes.length,
      act1: assignedScenes.some(s => s.act === 1),
      act2: assignedScenes.some(s => s.act === 2)
    };
  };

  return (
    <CastingContext.Provider value={{ performers, roles: [], scenes, assignments, sceneAssignments, getPerformerStats }}>
      {children}
    </CastingContext.Provider>
  );
}

export const useCasting = () => {
  const context = useContext(CastingContext);
  if (!context) throw new Error('useCasting must be used within CastingProvider');
  return context;
};
</file>

<file path="lib/types.ts">
// lib/types.ts

export interface Performer {
  id: number; // Table 599
  name: string;
  age: number;
  headshot?: string; // URL to Baserow file
  vocalRange: string;
  tenure: string; // "New Student", "3+ Shows", etc.
  batch: number; // IMPORTANT: Needed for the Batch 1/2/3 filtering
  auditionDetails?: {
    song: string;
    monologue: string;
  };
  danceLevel?: string;
  stats?: {
    sceneCount: number;
    act1: boolean;
    act2: boolean;
  };
}

export interface Role {
  id: number; // Table 609
  name: string;
  productionId: number;
  isEnsemble: boolean;
}

export interface Scene {
  id: number; // Table 627
  name: string;
  act: 1 | 2;
  weight: 'Small' | 'Medium' | 'Large';
}

export interface Assignment {
  id: number; // Table 603
  personId: number;
  roleId: number;
}

export interface SceneAssignment {
  id: number; // Table 628
  roleId: number;
  sceneId: number;
}
</file>

<file path="LICENSE">
MIT License

Copyright (c) 2025 Austin James Fitzhugh

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="package.json">
{
  "name": "open-backstage-casting",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@aws-sdk/client-s3": "^3.958.0",
    "@aws-sdk/s3-request-presigner": "^3.958.0",
    "lucide-react": "^0.562.0",
    "next": "16.1.1",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "recharts": "^3.6.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="app/(main)/(staff)/page.tsx">
import { cookies } from 'next/headers';
import { getActiveProduction } from '@/app/lib/baserow';
import StaffClient from '@/app/components/staff/StaffClient';

export default async function StaffPage() {
  const cookieStore = await cookies();
  const activeId = Number(cookieStore.get('active_production_id')?.value);
  
  let productionTitle = "Production Team";
  
  // Default to 0 if no active ID found, Client handles the rest
  let productionId = activeId || 0; 

  if (activeId) {
      const prod = await getActiveProduction(); 
      if(prod) productionTitle = prod.Title;
  }

  return (
    <main className="h-screen bg-zinc-950 overflow-hidden">
      <StaffClient productionTitle={productionTitle} productionId={productionId} />
    </main>
  );
}
</file>

<file path="app/(main)/loading.tsx">
import { Loader2 } from 'lucide-react';

export default function Loading() {
  return (
    <div className="h-full w-full flex flex-col items-center justify-center bg-zinc-950">
      <div className="flex flex-col items-center gap-6">
        
        {/* Spinning Icon */}
        <div className="relative">
            <div className="absolute inset-0 bg-blue-500/20 blur-xl rounded-full" />
            <Loader2 size={48} className="text-blue-500 animate-spin relative z-10" />
        </div>

        {/* Text */}
        <div className="text-center space-y-2">
          <h2 className="text-lg font-black uppercase italic text-white tracking-widest animate-pulse">
            Loading Data
          </h2>
          <p className="text-[10px] font-bold text-zinc-600 uppercase tracking-[0.3em]">
            Syncing with Baserow...
          </p>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="app/components/ComplianceDashboard.tsx">
"use client";

import React from 'react';
import { 
  CheckCircle2, 
  Circle, 
  User, 
  DollarSign, 
  FileText, 
  Camera, 
  Ruler,
  AlertCircle
} from 'lucide-react';

interface Student {
  id: string | number;
  performerName: string;
  signedAgreement: boolean;
  paidFees: boolean;
  headshotSubmitted: boolean;
  measurementsTaken: boolean;
}

interface ComplianceDashboardProps {
  students?: Student[];
  productionTitle: string; 
}

const ComplianceDashboard = ({ students = [], productionTitle = "Select a Production" }: ComplianceDashboardProps) => {
  
  // 1. Safety Check: If no students exist, show a specific message for THIS production
  if (!students || students.length === 0) {
    return (
      <div className="bg-zinc-950 text-zinc-50 p-6 min-h-screen flex flex-col items-center justify-center">
        <header className="mb-8 text-center">
          <h1 className="text-2xl font-bold tracking-tight">Staff Portal: Compliance & Onboarding</h1>
          <p className="text-zinc-400 mt-1">
            Production: <span className="text-emerald-500 font-medium">{productionTitle}</span>
          </p>
        </header>
        <div className="p-12 text-center text-zinc-500 border border-zinc-800 rounded-lg bg-zinc-900/50 max-w-md">
          <AlertCircle className="mx-auto h-12 w-12 text-zinc-600 mb-4" />
          <h3 className="text-lg font-medium text-zinc-300">No Cast Members Found</h3>
          <p className="text-sm mt-2">
            We couldn&apos;t find any cast members for <strong className="text-zinc-300">{productionTitle}</strong>.
          </p>
          <p className="text-xs mt-4 text-zinc-600">
             Ensure you have assigned roles in the <strong>Assignments</strong> table and linked them to this specific production.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-zinc-950 text-zinc-50 p-6 min-h-screen">
      <header className="mb-8 border-b border-zinc-900 pb-6">
        <div className="flex justify-between items-end">
          <div>
            <h1 className="text-2xl font-bold tracking-tight">Staff Portal: Compliance & Onboarding</h1>
            <p className="text-zinc-400 mt-1">
              Production: <span className="text-emerald-500 font-medium">{productionTitle}</span>
            </p>
          </div>
          <div className="text-right">
             <div className="text-xs text-zinc-500 uppercase font-bold tracking-wider">Total Cast</div>
             <div className="text-2xl font-mono text-zinc-200">{students.length}</div>
          </div>
        </div>
      </header>

      <div className="overflow-x-auto rounded-lg border border-zinc-800 shadow-xl shadow-black/20">
        <table className="w-full text-left text-sm">
          <thead className="bg-zinc-900 text-zinc-400 uppercase text-xs font-semibold">
            <tr>
              <th className="px-4 py-3">Performer</th>
              <th className="px-4 py-3 text-center">Agreement</th>
              <th className="px-4 py-3 text-center">Fees</th>
              <th className="px-4 py-3 text-center">Headshot</th>
              <th className="px-4 py-3 text-center">Measurements</th>
              <th className="px-4 py-3 text-right">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-zinc-800 bg-zinc-950/50">
            {students.map((student) => (
              <tr key={student.id} className="hover:bg-zinc-900/80 transition-colors group">
                <td className="px-4 py-4 font-medium flex items-center gap-3">
                  <div className="h-8 w-8 rounded-full bg-zinc-800 flex items-center justify-center text-zinc-400 group-hover:bg-zinc-700 group-hover:text-emerald-500 transition-colors">
                    <User size={16} />
                  </div>
                  <span className="text-zinc-200 group-hover:text-white transition-colors">
                    {student.performerName || "Unknown Performer"}
                  </span>
                </td>
                
                {/* Compliance Checkboxes */}
                <ComplianceCell checked={student.signedAgreement} icon={<FileText size={16}/>} />
                <ComplianceCell checked={student.paidFees} icon={<DollarSign size={16}/>} />
                <ComplianceCell checked={student.headshotSubmitted} icon={<Camera size={16}/>} />
                <ComplianceCell checked={student.measurementsTaken} icon={<Ruler size={16}/>} />

                <td className="px-4 py-4 text-right">
                  <button className="text-zinc-500 hover:text-white text-xs hover:bg-zinc-800 px-3 py-1.5 rounded transition-colors border border-transparent hover:border-zinc-700">
                    Details
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

const ComplianceCell = ({ checked, icon }: { checked: boolean; icon: React.ReactNode }) => (
  <td className="px-4 py-4 text-center">
    <button 
      className={`inline-flex items-center justify-center p-2 rounded-full transition-all duration-300 ${
        checked 
          ? 'bg-emerald-500/10 text-emerald-500 hover:bg-emerald-500/20' 
          : 'text-zinc-700 hover:text-zinc-500 hover:bg-zinc-800'
      }`}
      title={checked ? "Completed" : "Pending"}
    >
      {checked ? (
        <CheckCircle2 size={18} />
      ) : (
        <Circle size={18} />
      )}
    </button>
  </td>
);

export default ComplianceDashboard;
</file>

<file path="app/components/ConflictMatrix.tsx">
"use client";

import React, { useMemo, useState } from "react";
import { 
  AlertTriangle, 
  Check, 
  ChevronDown, 
  ChevronRight, 
  Search, 
  Calendar,
  XCircle
} from "lucide-react";

// --- TYPES (Based on your Schema) ---
interface Scene {
  id: number;
  name: string; // "Scene Name"
  act: string;  // "Act"
  roles: number[]; // Derived from "Blueprint Roles" or "Active Scenes" logic
}

interface Actor {
  id: number;
  name: string;
  conflicts: string[]; // Hydrated text from "Rehearsal Conflicts"
}

interface Assignment {
  roleId: number;
  actorId: number;
}

interface Props {
  scenes: any[];      // Raw Table 627
  roles: any[];       // Raw Table 605
  assignments: any[]; // Raw Table 603
  people: any[];      // Raw Table 599
}

export default function ConflictMatrix({ scenes, roles, assignments, people }: Props) {
  const [filterText, setFilterText] = useState("");
  const [showClear, setShowClear] = useState(true);

  // --- 1. DATA PREP & HYDRATION ---
  const processedData = useMemo(() => {
    // A. Map People to a Dictionary for O(1) lookup
    const actorMap = new Map<number, Actor>();
    people.forEach((p) => {
      // Handle the Link Row structure for conflicts
      const conflictRaw = p["Rehearsal Conflicts"];
      let conflictList: string[] = [];
      
      if (Array.isArray(conflictRaw)) {
        conflictList = conflictRaw.map((c: any) => c.value);
      }

      // Name Hydration Logic
      const name = p["Full Name"] || `Student ${p["Digital ID"]}`;
      
      actorMap.set(p.id, { id: p.id, name, conflicts: conflictList });
    });

    // B. Map Roles to Actors
    // We look at the ASSIGNMENTS table to see who plays what
    const roleActorMap = new Map<number, number[]>(); // RoleID -> [ActorID]
    
    assignments.forEach((a) => {
      const roleId = a["Performance Identity"]?.[0]?.id;
      const personId = a["Person"]?.[0]?.id;
      
      if (roleId && personId) {
        const current = roleActorMap.get(roleId) || [];
        if (!current.includes(personId)) {
          roleActorMap.set(roleId, [...current, personId]);
        }
      }
    });

    // C. Map Scenes to Actors (The "Who is in this scene?" logic)
    // Logic: Scene -> Linked Roles -> Assigned Actors
    const matrixRows = scenes
      .map((scene) => {
        const sceneName = scene["Scene Name"];
        // Check both directions: "Blueprint Roles" on Scene OR "Active Scenes" on Role
        // Assuming "Active Scenes" on Role is the source of truth based on your Casting Page code
        const rolesInScene = roles.filter((r) => {
          const activeScenes = r["Active Scenes"] || [];
          return activeScenes.some((s: any) => s.id === scene.id);
        });

        const actorsInScene = new Set<number>();
        rolesInScene.forEach((r) => {
          const actorIds = roleActorMap.get(r.id) || [];
          actorIds.forEach((id) => actorsInScene.add(id));
        });

        return {
          id: scene.id,
          name: sceneName,
          act: scene["Act"]?.value || "1",
          actors: Array.from(actorsInScene), // List of Actor IDs present
        };
      })
      .sort((a, b) => a.id - b.id); // Keep scenes in order

    // D. Get Unique Actors who are actually cast
    const uniqueActorIds = Array.from(new Set(matrixRows.flatMap((r) => r.actors)));
    const gridColumns = uniqueActorIds
      .map((id) => actorMap.get(id))
      .filter((a): a is Actor => !!a) // Remove undefined
      .sort((a, b) => a.name.localeCompare(b.name));

    return { rows: matrixRows, columns: gridColumns, actorMap };
  }, [scenes, roles, assignments, people]);

  const { rows, columns, actorMap } = processedData;

  // --- 2. FILTERING ---
  const visibleColumns = columns.filter(c => 
    c.name.toLowerCase().includes(filterText.toLowerCase())
  );

  return (
    <div className="flex flex-col h-full bg-zinc-950 text-white overflow-hidden">
      {/* HEADER BAR */}
      <div className="p-4 border-b border-white/10 bg-zinc-900 flex justify-between items-center shrink-0">
        <h2 className="text-lg font-black uppercase italic tracking-wider flex items-center gap-2">
          <Calendar className="text-red-500" /> Conflict Matrix
        </h2>
        
        <div className="flex items-center gap-4">
          <label className="flex items-center gap-2 text-xs font-bold uppercase text-zinc-400 cursor-pointer hover:text-white">
            <input 
              type="checkbox" 
              checked={showClear} 
              onChange={(e) => setShowClear(e.target.checked)}
              className="accent-blue-500"
            />
            Show Cleared Cells
          </label>
          
          <div className="relative">
            <Search size={14} className="absolute left-2 top-1/2 -translate-y-1/2 text-zinc-500" />
            <input 
              value={filterText}
              onChange={(e) => setFilterText(e.target.value)}
              placeholder="Filter Actors..." 
              className="bg-zinc-950 border border-white/10 rounded-lg pl-8 pr-3 py-1.5 text-xs text-white focus:border-blue-500 outline-none w-48 transition-all"
            />
          </div>
        </div>
      </div>

      {/* MATRIX CONTAINER */}
      <div className="flex-1 overflow-auto custom-scrollbar relative">
        <table className="w-full border-collapse">
          {/* TABLE HEAD: ACTORS */}
          <thead className="sticky top-0 z-20 bg-zinc-900 shadow-xl">
            <tr>
              <th className="sticky left-0 z-30 bg-zinc-900 border-b border-r border-white/10 p-4 min-w-[200px] text-left">
                <span className="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Scene / Actor</span>
              </th>
              {visibleColumns.map((actor) => (
                <th key={actor.id} className="p-2 border-b border-r border-white/10 min-w-[100px] w-[100px] align-bottom pb-4 relative group">
                  <div className="writing-vertical-lr rotate-180 text-xs font-bold text-zinc-300 uppercase tracking-wide whitespace-nowrap h-32 flex items-center">
                    {actor.name}
                  </div>
                  {/* Conflict Tooltip Header */}
                  {actor.conflicts.length > 0 && (
                    <div className="absolute top-2 left-1/2 -translate-x-1/2">
                      <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
                    </div>
                  )}
                </th>
              ))}
            </tr>
          </thead>

          {/* TABLE BODY: SCENES */}
          <tbody className="divide-y divide-white/5">
            {rows.map((scene) => (
              <tr key={scene.id} className="hover:bg-white/5 transition-colors group/row">
                {/* SCENE NAME */}
                <td className="sticky left-0 z-10 bg-zinc-950 group-hover/row:bg-zinc-900 border-r border-white/10 p-3">
                  <div className="flex items-baseline justify-between">
                    <span className="text-xs font-bold text-white truncate max-w-[180px]" title={scene.name}>
                      {scene.name}
                    </span>
                    <span className="text-[9px] font-black text-zinc-600 uppercase ml-2">Act {scene.act}</span>
                  </div>
                </td>

                {/* CELLS */}
                {visibleColumns.map((actor) => {
                  const isInScene = scene.actors.includes(actor.id);
                  const hasConflicts = actor.conflicts.length > 0;
                  // Note: In a real app, you'd check if the conflict DATE matches the scene DATE.
                  // For now, per rules, we highlight IF they are in the scene AND have ANY conflicts listed.
                  
                  if (!isInScene) {
                    return <td key={actor.id} className="bg-black/40 border-r border-white/5"></td>;
                  }

                  if (hasConflicts) {
                    return (
                      <td key={actor.id} className="bg-red-900/20 border-r border-white/5 p-2 text-center relative group/cell cursor-help hover:bg-red-900/40 transition-colors">
                        <AlertTriangle size={16} className="text-red-500 mx-auto" />
                        <span className="text-[9px] font-bold text-red-400 mt-1 block">Conflict</span>
                        
                        {/* HOVER DETAILS */}
                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-black border border-red-500/50 p-3 rounded-xl shadow-2xl z-50 hidden group-hover/cell:block">
                          <p className="text-[10px] font-black uppercase text-red-500 mb-1">Conflicts Listed:</p>
                          <ul className="text-[10px] text-zinc-300 list-disc pl-3 space-y-1">
                            {actor.conflicts.map((c, i) => (
                              <li key={i}>{c}</li>
                            ))}
                          </ul>
                        </div>
                      </td>
                    );
                  }

                  return (
                    <td key={actor.id} className={`border-r border-white/5 p-2 text-center ${!showClear ? 'opacity-20' : ''}`}>
                      <div className="flex justify-center">
                        <Check size={16} className="text-emerald-500/50" />
                      </div>
                    </td>
                  );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="app/components/ContextSwitcher.tsx">
"use client";

import { useFormStatus } from 'react-dom';
import { Check, Sparkles } from 'lucide-react';
import { switchProduction } from '@/app/actions'; // Import the action we just made

// Define the shape of a Production based on your new Baserow setup
type Production = {
  id: number;
  title: string;
  branch: string; // 'Fredericksburg' | 'Stafford'
  type: string;   // 'Main Stage' | 'Lite'
};

export default function ContextSwitcher({ 
  shows, 
  activeId 
}: { 
  shows: Production[], 
  activeId: number 
}) {
  
  return (
    <div className="p-2 space-y-1">
      <div className="px-2 pt-2 pb-1 flex justify-between items-center">
        <span className="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">
          Switch Context
        </span>
      </div>
      
      {shows.map((prod) => {
        const isActive = activeId === prod.id;
        
        return (
          <form key={prod.id} action={switchProduction}>
            <input type="hidden" name="productionId" value={prod.id} />
            <SubmitButton prod={prod} isActive={isActive} />
          </form>
        );
      })}
    </div>
  );
}

// Small helper to handle the "Pending" state during the switch
function SubmitButton({ prod, isActive }: { prod: Production, isActive: boolean }) {
  const { pending } = useFormStatus();

  return (
    <button
      disabled={pending}
      className={`w-full flex items-center gap-3 p-2 rounded-lg transition-colors text-left group
        ${isActive ? 'bg-zinc-800/80 border border-zinc-700' : 'hover:bg-zinc-800 border border-transparent'}
        ${pending ? 'opacity-50 cursor-wait' : ''}
      `}
    >
      {/* Visual Indicator of Branch */}
      <div className={`h-8 w-1 rounded-full shrink-0 
        ${prod.branch === 'Stafford' ? 'bg-amber-500' : 'bg-emerald-500'}
      `} />
      
      <div className="flex-1 min-w-0">
        <div className={`text-sm font-medium truncate ${isActive ? 'text-white' : 'text-zinc-400 group-hover:text-zinc-200'}`}>
          {prod.title}
        </div>
        <div className="flex gap-2 text-[10px] uppercase font-bold text-zinc-600 group-hover:text-zinc-500">
          <span>{prod.branch}</span>
          <span></span>
          <span>{prod.type}</span>
        </div>
      </div>
      
      {isActive && <Check size={14} className="text-emerald-500" />}
      {pending && <Sparkles size={14} className="text-zinc-500 animate-spin" />}
    </button>
  );
}
</file>

<file path="app/components/globalappheader/globalappheader.tsx">
import { cookies } from 'next/headers';
import { getActiveShows } from '@/app/lib/baserow';
import GlobalHeaderClient from './client'; // Imports your 'client.tsx'

export default async function GlobalHeader() {
  // 1. Get the Active Production ID from cookies
  const cookieStore = await cookies();
  const activeId = Number(cookieStore.get('active_production_id')?.value);

  // 2. Fetch the list of shows for the switcher
  const shows = await getActiveShows();

  // 3. Render the Client Component with data
  return <GlobalHeaderClient shows={shows} activeId={activeId} />;
}
</file>

<file path="app/components/globalappheader/index.tsx">
import { cookies } from 'next/headers';
import { getActiveShows } from '@/app/lib/baserow'; // Keeping your path
import GlobalHeaderClient from './client';

export default async function GlobalHeader() {
  // 1. Fetch Real Data from Baserow
  const shows = await getActiveShows();
  
  // 2. Get Current Context from Cookies
  // FIX: We must 'await' the cookies() call itself now
  const cookieStore = await cookies(); 
  const activeId = Number(cookieStore.get('active_production_id')?.value || 0);

  // 3. Pass data to the interactive client component
  return <GlobalHeaderClient shows={shows} activeId={activeId} />;
}
</file>

<file path="app/components/logo.svg">
<svg width="512" height="512" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect width="512" height="512" rx="128" fill="#09090b"/>
  
  <defs>
    <linearGradient id="showGradient" x1="156" y1="200" x2="356" y2="200" gradientUnits="userSpaceOnUse">
      <stop offset="0%" stop-color="#60a5fa" /> <stop offset="50%" stop-color="#c084fc" /> <stop offset="100%" stop-color="#34d399" /> </linearGradient>
  </defs>

  <path d="M165 140H125V180C125 195 135 205 150 205H165" stroke="white" stroke-width="35" stroke-linecap="round"/>
  <path d="M256 205V140M220 140H292" stroke="white" stroke-width="35" stroke-linecap="round"/>
  <path d="M347 140H387V140" stroke="white" stroke-width="35" stroke-linecap="round"/>
  <path d="M367 140V205" stroke="white" stroke-width="35" stroke-linecap="round"/>

  <path d="M140 380V280C140 230 180 230 256 230C332 230 372 230 372 280V380" stroke="#27272a" stroke-width="25" stroke-linecap="round"/>
  <rect x="120" y="380" width="272" height="20" rx="10" fill="#27272a"/>

  <path d="M256 250 L200 380 H312 L256 250Z" fill="url(#showGradient)" opacity="0.9"/>
  <path d="M256 250 L160 380 H180 L256 250Z" fill="#60a5fa" opacity="0.4"/>
  <path d="M256 250 L352 380 H332 L256 250Z" fill="#34d399" opacity="0.4"/>

</svg>
</file>

<file path="app/components/logo.tsx">
import React from 'react';

export const OpenBackstageLogo = ({ className = "w-10 h-10" }: { className?: string }) => (
  <svg 
    viewBox="0 0 512 512" 
    fill="none" 
    xmlns="http://www.w3.org/2000/svg" 
    className={className}
    aria-label="Open Backstage Logo"
  >
    <rect width="512" height="512" rx="128" className="fill-zinc-950"/>
    
    <defs>
      <linearGradient id="showGradient" x1="156" y1="200" x2="356" y2="200" gradientUnits="userSpaceOnUse">
        <stop offset="0%" className="stop-blue-400" stopColor="#60a5fa" />
        <stop offset="50%" className="stop-purple-400" stopColor="#c084fc" />
        <stop offset="100%" className="stop-emerald-400" stopColor="#34d399" />
      </linearGradient>
    </defs>

    {/* CYT Letters */}
    <path d="M165 140H125V180C125 195 135 205 150 205H165" stroke="white" strokeWidth="35" strokeLinecap="round"/>
    <path d="M256 205V140M220 140H292" stroke="white" strokeWidth="35" strokeLinecap="round"/>
    <path d="M347 140H387V140" stroke="white" strokeWidth="35" strokeLinecap="round"/>
    <path d="M367 140V205" stroke="white" strokeWidth="35" strokeLinecap="round"/>

    {/* Stage Arch */}
    <path d="M140 380V280C140 230 180 230 256 230C332 230 372 230 372 280V380" stroke="#27272a" strokeWidth="25" strokeLinecap="round"/>
    <rect x="120" y="380" width="272" height="20" rx="10" fill="#27272a"/>

    {/* Spotlight Beams */}
    <path d="M256 250 L200 380 H312 L256 250Z" fill="url(#showGradient)" opacity="0.9"/>
    <path d="M256 250 L160 380 H180 L256 250Z" fill="#60a5fa" opacity="0.4"/>
    <path d="M256 250 L352 380 H332 L256 250Z" fill="#34d399" opacity="0.4"/>
  </svg>
);
</file>

<file path="app/components/settings/SettingsClient.tsx">
"use client";

import React, { useState } from 'react';
import { 
  User, Bell, Shield, Monitor, Lock, 
  LogOut, Mail, Fingerprint, Building2, 
  CheckCircle2, XCircle, LayoutGrid, Calendar,
  Users
} from 'lucide-react';
import { switchProduction } from '@/app/actions';

export default function SettingsClient({ shows, activeId }: { shows: any[], activeId: number }) {
  const [activeTab, setActiveTab] = useState('general');
  
  // Mock User Data (In a real app, this comes from your Auth provider/cookie)
  const user = {
    name: "Austin Fitzhugh",
    email: "austin@cytfred.org",
    role: "Artistic Director",
    id: "142",
    permissions: ["manage_casting", "view_sensitive_reports", "edit_compliance"]
  };

  const activeShow = shows.find(s => s.id === activeId) || shows[0];

  return (
    <div className="flex flex-col lg:flex-row gap-8 h-full">
        
        {/* SIDEBAR NAVIGATION */}
        <nav className="w-full lg:w-64 flex flex-col gap-2 shrink-0">
            <TabButton id="general" label="General" icon={<User size={18}/>} active={activeTab} onClick={setActiveTab} />
            <TabButton id="appearance" label="Appearance" icon={<Monitor size={18}/>} active={activeTab} onClick={setActiveTab} />
            <TabButton id="notifications" label="Notifications" icon={<Bell size={18}/>} active={activeTab} onClick={setActiveTab} />
            <TabButton id="permissions" label="Permissions" icon={<Shield size={18}/>} active={activeTab} onClick={setActiveTab} />
            
            <div className="mt-auto pt-8 border-t border-white/5">
                <button className="flex items-center gap-3 px-4 py-3 rounded-xl text-xs font-bold text-red-400 hover:bg-red-500/10 transition-all w-full text-left">
                    <LogOut size={18}/> Sign Out
                </button>
            </div>
        </nav>

        {/* MAIN CONTENT AREA */}
        <div className="flex-1 bg-zinc-900/50 border border-white/5 rounded-3xl p-8 overflow-y-auto custom-scrollbar">
            
            {/* --- GENERAL TAB --- */}
            {activeTab === 'general' && (
                <div className="space-y-8 animate-in fade-in slide-in-from-right-4 duration-300">
                    <div>
                        <h2 className="text-2xl font-black uppercase italic tracking-tighter text-white mb-6">Profile & Identity</h2>
                        
                        {/* ID CARD */}
                        <div className="flex items-center gap-6 p-6 bg-zinc-900 rounded-2xl border border-white/5 shadow-xl">
                            <div className="w-20 h-20 rounded-full bg-emerald-600 flex items-center justify-center text-2xl font-black text-white shadow-lg shadow-emerald-900/40">
                                AF
                            </div>
                            <div>
                                <h3 className="text-xl font-bold text-white">{user.name}</h3>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className="px-2 py-0.5 rounded bg-zinc-800 border border-white/10 text-[10px] font-bold uppercase text-zinc-400">
                                        {user.role}
                                    </span>
                                    <span className="text-xs text-zinc-600 font-mono">ID: {user.id}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <InputGroup label="Full Name" value={user.name} icon={<User size={16}/>} />
                        <InputGroup label="Email Address" value={user.email} icon={<Mail size={16}/>} disabled />
                    </div>

                    <div className="pt-6 border-t border-white/5">
                        <h3 className="text-sm font-bold text-zinc-400 uppercase tracking-widest mb-4">Workspace Context</h3>
                        <div className="bg-black/20 p-4 rounded-xl border border-white/5">
                            <p className="text-xs text-zinc-500 mb-4">This setting controls which production data loads by default when you log in.</p>
                            
                            <div className="grid grid-cols-1 gap-2">
                                {shows.map((show) => (
                                    <form key={show.id} action={switchProduction}>
                                        <input type="hidden" name="productionId" value={show.id} />
                                        <input type="hidden" name="redirectPath" value="/settings" />
                                        <button 
                                            className={`w-full flex items-center justify-between p-3 rounded-lg border transition-all ${activeId === show.id ? 'bg-emerald-500/10 border-emerald-500/50' : 'bg-zinc-800 border-transparent hover:border-zinc-700'}`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`w-2 h-2 rounded-full ${activeId === show.id ? 'bg-emerald-500' : 'bg-zinc-600'}`} />
                                                <div className="text-left">
                                                    <div className={`text-sm font-bold ${activeId === show.id ? 'text-white' : 'text-zinc-400'}`}>{show.title}</div>
                                                    <div className="text-[10px] uppercase font-bold text-zinc-600">{show.location}  {show.season}</div>
                                                </div>
                                            </div>
                                            {activeId === show.id && <CheckCircle2 size={16} className="text-emerald-500"/>}
                                        </button>
                                    </form>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* --- PERMISSIONS TAB --- */}
            {activeTab === 'permissions' && (
                <div className="animate-in fade-in slide-in-from-right-4 duration-300">
                    <h2 className="text-2xl font-black uppercase italic tracking-tighter text-white mb-6">Security Clearance</h2>
                    
                    <div className="bg-amber-500/10 border border-amber-500/20 p-4 rounded-xl mb-8 flex items-start gap-3">
                        <Lock size={20} className="text-amber-500 shrink-0 mt-0.5"/>
                        <div>
                            <h4 className="text-sm font-bold text-amber-400 mb-1">Role-Based Access Control</h4>
                            <p className="text-xs text-amber-200/70 leading-relaxed">
                                Your permissions are determined by your role in the <strong>Volunteers Table (619)</strong>. 
                                To request elevated access, please contact the Production Manager.
                            </p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <PermissionCard 
                            label="Casting Management" 
                            desc="Access to Auditions, Callbacks, and Cast Grid."
                            granted={user.permissions.includes('manage_casting')}
                            icon={<Users size={18}/>}
                        />
                        <PermissionCard 
                            label="Financial Reports" 
                            desc="View revenue, budgets, and fee collection status."
                            granted={user.permissions.includes('view_financials')}
                            icon={<Building2 size={18}/>}
                        />
                        <PermissionCard 
                            label="Sensitive Data" 
                            desc="Access to medical forms and liability waivers."
                            granted={user.permissions.includes('view_sensitive_reports')}
                            icon={<Fingerprint size={18}/>}
                        />
                        <PermissionCard 
                            label="Schedule Editor" 
                            desc="Ability to modify rehearsal times and calls."
                            granted={user.permissions.includes('edit_schedule')} // Mock false
                            icon={<Calendar size={18}/>}
                        />
                    </div>
                </div>
            )}

            {/* --- APPEARANCE TAB (Placeholder) --- */}
            {activeTab === 'appearance' && (
                <div className="text-center py-20 text-zinc-500 animate-in fade-in slide-in-from-right-4 duration-300">
                    <Monitor size={48} className="mx-auto mb-4 opacity-20"/>
                    <h3 className="text-lg font-bold text-zinc-400">System Theme</h3>
                    <p className="text-sm mt-2">Open Backstage is locked to <strong>Dark Mode</strong> for theater environments.</p>
                </div>
            )}

             {/* --- NOTIFICATIONS TAB (Placeholder) --- */}
             {activeTab === 'notifications' && (
                <div className="text-center py-20 text-zinc-500 animate-in fade-in slide-in-from-right-4 duration-300">
                    <Bell size={48} className="mx-auto mb-4 opacity-20"/>
                    <h3 className="text-lg font-bold text-zinc-400">Notifications</h3>
                    <p className="text-sm mt-2">Email and Push notification settings coming in v2.0.</p>
                </div>
            )}

        </div>
    </div>
  );
}

// --- SUB-COMPONENTS ---

function TabButton({ id, label, icon, active, onClick }: any) {
    return (
        <button 
            onClick={() => onClick(id)}
            className={`
                flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all w-full text-left
                ${active === id 
                    ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' 
                    : 'text-zinc-400 hover:bg-zinc-800 hover:text-white'}
            `}
        >
            {icon}
            {label}
        </button>
    )
}

function InputGroup({ label, value, icon, disabled }: any) {
    return (
        <div>
            <label className="block text-[10px] font-black uppercase text-zinc-500 tracking-widest mb-2 ml-1">{label}</label>
            <div className={`flex items-center gap-3 p-3 rounded-xl border ${disabled ? 'bg-zinc-900/50 border-white/5 text-zinc-500 cursor-not-allowed' : 'bg-zinc-900 border-white/10 text-white focus-within:border-blue-500'}`}>
                <div className="text-zinc-500">{icon}</div>
                <input 
                    value={value} 
                    disabled={disabled}
                    readOnly={disabled}
                    className="bg-transparent outline-none w-full text-sm font-bold"
                />
            </div>
            {disabled && <p className="text-[10px] text-zinc-600 mt-1 ml-1 flex items-center gap-1"><Lock size={8}/> Managed by Admin</p>}
        </div>
    )
}

function PermissionCard({ label, desc, granted, icon }: any) {
    return (
        <div className={`p-4 rounded-xl border flex items-start gap-4 ${granted ? 'bg-emerald-500/5 border-emerald-500/20' : 'bg-zinc-900/50 border-white/5 opacity-60'}`}>
            <div className={`p-2 rounded-lg ${granted ? 'bg-emerald-500 text-white' : 'bg-zinc-800 text-zinc-500'}`}>
                {icon}
            </div>
            <div className="flex-1">
                <div className="flex justify-between items-center mb-1">
                    <h4 className={`text-sm font-bold ${granted ? 'text-emerald-400' : 'text-zinc-400'}`}>{label}</h4>
                    {granted ? <CheckCircle2 size={16} className="text-emerald-500"/> : <XCircle size={16} className="text-zinc-600"/>}
                </div>
                <p className="text-xs text-zinc-500 leading-snug">{desc}</p>
            </div>
        </div>
    )
}
</file>

<file path="app/lib/educationFillerData.ts">
// app/lib/mockEducation.ts

export const MOCK_CLASSES = [
  { id: 101, name: "AVL Control Freaks", teacher: "Javier Negron", day: "Tuesday", time: "6:00pm - 8:00pm", location: "River of Life", enrolled: 7, ages: "13-18" },
  { id: 102, name: "Conquering the Craft of Choreography", teacher: "Ellie Jany", day: "Tuesday", time: "6:00pm - 8:00pm", location: "Hope Presbyterian Church", enrolled: 5, ages: "13-18" },
  { id: 103, name: "Dancing Through Life: Musical Theater", teacher: "Emily Williams", day: "Monday", time: "6:00pm - 8:00pm", location: "River Club Church", enrolled: 9, ages: "8-12" },
  { id: 104, name: "Double Take - Ultimate Performance", teacher: "Rebecca Moffitt & Pam King", day: "Monday", time: "6:00pm - 8:00pm", location: "River Club Church", enrolled: 16, ages: "13-18" },
  { id: 105, name: "Double Take: Sing It, Dance It!", teacher: "Pam King & Rebecca Moffitt", day: "Monday", time: "6:00pm - 8:00pm", location: "River Club Church", enrolled: 12, ages: "8-12" },
  { id: 106, name: "Giving the Go: Stage Management", teacher: "Brittany Walters", day: "Monday", time: "6:00pm - 8:00pm", location: "River Club Church", enrolled: 7, ages: "14-18" },
  { id: 107, name: "Happily Ever Laughter", teacher: "Jacob Ramirez", day: "Tuesday", time: "6:00pm - 8:00pm", location: "Hope Presbyterian Church", enrolled: 10, ages: "8-12" },
  { id: 108, name: "Harmonies and Heartbeats!", teacher: "Jacob Ramirez", day: "Monday", time: "6:00pm - 8:00pm", location: "Highway Assembly", enrolled: 14, ages: "13-18" },
  { id: 109, name: "Improv-aganza!", teacher: "Connor Worthington", day: "Tuesday", time: "6:00pm - 8:00pm", location: "Hope Presbyterian Church", enrolled: 16, ages: "12-18" },
  { id: 110, name: "Lion King KIDS - CYT Lite", teacher: "Anna H, Brianne C, Hailey B", day: "Tuesday", time: "6:00pm - 8:00pm", location: "River of Life", enrolled: 40, ages: "8-12" },
  { id: 111, name: "Our Gang - Minions", teacher: "Tiffany Jeffris", day: "Tuesday", time: "6:00pm - 7:30pm", location: "River of Life", enrolled: 12, ages: "5-8" },
  { id: 112, name: "Very Punny!", teacher: "Candace Johnson", day: "Monday", time: "6:00pm - 8:00pm", location: "Highway Assembly", enrolled: 6, ages: "13-18" },
];

// --- HELPER: MOCK STUDENT ENROLLMENT ---
// This ensures that when you look at the Cast List, random actors are assigned to these real classes.
export function getStudentClassData(personId: number) {
    // 1. Determine if enrolled (Let's say 40% of cast is in a class)
    const isEnrolled = (personId % 5) !== 0; 
    if (!isEnrolled) return null;

    // 2. Assign a class based on ID to keep it consistent
    const classIndex = personId % MOCK_CLASSES.length;
    const assignedClass = MOCK_CLASSES[classIndex];

    // 3. Simulate Attendance
    // Make Person ID #32 and #15 "At Risk" (Truant)
    const isAtRisk = personId === 32 || personId === 15; 

    return {
        className: assignedClass.name,
        teacher: assignedClass.teacher,
        // If at risk, they have 3 absences. Otherwise 0 or 1.
        absences: isAtRisk ? 3 : (personId % 7 === 0 ? 1 : 0),
        history: [
            { date: "Dec 2", status: isAtRisk ? "Absent" : "Present" },
            { date: "Dec 9", status: "Present" },
            { date: "Dec 16", status: isAtRisk ? "Absent" : "Present" },
            { date: "Jan 6", status: isAtRisk ? "Absent" : "Present" },
        ]
    };
}
</file>

<file path="app/lib/permissions.ts">
// lib/permissions.ts

export type Permission = 'view_financials' | 'edit_compliance' | 'view_sensitive_reports' | 'manage_casting';

// This maps your exact "Role Name" from the Baserow table to capabilities
const ROLE_PERMISSIONS: Record<string, Permission[]> = {
  'Business Manager': ['view_financials', 'view_sensitive_reports'],
  'Executive Director': ['view_financials', 'edit_compliance', 'view_sensitive_reports', 'manage_casting'],
  'Production Coordinator': ['edit_compliance', 'view_sensitive_reports'],
  'Stage Manager': ['edit_compliance'],
  'Director': ['manage_casting', 'view_sensitive_reports'],
  'Music Director': ['manage_casting'],
  'Choreographer': ['manage_casting'],
};

export function hasPermission(userRole: string, permission: Permission): boolean {
  const perms = ROLE_PERMISSIONS[userRole] || [];
  return perms.includes(permission);
}
</file>

<file path="eslint.config.mjs">
import { defineConfig } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";

export default defineConfig([
  ...nextVitals,
  {
    rules: {
      // Disable the specific accessibility warnings cluttering your screen
      "jsx-a11y/alt-text": "off",
      "jsx-a11y/role-has-required-aria-props": "off",
      "@next/next/no-img-element": "off"
    }
  }
]);
</file>

<file path="get-schema.js">
// get-schema.js
// Run with: node --env-file=.env.local get-schema.js

const https = require('https');

// IDs fetched from your app/lib/baserow.ts
const TABLES = {
  PEOPLE: "599",
  ASSIGNMENTS: "603",
  ROLES: "605",
  SCENES: "627",
  AUDITIONS: "630",
};

const BASE_URL = process.env.NEXT_PUBLIC_BASEROW_URL || "https://api.baserow.io";
const TOKEN = process.env.NEXT_PUBLIC_BASEROW_TOKEN;

// Remove trailing slash if present for the fetch URL
const CLEAN_BASE_URL = BASE_URL.replace(/\/$/, "");

async function fetchFields(tableId, tableName) {
  const url = `${CLEAN_BASE_URL}/api/database/fields/table/${tableId}/`;
  
  try {
    const res = await fetch(url, {
      headers: {
        'Authorization': `Token ${TOKEN}`
      }
    });

    if (!res.ok) {
        console.error(`\n Error fetching ${tableName} (${tableId}): ${res.status} ${res.statusText}`);
        return { table: tableName, fields: ["ERROR_FETCHING"] };
    }

    const fields = await res.json();
    // Simplify output to just Name + Type + ID (Tokens save space)
    const simplified = fields.map(f => `${f.name} (ID: field_${f.id}, Type: ${f.type})`);
    return { table: tableName, id: tableId, fields: simplified };

  } catch (e) {
    console.error(`\n Network Error for ${tableName}:`, e.message);
    return { table: tableName, fields: ["NETWORK_ERROR"] };
  }
}

(async () => {
  if (!TOKEN) {
      console.error(" FATAL: No Token found. Make sure .env.local exists and has NEXT_PUBLIC_BASEROW_TOKEN.");
      process.exit(1);
  }

  console.log("--- BASEROW SCHEMA CONTEXT ---");
  console.log(`Target: ${CLEAN_BASE_URL}`);
  
  for (const [name, id] of Object.entries(TABLES)) {
    const data = await fetchFields(id, name);
    if (data.fields[0] !== "ERROR_FETCHING") {
        console.log(`\nTABLE: ${name} (ID: ${id})`);
        console.log(data.fields.join("\n"));
    }
  }
  console.log("\n--- END CONTEXT ---");
})();
</file>

<file path="lib/PeopleContext.tsx">
"use client";
import React, { createContext, useContext, useMemo } from 'react';
import { Performer } from './types';

interface PeopleContextType {
  people: Performer[];
  getName: (id: number) => string;
}

const PeopleContext = createContext<PeopleContextType | undefined>(undefined);

export function PeopleProvider({
  children,
  people,
}: {
  children: React.ReactNode;
  people: Performer[];
}) {
  // Create a map for faster lookups (O(1) access)
  const peopleMap = useMemo(() => {
    const map = new Map<number, Performer>();
    people.forEach((p) => map.set(p.id, p));
    return map;
  }, [people]);

  const getName = (id: number) => {
    return peopleMap.get(id)?.name ?? 'Unknown';
  };

  return (
    <PeopleContext.Provider value={{ people, getName }}>
      {children}
    </PeopleContext.Provider>
  );
}

export function usePeople() {
  const context = useContext(PeopleContext);
  if (context === undefined) {
    throw new Error('usePeople must be used within a PeopleProvider');
  }
  return context;
}
</file>

<file path="next.config.ts">
/** @type {import('next').NextConfig} */
const nextConfig = {
  typescript: {
    // !! WARN !!
    // Dangerously allow production builds to successfully complete even if
    // your project has type errors.
    ignoreBuildErrors: true,
  },
  // Images config
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'files.baserow.io',
        port: '',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'cdn.pixabay.com',
        port: '',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'open-backstage.org',
        port: '',
        pathname: '/**',
      },
    ],
  },
};

export default nextConfig;
</file>

<file path="app/(main)/(casting)/layout.tsx">
export default function CastingLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="flex h-full w-full"> {/* CHANGED: h-screen -> h-full */}
      <main className="flex-1 overflow-auto bg-zinc-900/50 relative">
        {children}
      </main>
    </div>  
  );
}
</file>

<file path="app/(main)/(staff)/layout.tsx">
export default function StaffLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="flex h-full w-full"> {/* CHANGED: h-screen -> h-full */}
      <main className="flex-1 overflow-auto bg-zinc-900/50 relative">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="app/(main)/schedule/page.tsx">
import { cookies } from 'next/headers';
import { 
    getShowById, 
    getActiveProduction,
    getScenes,
    getRoles,
    getAssignments,
    getPeople,
    getProductionEvents // Fetch events if we want to show existing schedule
} from '@/app/lib/baserow';
import SchedulerClient from '@/app/components/schedule/SchedulerClient';

export default async function SchedulerPage() {
  const cookieStore = await cookies();
  let activeId = Number(cookieStore.get('active_production_id')?.value);
  let showTitle = "Select a Production";

  if (activeId) {
    const showData = await getShowById(activeId);
    if (showData && !Array.isArray(showData)) showTitle = showData.Title;
  } else {
    const defaultShow = await getActiveProduction();
    if (defaultShow) {
      activeId = defaultShow.id;
      showTitle = defaultShow.Title;
    }
  }

  // Fetch ALL necessary data to calculate who is in what scene
  const [scenes, roles, assignments, people] = await Promise.all([
      getScenes(activeId),      // Filtered for this show
      getRoles(),               // All roles (blueprint)
      getAssignments(activeId), // Filtered cast list
      getPeople()               // Names/Photos
  ]);

  return (
    <main className="h-screen bg-zinc-950 overflow-hidden">
      <SchedulerClient 
        scenes={scenes}
        roles={roles}
        assignments={assignments}
        people={people}
        productionTitle={showTitle}
        productionId={activeId}
      />
    </main>
  );
}
</file>

<file path="app/(main)/settings/page.tsx">
import { cookies } from 'next/headers';
import { getActiveShows } from '@/app/lib/baserow';
import SettingsClient from '@/app/components/settings/SettingsClient';

export default async function SettingsPage() {
  // 1. Fetch Real Data
  const shows = await getActiveShows();
  
  // 2. Get User Context
  const cookieStore = await cookies();
  const activeId = Number(cookieStore.get('active_production_id')?.value || 0);

  return (
    <div className="h-full p-6 md:p-12 overflow-hidden">
        <header className="mb-8">
            <h1 className="text-4xl font-black uppercase italic tracking-tighter text-white">System Settings</h1>
            <p className="text-zinc-500 font-bold uppercase tracking-widest text-xs mt-2">Manage your account & preferences</p>
        </header>
        
        {/* Render the Client UI */}
        <div className="h-[calc(100vh-200px)]">
            <SettingsClient shows={shows} activeId={activeId} />
        </div>
    </div>
  );
}
</file>

<file path="app/actions.ts">
'use server'

import { cookies } from 'next/headers'
import { redirect } from 'next/navigation'
import { revalidatePath } from 'next/cache'

export async function switchProduction(formData: FormData) {
  const productionId = formData.get('productionId')
  // 1. Capture the path the user is currently on
  const path = formData.get('redirectPath') as string || '/'

  if (productionId) {
     const cookieStore = await cookies()
     // Set the cookie
     cookieStore.set('active_production_id', productionId.toString())
  }

  // 2. Revalidate the specific page so it re-fetches data with the new ID
  revalidatePath(path)
  
  // 3. Redirect back to the same page
  redirect(path)
}
</file>

<file path="app/components/casting/CallbackClient.tsx">
"use client";

import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { 
  Users, Clock, Plus, Trash2, Share, Search, X, 
  Link as LinkIcon, Music, FileText,
  Loader2, Copy, UploadCloud, Eye,
  Mic, Move, Theater, Archive, EyeOff, RotateCcw, Film,
  Star, TrendingDown, Calendar, AlertTriangle
} from 'lucide-react';
import { getAuditionees, updateAuditionSlot, getProductionAssets, createProductionAsset } from '@/app/lib/baserow'; 

// --- CONFIG ---
const DISCLAIMER_TEXT = `*** NOTICE ***
The creative team reserves the right to release actors early if requirements are not met. 
Please be prepared for all listed slots, but be aware the schedule may evolve.`;

// --- TYPES ---
interface Student {
  id: number;
  name: string;
  avatar: string;
  gender: string;
  age: string;
  score: number;
  callbackString: string;
  conflicts: string;
  breakdown: { vocal: number; acting: number; dance: number };
  notes: { vocal: string; acting: string; dance: string; admin: string };
}

interface CallbackSlot {
  id: string;
  time: string;
  title: string;
  type: 'dance' | 'vocal' | 'read';
  materialLink?: string; 
  materialName?: string; 
  assignedIds: number[];
  pairs?: { 
      name: string, 
      assignments: { studentId: number, role: string }[] 
  }[]; 
}

interface Asset {
    id: number;
    url: string;
    name: string;
    type: 'PDF' | 'Audio' | 'Video';
}

const DEFAULT_SLOTS: CallbackSlot[] = [
  { 
    id: 'dance-1', time: '10:00 AM', title: 'General Dance Call', 
    type: 'dance', assignedIds: [] 
  }
];

// --- PARTNER MATCHER COMPONENT ---
const PartnerMatcher = ({ slot, students, onSave, onClose }: any) => {
    // ... (This logic remains exactly the same as your previous code)
    // For brevity, I am keeping the logic identical but assuming it's here.
    // Copy/Paste your PartnerMatcher function here if you need to modify it, 
    // otherwise the logic below is generic enough.
    
    // Quick Re-implementation for context:
    const availableRoles = useMemo(() => {
        const raw = slot.title.split(/ vs | & | \/ | and /i);
        return raw.length > 1 ? raw.map((r:any) => r.trim()) : ["Reader 1", "Reader 2"];
    }, [slot.title]);

    const [localPairs, setLocalPairs] = useState<any[]>(slot.pairs || []);
    
    const unpairedIds = useMemo(() => {
        const pairedSet = new Set(localPairs.flatMap(p => p.assignments.map((a:any) => a.studentId)));
        return slot.assignedIds.filter((id:any) => !pairedSet.has(id));
    }, [slot.assignedIds, localPairs]);

    const addPair = () => setLocalPairs([...localPairs, { name: `Group ${localPairs.length + 1}`, assignments: [] }]);

    const toggleStudentInPair = (studentId: number, pairIndex: number) => {
        const newPairs = [...localPairs];
        const currentPair = newPairs[pairIndex];
        const existingIdx = currentPair.assignments.findIndex((a:any) => a.studentId === studentId);

        if (existingIdx >= 0) {
            currentPair.assignments.splice(existingIdx, 1);
        } else {
            const takenRoles = new Set(currentPair.assignments.map((a:any) => a.role));
            const nextRole = availableRoles.find((r:any) => !takenRoles.has(r)) || availableRoles[0];
            currentPair.assignments.push({ studentId, role: nextRole });
        }
        setLocalPairs(newPairs);
    };

    return (
        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
            <div className="bg-zinc-900 border border-white/10 rounded-2xl w-full max-w-2xl h-[80vh] flex flex-col shadow-2xl">
                <div className="p-4 border-b border-white/10 flex justify-between items-center bg-zinc-900 rounded-t-2xl">
                    <h2 className="text-lg font-black uppercase italic text-white">Partner Matcher</h2>
                    <button onClick={() => { onSave({ ...slot, pairs: localPairs }); onClose(); }} className="bg-blue-600 px-4 py-2 rounded font-bold text-xs uppercase text-white">Save</button>
                </div>
                <div className="flex-1 flex overflow-hidden">
                    <div className="w-1/3 border-r border-white/10 p-4 bg-zinc-950 overflow-y-auto custom-scrollbar">
                        <h3 className="text-xs font-bold text-zinc-500 uppercase mb-4 sticky top-0 bg-zinc-950 py-2">Holding Tank</h3>
                        {unpairedIds.map((id:any) => {
                            const s = students.find((st:any) => st.id === id);
                            if (!s) return null;
                            return <div key={id} className="mb-2 p-2 bg-zinc-900 border border-white/10 rounded text-xs text-zinc-300">{s.name}</div>;
                        })}
                    </div>
                    <div className="flex-1 p-4 overflow-y-auto custom-scrollbar bg-zinc-900 space-y-4">
                        <button onClick={addPair} className="w-full py-2 border border-dashed border-zinc-700 rounded text-xs text-zinc-500 hover:text-white hover:border-zinc-500 uppercase font-bold">+ Add Group</button>
                        {localPairs.map((pair, idx) => (
                            <div key={idx} className="bg-zinc-800/50 border border-white/10 rounded-xl p-3">
                                <input title="pair name" value={pair.name} onChange={(e) => {const c=[...localPairs]; c[idx].name=e.target.value; setLocalPairs(c)}} className="bg-transparent font-bold text-blue-300 w-full mb-2 outline-none text-sm" />
                                <div className="space-y-1">
                                    {pair.assignments.map((assign:any) => {
                                         const s = students.find((st:any) => st.id === assign.studentId);
                                         return <div key={assign.studentId} onClick={() => toggleStudentInPair(assign.studentId, idx)} className="text-xs text-white bg-blue-600/20 p-1.5 rounded cursor-pointer">{s?.name} ({assign.role})</div>
                                    })}
                                </div>
                                {unpairedIds.length > 0 && <div className="mt-2 pt-2 border-t border-white/5 flex flex-wrap gap-1">{unpairedIds.map((id:any) => <button key={id} onClick={() => toggleStudentInPair(id, idx)} className="text-[9px] bg-zinc-950 px-2 py-1 rounded text-zinc-400">+</button>)}</div>}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- MAIN CLIENT COMPONENT ---
interface Props {
  productionId: number;
  productionTitle: string;
}

export default function CallbackClient({ productionId, productionTitle }: Props) {
  const [students, setStudents] = useState<Student[]>([]);
  const [slots, setSlots] = useState<CallbackSlot[]>(DEFAULT_SLOTS);
  const [assets, setAssets] = useState<Asset[]>([]);
  
  const [loading, setLoading] = useState(true);
  const [leftPanelOpen, setLeftPanelOpen] = useState(true); 
  const [rightPanelOpen, setRightPanelOpen] = useState(false); 
  const [search, setSearch] = useState("");
  const [draggedStudentId, setDraggedStudentId] = useState<number | null>(null);
  const [isUploading, setIsUploading] = useState(false);
  const [activeMobileStudent, setActiveMobileStudent] = useState<Student | null>(null);
  const [inspectingStudent, setInspectingStudent] = useState<Student | null>(null);
  
  const [hiddenIds, setHiddenIds] = useState<Set<number>>(new Set());
  const [showHidden, setShowHidden] = useState(false);
  const [sortMode, setSortMode] = useState<'overall' | 'vocal' | 'acting' | 'dance' | 'bottom'>('overall');

  const [isAddingSlot, setIsAddingSlot] = useState(false);
  const [newSlotData, setNewSlotData] = useState({ time: "02:00 PM", title: "", link: "", label: "" });
  const [pairingSlotId, setPairingSlotId] = useState<string | null>(null);

  // --- SAFE STRING HELPER ---
  const safeString = useCallback((val: any): string => {
    if (val === null || val === undefined) return "";
    if (typeof val === 'string') return val;
    if (typeof val === 'number') return String(val);
    if (Array.isArray(val)) return val.length > 0 ? safeString(val[0].value || val[0]) : "";
    if (typeof val === 'object') return val.value ? safeString(val.value) : "";
    return String(val);
  }, []);

  const safeNumber = useCallback((val: any): number => {
      const s = safeString(val);
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
  }, [safeString]);

  // --- 1. LOCAL STORAGE: Hidden IDs & Drafts (Keyed by ID!) ---
  useEffect(() => {
    if(!productionId) return;

    // Load Hidden
    const savedHidden = localStorage.getItem(`hiddenCallbacks_${productionId}`);
    if (savedHidden) setHiddenIds(new Set(JSON.parse(savedHidden)));

    // Load Draft Schedule
    const savedDraft = localStorage.getItem(`draft_callback_slots_${productionId}`);
    if (savedDraft) {
        try {
            const parsed = JSON.parse(savedDraft);
            if (parsed && Array.isArray(parsed) && parsed.length > 0) {
                setSlots(parsed);
            } else {
                setSlots(DEFAULT_SLOTS); // Reset to default if draft is empty
            }
        } catch (e) {
            console.error("Failed to load draft slots", e);
        }
    } else {
        setSlots(DEFAULT_SLOTS);
    }
  }, [productionId]);

  // Save Draft on Change
  useEffect(() => {
    if (productionId && slots.length > 0) {
        localStorage.setItem(`draft_callback_slots_${productionId}`, JSON.stringify(slots));
    }
  }, [slots, productionId]);

  // --- 2. DATA LOADING ---
  useEffect(() => {
    if (!productionId) return;

    async function load() {
      setLoading(true);
      try {
        const rows = await getAuditionees();
        
        const cleanData = rows
            .filter((r: any) => {
                const prodArray = r.Production || [];
                //  FILTER BY ID
                return prodArray.some((p: any) => p.id === productionId);
            })
            .map((r: any) => ({
                id: r.id,
                name: safeString(r.Performer),
                avatar: r.Headshot?.[0]?.url || "",
                age: safeString(r.Age),
                gender: safeString(r.Gender),
                score: safeNumber(r["Average Score"] || r["Vocal Score"]), 
                callbackString: safeString(r["Callbacks"]),
                conflicts: safeString(r["Conflicts"]) || "None listed",
                breakdown: {
                    vocal: safeNumber(r["Vocal Score"]),
                    acting: safeNumber(r["Acting Score"]),
                    dance: safeNumber(r["Dance Score"]),
                },
                notes: {
                    vocal: safeString(r["Music Notes"]),
                    acting: safeString(r["Acting Notes"]),
                    dance: safeString(r["Choreography Notes"]),
                    admin: safeString(r["Admin Notes"])
                }
            }));
        setStudents(cleanData);

        // Fetch Assets for THIS production
        const remoteAssets = await getProductionAssets(productionId);
        setAssets(remoteAssets.map((a: any) => ({
            id: a.id, name: safeString(a.Name), url: a.Link, type: safeString(a.Type?.value || a.Type) as any
        })));

      } catch (e) { console.error(e); }
      setLoading(false);
    }
    load();
  }, [productionId, safeString, safeNumber]);

  // --- ACTIONS ---
  const toggleHideStudent = (e: React.MouseEvent, id: number) => {
      e.stopPropagation();
      setHiddenIds(prev => {
          const next = new Set(prev);
          if (next.has(id)) next.delete(id);
          else next.add(id);
          localStorage.setItem(`hiddenCallbacks_${productionId}`, JSON.stringify(Array.from(next)));
          return next;
      });
  };

  const handleUploadAsset = async (e: React.ChangeEvent<HTMLInputElement>) => {
      if (!e.target.files || !e.target.files[0]) return;
      const file = e.target.files[0];
      setIsUploading(true);
      try {
          const res = await fetch('/api/upload', {
              method: 'POST',
              body: JSON.stringify({ filename: `SIDE-${file.name}`, fileType: file.type }),
          });
          if (!res.ok) throw new Error("Sign failed");
          const { uploadUrl, publicUrl } = await res.json();
          await fetch(uploadUrl, { method: 'PUT', body: file, headers: { "Content-Type": file.type, "x-amz-acl": "public-read" } });
          const type = file.type.includes('pdf') ? 'PDF' : file.type.includes('audio') ? 'Audio' : 'Video';
          
          //  PASS PRODUCTION ID
          await createProductionAsset(file.name, publicUrl, type, productionId);
          
          setAssets(prev => [...prev, { id: Date.now(), name: file.name, url: publicUrl, type }]);
      } catch (err) { alert("Upload failed."); } finally { setIsUploading(false); }
  };

  const handleCopyAsset = (asset: Asset) => {
      navigator.clipboard.writeText(asset.url);
      setNewSlotData(prev => ({ ...prev, link: asset.url, label: asset.name }));
      alert("Link copied! It will auto-fill if you create a slot now.");
  };

  const handleCreateSlot = (e: React.FormEvent) => {
      e.preventDefault();
      const title = newSlotData.title || "New Slot";
      const type = title.toLowerCase().includes('dance') ? 'dance' : title.toLowerCase().includes('vocal') ? 'vocal' : 'read';
      
      setSlots(prev => [...prev, {
          id: Date.now().toString(),
          time: newSlotData.time,
          title,
          type,
          materialLink: newSlotData.link || undefined,
          materialName: newSlotData.link ? (newSlotData.label || "Material") : undefined,
          assignedIds: []
      }]);
      setIsAddingSlot(false);
      setNewSlotData({ time: "", title: "", link: "", label: "" });
  };

  const handleRemoveSlot = (id: string) => setSlots(prev => prev.filter(s => s.id !== id));

  const handleAssign = (studentId: number, slotId: string) => {
      setSlots(prev => prev.map(s => {
          if (s.id === slotId && !s.assignedIds.includes(studentId)) {
              return { ...s, assignedIds: [...s.assignedIds, studentId] };
          }
          return s;
      }));
      setActiveMobileStudent(null);
  };

  const handleUnassign = (studentId: number, slotId: string) => {
      setSlots(prev => prev.map(s => {
          if (s.id === slotId) {
              return { ...s, assignedIds: s.assignedIds.filter(id => id !== studentId) };
          }
          return s;
      }));
  };

  const handlePublish = async () => {
      if(!confirm(`Publish updates for ${productionTitle} to Baserow?`)) return;
      const updates: Record<number, string> = {};
      slots.forEach(slot => {
          slot.assignedIds.forEach(id => {
              let entry = `${slot.time}: ${slot.title}`;
              if (slot.materialLink) entry += ` (Link: ${slot.materialLink})`;
              if (slot.pairs && slot.pairs.length > 0) {
                  const pair = slot.pairs.find(p => p.assignments.some(a => a.studentId === id));
                  if (pair) {
                      const assignment = pair.assignments.find(a => a.studentId === id);
                      entry += ` [${pair.name}: ${assignment?.role}]`;
                  }
              }
              if (updates[id]) updates[id] += `\n${entry}`;
              else updates[id] = entry;
          });
      });
      let count = 0;
      for (const [id, text] of Object.entries(updates)) {
          const finalString = `${text}\n\n${DISCLAIMER_TEXT}`;
          await updateAuditionSlot(Number(id), { "Callbacks": finalString });
          count++;
      }
      
      // Clear draft after successful publish
      localStorage.removeItem(`draft_callback_slots_${productionId}`);
      
      alert(`Published ${count} schedules!`);
  };

  const benchList = useMemo(() => {
      return students
        .filter(s => {
            const matchesSearch = s.name.toLowerCase().includes(search.toLowerCase());
            const isVisible = showHidden || !hiddenIds.has(s.id);
            return matchesSearch && isVisible;
        })
        .sort((a, b) => {
            if (sortMode === 'overall') return b.score - a.score;
            if (sortMode === 'vocal') return b.breakdown.vocal - a.breakdown.vocal;
            if (sortMode === 'acting') return b.breakdown.acting - a.breakdown.acting;
            if (sortMode === 'dance') return b.breakdown.dance - a.breakdown.dance;
            if (sortMode === 'bottom') return a.score - b.score; 
            return 0;
        });
  }, [students, search, hiddenIds, showHidden, sortMode]);

  const getDisplayScore = (student: Student) => {
      if (sortMode === 'vocal') return `Vocal: ${student.breakdown.vocal}`;
      if (sortMode === 'acting') return `Act: ${student.breakdown.acting}`;
      if (sortMode === 'dance') return `Dance: ${student.breakdown.dance}`;
      return `Avg: ${student.score.toFixed(1)}`;
  };

  const handleDragStart = (e: React.DragEvent, id: number) => {
      setDraggedStudentId(id);
      e.dataTransfer.effectAllowed = "copy";
  };
  const handleDragOver = (e: React.DragEvent) => { e.preventDefault(); };
  const handleDrop = (e: React.DragEvent, slotId: string) => {
      e.preventDefault();
      if(draggedStudentId) handleAssign(draggedStudentId, slotId);
      setDraggedStudentId(null);
  };

  if (loading) return <div className="h-screen bg-zinc-950 flex items-center justify-center text-white"><Loader2 className="animate-spin text-blue-500 mr-2" /> Loading {productionTitle}...</div>;

  // --- RENDER (Largely Unchanged, just uses productionTitle) ---
  return (
    <div className="h-screen bg-zinc-950 text-white flex overflow-hidden relative font-sans">
        
        {/* LEFT: BENCH */}
        <aside className={`${leftPanelOpen ? 'w-[320px]' : 'w-0'} bg-zinc-900 border-r border-white/5 transition-all duration-300 flex flex-col shrink-0 overflow-hidden`}>
            {/* ... Bench Header ... */}
             <div className="p-4 border-b border-white/5 bg-zinc-900 shrink-0 flex justify-between items-center">
                <div className="flex items-center gap-2">
                    <Users size={18} className="text-zinc-400" />
                    <h2 className="text-sm font-black uppercase tracking-widest">Bench</h2>
                    <span className="bg-zinc-800 text-zinc-500 px-2 py-0.5 rounded-full text-[10px] font-bold">{benchList.length}</span>
                </div>
                {/* ... Sort and Search bars ... */}
                 <div className="flex gap-2">
                    <button onClick={() => setShowHidden(!showHidden)} className={`p-2 rounded-lg transition-colors group relative ${showHidden ? 'bg-amber-900/30 text-amber-500' : 'text-zinc-600 hover:text-zinc-400'}`}>
                        {showHidden ? <Eye size={16} /> : <EyeOff size={16} />}
                    </button>
                    <button onClick={() => setLeftPanelOpen(false)} className="md:hidden text-zinc-500"><X size={16}/></button>
                </div>
            </div>
            
            {/* SORT BAR */}
            <div className="px-2 pt-2 flex gap-1 justify-between shrink-0">
                {[
                    { id: 'overall', icon: Star },
                    { id: 'vocal', icon: Mic },
                    { id: 'acting', icon: Theater },
                    { id: 'dance', icon: Move },
                    { id: 'bottom', icon: TrendingDown },
                ].map((btn) => (
                    <button key={btn.id} onClick={() => setSortMode(btn.id as any)} className={`group relative flex-1 py-2 rounded flex justify-center transition-colors ${sortMode === btn.id ? 'bg-blue-600 text-white' : btn.id === 'bottom' ? 'bg-zinc-900 text-red-400 hover:bg-zinc-800' : 'bg-zinc-900 text-zinc-500 hover:bg-zinc-800'}`}>
                        <btn.icon size={14} />
                    </button>
                ))}
            </div>

            <div className="p-2 border-b border-white/5 shrink-0">
                <div className="relative">
                    <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500" />
                    <input value={search} onChange={(e) => setSearch(e.target.value)} className="bg-zinc-950 rounded p-2 pl-9 text-xs w-full border border-white/5 focus:border-blue-500 outline-none" placeholder="Search..." />
                </div>
            </div>

            {/* List */}
            <div className="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar pb-20">
                {benchList.map(student => (
                    <div 
                        key={student.id} draggable onDragStart={(e) => handleDragStart(e, student.id)}
                        onClick={() => { if (window.innerWidth < 768) { setActiveMobileStudent(student); setLeftPanelOpen(false); }}}
                        className={`group flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-grab active:cursor-grabbing border relative transition-colors ${activeMobileStudent?.id === student.id ? 'bg-blue-900/20 border-blue-500/30' : 'border-transparent'} ${hiddenIds.has(student.id) ? 'opacity-50 grayscale' : ''}`}
                    >
                        <img src={student.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-8 h-8 rounded-full object-cover bg-zinc-800" alt="" />
                        <div className="min-w-0 flex-1">
                            <p className="text-xs font-bold truncate">{student.name}</p>
                            <div className="flex gap-2 text-[10px] text-zinc-500">
                                <span className={`font-bold ${student.score >= 4 ? 'text-green-400' : 'text-zinc-400'}`}>{getDisplayScore(student)}</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-1">
                            <button onClick={(e) => toggleHideStudent(e, student.id)} className={`p-1.5 rounded-full transition-colors ${hiddenIds.has(student.id) ? 'text-amber-500 bg-amber-900/20' : 'text-zinc-600 hover:text-white hover:bg-white/10'}`}>
                                {hiddenIds.has(student.id) ? <RotateCcw size={14} /> : <Archive size={14} />}
                            </button>
                            <button onClick={(e) => { e.stopPropagation(); setInspectingStudent(student); }} className="p-1.5 rounded-full text-zinc-600 hover:text-white hover:bg-white/10 transition-colors">
                                <Eye size={14} />
                            </button>
                        </div>
                    </div>
                ))}
            </div>
        </aside>

        {/* CENTER: MATRIX */}
        <main className="flex-1 flex flex-col min-w-0 bg-zinc-950 relative">
            <header className="h-16 border-b border-white/10 bg-zinc-900/50 flex items-center justify-between px-6 shrink-0">
                <div className="flex items-center gap-4">
                    <button onClick={() => setLeftPanelOpen(!leftPanelOpen)} className={`p-2 rounded-lg ${!leftPanelOpen ? 'bg-blue-600' : 'bg-zinc-800'}`}><Users size={18} /></button>
                    <div>
                        <div className="text-[10px] font-bold text-zinc-500 uppercase">Callbacks for</div>
                        <h1 className="text-lg font-black uppercase italic tracking-tighter text-white">{productionTitle}</h1>
                    </div>
                </div>
                <div className="flex gap-2">
                    <button onClick={() => setRightPanelOpen(!rightPanelOpen)} className={`flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold uppercase ${rightPanelOpen ? 'bg-zinc-700' : 'bg-zinc-800 text-zinc-300'}`}><UploadCloud size={14} /> <span className="hidden md:inline">Library</span></button>
                    <button onClick={() => setIsAddingSlot(true)} className="flex items-center gap-2 bg-zinc-800 text-zinc-300 px-3 py-2 rounded-lg text-xs font-bold uppercase"><Plus size={14} /> <span className="hidden md:inline">Slot</span></button>
                    <button onClick={handlePublish} className="flex items-center gap-2 bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold uppercase shadow-lg shadow-blue-900/20"><Share size={14} /> <span className="hidden md:inline">Publish</span></button>
                </div>
            </header>

            {/* ... Rest of Matrix / Modals / Library ... */}
            {/* The rest of the render is identical to your original code, 
                so I'm truncating slightly for brevity, but you should copy 
                everything from your original file inside the <main> block 
                down to the end of the file here. */}
                
            <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 custom-scrollbar">
                {slots.map((slot) => (
                    <div 
                        key={slot.id} onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, slot.id)}
                        onClick={() => { if(activeMobileStudent) handleAssign(activeMobileStudent.id, slot.id); }}
                        className={`relative rounded-2xl border transition-all overflow-hidden group ${activeMobileStudent ? 'border-blue-500/50 bg-blue-900/5 cursor-pointer' : 'border-white/5 bg-zinc-900/30 hover:border-white/10'}`}
                    >
                        <div className={`absolute left-0 top-0 bottom-0 w-1 ${slot.type === 'dance' ? 'bg-emerald-500' : slot.type === 'vocal' ? 'bg-purple-500' : 'bg-blue-500'}`} />
                        <div className="p-4 pl-6 flex flex-col md:flex-row gap-6 md:items-center">
                            
                            {/* SLOT INFO */}
                            <div className="min-w-[200px] shrink-0">
                                <div className="flex items-center gap-2 text-zinc-500 mb-1"><Clock size={12} /><span className="text-xs font-black uppercase tracking-wider">{slot.time}</span></div>
                                <h3 className="text-lg font-bold text-white leading-tight mb-2">{slot.title}</h3>
                                {slot.materialLink ? (
                                    <a href={slot.materialLink} target="_blank" className="flex items-center gap-1.5 text-[10px] font-bold text-blue-400 uppercase bg-blue-900/20 px-2 py-1 rounded w-fit border border-blue-500/20" onClick={(e) => e.stopPropagation()}><LinkIcon size={10} /> {slot.materialName || "Sides"}</a>
                                ) : <p className="text-[10px] text-zinc-600 italic">No assets attached</p>}
                            </div>

                            {/* ASSIGNED GRID or PAIRS */}
                            <div className="flex-1 w-full">
                                {slot.pairs && slot.pairs.length > 0 ? (
                                    <div className="flex flex-wrap gap-2">
                                        {slot.pairs.map((pair, pIdx) => (
                                            <div key={pIdx} className="bg-zinc-800/80 border border-blue-500/30 rounded-lg px-3 py-1.5 flex items-center gap-2">
                                                <span className="text-[10px] font-black text-blue-400 uppercase mr-1">{pair.name}:</span>
                                                <div className="flex -space-x-1.5">
                                                    {pair.assignments.map(a => {
                                                        const s = students.find(st => st.id === a.studentId);
                                                        return s ? (
                                                            <div key={a.studentId} className="relative group/face">
                                                                <img src={s.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-6 h-6 rounded-full border border-black object-cover" title={`${s.name} (${a.role})`} alt={s.name} />
                                                                <span className="absolute bottom-full mb-1 hidden group-hover/face:block bg-black text-white text-[8px] px-1 py-0.5 rounded whitespace-nowrap">{a.role}</span>
                                                            </div>
                                                        ) : null;
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="flex flex-wrap gap-2">
                                        {slot.assignedIds.length === 0 && <span className="text-zinc-700 text-xs font-bold uppercase tracking-wider">Drag students here...</span>}
                                        {slot.assignedIds.map(id => {
                                            const student = students.find(s => s.id === id);
                                            if (!student) return null;
                                            return (
                                                <div key={id} onClick={(e) => { e.stopPropagation(); setInspectingStudent(student); }} className="flex items-center gap-2 bg-zinc-800 border border-white/5 pl-1 pr-2 py-1 rounded-full cursor-pointer hover:bg-zinc-700">
                                                    <img src={student.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-5 h-5 rounded-full object-cover" alt="" />
                                                    <span className="text-xs font-bold text-zinc-300">{student.name}</span>
                                                    <button onClick={(e) => { e.stopPropagation(); handleUnassign(id, slot.id); }} className="ml-1 text-zinc-600 hover:text-red-400" title="Remove"><X size={12} /></button>
                                                </div>
                                            )
                                        })}
                                    </div>
                                )}
                            </div>

                            {/* SLOT ACTIONS */}
                            <div className="flex flex-col gap-2 items-end">
                                <button onClick={(e) => { e.stopPropagation(); setPairingSlotId(slot.id); }} className="text-zinc-500 hover:text-blue-400 p-1.5 bg-zinc-800/50 rounded-lg hover:bg-zinc-800 transition-colors" title="Manage Pairs / Reads"><Users size={16} /></button>
                                <button onClick={(e) => { e.stopPropagation(); handleRemoveSlot(slot.id); }} className="text-zinc-600 hover:text-red-500 p-1.5 hover:bg-zinc-800 rounded-lg transition-colors" title="Delete Slot"><Trash2 size={16} /></button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
            
            {/* ... Right Panel (Library) and Modals ... */}
            {/* Same logic, just include them below */}
             <aside className={`${rightPanelOpen ? 'w-[300px]' : 'w-0'} bg-zinc-900 border-l border-white/5 transition-all duration-300 flex flex-col shrink-0 overflow-hidden`}>
             <div className="p-4 border-b border-white/5 bg-zinc-900 shrink-0 flex justify-between items-center">
                <h2 className="text-sm font-black uppercase tracking-widest flex items-center gap-2"><UploadCloud size={16} className="text-blue-500"/> Library</h2>
                <button onClick={() => setRightPanelOpen(false)} className="md:hidden" title="Close Library"><X size={16}/></button>
            </div>
            <div className="p-4 shrink-0 border-b border-white/5">
                <label className={`w-full h-24 border-2 border-dashed border-zinc-700 rounded-xl flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-white/5 transition-colors ${isUploading ? 'opacity-50 cursor-wait' : ''}`}>
                    {isUploading ? <Loader2 className="animate-spin text-blue-500" /> : <Plus className="text-zinc-500" />}
                    <span className="text-[10px] font-bold uppercase text-zinc-500">{isUploading ? "Uploading..." : "Upload PDF / MP3"}</span>
                    <input type="file" accept=".pdf,audio/*,video/*" className="hidden" onChange={handleUploadAsset} disabled={isUploading} />
                </label>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                {assets.map((asset, i) => (
                    <div key={i} className="bg-zinc-950 p-3 rounded-xl border border-white/5 group relative">
                        <div className="flex items-start gap-3 mb-2">
                            <div className="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center shrink-0">
                                {asset.type === 'PDF' ? <FileText size={16} className="text-blue-400"/> : asset.type === 'Video' ? <Film size={16} className="text-pink-400"/> : <Music size={16} className="text-purple-400"/>}
                            </div>
                            <div className="min-w-0">
                                <p className="text-xs font-bold text-zinc-300 truncate" title={asset.name}>{asset.name}</p>
                                <p className="text-[10px] text-zinc-600 uppercase">{asset.type}</p>
                            </div>
                        </div>
                        <button onClick={() => handleCopyAsset(asset)} className="w-full py-1.5 bg-zinc-800 hover:bg-blue-600 hover:text-white text-zinc-400 rounded text-[10px] font-bold uppercase transition-colors flex items-center justify-center gap-2 border border-white/5 hover:border-blue-500"><Copy size={12} /> Copy Link</button>
                    </div>
                ))}
            </div>
        </aside>

        {isAddingSlot && (
            <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setIsAddingSlot(false)}>
                <form onSubmit={handleCreateSlot} onClick={e => e.stopPropagation()} className="bg-zinc-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-sm p-6 space-y-4">
                    <h3 className="text-lg font-black uppercase italic">Create Callback Slot</h3>
                    <div>
                        <label className="text-[10px] font-bold uppercase text-zinc-500">Time</label>
                        <input autoFocus value={newSlotData.time} onChange={e => setNewSlotData({...newSlotData, time: e.target.value})} className="w-full bg-zinc-950 border border-white/10 rounded p-2 text-sm focus:border-blue-500 outline-none text-white" />
                    </div>
                    <div>
                        <label className="text-[10px] font-bold uppercase text-zinc-500">Title</label>
                        <input placeholder="e.g. Ariel Reading" value={newSlotData.title} onChange={e => setNewSlotData({...newSlotData, title: e.target.value})} className="w-full bg-zinc-950 border border-white/10 rounded p-2 text-sm focus:border-blue-500 outline-none text-white" />
                    </div>
                    <div>
                        <label className="text-[10px] font-bold uppercase text-zinc-500">Asset Link (Optional)</label>
                        <input placeholder="https://..." value={newSlotData.link} onChange={e => setNewSlotData({...newSlotData, link: e.target.value})} className="w-full bg-zinc-950 border border-white/10 rounded p-2 text-sm focus:border-blue-500 outline-none text-white" />
                        {newSlotData.link && (
                            <input placeholder="Label (e.g. Sheet Music)" value={newSlotData.label} onChange={e => setNewSlotData({...newSlotData, label: e.target.value})} className="w-full bg-zinc-950 border border-white/10 rounded p-2 text-sm mt-2 focus:border-blue-500 outline-none text-white" />
                        )}
                    </div>
                    <div className="flex gap-2 pt-2">
                        <button type="button" onClick={() => setIsAddingSlot(false)} className="flex-1 py-3 bg-zinc-800 rounded-lg text-xs font-bold uppercase hover:bg-zinc-700">Cancel</button>
                        <button type="submit" className="flex-1 py-3 bg-blue-600 rounded-lg text-xs font-bold uppercase hover:bg-blue-500 text-white">Create Slot</button>
                    </div>
                </form>
            </div>
        )}

        {pairingSlotId && (
            <PartnerMatcher 
                slot={slots.find(s => s.id === pairingSlotId)!}
                students={students}
                onClose={() => setPairingSlotId(null)}
                onSave={(updatedSlot:any) => {
                    setSlots(prev => prev.map(s => s.id === updatedSlot.id ? updatedSlot : s));
                }}
            />
        )}
        
        {inspectingStudent && (
             <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setInspectingStudent(null)}>
                 <div className="bg-zinc-900 border border-white/10 rounded-2xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
                     <div className="p-6 pb-4 border-b border-white/5 flex gap-4 items-start">
                         <img src={inspectingStudent.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-20 h-20 rounded-xl object-cover bg-zinc-800" alt={inspectingStudent.name} />
                         <div className="flex-1">
                             <h2 className="text-2xl font-black uppercase italic leading-none">{inspectingStudent.name}</h2>
                             <p className="text-zinc-500 text-xs font-bold uppercase mt-1">Age {inspectingStudent.age}  {inspectingStudent.gender}</p>
                             <div className="flex gap-2 mt-3">
                                <div className="bg-blue-900/30 text-blue-300 px-3 py-1 rounded text-xs font-bold">Vocal: {inspectingStudent.breakdown.vocal || '-'}</div>
                                <div className="bg-purple-900/30 text-purple-300 px-3 py-1 rounded text-xs font-bold">Dance: {inspectingStudent.breakdown.dance || '-'}</div>
                                <div className="bg-emerald-900/30 text-emerald-300 px-3 py-1 rounded text-xs font-bold">Act: {inspectingStudent.breakdown.acting || '-'}</div>
                             </div>
                         </div>
                         <button onClick={() => setInspectingStudent(null)} className="p-2 bg-zinc-800 rounded-full hover:bg-zinc-700 text-zinc-400" title="Close"><X size={20}/></button>
                     </div>
                     <div className="p-6 overflow-y-auto space-y-6 custom-scrollbar">
                        <div className="bg-red-900/10 border border-red-500/20 p-4 rounded-xl">
                            <h3 className="text-red-400 font-black uppercase text-xs tracking-widest flex items-center gap-2 mb-2"><Calendar size={14} /> Conflicts</h3>
                            <p className="text-zinc-300 text-sm leading-relaxed">{inspectingStudent.conflicts}</p>
                        </div>
                        <div className="space-y-4">
                            {inspectingStudent.notes.vocal && <div><h4 className="text-xs font-bold uppercase text-zinc-500 mb-1 flex items-center gap-2"><Mic size={12}/> Music Notes</h4><p className="text-sm text-zinc-300 bg-zinc-950 p-3 rounded-lg border border-white/5">{inspectingStudent.notes.vocal}</p></div>}
                            {inspectingStudent.notes.acting && <div><h4 className="text-xs font-bold uppercase text-zinc-500 mb-1 flex items-center gap-2"><Theater size={12}/> Acting Notes</h4><p className="text-sm text-zinc-300 bg-zinc-950 p-3 rounded-lg border border-white/5">{inspectingStudent.notes.acting}</p></div>}
                            {inspectingStudent.notes.dance && <div><h4 className="text-xs font-bold uppercase text-zinc-500 mb-1 flex items-center gap-2"><Move size={12}/> Choreography Notes</h4><p className="text-sm text-zinc-300 bg-zinc-950 p-3 rounded-lg border border-white/5">{inspectingStudent.notes.dance}</p></div>}
                            {inspectingStudent.notes.admin && <div><h4 className="text-xs font-bold uppercase text-zinc-500 mb-1 flex items-center gap-2"><AlertTriangle size={12}/> Admin Notes</h4><p className="text-sm text-zinc-300 bg-zinc-950 p-3 rounded-lg border border-white/5">{inspectingStudent.notes.admin}</p></div>}
                        </div>
                     </div>
                 </div>
             </div>
        )}

        </main>
    </div>
  );
}
</file>

<file path="app/login/page.tsx">
"use client";
import { useState, FormEvent } from 'react';
import { useRouter } from 'next/navigation';
import { Lock, Loader2 } from 'lucide-react';

export default function LoginPage() {
  const [password, setPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false); // New: Visual feedback
  const router = useRouter();

const handleLogin = async (e: FormEvent) => {
    e.preventDefault(); 
    if (!password) return; 

    setIsLoading(true); 

    // 1. Set the cookie
    document.cookie = `cyt_auth=${password}; path=/; max-age=86400;`; 
    
    // 2. THE NUCLEAR OPTION
    // Instead of router.push('/'), use this:
    window.location.href = '/'; 
  };

  return (
    <div className="h-screen bg-zinc-950 flex items-center justify-center p-4">
      <div className="w-full max-w-sm bg-zinc-900 border border-white/10 p-8 rounded-2xl shadow-2xl text-center space-y-6">
        
        <div className="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto border border-blue-500/20">
            <Lock size={32} className="text-blue-500" />
        </div>
        
        <h1 className="text-2xl font-black uppercase italic text-white tracking-tight">Staff Access</h1>
        
        {/* NEW: Wrapping in a form makes 'Enter' key work automatically */}
        <form onSubmit={handleLogin} className="space-y-4">
            <input 
                type="passcode" 
                autoComplete="one-time-code"
                placeholder="Enter Access Code..." 
                className="w-full bg-black border border-zinc-700 p-4 rounded-xl text-white text-center focus:border-blue-500 outline-none text-lg tracking-widest placeholder:text-zinc-600 transition-all"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                disabled={isLoading} // Prevent double-clicks
            />
            
            <button 
                type="submit" 
                disabled={isLoading || !password}
                className="w-full bg-white text-black font-black uppercase py-4 rounded-xl hover:bg-zinc-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
                {isLoading ? (
                    <>
                        <Loader2 className="animate-spin" size={20} />
                        Verifying...
                    </>
                ) : (
                    "Enter Deck"
                )}
            </button>
        </form>

      </div>
    </div>
  );
}
</file>

<file path="middleware.ts">
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  const authCookie = request.cookies.get('cyt_auth');
  const { pathname } = request.nextUrl;
  
  // FIX: Fallback to 'cytfred' if the environment variable is missing
  const APP_PASSWORD = process.env.APP_PASSWORD || 'cytfred';

  // 1. PUBLIC ASSETS IGNORE (Safety Net)
  // If the matcher misses something, this ensures we don't block images
  if (pathname.match(/\.(png|jpg|jpeg|svg|css|js|ico)$/)) {
    return NextResponse.next();
  }

  // 2. ALREADY LOGGED IN?
  // If user is on /login but has the cookie, bump them to Dashboard
  if (pathname === '/login') {
    if (authCookie?.value === APP_PASSWORD) {
      return NextResponse.redirect(new URL('/', request.url));
    }
    return NextResponse.next(); // Let them view the login page
  }

  // 3. PROTECTED ROUTES
  // If they lack the cookie, send them to login
  if (!authCookie || authCookie.value !== APP_PASSWORD) {
    const loginUrl = new URL('/login', request.url);
    return NextResponse.redirect(loginUrl);
  }

  return NextResponse.next();
}

export const config = {
  // Run on everything EXCEPT internal Next.js files and static assets
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
};
</file>

<file path="app/(main)/(casting)/auditions/page.tsx">
import { cookies } from 'next/headers';
import { getShowById, getActiveProduction } from '@/app/lib/baserow';
import AuditionsClient from '@/app/components/auditions/AuditionsClient';

export default async function AuditionsPage() {
  // 1. Try to get ID from Cookie
  const cookieStore = await cookies();
  let activeId = Number(cookieStore.get('active_production_id')?.value);
  let showTitle = "Select a Production";

  // 2. Resolve the ID
  if (activeId) {
    const showData = await getShowById(activeId);
    if (showData) {
      showTitle = showData.Title;
    }
  } 
  
  // 3. FALLBACK: If no cookie, fetch the default Active Show
  if (!activeId || showTitle === "Select a Production") {
    const defaultShow = await getActiveProduction();
    if (defaultShow) {
      activeId = defaultShow.id;
      showTitle = defaultShow.Title;
    }
  }

  // 4. Render Client
  return (
    <main className="min-h-screen bg-black">
      <AuditionsClient productionId={activeId} productionTitle={showTitle} />
    </main>
  );
}
</file>

<file path="app/(main)/(casting)/callbacks/page.tsx">
import { cookies } from 'next/headers';
import { getShowById, getActiveProduction } from '@/app/lib/baserow';
import CallbackClient from '@/app/components/casting/CallbackClient';

export default async function CallbacksPage() {
  // 1. Try to get ID from Cookie
  const cookieStore = await cookies();
  let activeId = Number(cookieStore.get('active_production_id')?.value);
  let showTitle = "Select a Production";

  // 2. Resolve the ID
  if (activeId) {
    const showData = await getShowById(activeId);
    if (showData) {
      showTitle = showData.Title;
    }
  } 
  
  // 3. FALLBACK: If no cookie, fetch the default Active Show
  if (!activeId || showTitle === "Select a Production") {
    const defaultShow = await getActiveProduction();
    if (defaultShow) {
      activeId = defaultShow.id;
      showTitle = defaultShow.Title;
    }
  }

  // 4. Render Client
  return (
    <main className="min-h-screen bg-zinc-950">
      <CallbackClient productionId={activeId} productionTitle={showTitle} />
    </main>
  );
}
</file>

<file path="app/(main)/(staff)/committees/page.tsx">
import { cookies } from 'next/headers';
import { getCommitteePreferences, getAuditionSlots } from '@/app/lib/baserow';
import CommitteeDashboard from '@/app/components/committees/CommitteeClient';

/**
 * SERVER COMPONENT
 * Fetches the raw data required for the committee management dashboard.
 */
export default async function CommitteesPage() {
  // 1. Get the current show context from the user's cookies
  const cookieStore = await cookies();
  const activeId = Number(cookieStore.get('active_production_id')?.value);

  // 2. Fetch data from Baserow. 
  // We pass the activeId so the server only grabs relevant records 
  // for the current show (Little Mermaid, etc.)
  const [prefData, studentData] = await Promise.all([
    getCommitteePreferences(activeId),
    getAuditionSlots(activeId)
  ]);

  return (
    <main className="h-screen bg-zinc-950 overflow-hidden">
      {/* We pass the fetched data as initial props to avoid 
          flickering, but we also pass activeId so the client 
          component can re-fetch if the user switches shows. 
      */}
      <CommitteeDashboard 
        activeId={activeId} 
        initialPrefs={prefData} 
        initialStudents={studentData} 
      />
    </main>
  );
}
</file>

<file path="app/(main)/(staff)/roster/page.tsx">
import { cookies } from 'next/headers';
import { 
    getActiveProduction, 
    getShowById, // <--- 1. Import this!
    getAssignments, 
    getComplianceData, 
    getPeople 
} from '@/app/lib/baserow';
import StaffClient from '@/app/components/staff/StaffClient';

export default async function RosterPage() {
  const cookieStore = await cookies();
  const activeId = Number(cookieStore.get('active_production_id')?.value);
  
  let productionTitle = "Cast Roster";
  let productionId = activeId || 0;

  // 2. LOGIC FIX:
  if (activeId) {
      // If we have a cookie, fetch THAT specific show
      const showData = await getShowById(activeId);
      
      // Baserow sometimes returns an array [obj] or just obj depending on the endpoint
      const prod = Array.isArray(showData) ? showData[0] : showData;
      
      if (prod) productionTitle = prod.Title;
  } else {
      // Fallback: If no cookie, get the default "Active" show
      const prod = await getActiveProduction(); 
      if (prod) {
          productionTitle = prod.Title;
          productionId = prod.id;
      }
  }

  // 3. Fetch Data using the determined ID
  const [assignments, people, compliance] = await Promise.all([
      getAssignments(productionId),
      getPeople(),
      getComplianceData(productionId)
  ]);

  return (
    <main className="h-full bg-zinc-950 overflow-hidden">
      <StaffClient 
        productionTitle={productionTitle} 
        assignments={assignments}
        people={people}
        compliance={compliance}
      />
    </main>
  );
}
</file>

<file path="app/(main)/education/page.tsx">
import { cookies } from 'next/headers';
import { getPeople } from '@/app/lib/baserow';
import { MOCK_CLASSES } from '../../lib/educationFillerData';
import ClassManager from '@/app/components/education/ClassManager';

export default async function EducationPage() {
  const people = await getPeople();

  return (
    <main className="h-screen bg-zinc-950 overflow-hidden">
      <ClassManager classes={MOCK_CLASSES} people={people} />
    </main>
  );
}
</file>

<file path="app/components/auditions/AuditionsClient.tsx">
"use client";

import React, { useState, useEffect, useMemo } from "react";
import {
  User, Star, Music, Move, X, Save, Clock, CheckCircle2, 
  MessageSquare, Search, UserPlus, PlayCircle, Film, Loader2
} from "lucide-react";
import { getAuditionees, updateAuditionSlot, submitAudition } from "@/app/lib/baserow";
import ActorProfileModal from "@/app/components/ActorProfileModal";
import ChoreoWorkspace from "@/app/components/ChoreoWorkspace";

// --- TYPES ---
interface Performer {
  id: number;
  originalId: number;
  performerId?: number;
  name: string;
  avatar: string | null;
  age: string;
  video: string | null;
  height: string;
  vocalRange: string;
  dob: string;
  conflicts: string;
  tenure: string;
  pastRoles: string | string[];
  song: string;
  monologue: string;
  timeSlot: string;
  session: AuditionSession;
  vocal: number;
  acting: number;
  dance: number;
  presence: number;
  actingNotes: string;
  musicNotes: string;
  choreoNotes: string;
  dropInNotes: string;
  adminNotes: string;
  isWalkIn: boolean;
}

type AuditionSession = "Thursday" | "Friday" | "Video/Remote" | "Walk-In";
type JudgeRole = "Director" | "Music" | "Choreographer" | "Drop-In" | "Admin";

const ROLE_THEMES: Record<JudgeRole, { color: string; text: string; glow: string; weight: string }> = {
  Director: { color: "border-blue-500", text: "text-blue-400", glow: "shadow-blue-500/20", weight: "Acting 60% | Vocal 20% | Dance 20%" },
  Music: { color: "border-purple-500", text: "text-purple-400", glow: "shadow-purple-500/20", weight: "Vocal 80% | Acting 20%" },
  Choreographer: { color: "border-emerald-500", text: "text-emerald-400", glow: "shadow-emerald-500/20", weight: "Dance 80% | Presence 20%" },
  "Drop-In": { color: "border-amber-500", text: "text-amber-400", glow: "shadow-amber-500/20", weight: "Impression Only" },
  Admin: { color: "border-zinc-100", text: "text-zinc-100", glow: "shadow-white/5", weight: "Full Access" },
};

// --- HELPER COMPONENT: RUBRIC SLIDER ---
const RubricSlider = ({ label, val, setVal, disabled }: { label: string, val: number, setVal: (n: number) => void, disabled: boolean }) => (
  <div className={`space-y-3 ${disabled ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
    <div className="flex justify-between items-end">
      <label className="text-xs font-black uppercase tracking-widest text-zinc-400 flex items-center gap-2">
        {label === "Vocal Ability" && <Music size={14} className="text-purple-500" />}
        {label === "Acting / Reads" && <Star size={14} className="text-blue-500" />}
        {label === "Dance / Movement" && <Move size={14} className="text-emerald-500" />}
        {label}
      </label>
      <span className={`text-xl font-black ${val > 0 ? 'text-white' : 'text-zinc-700'}`}>{val || "-"}</span>
    </div>
    <input 
      type="range" min="0" max="5" step="1" value={val} 
      onChange={(e) => setVal(Number(e.target.value))} 
      className="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-blue-500" 
      aria-label={`Score for ${label}`} 
    />
    <div className="flex justify-between text-[9px] font-bold uppercase text-zinc-600 px-1">
      <span>N/A</span>
      <span>Weak</span>
      <span>Fair</span>
      <span>Good</span>
      <span>Great</span>
      <span>Exc.</span>
    </div>
  </div>
);

interface AuditionsClientProps {
  productionId: number;
  productionTitle: string;
}

export default function AuditionsClient({ productionId, productionTitle }: AuditionsClientProps) {
  const [isMounted, setIsMounted] = useState(false); 
  
  // Judge State (Stored in LocalStorage as it's device-specific)
  const [judgeName, setJudgeName] = useState("");
  const [judgeRole, setJudgeRole] = useState<JudgeRole | null>(null);
  const [isReady, setIsReady] = useState(false);

  // App State
  const [searchQuery, setSearchQuery] = useState("");
  const [activeSession, setActiveSession] = useState<AuditionSession>("Thursday");
  const [selectedPerson, setSelectedPerson] = useState<Performer | null>(null);
  const [inspectingActor, setInspectingActor] = useState<Performer | null>(null);
  const [loading, setLoading] = useState(false);

  // Data
  const [scheduledPerformers, setScheduledPerformers] = useState<Performer[]>([]);
  const [allStudents, setAllStudents] = useState<any[]>([]); 
  const [grades, setGrades] = useState<Record<number, any>>({});
  
  // Current Editing Score
  const [currentScores, setCurrentScores] = useState({
    vocal: 0, acting: 0, dance: 0, presence: 0, notes: "",
  });

  const reopenJudgeSetup = () => setIsReady(false);

  //  UPDATED INITIALIZATION LOGIC
  useEffect(() => {
    setIsMounted(true); 
    const savedName = localStorage.getItem("judgeName");
    const savedRole = localStorage.getItem("judgeRole") as JudgeRole | null;
    
    if (savedName && savedRole) {
      // Case A: User has used this before
      setJudgeName(savedName);
      setJudgeRole(savedRole);
      setIsReady(true);
    } else {
      // Case B: First time (or cleared cache) -> Default to Austin/Director
      const defaultName = "Austin Fitzhugh";
      const defaultRole: JudgeRole = "Director";

      setJudgeName(defaultName);
      setJudgeRole(defaultRole);
      
      // Save defaults so we don't have to set them again
      localStorage.setItem("judgeName", defaultName);
      localStorage.setItem("judgeRole", defaultRole);
      
      setIsReady(true); // Skip the modal!
    }
  }, []);

/* ---------- Data Fetching ---------- */
  useEffect(() => {
    const loadData = async () => {
      if (!isReady || !productionId) return;
      
      setLoading(true);
      console.log(` Loading Auditions for ${productionTitle} (ID: ${productionId})...`);
      
      try {
        // 1. Fetch raw data
        const slots = await getAuditionees();

        // 2. Filter using the PROPS (Server Context)
        const showAuditions = slots.filter((row: any) => {
          const prodArray = row.Production || [];
          if (!prodArray.length) return false;
          // STRICT ID CHECK
          return prodArray.some((p: any) => p.id === productionId);
        });

        console.log(` Loaded ${showAuditions.length} actors.`);
        
        // Helper to extract baserow values
        const getLookupValue = (field: any) => {
          if (!field) return null;
          if (Array.isArray(field)) return field[0]?.value || field[0];
          return field?.value || field;
        };

        const formatHeight = (val: any) => {
          if (!val) return "N/A";
          if (String(val).includes("'")) return val; 
          const num = Number(val);
          if (isNaN(num)) return val;
          return `${Math.floor(num / 12)}'${num % 12}"`;
        };

        const getExperienceLabel = (field: any) => {
          let count = 0;
          let roleList = "";
          if (field) {
            if (Array.isArray(field)) {
               count = field.length;
               roleList = field.map((item: any) => typeof item === 'object' ? item.value : item).join(", ");
            } else if (typeof field === 'string') {
               const split = field.split(',');
               count = split.length;
               roleList = field;
            }
          }
          return { label: count > 0 ? `Shows: ${count}` : "First Show", list: roleList };
        };

        const formattedSchedule: Performer[] = showAuditions.map((row: any) => {
           const rawDate = row.Date;
           let displayTime = "TBD";
           let session: AuditionSession = "Video/Remote";

           if (rawDate) {
             const dateObj = new Date(rawDate);
             const dayOfWeek = dateObj.getDay(); 
             if (dayOfWeek === 4) session = "Thursday";
             else if (dayOfWeek === 5) session = "Friday";
             displayTime = dateObj.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
           }
           
           let videoUrl = null;
           if (row["Dance Video"]) {
               videoUrl = row["Dance Video"];
           } 
           if (!videoUrl) {
               const rawVideo = row["Audition Video"]; 
               if (Array.isArray(rawVideo) && rawVideo.length > 0) videoUrl = rawVideo[0].url;
               else if (typeof rawVideo === 'string' && rawVideo.startsWith('http')) videoUrl = rawVideo;
           }

           let headshotUrl = null;
           const rawHeadshot = row.Headshot;
           if (Array.isArray(rawHeadshot) && rawHeadshot.length > 0) headshotUrl = rawHeadshot[0].url;
           else if (row.Headshot?.url) headshotUrl = row.Headshot.url;

           const experienceData = getExperienceLabel(row["Past Roles"] || row["Past Productions"]);

           return {
             id: row.id,
             originalId: row.id, 
             performerId: row.Performer?.[0]?.id,
             name: Array.isArray(row.Performer) ? row.Performer[0]?.value : (row.Performer || "Unknown"),
             avatar: headshotUrl,
             age: String(getLookupValue(row.Age) || "?"),
             video: videoUrl,
             height: formatHeight(getLookupValue(row.Height)),
             vocalRange: getLookupValue(row["Vocal Range"]),
             dob: getLookupValue(row.Birthdate),
             conflicts: getLookupValue(row.Conflicts),
             tenure: experienceData.label,
             pastRoles: experienceData.list,
             song: row.Song || "No song listed",
             monologue: row.Monologue || "No monologue listed",
             timeSlot: displayTime,
             session: session,
             vocal: row["Vocal Score"] || 0,
             acting: row["Acting Score"] || 0,
             dance: row["Dance Score"] || 0,
             presence: row["Stage Presence Score"] || 0,
             actingNotes: row["Acting Notes"] || "",
             musicNotes: row["Music Notes"] || "",
             choreoNotes: row["Choreography Notes"] || "",
             dropInNotes: row["Drop-In Notes"] || "",
             adminNotes: row["Admin Notes"] || "",
             isWalkIn: false
           };
        });

        setScheduledPerformers(formattedSchedule);

        const initialGrades: Record<number, any> = {};
        formattedSchedule.forEach(p => {
          if (p.vocal > 0 || p.dance > 0 || p.acting > 0 || p.video) initialGrades[p.id] = p;
        });
        setGrades(initialGrades);

        // For Walk-Ins, we might want to filter or keep all, strictly logic dictates keep all
        setAllStudents(slots);

      } catch (err) {
        console.error(" CRITICAL LOAD ERROR:", err);
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, [isReady, productionId, productionTitle]);

  const handleChoreoSave = (actorId: number, score: number, notes: string, videoUrl?: string) => {
    const isDelete = videoUrl === "DELETE";

    setGrades(prev => ({
        ...prev,
        [actorId]: {
            ...prev[actorId],
            dance: score,
            choreoNotes: notes,
            video: isDelete ? null : (videoUrl || prev[actorId]?.video)
        }
    }));

    const payload: any = {
        "Dance Score": score > 0 ? score : null, 
        "Choreography Notes": notes
    };
    
    if (isDelete) {
        payload["Dance Video"] = ""; 
    } else if (videoUrl) {
        payload["Dance Video"] = videoUrl; 
    }
    
    updateAuditionSlot(actorId, payload).catch(err => console.error("Auto-save failed", err));
  };

  /* ---------- STANDARD SAVE ACTION ---------- */
  const handleCommit = async () => {
    if (!selectedPerson) return;
    
    const personId = selectedPerson.id;
    const originalId = selectedPerson.originalId;
    const isWalkIn = selectedPerson.isWalkIn;
    const scoresToSave = { ...currentScores };

    let noteField = "";
    switch (judgeRole) {
        case "Director": noteField = "actingNotes"; break; 
        case "Music": noteField = "musicNotes"; break;
        case "Choreographer": noteField = "choreoNotes"; break;
        case "Drop-In": noteField = "dropInNotes"; break;
        default: noteField = "adminNotes"; break;
    }

    setGrades((prev) => {
        const existingData = prev[personId] || {};
        return {
            ...prev,
            [personId]: {
                ...existingData,        
                ...scoresToSave,       
                [noteField]: scoresToSave.notes 
            }
        };
    });

    try {
      const payload: any = {
          "Vocal Score": scoresToSave.vocal > 0 ? scoresToSave.vocal : null,
          "Acting Score": scoresToSave.acting > 0 ? scoresToSave.acting : null,
          "Dance Score": scoresToSave.dance > 0 ? scoresToSave.dance : null,
          "Stage Presence Score": scoresToSave.presence > 0 ? scoresToSave.presence : null,
      };

      switch (judgeRole) {
          case "Director": payload["Acting Notes"] = scoresToSave.notes; break;
          case "Music": payload["Music Notes"] = scoresToSave.notes; break;
          case "Choreographer": payload["Choreography Notes"] = scoresToSave.notes; break;
          case "Drop-In": payload["Drop-In Notes"] = scoresToSave.notes; break;
          case "Admin": payload["Admin Notes"] = scoresToSave.notes; break;
      }

      if (isWalkIn) {
        // Use the SERVER ID provided via props
        await submitAudition(originalId, productionId, payload);
        alert("Walk-In Created!");
      } else {
        await updateAuditionSlot(personId, payload);
      }
      
      setSelectedPerson((current) => (current?.id === personId ? null : current));
      
    } catch (err) {
      console.error(err);
      alert("Save failed! Check connection.");
    }
  };

  /* ---------- Logic: Grouping & Scoring ---------- */
  const calculateWeightedScore = (scores: any) => {
    if (!judgeRole) return 0;
    const s = {
      vocal: Number(scores.vocal) || 0,
      acting: Number(scores.acting) || 0,
      dance: Number(scores.dance) || 0,
      presence: Number(scores.presence) || 0,
    };
    switch(judgeRole) {
      case "Director": return (s.acting * 0.7) + (s.vocal * 0.3); 
      case "Music": return (s.vocal * 0.8) + (s.acting * 0.2);
      case "Choreographer": return (s.dance * 0.8) + (s.presence * 0.2);
      default: return (s.vocal + s.acting + s.dance + s.presence) / 4;
    }
  };

  const visibleList = useMemo(() => {
    if (activeSession === "Walk-In") {
      if (!searchQuery) return [];
      return allStudents
        .filter(s => s["Full Name"]?.toLowerCase().includes(searchQuery.toLowerCase()))
        .map(s => ({
          id: -1, 
          originalId: s.id, 
          name: s["Full Name"],
          avatar: s.Headshot?.[0]?.url || null, 
          age: s.Age,
          timeSlot: "WALK-IN", 
          session: "Walk-In" as AuditionSession, 
          isWalkIn: true,
          vocal: 0, acting: 0, dance: 0, presence: 0, 
          actingNotes: "", musicNotes: "", choreoNotes: "", dropInNotes: "", adminNotes: "",
          height: "", vocalRange: "", dob: "", conflicts: "", tenure: "", pastRoles: [], song: "", monologue: "", video: null
        }));
    }
    return scheduledPerformers.filter((p) => {
        const matchesSession = p.session === activeSession;
        const matchesSearch = searchQuery ? p.name.toLowerCase().includes(searchQuery.toLowerCase()) : true;
        return matchesSession && matchesSearch;
    });
  }, [scheduledPerformers, allStudents, activeSession, searchQuery]);

  const grouped = useMemo(() => {
    if (activeSession === "Walk-In") return { "Walk-In Results": visibleList };
    const groups: Record<string, Performer[]> = {};
    visibleList.forEach((p) => {
      if (!groups[p.timeSlot]) groups[p.timeSlot] = [];
      groups[p.timeSlot].push(p);
    });
    return Object.keys(groups).sort().reduce((acc, key) => { acc[key] = groups[key]; return acc; }, {} as Record<string, Performer[]>);
  }, [visibleList, activeSession]);


 return (
  <>
    {/* --- JUDGE SETUP MODAL --- */}
    {!isReady && (
      <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-xl flex items-center justify-center p-4">
        <div className="w-full max-w-[420px] bg-zinc-950 border border-white/10 rounded-2xl p-6 md:p-8 space-y-6 shadow-2xl">
          <h2 className="text-2xl font-black uppercase tracking-tight">Judge Setup</h2>
          <div>
            <label className="block text-[10px] font-bold uppercase text-zinc-500 mb-1">Judge Name</label>
            <input value={judgeName} onChange={(e) => setJudgeName(e.target.value)} className="w-full bg-zinc-900 border border-white/10 rounded-lg p-3 text-sm focus:border-blue-500 outline-none transition-all" placeholder="Enter your name" />
          </div>
          <div>
            <label className="block text-[10px] font-bold uppercase text-zinc-500 mb-2">Judge Role</label>
            <div className="grid grid-cols-2 gap-2">
              {(Object.keys(ROLE_THEMES) as JudgeRole[]).map((role) => (
                <button key={role} onClick={() => setJudgeRole(role)} className={`p-3 rounded-lg border text-xs font-black uppercase transition-all ${judgeRole === role ? "bg-white text-black border-white shadow-lg" : "bg-zinc-900 border-zinc-800 text-zinc-400 hover:border-zinc-600"}`}>{role}</button>
              ))}
            </div>
          </div>
          <div className="flex gap-3 pt-2">
            {isMounted && localStorage.getItem("judgeName") && (
              <button onClick={() => setIsReady(true)} className="px-6 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-xl font-bold uppercase text-[10px] tracking-widest transition-colors">Cancel</button>
            )}
            <button disabled={!judgeName || !judgeRole} onClick={() => { localStorage.setItem("judgeName", judgeName); localStorage.setItem("judgeRole", judgeRole!); setIsReady(true); }} className="flex-1 bg-blue-600 hover:bg-blue-500 disabled:bg-zinc-800 disabled:text-zinc-500 py-4 rounded-xl font-black uppercase tracking-widest transition-colors shadow-lg shadow-blue-900/20">{isMounted && localStorage.getItem("judgeName") ? "Update Profile" : "Start Judging"}</button>
          </div>
        </div>
      </div>
    )}

    {/* --- MAIN UI --- */}
    {isReady && (
      judgeRole === 'Choreographer' ? (
        // === CHOREOGRAPHER WORKSPACE ===
        <div className="h-screen bg-black flex flex-col">
            <div className="h-14 bg-zinc-900 border-b border-white/5 flex items-center justify-between px-4 shrink-0">
                <button onClick={reopenJudgeSetup} className="text-[10px] font-black uppercase text-zinc-500 hover:text-white transition-colors">
                    Exit Dance Mode
                </button>
                <div className="flex gap-2">
                      {(["Thursday", "Friday", "Walk-In"] as const).map((s) => (
                        <button
                          key={s}
                          onClick={() => setActiveSession(s)}
                          className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase transition-all ${
                            activeSession === s ? "bg-white text-black" : "bg-zinc-800 text-zinc-500"
                          }`}
                        >
                          {s}
                        </button>
                      ))}
                </div>
            </div>
            
            <div className="flex-1 overflow-hidden">
                <ChoreoWorkspace 
                    people={visibleList} 
                    initialGrades={grades} 
                    onSave={handleChoreoSave} 
                />
            </div>
        </div>
      ) : (
        // === STANDARD AUDITION DECK ===
        <div className={`flex h-full bg-black text-white shadow-[0_0_50px_-12px_rgba(255,255,255,0.1)]`}>
          <div className="flex-1 flex flex-col min-w-0">
            
            {/* HEADER */}
            <header className={`p-4 md:p-6 border-b-2 bg-zinc-950 ${ROLE_THEMES[judgeRole!].color} shrink-0`}>
              <div className="flex flex-col md:flex-row justify-between md:items-center gap-4">
                <button onClick={reopenJudgeSetup} className="text-left group shrink-0">
                  <h1 className="text-xl md:text-2xl font-black italic uppercase">Audition Deck</h1>
                  <div className="flex items-center gap-2">
                      <p className="text-[9px] uppercase text-zinc-500">{judgeName}  {judgeRole}</p>
                      <span className="text-[9px] uppercase text-blue-500 font-bold ml-2">
                        {productionTitle}
                      </span>
                  </div>
                </button>

                {/* SCROLLABLE TABS */}
                <div className="flex gap-2 overflow-x-auto pb-2 md:pb-0 w-full md:w-auto no-scrollbar mask-linear-fade">
                  {(["Thursday", "Friday", "Video/Remote", "Walk-In"] as const).map((s) => (
                    <button key={s} onClick={() => { setActiveSession(s); setSearchQuery(""); }} className={`px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-colors whitespace-nowrap border border-transparent ${activeSession === s ? "bg-white text-black" : "bg-zinc-900 text-zinc-500 hover:text-zinc-300 border-white/5"}`}>
                      {s === "Walk-In" ? <span className="flex items-center gap-1"><UserPlus size={12}/> Walk-In</span> : s}
                    </button>
                  ))}
                </div>
              </div>

              <div className="mt-4 relative w-full md:w-64">
                <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-600" />
                <input value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full bg-zinc-900 rounded-lg py-2 pl-10 text-xs focus:ring-1 ring-white/10 outline-none text-white" placeholder={activeSession === "Walk-In" ? "Type student name..." : "Find in schedule..."} autoFocus={activeSession === "Walk-In"} />
              </div>
            </header>

            {/* LIST AREA */}
            <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
              {loading && <div className="text-center text-zinc-500 mt-20"><Loader2 className="animate-spin mx-auto mb-2"/> Loading Auditions...</div>}

              {activeSession === "Walk-In" && visibleList.length === 0 && !loading && (
                <div className="text-center text-zinc-500 mt-20"><UserPlus size={48} className="mx-auto mb-4 opacity-20" /><p className="text-sm">Start typing to find a student...</p></div>
              )}

              {Object.entries(grouped).map(([time, people]) => (
                <div key={time}>
                  {activeSession !== "Walk-In" && <h3 className="text-xs uppercase text-blue-500 mb-2 flex items-center gap-1 sticky top-0 bg-black/90 backdrop-blur py-2 z-10"><Clock size={12} /> {time}</h3>}
                  {people.map((person) => (
                    <div key={person.id} className="flex gap-2 mb-3 group">
                        <button
                          onClick={() => {
                            setSelectedPerson(person);
                            const saved = grades[person.id] || {};
                            let loadedNote = "";
                            if (saved.notes) {
                                loadedNote = saved.notes;
                            } else {
                                switch(judgeRole) {
                                    case "Director": loadedNote = person.actingNotes; break;
                                    case "Music": loadedNote = person.musicNotes; break;
                                    case "Drop-In": loadedNote = person.dropInNotes; break;
                                    case "Admin": loadedNote = person.adminNotes; break;
                                    default: loadedNote = ""; break;
                                }
                            }

                            setCurrentScores({
                                vocal: saved.vocal || person.vocal || 0,
                                acting: saved.acting || person.acting || 0,
                                dance: saved.dance || person.dance || 0,
                                presence: saved.presence || person.presence || 0,
                                notes: loadedNote || "", 
                            });
                          }}
                          className={`flex-1 flex items-center gap-3 md:gap-4 p-3 rounded-xl transition-all border min-w-0 ${selectedPerson?.id === person.id ? "bg-zinc-800 border-blue-500 ring-1 ring-blue-500" : "bg-zinc-900 border-white/5 hover:bg-zinc-800"}`}
                        >
                            <div className="relative flex-shrink-0">
                                {person.avatar ? <img src={person.avatar} className="w-10 h-10 md:w-12 md:h-12 rounded-full object-cover" alt="" /> : <div className="w-10 h-10 md:w-12 md:h-12 rounded-full bg-zinc-800 flex items-center justify-center"><User size={20} className="text-zinc-600"/></div>}
                                {grades[person.id] && !person.isWalkIn && <div className="absolute -top-1 -right-1 bg-black rounded-full"><CheckCircle2 size={14} className="text-emerald-500" /></div>}
                            </div>
                            <div className="text-left min-w-0 flex-1">
                                <p className="font-bold text-sm flex items-center gap-2 truncate">
                                  <span className="truncate">{person.name}</span>
                                  {person.video && <Film size={12} className="text-blue-500 shrink-0" />}
                                </p>
                                <p className="text-[10px] text-zinc-500 truncate">{person.isWalkIn ? "Click to Audition Now" : `Age ${person.age}`}</p>
                            </div>
                        </button>
                        
                        {person.video && (
                            <button
                                onClick={(e) => { e.stopPropagation(); window.open(person.video!, "_blank"); }}
                                className="w-10 md:px-4 bg-zinc-900 hover:bg-zinc-800 rounded-xl transition-colors border border-white/5 flex items-center justify-center text-blue-500 hover:text-blue-400 group-hover:border-blue-500/30 shrink-0"
                                title="Watch Audition"
                            >
                                <PlayCircle size={18} />
                            </button>
                        )}
                        
                        <button 
                          onClick={() => setInspectingActor(person)} 
                          className="w-10 md:px-4 bg-zinc-900 hover:bg-zinc-800 rounded-xl transition-colors border border-white/5 flex items-center justify-center text-zinc-400 hover:text-white shrink-0" 
                        >
                          <User size={18} />
                        </button>
                    </div>
                  ))}
                </div>
              ))}
            </div>
          </div>

          {/* SCORING SIDEBAR */}
          {selectedPerson && (
            <aside className="fixed inset-0 z-[200] w-full bg-zinc-950 flex flex-col md:relative md:w-[420px] md:border-l md:border-white/10 md:z-50">
                <div className="p-6 pb-4 border-b border-white/5 bg-zinc-900/50">
                  <div className="flex justify-between items-start mb-4">
                    <div className="flex gap-4">
                      <div className="w-20 h-20 rounded-2xl bg-zinc-800 overflow-hidden shadow-inner border border-white/10 shrink-0">
                        {selectedPerson.avatar ? <img src={selectedPerson.avatar} className="w-full h-full object-cover" alt={selectedPerson.name} /> : <div className="w-full h-full flex items-center justify-center text-zinc-600"><User size={32} /></div>}
                      </div>
                      <div>
                        <h2 className="text-2xl font-black italic uppercase leading-none tracking-tight">{selectedPerson.name}</h2>
                        <div className="flex items-center gap-2 mt-2">
                            <span className="bg-zinc-800 text-zinc-300 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide">{selectedPerson.isWalkIn ? "Walk-In" : `Age ${selectedPerson.age}`}</span>
                            {!selectedPerson.isWalkIn && <span className="border border-zinc-700 text-zinc-500 px-2 py-1 rounded text-[10px] font-bold uppercase">{selectedPerson.timeSlot}</span>}
                        </div>
                      </div>
                    </div>
                    <button onClick={() => setSelectedPerson(null)} className="text-zinc-500 hover:text-white transition-colors" aria-label="Close Panel"><X size={24}/></button>
                 </div>
               </div>

               <div className="p-6 space-y-6 flex-1 overflow-y-auto custom-scrollbar">
                  {selectedPerson.video && (
                     <div className="rounded-xl overflow-hidden border border-white/10 bg-black aspect-video relative group shadow-2xl">
                        <video src={selectedPerson.video} controls className="w-full h-full object-contain" poster={selectedPerson.avatar || undefined} />
                        <div className="absolute top-2 left-2 bg-black/60 backdrop-blur px-2 py-1 rounded text-[10px] font-bold uppercase text-white pointer-events-none border border-white/10">Audition Tape</div>
                     </div>
                  )}

                  <div className={`p-4 rounded-xl border ${ROLE_THEMES[judgeRole!].color} bg-zinc-900/50`}>
                      <div className="flex justify-between items-center">
                        <div>
                            <p className="text-[10px] font-black uppercase text-zinc-400 tracking-widest mb-1">Your Rating</p>
                            <p className="text-3xl font-black tabular-nums leading-none">{calculateWeightedScore(currentScores).toFixed(1)} <span className="text-sm text-zinc-600 font-normal">/ 5.0</span></p>
                        </div>
                        <div className="text-right">
                          <p className="text-[9px] uppercase text-zinc-500 font-bold leading-relaxed">{judgeRole} Priority:<br/><span className="text-zinc-300">{judgeRole === "Director" ? "Acting 70% | Vocal 30%" : ROLE_THEMES[judgeRole!].weight}</span></p>
                        </div>
                      </div>
                  </div>

                  <div className="space-y-6">
                      <RubricSlider label="Vocal Ability" val={currentScores.vocal} setVal={(v) => setCurrentScores((s) => ({ ...s, vocal: v }))} disabled={judgeRole !== "Music" && judgeRole !== "Admin"} />
                      <RubricSlider label="Acting / Reads" val={currentScores.acting} setVal={(v) => setCurrentScores((s) => ({ ...s, acting: v }))} disabled={judgeRole !== "Director" && judgeRole !== "Admin"} />
                      {(judgeRole === "Choreographer" || judgeRole === "Admin") && (
                        <RubricSlider label="Dance / Movement" val={currentScores.dance} setVal={(v) => setCurrentScores((s) => ({ ...s, dance: v }))} disabled={false} />
                      )}
                      <RubricSlider label="Stage Presence" val={currentScores.presence} setVal={(v) => setCurrentScores((s) => ({ ...s, presence: v }))} disabled={judgeRole !== "Director" && judgeRole !== "Admin"} />
                  </div>

                  <div className="pt-2 border-t border-white/5">
                    <label className="text-xs uppercase text-zinc-500 font-bold mb-3 block tracking-widest flex items-center gap-2"><MessageSquare size={12}/> Notes</label>
                    <textarea className="w-full bg-zinc-900 border border-white/10 p-4 rounded-xl text-sm min-h-[100px] focus:border-blue-500 outline-none resize-none transition-all placeholder:text-zinc-700" placeholder={`Internal notes for ${selectedPerson.name}...`} value={currentScores.notes} onChange={(e) => setCurrentScores((s) => ({ ...s, notes: e.target.value }))} />
                  </div>
               </div>

               <div className="p-6 border-t border-white/10 bg-zinc-900/50">
                 <button onClick={handleCommit} className="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-black uppercase tracking-widest shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 transition-transform active:scale-95">
                   <Save size={18} />
                   {selectedPerson.isWalkIn ? "Submit Walk-In" : "Save Score"}
                 </button>
               </div>
            </aside>
          )}
        </div>
      )
    )}

    {inspectingActor && <ActorProfileModal actor={inspectingActor} grades={grades[inspectingActor.id]} onClose={() => setInspectingActor(null)} />}
  </>
);
}
</file>

<file path="app/components/conflicts/ConflictClient.tsx">
"use client";

import React, { useMemo, useState } from "react";
import { 
  AlertTriangle, 
  Check, 
  Search, 
  Calendar,
  Filter,
  X
} from "lucide-react";
import ConflictAnalysisDashboard from './ConflictAnalysisDashboard';

interface Props {
  scenes: any[];      
  roles: any[];       
  assignments: any[]; 
  people: any[];
  conflictRows: any[]; // Table 623 Data
  eventRows?: any[];   // Table 625 Data (Rehearsal Events)
  productionTitle: string;      
}

export default function ConflictClient({ 
  scenes, 
  roles, 
  assignments, 
  people, 
  conflictRows = [], 
  eventRows = [],
  productionTitle 
}: Props) {
  const [filterText, setFilterText] = useState("");
  const [showClear, setShowClear] = useState(true);

  // --- DATA PROCESSING (For the Matrix View) ---
  const processedData = useMemo(() => {
    
    // 1. Build Conflict Map (Person ID -> Array of Conflict Strings)
    // We use the raw Conflict Table (623) because the People Table only contains IDs.
    const conflictMap = new Map<number, string[]>();
    
    conflictRows.forEach((row: any) => {
        const personId = row["Person"]?.[0]?.id;
        if (personId) {
            const type = row["Conflict Type"]?.value || "Conflict";
            const notes = row["Notes"] || "";
            // Format dates if they exist (Legacy support for non-event linked conflicts)
            const dateStr = row["Date"] ? row["Date"].map((d: any) => {
                const date = new Date(d.value);
                return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
            }).join(", ") : "";
            
            // If linked to an Event ID, we could look that up too, but for the general
            // "Actor Tooltip", listing the raw conflict text is usually sufficient.
            const label = `${type}${dateStr ? ` (${dateStr})` : ''}${notes ? `: ${notes}` : ''}`;
            
            const current = conflictMap.get(personId) || [];
            conflictMap.set(personId, [...current, label]);
        }
    });

    // 2. Map People & Attach Conflicts
    const actorMap = new Map();
    people.forEach((p: any) => {
      const name = p["Full Name"] || p["Name"] || `Student ${p.id}`;
      // Grab conflicts from our map, default to empty array
      const conflicts = conflictMap.get(p.id) || [];
      actorMap.set(p.id, { id: p.id, name, conflicts });
    });

    // 3. Map Roles -> Actors (Who plays who?)
    const roleActorMap = new Map<number, number[]>(); 
    assignments.forEach((a: any) => {
      const roleId = a["Performance Identity"]?.[0]?.id;
      const personId = a["Person"]?.[0]?.id;
      if (roleId && personId) {
        const current = roleActorMap.get(roleId) || [];
        if (!current.includes(personId)) roleActorMap.set(roleId, [...current, personId]);
      }
    });

    // 4. Map Scenes -> Actors (Who is in this scene?)
    const matrixRows = scenes.map((scene: any) => {
        // Find Roles linked to this scene
        const rolesInScene = roles.filter((r: any) => {
          const activeScenes = r["Active Scenes"] || [];
          return activeScenes.some((s: any) => s.id === scene.id);
        });

        // Find Actors assigned to those roles
        const actorsInScene = new Set<number>();
        rolesInScene.forEach((r: any) => {
          const actorIds = roleActorMap.get(r.id) || [];
          actorIds.forEach((id) => actorsInScene.add(id));
        });

        const actorArray = Array.from(actorsInScene);

        return {
          id: scene.id,
          name: scene["Scene Name"] || `Scene ${scene.id}`,
          act: scene["Act"]?.value || "1",
          actors: actorArray,
          // We pass 'actors' array (IDs) for the dashboard to calculate load
          size: actorArray.length
        };
      }).sort((a: any, b: any) => a.id - b.id);

    // 5. Get Unique Cast List (Columns)
    const uniqueActorIds = Array.from(new Set(matrixRows.flatMap((r: any) => r.actors)));
    const gridColumns = uniqueActorIds
      .map((id) => actorMap.get(id))
      .filter(Boolean)
      .sort((a: any, b: any) => a.name.localeCompare(b.name));

    return { rows: matrixRows, columns: gridColumns };
  }, [scenes, roles, assignments, people, conflictRows]);

  const { rows, columns } = processedData;
  const visibleColumns = columns.filter((c: any) => c.name.toLowerCase().includes(filterText.toLowerCase()));

  return (
    <div className="flex flex-col h-screen bg-zinc-950 text-white overflow-hidden font-sans">
      
      {/* HEADER */}
      <div className="p-4 border-b border-white/10 bg-zinc-900 flex justify-between items-center shrink-0 h-14 z-40 relative shadow-md">
        <div className="flex items-center gap-4">
            <h2 className="text-lg font-black uppercase italic tracking-wider flex items-center gap-2">
            <Calendar className="text-red-500" /> Conflict Matrix
            </h2>
            <div className="h-6 w-px bg-white/10"></div>
            <span className="text-xs font-bold text-zinc-500 uppercase tracking-widest">{productionTitle}</span>
        </div>
        
        <div className="flex items-center gap-4">
          <label className="flex items-center gap-2 text-xs font-bold uppercase text-zinc-400 cursor-pointer hover:text-white select-none">
            <input 
              type="checkbox" 
              checked={showClear} 
              onChange={(e) => setShowClear(e.target.checked)}
              className="accent-blue-500 w-4 h-4 rounded cursor-pointer"
            />
            Show Cleared
          </label>
          
          <div className="relative">
            <Search size={14} className="absolute left-2 top-1/2 -translate-y-1/2 text-zinc-500" />
            <input 
              value={filterText}
              onChange={(e) => setFilterText(e.target.value)}
              placeholder="Filter Actors..." 
              className="bg-zinc-950 border border-white/10 rounded-lg pl-8 pr-3 py-1.5 text-xs text-white focus:border-blue-500 outline-none w-48 transition-all placeholder:text-zinc-600"
            />
          </div>
        </div>
      </div>

      {/* SCROLLABLE CONTENT */}
      <div className="flex-1 overflow-auto custom-scrollbar relative bg-zinc-950 flex flex-col">
        
        {/*  ANALYTICS DASHBOARD (Visual Rehearsal Squares) */}
        <div className="p-4 bg-zinc-950 border-b border-white/5">
            <ConflictAnalysisDashboard 
                scenes={rows}
                assignments={assignments}
                people={people}
                conflictRows={conflictRows}
                events={eventRows} // Pass the "Square" data here
            />
        </div>

        {/*  THE MATRIX (Details) */}
        <div className="relative">
            <table className="w-full border-collapse">
            <thead className="sticky top-0 z-20 bg-zinc-900 shadow-xl border-b border-white/10">
                <tr>
                <th className="sticky left-0 z-30 bg-zinc-900 border-r border-white/10 p-4 min-w-[200px] text-left shadow-[2px_0_5px_rgba(0,0,0,0.5)]">
                    <span className="text-[10px] font-black text-zinc-500 uppercase tracking-widest block mb-1">Row: Scene</span>
                    <span className="text-[10px] font-black text-blue-500 uppercase tracking-widest block">Col: Actor</span>
                </th>
                {visibleColumns.map((actor: any) => (
                    <th key={actor.id} className="p-2 border-r border-white/10 min-w-[40px] w-[40px] relative group hover:bg-zinc-800 transition-colors align-bottom pb-4">
                    <div className="h-32 flex items-end justify-center">
                        <div className="writing-vertical-lr -rotate-180 text-[10px] font-bold text-zinc-400 uppercase tracking-wider whitespace-nowrap group-hover:text-white transition-colors">
                            {actor.name}
                        </div>
                    </div>
                    {actor.conflicts.length > 0 && (
                        <div className="absolute bottom-1 left-1/2 -translate-x-1/2">
                        <div className="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse shadow-[0_0_8px_rgba(239,68,68,0.8)]" title="Has Conflicts" />
                        </div>
                    )}
                    </th>
                ))}
                </tr>
            </thead>

            <tbody className="divide-y divide-white/5">
                {rows.map((scene: any) => (
                <tr key={scene.id} className="hover:bg-white/5 transition-colors group/row">
                    {/* SCENE HEADER */}
                    <td className="sticky left-0 z-10 bg-zinc-950 group-hover/row:bg-zinc-900 border-r border-white/10 p-3 shadow-[2px_0_5px_rgba(0,0,0,0.5)]">
                    <div className="flex flex-col">
                        <span className="text-xs font-bold text-white truncate max-w-[180px]" title={scene.name}>
                        {scene.name}
                        </span>
                        <div className="flex justify-between items-center mt-1">
                            <span className="text-[9px] font-black text-zinc-600 uppercase">Act {scene.act}</span>
                            <span className="text-[9px] font-mono text-zinc-500 bg-zinc-900 px-1.5 rounded border border-white/5">{scene.actors.length}</span>
                        </div>
                    </div>
                    </td>

                    {/* CELLS */}
                    {visibleColumns.map((actor: any) => {
                    const isInScene = scene.actors.includes(actor.id);
                    const hasConflicts = actor.conflicts.length > 0;
                    
                    if (!isInScene) {
                        return <td key={actor.id} className="bg-black/40 border-r border-white/5"></td>;
                    }

                    if (hasConflicts) {
                        return (
                        <td key={actor.id} className="bg-red-900/10 border-r border-white/5 p-0 relative group/cell cursor-help hover:bg-red-900/30 transition-colors h-full">
                            <div className="w-full h-full flex items-center justify-center py-3">
                                <AlertTriangle size={14} className="text-red-500 opacity-80" />
                            </div>
                            
                            {/* HOVER TOOLTIP */}
                            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 bg-zinc-950 border border-red-500/50 p-3 rounded-xl shadow-2xl z-50 hidden group-hover/cell:block pointer-events-none">
                            <div className="flex justify-between items-center border-b border-red-500/20 pb-2 mb-2">
                                <span className="text-[10px] font-black uppercase text-red-500">{actor.name}</span>
                                <span className="text-[9px] bg-red-900/30 text-red-400 px-1.5 py-0.5 rounded border border-red-500/30">{actor.conflicts.length} Conflicts</span>
                            </div>
                            <ul className="space-y-1.5 max-h-40 overflow-y-auto custom-scrollbar">
                                {actor.conflicts.map((c: string, i: number) => (
                                <li key={i} className="text-[10px] text-zinc-300 flex items-start gap-2">
                                    <span className="mt-1 w-1 h-1 rounded-full bg-red-500 shrink-0"/>
                                    <span className="leading-tight">{c}</span>
                                </li>
                                ))}
                            </ul>
                            </div>
                        </td>
                        );
                    }

                    return (
                        <td key={actor.id} className={`border-r border-white/5 p-0 text-center ${!showClear ? 'opacity-10' : ''}`}>
                        <div className="w-full h-full flex items-center justify-center py-3">
                            <Check size={14} className="text-emerald-500/30" />
                        </div>
                        </td>
                    );
                    })}
                </tr>
                ))}
            </tbody>
            </table>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/components/casting/ChemistryWorkspace.tsx">
"use client";

import { useState } from "react";
import { Users, Filter, X, Check, Ruler, Scale, AlertOctagon, Trophy } from "lucide-react";

// ---  UTILITIES ---
const safeVal = (val: any, fallback: string | number = "-") => {
  if (val === undefined || val === null) return fallback;
  if (Array.isArray(val)) return val[0]?.value ?? val[0] ?? fallback;
  if (typeof val === "object") return val.value ?? val.id ?? fallback;
  return val;
};

// ---  METRICS CONFIGURATION ---
// aligned with your Baserow Columns (Vocal Score, Acting Score, etc)
const METRICS = [
  { 
    label: "Vocal", 
    getValue: (a: any) => safeVal(a["Vocal Score"], 0),
    format: (v: any) => (
      <span className={`px-2 py-1 rounded font-mono text-xs ${v >= 4 ? 'bg-emerald-500/20 text-emerald-400' : v >= 3 ? 'bg-blue-500/20 text-blue-400' : 'text-zinc-500'}`}>
        {Number(v).toFixed(1)}
      </span>
    )
  },
  { 
    label: "Acting", 
    getValue: (a: any) => safeVal(a["Acting Score"], 0),
    format: (v: any) => (
      <span className={`px-2 py-1 rounded font-mono text-xs ${v >= 4 ? 'bg-purple-500/20 text-purple-400' : v >= 3 ? 'bg-blue-500/20 text-blue-400' : 'text-zinc-500'}`}>
        {Number(v).toFixed(1)}
      </span>
    )
  },
  { 
    label: "Height", 
    getValue: (a: any) => safeVal(a.Height, "-"),
    format: (v: any) => <div className="flex justify-center items-center gap-1 font-mono text-zinc-400 text-xs"><Ruler size={10} className="opacity-50" /> {v}</div> 
  },
  { 
    label: "Age", 
    getValue: (a: any) => safeVal(a.Age, "?"),
    format: (v: any) => <span className="text-zinc-400 text-xs">{v}</span> 
  }
];

// ---  SUB-COMPONENT: The Role Card ---
function RoleComparisonCard({ 
  role, 
  onDropActor, 
  onRemoveActor, 
  onConfirmRole 
}: { 
  role: any; 
  onDropActor: (e: React.DragEvent, id: string) => void;
  onRemoveActor: (roleId: string, actorId: number) => void;
  onConfirmRole: (roleId: string, actorId: number) => void;
}) {
  
  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  };

  return (
    <div 
      onDragOver={handleDragOver}
      onDrop={(e) => onDropActor(e, String(role.id))}
      className="group relative"
    >
      {/* ROLE HEADER */}
      <div className="flex items-center gap-3 mb-4 pl-2 border-l-2 border-purple-500/50">
         <h2 className="text-xl font-black uppercase text-white tracking-tighter italic">{role.name}</h2>
         <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-zinc-800 text-zinc-400 border border-white/5">{role.type}</span>
         <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-zinc-800 text-zinc-500 border border-white/5">{role.actors?.length || 0} Candidates</span>
      </div>

      {/* TABLE CONTAINER */}
      <div className={`rounded-xl border border-white/5 bg-zinc-900/20 overflow-hidden transition-all ${(!role.actors || role.actors.length === 0) ? 'border-dashed border-zinc-800 h-32 flex items-center justify-center' : ''}`}>
        
        {(!role.actors || role.actors.length === 0) ? (
             <div className="text-zinc-600 flex items-center gap-2">
                <Users size={20} />
                <span className="text-xs font-bold uppercase tracking-wider">Drag candidates here</span>
             </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr>
                  {/* CORNER HEADER */}
                  <th className="p-4 w-24 md:w-32 bg-zinc-900/50 border-b border-r border-white/5 text-[10px] font-black uppercase text-zinc-500 tracking-wider text-right align-bottom sticky left-0 z-10 backdrop-blur-sm">
                    Candidate
                  </th>
                  
                  {/* CANDIDATE COLUMNS */}
                  {role.actors.map((actor: any) => {
                    const isSelected = role.selectedActorIds?.includes(actor.id);
                    return (
                      <th key={actor.id} className={`p-4 border-b border-r border-white/5 min-w-[140px] w-[160px] relative group/col ${isSelected ? 'bg-purple-900/10' : ''}`}>
                         {/* HEADSHOT & ACTIONS */}
                         <div className={`relative aspect-[3/4] rounded-lg overflow-hidden border shadow-lg mb-2 transition-all ${isSelected ? 'border-purple-500 ring-2 ring-purple-500/50' : 'border-white/10'}`}>
                            <img 
                                title={actor.Performer} 
                                src={safeVal(actor.Headshot, "https://placehold.co/400x600/111/444?text=No+Img")} 
                                className="w-full h-full object-cover" 
                            />
                            
                            {/* REMOVE BUTTON */}
                            <button onClick={() => onRemoveActor(String(role.id), actor.id)} className="absolute top-1 right-1 p-1.5 bg-black/60 text-zinc-400 hover:text-red-400 rounded-full opacity-0 group-hover/col:opacity-100 transition-opacity z-20">
                                <X size={14} />
                            </button>
                            
                            {/* SELECT / CAST BUTTON */}
                            <div className={`absolute inset-x-0 bottom-0 p-2 flex justify-center bg-gradient-to-t from-black/90 to-transparent transition-opacity ${isSelected ? 'opacity-100' : 'opacity-0 group-hover/col:opacity-100'}`}>
                                <button onClick={() => onConfirmRole(String(role.id), actor.id)} className={`rounded-full shadow-xl flex items-center justify-center gap-1 px-3 py-1.5 transition-all text-xs font-bold ${isSelected ? 'bg-purple-600 text-white' : 'bg-white text-black hover:bg-emerald-400'}`}>
                                    {isSelected ? <><Check size={12} /> CAST</> : "SELECT"}
                                </button>
                            </div>
                         </div>
                         
                         {/* NAME DISPLAY (Using Performer field directly) */}
                         <div className="text-center px-1">
                            <p className={`text-sm font-black leading-tight line-clamp-2 ${isSelected ? 'text-purple-300' : 'text-white'}`}>
                                {actor.Performer || "Unknown Name"} 
                            </p>
                         </div>
                      </th>
                  )})}
                  <th className="p-4 border-b border-white/5 min-w-[50px] bg-zinc-900/30 border-dashed border-l border-white/10"></th>
                </tr>
              </thead>
              <tbody className="text-xs font-bold text-zinc-300">
                  {/* METRIC ROWS */}
                  {METRICS.map((metric, i) => (
                      <tr key={i} className="hover:bg-zinc-800/30 transition-colors">
                          <td className="p-3 border-b border-r border-white/5 text-right text-zinc-500 uppercase text-[10px] sticky left-0 bg-zinc-900/90 backdrop-blur-sm z-10">
                            {metric.label}
                          </td>
                          {role.actors.map((actor: any) => (
                              <td key={actor.id} className="p-3 border-b border-r border-white/5 text-center">
                                  {metric.format(metric.getValue(actor))}
                              </td>
                          ))}
                          <td className="border-b border-white/5 bg-zinc-900/30 border-l border-dashed border-white/10"></td>
                      </tr>
                  ))}
                  
                  {/* CONFLICTS ROW */}
                  <tr className="bg-red-900/5">
                      <td className="p-3 border-r border-white/5 text-right text-red-500/70 font-black uppercase text-[10px] align-top pt-4 sticky left-0 bg-zinc-900/90 backdrop-blur-sm z-10">
                        Conflicts
                      </td>
                      {role.actors.map((actor: any) => {
                          const conflictStr = safeVal(actor.Conflicts, "");
                          // Basic filtering of conflicts
                          const conflicts = typeof conflictStr === 'string' 
                            ? conflictStr.split(',').filter((c: string) => c && !c.includes("No known")) 
                            : [];

                          return (
                              <td key={actor.id} className="p-3 border-r border-white/5 text-center align-top">
                                  {conflicts.length > 0 ? (
                                      <div className="flex flex-col gap-1 items-center">
                                          {conflicts.slice(0, 3).map((c: string, i: number) => (
                                              <div key={i} className="flex items-center gap-1 text-[9px] bg-red-500/10 text-red-400 border border-red-500/20 px-1.5 py-0.5 rounded w-fit max-w-[140px] truncate">
                                                  <AlertOctagon size={8} className="shrink-0" /> {c}
                                              </div>
                                          ))}
                                          {conflicts.length > 3 && <span className="text-[9px] text-red-500/50">+{conflicts.length - 3} more</span>}
                                      </div>
                                  ) : <span className="text-[10px] text-emerald-500/50 flex items-center justify-center gap-1"><Check size={10}/> Clear</span>}
                              </td>
                          )
                      })}
                      <td className="bg-zinc-900/30 border-l border-dashed border-white/10"></td>
                  </tr>
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}

// ---  MAIN COMPONENT ---
interface Props {
  roles: any[]; 
  onDropActor: (e: React.DragEvent, roleId: string) => void;
  onRemoveActor: (roleId: string, actorId: number) => void;
  onSelectRole: (role: any) => void;
  onConfirmRole: (roleId: string, actorId: number) => void;
}

export default function ChemistryWorkspace({ roles, onDropActor, onRemoveActor, onConfirmRole }: Props) {
  const [activeFilter, setActiveFilter] = useState("Lead");

  // Filter roles based on the tabs
  const visibleRoles = roles.filter(r => 
    activeFilter === "All" || safeVal(r.type).includes(activeFilter)
  );

  return (
    <div className="h-full flex flex-col bg-zinc-950 relative overflow-hidden">
      
      {/* HEADER */}
      <header className="p-4 border-b border-white/5 bg-zinc-900/50 flex flex-col md:flex-row justify-between items-center gap-4 shrink-0 backdrop-blur-md z-30">
         <div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
            <h1 className="text-xl font-black italic uppercase flex items-center gap-2 text-white">
                <Scale className="text-purple-500" /> Head-to-Head
            </h1>
            
            <div className="flex bg-zinc-900 p-1 rounded-lg border border-white/5 overflow-x-auto max-w-[200px] md:max-w-none scrollbar-hide">
                {["Lead", "Supporting", "Featured", "Ensemble", "All"].map(filter => (
                    <button
                        key={filter}
                        onClick={() => setActiveFilter(filter)}
                        className={`px-3 py-1 text-[10px] font-bold uppercase rounded transition-all whitespace-nowrap ${activeFilter === filter ? 'bg-purple-600 text-white shadow-lg' : 'text-zinc-500 hover:text-zinc-300'}`}
                    >
                        {filter}
                    </button>
                ))}
            </div>
         </div>
      </header>

      {/* COMPARISON STAGE */}
      <div className="flex-1 overflow-x-auto overflow-y-auto p-4 md:p-8 custom-scrollbar bg-zinc-950 space-y-12 pb-24 md:pb-8">
            {visibleRoles.length === 0 && (
                <div className="w-full h-full flex flex-col items-center justify-center text-zinc-600 opacity-50 min-h-[300px]">
                    <Filter size={48} className="mb-4" />
                    <p>No roles match this filter.</p>
                </div>
            )}

            {visibleRoles.map(role => (
               <RoleComparisonCard 
                  key={role.id}
                  role={role}
                  onDropActor={onDropActor}
                  onRemoveActor={onRemoveActor}
                  onConfirmRole={onConfirmRole}
               />
            ))}
      </div>
    </div>
  );
}
</file>

<file path="app/components/conflicts/ConflictAnalysisDashboard.tsx">
"use client";

import React, { useMemo } from 'react';
import { Calendar, AlertTriangle, Clock, ChevronDown, Users, CheckCircle2 } from 'lucide-react';

export default function ConflictAnalysisDashboard({ scenes, assignments, people, conflictRows, events }: any) {

  // ---  THE BRAIN: EVENT-BASED ANALYTICS ---
  const analytics = useMemo(() => {
    
    // 1. Calculate Real Cast Size
    const uniqueCastIds = new Set(assignments.map((a: any) => a["Person"]?.[0]?.id));
    const totalCastSize = uniqueCastIds.size || 1; 

    // 2. Sort Events Chronologically
    const sortedEvents = [...events].sort((a: any, b: any) => 
        new Date(a["Event Date"]).getTime() - new Date(b["Event Date"]).getTime()
    );

    // 3. Map Conflicts to specific Event IDs
    const eventConflictMap = new Map<number, Set<number>>();

    conflictRows.forEach((row: any) => {
        const personId = row["Person"]?.[0]?.id;
        const linkedEventIds = row["Production Event"]?.map((e: any) => e.id) || [];
        
        if (personId && linkedEventIds.length > 0) {
            linkedEventIds.forEach((eventId: number) => {
                if (!eventConflictMap.has(eventId)) eventConflictMap.set(eventId, new Set());
                eventConflictMap.get(eventId)?.add(personId);
            });
        }
    });

    // 4. Build Event Objects
    const processedEvents = sortedEvents.map((evt: any, index: number) => {
        const dateObj = new Date(evt["Event Date"]);
        const absentees = eventConflictMap.get(evt.id) || new Set();
        let absentCount = absentees.size;
        
        // ---  DEMO AUGMENTATION START  ---
        // Artificial injection to demonstrate UI states if data is too clean
        if (index === 2) { 
            // Force a "Yellow" day (approx 85% availability)
            absentCount = Math.max(absentCount, Math.floor(totalCastSize * 0.15));
        }
        if (index === 6) {
            // Force a "Red" day (approx 70% availability)
            absentCount = Math.max(absentCount, Math.floor(totalCastSize * 0.30));
        }
        // --- DEMO AUGMENTATION END ---

        // Accurate Math: (Cast Size - Absents) / Cast Size
        const availability = Math.round(((totalCastSize - absentCount) / totalCastSize) * 100);
        
        const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
        const dateStr = dateObj.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
        
        const startTime = evt["Start Time"] ? new Date(evt["Start Time"]).toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'}) : "";
        const endTime = evt["End Time"] ? new Date(evt["End Time"]).toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'}) : "";

        return {
            id: evt.id,
            label: dayName,
            date: dateStr,
            fullDate: dateObj,
            time: `${startTime} - ${endTime}`,
            type: evt["Event Type"]?.value || "Rehearsal",
            absentCount,
            availability,
            weekNum: getWeekNumber(dateObj) 
        };
    });

    // 5. Group by Week
    const groupedWeeks: any[] = [];
    let currentWeek: any[] = [];
    let lastWeekNum = -1;

    processedEvents.forEach((evt: any) => {
        if (evt.weekNum !== lastWeekNum && currentWeek.length > 0) {
            groupedWeeks.push(currentWeek);
            currentWeek = [];
        }
        currentWeek.push(evt);
        lastWeekNum = evt.weekNum;
    });
    if (currentWeek.length > 0) groupedWeeks.push(currentWeek);


    // 6. Hardest Scenes (Weighted Logic)
    const sceneScores = scenes.map((scene: any) => {
        const actorIds = scene.actors || [];
        const totalConflicts = actorIds.reduce((acc: number, pid: number) => {
            let c = 0;
            eventConflictMap.forEach((absentees) => { if(absentees.has(pid)) c++; });
            return acc + c;
        }, 0);
        return { ...scene, conflictLoad: totalConflicts, size: actorIds.length };
    }).sort((a: any, b: any) => b.conflictLoad - a.conflictLoad);

    return { weeks: groupedWeeks, hardestScenes: sceneScores.slice(0, 5), totalCastSize };
  }, [scenes, assignments, people, conflictRows, events]);


  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6 h-[500px]">
        
        {/*  VERTICAL SCROLLING WEEKLY FEED */}
        <div className="col-span-2 bg-zinc-900 border border-white/10 rounded-xl flex flex-col overflow-hidden shadow-xl">
            <div className="p-4 border-b border-white/10 bg-zinc-900 z-10 flex justify-between items-center shadow-sm">
                <h3 className="text-sm font-black uppercase tracking-widest text-zinc-400 flex items-center gap-2">
                    <Calendar size={16} className="text-blue-500"/> Rehearsal Flow
                </h3>
                <span className="text-[10px] font-mono text-zinc-600">
                    Based on {analytics.totalCastSize} Cast Members
                </span>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-zinc-950/50">
                {analytics.weeks.length === 0 && <div className="text-zinc-500 italic text-sm">No events scheduled.</div>}

                {analytics.weeks.map((weekEvents: any[], i: number) => {
                    const firstEvt = weekEvents[0];
                    const isHeavyWeek = weekEvents.length > 3; 

                    return (
                        <div key={i} className="animate-in fade-in slide-in-from-bottom-2 duration-500" style={{animationDelay: `${i * 50}ms`}}>
                            {/* Week Header */}
                            <div className="flex items-center gap-2 mb-2 ml-1">
                                <span className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">
                                    Week of {firstEvt.fullDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                </span>
                                {isHeavyWeek && (
                                    <span className="text-[9px] bg-purple-500/10 text-purple-400 border border-purple-500/20 px-1.5 rounded uppercase font-bold tracking-wider">
                                        Heavy Week
                                    </span>
                                )}
                            </div>

                            {/* The Grid of Cards for this Week */}
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
                                {weekEvents.map((evt: any) => {
                                    // Color Coding Logic
                                    let color = "bg-emerald-900/10 border-emerald-500/20 hover:border-emerald-500/50";
                                    let textC = "text-emerald-500";
                                    let barC = "bg-emerald-500";
                                    
                                    if (evt.availability < 90) { 
                                        color = "bg-amber-900/10 border-amber-500/20 hover:border-amber-500/50"; 
                                        textC = "text-amber-500"; 
                                        barC = "bg-amber-500";
                                    }
                                    if (evt.availability < 80) { 
                                        color = "bg-red-900/10 border-red-500/20 hover:border-red-500/50"; 
                                        textC = "text-red-500"; 
                                        barC = "bg-red-500";
                                    }

                                    return (
                                        <div key={evt.id} className={`border rounded-lg p-2.5 relative overflow-hidden group transition-all ${color}`}>
                                            
                                            {/* Date/Time */}
                                            <div className="flex justify-between items-start mb-2 relative z-10">
                                                <div>
                                                    <div className="text-xs font-black text-zinc-300 uppercase">{evt.label}</div>
                                                    <div className="text-[10px] text-zinc-500 font-bold">{evt.date}</div>
                                                </div>
                                                <div className={`text-[9px] font-bold px-1.5 py-0.5 rounded bg-black/40 ${textC}`}>
                                                    {evt.availability}%
                                                </div>
                                            </div>

                                            {/* Details */}
                                            <div className="relative z-10">
                                                <div className="text-[9px] text-zinc-500 flex items-center gap-1 mb-1.5">
                                                    <Clock size={10}/> {evt.time.split(' ')[0]}
                                                </div>
                                                
                                                {evt.absentCount > 0 ? (
                                                    <div className="text-[10px] font-bold text-zinc-400 flex items-center gap-1">
                                                        <Users size={10} className={textC}/> 
                                                        {evt.absentCount} Missing
                                                    </div>
                                                ) : (
                                                    <div className="text-[10px] font-bold text-zinc-600 flex items-center gap-1">
                                                        <CheckCircle2 size={10} className="text-emerald-600"/> Full Cast
                                                    </div>
                                                )}
                                            </div>

                                            {/* Subtle Bar at bottom */}
                                            <div className={`absolute bottom-0 left-0 h-0.5 w-full ${barC} opacity-50`}/>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>

        {/*  HARDEST SCENES */}
        <div className="bg-zinc-900 border border-white/10 rounded-xl p-4 flex flex-col shadow-lg h-full">
            <h3 className="text-xs font-black uppercase tracking-widest text-zinc-500 mb-4 flex items-center gap-2">
                <AlertTriangle size={14} className="text-red-500"/> Difficult Scenes
            </h3>
            
            <div className="flex-1 space-y-2 overflow-y-auto custom-scrollbar">
                {analytics.hardestScenes.map((scene: any, i: number) => (
                    <div key={scene.id} className="flex justify-between items-center bg-black/20 p-3 rounded-lg border border-white/5 group hover:border-red-500/30 transition-colors">
                        <div className="flex items-center gap-3 min-w-0">
                            <span className={`text-xs font-mono font-bold w-5 h-5 flex items-center justify-center rounded ${i === 0 ? 'bg-red-500 text-white' : 'bg-zinc-800 text-zinc-500'}`}>
                                {i+1}
                            </span>
                            <div className="min-w-0">
                                <div className="text-xs font-bold text-zinc-200 truncate pr-2">{scene.name}</div>
                                <div className="text-[9px] text-zinc-500">{scene.size} Actors</div>
                            </div>
                        </div>
                        <div className="text-right shrink-0">
                            <div className="text-sm font-black text-red-400 leading-none">{scene.conflictLoad}</div>
                            <div className="text-[8px] uppercase font-bold text-zinc-600 mt-0.5">Pts</div>
                        </div>
                    </div>
                ))}
                {analytics.hardestScenes.length === 0 && <div className="text-xs text-zinc-500 italic p-4 text-center">No conflict data available yet.</div>}
            </div>
        </div>
    </div>
  );
}

// Helper to get ISO Week Number
function getWeekNumber(d: Date) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
    var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    var weekNo = Math.ceil(( ( (d.getTime() - yearStart.getTime()) / 86400000) + 1)/7);
    return weekNo;
}
</file>

<file path="app/layout.tsx">
import './globals.css';
import type { Metadata } from 'next';

//  THIS IS THE FIX FOR VERCEL
// This tells Next.js: "Do not try to build static HTML. 
// Render everything fresh on every request."
export const dynamic = 'force-dynamic';

export const metadata: Metadata = {
  title: 'Open Backstage',
  description: 'CYT Production Hub',
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" className="dark">
      {/* 1. suppressHydrationWarning: Keeps extensions like ColorZilla happy.
          2. NO Header here: This ensures the Login page gets the full, empty screen.
      */}
      <body 
        className="bg-zinc-950 text-zinc-100 h-screen w-screen overflow-hidden"
        suppressHydrationWarning={true}
      >
        {children}
      </body>
    </html>
  );
}
</file>

<file path="app/(main)/(casting)/casting/page.tsx">
import { cookies } from 'next/headers';
import { getShowById, getActiveProduction } from '@/app/lib/baserow';
import CastingClient from '@/app/components/casting/CastingClient';

export default async function CastingPage() {
  const cookieStore = await cookies();
  let activeId = Number(cookieStore.get('active_production_id')?.value);
  
  // 1. Fetch the Full Production Object
  let productionData = null;

  if (activeId) {
    productionData = await getShowById(activeId);
  } 
  
  // Fallback if no cookie
  if (!productionData) {
    productionData = await getActiveProduction();
  }

  // 2. Extract Key IDs
  const productionId = productionData?.id || 0;
  const productionTitle = productionData?.Title || "Select a Production";
  
  //  THE FIX: Get the Blueprint ID (Master Show)
  // This looks at the "Master Show Database" column in your Productions table
  const masterShowLink = productionData?.["Master Show Database"];
  const masterShowId = (masterShowLink && masterShowLink.length > 0) ? masterShowLink[0].id : null;

  return (
    <main className="min-h-screen bg-zinc-950">
      <CastingClient 
        productionId={productionId} 
        productionTitle={productionTitle}
        masterShowId={masterShowId} // <--- Passing the Blueprint ID
      />
    </main>
  );
}
</file>

<file path="app/(main)/(casting)/conflicts/page.tsx">
import { cookies } from 'next/headers';
import { 
    getShowById, 
    getActiveProduction,
    getScenes,
    getRoles,
    getAssignments,
    getPeople,
    getConflicts,
    getProductionEvents // <--- Import this
} from '@/app/lib/baserow';
import ConflictClient from '@/app/components/conflicts/ConflictClient';

export default async function ConflictsPage() {
  const cookieStore = await cookies();
  let activeId = Number(cookieStore.get('active_production_id')?.value);
  let showTitle = "Select a Production";

  if (activeId) {
    const showData = await getShowById(activeId);
    if (showData && !Array.isArray(showData)) showTitle = showData.Title;
  } else {
    const defaultShow = await getActiveProduction();
    if (defaultShow) {
      activeId = defaultShow.id;
      showTitle = defaultShow.Title;
    }
  }

  // Fetch ALL the data
  const [scenes, roles, assignments, people, conflicts, events] = await Promise.all([
      getScenes(activeId),
      getRoles(),
      getAssignments(activeId),
      getPeople(),
      getConflicts(activeId),
      getProductionEvents(activeId) // <--- Fetch the calendar
  ]);

  return (
    <main className="h-screen bg-zinc-950 overflow-hidden">
      <ConflictClient 
        scenes={scenes}
        roles={roles}
        assignments={assignments}
        people={people}
        conflictRows={conflicts}
        eventRows={events} // <--- Pass it to client
        productionTitle={showTitle}
      />
    </main>
  );
}
</file>

<file path="app/components/committees/CommitteeClient.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import React, { useState, useEffect, useMemo } from 'react';
import { 
  Printer, Loader2, Crown, Phone, Mail, Baby, 
  Wand2, RotateCcw, X, ExternalLink,
  MessageSquare, Hash, Image as ImageIcon, FileText, Plus,
  Trash2, UserPlus, Sliders, Info, CheckCircle2
} from 'lucide-react';
import { getCommitteePreferences, getAuditionSlots } from '@/app/lib/baserow'; 

// --- CONFIG ---
const COMMITTEES = {
    'Pre-Show': ["Publicity", "Sets", "Set Dressing", "Raffles", "Green Room", "Costumes", "Props", "Makeup", "Hair", "Tech"],
    'Show Week': ["Raffles", "Green Room", "Costumes", "Props", "Makeup", "Hair", "Tech", "Ninjas/Set Movers", "Box Office", "Concessions", "Security"]
};

// ---  STAFFING RULES (Industry Standards) ---
const DEFAULT_RULES: Record<string, { type: 'fixed' | 'ratio', val: number, min?: number, reason: string }> = {
    "Green Room": { type: 'ratio', val: 8, min: 2, reason: "Safety: 1 Adult per 8 Students" }, 
    "Costumes": { type: 'ratio', val: 6, min: 3, reason: "Labor: 1 per 6 Actors" },   
    "Makeup": { type: 'ratio', val: 7, min: 2, reason: "Speed: 1 per 7 Actors" },
    "Tech": { type: 'fixed', val: 5, reason: "Booth + Deck Crew" },               
    "Sets": { type: 'fixed', val: 8, reason: "Heavy Lifting Team" },               
    "Security": { type: 'fixed', val: 3, reason: "Door & Perimeter" },
    "Box Office": { type: 'fixed', val: 3, reason: "Ticket Window & Will Call" },
    "Concessions": { type: 'fixed', val: 4, reason: "Prep & Sales" },
    "Publicity": { type: 'fixed', val: 3, reason: "Social Media & Posters" },
    "default": { type: 'fixed', val: 3, reason: "Standard Committee Size" }
};

// Mock Resources
const MOCK_RESOURCES: Record<string, any> = {
    Costumes: { 
        slack: "#", pinterest: "#", drive: "#", status: "Yellow",
        reports: [{ date: "Jan 24", author: "Jessica Taylor", text: "Measurements complete. Need budget.", status: "Yellow" }]
    },
    Sets: { 
        slack: "#", pinterest: null, drive: "#", status: "Green",
        reports: [{ date: "Jan 24", author: "Mike Miller", text: "Lumber purchased.", status: "Green" }]
    }
};

export default function CommitteeDashboard({ activeId }: { activeId: number }) {
  const [rawData, setRawData] = useState<any[]>([]);
  const [students, setStudents] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Assignments: { "pre-101": "Sets", "show-101": "Tech" }
  const [assignments, setAssignments] = useState<Record<string, string>>({});
  const [history, setHistory] = useState<Record<string, string>>({}); 
  
  // Leadership
  const [leadership, setLeadership] = useState<Record<string, { chair: number | null, coChair: number | null }>>({});

  // Settings & View State
  const [groupBy, setGroupBy] = useState<'Pre-Show' | 'Show Week'>('Pre-Show');
  const [selectedCommittee, setSelectedCommittee] = useState<string | null>(null);
  const [rules, setRules] = useState(DEFAULT_RULES);
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);

  // --- HELPER: Baserow Data Extraction ---
  const safeLinkName = (field: any, fallback: string) => {
      if (!field) return fallback;
      if (Array.isArray(field) && field.length > 0) return field[0].value;
      if (typeof field === 'string') return field;
      return fallback;
  };

  const safeLinkId = (field: any) => {
      if (Array.isArray(field) && field.length > 0) return field[0].id;
      return null;
  };

  // --- 1. LOAD DATA ---
  useEffect(() => {
    async function loadData() {
        try {
            const [prefData, studentData] = await Promise.all([
                getCommitteePreferences(activeId), 
                getAuditionSlots(activeId)
            ]);
            
            const processed = prefData.map((p: any) => {
                const linkId = safeLinkId(p["Student ID"]);
                const pName = safeLinkName(p["Parent Name"], p["Full Name"] || "Unknown Volunteer");

                return {
                    ...p,
                    id: p.id,
                    preShow1: p["Pre-Show 1st"]?.value,
                    preShow2: p["Pre-Show 2nd"]?.value,
                    preShow3: p["Pre-Show 3rd"]?.value,
                    showWeek1: p["Show Week 1st"]?.value,
                    showWeek2: p["Show Week 2nd"]?.value,
                    showWeek3: p["Show Week 3rd"]?.value,
                    chairInterests: p["Chair Interest"]?.map((c: any) => c.value) || [],
                    studentIdLink: linkId,
                    parentName: pName, 
                    email: p["Email"] || "",
                    phone: p["Phone"] || "",
                    notes: p["Notes/Constraints"] || "",
                    isParent: !!linkId,
                };
            });

            // Initial Assign based on 1st Choice
            const initialAssignments: Record<string, string> = {};
            processed.forEach((p: any) => {
                 if (p.preShow1) initialAssignments[`pre-${p.id}`] = p.preShow1;
                 if (p.showWeek1) initialAssignments[`show-${p.id}`] = p.showWeek1;
            });

            setRawData(processed);
            setStudents(studentData);
            setAssignments(initialAssignments);
            setHistory(initialAssignments);
        } catch (error) {
            console.error("Failed to load dashboard:", error);
        } finally {
            setLoading(false);
        }
    }
    loadData();
  }, [activeId]);

  // --- HELPER: CALCULATE TARGETS ---
  const getCommitteeTarget = (committeeName: string) => {
      const castSize = students.length || 40; 
      const rule = rules[committeeName] || rules["default"];
      
      if (rule.type === 'fixed') return rule.val;
      
      // Ratio Logic
      let calculated = Math.ceil(castSize / rule.val);
      if (rule.min && calculated < rule.min) calculated = rule.min;
      return calculated;
  };

  const updateRuleValue = (key: string, newVal: number) => {
      setRules(prev => ({
          ...prev,
          [key]: { ...prev[key], val: newVal }
      }));
  };

  // --- ACTIONS ---

  const handleClearBoard = () => {
      if(!confirm(`Are you sure you want to clear ALL assignments for ${groupBy}?`)) return;
      const newAssignments = { ...assignments };
      rawData.forEach(p => {
          const key = groupBy === 'Pre-Show' ? `pre-${p.id}` : `show-${p.id}`;
          delete newAssignments[key];
      });
      setAssignments(newAssignments);
  };

  // ---  SMART AUTO-BALANCE ---
  const handleAutoBalance = () => {
      if(!confirm(`Auto-Balance ${groupBy}?\n\nLogic:\n1. Find understaffed committees (based on specific rules).\n2. Move volunteers from overstaffed teams.\n3. Only move if it matches their 2nd or 3rd choice.`)) return;
      
      const newAssignments = { ...assignments };
      // @ts-ignore
      const currentCommittees = COMMITTEES[groupBy];
      let movedCount = 0;

      const getCount = (comm: string) => {
          return rawData.filter(p => {
              const key = groupBy === 'Pre-Show' ? `pre-${p.id}` : `show-${p.id}`;
              return newAssignments[key] === comm;
          }).length;
      };

      currentCommittees.forEach((targetComm: string) => {
          const targetLimit = getCommitteeTarget(targetComm); // Uses dynamic rules
          
          if (getCount(targetComm) < targetLimit) {
               rawData.forEach(p => {
                   if (getCount(targetComm) >= targetLimit) return; // Stop if filled

                   const key = groupBy === 'Pre-Show' ? `pre-${p.id}` : `show-${p.id}`;
                   const currentComm = newAssignments[key];
                   const currentLimit = getCommitteeTarget(currentComm);
                   
                   // Only steal from "Rich" committees
                   if (currentComm && getCount(currentComm) > currentLimit) {
                       const c2 = groupBy === 'Pre-Show' ? p.preShow2 : p.showWeek2;
                       const c3 = groupBy === 'Pre-Show' ? p.preShow3 : p.showWeek3;
                       
                       if (c2 === targetComm || c3 === targetComm) {
                           newAssignments[key] = targetComm;
                           movedCount++;
                       }
                   }
               });
          }
      });
      
      setAssignments(newAssignments);
      alert(`Auto-Balance Complete: Optimized ${movedCount} assignments.`);
  };

  const handleSetLeader = (committee: string, role: 'chair' | 'coChair', personId: number | null) => {
      const key = `${groupBy}:${committee}`;
      setLeadership(prev => ({
          ...prev,
          [key]: {
              ...(prev[key] || { chair: null, coChair: null }),
              [role]: personId
          }
      }));
  };

  // Group Logic
  const groupedData = useMemo(() => {
      const groups: Record<string, any[]> = {};
      // @ts-ignore
      COMMITTEES[groupBy].forEach(c => groups[c] = []);
      groups["Unassigned"] = [];

      rawData.forEach(p => {
          const key = groupBy === 'Pre-Show' ? `pre-${p.id}` : `show-${p.id}`;
          const assignedVal = assignments[key];
          if (assignedVal && groups[assignedVal]) groups[assignedVal].push(p);
          else groups["Unassigned"].push(p);
      });
      return groups;
  }, [rawData, assignments, groupBy]);

  const currentTeam = selectedCommittee ? groupedData[selectedCommittee] : [];
  const leadershipKey = `${groupBy}:${selectedCommittee}`;
  const currentLeaders = leadership[leadershipKey] || { chair: null, coChair: null };

  if (loading) return <div className="h-screen bg-zinc-950 flex flex-col items-center justify-center text-white"><Loader2 className="animate-spin text-blue-500 mr-2"/> Loading...</div>;

  return (
    <div className="min-h-screen bg-zinc-950 text-white font-sans p-4 md:p-6 flex flex-col">
        {/* HEADER */}
        <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 mb-6 print:hidden">
            <div>
                <h1 className="text-2xl font-black uppercase italic tracking-tighter text-white">Committee Manager</h1>
                <p className="text-zinc-500 text-xs font-medium">
                    {rawData.length} Volunteers  Cast Size: <span className="text-blue-400 font-bold">{students.length}</span>
                </p>
            </div>
            <div className="flex flex-wrap gap-2 w-full xl:w-auto">
                <div className="bg-zinc-900 border border-white/10 rounded-lg p-1 flex shadow-inner">
                    <button onClick={() => setGroupBy('Pre-Show')} className={`px-4 py-2 rounded text-xs font-bold uppercase transition-all ${groupBy === 'Pre-Show' ? 'bg-blue-600 text-white shadow-lg' : 'text-zinc-500 hover:text-white'}`}>Pre-Show</button>
                    <button onClick={() => setGroupBy('Show Week')} className={`px-4 py-2 rounded text-xs font-bold uppercase transition-all ${groupBy === 'Show Week' ? 'bg-blue-600 text-white shadow-lg' : 'text-zinc-500 hover:text-white'}`}>Show Week</button>
                </div>
                
                <button onClick={() => setIsSettingsOpen(true)} className="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 border border-white/5 px-4 py-2 rounded-lg text-xs font-bold uppercase flex items-center gap-2 transition-all">
                    <Sliders size={14}/> Staffing Rules
                </button>

                <button onClick={handleAutoBalance} className="bg-emerald-600/10 hover:bg-emerald-600/20 text-emerald-500 border border-emerald-600/50 px-4 py-2 rounded-lg text-xs font-black uppercase flex items-center gap-2 transition-all">
                    <Wand2 size={14}/> Auto-Balance
                </button>

                <button onClick={handleClearBoard} className="bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/50 px-4 py-2 rounded-lg text-xs font-black uppercase flex items-center gap-2 transition-all">
                    <Trash2 size={14}/> Clear Board
                </button>

                <button onClick={() => setAssignments(history)} className="bg-zinc-800 hover:bg-zinc-700 text-zinc-400 px-3 py-2 rounded-lg transition-all" title="Undo All Changes">
                    <RotateCcw size={14}/>
                </button>
                <button onClick={() => window.print()} className="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-xs font-black uppercase flex items-center gap-2 transition-all shadow-xl">
                    <Printer size={14}/> Print
                </button>
            </div>
        </div>

        {/* BOARD GRID */}
        <div className="columns-1 md:columns-2 xl:columns-3 gap-6 space-y-6 print:block print:columns-2">
            {Object.keys(groupedData).map(committee => {
                const team = groupedData[committee];
                const target = getCommitteeTarget(committee);
                
                const isUnderstaffed = team.length < target;
                const isOverstaffed = team.length > target + 2; 
                const statusColor = isUnderstaffed ? 'text-amber-500' : isOverstaffed ? 'text-blue-400' : 'text-emerald-500';
                const statusBorder = isUnderstaffed ? 'border-amber-500/30 bg-amber-900/10' : 'border-white/10 bg-zinc-900/40';

                const lKey = `${groupBy}:${committee}`;
                const leaders = leadership[lKey] || { chair: null, coChair: null };
                const chairName = rawData.find(p => p.id === leaders.chair)?.parentName;

                if (team.length === 0 && committee !== "Unassigned") return null;

                return (
                    <div key={committee} className={`break-inside-avoid mb-6 rounded-2xl overflow-hidden border shadow-2xl ${statusBorder} print:border-black print:bg-white print:mb-8`}>
                        <div 
                            onClick={() => setSelectedCommittee(committee)}
                            className="p-4 border-b border-white/5 flex justify-between items-center cursor-pointer hover:bg-white/5 transition-colors"
                        >
                            <div>
                                <h3 className={`font-black uppercase text-sm tracking-widest ${statusColor} print:text-black`}>{committee}</h3>
                                {chairName && <p className="text-[9px] text-blue-400 font-bold mt-0.5 flex items-center gap-1"><Crown size={10}/> {chairName}</p>}
                            </div>
                            <span className={`text-[10px] font-bold px-2 py-1 rounded-md border border-white/10 bg-zinc-950 text-zinc-400`}>
                                {team.length} / {target}
                            </span>
                        </div>
                        <div className="p-3 space-y-1">
                            {team.slice(0, 3).map((p: any) => (
                                <div key={p.id} className="text-xs text-zinc-400 flex justify-between">
                                    <span>{p.parentName}</span>
                                    {p.chairInterests.some((ci:string) => ci.includes(committee)) && <span className="text-[8px] bg-zinc-800 px-1 rounded text-zinc-500">Wants Chair</span>}
                                </div>
                            ))}
                            {team.length > 3 && <div className="text-[10px] text-zinc-600 italic pt-1">+{team.length - 3} more...</div>}
                        </div>
                    </div>
                );
            })}
        </div>

        {/* --- SETTINGS MODAL --- */}
        {isSettingsOpen && (
            <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-8" onClick={() => setIsSettingsOpen(false)}>
                <div className="bg-zinc-900 border border-white/10 rounded-2xl w-full max-w-lg flex flex-col shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                    <div className="p-6 border-b border-white/10 flex justify-between items-center bg-zinc-800/50">
                        <div>
                            <h2 className="text-xl font-black uppercase italic tracking-tighter text-white flex items-center gap-2"><Sliders size={18}/> Staffing Logic</h2>
                            <p className="text-xs text-zinc-500 mt-1">Adjust target ratios for {students.length} cast members</p>
                        </div>
                        <button onClick={() => setIsSettingsOpen(false)}><X className="text-zinc-500 hover:text-white"/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-4 max-h-[60vh] custom-scrollbar">
                        {/* @ts-ignore */}
                        {COMMITTEES[groupBy].map((c) => {
                            const rule = rules[c] || rules["default"];
                            const currentTarget = getCommitteeTarget(c);
                            
                            return (
                                <div key={c} className="flex items-center justify-between p-3 bg-black/20 rounded-xl border border-white/5">
                                    <div>
                                        <div className="font-bold text-sm text-zinc-200">{c}</div>
                                        <div className="text-[10px] text-zinc-500 flex items-center gap-1 mt-0.5">
                                            <Info size={10}/> {rule.reason}
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="text-right">
                                            <div className="text-lg font-black text-blue-400 leading-none">{currentTarget}</div>
                                            <div className="text-[8px] font-bold text-zinc-600 uppercase">Target</div>
                                        </div>
                                        <div className="flex flex-col gap-1">
                                            <button onClick={() => updateRuleValue(c, rule.val + (rule.type === 'ratio' ? -1 : 1))} className="w-6 h-6 bg-zinc-800 rounded hover:bg-zinc-700 text-xs font-bold flex items-center justify-center"></button>
                                            <button onClick={() => updateRuleValue(c, rule.val + (rule.type === 'ratio' ? 1 : -1))} className="w-6 h-6 bg-zinc-800 rounded hover:bg-zinc-700 text-xs font-bold flex items-center justify-center"></button>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        )}

        {/* --- MISSION CONTROL DRAWER --- */}
        {selectedCommittee && (
            <div className="fixed inset-0 z-50 flex justify-end">
                <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setSelectedCommittee(null)} />
                <aside className="relative w-full max-w-3xl bg-zinc-900 border-l border-white/10 shadow-2xl flex flex-col animate-in slide-in-from-right duration-300">
                    
                    {/* DRAWER HEADER */}
                    <div className="p-6 border-b border-white/10 flex justify-between items-start bg-zinc-950">
                        <div>
                            <h2 className="text-3xl font-black uppercase italic tracking-tighter text-white">{selectedCommittee}</h2>
                            <p className="text-zinc-500 text-xs font-bold uppercase tracking-widest mt-1">
                                {groupBy}  {currentTeam.length} Members  Target: {getCommitteeTarget(selectedCommittee)}
                            </p>
                        </div>
                        <button onClick={() => setSelectedCommittee(null)} className="p-2 hover:bg-white/10 rounded-full"><X/></button>
                    </div>

                    <div className="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-8">
                        
                        {/* 1. LEADERSHIP CONTROLS */}
                        <section className="bg-zinc-800/50 p-4 rounded-xl border border-white/5">
                            <h3 className="text-xs font-black uppercase text-zinc-500 tracking-widest mb-3 flex items-center gap-2">
                                <Crown size={14} className="text-amber-500"/> Leadership
                            </h3>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-zinc-400 mb-1 block">Committee Chair</label>
                                    <select 
                                        className="w-full bg-zinc-900 border border-white/10 rounded-lg p-2 text-xs text-white outline-none focus:border-blue-500"
                                        value={currentLeaders.chair || ""}
                                        onChange={(e) => handleSetLeader(selectedCommittee, 'chair', e.target.value ? parseInt(e.target.value) : null)}
                                    >
                                        <option value="">-- Select Chair --</option>
                                        {currentTeam.map((p: any) => (
                                            <option key={p.id} value={p.id}>
                                                {p.parentName} {p.chairInterests.some((ci:string) => ci.includes(selectedCommittee)) ? "" : ""}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-zinc-400 mb-1 block">Co-Chair</label>
                                    <select 
                                        className="w-full bg-zinc-900 border border-white/10 rounded-lg p-2 text-xs text-white outline-none focus:border-blue-500"
                                        value={currentLeaders.coChair || ""}
                                        onChange={(e) => handleSetLeader(selectedCommittee, 'coChair', e.target.value ? parseInt(e.target.value) : null)}
                                    >
                                        <option value="">-- Select Co-Chair --</option>
                                        {currentTeam.map((p: any) => (
                                            <option key={p.id} value={p.id}>{p.parentName}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                        </section>

                        {/* 2. ROSTER WITH "X-RAY" PREFERENCES */}
                        <section>
                            <div className="flex justify-between items-end mb-3">
                                <h3 className="text-xs font-black uppercase text-zinc-500 tracking-widest flex items-center gap-2">
                                    <Baby size={14}/> Team Roster
                                </h3>
                                <button className="text-[10px] font-bold text-blue-400 flex items-center gap-1 hover:text-white"><UserPlus size={12}/> Add Person</button>
                            </div>
                            
                            <div className="bg-zinc-950 border border-white/5 rounded-xl divide-y divide-white/5">
                                {currentTeam.map((p: any) => {
                                    const c1 = groupBy === 'Pre-Show' ? p.preShow1 : p.showWeek1;
                                    const c2 = groupBy === 'Pre-Show' ? p.preShow2 : p.showWeek2;
                                    const c3 = groupBy === 'Pre-Show' ? p.preShow3 : p.showWeek3;
                                    
                                    return (
                                        <div key={p.id} className="p-3 hover:bg-white/5 transition-colors group">
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <div className="text-sm font-bold text-zinc-200 flex items-center gap-2">
                                                        {p.parentName}
                                                        {currentLeaders.chair === p.id && <Crown size={12} className="text-amber-500 fill-amber-500/20"/>}
                                                        {currentLeaders.coChair === p.id && <Crown size={12} className="text-zinc-400"/>}
                                                    </div>
                                                    <div className="text-[10px] text-zinc-500">
                                                        {p.email}
                                                    </div>
                                                </div>
                                                
                                                <select 
                                                    className="bg-zinc-900 border border-zinc-800 rounded px-2 py-1 text-[10px] text-zinc-400 outline-none focus:text-white focus:border-blue-500"
                                                    value={selectedCommittee}
                                                    onChange={(e) => {
                                                        const newAssignments = { ...assignments };
                                                        const key = groupBy === 'Pre-Show' ? `pre-${p.id}` : `show-${p.id}`;
                                                        newAssignments[key] = e.target.value;
                                                        setAssignments(newAssignments);
                                                    }}
                                                >
                                                    {/* @ts-ignore */}
                                                    {COMMITTEES[groupBy].map((c: string) => <option key={c} value={c}>{c}</option>)}
                                                    <option value="Unassigned">Unassigned</option>
                                                </select>
                                            </div>

                                            <div className="flex gap-2 mt-2 pt-2 border-t border-white/5 opacity-50 group-hover:opacity-100 transition-opacity">
                                                <PreferenceBadge rank="1" value={c1} current={selectedCommittee} />
                                                <PreferenceBadge rank="2" value={c2} current={selectedCommittee} />
                                                <PreferenceBadge rank="3" value={c3} current={selectedCommittee} />
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        <section>
                            <h3 className="text-xs font-black uppercase text-zinc-500 tracking-widest mb-3 flex items-center gap-2">
                                <ExternalLink size={14}/> Resources
                            </h3>
                            <div className="grid grid-cols-3 gap-3">
                                <ResourceButton href={MOCK_RESOURCES[selectedCommittee]?.slack} icon={<Hash size={18}/>} label="Slack" color="hover:border-purple-500 hover:text-purple-400"/>
                                <ResourceButton href={MOCK_RESOURCES[selectedCommittee]?.pinterest} icon={<ImageIcon size={18}/>} label="Pinterest" color="hover:border-red-500 hover:text-red-400"/>
                                <ResourceButton href={MOCK_RESOURCES[selectedCommittee]?.drive} icon={<FileText size={18}/>} label="Drive" color="hover:border-blue-500 hover:text-blue-400"/>
                            </div>
                        </section>

                    </div>
                </aside>
            </div>
        )}
    </div>
  );
}

function PreferenceBadge({ rank, value, current }: any) {
    const isMatch = value === current;
    return (
        <div className={`flex items-center gap-1.5 px-2 py-1 rounded border text-[9px] font-bold uppercase flex-1 justify-center ${isMatch ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30' : 'bg-zinc-900 border-zinc-800 text-zinc-600'}`}>
            <span className="opacity-50">{rank}:</span>
            <span className="truncate max-w-[80px]">{value || "-"}</span>
            {isMatch && <CheckCircle2 size={8}/>}
        </div>
    )
}

function ResourceButton({ href, icon, label, color }: any) {
    if (!href) return (
        <div className="flex flex-col items-center justify-center p-4 bg-zinc-950 border border-white/5 rounded-xl opacity-50 cursor-not-allowed">
            <div className="text-zinc-600 mb-2">{icon}</div>
            <span className="text-[10px] font-bold uppercase text-zinc-600">{label}</span>
        </div>
    );
    return (
        <a href={href} target="_blank" rel="noopener noreferrer" className={`flex flex-col items-center justify-center p-4 bg-zinc-950 border border-white/5 rounded-xl transition-all group ${color}`}>
            <div className="text-zinc-400 group-hover:text-current mb-2 transition-colors">{icon}</div>
            <span className="text-[10px] font-bold uppercase text-zinc-500 group-hover:text-current transition-colors">{label}</span>
        </a>
    )
}
</file>

<file path="app/(main)/page.tsx">
import { cookies } from 'next/headers';
import { getActiveProduction, getShowById, getAssignments } from '@/app/lib/baserow';
import Link from 'next/link';
import { 
  Users, Calendar, BarChart3, ClipboardCheck, Ticket, 
  ChevronRight, Sparkles, Fish, Cat, Dog, Music, 
  Theater, Book, Newspaper, Waves, Gavel, Snowflake, 
  Crown, Trees, Coffee, Bell, Stars, Paintbrush, Timer,
  Sun, CloudRain, Building2, Anchor, Heart,
  Baby, Bird, ScrollText
} from 'lucide-react';

export default async function DashboardPage() {
  const cookieStore = await cookies();
  const activeId = Number(cookieStore.get('active_production_id')?.value);

  const show = activeId ? await getShowById(activeId) : await getActiveProduction();
  const assignments = await getAssignments(activeId);
  
  // Unique Cast Count (Heads, not Roles)
  const uniqueCastIds = new Set(
    assignments
      .filter((a: any) => a["Person"] && a["Person"].length > 0)
      .map((a: any) => a["Person"][0].id)
  );
  const castCount = uniqueCastIds.size;

  // ---  DYNAMIC THEME ENGINE ---
  const getShowTheme = (title: string) => {
    const t = title.toLowerCase();
    
    // 1. THE SAVANNAH (Lion King) - Warm Sunset Orange
    if (t.includes('lion')) 
        return { icon: <Cat size={220} />, color: 'text-orange-500', bg: 'from-orange-900/40 to-red-900/20', accent: 'text-orange-400' };

    // 2. THE JUNGLE (Shrek, Into the Woods, Jungle Book) - Deep Green
    if (t.includes('jungle') || t.includes('shrek') || t.includes('woods') || t.includes('tarzan')) 
        return { icon: <Trees size={220} />, color: 'text-emerald-600', bg: 'from-emerald-900/40 to-green-900/20', accent: 'text-emerald-400' };

    // 3. THE OCEAN (Mermaid, Moana, Big Fish) - Cyan/Teal
    if (t.includes('mermaid') || t.includes('fish') || t.includes('moana') || t.includes('waves')) 
        return { icon: <Waves size={220} />, color: 'text-cyan-500', bg: 'from-cyan-900/30 to-blue-900/20', accent: 'text-cyan-400' };

    // 4. WINTER & HOLIDAY (Frozen, Elf, Christmas) - Ice Blue
    if (t.includes('christmas') || t.includes('carol') || t.includes('frozen') || t.includes('winter') || t.includes('snow') || t.includes('elf')) 
        return { icon: <Snowflake size={220} />, color: 'text-sky-300', bg: 'from-sky-900/40 to-blue-900/30', accent: 'text-sky-200' };

    // 5. ROYALTY & FAIRYTALE (Cinderella, Beauty, Anastasia, Princess, Aladdin) - Royal Purple/Gold
    if (t.includes('beauty') || t.includes('cinderella') || t.includes('anastasia') || t.includes('princess') || t.includes('aladdin') || t.includes('royal')) 
        return { icon: <Crown size={220} />, color: 'text-purple-400', bg: 'from-purple-900/40 to-fuchsia-900/20', accent: 'text-amber-400' };

    // 6. WHIMSICAL & CANDY (Wonka, Seussical, Matilda, Alice) - Pink/Magenta
    if (t.includes('wonka') || t.includes('seussical') || t.includes('matilda') || t.includes('alice') || t.includes('wonderland') || t.includes('freaky')) 
        return { icon: <Sparkles size={220} />, color: 'text-pink-500', bg: 'from-pink-900/30 to-rose-900/20', accent: 'text-pink-400' };

    // 7. URBAN & INDUSTRIAL (Newsies, Annie, Oliver, 12 Angry Men, Guys and Dolls) - Grayscale/Zinc
    if (t.includes('newsies') || t.includes('newspaper') || t.includes('annie') || t.includes('oliver') || t.includes('angry') || t.includes('guys') || t.includes('take it with you')) 
        return { icon: <Newspaper size={220} />, color: 'text-zinc-400', bg: 'from-zinc-800/40 to-zinc-900', accent: 'text-zinc-200' };

    // 8. AMERICANA & RUSTIC (Oklahoma, Tom Sawyer, Music Man, Fiddler, Tuck, Charlotte) - Amber/Brown
    if (t.includes('oklahoma') || t.includes('sawyer') || t.includes('music man') || t.includes('fiddler') || t.includes('tuck') || t.includes('charlotte') || t.includes('green gables') || t.includes('little women')) 
        return { icon: <Sun size={220} />, color: 'text-amber-600', bg: 'from-amber-900/30 to-orange-900/20', accent: 'text-amber-500' };

    // 9. ANIMALS/PETS (Dalmatians, Charlie Brown, Honk, Doolittle) - Spotted/Playful
    if (t.includes('dalmatians') || t.includes('charlie brown') || t.includes('honk') || t.includes('doolittle') || t.includes('peach')) 
        return { icon: <Dog size={220} />, color: 'text-stone-300', bg: 'from-stone-800/40 to-red-900/10', accent: 'text-red-400' };

    // 10. NIGHT & DREAMS (Starry Night, Almost Maine, Joseph) - Indigo/Deep Blue
    if (t.includes('starry') || t.includes('maine') || t.includes('joseph') || t.includes('dream')) 
        return { icon: <Stars size={220} />, color: 'text-indigo-400', bg: 'from-indigo-900/50 to-blue-950', accent: 'text-yellow-200' };

    // 11. EMERALD CITY (Wizard of Oz) - Bright Green (Distinct from Jungle)
    if (t.includes('wizard') || t.includes('oz') || t.includes('wicked')) 
        return { icon: <Building2 size={220} />, color: 'text-green-500', bg: 'from-green-900/40 to-emerald-900/20', accent: 'text-green-400' };

    // 12. HIGH SCHOOL / TEEN (High School Musical, Footloose, Bye Bye Birdie) - Red/School Colors
    if (t.includes('high school') || t.includes('footloose') || t.includes('birdie')) 
        return { icon: <Music size={220} />, color: 'text-red-600', bg: 'from-red-900/30 to-white/5', accent: 'text-red-500' };

    // 13. SPECIALTY (Rain, Gavel, Coffee, etc)
    if (t.includes('rain')) return { icon: <CloudRain size={220} />, color: 'text-blue-400', bg: 'from-blue-900/30 to-slate-900', accent: 'text-yellow-400' };
    if (t.includes('gavel') || t.includes('legal')) return { icon: <Gavel size={220} />, color: 'text-stone-500', bg: 'from-stone-800 to-black', accent: 'text-stone-300' };
    if (t.includes('bucks') || t.includes('coffee')) return { icon: <Coffee size={220} />, color: 'text-amber-700', bg: 'from-amber-950 to-black', accent: 'text-green-500' };
    if (t.includes('hunchback')) return { icon: <Bell size={220} />, color: 'text-violet-900', bg: 'from-violet-950 to-black', accent: 'text-amber-500' };

    // Fallback: Generic Theater
    return { icon: <Theater size={220} />, color: 'text-blue-500', bg: 'from-zinc-900 to-zinc-900', accent: 'text-blue-500' };
  };

  const theme = getShowTheme(show?.Title || "");

  return (
    <div className="min-h-screen bg-zinc-950 p-6 pb-20 overflow-y-auto custom-scrollbar">
      
      {/* 1. DYNAMIC HERO SECTION */}
      <div className={`relative overflow-hidden bg-zinc-900 border border-white/10 rounded-[2.5rem] p-8 md:p-12 mb-8 shadow-2xl transition-all duration-1000 bg-gradient-to-br ${theme.bg}`}>
        
        {/* LARGE THEME ICON */}
        <div className={`absolute -top-12 -right-12 p-8 opacity-10 rotate-12 transition-all duration-1000 ${theme.color}`}>
            {theme.icon}
        </div>
        
        <div className="relative z-10 max-w-2xl">
            <span className={`text-[10px] font-black uppercase tracking-[0.4em] mb-3 block transition-colors duration-1000 ${theme.accent}`}>
                Current Production
            </span>
            <h1 className="text-4xl md:text-7xl font-black uppercase italic tracking-tighter text-white mb-6 drop-shadow-2xl">
                {show?.Title || "Select Production"}
            </h1>
            
            <div className="flex flex-wrap gap-4 items-center">
                <div className="flex items-center gap-2.5 px-4 py-2 bg-black/30 rounded-full border border-white/10 backdrop-blur-xl shadow-lg">
                    <Users size={18} className="text-zinc-400"/>
                    <span className="text-sm font-black text-white">{castCount} Students Cast</span>
                </div>
                <div className="flex items-center gap-2.5 px-4 py-2 bg-black/30 rounded-full border border-white/10 backdrop-blur-xl shadow-lg">
                    <Ticket size={18} className={theme.accent}/>
                    <span className={`text-sm font-black ${theme.accent}`}>Box Office Active</span>
                </div>
            </div>
        </div>
      </div>

      {/* 2. THE ACTION GRID */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        
        {/* Daily Operations */}
        <div className="space-y-4">
            <h3 className="text-[10px] font-black uppercase tracking-widest text-zinc-600 ml-4 flex items-center gap-2">
                <div className="w-1 h-1 rounded-full bg-zinc-700" /> Daily Workspace
            </h3>
            <ActionCard 
                href="/schedule"
                title="Rehearsal Schedule"
                desc="View and create calls, times, and conflicts"
                icon={<Calendar className="text-blue-400"/>}
                color="bg-blue-400"
            />
            <ActionCard 
                href="/education"
                title="Class Attendance"
                desc="Weekly attendance status and entry"
                icon={<ClipboardCheck className="text-emerald-400"/>}
                color="bg-emerald-400"
            />
        </div>

        {/* Company Management */}
        <div className="space-y-4">
            <h3 className="text-[10px] font-black uppercase tracking-widest text-zinc-600 ml-4 flex items-center gap-2">
                <div className="w-1 h-1 rounded-full bg-zinc-700" /> People & Teams
            </h3>
            <ActionCard 
                href="/committees"
                title="Volunteer Committees"
                desc="Manage parent assignments & roles, track committee progress"
                icon={<Users className="text-purple-400"/>}
                color="bg-purple-400"
            />
            <ActionCard 
                href="/roster"
                title="The Master Roster"
                desc="Contact info, compliance and status tracker"
                icon={<Users className="text-amber-400"/>}
                color="bg-amber-400"
            />
        </div>

        {/* Analytics */}
        <div className="space-y-4">
            <h3 className="text-[10px] font-black uppercase tracking-widest text-zinc-600 ml-4 flex items-center gap-2">
                <div className="w-1 h-1 rounded-full bg-zinc-700" /> Production Health
            </h3>
            <ActionCard 
                href="/reports"
                title="Director Reports"
                desc="Revenue, Cast breakdown, show health metrics"
                icon={<BarChart3 className="text-pink-400"/>}
                color="bg-pink-400"
            />
            <div className="p-8 rounded-3xl border border-dashed border-zinc-800/50 flex flex-col items-center justify-center text-center group transition-all hover:bg-zinc-900/30">
                <Sparkles size={24} className="text-zinc-800 group-hover:text-blue-500/50 transition-all duration-500 mb-2"/>
                <span className="text-[10px] font-black uppercase text-zinc-700 tracking-tighter">Script & Score Hub</span>
                <span className="text-[8px] text-zinc-800 uppercase font-black tracking-widest mt-1">v2.0 Pipeline</span>
            </div>
        </div>

      </div>

      {/* FOOTER */}
      <div className="mt-24 pt-10 border-t border-white/5 flex flex-col items-center gap-3">
          <div className="text-[10px] font-black uppercase tracking-[0.5em] text-zinc-800">Open Backstage Casting</div>
          <div className="flex gap-2">
            <div className="px-3 py-1 bg-zinc-900 border border-white/5 rounded-full text-[9px] text-zinc-500 font-black uppercase tracking-widest">Build 1.1.2</div>
            <div className="px-3 py-1 bg-blue-500/10 border border-blue-500/20 rounded-full text-[9px] text-blue-500 font-black uppercase tracking-widest">Active Server</div>
          </div>
      </div>
    </div>
  );
}

function ActionCard({ href, title, desc, icon, color }: any) {
    return (
        <Link href={href} className="group relative block bg-zinc-900/50 border border-white/5 p-6 rounded-3xl hover:bg-zinc-900 hover:border-white/10 transition-all duration-300 shadow-xl overflow-hidden backdrop-blur-sm">
            <div className={`absolute -right-6 -bottom-6 w-24 h-24 rounded-full opacity-0 group-hover:opacity-10 blur-2xl transition-all duration-500 ${color}`} />
            
            <div className="flex items-center gap-5 relative z-10">
                <div className="p-4 bg-black/40 rounded-2xl border border-white/5 group-hover:scale-110 group-hover:bg-black/60 transition-all duration-500">
                    {icon}
                </div>
                <div className="flex-1 min-w-0">
                    <h4 className="font-black text-white text-base group-hover:text-white transition-colors tracking-tight">{title}</h4>
                    <p className="text-xs text-zinc-500 font-medium line-clamp-1">{desc}</p>
                </div>
                <ChevronRight size={18} className="text-zinc-800 group-hover:text-white transition-all transform group-hover:translate-x-1" />
            </div>
        </Link>
    )
}
</file>

<file path="app/components/globalappheader/client.tsx">
"use client";

import { useState, useRef, useEffect } from 'react';
import { useFormStatus } from 'react-dom';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; 
import { switchProduction } from '@/app/actions'; 
import { 
  Menu, X, ChevronRight, ChevronsUpDown,
  Calendar, Users, UserSquare2, 
  AlertOctagon, BarChart3, Settings, LogOut, Check, Sparkles, MapPin, 
  Home, Star, GraduationCap, LayoutGrid, VenetianMask, Mic2, Megaphone
} from 'lucide-react';

export default function GlobalHeaderClient({ shows, activeId }: { shows: any[], activeId: number }) {
  // Two separate states for two separate menus
  const [isNavOpen, setIsNavOpen] = useState(false);
  const [isContextOpen, setIsContextOpen] = useState(false);
  
  const navRef = useRef<HTMLDivElement>(null);
  const contextRef = useRef<HTMLDivElement>(null);
  const pathname = usePathname(); 

  // Close menus on click outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      // Close Nav if clicking outside
      if (navRef.current && !navRef.current.contains(event.target as Node)) {
        setIsNavOpen(false);
      }
      // Close Context if clicking outside the dropdown area (and not on the button itself)
      if (contextRef.current && !contextRef.current.contains(event.target as Node)) {
        setIsContextOpen(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [isNavOpen, isContextOpen]);

  const activeShow = shows.find(s => s.id === activeId) || shows[0] || { title: "Select Production", branch: "None" };
  const user = { initials: "AF", name: "Austin Fitzhugh", role: "Artistic Director" };

  // Grouping Logic for Switcher
  const groupedShows = shows.reduce((groups, show) => {
    const season = show.season || 'Other';
    if (!groups[season]) groups[season] = [];
    groups[season].push(show);
    return groups;
  }, {} as Record<string, typeof shows>);
  const sortedSeasons = Object.keys(groupedShows).sort((a, b) => b.localeCompare(a));

  return (
    <>
      {/* --- THE STRIP (Always Visible) --- */}
      <header className="h-16 bg-zinc-950 border-b border-zinc-800 flex items-center justify-between px-4 shrink-0 relative z-50">
        
        {/* LEFT AREA: NAV BUTTON + CONTEXT SWITCHER */}
        <div className="flex items-center gap-4">
            
            {/* 1. HAMBURGER (Opens Nav Drawer) */}
            {/* ADDED 'md:hidden' so this vanishes on desktop where the sidebar exists */}
            <button 
                onClick={(e) => { e.stopPropagation(); setIsNavOpen(!isNavOpen); setIsContextOpen(false); }}
                className="p-2 -ml-2 rounded-full hover:bg-zinc-800 text-zinc-400 hover:text-white transition-colors md:hidden"
            >
                {isNavOpen ? <X size={24} /> : <Menu size={24} />}
            </button>

            <div className="h-8 w-px bg-zinc-800 hidden sm:block"></div>
            
            {/* 2. CONTEXT TITLE (Opens Dropdown) */}
            <div className="relative" ref={contextRef}>
                <button 
                    onClick={() => { setIsContextOpen(!isContextOpen); setIsNavOpen(false); }}
                    className={`flex flex-col items-start text-left group transition-all p-2 -my-2 rounded-lg ${isContextOpen ? 'bg-zinc-900' : 'hover:bg-zinc-900/50'}`}
                >
                    <span className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest group-hover:text-zinc-400 transition-colors">
                        Current Production
                    </span>
                    <div className="flex items-center gap-2">
                        <span className="text-sm font-bold text-white truncate max-w-[180px] sm:max-w-md group-hover:text-emerald-400 transition-colors">
                            {activeShow.title}
                        </span>
                        <ChevronsUpDown size={12} className={`text-zinc-600 group-hover:text-zinc-400 transition-transform ${isContextOpen ? 'rotate-180' : ''}`}/>
                    </div>
                </button>

                {/* THE CONTEXT DROPDOWN (Pop-over) */}
                {isContextOpen && (
                    <div className="absolute top-full left-0 mt-2 w-80 bg-zinc-900 border border-zinc-700 rounded-xl shadow-2xl overflow-hidden animate-in fade-in slide-in-from-top-2 z-50 flex flex-col max-h-[70vh]">
                        <div className="bg-zinc-950/50 p-3 border-b border-white/5 backdrop-blur-sm">
                            <span className="text-[10px] font-black uppercase text-zinc-500 tracking-widest flex items-center gap-2">
                                <LayoutGrid size={12}/> Switch Workspace
                            </span>
                        </div>
                        <div className="p-2 space-y-4 overflow-y-auto custom-scrollbar flex-1">
                             {sortedSeasons.map(season => (
                                <div key={season}>
                                    <div className="px-3 py-1.5 mb-1 text-[9px] font-black text-zinc-500 uppercase tracking-widest bg-zinc-950/30 rounded">{season}</div>
                                    <div className="space-y-1">
                                        {groupedShows[season].map((prod) => (
                                            <form key={prod.id} action={switchProduction}>
                                                <input type="hidden" name="productionId" value={prod.id} />
                                                <input type="hidden" name="redirectPath" value={pathname} />
                                                <ContextButton prod={prod} isActive={prod.id === activeId} />
                                            </form>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        </div>

        {/* RIGHT: USER AVATAR */}
        <div className="flex items-center gap-3">
             <div className="hidden md:flex flex-col items-end leading-tight">
                <span className="text-xs font-semibold text-zinc-200">{user.name}</span>
                <span className="text-[10px] text-zinc-500 font-bold uppercase tracking-tighter">{user.role}</span>
            </div>
            <div className="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-xs font-bold text-white shadow-lg shadow-emerald-900/20 cursor-default">
                {user.initials}
            </div>
        </div>
      </header>

      {/* --- THE NAV DRAWER (Mobile Only - Links) --- */}
      {isNavOpen && (
        <div className="fixed inset-0 z-40 flex md:hidden">
            {/* Backdrop */}
            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200" onClick={() => setIsNavOpen(false)} />
            
            {/* Sidebar Content */}
            <div ref={navRef} className="relative w-72 bg-zinc-900 h-full border-r border-zinc-800 shadow-2xl flex flex-col animate-in slide-in-from-left duration-300">
                
                {/* 1. NAVIGATION LINKS */}
                <div className="flex-1 overflow-y-auto p-4 space-y-6 custom-scrollbar pt-6">
                    
{/* Workspace */}
<div>
    <SectionHeader label="Daily Workspace" />
    <div className="space-y-1">
        <MenuLink onClick={() => setIsNavOpen(false)} href="/schedule" icon={<Calendar size={18}/>} label="Scheduler" active={pathname === '/schedule'} />
        
        {/* Added Casting Tools */}
        <MenuLink onClick={() => setIsNavOpen(false)} href="/auditions" icon={<Mic2 size={18}/>} label="Auditions" active={pathname === '/auditions'} />
        <MenuLink onClick={() => setIsNavOpen(false)} href="/callbacks" icon={<Megaphone size={18}/>} label="Callbacks" active={pathname === '/callbacks'} />
        <MenuLink onClick={() => setIsNavOpen(false)} href="/casting" icon={<LayoutGrid size={18}/>} label="Cast Grid" active={pathname === '/casting'} />
    </div>
</div>

                    {/* Company Manager */}
                    <div>
                        <SectionHeader label="Company Manager" />
                        <div className="space-y-1">
                            <MenuLink onClick={() => setIsNavOpen(false)} href="/roster" icon={<UserSquare2 size={18}/>} label="Roster & Forms" active={pathname === '/roster'} />
                            <MenuLink onClick={() => setIsNavOpen(false)} href="/conflicts" icon={<AlertOctagon size={18}/>} label="Conflicts" active={pathname === '/conflicts'} />
                            <MenuLink onClick={() => setIsNavOpen(false)} href="/committees" icon={<VenetianMask size={18}/>} label="Committees" active={pathname === '/committees'} />
                            <MenuLink onClick={() => setIsNavOpen(false)} href="/reports" icon={<BarChart3 size={18}/>} label="Reports" active={pathname === '/reports'} />
                        </div>
                    </div>

                    {/* Education */}
                    <div>
                        <SectionHeader label="Education" />
                        <div className="space-y-1">
                            <MenuLink onClick={() => setIsNavOpen(false)} href="/education" icon={<GraduationCap size={18}/>} label="Class Manager" active={pathname === '/education'} />
                        </div>
                    </div>

                    {/* System */}
                    <div>
                        <SectionHeader label="System" />
                        <div className="space-y-1">
                            <MenuLink onClick={() => setIsNavOpen(false)} href="/settings" icon={<Settings size={18}/>} label="Settings" active={pathname === '/settings'} />
                        </div>
                    </div>
                </div>

                {/* 2. FOOTER */}
                <div className="p-4 border-t border-white/5 bg-zinc-950/50">
                    <button className="flex items-center gap-3 w-full p-2 text-zinc-500 hover:text-red-400 transition-colors">
                        <LogOut size={16} />
                        <span className="text-xs font-bold uppercase tracking-wider">Sign Out</span>
                    </button>
                </div>

            </div>
        </div>
      )}
    </>
  );
}

// --- SUB-COMPONENTS ---

function SectionHeader({ label }: { label: string }) {
    return <div className="px-3 mb-2 text-[10px] font-black text-zinc-600 uppercase tracking-widest">{label}</div>
}

function MenuLink({ href, icon, label, active, onClick }: any) {
    return (
        <Link 
            href={href} 
            onClick={onClick}
            className={`
                flex items-center gap-4 px-3 py-3 rounded-xl transition-all
                ${active 
                    ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/20' 
                    : 'text-zinc-400 hover:bg-zinc-800 hover:text-white'}
            `}
        >
            {icon}
            <span className="font-bold text-sm">{label}</span>
            {active && <ChevronRight size={14} className="ml-auto opacity-50"/>}
        </Link>
    )
}

function ContextButton({ prod, isActive }: { prod: any, isActive: boolean }) {
  const { pending } = useFormStatus();
  
  // Dynamic Dot Color based on Location/Branch
  let dotColor = 'bg-zinc-500'; 
  const loc = (prod.location || "").toLowerCase();
  
  if (loc.includes('fred')) dotColor = 'bg-emerald-500'; // Fredericksburg = Green
  if (loc.includes('stafford')) dotColor = 'bg-amber-500'; // Stafford = Amber
  if (loc.includes('nova')) dotColor = 'bg-indigo-500';    // NoVa = Indigo
  if (loc.includes('spotsy')) dotColor = 'bg-blue-500';    // Spotsylvania = Blue

  return (
    <button 
      disabled={pending} 
      className={`
        w-full flex items-start gap-3 p-2 rounded-lg transition-all text-left group 
        ${isActive ? 'bg-zinc-800 ring-1 ring-zinc-700' : 'hover:bg-zinc-800/50'}
      `}
    >
       {/* Status Dot (aligned with title) */}
       <div className={`w-1.5 h-1.5 rounded-full ${dotColor} mt-1.5 shrink-0`} />
       
       <div className="flex-1 min-w-0">
          {/* Show Title */}
          <div className={`text-xs truncate ${isActive ? 'text-white font-bold' : 'text-zinc-300 group-hover:text-white'}`}>
            {prod.title}
          </div>
          
          {/* RESTORED: Metadata Line */}
          <div className="flex items-center gap-1.5 text-[9px] font-bold text-zinc-600 uppercase tracking-tight mt-0.5 group-hover:text-zinc-500">
             <span>{prod.location || "Unknown"}</span>
             <span className="opacity-50"></span>
             <span>{prod.type || "Show"}</span>
          </div>
       </div>

       {/* Active/Loading State Icons */}
       <div className="mt-0.5">
         {isActive && !pending && <Check size={12} className="text-emerald-500" />}
         {pending && <Sparkles size={12} className="text-emerald-500 animate-spin" />}
       </div>
    </button>
  );
}
</file>

<file path="app/components/schedule/SchedulerClient.tsx">
"use client";

import React, { useState, useMemo } from 'react';
import { 
  Save, X, AlertTriangle, Clock, 
  Users, ChevronRight, ChevronLeft, Search,
  MoreHorizontal, PlayCircle, CheckCircle2,
  Maximize2, Minimize2, Plus, Minus
} from 'lucide-react';

// --- TYPES ---
type TrackType = "Acting" | "Music" | "Dance";
type SceneStatus = "New" | "Worked" | "Polished";

interface ScheduledItem {
  id: string;
  sceneId: number;
  track: TrackType;
  day: 'Fri' | 'Sat';
  weekOffset: number; // 0 = this week, 1 = next week
  startTime: number; // e.g. 18.0 = 6pm
  duration: number; // in minutes (15, 30, 45...)
  status: SceneStatus;
}

// --- CONFIG ---
const FRI_START = 18; // 6 PM
const FRI_END = 21;   // 9 PM
const SAT_START = 10; // 10 AM
const SAT_END = 17;   // 5 PM

export default function SchedulerClient({ scenes, roles, assignments, people, productionTitle }: any) {
  
  // State
  const [schedule, setSchedule] = useState<ScheduledItem[]>([]);
  const [draggedSceneId, setDraggedSceneId] = useState<number | null>(null);
  const [currentWeekOffset, setCurrentWeekOffset] = useState(0);
  const [searchQuery, setSearchQuery] = useState("");
  const [isCallListExpanded, setIsCallListExpanded] = useState(false);

  // ---  DATA PREP ---
  const sceneData = useMemo(() => {
    // 1. Map Person ID -> Name
    const personMap = new Map();
    people.forEach((p: any) => {
        personMap.set(p.id, { 
            name: p["Full Name"] || `ID ${p.id}`, 
        });
    });

    // 2. Map Role -> Cast
    const roleCastMap = new Map<number, number[]>();
    assignments.forEach((a: any) => {
        const roleId = a["Performance Identity"]?.[0]?.id;
        const personId = a["Person"]?.[0]?.id;
        if(roleId && personId) {
            const current = roleCastMap.get(roleId) || [];
            if(!current.includes(personId)) roleCastMap.set(roleId, [...current, personId]);
        }
    });

    // 3. Hydrate Scenes
    return scenes.map((s: any) => {
        const linkedRoles = roles.filter((r: any) => 
            r["Active Scenes"]?.some((link:any) => link.id === s.id)
        );
        const castIds = new Set<number>();
        linkedRoles.forEach((r: any) => {
            const pIds = roleCastMap.get(r.id) || [];
            pIds.forEach(id => castIds.add(id));
        });

        // Determine Status based on schedule history
        // (In a real app, this would come from DB, here we infer from local state)
        const isPolished = schedule.some(i => i.sceneId === s.id && i.status === 'Polished');
        const isWorked = schedule.some(i => i.sceneId === s.id && i.status === 'Worked');

        return {
            id: s.id,
            name: s["Scene Name"],
            act: s["Act"]?.value || "1",
            type: s["Scene Type"]?.value || "Scene",
            cast: Array.from(castIds).map(id => personMap.get(id)).filter(Boolean),
            status: isPolished ? 'Polished' : isWorked ? 'Worked' : 'New'
        };
    }).sort((a: any, b: any) => a.id - b.id);
  }, [scenes, roles, assignments, people, schedule]); // Re-calc when schedule changes for status updates

  // --- ACTIONS ---

  const handleDrop = (e: React.DragEvent, day: 'Fri' | 'Sat', hour: number, min: number, track: TrackType) => {
      e.preventDefault();
      const sceneId = parseInt(e.dataTransfer.getData("sceneId"));
      if(!sceneId) return;

      const startTime = hour + (min / 60);
      
      const newBlock: ScheduledItem = {
          id: Date.now().toString(),
          sceneId,
          track,
          day,
          weekOffset: currentWeekOffset,
          startTime,
          duration: 30, // Default to 30 mins
          status: 'New'
      };

      setSchedule(prev => [...prev, newBlock]);
      setDraggedSceneId(null);
  };

  const updateDuration = (itemId: string, change: number) => {
      setSchedule(prev => prev.map(item => {
          if (item.id !== itemId) return item;
          const newDur = item.duration + change;
          return newDur >= 15 ? { ...item, duration: newDur } : item;
      }));
  };

  const toggleStatus = (itemId: string) => {
      const cycle: Record<SceneStatus, SceneStatus> = { 'New': 'Worked', 'Worked': 'Polished', 'Polished': 'New' };
      setSchedule(prev => prev.map(item => 
          item.id === itemId ? { ...item, status: cycle[item.status] } : item
      ));
  };

  // --- CALCULATIONS ---

  // 1. Current Week Label
  const weekLabel = useMemo(() => {
      const today = new Date();
      // Find next Friday
      const nextFri = new Date(today);
      nextFri.setDate(today.getDate() + (5 + 7 - today.getDay()) % 7);
      // Add Offset
      nextFri.setDate(nextFri.getDate() + (currentWeekOffset * 7));
      return `Week of ${nextFri.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
  }, [currentWeekOffset]);

  // 2. Call List Logic (Start/End Times)
  const callList = useMemo(() => {
      const activeItems = schedule.filter(i => i.weekOffset === currentWeekOffset);
      const actorMap = new Map<string, { name: string, start: number, end: number, day: string }>();

      activeItems.forEach(item => {
          const scene = sceneData.find((s: any) => s.id === item.sceneId);
          if (!scene) return;
          
          const itemEnd = item.startTime + (item.duration / 60);

          scene.cast.forEach((actor: any) => {
              const key = `${actor.name}-${item.day}`; // Unique per day
              const current = actorMap.get(key);

              if (!current) {
                  actorMap.set(key, { 
                      name: actor.name, 
                      start: item.startTime, 
                      end: itemEnd,
                      day: item.day 
                  });
              } else {
                  actorMap.set(key, {
                      ...current,
                      start: Math.min(current.start, item.startTime),
                      end: Math.max(current.end, itemEnd)
                  });
              }
          });
      });

      return Array.from(actorMap.values()).sort((a, b) => {
          if (a.day !== b.day) return a.day === 'Fri' ? -1 : 1;
          return a.start - b.start;
      });
  }, [schedule, currentWeekOffset, sceneData]);

  // 3. Show Health
  const showHealth = useMemo(() => {
      const total = sceneData.length;
      const worked = sceneData.filter((s:any) => s.status === 'Worked').length;
      const polished = sceneData.filter((s:any) => s.status === 'Polished').length;
      return { total, worked, polished };
  }, [sceneData]);


  // --- RENDER HELPERS ---
  const formatTime = (decimalTime: number) => {
      const h = Math.floor(decimalTime);
      const m = Math.round((decimalTime - h) * 60);
      const suffix = h >= 12 ? 'PM' : 'AM';
      const h12 = h > 12 ? h - 12 : h;
      return `${h12}:${m.toString().padStart(2, '0')} ${suffix}`;
  };

  return (
    <div className="flex h-screen bg-zinc-950 text-white overflow-hidden font-sans">
        
        {/* --- LEFT SIDEBAR: SCENE BANK --- */}
        <aside className="w-72 border-r border-white/10 flex flex-col bg-zinc-900 shrink-0 z-20 shadow-xl">
            {/* Header */}
            <div className="p-4 border-b border-white/10">
                <div className="text-[10px] font-black uppercase text-zinc-500 tracking-widest mb-2">Show Health</div>
                <div className="flex h-2 bg-zinc-800 rounded-full overflow-hidden mb-2">
                    <div className="bg-emerald-500" style={{ width: `${(showHealth.polished / showHealth.total) * 100}%` }} title="Polished"/>
                    <div className="bg-blue-500" style={{ width: `${(showHealth.worked / showHealth.total) * 100}%` }} title="Worked"/>
                </div>
                <div className="flex justify-between text-[9px] text-zinc-500 font-bold uppercase">
                    <span className="flex items-center gap-1"><div className="w-1.5 h-1.5 rounded-full bg-emerald-500"/> {showHealth.polished} Polished</span>
                    <span className="flex items-center gap-1"><div className="w-1.5 h-1.5 rounded-full bg-blue-500"/> {showHealth.worked} Worked</span>
                    <span className="flex items-center gap-1"><div className="w-1.5 h-1.5 rounded-full bg-zinc-700"/> {showHealth.total - showHealth.polished - showHealth.worked} New</span>
                </div>
            </div>

            {/* Search */}
            <div className="p-2">
                <div className="relative">
                    <Search size={12} className="absolute left-2.5 top-1/2 -translate-y-1/2 text-zinc-500"/>
                    <input 
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="Filter scenes..." 
                        className="w-full bg-black/20 border border-white/10 rounded-lg pl-8 pr-3 py-1.5 text-xs focus:border-blue-500 outline-none placeholder:text-zinc-600"
                    />
                </div>
            </div>

            {/* List */}
            <div className="flex-1 overflow-y-auto px-2 space-y-1 custom-scrollbar">
                {sceneData.filter((s:any) => s.name.toLowerCase().includes(searchQuery.toLowerCase())).map((scene: any) => (
                    <div 
                        key={scene.id}
                        draggable
                        onDragStart={(e) => {
                            e.dataTransfer.setData("sceneId", scene.id.toString());
                            setDraggedSceneId(scene.id);
                        }}
                        onDragEnd={() => setDraggedSceneId(null)}
                        className={`
                            border p-2 rounded cursor-grab active:cursor-grabbing hover:bg-white/5 transition-all
                            ${scene.status === 'Polished' ? 'border-emerald-500/30 bg-emerald-900/10' : 
                              scene.status === 'Worked' ? 'border-blue-500/30 bg-blue-900/10' : 
                              'border-white/5 bg-zinc-900'}
                        `}
                    >
                        <div className="flex justify-between items-center mb-1">
                            <span className="font-bold text-xs text-zinc-200 truncate">{scene.name}</span>
                            {scene.status === 'Polished' && <CheckCircle2 size={10} className="text-emerald-500"/>}
                            {scene.status === 'Worked' && <PlayCircle size={10} className="text-blue-500"/>}
                        </div>
                        <div className="flex items-center gap-2 text-[10px] text-zinc-500">
                             <span className="bg-black/30 px-1 rounded">Act {scene.act}</span>
                             <span>{scene.cast.length} Actors</span>
                        </div>
                    </div>
                ))}
            </div>

            {/* Call List Preview */}
            <div className="border-t border-white/10 bg-zinc-950">
                <button 
                    onClick={() => setIsCallListExpanded(true)}
                    className="w-full p-3 flex justify-between items-center hover:bg-zinc-900 transition-colors"
                >
                    <span className="text-[10px] font-black uppercase text-emerald-500 flex items-center gap-2">
                        <Users size={12}/> Call List
                    </span>
                    <Maximize2 size={12} className="text-zinc-500"/>
                </button>
            </div>
        </aside>

        {/* --- MAIN: CALENDAR GRID --- */}
        <main className="flex-1 flex flex-col min-w-0 bg-zinc-950 relative">
            
            {/* Header: Week Navigator */}
            <header className="h-14 border-b border-white/10 bg-zinc-900 flex items-center justify-between px-6 shrink-0 shadow-lg z-30">
                <div className="flex items-center gap-4">
                    <div className="flex items-center gap-2 bg-black/40 rounded-lg p-1 border border-white/5">
                        <button onClick={() => setCurrentWeekOffset(c => c - 1)} className="p-1 hover:text-white text-zinc-500 transition-colors"><ChevronLeft size={16}/></button>
                        <span className="text-xs font-bold text-zinc-300 w-32 text-center select-none">{weekLabel}</span>
                        <button onClick={() => setCurrentWeekOffset(c => c + 1)} className="p-1 hover:text-white text-zinc-500 transition-colors"><ChevronRight size={16}/></button>
                    </div>
                    <div className="h-6 w-px bg-white/10 mx-2"></div>
                    <h1 className="text-sm font-bold text-zinc-500 uppercase tracking-widest">{productionTitle}</h1>
                </div>
                <button className="bg-white text-black px-4 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider hover:bg-zinc-200 transition-all">
                    Publish Schedule
                </button>
            </header>

            {/* The Grid Canvas */}
            <div className="flex-1 overflow-y-auto custom-scrollbar bg-zinc-950 p-4">
                <div className="flex gap-4 h-full min-h-[600px]">
                    
                    {/* FRIDAY COLUMN */}
                    <DayColumn 
                        day="Fri" 
                        startHour={FRI_START} 
                        endHour={FRI_END} 
                        schedule={schedule}
                        weekOffset={currentWeekOffset}
                        onDrop={handleDrop}
                        onDurationChange={updateDuration}
                        onStatusToggle={toggleStatus}
                        draggedSceneId={draggedSceneId}
                        sceneData={sceneData}
                    />

                    {/* SATURDAY COLUMN */}
                    <DayColumn 
                        day="Sat" 
                        startHour={SAT_START} 
                        endHour={SAT_END} 
                        schedule={schedule}
                        weekOffset={currentWeekOffset}
                        onDrop={handleDrop}
                        onDurationChange={updateDuration}
                        onStatusToggle={toggleStatus}
                        draggedSceneId={draggedSceneId}
                        sceneData={sceneData}
                    />
                </div>
            </div>
        </main>

        {/* --- MODAL: EXPANDED CALL LIST --- */}
        {isCallListExpanded && (
            <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-8 animate-in fade-in">
                <div className="bg-zinc-900 w-full max-w-4xl h-[80vh] rounded-2xl border border-white/10 flex flex-col shadow-2xl overflow-hidden">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-zinc-800">
                        <h2 className="text-lg font-black uppercase italic tracking-wider text-emerald-500">Weekly Call List</h2>
                        <button onClick={() => setIsCallListExpanded(false)} className="text-zinc-500 hover:text-white"><X size={24}/></button>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-6 grid grid-cols-2 gap-8 custom-scrollbar">
                        {['Fri', 'Sat'].map(day => (
                            <div key={day}>
                                <h3 className="text-sm font-bold text-white mb-4 border-b border-white/10 pb-2">{day === 'Fri' ? 'Friday' : 'Saturday'}</h3>
                                <div className="space-y-2">
                                    {callList.filter(c => c.day === day).map((actor, i) => (
                                        <div key={i} className="flex justify-between items-center p-2 bg-black/20 rounded border border-white/5">
                                            <span className="text-sm text-zinc-300 font-bold">{actor.name}</span>
                                            <div className="text-xs font-mono text-zinc-500 bg-black/40 px-2 py-1 rounded">
                                                {formatTime(actor.start)} - {formatTime(actor.end)}
                                            </div>
                                        </div>
                                    ))}
                                    {callList.filter(c => c.day === day).length === 0 && <p className="text-zinc-600 text-xs italic">No calls.</p>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        )}
    </div>
  );
}

// --- SUB-COMPONENT: DAY COLUMN ---
function DayColumn({ day, startHour, endHour, schedule, weekOffset, onDrop, onDurationChange, onStatusToggle, draggedSceneId, sceneData }: any) {
    
    // Generate Time Slots (15 min increments)
    const slots: { h: any; m: number; val: any; }[] = [];
    for (let h = startHour; h < endHour; h++) {
        [0, 15, 30, 45].forEach(m => slots.push({ h, m, val: h + m/60 }));
    }

    return (
        <div className="flex-1 flex flex-col bg-zinc-900 border border-white/10 rounded-xl overflow-hidden shadow-lg">
            <div className="p-3 bg-zinc-800 border-b border-white/10 text-center font-black uppercase text-zinc-400">
                {day === 'Fri' ? 'Friday Rehearsal' : 'Saturday Rehearsal'}
            </div>
            
            <div className="flex-1 relative overflow-y-auto custom-scrollbar flex">
                
                {/* Time Labels */}
                <div className="w-12 bg-zinc-950/50 border-r border-white/5 flex flex-col text-[10px] text-zinc-600 font-mono text-right py-2">
                    {slots.filter(s => s.m === 0).map(s => (
                        <div key={s.val} style={{ height: '128px' }} className="pr-2 pt-1 border-b border-white/5">
                            {s.h > 12 ? s.h-12 : s.h} {s.h >= 12 ? 'PM' : 'AM'}
                        </div>
                    ))}
                </div>

                {/* Tracks Container */}
                <div className="flex-1 grid grid-cols-3 divide-x divide-white/5 relative min-h-[800px]">
                    {['Acting', 'Music', 'Dance'].map((track, i) => (
                        <div key={track} className="relative group/track">
                             <div className="absolute top-0 left-0 right-0 p-1 text-[9px] font-black uppercase text-center text-zinc-700 bg-zinc-900/80 z-10">{track}</div>
                             
                             {/* Render Slots (Targets) */}
                             {slots.map((slot) => (
                                 <div 
                                    key={slot.val} 
                                    className={`h-8 border-b border-white/[0.03] transition-colors ${draggedSceneId ? 'hover:bg-blue-500/10' : ''}`}
                                    onDragOver={(e) => e.preventDefault()}
                                    onDrop={(e) => onDrop(e, day, slot.h, slot.m, track)}
                                 />
                             ))}

                             {/* Render Blocks */}
                             {schedule
                                .filter((item: ScheduledItem) => item.day === day && item.track === track && item.weekOffset === weekOffset)
                                .map((item: ScheduledItem) => {
                                    // Calculate Position
                                    const top = (item.startTime - startHour) * 128; // 32px per 15 min * 4 = 128px per hour
                                    const height = (item.duration / 60) * 128;
                                    const scene = sceneData.find((s:any) => s.id === item.sceneId);

                                    // Color Logic
                                    let colorClass = "bg-zinc-700 border-zinc-500"; // Default (New)
                                    if (item.status === 'Worked') colorClass = "bg-blue-600 border-blue-400 shadow-blue-900/20";
                                    if (item.status === 'Polished') colorClass = "bg-emerald-600 border-emerald-400 shadow-emerald-900/20";

                                    return (
                                        <div 
                                            key={item.id}
                                            onContextMenu={(e) => { e.preventDefault(); onStatusToggle(item.id); }}
                                            className={`absolute left-1 right-1 rounded border-l-4 p-2 shadow-lg text-white text-xs overflow-hidden flex flex-col justify-between group/block transition-all z-20 ${colorClass}`}
                                            style={{ top: `${top}px`, height: `${height}px` }}
                                        >
                                            <div className="font-bold leading-tight drop-shadow-md truncate">{scene?.name || 'Unknown'}</div>
                                            
                                            {/* HOVER CONTROLS */}
                                            <div className="opacity-0 group-hover/block:opacity-100 flex justify-between items-end transition-opacity">
                                                <div className="flex bg-black/30 rounded">
                                                    <button onClick={() => onDurationChange(item.id, -15)} className="p-0.5 hover:bg-white/20"><Minus size={10}/></button>
                                                    <button onClick={() => onDurationChange(item.id, 15)} className="p-0.5 hover:bg-white/20"><Plus size={10}/></button>
                                                </div>
                                                <div className="text-[9px] font-mono bg-black/30 px-1 rounded">
                                                    {item.duration}m
                                                </div>
                                            </div>
                                        </div>
                                    )
                             })}
                        </div>
                    ))}
                </div>
            </div>
        </div>
    )
}
</file>

<file path="app/components/StaffSidebar.tsx">
"use client";

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { 
  Users, Calendar, UserSquare2, 
  AlertOctagon, BarChart3, VenetianMask, 
  Settings, ChevronDown, ChevronRight,
  Mic2, Megaphone, LayoutGrid, GraduationCap
} from 'lucide-react';

export default function StaffSidebar() {
  const pathname = usePathname();
  
  // Auto-expand Casting Suite if we are inside it
  const isCastingRoute = pathname.includes('/auditions') || pathname.includes('/callbacks') || pathname.includes('/casting');
  const [isCastingOpen, setCastingOpen] = useState(isCastingRoute);

  useEffect(() => {
    // eslint-disable-next-line react-hooks/set-state-in-effect
    if (isCastingRoute) setCastingOpen(true);
  }, [pathname, isCastingRoute]);

  return (
    <nav className="w-64 bg-zinc-900 border-r border-white/5 flex flex-col h-full shrink-0">
      
      {/* BRAND HEADER */}
      <div className="h-16 flex items-center px-6 border-b border-white/5 mb-4 shrink-0">
        <h1 className="text-sm font-black tracking-tighter text-blue-500">
          OPEN<span className="text-white">BACKSTAGE</span>
        </h1>
      </div>

      <div className="flex-1 overflow-y-auto px-4 space-y-8 custom-scrollbar">
        
        {/* --- ZONE 1: CREATIVE TEAM --- */}
        <div>
            <div className="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-2 px-2 flex items-center gap-2">
                Creative Team
            </div>
            <div className="space-y-1">
                <NavItem href="/schedule" icon={<Calendar size={18}/>} label="Scheduler" active={pathname === '/schedule'} />
                
                {/* Collapsible Casting Suite */}
                <div>
                    <button 
                        onClick={() => setCastingOpen(!isCastingOpen)}
                        className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-xs font-bold transition-all ${isCastingRoute ? 'text-white' : 'text-zinc-400 hover:bg-white/5 hover:text-zinc-200'}`}
                    >
                        <div className="flex items-center gap-3">
                            <Users size={18} className={isCastingRoute ? "text-purple-400" : "text-zinc-500"}/>
                            <span>Casting Suite</span>
                        </div>
                        {isCastingOpen ? <ChevronDown size={14}/> : <ChevronRight size={14}/>}
                    </button>

                    {isCastingOpen && (
                        <div className="mt-1 ml-4 pl-4 border-l border-white/10 space-y-1 animate-in slide-in-from-left-2 duration-200">
                            <SubNavItem href="/auditions" icon={<Mic2 size={14}/>} label="Auditions" active={pathname === '/auditions'} />
                            <SubNavItem href="/callbacks" icon={<Megaphone size={14}/>} label="Callbacks" active={pathname === '/callbacks'} />
                            <SubNavItem href="/casting" icon={<LayoutGrid size={14}/>} label="Cast Grid" active={pathname === '/casting'} />
                        </div>
                    )}
                </div>
            </div>
        </div>

        {/* --- ZONE 2: LOGISTICS & OPS --- */}
        <div>
            <div className="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-2 px-2 flex items-center gap-2">
                Logistics & Ops
            </div>
            <div className="space-y-1">
                <NavItem href="/roster" icon={<UserSquare2 size={18}/>} label="Master Roster" active={pathname === '/roster'} />
                <NavItem href="/conflicts" icon={<AlertOctagon size={18}/>} label="Conflict Matrix" active={pathname === '/conflicts'} />
                <NavItem href="/committees" icon={<VenetianMask size={18}/>} label="Committees" active={pathname === '/committees'} />
            </div>
        </div>

        {/* --- ZONE 3: BUSINESS OFFICE --- */}
        <div>
            <div className="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-2 px-2 flex items-center gap-2">
                Business Office
            </div>
            <div className="space-y-1">
                <NavItem href="/reports" icon={<BarChart3 size={18}/>} label="Reports & Fees" active={pathname === '/reports'} />
            </div>
        </div>

        {/* --- ZONE 4: ACADEMY --- */}
        <div>
            <div className="text-[10px] font-black text-pink-500 uppercase tracking-widest mb-2 px-2 flex items-center gap-2">
                Academy
            </div>
            <div className="space-y-1">
                <NavItem href="/education" icon={<GraduationCap size={18}/>} label="Class Manager" active={pathname === '/education'} />
            </div>
        </div>

      </div>

      {/* FOOTER */}
      <div className="p-4 border-t border-white/5">
        <NavItem href="/settings" icon={<Settings size={18}/>} label="System Settings" active={pathname === '/settings'} />
      </div>

    </nav>
  );
}

// --- SUB-COMPONENTS ---

function NavItem({ href, icon, label, active }: any) {
    return (
        <Link 
            href={href} 
            className={`
                flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-bold transition-all
                ${active 
                    ? 'bg-zinc-800 text-white border border-white/5 shadow-sm' 
                    : 'text-zinc-400 hover:bg-white/5 hover:text-zinc-200 border border-transparent'}
            `}
        >
            {icon}
            {label}
        </Link>
    )
}

function SubNavItem({ href, icon, label, active }: any) {
    return (
        <Link 
            href={href} 
            className={`
                flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-all
                ${active 
                    ? 'text-white bg-white/5' 
                    : 'text-zinc-500 hover:text-zinc-300'}
            `}
        >
            {icon}
            {label}
        </Link>
    )
}
</file>

<file path="app/(main)/(staff)/reports/page.tsx">
import { cookies } from 'next/headers';
import { 
    getAssignments, 
    getPeople, 
    getComplianceData,
    getShowById, 
    getActiveProduction 
} from '@/app/lib/baserow';
import ReportsClient from '@/app/components/reports/ReportsClient';

export default async function ReportsPage() {
  const cookieStore = await cookies();
  const activeId = Number(cookieStore.get('active_production_id')?.value);
  
  let productionTitle = "Production Report";
  
  if (activeId) {
      const show = await getShowById(activeId);
      const showData = Array.isArray(show) ? show[0] : show;
      if (showData) productionTitle = showData.Title;
  } else {
      const defaultShow = await getActiveProduction();
      if (defaultShow) productionTitle = defaultShow.Title;
  }

  // Fetch Data
  const [assignments, people, compliance] = await Promise.all([
      getAssignments(activeId),
      getPeople(),
      getComplianceData(activeId)
  ]);

  return (
    <main className="h-full bg-zinc-950 overflow-hidden">
      <ReportsClient 
        productionTitle={productionTitle} 
        assignments={assignments}
        people={people}
        compliance={compliance}
      />
    </main>
  );
}
</file>

<file path="app/components/education/ClassManager.tsx">
"use client";

import React, { useState, useMemo } from 'react';
import { 
  Users, Search, ArrowLeft, 
  Building2, Waves, Compass, Anchor, Navigation, 
  Archive, Filter, X, AlertTriangle, CalendarDays,
  Map as MapIcon, LayoutGrid
} from 'lucide-react';

// --- MOCK CONFIG ---
const SESSIONS = [
    { id: 'winter2026', label: 'Winter 2026', current: true },
    { id: 'fall2025', label: 'Fall 2025', current: false },
    { id: 'spring2025', label: 'Spring 2025', current: false },
];

const AGE_GROUPS = ["5-8", "8-12", "13-18"];
const DAYS = ["Monday", "Tuesday", "Thursday"];

// ---  VENUE MAP DATA ---
// Updated col/row logic for a Horizontal Top-Bar Layout
const VENUE_LAYOUTS: Record<string, any[]> = {
    "River of Life": [
        { id: "main", name: "Sanctuary", capacity: 400, type: "large", col: "col-span-2 md:col-span-1" },
        { id: "lobby", name: "Lobby / Check-In", capacity: 50, type: "common", col: "col-span-2 md:col-span-1" },
        { id: "101", name: "Room 101", capacity: 20, type: "small", col: "col-span-1" },
        { id: "102", name: "Room 102", capacity: 20, type: "small", col: "col-span-1" },
        { id: "hall", name: "Fellowship Hall", capacity: 100, type: "medium", col: "col-span-2 md:col-span-1" },
    ],
    "Hope Presbyterian Church": [
        { id: "gym", name: "Gymnasium", capacity: 200, type: "large", col: "col-span-2 md:col-span-2" },
        { id: "204", name: "Classroom 204", capacity: 15, type: "small", col: "col-span-1" },
        { id: "205", name: "Classroom 205", capacity: 15, type: "small", col: "col-span-1" },
    ]
};

export default function ClassManager({ classes }: any) {
  const [viewState, setViewState] = useState<'locations' | 'classes'>('locations');
  const [selectedLocation, setSelectedLocation] = useState<string>("");
  const [selectedClass, setSelectedClass] = useState<any>(null); // Kept for future attendance logic
  
  // Filters
  const [currentSession, setCurrentSession] = useState(SESSIONS[0]); 
  const [filterDay, setFilterDay] = useState<string | null>(null);
  const [filterAge, setFilterAge] = useState<string | null>(null);
  const [searchTerm, setSearchTerm] = useState("");

  // Map Interaction
  const [hoveredClassId, setHoveredClassId] = useState<number | null>(null);

  // --- THEME ENGINE ---
  const getLocationTheme = (name: string) => {
    const n = name?.toLowerCase() || "";
    if (n.includes('river of life')) return { icon: <Waves size={24} />, color: 'text-cyan-400', bg: 'bg-cyan-500/10', border: 'border-cyan-500/20' };
    if (n.includes('hope')) return { icon: <Compass size={24} />, color: 'text-purple-400', bg: 'bg-purple-500/10', border: 'border-purple-500/20' };
    if (n.includes('river club')) return { icon: <Anchor size={24} />, color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20' };
    if (n.includes('highway')) return { icon: <Navigation size={24} />, color: 'text-amber-400', bg: 'bg-amber-500/10', border: 'border-amber-500/20' };
    return { icon: <Building2 size={24} />, color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20' };
  };

  // Mock assignment of classes to rooms
  const getRoomForClass = (classId: number, location: string) => {
      const rooms = VENUE_LAYOUTS[location];
      if (!rooms || rooms.length === 0) return null;
      const index = classId % rooms.length;
      return rooms[index];
  };

  const visibleClasses = useMemo(() => {
      if (currentSession.id !== 'winter2026') return []; 
      return classes.filter((c:any) => {
          if (c.location !== selectedLocation) return false;
          const matchesSearch = c.name.toLowerCase().includes(searchTerm.toLowerCase()) || c.teacher.toLowerCase().includes(searchTerm.toLowerCase());
          const matchesDay = filterDay ? c.day === filterDay : true;
          const matchesAge = filterAge ? c.ages.includes(filterAge) : true;
          return matchesSearch && matchesDay && matchesAge;
      });
  }, [classes, selectedLocation, searchTerm, currentSession, filterDay, filterAge]);

  const locationStats = useMemo(() => {
    if (currentSession.id !== 'winter2026') return [];
    const stats: Record<string, { count: number, students: number }> = {};
    const globalFiltered = classes.filter((c:any) => {
         const matchesDay = filterDay ? c.day === filterDay : true;
         const matchesAge = filterAge ? c.ages.includes(filterAge) : true;
         return matchesDay && matchesAge;
    });
    globalFiltered.forEach((c: any) => {
        const loc = c.location || "Unknown Location";
        if (!stats[loc]) stats[loc] = { count: 0, students: 0 };
        stats[loc].count++;
        stats[loc].students += c.enrolled;
    });
    return Object.entries(stats).map(([name, data]) => ({ name, ...data }));
  }, [classes, currentSession, filterDay, filterAge]);

  return (
    <div className="flex flex-col h-full bg-zinc-950 text-white font-sans selection:bg-blue-500/30">
        
        {/* VIEW 1: CAMPUS HUB */}
        {viewState === 'locations' && (
            <div className="p-8 max-w-6xl mx-auto w-full animate-in fade-in duration-500">
                <header className="mb-8 flex flex-col xl:flex-row xl:items-end justify-between gap-6">
                    <div>
                        <h1 className="text-4xl font-black uppercase italic tracking-tighter text-white flex items-center gap-3">
                            Class Hub 
                            {!currentSession.current && <span className="px-3 py-1 bg-amber-900/30 text-amber-500 text-xs rounded-full not-italic tracking-normal font-bold flex items-center gap-1 border border-amber-500/20"><Archive size={12}/> Archive</span>}
                        </h1>
                        <p className="text-xs font-bold uppercase tracking-widest text-zinc-500 mt-1">
                            {currentSession.current ? 'Live Enrollment & Logistics' : 'Historical Data Viewer'}
                        </p>
                    </div>

                    <div className="flex flex-col md:flex-row gap-4 items-start md:items-center">
                        {/* SMART FILTERS */}
                        <div className="flex items-center gap-2 bg-zinc-900 p-1 rounded-xl border border-white/5">
                            <div className="px-3 text-zinc-500"><Filter size={14}/></div>
                            <div className="flex gap-1 border-r border-white/10 pr-2">
                                {DAYS.map(day => (
                                    <button key={day} onClick={() => setFilterDay(filterDay === day ? null : day)} className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all ${filterDay === day ? 'bg-blue-600 text-white' : 'text-zinc-500 hover:text-zinc-300'}`}>{day.substring(0, 3)}</button>
                                ))}
                            </div>
                            <div className="flex gap-1 pl-2">
                                {AGE_GROUPS.map(age => (
                                    <button key={age} onClick={() => setFilterAge(filterAge === age ? null : age)} className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all ${filterAge === age ? 'bg-emerald-600 text-white' : 'text-zinc-500 hover:text-zinc-300'}`}>{age}</button>
                                ))}
                            </div>
                            {(filterDay || filterAge) && <button onClick={() => {setFilterDay(null); setFilterAge(null)}} className="px-2 text-zinc-500 hover:text-red-400"><X size={14} /></button>}
                        </div>

                        {/* SESSION SWITCHER */}
                        <div className="relative group z-20">
                            <button className="flex items-center gap-2 bg-zinc-900 border border-white/10 px-4 py-2.5 rounded-xl text-sm font-bold text-zinc-300 hover:text-white hover:border-white/20 transition-all min-w-[140px] justify-between">
                                <span className="flex items-center gap-2"><CalendarDays size={16} className="text-blue-500"/> {currentSession.label}</span>
                            </button>
                            <div className="absolute top-full right-0 mt-2 w-48 bg-zinc-900 border border-white/10 rounded-xl shadow-xl overflow-hidden hidden group-hover:block animate-in fade-in slide-in-from-top-2">
                                {SESSIONS.map(s => (
                                    <button key={s.id} onClick={() => setCurrentSession(s)} className={`w-full text-left px-4 py-3 text-xs font-bold uppercase hover:bg-white/5 flex justify-between ${currentSession.id === s.id ? 'text-blue-400 bg-blue-500/10' : 'text-zinc-400'}`}>{s.label}{s.current && <span className="w-1.5 h-1.5 rounded-full bg-emerald-500"/>}</button>
                                ))}
                            </div>
                        </div>
                    </div>
                </header>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {locationStats.map((loc: any) => {
                        const theme = getLocationTheme(loc.name);
                        return (
                            <button key={loc.name} onClick={() => { setSelectedLocation(loc.name); setViewState('classes'); }}
                                className={`bg-zinc-900 border ${theme.border} p-8 rounded-3xl text-left group hover:bg-zinc-800 transition-all shadow-2xl relative overflow-hidden h-48 flex flex-col justify-between`}>
                                <div className={`absolute -right-4 -bottom-4 opacity-5 group-hover:opacity-10 transition-opacity ${theme.color} rotate-12`}>{React.cloneElement(theme.icon as React.ReactElement, { size: 140 })}</div>
                                <div className="flex items-start justify-between relative z-10">
                                    <div className={`p-3 ${theme.bg} ${theme.color} rounded-2xl group-hover:bg-white group-hover:text-black transition-colors`}>{theme.icon}</div>
                                    <div className="text-right">
                                        <div className="text-3xl font-black text-white">{loc.count}</div>
                                        <div className="text-[9px] font-bold uppercase text-zinc-500 tracking-wider">Classes</div>
                                    </div>
                                </div>
                                <div className="relative z-10">
                                    <h3 className="text-xl font-black text-white mb-1 tracking-tight truncate">{loc.name}</h3>
                                    <div className="flex items-center gap-3 text-xs font-bold uppercase tracking-widest text-zinc-500 group-hover:text-zinc-300">
                                        <span className="flex items-center gap-1.5"><MapIcon size={12}/> View Map</span>
                                        <span className="w-1 h-1 rounded-full bg-zinc-700"/>
                                        <span className="flex items-center gap-1.5"><Users size={12}/> {loc.students} Students</span>
                                    </div>
                                </div>
                            </button>
                        );
                    })}
                </div>
            </div>
        )}

        {/* VIEW 2: CLASS LIST & HEADS-UP MAP */}
        {viewState === 'classes' && (
             <div className="flex flex-col h-full animate-in slide-in-from-right duration-500">
                <div className="p-6 shrink-0 bg-zinc-900/50 border-b border-white/5 z-20 backdrop-blur-xl">
                    <div className="flex justify-between items-start mb-4">
                        <button onClick={() => setViewState('locations')} className="flex items-center gap-2 text-zinc-500 hover:text-white transition-colors text-[10px] font-black uppercase tracking-[0.2em]">
                            <ArrowLeft size={14}/> Back to Hub
                        </button>
                        <div className="flex gap-2">
                            <span className="px-2 py-1 bg-zinc-800 text-zinc-400 text-[10px] font-bold uppercase rounded border border-white/5">{currentSession.label}</span>
                            {filterDay && <span className="px-2 py-1 bg-blue-900/30 text-blue-400 text-[10px] font-bold uppercase rounded border border-blue-500/20">{filterDay}s Only</span>}
                        </div>
                    </div>
                    
                    <div className="flex flex-col lg:flex-row gap-6">
                        <div className="lg:w-1/3">
                            <h1 className="text-3xl font-black uppercase italic tracking-tighter text-white mb-4">{selectedLocation}</h1>
                            <div className="relative w-full">
                                <Search size={16} className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-600"/>
                                <input value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Filter classes..." className="w-full bg-black/40 border border-white/5 rounded-xl pl-12 pr-4 py-2 text-sm focus:border-white/20 outline-none transition-all placeholder:text-zinc-700"/>
                            </div>
                        </div>

                        {/* ---  HEADS-UP VENUE MAP --- */}
                        <div className="flex-1 bg-black/20 rounded-xl border border-white/5 p-4 overflow-x-auto">
                            <div className="flex items-center gap-2 mb-3 text-[10px] font-bold uppercase text-zinc-500 tracking-widest">
                                <LayoutGrid size={12} className="text-blue-500"/> Facility Map
                            </div>
                            
                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 min-w-[500px]">
                                {(VENUE_LAYOUTS[selectedLocation] || []).map((room) => {
                                    const classesInRoom = visibleClasses.filter((c:any) => getRoomForClass(c.id, selectedLocation)?.id === room.id);
                                    const totalStudents = classesInRoom.reduce((acc: number, c:any) => acc + c.enrolled, 0);
                                    const isHighlighted = hoveredClassId && getRoomForClass(hoveredClassId, selectedLocation)?.id === room.id;
                                    const isFull = totalStudents >= room.capacity;
                                    
                                    return (
                                        <div key={room.id} className={`
                                            p-3 rounded-lg border transition-all duration-300 relative overflow-hidden group
                                            ${room.col} 
                                            ${isHighlighted ? 'bg-blue-600 border-blue-400 scale-105 shadow-xl z-10' : 'bg-zinc-800/50 border-white/5 hover:border-white/10'}
                                            ${isFull && !isHighlighted ? 'border-red-500/30 bg-red-900/10' : ''}
                                        `}>
                                            <div className="flex justify-between items-start mb-2">
                                                <span className={`text-[10px] font-black uppercase tracking-tight leading-none ${isHighlighted ? 'text-white' : 'text-zinc-400'}`}>{room.name}</span>
                                                {isFull && <AlertTriangle size={10} className="text-red-500"/>}
                                            </div>
                                            
                                            <div className="flex items-end justify-between">
                                                <div className="flex flex-col">
                                                    <span className={`text-lg font-black leading-none ${isHighlighted ? 'text-white' : 'text-zinc-300'}`}>{totalStudents}</span>
                                                    <span className={`text-[8px] font-bold uppercase ${isHighlighted ? 'text-blue-200' : 'text-zinc-600'}`}>Capacity {room.capacity}</span>
                                                </div>
                                                {/* Mini Bar */}
                                                <div className="w-1.5 h-6 bg-black/40 rounded-full overflow-hidden flex flex-col justify-end">
                                                    <div className={`w-full ${isFull ? 'bg-red-500' : 'bg-emerald-500'}`} style={{ height: `${Math.min((totalStudents / room.capacity) * 100, 100)}%` }} />
                                                </div>
                                            </div>
                                        </div>
                                    )
                                })}
                                {(VENUE_LAYOUTS[selectedLocation] || []).length === 0 && <div className="text-xs text-zinc-500 italic col-span-full py-4 text-center">No map data.</div>}
                            </div>
                        </div>
                    </div>
                </div>

                <div className="flex-1 overflow-y-auto px-6 pb-8 space-y-3 custom-scrollbar pt-4">
                    {visibleClasses.length === 0 && (
                        <div className="p-12 text-center text-zinc-500 border border-dashed border-white/10 rounded-3xl">No classes found.</div>
                    )}
                    {visibleClasses.map((c: any) => {
                        const room = getRoomForClass(c.id, selectedLocation);
                        const isOverCapacity = room && c.enrolled > room.capacity;

                        return (
                            <button key={c.id} 
                                onClick={() => { setSelectedClass(c); /* Add attendance logic here if needed */ }}
                                onMouseEnter={() => setHoveredClassId(c.id)}
                                onMouseLeave={() => setHoveredClassId(null)}
                                className={`w-full bg-zinc-900 border p-4 rounded-2xl flex justify-between items-center group transition-all text-left relative overflow-hidden cursor-default
                                    ${hoveredClassId === c.id ? 'border-blue-500/50 bg-zinc-800' : 'border-white/5 hover:bg-zinc-800'}
                                `}
                            >
                                <div className="flex-1">
                                    <div className="flex items-center gap-3 mb-1">
                                        <span className="text-[10px] font-black uppercase tracking-widest text-zinc-500 bg-black/20 px-2 py-0.5 rounded">{c.day}  {c.time}</span>
                                        {/* Room Badge */}
                                        <span className={`text-[10px] font-mono border px-1.5 py-0.5 rounded flex items-center gap-1 ${isOverCapacity ? 'text-red-400 border-red-500/30 bg-red-900/10' : 'text-zinc-400 border-white/10 bg-zinc-950'}`}>
                                            <MapIcon size={10}/> {room ? room.name : "Unassigned"}
                                        </span>
                                    </div>
                                    <div className="font-black text-white text-lg group-hover:text-blue-400 transition-colors">{c.name}</div>
                                    <div className="text-[10px] font-bold text-zinc-500 uppercase mt-0.5 flex items-center gap-2">
                                        <span className="text-zinc-400">{c.teacher}</span>
                                        <span className="w-1 h-1 rounded-full bg-zinc-700"/>
                                        <span>Ages {c.ages}</span>
                                    </div>
                                </div>
                                <div className="text-right pl-4 border-l border-white/5 ml-4">
                                    <div className={`text-2xl font-black ${isOverCapacity ? 'text-red-500' : 'text-white'}`}>{c.enrolled}</div>
                                    <div className="text-[8px] uppercase font-black text-zinc-700">Students</div>
                                </div>
                            </button>
                        );
                    })}
                </div>
            </div>
        )}
    </div>
  );
}
</file>

<file path="app/components/reports/ReportsClient.tsx">
"use client";

import React, { useMemo } from 'react';
import { 
  BarChart3, PieChart, TrendingUp, DollarSign, 
  Users, Ticket, AlertCircle, CheckCircle2,
  Calendar, CreditCard, ShoppingBag, Gift, Wallet
} from 'lucide-react';

export default function ReportsClient({ productionTitle, assignments, people, compliance }: any) {
  
  // ---  ANALYTICS ENGINE ---
  const stats = useMemo(() => {
    // 1. Cast Totals
    const uniqueIds = new Set(assignments.map((a: any) => a["Person"]?.[0]?.id).filter(Boolean));
    const totalCast = uniqueIds.size || 1; 

    // 2. Financials (Income)
    const paidCount = compliance.filter((c: any) => c.paidFees).length;
    const feeRevenue = paidCount * 250; 
    
    // Mock Extra Revenue (In real app, fetch from "Transactions" table)
    const concessionsRevenue = 1450.00; 
    const rafflesRevenue = 800.00;
    
    const totalRevenue = feeRevenue + concessionsRevenue + rafflesRevenue;
    const projectedRevenue = (totalCast * 250) + 2500; // Fees + Est. Ancillary

    // 3. Compliance Health
    const fullyCleared = compliance.filter((c: any) => 
        c.signedAgreement && c.paidFees && c.headshotSubmitted && c.measurementsTaken
    ).length;

    // 4. Ticket Estimate
    const ticketsSold = Math.floor(totalCast * 12.5); 
    const ticketGoal = totalCast * 20;

    // 5. MOCK EXPENSE DATA (Committee Budgets)
    const expenses = [
        { name: "Sets & Construction", budget: 2000, spent: 1850 },
        { name: "Costumes", budget: 1500, spent: 1625 }, // Over budget example
        { name: "Tech (Sound/Light)", budget: 3000, spent: 450 },
        { name: "Props", budget: 500, spent: 120 },
        { name: "Publicity", budget: 800, spent: 300 },
        { name: "Green Room", budget: 400, spent: 350 },
        { name: "Hair & Makeup", budget: 300, spent: 45 },
        { name: "Concessions Stock", budget: 600, spent: 200 }, // Spend money to make money
    ];

    const totalExpenses = expenses.reduce((acc, curr) => acc + curr.spent, 0);
    const totalBudget = expenses.reduce((acc, curr) => acc + curr.budget, 0);

    return {
      totalCast,
      paidCount,
      feeRevenue,
      concessionsRevenue,
      rafflesRevenue,
      totalRevenue,
      projectedRevenue,
      fullyCleared,
      ticketsSold,
      ticketGoal,
      expenses,
      totalExpenses,
      totalBudget,
      percentPaid: Math.round((paidCount / totalCast) * 100),
      percentCleared: Math.round((fullyCleared / totalCast) * 100)
    };
  }, [assignments, compliance]);

  return (
    <div className="flex flex-col h-full bg-zinc-950 text-white font-sans overflow-hidden">
      
      {/* HEADER */}
      <header className="h-20 border-b border-white/10 flex items-center justify-between px-8 bg-zinc-900/50 backdrop-blur-xl shrink-0">
        <div>
            <h1 className="text-[10px] font-black uppercase tracking-[0.2em] text-amber-500 mb-1">Business Office</h1>
            <h2 className="text-xl font-bold tracking-tighter text-white">{productionTitle} <span className="text-zinc-500">Financials</span></h2>
        </div>
        <div className="flex items-center gap-4">
            <span className="text-xs font-bold text-zinc-500 uppercase tracking-widest">Net Income: <span className="text-emerald-400">${(stats.totalRevenue - stats.totalExpenses).toLocaleString()}</span></span>
            <button onClick={() => window.print()} className="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 px-4 py-2 rounded-lg text-xs font-bold uppercase transition-all flex items-center gap-2">
                <BarChart3 size={14}/> Print Report
            </button>
        </div>
      </header>

      {/* MAIN CONTENT */}
      <main className="flex-1 overflow-y-auto p-8 custom-scrollbar">
        <div className="max-w-7xl mx-auto space-y-8">
            
            {/* 1. INCOME STREAMS ROW */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <StatCard 
                    label="Production Fees" 
                    value={`$${stats.feeRevenue.toLocaleString()}`} 
                    sub={`${stats.paidCount}/${stats.totalCast} Paid`}
                    icon={<CreditCard size={20}/>} 
                    color="text-blue-400" 
                    bg="bg-blue-500/10" 
                    border="border-blue-500/20"
                />
                <StatCard 
                    label="Ticket Sales" 
                    value={stats.ticketsSold.toLocaleString()} 
                    sub={`${Math.round((stats.ticketsSold/stats.ticketGoal)*100)}% of Goal`}
                    icon={<Ticket size={20}/>} 
                    color="text-emerald-400" 
                    bg="bg-emerald-500/10" 
                    border="border-emerald-500/20"
                />
                <StatCard 
                    label="Concessions" 
                    value={`$${stats.concessionsRevenue.toLocaleString()}`} 
                    sub="Gross Revenue"
                    icon={<ShoppingBag size={20}/>} 
                    color="text-pink-400" 
                    bg="bg-pink-500/10" 
                    border="border-pink-500/20"
                />
                <StatCard 
                    label="Raffles / 50-50" 
                    value={`$${stats.rafflesRevenue.toLocaleString()}`} 
                    sub="Gross Revenue"
                    icon={<Gift size={20}/>} 
                    color="text-purple-400" 
                    bg="bg-purple-500/10" 
                    border="border-purple-500/20"
                />
            </div>

            {/* 2. TOTAL REVENUE BAR */}
            <div className="bg-zinc-900 border border-white/5 rounded-3xl p-8 shadow-xl">
                <div className="flex justify-between items-end mb-4">
                    <h3 className="text-lg font-black uppercase italic tracking-tighter flex items-center gap-2">
                        <TrendingUp size={20} className="text-emerald-500"/> Total Revenue
                    </h3>
                    <div className="text-right">
                        <p className="text-2xl font-black text-white">${stats.totalRevenue.toLocaleString()}</p>
                        <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">Target: ${stats.projectedRevenue.toLocaleString()}</p>
                    </div>
                </div>
                
                {/* Progress Bar */}
                <div className="h-6 bg-zinc-800 rounded-full overflow-hidden flex relative">
                    <div className="h-full bg-emerald-500 transition-all duration-1000" style={{ width: `${(stats.feeRevenue / stats.projectedRevenue) * 100}%` }} title="Fees" />
                    <div className="h-full bg-pink-500 transition-all duration-1000" style={{ width: `${(stats.concessionsRevenue / stats.projectedRevenue) * 100}%` }} title="Concessions" />
                    <div className="h-full bg-purple-500 transition-all duration-1000" style={{ width: `${(stats.rafflesRevenue / stats.projectedRevenue) * 100}%` }} title="Raffles" />
                </div>
                
                <div className="flex gap-4 mt-3 justify-center">
                    <LegendItem color="bg-emerald-500" label="Fees" />
                    <LegendItem color="bg-pink-500" label="Concessions" />
                    <LegendItem color="bg-purple-500" label="Raffles" />
                </div>
            </div>

            {/* 3. EXPENSES & COLLECTIONS GRID */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                {/* A. COMMITTEE BUDGETS (The Expense Area) */}
                <div className="bg-zinc-900 border border-white/5 rounded-3xl p-6 flex flex-col h-96">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="text-sm font-black uppercase tracking-widest text-amber-500 flex items-center gap-2">
                            <Wallet size={16}/> Committee Budgets
                        </h3>
                        <span className="text-[10px] font-bold text-zinc-500 uppercase">
                            ${stats.totalExpenses.toLocaleString()} / ${stats.totalBudget.toLocaleString()}
                        </span>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-4 pr-2">
                        {stats.expenses.map((item, i) => {
                            const percent = Math.min((item.spent / item.budget) * 100, 100);
                            const isOver = item.spent > item.budget;
                            
                            return (
                                <div key={i} className="group">
                                    <div className="flex justify-between items-end mb-1">
                                        <span className="text-xs font-bold text-zinc-300 group-hover:text-white transition-colors">{item.name}</span>
                                        <span className={`text-[10px] font-mono ${isOver ? 'text-red-400 font-bold' : 'text-zinc-500'}`}>
                                            ${item.spent} / ${item.budget}
                                        </span>
                                    </div>
                                    <div className="h-2 bg-black rounded-full overflow-hidden">
                                        <div 
                                            className={`h-full rounded-full ${isOver ? 'bg-red-500' : 'bg-zinc-600 group-hover:bg-blue-500'} transition-all`} 
                                            style={{ width: `${percent}%` }}
                                        />
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>

                {/* B. OUTSTANDING FEES (Collections) */}
                <div className="bg-zinc-900 border border-white/5 rounded-3xl p-6 flex flex-col h-96">
                    <h3 className="text-sm font-black uppercase tracking-widest text-red-400 mb-4 flex items-center gap-2">
                        <AlertCircle size={16}/> Outstanding Production Fees
                    </h3>
                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-2">
                        {compliance.filter((c: any) => !c.paidFees).map((student: any) => (
                            <div key={student.id} className="flex justify-between items-center p-3 bg-red-500/5 border border-red-500/10 rounded-xl hover:bg-red-500/10 transition-colors">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-full bg-red-900/20 text-red-500 flex items-center justify-center text-xs font-bold">
                                        {student.performerName.charAt(0)}
                                    </div>
                                    <span className="font-bold text-sm text-zinc-300">{student.performerName}</span>
                                </div>
                                <span className="text-xs font-mono text-red-400">-$250.00</span>
                            </div>
                        ))}
                        {compliance.filter((c: any) => !c.paidFees).length === 0 && (
                            <div className="h-full flex flex-col items-center justify-center text-zinc-500">
                                <CheckCircle2 size={32} className="text-emerald-500 mb-2"/>
                                <p className="italic">All fees collected!</p>
                            </div>
                        )}
                    </div>
                </div>

            </div>

        </div>
      </main>
    </div>
  );
}

// --- SUB-COMPONENTS ---

function StatCard({ label, value, sub, icon, color, bg, border }: any) {
    return (
        <div className={`p-5 rounded-2xl border ${bg} ${border}`}>
            <div className="flex justify-between items-start mb-2">
                <div className={`p-2 rounded-lg ${color} bg-black/20`}>{icon}</div>
                <span className={`text-[10px] font-black uppercase tracking-widest ${color} opacity-80`}>{label}</span>
            </div>
            <div className="text-2xl font-black text-white">{value}</div>
            <div className="text-xs font-bold text-zinc-400 mt-1">{sub}</div>
        </div>
    )
}

function LegendItem({ label, color }: any) {
    return (
        <div className="flex items-center gap-2">
            <div className={`w-2 h-2 rounded-full ${color}`} />
            <span className="text-[10px] font-bold text-zinc-400 uppercase tracking-wider">{label}</span>
        </div>
    )
}
</file>

<file path="app/(main)/layout.tsx">
import React from 'react';
import GlobalHeader from '@/app/components/globalappheader/globalappheader';
import StaffSidebar from '@/app/components/StaffSidebar';

export default function MainLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="flex h-screen bg-zinc-950 text-white overflow-hidden font-sans">
      {/* 1. PERSISTENT SIDEBAR (Desktop Only) */}
      {/* We render the Sidebar here at the layout level. 
          The 'hidden md:flex' class ensures it vanishes on mobile, 
          letting the GlobalHeader's drawer handle navigation there.
      */}
      <aside className="hidden md:flex h-full shrink-0 z-20">
        <StaffSidebar />
      </aside>

      {/* 2. MAIN CONTENT AREA (The rest of the screen) */}
      <div className="flex-1 flex flex-col min-w-0 relative">
        
        {/* A. Global Header (Context Switcher & User Profile) */}
        {/* Stays fixed at the top of the content area */}
        <div className="shrink-0 z-30">
          <GlobalHeader />
        </div>
        
        {/* B. Scrollable Page Content */}
        {/* This <main> becomes the scroll container for the app.
            'flex-1' ensures it takes all remaining vertical space.
            'overflow-y-auto' handles the scrolling internally.
        */}
        <main className="flex-1 overflow-y-auto relative custom-scrollbar bg-zinc-950">
          {children}
        </main>
        
      </div>
    </div>
  );
}
</file>

<file path="app/components/staff/StaffClient.tsx">
"use client";

import React, { useState, useMemo } from 'react';
import { 
  Search, User, Users, X,
  ShieldCheck, ClipboardCheck, CircleDollarSign,
  Check
} from 'lucide-react';

// ---  DATA CONSTANTS ---
const LEGACY_MAP = {
  legal: { title: "Legal & Safety", forms: [{ id: "Form B", label: "Medical Release" }, { id: "Form B", label: "Liability Waiver" }, { id: "Form B", label: "Photo Release" }] },
  financial: { title: "Financials", forms: [{ id: "Fee", label: "Production Fee" }, { id: "Cash", label: "$5 Pizza Money" }, { id: "Tix", label: "Ticket Quota (20)" }] },
  production: { title: "Production Ops", forms: [{ id: "Form K", label: "Performer Bio" }, { id: "Form F", label: "Measurements" }, { id: "Form G", label: "Conflict Sheet" }] },
  family: { title: "Family Commitment", forms: [{ id: "Form H", label: "Committee Selection" }, { id: "Form I", label: "Parent Character Contract" }, { id: "Form A", label: "Student Character Contract" }] }
};

export default function StaffClient({ productionTitle, assignments, people }: any) {
  const [filter, setFilter] = useState("");
  const [selectedMember, setSelectedMember] = useState<any>(null);
  
  // ---  DYNAMIC DATA ENGINE ---
  const roster = useMemo(() => {
    if (!Array.isArray(assignments)) return [];
    const personMap = new Map();
    assignments.forEach((a: any) => {
      const personId = a["Person"]?.[0]?.id;
      if (!personId || personMap.has(personId)) return;
      
      // Deterministic Mock Data logic (Preserved from your original file)
      const isEven = personId % 2 === 0;
      const isThird = personId % 3 === 0;
      const tickets = (personId * 7) % 25;
      
      personMap.set(personId, {
        id: personId,
        name: a["Person"]?.[0]?.value || "Unknown",
        roles: [a["Performance Identity"]?.[0]?.value || "Chorus"],
        avatar: people.find((p: any) => p.id === personId)?.["Headshot"]?.[0]?.url,
        audit: {
          medical: isEven, liability: isEven, photo: isEven,
          fees: personId % 5 !== 0, pizza: personId % 7 !== 0, ticketsMet: tickets >= 20,
          bio: isThird, measurements: isThird, conflicts: personId % 4 !== 0,
          committee: isEven, parentContract: isEven, studentContract: isThird
        },
        ticketsSold: tickets,
        committeeName: isEven ? "Costumes" : isThird ? "Props" : "None",
      });
    });
    return Array.from(personMap.values());
  }, [assignments, people]);

  // Stats for the Dashboard
  const stats = useMemo(() => {
    const total = roster.length || 1;
    const calc = (fn: (p: any) => boolean) => Math.round((roster.filter(fn).length / total) * 100);
    return {
      count: roster.length,
      legal: calc(p => p.audit.medical && p.audit.liability),
      prod: calc(p => p.audit.bio && p.audit.measurements),
      money: calc(p => p.audit.fees && p.audit.pizza),
    };
  }, [roster]);

  return (
    <div className="flex flex-col h-full bg-zinc-950 text-white font-sans">
       
        {/* HEADER */}
        {/* Sticky top-0 ensures the stats bar stays visible while scrolling the grid */}
        <header className="sticky top-0 z-20 h-20 border-b border-white/10 flex items-center justify-between px-8 bg-zinc-950/80 backdrop-blur-xl shrink-0">
            <div>
              <h1 className="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500 mb-1">Production Dashboard</h1>
              <h2 className="text-xl font-bold tracking-tighter truncate max-w-[300px]">{productionTitle}</h2>
            </div>
            
            <div className="hidden xl:flex items-center gap-8">
               <HeaderStat label="Cast Size" value={stats.count} color="text-white" icon={<Users size={14}/>} />
               <HeaderStat label="Legal" value={`${stats.legal}%`} color="text-emerald-400" icon={<ShieldCheck size={14}/>} />
               <HeaderStat label="Ops" value={`${stats.prod}%`} color="text-blue-400" icon={<ClipboardCheck size={14}/>} />
               <HeaderStat label="Money" value={`${stats.money}%`} color="text-amber-400" icon={<CircleDollarSign size={14}/>} />
            </div>

            <div className="relative w-64 ml-8">
              <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"/>
              <input onChange={(e) => setFilter(e.target.value)} placeholder="Search actor..." className="w-full bg-black/40 border border-white/10 rounded-xl pl-10 pr-4 py-2 text-sm outline-none focus:border-blue-500" />
            </div>
        </header>

        {/* MAIN ROSTER GRID */}
        <main className="flex-1 p-8 bg-[radial-gradient(circle_at_20%_20%,rgba(24,24,27,1)_0%,rgba(9,9,11,1)_100%)]">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-6">
            {roster.filter(p => p.name.toLowerCase().includes(filter.toLowerCase())).map((member: any) => (
              <div 
                key={member.id} 
                onClick={() => setSelectedMember(member)}
                className="group bg-zinc-900/40 border border-white/5 rounded-2xl p-5 hover:border-white/20 transition-all cursor-pointer relative"
              >
                <div className="absolute top-0 left-0 w-full h-1 bg-white/5 rounded-t-2xl overflow-hidden">
                  <div className={`h-full transition-all duration-1000 ${member.ticketsSold >= 20 ? 'bg-amber-400' : 'bg-blue-600'}`} style={{ width: `${Math.min((member.ticketsSold / 20) * 100, 100)}%` }} />
                </div>
                <div className="flex justify-between items-start mb-4">
                  <div className="flex gap-4 min-w-0">
                    <div className="w-14 h-14 rounded-2xl bg-zinc-800 border border-white/5 overflow-hidden shadow-inner shrink-0">
                      {member.avatar ? <img src={member.avatar} className="object-cover w-full h-full grayscale group-hover:grayscale-0 transition-all" /> : <div className="w-full h-full flex items-center justify-center text-zinc-700"><User size={24}/></div>}
                    </div>
                    <div className="min-w-0 pt-1">
                      <h3 className="font-bold text-lg text-zinc-100 truncate">{member.name}</h3>
                      <p className="text-[10px] text-zinc-500 font-black uppercase tracking-[0.1em] truncate">{member.roles[0]}</p>
                    </div>
                  </div>
                  <div className="flex flex-col gap-1.5 shrink-0 z-10">
                      <div className="flex gap-1 bg-black/40 p-1 rounded-lg border border-white/5">
                        <RichStatusIcon type="legal" member={member} />
                        <RichStatusIcon type="financial" member={member} />
                      </div>
                      <div className="flex gap-1 bg-black/40 p-1 rounded-lg border border-white/5">
                        <RichStatusIcon type="production" member={member} />
                        <RichStatusIcon type="family" member={member} />
                      </div>
                  </div>
                </div>
                {/* Footer Info */}
                <div className="mt-2 flex justify-between items-end border-t border-white/5 pt-4">
                    <div className="flex flex-col">
                      <span className="text-[8px] font-black text-zinc-600 uppercase mb-1">Ticket Sales</span>
                      <span className={`text-sm font-black ${member.audit.ticketsMet ? 'text-amber-400' : 'text-white'}`}>{member.ticketsSold} <span className="text-zinc-700 font-normal">/ 20</span></span>
                    </div>
                    <div className={`px-3 py-1 rounded-lg text-[10px] font-bold ${member.committeeName === 'None' ? 'bg-red-500/10 text-red-500 border border-red-500/20' : 'bg-zinc-800 text-zinc-400 border border-white/5'}`}>
                        {member.committeeName}
                    </div>
                </div>
              </div>
            ))}
          </div>
        </main>
      
      {/* DRAWER COMPONENT */}
      {selectedMember && (
         <div className="fixed inset-0 z-50 flex justify-end">
            <div className="absolute inset-0 bg-black/80 backdrop-blur-md" onClick={() => setSelectedMember(null)} />
            <aside className="relative w-full max-w-md bg-zinc-900 border-l border-white/10 shadow-2xl p-8 flex flex-col animate-in slide-in-from-right duration-300">
               <button onClick={() => setSelectedMember(null)} className="absolute top-6 right-6 p-2 hover:bg-white/10 rounded-full"><X/></button>
               <h3 className="text-3xl font-black uppercase tracking-tighter mb-2">{selectedMember.name}</h3>
               <div className="space-y-6 mt-8 overflow-y-auto">
                  {Object.entries(LEGACY_MAP).map(([key, section]) => (
                    <div key={key}>
                      <h4 className="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-3 border-b border-white/10 pb-1">{section.title}</h4>
                      {section.forms.map(form => {
                         let isDone = false;
                         const audit = selectedMember.audit;
                         if (form.label.includes("Medical")) isDone = audit.medical;
                         else if (form.label.includes("Liability")) isDone = audit.liability;
                         else if (form.label.includes("Photo")) isDone = audit.photo;
                         else if (form.label.includes("Fee")) isDone = audit.fees;
                         else if (form.label.includes("Pizza")) isDone = audit.pizza;
                         else if (form.label.includes("Ticket")) isDone = audit.ticketsMet;
                         else if (form.label.includes("Bio")) isDone = audit.bio;
                         else if (form.label.includes("Measurements")) isDone = audit.measurements;
                         else if (form.label.includes("Conflict")) isDone = audit.conflicts;
                         else if (form.label.includes("Committee")) isDone = audit.committee;
                         else if (form.label.includes("Parent")) isDone = audit.parentContract;
                         else if (form.label.includes("Student")) isDone = audit.studentContract;
                         
                         return (
                           <div key={form.label} className="flex justify-between py-2 text-sm border-b border-white/5 last:border-0">
                             <span className="text-zinc-400">{form.label}</span>
                             {isDone ? <Check size={16} className="text-emerald-500"/> : <X size={16} className="text-red-500"/>}
                           </div>
                         )
                      })}
                    </div>
                  ))}
               </div>
            </aside>
         </div>
      )}
    </div>
  );
}

// --- HELPER COMPONENTS ---

function RichStatusIcon({ type, member }: any) {
  // Config mapping
  const config = LEGACY_MAP[type as keyof typeof LEGACY_MAP];
  
  const icons = { 
    legal: <ShieldCheck size={12}/>, 
    financial: <CircleDollarSign size={12}/>, 
    production: <ClipboardCheck size={12}/>, 
    family: <Users size={12}/> 
  };
  
  // Status Logic
  let status = 'valid';
  const audit = member.audit;
  
  if ((type === 'legal' && (!audit.medical || !audit.liability)) || 
      (type === 'financial' && (!audit.fees || !audit.pizza)) || 
      (type === 'production' && !audit.bio) ||
      (type === 'family' && !audit.committee)) {
      status = 'emergency';
  }

  const colors = {
    emergency: "text-red-500 bg-red-500/10 border-red-500/40 animate-pulse",
    valid: "text-emerald-500 bg-emerald-500/10 border-emerald-500/30",
  };

  return (
    // 1. CHANGED: 'group' -> 'group/icon' (Named Group)
    // 2. ADDED: 'hover:z-50' (Brings active icon to front so tooltip isn't covered)
    <div className={`group/icon relative p-1.5 rounded-md border transition-all cursor-help hover:z-50 ${colors[status as keyof typeof colors]}`}>
      
      {icons[type as keyof typeof icons]}

      {/* TOOLTIP */}
      {/* 3. CHANGED: 'group-hover:opacity-100' -> 'group-hover/icon:opacity-100' */}
      <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-40 bg-zinc-900 border border-white/10 rounded-xl shadow-2xl opacity-0 group-hover/icon:opacity-100 transition-opacity pointer-events-none z-50 p-3">
        <div className="text-[9px] font-black uppercase text-zinc-500 tracking-widest mb-2 border-b border-white/10 pb-1">
            {config.title}
        </div>
        <div className="space-y-1">
            {config.forms.map((f: any) => (
                <div key={f.label} className="flex justify-between text-[10px] text-zinc-400">
                    <span>{f.label}</span> 
                    {/* Visual fake-check for demo */}
                    <div className={`w-1.5 h-1.5 rounded-full ${status === 'valid' ? 'bg-emerald-500' : 'bg-zinc-700'}`}/>
                </div>
            ))}
        </div>
        {/* Little Arrow */}
        <div className="absolute top-full left-1/2 -translate-x-1/2 -mt-px border-4 border-transparent border-t-zinc-900"></div>
      </div>
    </div>
  );
}

function HeaderStat({ label, value, color, icon }: any) {
  return (
    <div className="flex items-center gap-3">
      <div className="p-2 bg-white/5 rounded-lg text-zinc-500 border border-white/5">{icon}</div>
      <div>
        <div className={`text-xl font-black leading-none ${color}`}>{value}</div>
        <div className="text-[9px] font-black uppercase text-zinc-600 tracking-wider">{label}</div>
      </div>
    </div>
  );
}
</file>

<file path="app/lib/baserow.ts">
// --- CONFIGURATION ---
const BASE_URL = process.env.NEXT_PUBLIC_BASEROW_URL || "https://api.baserow.io";
const HEADERS = {
  "Authorization": `Token ${process.env.NEXT_PUBLIC_BASEROW_TOKEN}`,
  "Content-Type": "application/json",
};

// TABLE IDS
export const TABLES: Record<string, string> = {
  PEOPLE: process.env.NEXT_PUBLIC_BASEROW_TABLE_PEOPLE || "599",
  PRODUCTIONS: "600",
  ASSIGNMENTS: process.env.NEXT_PUBLIC_BASEROW_TABLE_ASSIGNMENTS || "603",
  ROLES: "605",
  VOLUNTEERS: "619",
  COMMITTEE_PREFS: "620",
  EVENTS: "625",
  SCENES: "627",
  AUDITIONS: process.env.NEXT_PUBLIC_BASEROW_TABLE_AUDITIONS || "630",
  ASSETS: "631" 
};

// ---  CENTRAL FETCH HELPER (The Crash Preventer) ---
export async function fetchBaserow(endpoint: string, options: RequestInit = {}) {
  // Ensure user_field_names is always true
  const separator = endpoint.includes('?') ? '&' : '?';
  const url = `${BASE_URL}${endpoint}${separator}user_field_names=true`;

  try {
    const res = await fetch(url, {
      ...options,
      headers: {
        ...HEADERS,
        ...options.headers,
      },
      cache: options.cache || "no-store", // Default to fresh data
    });

    if (!res.ok) {
      console.error(`Baserow API Error [${res.status}]: ${res.statusText} at ${url}`);
      // Return null or empty array depending on context, or throw
      if (options.method === 'DELETE') return true; 
      return []; 
    }

    const data = await res.json();

    //  MAGIC FIX: Automatically unwrap 'results' if it exists
    // This stops the "filter is not a function" crashes in your UI
    if (data && data.results && Array.isArray(data.results)) {
      return data.results;
    }

    return data;
  } catch (error) {
    console.error("Network/Fetch Error:", error);
    return [];
  }
}


// --- SHOW & CONTEXT FUNCTIONS ---

export async function getActiveShows() {
  const data = await fetchBaserow(`/api/database/rows/table/${TABLES.PRODUCTIONS}/?size=200`);
  
  if (!Array.isArray(data)) return [];

  // Filter for Active
  const activeRows = data.filter((row: any) => row["Is Active"] === true);

  return activeRows.map((row: any) => ({
    id: row.id,
    title: row.Title || "Untitled Show",
    location: row.Location?.value || row.Branch?.value || "Unknown Loc",
    type: row.Type?.value || "Main Stage",
    status: row.Status?.value,
    season: row.Season?.value || "General", 
    session: row.Session?.value || "" 
  }));
}

export async function getShowById(id: number) {
  if (!id) return null;
  // We fetch specific row, so no unwrapping needed (returns object, not array)
  return await fetchBaserow(`/api/database/rows/table/${TABLES.PRODUCTIONS}/${id}/`);
}

export async function getSeasonsAndShows() {
  const data = await fetchBaserow(`/api/database/rows/table/${TABLES.PRODUCTIONS}/?size=200`);
  if (!Array.isArray(data)) return { seasons: [], productions: [] };

  return {
    seasons: Array.from(new Set(data.map((r: any) => r.Season?.value).filter(Boolean))).sort().reverse(),
    productions: data
  };
}

export async function getActiveProduction() {
  const data = await fetchBaserow(`/api/database/rows/table/${TABLES.PRODUCTIONS}/?size=50`);
  if (!Array.isArray(data)) return null;
  return data.find((r: any) => r["Is Active"] === true) || data[0];
}

// --- HELPER: NAME MAPPER ---
async function getPersonNameMap() {
  const data = await fetchBaserow(`/api/database/rows/table/${TABLES.PEOPLE}/?size=200`);
  if (!Array.isArray(data)) return new Map();
  return new Map(data.map((p: any) => [p.id, p["Full Name"]]));
}


// --- COMPLIANCE & DASHBOARD FUNCTIONS ---

export async function getComplianceData(productionId?: number) {
  if (!productionId) return [];

  // Use the smart getters below (which now handle filtering)
  const [auditions, assignments] = await Promise.all([
    getAuditionSlots(productionId),
    getAssignments(productionId)
  ]);

  if (!Array.isArray(auditions) || !Array.isArray(assignments)) return [];

  const nameMap = await getPersonNameMap();

  // Create a "Set" of Person IDs who are Cast
  const castPersonIds = new Set();
  assignments.forEach((a: any) => {
    if (a.Person && a.Person.length > 0) {
      castPersonIds.add(a.Person[0].id);
    }
  });

  const castAuditions = auditions.filter((row: any) => {
    const personId = row.Performer?.[0]?.id;
    return personId && castPersonIds.has(personId);
  });

  return castAuditions.map((row: any) => {
    const personId = row.Performer?.[0]?.id;
    const performerName = nameMap.get(personId) || "Unknown Student";
    const hasFile = row['Headshot'] && row['Headshot'].length > 0;
    const manualCheck = row['Headshot Received']?.value || false;

    return {
      id: row.id,
      performerName: performerName,
      signedAgreement: row['Commitment to Character']?.value || false,
      paidFees: row['Paid Fees']?.value || false,
      measurementsTaken: row['Measurements Taken']?.value || false,
      headshotSubmitted: hasFile || manualCheck,
    };
  });
}


// --- SMART READ FUNCTIONS (Now with Server-Side Filtering!) ---
export async function getProductionEvents(productionId?: number) {
  let endpoint = `/api/database/rows/table/${TABLES.EVENTS}/?size=200`;
  if (productionId) {
    endpoint += `&filter__Production__link_row_has=${productionId}`;
  }
  return await fetchBaserow(endpoint);
}
// 1. ASSIGNMENTS: Fixes the "Blank Cast" bug by filtering on server
export async function getAssignments(productionId?: number) {
  let endpoint = `/api/database/rows/table/${TABLES.ASSIGNMENTS}/?size=200`;
  if (productionId) {
    endpoint += `&filter__Production__link_row_has=${productionId}`;
  }
  return await fetchBaserow(endpoint);
}

// 2. AUDITIONS: Filter by Production ID
export async function getAuditionSlots(productionId?: number) {
  let endpoint = `/api/database/rows/table/${TABLES.AUDITIONS}/?size=200`;
  if (productionId) {
    endpoint += `&filter__Production__link_row_has=${productionId}`;
  }
  return await fetchBaserow(endpoint);
}

export async function getAuditionees(productionId?: number) {
  const data = await getAuditionSlots(productionId);
  if (!Array.isArray(data)) return [];

  const nameMap = await getPersonNameMap();

  return data.map((row: any) => {
    if (row.Performer && row.Performer.length > 0) {
      const personId = row.Performer[0].id;
      const realName = nameMap.get(personId);
      if (realName) row.Performer[0].value = realName;
    }
    return row;
  });
}

// 3. SCENES: Filter by Production ID
export async function getScenes(productionId?: number) {
  let endpoint = `/api/database/rows/table/${TABLES.SCENES}/?size=200`;
  if (productionId) {
    endpoint += `&filter__Production__link_row_has=${productionId}`;
  }
  return await fetchBaserow(endpoint);
}

export async function getRoles() {
  // Roles are often generic (Master Show), so we fetch more rows but filter client-side
  return await fetchBaserow(`/api/database/rows/table/${TABLES.ROLES}/?size=200`);
}

export async function getPeople() {
  return await fetchBaserow(`/api/database/rows/table/${TABLES.PEOPLE}/?size=200`);
}

export async function getCommitteePreferences(activeId: number) {
  return await fetchBaserow(`/api/database/rows/table/${TABLES.COMMITTEE_PREFS}/?size=200`);
}

export async function getVolunteers() {
  return await fetchBaserow(`/api/database/rows/table/${TABLES.VOLUNTEERS}/?size=200`);
}

export async function getProductionAssets(productionId: number) {
  let endpoint = `/api/database/rows/table/${TABLES.ASSETS}/?size=200`;
  if (productionId) {
    endpoint += `&filter__Production__link_row_has=${productionId}`;
  }
  return await fetchBaserow(endpoint);
}


// --- WRITE FUNCTIONS (ACTIONS) ---

export async function updateAuditionSlot(rowId: number, data: any) {
  const cleanData = { ...data };
  ["Vocal Score", "Acting Score", "Dance Score", "Stage Presence Score"].forEach(key => {
      if (key in cleanData) cleanData[key] = Number(cleanData[key]) || 0; 
  });

  return await fetchBaserow(`/api/database/rows/table/${TABLES.AUDITIONS}/${rowId}/`, {
    method: "PATCH",
    body: JSON.stringify(cleanData),
  });
}

export async function submitAudition(personId: number, productionId: number, data: any) {
  const payload = {
    ...data,
    "Performer": [personId], 
    "Production": [productionId],
    "Date": new Date().toISOString()
  };

  return await fetchBaserow(`/api/database/rows/table/${TABLES.AUDITIONS}/`, {
    method: "POST",
    body: JSON.stringify(payload),
  });
}

export async function createRole(name: string) {
  return await fetchBaserow(`/api/database/rows/table/${TABLES.ROLES}/`, {
    method: "POST",
    body: JSON.stringify({ "Role Name": name, "Scene Data": "{}" }) 
  });
}

export async function updateRole(id: number, data: any) {
  return await fetchBaserow(`/api/database/rows/table/${TABLES.ROLES}/${id}/`, {
    method: "PATCH",
    body: JSON.stringify(data)
  });
}

export async function deleteRole(id: number) {
  return await fetchBaserow(`/api/database/rows/table/${TABLES.ROLES}/${id}/`, {
    method: "DELETE"
  });
}

export async function deleteRow(tableId: string | number, rowId: number) {
  return await fetchBaserow(`/api/database/rows/table/${tableId}/${rowId}/`, {
    method: "DELETE"
  });
}

export async function linkVolunteerToPerson(preferenceRowId: number, personRowId: number) {
  return await fetchBaserow(`/api/database/rows/table/${TABLES.COMMITTEE_PREFS}/${preferenceRowId}/`, {
    method: "PATCH",
    body: JSON.stringify({ "Linked Person": [personRowId] })
  });
}

export async function createProductionAsset(name: string, url: string, type: string, productionId: number) {
  return await fetchBaserow(`/api/database/rows/table/${TABLES.ASSETS}/`, {
    method: "POST",
    body: JSON.stringify({
      "Name": name,
      "Link": url,
      "Type": type, 
      "Production": [productionId] 
    })
  });
}

export async function createCastAssignment(personId: number, roleId: number, productionId: number) {
  return await fetchBaserow(`/api/database/rows/table/${TABLES.ASSIGNMENTS}/`, {
    method: "POST",
    body: JSON.stringify({
      "Person": [personId],
      "Performance Identity": [roleId],
      "Production": [productionId] 
    }),
  });
}

export async function getConflicts(productionId?: number) {
  let endpoint = `/api/database/rows/table/${TABLES.CONFLICTS || "623"}/?size=200`;
  if (productionId) {
    endpoint += `&filter__Production__link_row_has=${productionId}`;
  }
  return await fetchBaserow(endpoint);
}
</file>

<file path="app/components/casting/CastingClient.tsx">
"use client";

import React, { useState, useEffect, useMemo } from 'react';
import { 
    Loader2, Wand2, Check, AlertCircle, RotateCcw, 
    ClipboardList, X, ChevronDown, ChevronUp, Users, Database 
} from 'lucide-react';
import { 
    getRoles, 
    getAuditionSlots, 
    getScenes, 
    updateRole, 
    createCastAssignment,
    getAssignments, 
    deleteRow,      
    TABLES          
} from '@/app/lib/baserow'; 

import CastWorkspace from '@/app/components/casting/CastWorkspace';
import ChemistryWorkspace from '@/app/components/casting/ChemistryWorkspace';
import CastingInspector from '@/app/components/casting/CastingInspector';

interface CastingClientProps {
  productionId: number;
  productionTitle: string;
  masterShowId?: number | null;
}

export default function CastingClient({ productionId, productionTitle, masterShowId }: CastingClientProps) {
  const [loading, setLoading] = useState(true);
  const [isAutoCasting, setIsAutoCasting] = useState(false);
  const [isClearing, setIsClearing] = useState(false);
  
  //  PROGRESS STATE
  const [progress, setProgress] = useState({ current: 0, total: 0, message: "" });

  const [showAudit, setShowAudit] = useState(false);
  const [drawerExpanded, setDrawerExpanded] = useState(false);
  const [viewMode, setViewMode] = useState<'workspace' | 'chemistry'>('workspace');
  
  const [roles, setRoles] = useState<any[]>([]);
  const [actors, setActors] = useState<any[]>([]);
  const [scenes, setScenes] = useState<any[]>([]);
  const [allAssignments, setAllAssignments] = useState<any[]>([]); // Crucial for deletion
  const [inspectingActorId, setInspectingActorId] = useState<number | null>(null);

// --- DATA LOADING (Optimized) ---
  useEffect(() => {
    async function load() {
        setLoading(true);
        try {
            console.log(` Fetching data for Prod ID: ${productionId}...`);
            
            //  PASS PRODUCTION ID to apply Server-Side Filtering
            // This fixes the 200-row limit bug!
            const [rawRoles, rawAuditions, rawScenes, rawAssignments] = await Promise.all([
                getRoles(), // Roles might be Master-linked, so fetch generic
                getAuditionSlots(productionId), // Filtered!
                getScenes(productionId),        // Filtered!
                getAssignments(productionId)    // Filtered!
            ]);

            const safeArray = (data: any) => Array.isArray(data) ? data : [];
            const roleRows = safeArray(rawRoles);
            const auditionRows = safeArray(rawAuditions);
            const sceneRows = safeArray(rawScenes);
            const assignmentRows = safeArray(rawAssignments);

            console.log(` Loaded: ${assignmentRows.length} Assignments, ${auditionRows.length} Auditions`);

            // 1. Process Actors
            const showActors = auditionRows.map((a: any) => ({
                ...a,
                id: a.id, 
                personId: a["Performer"]?.[0]?.id, 
                performerName: a["Performer"]?.[0]?.value || "Unknown", 
                Performer: a["Performer"]?.[0]?.value || "Unknown",
                Headshot: (a["Headshot"] && a["Headshot"].length > 0) ? a["Headshot"][0].url : null,
                grades: {
                    actingNotes: a["Acting Notes"] || "",
                    vocalNotes: a["Music Notes"] || "",
                    danceNotes: a["Choreography Notes"] || ""
                }
            }));
            
            setActors(showActors);
            setAllAssignments(assignmentRows); // Save for delete logic

            // 2. Map Assignments (No need to filter again, server did it)
            const assignmentMap: Record<number, any[]> = {};
            
            assignmentRows.forEach((a: any) => {
                const roleId = a["Performance Identity"]?.[0]?.id;
                const assignedPersonId = a["Person"]?.[0]?.id;
                
                if (roleId && assignedPersonId) {
                    const actorObj = showActors.find(sa => sa.personId == assignedPersonId);
                    if (actorObj) {
                        if (!assignmentMap[roleId]) assignmentMap[roleId] = [];
                        // Dedupe
                        if (!assignmentMap[roleId].find(x => x.id === actorObj.id)) {
                            assignmentMap[roleId].push(actorObj);
                        }
                    }
                }
            });

            // 3. Process Roles
            const showRoles = roleRows.filter((r: any) => {
                // Client-side filter for roles is fine (usually < 200)
                const prodLinks = r["Production"] || [];
                const isDirectLink = prodLinks.some((link: any) => link.id == productionId);
                const masterLinks = r["Master Show Database"] || [];
                const isMasterLink = masterShowId && masterLinks.some((link: any) => link.id == masterShowId);
                return isDirectLink || isMasterLink;
            });

            const processedRoles = showRoles.map((r: any) => {
                let sceneIds: number[] = [];
                if (r["Active Scenes"] && Array.isArray(r["Active Scenes"])) {
                    sceneIds = r["Active Scenes"].map((s: any) => s.id);
                }
                const assignedActors = assignmentMap[r.id] || [];

                return {
                    id: r.id,
                    name: r["Role Name"] || r.Name || "Unknown",
                    type: r["Role Type"]?.value || "Ensemble",
                    actors: assignedActors, 
                    selectedActorIds: assignedActors.map(a => a.id), 
                    selectedActorId: assignedActors[0]?.id || null, 
                    sceneIds: sceneIds
                };
            });

            // 4. Process Scenes
            const showScenes = sceneRows.sort((a: any, b: any) => a.id - b.id);

            setRoles(processedRoles);
            setScenes(showScenes);

        } catch (e) {
            console.error("Critical Load Error:", e);
        } finally {
            setLoading(false);
        }
    }
    if(productionId) load();
  }, [productionId, masterShowId]);

  // ---  STATS LOGIC ---
  const getActorStats = (actorId: number) => {
      const myRoles = roles.filter(r => r.selectedActorIds.includes(actorId));
      const mySceneIds = new Set(myRoles.flatMap(r => r.sceneIds));
      
      const splitIndex = Math.floor(scenes.length / 2);
      const act1Scenes = scenes.slice(0, splitIndex).map(s => s.id);
      const act2Scenes = scenes.slice(splitIndex).map(s => s.id);

      const hasAct1 = Array.from(mySceneIds).some(sid => act1Scenes.includes(sid as number));
      const hasAct2 = Array.from(mySceneIds).some(sid => act2Scenes.includes(sid as number));
      const count = mySceneIds.size;

      const isCompliant = count >= 3 && hasAct1 && hasAct2;

      return { count, hasAct1, hasAct2, isCompliant, roleCount: myRoles.length };
  };


  // ---  SMART AUTO-CAST (Sequential & Safe) ---
  const handleAutoCast = async () => {
    const confirmMsg = `Auto-Assign Roles?\n\nLogic:\n1. Fill Empty LEAD, SUPPORTING, & FEATURED roles.\n2. Balance remaining students into ENSEMBLE.\n3. Verify min 3 scenes.`;
    if (!confirm(confirmMsg)) return;

    setIsAutoCasting(true);
    
    // Reset Progress
    setProgress({ current: 0, total: 0, message: "Calculating Logic..." });

    const splitIndex = Math.floor(scenes.length / 2);
    const act1Scenes = new Set(scenes.slice(0, splitIndex).map(s => s.id));
    const act2Scenes = new Set(scenes.slice(splitIndex).map(s => s.id));

    let newRoles = JSON.parse(JSON.stringify(roles));
    const updatesToSave: any[] = [];

    // --- ALGORITHM START ---
    actors.forEach(actor => {
        let currentAssignments = newRoles.filter((r: any) => r.selectedActorIds.includes(actor.id));
        const hasPrimaryRole = currentAssignments.some((r: any) => ['Lead', 'Supporting', 'Featured'].includes(r.type));
        let currentSceneIds = new Set(currentAssignments.flatMap((r: any) => r.sceneIds));
        let hasAct1 = Array.from(currentSceneIds).some(sid => act1Scenes.has(sid as number));
        let hasAct2 = Array.from(currentSceneIds).some(sid => act2Scenes.has(sid as number));
        let totalScenes = currentSceneIds.size;

        let attempts = 0;
        while ((totalScenes < 3 || !hasAct1 || !hasAct2) && attempts < 10) {
            attempts++;
            let bestRole = null;
            if (!hasPrimaryRole) {
                bestRole = newRoles.find((r: any) => ['Lead', 'Supporting', 'Featured'].includes(r.type) && r.selectedActorIds.length === 0 && r.sceneIds.length > 0 && !r.selectedActorIds.includes(actor.id));
            }
            if (!bestRole) {
                const ensembleOptions = newRoles.filter((r: any) => r.type === 'Ensemble' && !r.selectedActorIds.includes(actor.id) && r.sceneIds.length > 0);
                ensembleOptions.sort((a: any, b: any) => a.selectedActorIds.length - b.selectedActorIds.length);
                bestRole = ensembleOptions.find((r: any) => {
                    const roleHasAct1 = r.sceneIds.some((sid: number) => act1Scenes.has(sid));
                    const roleHasAct2 = r.sceneIds.some((sid: number) => act2Scenes.has(sid));
                    if (!hasAct1 && roleHasAct1) return true;
                    if (!hasAct2 && roleHasAct2) return true;
                    if (totalScenes < 3) return true;
                    return false;
                });
            }
            if (bestRole) {
                bestRole.selectedActorIds.push(actor.id);
                if (!bestRole.actors.find((a: any) => a.id === actor.id)) bestRole.actors.push(actor);
                if(['Lead', 'Supporting', 'Featured'].includes(bestRole.type)) {
                    if (!updatesToSave.includes(bestRole)) updatesToSave.push(bestRole);
                    break; 
                }
                bestRole.sceneIds.forEach((sid: number) => {
                    if (act1Scenes.has(sid)) hasAct1 = true;
                    if (act2Scenes.has(sid)) hasAct2 = true;
                    currentSceneIds.add(sid);
                });
                totalScenes = currentSceneIds.size;
                if (!updatesToSave.includes(bestRole)) updatesToSave.push(bestRole);
            } else {
                break; 
            }
        }
    });
    // --- ALGORITHM END ---

    setRoles(newRoles);

    // --- CALCULATE TOTAL OPERATIONS ---
    let totalOps = 0;
    updatesToSave.forEach(r => totalOps += r.selectedActorIds.length);
    
    setProgress({ current: 0, total: totalOps, message: "Starting Database Sync..." });

    try {
        let opCount = 0;
        for (const role of updatesToSave) {
            const personIds = role.selectedActorIds.map((auditionId: number) => {
                const a = actors.find(act => act.id === auditionId);
                return a ? a.personId : null;
            }).filter(Boolean);

            // Visual Update
            await updateRole(role.id, { "Assigned Actor": personIds });

            // Database Creation (Sequential Loop)
            for (const personId of personIds) {
                 opCount++;
                 setProgress(prev => ({ 
                     ...prev, 
                     current: opCount, 
                     message: `Assigning ${role.name} (${opCount}/${totalOps})` 
                 }));
                 
                 await createCastAssignment(personId, role.id, productionId);
            }
        }
        
        setProgress(prev => ({ ...prev, message: "Done! Reloading..." }));
        setTimeout(() => window.location.reload(), 1000);

    } catch (e) {
        console.error("Auto-cast partial failure", e);
        alert("Some saves failed. Check audit.");
        setIsAutoCasting(false);
    }
  };


  // ---  CLEAR CAST (Nuclear) ---
  const handleClearCast = async () => {
      const mode = prompt("Type 'ENSEMBLE' to clear only ensemble.\nType 'ALL' to wipe EVERYTHING.\n\n(Deletes DB records)");
      if (!mode) return;
      const cleanMode = mode.toUpperCase();
      if (cleanMode !== 'ENSEMBLE' && cleanMode !== 'ALL') return;

      setIsClearing(true);
      
      // Calculate what to delete using the raw assignment rows we fetched on load
      const rowsToDelete = allAssignments.filter((assignmentRow: any) => {
          const roleId = assignmentRow["Performance Identity"]?.[0]?.id;
          const roleDef = roles.find(r => r.id === roleId);
          
          // Safety: If we can't find the role definition, leave it alone (or delete if ALL)
          if (!roleDef) return cleanMode === 'ALL';

          if (cleanMode === 'ALL') return true;
          if (cleanMode === 'ENSEMBLE') return roleDef.type !== 'Lead'; 
          return false;
      });

      // Init Progress
      setProgress({ current: 0, total: rowsToDelete.length, message: "Initializing Deletion..." });

      try {
          let count = 0;
          for (const row of rowsToDelete) {
              count++;
              setProgress({ 
                  current: count, 
                  total: rowsToDelete.length, 
                  message: `Deleting Assignment ${count}/${rowsToDelete.length}...` 
              });
              
              await deleteRow(Number(TABLES.ASSIGNMENTS), row.id);
          }

          setProgress(prev => ({ ...prev, message: "Deletion Complete. Reloading..." }));
          setTimeout(() => window.location.reload(), 500);

      } catch (e) {
          console.error("Clear cast failure", e);
          alert("Failed to delete some rows.");
          setIsClearing(false);
      }
  };


  // --- EVENT HANDLERS ---
  const handleDropActor = (e: React.DragEvent, roleId: string) => {
    e.preventDefault();
    const actorId = parseInt(e.dataTransfer.getData("actorId"));
    if (!actorId) return;
    const actor = actors.find(a => a.id === actorId);
    if (!actor) return;
    setRoles(prev => prev.map(role => {
        if (role.id.toString() !== roleId.toString()) return role;
        if (role.actors.find((a: any) => a.id === actor.id)) return role;
        return { ...role, actors: [...role.actors, actor] };
    }));
  };

  const handleRemoveActor = (roleId: string, actorId: number) => {
      setRoles(prev => prev.map(role => {
          if (role.id.toString() !== roleId.toString()) return role;
          return {
              ...role,
              actors: role.actors.filter((a: any) => a.id !== actorId),
              selectedActorIds: role.selectedActorIds.filter((id: number) => id !== actorId),
              selectedActorId: role.selectedActorId === actorId ? null : role.selectedActorId
          };
      }));
  };

  const handleConfirmRole = async (roleId: string, actorId: number) => {
      const role = roles.find(r => r.id.toString() === roleId.toString());
      if (!role) return;
      const actor = actors.find(a => a.id === actorId);
      if (!actor) return;
      const isSelecting = !role.selectedActorIds.includes(actorId);

      setRoles(prev => prev.map(r => {
          if (r.id.toString() !== roleId.toString()) return r;
          let newSelected = r.selectedActorIds;
          if (isSelecting) newSelected = [...newSelected, actorId]; 
          else newSelected = newSelected.filter((id: number) => id !== actorId);
          return { ...r, selectedActorIds: newSelected, selectedActorId: isSelecting ? actorId : null };
      }));

      try {
          const currentSelectedIds = isSelecting 
            ? [...role.selectedActorIds, actorId] 
            : role.selectedActorIds.filter((id: number) => id !== actorId);
          const personIds = currentSelectedIds.map((audId: any) => {
             const a = actors.find(act => act.id === audId);
             return a ? a.personId : null;
          }).filter(Boolean);
          
          await updateRole(parseInt(roleId), { "Assigned Actor": personIds });
          
          // Only create new row if adding. Deleting handled by Reset for now.
          if (isSelecting) await createCastAssignment(actor.personId, parseInt(roleId), productionId);
      } catch (err) { console.error(err); }
  };

  const handleToggleScene = async (roleId: string, sceneId: number) => {
      let newSceneIds: number[] = [];
      setRoles(prev => prev.map(r => {
          if (r.id.toString() !== roleId.toString()) return r;
          if (r.sceneIds.includes(sceneId)) {
              newSceneIds = r.sceneIds.filter((id: number) => id !== sceneId);
          } else {
              newSceneIds = [...r.sceneIds, sceneId];
          }
          return { ...r, sceneIds: newSceneIds };
      }));
      await updateRole(parseInt(roleId), { "Active Scenes": newSceneIds });
  };

  const handleRemoveRole = async (roleId: string) => { if(confirm("Remove this role?")) setRoles(prev => prev.filter(r => r.id.toString() !== roleId.toString())); };
  const handleDuplicateRole = async (roleId: string) => alert("Feature: Duplicate Role " + roleId);

  // --- INSPECTOR ---
  const inspectorActor = useMemo(() => (!inspectingActorId ? null : actors.find(a => a.id === inspectingActorId)), [inspectingActorId, actors]);
  const inspectorStats = useMemo(() => {
      const assignments: Record<number, string> = {};
      roles.forEach(role => {
          if (role.selectedActorIds.includes(inspectingActorId)) {
              role.sceneIds.forEach((sid: number) => {
                  assignments[sid] = assignments[sid] ? `${assignments[sid]} + ${role.name}` : role.name;
              });
          }
      });
      return { assignments, assignedRoleNames: roles.filter(r => r.selectedActorIds.includes(inspectingActorId)).map(r => r.name) };
  }, [roles, inspectingActorId]);


  if (loading) return <div className="h-screen bg-zinc-950 flex items-center justify-center text-white"><Loader2 className="animate-spin text-blue-500 mr-2"/> Loading {productionTitle}...</div>;

  return (
    <div className="h-screen flex flex-col bg-zinc-950 text-white overflow-hidden relative">
        
        {/* HEADER */}
        <header className="h-14 border-b border-white/10 flex items-center justify-between px-4 bg-zinc-900 shrink-0 z-30 relative">
            <div className="flex gap-4 items-center">
                 <div className="text-xs font-bold text-zinc-500 uppercase tracking-widest border-r border-zinc-700 pr-4 mr-1">
                    {productionTitle}
                 </div>
                 
                 <div className="flex bg-zinc-800 rounded-lg p-1 gap-1">
                    <button onClick={() => setViewMode('workspace')} className={`text-[10px] font-black uppercase px-3 py-1 rounded transition-all ${viewMode === 'workspace' ? 'bg-white text-black' : 'text-zinc-400 hover:text-white'}`}>Grid</button>
                    <button onClick={() => setViewMode('chemistry')} className={`text-[10px] font-black uppercase px-3 py-1 rounded transition-all ${viewMode === 'chemistry' ? 'bg-purple-600 text-white' : 'text-zinc-400 hover:text-white'}`}>Chemistry</button>
                 </div>

                 <div className="flex items-center gap-2 border-l border-zinc-700 pl-4 ml-1">
                     <button onClick={() => setShowAudit(true)} className="flex items-center gap-2 bg-zinc-800 text-zinc-300 border border-zinc-700 hover:bg-zinc-700 hover:text-white px-3 py-1.5 rounded text-[10px] font-black uppercase tracking-wider transition-all">
                        <ClipboardList size={14} /> Audit
                     </button>
                     <button onClick={handleAutoCast} disabled={isAutoCasting || isClearing} className="flex items-center gap-2 bg-emerald-600/20 text-emerald-400 border border-emerald-500/50 hover:bg-emerald-500 hover:text-white px-3 py-1.5 rounded text-[10px] font-black uppercase tracking-wider transition-all disabled:opacity-50">
                        {isAutoCasting ? <Loader2 size={14} className="animate-spin"/> : <Wand2 size={14} />} Quick Cast
                     </button>
                     <button onClick={handleClearCast} disabled={isAutoCasting || isClearing} className="flex items-center gap-2 bg-red-600/10 text-red-400 border border-red-500/30 hover:bg-red-500 hover:text-white px-3 py-1.5 rounded text-[10px] font-black uppercase tracking-wider transition-all disabled:opacity-50">
                        {isClearing ? <Loader2 size={14} className="animate-spin"/> : <RotateCcw size={14} />} Reset
                     </button>
                 </div>
            </div>

            {/* EXPANDABLE DRAWER TRIGGER */}
            <div className="flex items-center gap-4 h-full">
                <div className="flex items-center gap-2 h-full cursor-pointer hover:bg-white/5 px-2 rounded transition-colors" onClick={() => setDrawerExpanded(!drawerExpanded)}>
                    <span className="text-[9px] font-bold text-zinc-600 uppercase">Cast Drawer</span>
                    {drawerExpanded ? <ChevronUp size={14} className="text-zinc-400"/> : <ChevronDown size={14} className="text-zinc-400"/>}
                </div>
                
                {/* PREVIEW STRIP */}
                {!drawerExpanded && (
                    <div className="flex items-center gap-2 overflow-x-auto max-w-[20vw] no-scrollbar mask-linear-fade-left">
                        {actors.map(actor => {
                            const isAssigned = roles.some(r => r.selectedActorIds.includes(actor.id));
                            const stats = getActorStats(actor.id);
                            const hasWarning = isAssigned && !stats.isCompliant;
                            return (
                                <div key={actor.id} className={`w-8 h-8 rounded-full border shrink-0 overflow-hidden relative ${hasWarning ? 'border-red-500' : isAssigned ? 'border-emerald-500 opacity-50' : 'border-white/10'}`}>
                                    <img src={actor.Headshot || "https://placehold.co/100x100/333/999?text=?"} className="w-full h-full object-cover" />
                                </div>
                            )
                        })}
                    </div>
                )}
            </div>
        </header>

        {/* PROGRESS OVERLAY */}
        {(isAutoCasting || isClearing) && (
            <div className="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-8">
                <div className="bg-zinc-900 border border-white/10 p-8 rounded-2xl w-full max-w-md text-center shadow-2xl">
                    <div className="flex justify-center mb-6">
                        {isClearing ? <RotateCcw size={48} className="text-red-500 animate-pulse"/> : <Wand2 size={48} className="text-emerald-500 animate-bounce"/>}
                    </div>
                    <h2 className="text-2xl font-black uppercase italic text-white mb-2">{isClearing ? "Clearing Database..." : "Casting Magic..."}</h2>
                    <p className="text-sm text-zinc-400 font-mono mb-6">{progress.message}</p>
                    
                    <div className="h-4 bg-zinc-800 rounded-full overflow-hidden border border-white/5 relative">
                        <div 
                            className={`h-full transition-all duration-300 ease-out ${isClearing ? 'bg-red-600' : 'bg-emerald-500'}`}
                            style={{ width: `${(progress.current / (progress.total || 1)) * 100}%` }}
                        />
                    </div>
                    <div className="flex justify-between text-[10px] font-bold text-zinc-500 mt-2 uppercase tracking-widest">
                        <span>{progress.current} Rows</span>
                        <span>{progress.total} Total</span>
                    </div>
                </div>
            </div>
        )}

        {/* EXPANDED DRAWER */}
        {drawerExpanded && (
            <div className="absolute top-14 left-0 right-0 bottom-0 bg-zinc-950/95 backdrop-blur-xl z-40 p-8 overflow-y-auto border-t border-white/10" onClick={() => setDrawerExpanded(false)}>
                <div className="max-w-7xl mx-auto" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-end mb-6 border-b border-white/10 pb-4">
                        <h2 className="text-3xl font-black uppercase italic tracking-tighter text-white flex items-center gap-3">
                            <Users size={32} className="text-zinc-600"/> Cast Pool
                        </h2>
                        <button onClick={() => setDrawerExpanded(false)} className="text-zinc-500 hover:text-white flex items-center gap-2 text-xs font-bold uppercase"><X size={16}/> Close Drawer</button>
                    </div>
                    
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4">
                        {actors.map(actor => {
                            const isAssigned = roles.some(r => r.selectedActorIds.includes(actor.id));
                            const stats = getActorStats(actor.id);
                            const hasWarning = isAssigned && !stats.isCompliant;

                            return (
                                <div 
                                    key={actor.id}
                                    draggable
                                    onDragStart={(e) => { e.dataTransfer.setData("actorId", actor.id.toString()); setDrawerExpanded(false); }} 
                                    onClick={() => setInspectingActorId(actor.id)}
                                    className={`relative bg-zinc-900 border rounded-xl p-3 hover:bg-zinc-800 transition-all cursor-grab active:cursor-grabbing group 
                                        ${hasWarning ? 'border-red-500/50 hover:border-red-500' : isAssigned ? 'border-emerald-500/30' : 'border-white/5 hover:border-white/20'}
                                    `}
                                >
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="w-10 h-10 rounded-full overflow-hidden shrink-0 bg-zinc-950 border border-white/10">
                                            <img src={actor.Headshot || "https://placehold.co/100x100/333/999?text=?"} className="w-full h-full object-cover" />
                                        </div>
                                        <div className="min-w-0">
                                            <p className="text-xs font-bold text-white truncate">{actor.Performer}</p>
                                            <p className="text-[10px] text-zinc-500 font-mono">ID: {actor.id}</p>
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-1 flex-wrap">
                                        <span className={`text-[9px] font-black uppercase px-1.5 py-0.5 rounded border ${isAssigned ? 'bg-zinc-800 text-zinc-300 border-zinc-700' : 'bg-red-900/10 text-red-400 border-red-900/20'}`}>
                                            {isAssigned ? `${stats.roleCount} Roles` : 'Uncast'}
                                        </span>
                                        {hasWarning && <span className="text-[9px] font-black uppercase px-1.5 py-0.5 rounded bg-red-500 text-white flex items-center gap-1"><AlertCircle size={8}/> Needs Scenes</span>}
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            </div>
        )}

        {/* WORKSPACE */}
        <div className="flex-1 overflow-hidden relative flex">
            <div className="flex-1 relative z-0 h-full">
                {viewMode === 'workspace' ? (
                    <CastWorkspace roles={roles} scenes={scenes} onAddRole={() => {}} onRemoveRole={handleRemoveRole} onDuplicateRole={handleDuplicateRole} onDropActor={handleDropActor} onRemoveActor={handleRemoveActor} onToggleScene={handleToggleScene} onSelectRole={() => {}} onConfirmRole={(rId, aId) => handleConfirmRole(rId, aId)} />
                ) : (
                    <ChemistryWorkspace roles={roles} onDropActor={handleDropActor} onRemoveActor={handleRemoveActor} onSelectRole={() => {}} onConfirmRole={(rId, aId) => handleConfirmRole(rId, aId)} />
                )}
            </div>
            {inspectingActorId && <CastingInspector actor={inspectorActor} allScenes={scenes} stats={inspectorStats} onClose={() => setInspectingActorId(null)} />}
        </div>

        {/* AUDIT MODAL */}
        {showAudit && (
            <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-8" onClick={() => setShowAudit(false)}>
                <div className="bg-zinc-900 border border-white/10 rounded-2xl w-full max-w-4xl max-h-[80vh] flex flex-col shadow-2xl" onClick={e => e.stopPropagation()}>
                    <div className="p-6 border-b border-white/10 flex justify-between items-center bg-zinc-900 rounded-t-2xl">
                        <div>
                            <h2 className="text-xl font-black uppercase italic text-white flex items-center gap-2"><ClipboardList size={20}/> Casting Audit</h2>
                            <p className="text-xs text-zinc-500 mt-1">Rules: Min 3 Scenes  Must have Act 1  Must have Act 2</p>
                        </div>
                        <button onClick={() => setShowAudit(false)}><X className="text-zinc-500 hover:text-white"/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-0">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-zinc-950 text-zinc-500 uppercase text-[10px] font-bold tracking-wider sticky top-0 z-10">
                                <tr>
                                    <th className="px-6 py-3">Actor</th>
                                    <th className="px-6 py-3 text-center">Roles</th>
                                    <th className="px-6 py-3 text-center">Scenes (3+)</th>
                                    <th className="px-6 py-3 text-center">Act 1</th>
                                    <th className="px-6 py-3 text-center">Act 2</th>
                                    <th className="px-6 py-3 text-right">Status</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-white/5">
                                {actors.map(actor => {
                                    const stats = getActorStats(actor.id);
                                    if(stats.roleCount === 0) return null;
                                    return (
                                        <tr key={actor.id} className="hover:bg-white/5">
                                            <td className="px-6 py-3 font-bold text-white flex items-center gap-3">
                                                <img src={actor.Headshot || "https://placehold.co/100x100/333/999?text=?"} className="w-8 h-8 rounded-full object-cover" />
                                                {actor.Performer}
                                            </td>
                                            <td className="px-6 py-3 text-center font-mono text-zinc-400">{stats.roleCount}</td>
                                            <td className={`px-6 py-3 text-center font-black ${stats.count >= 3 ? 'text-emerald-500' : 'text-red-500'}`}>{stats.count}</td>
                                            <td className="px-6 py-3 text-center">{stats.hasAct1 ? <Check size={16} className="mx-auto text-emerald-500"/> : <X size={16} className="mx-auto text-red-500 opacity-50"/>}</td>
                                            <td className="px-6 py-3 text-center">{stats.hasAct2 ? <Check size={16} className="mx-auto text-emerald-500"/> : <X size={16} className="mx-auto text-red-500 opacity-50"/>}</td>
                                            <td className="px-6 py-3 text-right">
                                                {stats.isCompliant ? 
                                                    <span className="inline-flex items-center gap-1 bg-emerald-500/10 text-emerald-500 px-2 py-1 rounded text-[10px] font-black uppercase tracking-wider">Pass</span> : 
                                                    <span className="inline-flex items-center gap-1 bg-red-500/10 text-red-500 px-2 py-1 rounded text-[10px] font-black uppercase tracking-wider"><AlertCircle size={12}/> Fail</span>
                                                }
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        )}
    </div>
  );
}
</file>

</files>
