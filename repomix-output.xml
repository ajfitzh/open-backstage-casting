This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: **/*.lock, **/.next/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
app/(casting)/auditions/page.tsx
app/(casting)/callbacks/page.tsx
app/(casting)/casting/page.tsx
app/(casting)/layout.tsx
app/(staff)/committees/page.tsx
app/(staff)/layout.tsx
app/api/upload/route.ts
app/components/ActorProfileModal.tsx
app/components/casting/CastingInspector.tsx
app/components/casting/CastWorkspace.tsx
app/components/casting/ChemistryWorkspace.tsx
app/components/ChoreoWorkspace.tsx
app/components/GlobalHeader.tsx
app/components/Sidebar.tsx
app/components/StaffSidebar.tsx
app/favicon.ico
app/globals.css
app/layout.tsx
app/lib/baserow.ts
app/lib/CastingContext.tsx
app/login/page.tsx
app/page.tsx
app/plan.md
app/test-sync/page.tsx
eslint.config.mjs
lib/CastingContext.tsx
lib/PeopleContext.tsx
lib/types.ts
LICENSE
middleware.ts
next.config.ts
package.json
postcss.config.mjs
public/file.svg
public/globe.svg
public/next.svg
public/vercel.svg
public/window.svg
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="lib/PeopleContext.tsx">
"use client";
import React, { createContext, useContext, useMemo } from 'react';
import { Performer } from './types';

interface PeopleContextType {
  people: Performer[];
  getName: (id: number) => string;
}

const PeopleContext = createContext<PeopleContextType | undefined>(undefined);

export function PeopleProvider({
  children,
  people,
}: {
  children: React.ReactNode;
  people: Performer[];
}) {
  // Create a map for faster lookups (O(1) access)
  const peopleMap = useMemo(() => {
    const map = new Map<number, Performer>();
    people.forEach((p) => map.set(p.id, p));
    return map;
  }, [people]);

  const getName = (id: number) => {
    return peopleMap.get(id)?.name ?? 'Unknown';
  };

  return (
    <PeopleContext.Provider value={{ people, getName }}>
      {children}
    </PeopleContext.Provider>
  );
}

export function usePeople() {
  const context = useContext(PeopleContext);
  if (context === undefined) {
    throw new Error('usePeople must be used within a PeopleProvider');
  }
  return context;
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="app/(casting)/auditions/page.tsx">
/* eslint-disable react-hooks/rules-of-hooks */
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";
// NOTE: We switched getAuditionSlots to getAuditionees to fix the name issue
import { getAuditionees, updateAuditionSlot, submitAudition } from "@/app/lib/baserow";
import React, { useState, useEffect, useMemo } from "react";
import {
  User, Star, Music, Move, X, Save, Clock, CheckCircle2, 
  MessageSquare, Search, UserPlus, PlayCircle, Film
} from "lucide-react";
import ActorProfileModal from "@/app/components/ActorProfileModal";
import ChoreoWorkspace from "@/app/components/ChoreoWorkspace";

const TARGET_PRODUCTION_STRING = "The Little Mermaid, Jr. - Spring - 2025-2026";

/* =====================
   Types & Config
===================== */
type AuditionSession = "Thursday" | "Friday" | "Video/Remote" | "Walk-In";
type JudgeRole = "Director" | "Music" | "Choreographer" | "Drop-In" | "Admin";

const ROLE_THEMES: Record<JudgeRole, { color: string; text: string; glow: string; weight: string }> = {
  Director: { color: "border-blue-500", text: "text-blue-400", glow: "shadow-blue-500/20", weight: "Acting 60% | Vocal 20% | Dance 20%" },
  Music: { color: "border-purple-500", text: "text-purple-400", glow: "shadow-purple-500/20", weight: "Vocal 80% | Acting 20%" },
  Choreographer: { color: "border-emerald-500", text: "text-emerald-400", glow: "shadow-emerald-500/20", weight: "Dance 80% | Presence 20%" },
  "Drop-In": { color: "border-amber-500", text: "text-amber-400", glow: "shadow-amber-500/20", weight: "Impression Only" },
  Admin: { color: "border-zinc-100", text: "text-zinc-100", glow: "shadow-white/5", weight: "Full Access" },
};

// --- HELPER COMPONENT: RUBRIC SLIDER ---
const RubricSlider = ({ label, val, setVal, disabled }: { label: string, val: number, setVal: (n: number) => void, disabled: boolean }) => (
  <div className={`space-y-3 ${disabled ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
    <div className="flex justify-between items-end">
      <label className="text-xs font-black uppercase tracking-widest text-zinc-400 flex items-center gap-2">
        {label === "Vocal Ability" && <Music size={14} className="text-purple-500" />}
        {label === "Acting / Reads" && <Star size={14} className="text-blue-500" />}
        {label === "Dance / Movement" && <Move size={14} className="text-emerald-500" />}
        {label}
      </label>
      <span className={`text-xl font-black ${val > 0 ? 'text-white' : 'text-zinc-700'}`}>{val || "-"}</span>
    </div>
    <input 
      type="range" min="0" max="5" step="1" value={val} 
      onChange={(e) => setVal(Number(e.target.value))} 
      className="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-blue-500" 
    />
    <div className="flex justify-between text-[9px] font-bold uppercase text-zinc-600 px-1">
      <span>N/A</span>
      <span>Weak</span>
      <span>Fair</span>
      <span>Good</span>
      <span>Great</span>
      <span>Exc.</span>
    </div>
  </div>
);

export default function AuditionsPage() {
  const [isMounted, setIsMounted] = useState(false); 
  
  // Judge State
  const [judgeName, setJudgeName] = useState("");
  const [judgeRole, setJudgeRole] = useState<JudgeRole | null>(null);
  const [isReady, setIsReady] = useState(false);

  // App State
  const [searchQuery, setSearchQuery] = useState("");
  const [activeSession, setActiveSession] = useState<AuditionSession>("Thursday");
  const [selectedPerson, setSelectedPerson] = useState<any | null>(null);
  const [inspectingActor, setInspectingActor] = useState<any | null>(null);

  // Data
  const [scheduledPerformers, setScheduledPerformers] = useState<any[]>([]);
  const [allStudents, setAllStudents] = useState<any[]>([]); 
  const [grades, setGrades] = useState<Record<number, any>>({});
  
  // Current Editing Score
  const [currentScores, setCurrentScores] = useState({
    vocal: 0, acting: 0, dance: 0, presence: 0, notes: "",
  });

  const reopenJudgeSetup = () => setIsReady(false);

  // Initial Load
  useEffect(() => {
    setIsMounted(true); 
    const savedName = localStorage.getItem("judgeName");
    const savedRole = localStorage.getItem("judgeRole") as JudgeRole | null;
    if (savedName && savedRole) {
      setJudgeName(savedName);
      setJudgeRole(savedRole);
      setIsReady(true);
    }
  }, []);

/* ---------- Data Fetching ---------- */
  useEffect(() => {
    const loadData = async () => {
      if (!isReady) return;
      
      console.log("ðŸš€ Starting Data Load...");
      
      try {
        // 1. Fetch raw data
        const slots = await getAuditionees();
        console.log(`ðŸ“¦ Raw Auditions Fetched: ${slots.length}`, slots[0]); // Log first item to see structure

        const activeShowId = localStorage.getItem('activeShowId'); 
        console.log(`ðŸŽ­ Active Show ID from Storage:`, activeShowId);

        // 2. Filter with Logging
        const showAuditions = slots.filter((row: any) => {
          const prodArray = row.Production || [];
          
          // Debugging specific rows
          if (!prodArray.length) {
             console.warn(`âš ï¸ Row ${row.id} has no Production linked.`);
             return false;
          }

          // CHECK 1: Local Storage Match (Most Reliable)
          // We check equality loosely (==) to catch string "5" vs number 5
          if (activeShowId && prodArray.some((p: any) => p.id == activeShowId)) {
              return true;
          }

          // CHECK 2: Fallback String Match
          const prodName = (prodArray[0]?.value || "").toString().toLowerCase();
          const isMermaid = prodName.includes("mermaid");
          
          // CHECK 3: Safety Net - If the "Value" is just a number (e.g. "5"), assume it's the right show for now 
          // (REMOVE THIS later once you fix the Primary Field in Baserow)
          const isJustID = !isNaN(Number(prodName)); 

          // Log failures to help you debug
          if (!isMermaid && !isJustID) {
              console.log(`âŒ Row ${row.id} skipped. Prod Value: "${prodName}"`);
          }

          return isMermaid || isJustID; 
        });

        console.log(`âœ… Filtered down to ${showAuditions.length} actors for this show.`);

        // ... (Rest of your formatting logic remains the same) ...
        
        // Helper to extract baserow values
        const getLookupValue = (field: any) => {
          if (!field) return null;
          if (Array.isArray(field)) return field[0]?.value || field[0];
          return field?.value || field;
        };

        const formatHeight = (val: any) => {
          if (!val) return "N/A";
          if (String(val).includes("'")) return val; 
          const num = Number(val);
          if (isNaN(num)) return val;
          return `${Math.floor(num / 12)}'${num % 12}"`;
        };

        const getExperienceLabel = (field: any) => {
          let count = 0;
          let roleList = "";
          if (field) {
            if (Array.isArray(field)) {
               count = field.length;
               roleList = field.map((item: any) => typeof item === 'object' ? item.value : item).join(", ");
            } else if (typeof field === 'string') {
               const split = field.split(',');
               count = split.length;
               roleList = field;
            }
          }
          return { label: count > 0 ? `Shows: ${count}` : "First Show", list: roleList };
        };

        const formattedSchedule = showAuditions.map((row: any) => {
           // ... (Keep your existing mapping logic here) ...
           const rawDate = row.Date;
           let displayTime = "TBD";
           let session: AuditionSession = "Video/Remote";

           if (rawDate) {
             const dateObj = new Date(rawDate);
             const dayOfWeek = dateObj.getDay(); 
             if (dayOfWeek === 4) session = "Thursday";
             else if (dayOfWeek === 5) session = "Friday";
             displayTime = dateObj.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
           }
           
           let videoUrl = null;
           if (row["Dance Video"]) {
               videoUrl = row["Dance Video"];
           } 
           if (!videoUrl) {
               const rawVideo = row["Audition Video"]; 
               if (Array.isArray(rawVideo) && rawVideo.length > 0) videoUrl = rawVideo[0].url;
               else if (typeof rawVideo === 'string' && rawVideo.startsWith('http')) videoUrl = rawVideo;
           }

           let headshotUrl = null;
           const rawHeadshot = row.Headshot;
           if (Array.isArray(rawHeadshot) && rawHeadshot.length > 0) headshotUrl = rawHeadshot[0].url;
           else if (row.Headshot?.url) headshotUrl = row.Headshot.url;

           const experienceData = getExperienceLabel(row["Past Roles"] || row["Past Productions"]);

           return {
             id: row.id,
             originalId: row.id, // Ensure this exists for saving
             performerId: row.Performer?.[0]?.id,
             name: Array.isArray(row.Performer) ? row.Performer[0]?.value : (row.Performer || "Unknown"),
             avatar: headshotUrl,
             age: String(getLookupValue(row.Age) || "?"),
             video: videoUrl,
             height: formatHeight(getLookupValue(row.Height)),
             vocalRange: getLookupValue(row["Vocal Range"]),
             dob: getLookupValue(row.Birthdate),
             conflicts: getLookupValue(row.Conflicts),
             tenure: experienceData.label,
             pastRoles: experienceData.list,
             song: row.Song || "No song listed",
             monologue: row.Monologue || "No monologue listed",
             timeSlot: displayTime,
             session: session,
             vocal: row["Vocal Score"] || 0,
             acting: row["Acting Score"] || 0,
             dance: row["Dance Score"] || 0,
             presence: row["Stage Presence Score"] || 0,
             actingNotes: row["Acting Notes"] || "",
             musicNotes: row["Music Notes"] || "",
             choreoNotes: row["Choreography Notes"] || "",
             dropInNotes: row["Drop-In Notes"] || "",
             adminNotes: row["Admin Notes"] || "",
             isWalkIn: false
           };
        });

        setScheduledPerformers(formattedSchedule);

        const initialGrades: Record<number, any> = {};
        formattedSchedule.forEach(p => {
          if (p.vocal > 0 || p.dance > 0 || p.acting > 0 || p.video) initialGrades[p.id] = p;
        });
        setGrades(initialGrades);

        // For Walk-Ins
        setAllStudents(slots);

      } catch (err) {
        console.error("âŒ CRITICAL LOAD ERROR:", err);
      }
    };

    loadData();
  }, [isReady]);
const handleChoreoSave = (actorId: number, score: number, notes: string, videoUrl?: string) => {
    const isDelete = videoUrl === "DELETE";

    setGrades(prev => ({
        ...prev,
        [actorId]: {
            ...prev[actorId],
            dance: score,
            choreoNotes: notes,
            video: isDelete ? null : (videoUrl || prev[actorId]?.video)
        }
    }));

    const payload: any = {
        "Dance Score": score > 0 ? score : null, 
        "Choreography Notes": notes
    };
    
    if (isDelete) {
        payload["Dance Video"] = ""; 
    } else if (videoUrl) {
        payload["Dance Video"] = videoUrl; 
    }
    
    updateAuditionSlot(actorId, payload).catch(err => console.error("Auto-save failed", err));
};

  /* ---------- STANDARD SAVE ACTION ---------- */
  const handleCommit = async () => {
    if (!selectedPerson) return;
    const activeShowId = localStorage.getItem('activeShowId');

    let noteField = "";
    switch (judgeRole) {
        case "Director": noteField = "actingNotes"; break; 
        case "Music": noteField = "musicNotes"; break;
        case "Choreographer": noteField = "choreoNotes"; break;
        case "Drop-In": noteField = "dropInNotes"; break;
        default: noteField = "adminNotes"; break;
    }

    setGrades((prev) => {
        const existingData = prev[selectedPerson.id] || {};
        return {
            ...prev,
            [selectedPerson.id]: {
                ...existingData,        
                ...currentScores,       
                [noteField]: currentScores.notes 
            }
        };
    });

    try {
      const payload: any = {
          "Vocal Score": currentScores.vocal > 0 ? currentScores.vocal : null,
          "Acting Score": currentScores.acting > 0 ? currentScores.acting : null,
          "Dance Score": currentScores.dance > 0 ? currentScores.dance : null,
          "Stage Presence Score": currentScores.presence > 0 ? currentScores.presence : null,
      };

      switch (judgeRole) {
          case "Director": payload["Acting Notes"] = currentScores.notes; break;
          case "Music": payload["Music Notes"] = currentScores.notes; break;
          case "Choreographer": payload["Choreography Notes"] = currentScores.notes; break;
          case "Drop-In": payload["Drop-In Notes"] = currentScores.notes; break;
          case "Admin": payload["Admin Notes"] = currentScores.notes; break;
      }

      if (selectedPerson.isWalkIn) {
        const productionId = Number(activeShowId) || 94; 
        await submitAudition(selectedPerson.originalId, productionId, payload);
        alert("Walk-In Created!");
      } else {
        await updateAuditionSlot(selectedPerson.id, payload);
      }
      setSelectedPerson(null);
    } catch (err) {
      console.error(err);
      alert("Save failed! Check connection.");
    }
  };

  /* ---------- Logic: Grouping & Scoring ---------- */
  const calculateWeightedScore = (scores: any) => {
    if (!judgeRole) return 0;
    const s = {
      vocal: Number(scores.vocal) || 0,
      acting: Number(scores.acting) || 0,
      dance: Number(scores.dance) || 0,
      presence: Number(scores.presence) || 0,
    };
    switch(judgeRole) {
      case "Director": return (s.acting * 0.7) + (s.vocal * 0.3); 
      case "Music": return (s.vocal * 0.8) + (s.acting * 0.2);
      case "Choreographer": return (s.dance * 0.8) + (s.presence * 0.2);
      default: return (s.vocal + s.acting + s.dance + s.presence) / 4;
    }
  };

  const visibleList = useMemo(() => {
    if (activeSession === "Walk-In") {
      if (!searchQuery) return [];
      return allStudents
        .filter(s => s["Full Name"]?.toLowerCase().includes(searchQuery.toLowerCase()))
        .map(s => ({
          id: `walkin-${s.id}`, originalId: s.id, name: s["Full Name"],
          avatar: s.Headshot?.[0]?.url || null, age: s.Age,
          timeSlot: "WALK-IN", session: "Walk-In", isWalkIn: true,
          vocal: 0, acting: 0, dance: 0, presence: 0, notes: "" 
        }));
    }
    return scheduledPerformers.filter((p) => {
        const matchesSession = p.session === activeSession;
        const matchesSearch = searchQuery ? p.name.toLowerCase().includes(searchQuery.toLowerCase()) : true;
        return matchesSession && matchesSearch;
    });
  }, [scheduledPerformers, allStudents, activeSession, searchQuery]);

  const grouped = useMemo(() => {
    if (activeSession === "Walk-In") return { "Walk-In Results": visibleList };
    const groups: Record<string, any[]> = {};
    visibleList.forEach((p) => {
      if (!groups[p.timeSlot]) groups[p.timeSlot] = [];
      groups[p.timeSlot].push(p);
    });
    return Object.keys(groups).sort().reduce((acc, key) => { acc[key] = groups[key]; return acc; }, {} as Record<string, any[]>);
  }, [visibleList, activeSession]);


 return (
  <>
    {/* --- JUDGE SETUP MODAL --- */}
    {!isReady && (
      <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-xl flex items-center justify-center p-4">
        <div className="w-full max-w-[420px] bg-zinc-950 border border-white/10 rounded-2xl p-6 md:p-8 space-y-6 shadow-2xl">
          <h2 className="text-2xl font-black uppercase tracking-tight">Judge Setup</h2>
          <div>
            <label className="block text-[10px] font-bold uppercase text-zinc-500 mb-1">Judge Name</label>
            <input value={judgeName} onChange={(e) => setJudgeName(e.target.value)} className="w-full bg-zinc-900 border border-white/10 rounded-lg p-3 text-sm focus:border-blue-500 outline-none transition-all" placeholder="Enter your name" />
          </div>
          <div>
            <label className="block text-[10px] font-bold uppercase text-zinc-500 mb-2">Judge Role</label>
            <div className="grid grid-cols-2 gap-2">
              {(Object.keys(ROLE_THEMES) as JudgeRole[]).map((role) => (
                <button key={role} onClick={() => setJudgeRole(role)} className={`p-3 rounded-lg border text-xs font-black uppercase transition-all ${judgeRole === role ? "bg-white text-black border-white shadow-lg" : "bg-zinc-900 border-zinc-800 text-zinc-400 hover:border-zinc-600"}`}>{role}</button>
              ))}
            </div>
          </div>
          <div className="flex gap-3 pt-2">
            {isMounted && localStorage.getItem("judgeName") && (
              <button onClick={() => setIsReady(true)} className="px-6 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-xl font-bold uppercase text-[10px] tracking-widest transition-colors">Cancel</button>
            )}
            <button disabled={!judgeName || !judgeRole} onClick={() => { localStorage.setItem("judgeName", judgeName); localStorage.setItem("judgeRole", judgeRole!); setIsReady(true); }} className="flex-1 bg-blue-600 hover:bg-blue-500 disabled:bg-zinc-800 disabled:text-zinc-500 py-4 rounded-xl font-black uppercase tracking-widest transition-colors shadow-lg shadow-blue-900/20">{isMounted && localStorage.getItem("judgeName") ? "Update Profile" : "Start Judging"}</button>
          </div>
        </div>
      </div>
    )}

    {/* --- CONDITIONAL VIEW --- */}
    {isReady && judgeRole === 'Choreographer' ? (
      // === CHOREOGRAPHER WORKSPACE ===
      <div className="h-screen bg-black flex flex-col">
          <div className="h-14 bg-zinc-900 border-b border-white/5 flex items-center justify-between px-4 shrink-0">
               <button onClick={reopenJudgeSetup} className="text-[10px] font-black uppercase text-zinc-500 hover:text-white transition-colors">
                   Exit Dance Mode
               </button>
               <div className="flex gap-2">
                    {(["Thursday", "Friday", "Walk-In"] as const).map((s) => (
                      <button
                        key={s}
                        onClick={() => setActiveSession(s)}
                        className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase transition-all ${
                          activeSession === s ? "bg-white text-black" : "bg-zinc-800 text-zinc-500"
                        }`}
                      >
                        {s}
                      </button>
                    ))}
               </div>
          </div>
          
          <div className="flex-1 overflow-hidden">
              <ChoreoWorkspace 
                  people={visibleList} 
                  initialGrades={grades} 
                  onSave={handleChoreoSave} 
              />
          </div>
      </div>
    ) : (
      // === STANDARD AUDITION DECK (MOBILE OPTIMIZED) ===
      isReady && (
      <div className={`flex h-full bg-black text-white shadow-[0_0_50px_-12px_rgba(255,255,255,0.1)]`}>
        <div className="flex-1 flex flex-col min-w-0">
          
          {/* HEADER */}
          <header className={`p-4 md:p-6 border-b-2 bg-zinc-950 ${ROLE_THEMES[judgeRole!].color} shrink-0`}>
            <div className="flex flex-col md:flex-row justify-between md:items-center gap-4">
              <button onClick={reopenJudgeSetup} className="text-left group shrink-0">
                <h1 className="text-xl md:text-2xl font-black italic uppercase">Audition Deck</h1>
                <div className="flex items-center gap-2">
                    <p className="text-[9px] uppercase text-zinc-500">{judgeName} â€¢ {judgeRole}</p>
                    <span 
                        onClick={(e) => {
                            e.stopPropagation();
                            if(confirm("Reload active production data?")) {
                                localStorage.removeItem('activeShowId'); 
                                window.location.href = "/"; 
                            }
                        }}
                        className="text-[9px] text-blue-900 group-hover:text-blue-500 cursor-pointer transition-colors"
                    >
                        (Switch Show)
                    </span>
                </div>
              </button>

              {/* SCROLLABLE TABS */}
              <div className="flex gap-2 overflow-x-auto pb-2 md:pb-0 w-full md:w-auto no-scrollbar mask-linear-fade">
                {(["Thursday", "Friday", "Video/Remote", "Walk-In"] as const).map((s) => (
                  <button key={s} onClick={() => { setActiveSession(s); setSearchQuery(""); }} className={`px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-colors whitespace-nowrap border border-transparent ${activeSession === s ? "bg-white text-black" : "bg-zinc-900 text-zinc-500 hover:text-zinc-300 border-white/5"}`}>
                    {s === "Walk-In" ? <span className="flex items-center gap-1"><UserPlus size={12}/> Walk-In</span> : s}
                  </button>
                ))}
              </div>
            </div>

            <div className="mt-4 relative w-full md:w-64">
              <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-600" />
              <input value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full bg-zinc-900 rounded-lg py-2 pl-10 text-xs focus:ring-1 ring-white/10 outline-none text-white" placeholder={activeSession === "Walk-In" ? "Type student name..." : "Find in schedule..."} autoFocus={activeSession === "Walk-In"} />
            </div>
          </header>

          {/* LIST AREA */}
          <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
            {activeSession === "Walk-In" && visibleList.length === 0 && (
              <div className="text-center text-zinc-500 mt-20"><UserPlus size={48} className="mx-auto mb-4 opacity-20" /><p className="text-sm">Start typing to find a student...</p></div>
            )}

            {Object.entries(grouped).map(([time, people]) => (
              <div key={time}>
                {activeSession !== "Walk-In" && <h3 className="text-xs uppercase text-blue-500 mb-2 flex items-center gap-1 sticky top-0 bg-black/90 backdrop-blur py-2 z-10"><Clock size={12} /> {time}</h3>}
                {people.map((person) => (
                  <div key={person.id} className="flex gap-2 mb-3 group">
                      <button
                        onClick={() => {
                          setSelectedPerson(person);
                          const saved = grades[person.id] || {};
                          let loadedNote = "";
                          if (saved.notes) {
                              loadedNote = saved.notes;
                          } else {
                              switch(judgeRole) {
                                  case "Director": loadedNote = person.actingNotes; break;
                                  case "Music": loadedNote = person.musicNotes; break;
                                  case "Choreographer": loadedNote = person.choreoNotes; break;
                                  case "Drop-In": loadedNote = person.dropInNotes; break;
                                  case "Admin": loadedNote = person.adminNotes; break;
                              }
                          }

                          setCurrentScores({
                              vocal: saved.vocal || person.vocal || 0,
                              acting: saved.acting || person.acting || 0,
                              dance: saved.dance || person.dance || 0,
                              presence: saved.presence || person.presence || 0,
                              notes: loadedNote || "", 
                          });
                        }}
                        className={`flex-1 flex items-center gap-3 md:gap-4 p-3 rounded-xl transition-all border min-w-0 ${selectedPerson?.id === person.id ? "bg-zinc-800 border-blue-500 ring-1 ring-blue-500" : "bg-zinc-900 border-white/5 hover:bg-zinc-800"}`}
                      >
                          <div className="relative flex-shrink-0">
                              {person.avatar ? <img src={person.avatar} className="w-10 h-10 md:w-12 md:h-12 rounded-full object-cover" alt="" /> : <div className="w-10 h-10 md:w-12 md:h-12 rounded-full bg-zinc-800 flex items-center justify-center"><User size={20} className="text-zinc-600"/></div>}
                              {grades[person.id] && !person.isWalkIn && <div className="absolute -top-1 -right-1 bg-black rounded-full"><CheckCircle2 size={14} className="text-emerald-500" /></div>}
                          </div>
                          <div className="text-left min-w-0 flex-1">
                              <p className="font-bold text-sm flex items-center gap-2 truncate">
                                <span className="truncate">{person.name}</span>
                                {person.video && <Film size={12} className="text-blue-500 shrink-0" />}
                              </p>
                              <p className="text-[10px] text-zinc-500 truncate">{person.isWalkIn ? "Click to Audition Now" : `Age ${person.age}`}</p>
                          </div>
                      </button>
                      
                      {person.video && (
                          <button
                              onClick={(e) => {
                                  e.stopPropagation();
                                  window.open(person.video, "_blank");
                              }}
                              className="w-10 md:px-4 bg-zinc-900 hover:bg-zinc-800 rounded-xl transition-colors border border-white/5 flex items-center justify-center text-blue-500 hover:text-blue-400 group-hover:border-blue-500/30 shrink-0"
                              title="Watch Audition"
                          >
                              <PlayCircle size={18} />
                          </button>
                      )}
                      
                      <button onClick={() => setInspectingActor(person)} className="w-10 md:px-4 bg-zinc-900 hover:bg-zinc-800 rounded-xl transition-colors border border-white/5 flex items-center justify-center text-zinc-400 hover:text-white shrink-0" title="View Profile"><User size={18} /></button>
                  </div>
                ))}
              </div>
            ))}
          </div>
        </div>

        {/* SCORING SIDEBAR */}
        {selectedPerson && (
          <aside className="fixed inset-0 z-[200] w-full bg-zinc-950 flex flex-col md:relative md:w-[420px] md:border-l md:border-white/10 md:z-50">
             <div className="p-6 pb-4 border-b border-white/5 bg-zinc-900/50">
               <div className="flex justify-between items-start mb-4">
                  <div className="flex gap-4">
                    <div className="w-20 h-20 rounded-2xl bg-zinc-800 overflow-hidden shadow-inner border border-white/10 shrink-0">
                      {selectedPerson.avatar ? <img src={selectedPerson.avatar} className="w-full h-full object-cover" alt={selectedPerson.name} /> : <div className="w-full h-full flex items-center justify-center text-zinc-600"><User size={32} /></div>}
                    </div>
                    <div>
                      <h2 className="text-2xl font-black italic uppercase leading-none tracking-tight">{selectedPerson.name}</h2>
                      <div className="flex items-center gap-2 mt-2">
                         <span className="bg-zinc-800 text-zinc-300 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide">{selectedPerson.isWalkIn ? "Walk-In" : `Age ${selectedPerson.age}`}</span>
                         {!selectedPerson.isWalkIn && <span className="border border-zinc-700 text-zinc-500 px-2 py-1 rounded text-[10px] font-bold uppercase">{selectedPerson.timeSlot}</span>}
                      </div>
                    </div>
                  </div>
                  <button onClick={() => setSelectedPerson(null)} className="text-zinc-500 hover:text-white transition-colors"><X size={24}/></button>
               </div>
             </div>

             <div className="p-6 space-y-6 flex-1 overflow-y-auto custom-scrollbar">
                {selectedPerson.video && (
                   <div className="rounded-xl overflow-hidden border border-white/10 bg-black aspect-video relative group shadow-2xl">
                      <video 
                          src={selectedPerson.video} 
                          controls 
                          className="w-full h-full object-contain"
                          poster={selectedPerson.avatar}
                      />
                      <div className="absolute top-2 left-2 bg-black/60 backdrop-blur px-2 py-1 rounded text-[10px] font-bold uppercase text-white pointer-events-none border border-white/10">
                          Audition Tape
                      </div>
                   </div>
                )}

                <div className={`p-4 rounded-xl border ${ROLE_THEMES[judgeRole!].color} bg-zinc-900/50`}>
                    <div className="flex justify-between items-center">
                      <div>
                          <p className="text-[10px] font-black uppercase text-zinc-400 tracking-widest mb-1">Your Rating</p>
                          <p className="text-3xl font-black tabular-nums leading-none">{calculateWeightedScore(currentScores).toFixed(1)} <span className="text-sm text-zinc-600 font-normal">/ 5.0</span></p>
                      </div>
                      <div className="text-right">
                        <p className="text-[9px] uppercase text-zinc-500 font-bold leading-relaxed">{judgeRole} Priority:<br/><span className="text-zinc-300">{judgeRole === "Director" ? "Acting 70% | Vocal 30%" : ROLE_THEMES[judgeRole!].weight}</span></p>
                      </div>
                    </div>
                </div>

                <div className="space-y-6">
                    <RubricSlider label="Vocal Ability" val={currentScores.vocal} setVal={(v) => setCurrentScores((s) => ({ ...s, vocal: v }))} disabled={judgeRole !== "Music" && judgeRole !== "Admin"} />
                    <RubricSlider label="Acting / Reads" val={currentScores.acting} setVal={(v) => setCurrentScores((s) => ({ ...s, acting: v }))} disabled={judgeRole !== "Director" && judgeRole !== "Admin"} />
                    {(judgeRole === "Choreographer" || judgeRole === "Admin") && (
                      <RubricSlider label="Dance / Movement" val={currentScores.dance} setVal={(v) => setCurrentScores((s) => ({ ...s, dance: v }))} disabled={false} />
                    )}
                    <RubricSlider label="Stage Presence" val={currentScores.presence} setVal={(v) => setCurrentScores((s) => ({ ...s, presence: v }))} disabled={judgeRole !== "Director" && judgeRole !== "Admin"} />
                </div>

                <div className="pt-2 border-t border-white/5">
                  <label className="text-xs uppercase text-zinc-500 font-bold mb-3 block tracking-widest flex items-center gap-2"><MessageSquare size={12}/> Notes</label>
                  <textarea className="w-full bg-zinc-900 border border-white/10 p-4 rounded-xl text-sm min-h-[100px] focus:border-blue-500 outline-none resize-none transition-all placeholder:text-zinc-700" placeholder={`Internal notes for ${selectedPerson.name}...`} value={currentScores.notes} onChange={(e) => setCurrentScores((s) => ({ ...s, notes: e.target.value }))} />
                </div>
             </div>

             <div className="p-6 border-t border-white/10 bg-zinc-900/50">
               <button onClick={handleCommit} className="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-black uppercase tracking-widest shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 transition-transform active:scale-95">
                 <Save size={18} />
                 {selectedPerson.isWalkIn ? "Submit Walk-In" : "Save Score"}
               </button>
             </div>
          </aside>
        )}
      </div>
      )
    )}

    {inspectingActor && <ActorProfileModal actor={inspectingActor} grades={grades[inspectingActor.id]} onClose={() => setInspectingActor(null)} />}
  </>
);
}
</file>

<file path="app/(casting)/callbacks/page.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import React, { useState, useEffect, useMemo } from 'react';
import { 
  Users, Clock, Plus, Trash2, Share, Search, X, 
  Link as LinkIcon, Music, FileText,
  Loader2, Copy, UploadCloud, Eye,
  Mic, Move, Theater, Archive, EyeOff, RotateCcw, Film,
  Star, TrendingDown
} from 'lucide-react';
// CRITICAL: Using getAuditionees ensures names are hydrated (not IDs)
import { getAuditionees, updateAuditionSlot, getProductionAssets, createProductionAsset } from '@/app/lib/baserow'; 

// --- CONFIG ---
const DISCLAIMER_TEXT = `*** NOTICE ***
The creative team reserves the right to release actors early if requirements are not met. 
Please be prepared for all listed slots, but be aware the schedule may evolve.`;

// --- TYPES ---
interface Student {
  id: number;
  name: string;
  avatar: string;
  gender: string;
  age: string;
  score: number;
  callbackString: string;
  conflicts: string;
  breakdown: { vocal: number; acting: number; dance: number };
  notes: { vocal: string; acting: string; dance: string; admin: string };
}

interface CallbackSlot {
  id: string;
  time: string;
  title: string;
  type: 'dance' | 'vocal' | 'read';
  materialLink?: string; 
  materialName?: string; 
  assignedIds: number[];
  // Tracks role assignment per student
  pairs?: { 
      name: string, 
      assignments: { studentId: number, role: string }[] 
  }[]; 
}

interface Asset {
    id: number;
    url: string;
    name: string;
    type: 'PDF' | 'Audio' | 'Video';
}

// --- DEMO DATA ---
const DEFAULT_SLOTS: CallbackSlot[] = [
  { 
    id: 'dance-1', 
    time: '10:00 AM', 
    title: 'General Dance Call (Jazz)', 
    type: 'dance', 
    materialName: "Combo Video",
    materialLink: "https://youtu.be/example",
    assignedIds: [] 
  },
  { 
    id: 'vocal-1', 
    time: '11:15 AM', 
    title: 'Ariel / Ursula Vocal Cut', 
    type: 'vocal', 
    materialName: "Sheet Music (m.32-50)",
    assignedIds: [] 
  },
  { 
    id: 'read-1', 
    time: '01:00 PM', 
    title: 'Sc 4: Ariel & Flounder', 
    type: 'read', 
    materialName: "Side #4",
    assignedIds: [] 
  },
];

// --- PARTNER MATCHER COMPONENT ---
const PartnerMatcher = ({ 
    slot, 
    students, 
    onSave, 
    onClose 
}: { 
    slot: CallbackSlot, 
    students: Student[], 
    onSave: (updatedSlot: CallbackSlot) => void, 
    onClose: () => void 
}) => {
    // 1. Detect Roles from Title (Simple Split)
    const availableRoles = useMemo(() => {
        // Split by common separators: " vs ", " & ", " / ", " and "
        const raw = slot.title.split(/ vs | & | \/ | and /i);
        // If no split found (e.g. "General Reading"), just use "Reader"
        return raw.length > 1 ? raw.map(r => r.trim()) : ["Reader 1", "Reader 2"];
    }, [slot.title]);

    const [localPairs, setLocalPairs] = useState<{ name: string, assignments: { studentId: number, role: string }[] }[]>(slot.pairs || []);
    const [unpairedIds, setUnpairedIds] = useState<number[]>([]);

    useEffect(() => {
        const pairedSet = new Set(localPairs.flatMap(p => p.assignments.map(a => a.studentId)));
        setUnpairedIds(slot.assignedIds.filter(id => !pairedSet.has(id)));
    }, [slot.assignedIds, localPairs]);

    const addPair = () => {
        setLocalPairs([...localPairs, { name: `Read ${localPairs.length + 1}`, assignments: [] }]);
    };

    const toggleStudentInPair = (studentId: number, pairIndex: number) => {
        const newPairs = [...localPairs];
        const currentPair = newPairs[pairIndex];
        
        // Check if student is already in this pair
        const existingIdx = currentPair.assignments.findIndex(a => a.studentId === studentId);

        if (existingIdx >= 0) {
            // REMOVE: Send back to tank
            currentPair.assignments.splice(existingIdx, 1);
            setUnpairedIds([...unpairedIds, studentId]);
        } else {
            // ADD: Assign first available role
            // Find which roles are already taken in this pair
            const takenRoles = new Set(currentPair.assignments.map(a => a.role));
            // Find first role NOT taken, or default to first role
            const nextRole = availableRoles.find(r => !takenRoles.has(r)) || availableRoles[0];
            
            currentPair.assignments.push({ studentId, role: nextRole });
            setUnpairedIds(unpairedIds.filter(id => id !== studentId));
        }
        setLocalPairs(newPairs);
    };

    const cycleRole = (pairIndex: number, assignmentIndex: number) => {
        const newPairs = [...localPairs];
        const assignment = newPairs[pairIndex].assignments[assignmentIndex];
        
        const currentRoleIdx = availableRoles.indexOf(assignment.role);
        const nextRoleIdx = (currentRoleIdx + 1) % availableRoles.length;
        
        assignment.role = availableRoles[nextRoleIdx];
        setLocalPairs(newPairs);
    };

    const handleSave = () => {
        onSave({ ...slot, pairs: localPairs });
        onClose();
    };

    return (
        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
            <div className="bg-zinc-900 border border-white/10 rounded-2xl w-full max-w-2xl h-[80vh] flex flex-col shadow-2xl">
                <div className="p-4 border-b border-white/10 flex justify-between items-center bg-zinc-900 rounded-t-2xl">
                    <div>
                        <h2 className="text-lg font-black uppercase italic text-white">Partner Matcher</h2>
                        <div className="flex gap-2 mt-1">
                            {availableRoles.map(r => (
                                <span key={r} className="text-[10px] font-bold bg-white/10 px-2 py-0.5 rounded text-zinc-400">{r}</span>
                            ))}
                        </div>
                    </div>
                    <button onClick={handleSave} className="bg-blue-600 px-4 py-2 rounded font-bold text-xs uppercase hover:bg-blue-500 text-white shadow-lg">Save Pairs</button>
                </div>

                <div className="flex-1 flex overflow-hidden">
                    {/* LEFT: UNPAIRED POOL */}
                    <div className="w-1/3 border-r border-white/10 p-4 bg-zinc-950 overflow-y-auto custom-scrollbar">
                        <h3 className="text-xs font-bold text-zinc-500 uppercase mb-4 sticky top-0 bg-zinc-950 py-2">Holding Tank</h3>
                        {unpairedIds.map(id => {
                            const s = students.find(st => st.id === id);
                            if (!s) return null;
                            return (
                                <div key={id} className="mb-2 p-2 bg-zinc-900 border border-white/10 rounded flex items-center gap-2 opacity-75 hover:opacity-100">
                                    <img src={s.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-6 h-6 rounded-full object-cover" />
                                    <span className="text-xs font-bold text-zinc-300">{s.name}</span>
                                </div>
                            );
                        })}
                        {unpairedIds.length === 0 && <p className="text-[10px] text-zinc-600 italic">All actors assigned!</p>}
                    </div>

                    {/* RIGHT: PAIRS */}
                    <div className="flex-1 p-4 overflow-y-auto custom-scrollbar bg-zinc-900">
                        <div className="flex justify-between mb-4 items-center">
                            <h3 className="text-xs font-bold text-zinc-500 uppercase">Reads / Groups</h3>
                            <button onClick={addPair} className="flex items-center gap-1 text-xs font-bold text-blue-400 uppercase hover:text-blue-300 bg-blue-900/20 px-3 py-1.5 rounded-full border border-blue-500/30"><Plus size={12}/> Add Read</button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {localPairs.map((pair, idx) => (
                                <div key={idx} className="bg-zinc-800/50 border border-white/10 rounded-xl p-3 relative group">
                                    <div className="flex justify-between items-center mb-2">
                                        <input 
                                            value={pair.name} 
                                            onChange={(e) => {
                                                const copy = [...localPairs];
                                                copy[idx].name = e.target.value;
                                                setLocalPairs(copy);
                                            }}
                                            className="bg-transparent font-bold text-sm text-blue-300 outline-none w-full placeholder:text-zinc-600"
                                            placeholder="Group Name"
                                        />
                                        <button onClick={() => setLocalPairs(localPairs.filter((_, i) => i !== idx))} className="text-zinc-600 hover:text-red-500"><X size={12}/></button>
                                    </div>
                                    
                                    {/* ASSIGNED TO THIS PAIR */}
                                    <div className="space-y-1 mb-3 min-h-[40px]">
                                        {pair.assignments.map((assign, aIdx) => {
                                            const s = students.find(st => st.id === assign.studentId);
                                            if(!s) return null;
                                            return (
                                                <div key={assign.studentId} className="flex items-center justify-between bg-blue-600/20 border border-blue-500/30 text-blue-100 p-1.5 rounded group/item">
                                                    <div 
                                                        className="flex items-center gap-2 cursor-pointer"
                                                        onClick={() => toggleStudentInPair(assign.studentId, idx)} // Click name to remove
                                                        title="Click to Remove"
                                                    >
                                                        <img src={s.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-4 h-4 rounded-full object-cover" />
                                                        <span className="text-[10px] font-bold">{s.name}</span>
                                                    </div>
                                                    
                                                    {/* ROLE BADGE (Click to Cycle) */}
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); cycleRole(idx, aIdx); }}
                                                        className="ml-2 bg-blue-500 text-white text-[8px] font-black uppercase px-1.5 py-0.5 rounded hover:bg-blue-400 transition-colors"
                                                        title="Tap to switch role"
                                                    >
                                                        {assign.role}
                                                    </button>
                                                </div>
                                            )
                                        })}
                                        {pair.assignments.length === 0 && <p className="text-[10px] text-zinc-600 italic py-2 text-center border-2 border-dashed border-zinc-800 rounded">Empty Read</p>}
                                    </div>

                                    {/* AVAILABLE TO ADD */}
                                    {unpairedIds.length > 0 && (
                                        <div className="pt-2 border-t border-white/5">
                                            <p className="text-[8px] font-bold text-zinc-500 uppercase mb-1">Tap to Add:</p>
                                            <div className="flex flex-wrap gap-1">
                                                {unpairedIds.map(id => {
                                                    const s = students.find(st => st.id === id);
                                                    if(!s) return null;
                                                    return (
                                                        <button key={id} onClick={() => toggleStudentInPair(id, idx)} className="text-[8px] bg-zinc-950 border border-white/10 px-2 py-1 rounded hover:border-blue-500 hover:text-blue-400 text-zinc-400 transition-colors">
                                                            {s.name.split(' ')[0]}
                                                        </button>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default function CallbackMatrixPage() {
  // --- STATE ---
  const [students, setStudents] = useState<Student[]>([]);
  const [slots, setSlots] = useState<CallbackSlot[]>(DEFAULT_SLOTS);
  const [assets, setAssets] = useState<Asset[]>([]);
  
  const [loading, setLoading] = useState(true);
  const [leftPanelOpen, setLeftPanelOpen] = useState(true); 
  const [rightPanelOpen, setRightPanelOpen] = useState(false); 
  const [search, setSearch] = useState("");
  const [draggedStudentId, setDraggedStudentId] = useState<number | null>(null);
  const [isUploading, setIsUploading] = useState(false);
  const [activeMobileStudent, setActiveMobileStudent] = useState<Student | null>(null);
  const [inspectingStudent, setInspectingStudent] = useState<Student | null>(null);
  const [activeProductionId, setActiveProductionId] = useState<number | null>(null);
  
  // Sorting & Filtering
  const [hiddenIds, setHiddenIds] = useState<Set<number>>(new Set());
  const [showHidden, setShowHidden] = useState(false);
  const [sortMode, setSortMode] = useState<'overall' | 'vocal' | 'acting' | 'dance' | 'bottom'>('overall');

  // Modals
  const [isAddingSlot, setIsAddingSlot] = useState(false);
  const [newSlotData, setNewSlotData] = useState({ time: "02:00 PM", title: "", link: "", label: "" });
  const [pairingSlotId, setPairingSlotId] = useState<string | null>(null);

  // --- HELPERS ---
  const safeString = (val: any): string => {
    if (val === null || val === undefined) return "";
    if (typeof val === 'string') return val;
    if (typeof val === 'number') return String(val);
    if (Array.isArray(val)) return val.length > 0 ? safeString(val[0].value || val[0]) : "";
    if (typeof val === 'object') return val.value ? safeString(val.value) : "";
    return String(val);
  };

  const safeNumber = (val: any): number => {
      const s = safeString(val);
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
  };

  // --- SAFETY NET: LOAD DRAFT ---
  useEffect(() => {
    const saved = localStorage.getItem('draft_callback_slots');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            if (parsed && Array.isArray(parsed) && parsed.length > 0) {
                setSlots(parsed);
                console.log("Restored draft schedule from local storage");
            }
        } catch (e) {
            console.error("Failed to load draft slots", e);
        }
    }
  }, []);

  // --- SAFETY NET: SAVE DRAFT ---
  useEffect(() => {
    if (slots.length > 0 && JSON.stringify(slots) !== JSON.stringify(DEFAULT_SLOTS)) {
        localStorage.setItem('draft_callback_slots', JSON.stringify(slots));
    }
  }, [slots]);

  // --- DATA LOADING ---
  useEffect(() => {
    async function load() {
      const rows = await getAuditionees();
      
      const activeShowIdStr = localStorage.getItem('activeShowId'); 
      const activeShowId = activeShowIdStr ? parseInt(activeShowIdStr) : null;
      setActiveProductionId(activeShowId);

      if (activeShowId) {
          const savedHidden = localStorage.getItem(`hiddenCallbacks_${activeShowId}`);
          if (savedHidden) setHiddenIds(new Set(JSON.parse(savedHidden)));
      }

      const cleanData = rows
        .filter((r: any) => {
            const prodArray = r.Production || [];
            if (!prodArray.length) return false;
            if (activeShowId && prodArray.some((p: any) => p.id === activeShowId)) return true;
            // Fallback for demo
            return (prodArray[0]?.value || "").toLowerCase().includes("mermaid");
        })
        .map((r: any) => ({
            id: r.id,
            name: safeString(r.Performer),
            avatar: r.Headshot?.[0]?.url || "",
            age: safeString(r.Age),
            gender: safeString(r.Gender),
            score: safeNumber(r["Average Score"] || r["Vocal Score"]), 
            callbackString: safeString(r["Callbacks"]),
            conflicts: safeString(r["Conflicts"]) || "None listed",
            breakdown: {
                vocal: safeNumber(r["Vocal Score"]),
                acting: safeNumber(r["Acting Score"]),
                dance: safeNumber(r["Dance Score"]),
            },
            notes: {
                vocal: safeString(r["Music Notes"]),
                acting: safeString(r["Acting Notes"]),
                dance: safeString(r["Choreography Notes"]),
                admin: safeString(r["Admin Notes"])
            }
        }));
      setStudents(cleanData);

      if (activeShowId) {
          try {
              const remoteAssets = await getProductionAssets(activeShowId);
              setAssets(remoteAssets.map((a: any) => ({
                  id: a.id, name: safeString(a.Name), url: a.Link, type: safeString(a.Type?.value || a.Type) as any
              })));
          } catch (e) { console.error(e); }
      }
      setLoading(false);
    }
    load();
  }, []);

  // --- ACTIONS ---
  const toggleHideStudent = (e: React.MouseEvent, id: number) => {
      e.stopPropagation();
      setHiddenIds(prev => {
          const next = new Set(prev);
          if (next.has(id)) next.delete(id);
          else next.add(id);
          if (activeProductionId) localStorage.setItem(`hiddenCallbacks_${activeProductionId}`, JSON.stringify(Array.from(next)));
          return next;
      });
  };

  const handleUploadAsset = async (e: React.ChangeEvent<HTMLInputElement>) => {
      if (!e.target.files || !e.target.files[0]) return;
      if (!activeProductionId) { alert("Please select a Production first!"); return; }
      const file = e.target.files[0];
      setIsUploading(true);
      try {
          const res = await fetch('/api/upload', {
              method: 'POST',
              body: JSON.stringify({ filename: `SIDE-${file.name}`, fileType: file.type }),
          });
          if (!res.ok) throw new Error("Sign failed");
          const { uploadUrl, publicUrl } = await res.json();
          await fetch(uploadUrl, { method: 'PUT', body: file, headers: { "Content-Type": file.type, "x-amz-acl": "public-read" } });
          const type = file.type.includes('pdf') ? 'PDF' : file.type.includes('audio') ? 'Audio' : 'Video';
          await createProductionAsset(file.name, publicUrl, type, activeProductionId);
          setAssets(prev => [...prev, { id: Date.now(), name: file.name, url: publicUrl, type }]);
      } catch (err) { alert("Upload failed."); } finally { setIsUploading(false); }
  };

  const handleCopyAsset = (asset: Asset) => {
      navigator.clipboard.writeText(asset.url);
      setNewSlotData(prev => ({ ...prev, link: asset.url, label: asset.name }));
      alert("Link copied! It will auto-fill if you create a slot now.");
  };

  const handleCreateSlot = (e: React.FormEvent) => {
      e.preventDefault();
      const title = newSlotData.title || "New Slot";
      const type = title.toLowerCase().includes('dance') ? 'dance' : title.toLowerCase().includes('vocal') ? 'vocal' : 'read';
      
      setSlots(prev => [...prev, {
          id: Date.now().toString(),
          time: newSlotData.time,
          title,
          type,
          materialLink: newSlotData.link || undefined,
          materialName: newSlotData.link ? (newSlotData.label || "Material") : undefined,
          assignedIds: []
      }]);
      setIsAddingSlot(false);
      setNewSlotData({ time: "", title: "", link: "", label: "" });
  };

  const handleRemoveSlot = (id: string) => setSlots(prev => prev.filter(s => s.id !== id));

  const handleAssign = (studentId: number, slotId: string) => {
      setSlots(prev => prev.map(s => {
          if (s.id === slotId && !s.assignedIds.includes(studentId)) {
              return { ...s, assignedIds: [...s.assignedIds, studentId] };
          }
          return s;
      }));
      setActiveMobileStudent(null);
  };

  const handleUnassign = (studentId: number, slotId: string) => {
      setSlots(prev => prev.map(s => {
          if (s.id === slotId) {
              return { ...s, assignedIds: s.assignedIds.filter(id => id !== studentId) };
          }
          return s;
      }));
  };

  const handlePublish = async () => {
      if(!confirm("Publish updates to Baserow?")) return;
      const updates: Record<number, string> = {};
      slots.forEach(slot => {
          slot.assignedIds.forEach(id => {
              let entry = `${slot.time}: ${slot.title}`;
              if (slot.materialLink) entry += ` (Link: ${slot.materialLink})`;
              // UPDATED: Include Role Info
              if (slot.pairs && slot.pairs.length > 0) {
                  // Find assignment
                  const pair = slot.pairs.find(p => p.assignments.some(a => a.studentId === id));
                  if (pair) {
                      const assignment = pair.assignments.find(a => a.studentId === id);
                      entry += ` [${pair.name}: ${assignment?.role}]`;
                  }
              }
              if (updates[id]) updates[id] += `\n${entry}`;
              else updates[id] = entry;
          });
      });
      let count = 0;
      for (const [id, text] of Object.entries(updates)) {
          const finalString = `${text}\n\n${DISCLAIMER_TEXT}`;
          await updateAuditionSlot(Number(id), { "Callbacks": finalString });
          count++;
      }
      
      // Clear safety net on success
      localStorage.removeItem('draft_callback_slots');
      
      alert(`Published ${count} schedules!`);
  };

  const benchList = useMemo(() => {
      return students
        .filter(s => {
            const matchesSearch = s.name.toLowerCase().includes(search.toLowerCase());
            const isVisible = showHidden || !hiddenIds.has(s.id);
            return matchesSearch && isVisible;
        })
        .sort((a, b) => {
            if (sortMode === 'overall') return b.score - a.score;
            if (sortMode === 'vocal') return b.breakdown.vocal - a.breakdown.vocal;
            if (sortMode === 'acting') return b.breakdown.acting - a.breakdown.acting;
            if (sortMode === 'dance') return b.breakdown.dance - a.breakdown.dance;
            if (sortMode === 'bottom') return a.score - b.score; 
            return 0;
        });
  }, [students, search, hiddenIds, showHidden, sortMode]);

  const getDisplayScore = (student: Student) => {
      if (sortMode === 'vocal') return `Vocal: ${student.breakdown.vocal}`;
      if (sortMode === 'acting') return `Act: ${student.breakdown.acting}`;
      if (sortMode === 'dance') return `Dance: ${student.breakdown.dance}`;
      return `Avg: ${student.score.toFixed(1)}`;
  };

  const getSortLabel = () => {
      switch(sortMode) {
          case 'overall': return "Top Overall Scores";
          case 'vocal': return "Top Vocal Scores";
          case 'acting': return "Top Acting Scores";
          case 'dance': return "Top Dance Scores";
          case 'bottom': return "Lowest Scores (Cuts)";
      }
  };

  const handleDragStart = (e: React.DragEvent, id: number) => {
      setDraggedStudentId(id);
      e.dataTransfer.effectAllowed = "copy";
  };
  const handleDragOver = (e: React.DragEvent) => { e.preventDefault(); };
  const handleDrop = (e: React.DragEvent, slotId: string) => {
      e.preventDefault();
      if(draggedStudentId) handleAssign(draggedStudentId, slotId);
      setDraggedStudentId(null);
  };

  if (loading) return <div className="h-screen bg-zinc-950 flex items-center justify-center text-white"><Loader2 className="animate-spin text-blue-500" /></div>;

  return (
    <div className="h-screen bg-zinc-950 text-white flex overflow-hidden relative font-sans">
        
        {/* LEFT: BENCH */}
        <aside className={`${leftPanelOpen ? 'w-[320px]' : 'w-0'} bg-zinc-900 border-r border-white/5 transition-all duration-300 flex flex-col shrink-0 overflow-hidden`}>
            {/* Header */}
            <div className="p-4 border-b border-white/5 bg-zinc-900 shrink-0 flex justify-between items-center">
                <div className="flex items-center gap-2">
                    <Users size={18} className="text-zinc-400" />
                    <h2 className="text-sm font-black uppercase tracking-widest">Bench</h2>
                    <span className="bg-zinc-800 text-zinc-500 px-2 py-0.5 rounded-full text-[10px] font-bold">{benchList.length}</span>
                </div>
                <div className="flex gap-2">
                    <button onClick={() => setShowHidden(!showHidden)} className={`p-2 rounded-lg transition-colors group relative ${showHidden ? 'bg-amber-900/30 text-amber-500' : 'text-zinc-600 hover:text-zinc-400'}`}>
                        {showHidden ? <Eye size={16} /> : <EyeOff size={16} />}
                        <span className="absolute bottom-full right-0 mb-2 hidden group-hover:block bg-black text-white text-[10px] font-bold px-2 py-1 rounded whitespace-nowrap z-50">
                            {showHidden ? "Hide Archived" : "Show Archived"}
                        </span>
                    </button>
                    <button onClick={() => setLeftPanelOpen(false)} className="md:hidden text-zinc-500"><X size={16}/></button>
                </div>
            </div>
            
            {/* SORT BAR */}
            <div className="px-2 pt-2 flex gap-1 justify-between shrink-0">
                {[
                    { id: 'overall', icon: Star, label: "Top Overall" },
                    { id: 'vocal', icon: Mic, label: "Top Vocal" },
                    { id: 'acting', icon: Theater, label: "Top Acting" },
                    { id: 'dance', icon: Move, label: "Top Dance" },
                    { id: 'bottom', icon: TrendingDown, label: "Lowest Scores" },
                ].map((btn) => (
                    <button key={btn.id} onClick={() => setSortMode(btn.id as any)} className={`group relative flex-1 py-2 rounded flex justify-center transition-colors ${sortMode === btn.id ? 'bg-blue-600 text-white' : btn.id === 'bottom' ? 'bg-zinc-900 text-red-400 hover:bg-zinc-800' : 'bg-zinc-900 text-zinc-500 hover:bg-zinc-800'}`}>
                        <btn.icon size={14} />
                        <span className="absolute bottom-full mb-2 hidden group-hover:block bg-black border border-white/10 text-white text-[10px] font-bold px-2 py-1 rounded whitespace-nowrap z-50 shadow-xl">{btn.label}</span>
                    </button>
                ))}
            </div>

            <div className="px-3 pb-2 pt-1 text-center border-b border-white/5 bg-zinc-900/50">
                <p className="text-[9px] font-black uppercase tracking-widest text-zinc-500">Sorting By: <span className="text-blue-400">{getSortLabel()}</span></p>
            </div>

            <div className="p-2 border-b border-white/5 shrink-0">
                <div className="relative">
                    <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500" />
                    <input value={search} onChange={(e) => setSearch(e.target.value)} className="bg-zinc-950 rounded p-2 pl-9 text-xs w-full border border-white/5 focus:border-blue-500 outline-none" placeholder="Search..." />
                </div>
            </div>

            {/* List */}
            <div className="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar pb-20">
                {benchList.map(student => (
                    <div 
                        key={student.id} draggable onDragStart={(e) => handleDragStart(e, student.id)}
                        onClick={() => { if (window.innerWidth < 768) { setActiveMobileStudent(student); setLeftPanelOpen(false); }}}
                        className={`group flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-grab active:cursor-grabbing border relative transition-colors ${activeMobileStudent?.id === student.id ? 'bg-blue-900/20 border-blue-500/30' : 'border-transparent'} ${hiddenIds.has(student.id) ? 'opacity-50 grayscale' : ''}`}
                    >
                        <img src={student.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-8 h-8 rounded-full object-cover bg-zinc-800" />
                        <div className="min-w-0 flex-1">
                            <p className="text-xs font-bold truncate">{student.name}</p>
                            <div className="flex gap-2 text-[10px] text-zinc-500">
                                <span className={`font-bold ${student.score >= 4 ? 'text-green-400' : 'text-zinc-400'}`}>{getDisplayScore(student)}</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-1">
                            <button onClick={(e) => toggleHideStudent(e, student.id)} className={`group/btn relative p-1.5 rounded-full transition-colors ${hiddenIds.has(student.id) ? 'text-amber-500 bg-amber-900/20' : 'text-zinc-600 hover:text-white hover:bg-white/10'}`}>
                                {hiddenIds.has(student.id) ? <RotateCcw size={14} /> : <Archive size={14} />}
                                <span className="absolute bottom-full right-0 mb-2 hidden group-hover/btn:block bg-black border border-white/10 text-white text-[10px] font-bold px-2 py-1 rounded whitespace-nowrap z-50 shadow-xl">{hiddenIds.has(student.id) ? "Restore to Bench" : "Archive (Hide)"}</span>
                            </button>
                            <button onClick={(e) => { e.stopPropagation(); setInspectingStudent(student); }} className="group/btn relative p-1.5 rounded-full text-zinc-600 hover:text-white hover:bg-white/10 transition-colors">
                                <Eye size={14} />
                                <span className="absolute bottom-full right-0 mb-2 hidden group-hover/btn:block bg-black border border-white/10 text-white text-[10px] font-bold px-2 py-1 rounded whitespace-nowrap z-50 shadow-xl">View Profile</span>
                            </button>
                        </div>
                    </div>
                ))}
            </div>
        </aside>

        {/* CENTER: MATRIX */}
        <main className="flex-1 flex flex-col min-w-0 bg-zinc-950 relative">
            <header className="h-16 border-b border-white/10 bg-zinc-900/50 flex items-center justify-between px-6 shrink-0">
                <div className="flex items-center gap-4">
                    <button onClick={() => setLeftPanelOpen(!leftPanelOpen)} className={`p-2 rounded-lg ${!leftPanelOpen ? 'bg-blue-600' : 'bg-zinc-800'}`}><Users size={18} /></button>
                    <div><h1 className="text-lg font-black uppercase italic tracking-tighter">Callback Matrix</h1></div>
                </div>
                <div className="flex gap-2">
                    <button onClick={() => setRightPanelOpen(!rightPanelOpen)} className={`flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold uppercase ${rightPanelOpen ? 'bg-zinc-700' : 'bg-zinc-800 text-zinc-300'}`}><UploadCloud size={14} /> <span className="hidden md:inline">Library</span></button>
                    <button onClick={() => setIsAddingSlot(true)} className="flex items-center gap-2 bg-zinc-800 text-zinc-300 px-3 py-2 rounded-lg text-xs font-bold uppercase"><Plus size={14} /> <span className="hidden md:inline">Slot</span></button>
                    <button onClick={handlePublish} className="flex items-center gap-2 bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold uppercase shadow-lg shadow-blue-900/20"><Share size={14} /> <span className="hidden md:inline">Publish</span></button>
                </div>
            </header>

            {activeMobileStudent && (
                <div className="bg-blue-600 text-white p-3 text-xs font-bold flex justify-between items-center shadow-lg z-20">
                    <span>Assigning: {activeMobileStudent.name}</span>
                    <button onClick={() => setActiveMobileStudent(null)} className="p-1 hover:bg-white/20 rounded"><X size={14}/></button>
                </div>
            )}

            <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 custom-scrollbar">
                {slots.map((slot) => (
                    <div 
                        key={slot.id} onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, slot.id)}
                        onClick={() => { if(activeMobileStudent) handleAssign(activeMobileStudent.id, slot.id); }}
                        className={`relative rounded-2xl border transition-all overflow-hidden group ${activeMobileStudent ? 'border-blue-500/50 bg-blue-900/5 cursor-pointer' : 'border-white/5 bg-zinc-900/30 hover:border-white/10'}`}
                    >
                        <div className={`absolute left-0 top-0 bottom-0 w-1 ${slot.type === 'dance' ? 'bg-emerald-500' : slot.type === 'vocal' ? 'bg-purple-500' : 'bg-blue-500'}`} />
                        <div className="p-4 pl-6 flex flex-col md:flex-row gap-6 md:items-center">
                            
                            {/* SLOT INFO */}
                            <div className="min-w-[200px] shrink-0">
                                <div className="flex items-center gap-2 text-zinc-500 mb-1"><Clock size={12} /><span className="text-xs font-black uppercase tracking-wider">{slot.time}</span></div>
                                <h3 className="text-lg font-bold text-white leading-tight mb-2">{slot.title}</h3>
                                {slot.materialLink ? (
                                    <a href={slot.materialLink} target="_blank" className="flex items-center gap-1.5 text-[10px] font-bold text-blue-400 uppercase bg-blue-900/20 px-2 py-1 rounded w-fit border border-blue-500/20" onClick={(e) => e.stopPropagation()}><LinkIcon size={10} /> {slot.materialName || "Sides"}</a>
                                ) : <p className="text-[10px] text-zinc-600 italic">No assets attached</p>}
                            </div>

                            {/* ASSIGNED GRID or PAIRS */}
                            <div className="flex-1 w-full">
                                {slot.pairs && slot.pairs.length > 0 ? (
                                    <div className="flex flex-wrap gap-2">
                                        {slot.pairs.map((pair, pIdx) => (
                                            <div key={pIdx} className="bg-zinc-800/80 border border-blue-500/30 rounded-lg px-3 py-1.5 flex items-center gap-2">
                                                <span className="text-[10px] font-black text-blue-400 uppercase mr-1">{pair.name}:</span>
                                                <div className="flex -space-x-1.5">
                                                    {pair.assignments.map(a => {
                                                        const s = students.find(st => st.id === a.studentId);
                                                        return s ? (
                                                            <div key={a.studentId} className="relative group/face">
                                                                <img src={s.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-6 h-6 rounded-full border border-black object-cover" title={`${s.name} (${a.role})`} />
                                                                <span className="absolute bottom-full mb-1 hidden group-hover/face:block bg-black text-white text-[8px] px-1 py-0.5 rounded whitespace-nowrap">{a.role}</span>
                                                            </div>
                                                        ) : null;
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="flex flex-wrap gap-2">
                                        {slot.assignedIds.length === 0 && <span className="text-zinc-700 text-xs font-bold uppercase tracking-wider">Drag students here...</span>}
                                        {slot.assignedIds.map(id => {
                                            const student = students.find(s => s.id === id);
                                            if (!student) return null;
                                            return (
                                                <div key={id} onClick={(e) => { e.stopPropagation(); setInspectingStudent(student); }} className="flex items-center gap-2 bg-zinc-800 border border-white/5 pl-1 pr-2 py-1 rounded-full cursor-pointer hover:bg-zinc-700">
                                                    <img src={student.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-5 h-5 rounded-full object-cover" />
                                                    <span className="text-xs font-bold text-zinc-300">{student.name}</span>
                                                    <button onClick={(e) => { e.stopPropagation(); handleUnassign(id, slot.id); }} className="ml-1 text-zinc-600 hover:text-red-400"><X size={12} /></button>
                                                </div>
                                            )
                                        })}
                                    </div>
                                )}
                            </div>

                            {/* SLOT ACTIONS */}
                            <div className="flex flex-col gap-2 items-end">
                                <button onClick={(e) => { e.stopPropagation(); setPairingSlotId(slot.id); }} className="text-zinc-500 hover:text-blue-400 p-1.5 bg-zinc-800/50 rounded-lg hover:bg-zinc-800 transition-colors" title="Manage Pairs / Reads"><Users size={16} /></button>
                                <button onClick={(e) => { e.stopPropagation(); handleRemoveSlot(slot.id); }} className="text-zinc-600 hover:text-red-500 p-1.5 hover:bg-zinc-800 rounded-lg transition-colors"><Trash2 size={16} /></button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </main>

        {/* RIGHT: ASSET LIBRARY */}
        <aside className={`${rightPanelOpen ? 'w-[300px]' : 'w-0'} bg-zinc-900 border-l border-white/5 transition-all duration-300 flex flex-col shrink-0 overflow-hidden`}>
             <div className="p-4 border-b border-white/5 bg-zinc-900 shrink-0 flex justify-between items-center">
                <h2 className="text-sm font-black uppercase tracking-widest flex items-center gap-2"><UploadCloud size={16} className="text-blue-500"/> Library</h2>
                <button onClick={() => setRightPanelOpen(false)} className="md:hidden"><X size={16}/></button>
            </div>
            <div className="p-4 shrink-0 border-b border-white/5">
                <label className={`w-full h-24 border-2 border-dashed border-zinc-700 rounded-xl flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-white/5 transition-colors ${isUploading ? 'opacity-50 cursor-wait' : ''}`}>
                    {isUploading ? <Loader2 className="animate-spin text-blue-500" /> : <Plus className="text-zinc-500" />}
                    <span className="text-[10px] font-bold uppercase text-zinc-500">{isUploading ? "Uploading..." : "Upload PDF / MP3"}</span>
                    <input type="file" accept=".pdf,audio/*,video/*" className="hidden" onChange={handleUploadAsset} disabled={isUploading} />
                </label>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                {assets.map((asset, i) => (
                    <div key={i} className="bg-zinc-950 p-3 rounded-xl border border-white/5 group relative">
                        <div className="flex items-start gap-3 mb-2">
                            <div className="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center shrink-0">
                                {asset.type === 'PDF' ? <FileText size={16} className="text-blue-400"/> : asset.type === 'Video' ? <Film size={16} className="text-pink-400"/> : <Music size={16} className="text-purple-400"/>}
                            </div>
                            <div className="min-w-0">
                                <p className="text-xs font-bold text-zinc-300 truncate" title={asset.name}>{asset.name}</p>
                                <p className="text-[10px] text-zinc-600 uppercase">{asset.type}</p>
                            </div>
                        </div>
                        <button onClick={() => handleCopyAsset(asset)} className="w-full py-1.5 bg-zinc-800 hover:bg-blue-600 hover:text-white text-zinc-400 rounded text-[10px] font-bold uppercase transition-colors flex items-center justify-center gap-2 border border-white/5 hover:border-blue-500"><Copy size={12} /> Copy Link</button>
                    </div>
                ))}
            </div>
        </aside>

        {/* MODAL: ADD SLOT */}
        {isAddingSlot && (
            <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setIsAddingSlot(false)}>
                <form onSubmit={handleCreateSlot} onClick={e => e.stopPropagation()} className="bg-zinc-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-sm p-6 space-y-4">
                    <h3 className="text-lg font-black uppercase italic">Create Callback Slot</h3>
                    <div>
                        <label className="text-[10px] font-bold uppercase text-zinc-500">Time</label>
                        <input autoFocus value={newSlotData.time} onChange={e => setNewSlotData({...newSlotData, time: e.target.value})} className="w-full bg-zinc-950 border border-white/10 rounded p-2 text-sm focus:border-blue-500 outline-none text-white" />
                    </div>
                    <div>
                        <label className="text-[10px] font-bold uppercase text-zinc-500">Title</label>
                        <input placeholder="e.g. Ariel Reading" value={newSlotData.title} onChange={e => setNewSlotData({...newSlotData, title: e.target.value})} className="w-full bg-zinc-950 border border-white/10 rounded p-2 text-sm focus:border-blue-500 outline-none text-white" />
                    </div>
                    <div>
                        <label className="text-[10px] font-bold uppercase text-zinc-500">Asset Link (Optional)</label>
                        <input placeholder="https://..." value={newSlotData.link} onChange={e => setNewSlotData({...newSlotData, link: e.target.value})} className="w-full bg-zinc-950 border border-white/10 rounded p-2 text-sm focus:border-blue-500 outline-none text-white" />
                        {newSlotData.link && (
                            <input placeholder="Label (e.g. Sheet Music)" value={newSlotData.label} onChange={e => setNewSlotData({...newSlotData, label: e.target.value})} className="w-full bg-zinc-950 border border-white/10 rounded p-2 text-sm mt-2 focus:border-blue-500 outline-none text-white" />
                        )}
                    </div>
                    <div className="flex gap-2 pt-2">
                        <button type="button" onClick={() => setIsAddingSlot(false)} className="flex-1 py-3 bg-zinc-800 rounded-lg text-xs font-bold uppercase hover:bg-zinc-700">Cancel</button>
                        <button type="submit" className="flex-1 py-3 bg-blue-600 rounded-lg text-xs font-bold uppercase hover:bg-blue-500 text-white">Create Slot</button>
                    </div>
                </form>
            </div>
        )}

        {/* MODAL: PARTNER MATCHER (With Role Logic) */}
        {pairingSlotId && (
            <PartnerMatcher 
                slot={slots.find(s => s.id === pairingSlotId)!}
                students={students}
                onClose={() => setPairingSlotId(null)}
                onSave={(updatedSlot) => {
                    setSlots(prev => prev.map(s => s.id === updatedSlot.id ? updatedSlot : s));
                }}
            />
        )}

        {/* MODAL: INSPECTOR */}
        {inspectingStudent && (
             <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setInspectingStudent(null)}>
                 <div className="bg-zinc-900 border border-white/10 rounded-2xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
                     <div className="p-6 pb-4 border-b border-white/5 flex gap-4 items-start">
                         <img src={inspectingStudent.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-20 h-20 rounded-xl object-cover bg-zinc-800" />
                         <div className="flex-1">
                             <h2 className="text-2xl font-black uppercase italic leading-none">{inspectingStudent.name}</h2>
                             <p className="text-zinc-500 text-xs font-bold uppercase mt-1">Age {inspectingStudent.age} â€¢ {inspectingStudent.gender}</p>
                             <div className="flex gap-2 mt-3">
                                <div className="bg-blue-900/30 text-blue-300 px-3 py-1 rounded text-xs font-bold">Vocal: {inspectingStudent.breakdown.vocal || '-'}</div>
                                <div className="bg-purple-900/30 text-purple-300 px-3 py-1 rounded text-xs font-bold">Dance: {inspectingStudent.breakdown.dance || '-'}</div>
                                <div className="bg-emerald-900/30 text-emerald-300 px-3 py-1 rounded text-xs font-bold">Act: {inspectingStudent.breakdown.acting || '-'}</div>
                             </div>
                         </div>
                         <button onClick={() => setInspectingStudent(null)} className="p-2 bg-zinc-800 rounded-full hover:bg-zinc-700 text-zinc-400"><X size={20}/></button>
                     </div>
                     <div className="p-6 overflow-y-auto space-y-6 custom-scrollbar">
                        <div className="bg-red-900/10 border border-red-500/20 p-4 rounded-xl">
                            <h3 className="text-red-400 font-black uppercase text-xs tracking-widest flex items-center gap-2 mb-2"><Calendar size={14} /> Conflicts</h3>
                            <p className="text-zinc-300 text-sm leading-relaxed">{inspectingStudent.conflicts}</p>
                        </div>
                        <div className="space-y-4">
                            {inspectingStudent.notes.vocal && <div><h4 className="text-xs font-bold uppercase text-zinc-500 mb-1 flex items-center gap-2"><Mic size={12}/> Music Notes</h4><p className="text-sm text-zinc-300 bg-zinc-950 p-3 rounded-lg border border-white/5">{inspectingStudent.notes.vocal}</p></div>}
                            {inspectingStudent.notes.acting && <div><h4 className="text-xs font-bold uppercase text-zinc-500 mb-1 flex items-center gap-2"><Theater size={12}/> Acting Notes</h4><p className="text-sm text-zinc-300 bg-zinc-950 p-3 rounded-lg border border-white/5">{inspectingStudent.notes.acting}</p></div>}
                            {inspectingStudent.notes.dance && <div><h4 className="text-xs font-bold uppercase text-zinc-500 mb-1 flex items-center gap-2"><Move size={12}/> Choreography Notes</h4><p className="text-sm text-zinc-300 bg-zinc-950 p-3 rounded-lg border border-white/5">{inspectingStudent.notes.dance}</p></div>}
                            {inspectingStudent.notes.admin && <div><h4 className="text-xs font-bold uppercase text-zinc-500 mb-1 flex items-center gap-2"><AlertTriangle size={12}/> Admin Notes</h4><p className="text-sm text-zinc-300 bg-zinc-950 p-3 rounded-lg border border-white/5">{inspectingStudent.notes.admin}</p></div>}
                        </div>
                     </div>
                 </div>
             </div>
        )}
    </div>
  );
}
</file>

<file path="app/(casting)/casting/page.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import React, { useState, useEffect, useMemo } from 'react';
import { Loader2 } from 'lucide-react';
import { getRoles, getAuditionSlots, getScenes, updateRole } from '@/app/lib/baserow'; 

// Import your components
import CastWorkspace from '@/app/components/casting/CastWorkspace';
import ChemistryWorkspace from '@/app/components/casting/ChemistryWorkspace';
import CastingInspector from '@/app/components/casting/CastingInspector';

// --- CONFIG ---
const TARGET_SHOW_STRING = "Little Mermaid"; 

export default function CastingPage() {
  // --- STATE ---
  const [loading, setLoading] = useState(true);
  const [viewMode, setViewMode] = useState<'workspace' | 'chemistry'>('workspace');
  
  // Data Containers
  const [roles, setRoles] = useState<any[]>([]);
  const [actors, setActors] = useState<any[]>([]);
  const [scenes, setScenes] = useState<any[]>([]);
  
  // UI State
  const [inspectingActorId, setInspectingActorId] = useState<number | null>(null);

  // --- 1. DATA LOADING ---
  useEffect(() => {
    async function load() {
        try {
            const [roleRows, auditionRows, sceneRows] = await Promise.all([
                getRoles(), 
                getAuditionSlots(),
                getScenes()
            ]);

            // Filter for current show
            const showRoles = roleRows.filter((r: any) => {
                const s = r["Master Show Database"]?.[0]?.value || "";
                return s.includes(TARGET_SHOW_STRING) || s.includes("Mermaid");
            });

            // Process Scenes (Sort by Act/Scene)
            const sortedScenes = sceneRows
                .filter((s: any) => s["Production"]?.[0]?.value?.includes(TARGET_SHOW_STRING) || s["Production"]?.[0]?.value?.includes("Mermaid"))
                .sort((a: any, b: any) => a.id - b.id);

            // Process Actors
            const showActors = auditionRows
                .filter((a: any) => {
                     const p = a["Production"]?.[0]?.value || "";
                     return p.includes(TARGET_SHOW_STRING) || p.includes("Mermaid");
                })
                .map((a: any) => ({
                    ...a,
                    // Normalize fields for the components
                    id: a.id, 
                    personId: a["Performer"]?.[0]?.id,
                    Performer: a["Performer"]?.[0]?.value || "Unknown",
                    Headshot: a["Headshot"]?.[0]?.url || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png",
                    grades: {
                        actingNotes: a["Acting Notes"],
                        vocalNotes: a["Music Notes"],
                        danceNotes: a["Choreography Notes"]
                    }
                }));

            // Process Roles (Hydrate with Actor Objects)
            const processedRoles = showRoles.map((r: any) => {
                
                // *** FIX: Use "Active Scenes" Link Field instead of "Scene Data" JSON ***
                let sceneIds: number[] = [];
                if (r["Active Scenes"] && Array.isArray(r["Active Scenes"])) {
                    sceneIds = r["Active Scenes"].map((s: any) => s.id);
                }

                // Get Assigned Actor (Confirmed)
                const assignedId = r["Assigned Actor"]?.[0]?.id; // This is PersonID
                
                // Find the actor object using PersonID
                const assignedActor = showActors.find((a: any) => a.personId === assignedId);

                return {
                    id: r.id,
                    name: r["Role Name"] || r.Name,
                    type: r["Role Type"]?.value || "Ensemble",
                    // Candidates: Start with just the assigned actor if any
                    actors: assignedActor ? [assignedActor] : [],
                    // Selected: The confirmed cast member
                    selectedActorIds: assignedActor ? [assignedActor.id] : [], // Use Audition ID for UI
                    selectedActorId: assignedActor ? assignedActor.id : null, // For Chemistry (Single)
                    sceneIds: sceneIds
                };
            });

            setRoles(processedRoles);
            setActors(showActors);
            setScenes(sortedScenes);

        } catch (e) {
            console.error("Load failed:", e);
        } finally {
            setLoading(false);
        }
    }
    load();
  }, []);

  // --- 2. EVENT HANDLERS ---

  // Handle Drag & Drop: Add candidate to role
  const handleDropActor = (e: React.DragEvent, roleId: string) => {
    e.preventDefault();
    const actorId = parseInt(e.dataTransfer.getData("actorId"));
    if (!actorId) return;

    const actor = actors.find(a => a.id === actorId);
    if (!actor) return;

    setRoles(prev => prev.map(role => {
        if (role.id.toString() !== roleId.toString()) return role;
        // Don't add if already there
        if (role.actors.find((a: any) => a.id === actor.id)) return role;
        return { ...role, actors: [...role.actors, actor] };
    }));
  };

  const handleRemoveActor = (roleId: string, actorId: number) => {
      setRoles(prev => prev.map(role => {
          if (role.id.toString() !== roleId.toString()) return role;
          return {
              ...role,
              actors: role.actors.filter((a: any) => a.id !== actorId),
              selectedActorIds: role.selectedActorIds.filter((id: number) => id !== actorId),
              selectedActorId: role.selectedActorId === actorId ? null : role.selectedActorId
          };
      }));
  };

  // Confirm Casting (Save to DB)
  const handleConfirmRole = async (roleId: string, actorId: number) => {
      const role = roles.find(r => r.id.toString() === roleId.toString());
      if (!role) return;

      const actor = actors.find(a => a.id === actorId);
      if (!actor) return;

      const isSelecting = !role.selectedActorIds.includes(actorId);

      // UI Update
      setRoles(prev => prev.map(r => {
          if (r.id.toString() !== roleId.toString()) return r;
          
          // Toggle selection
          let newSelected = r.selectedActorIds;
          if (isSelecting) newSelected = [...newSelected, actorId]; // Allow multi-cast for now?
          else newSelected = newSelected.filter((id: number) => id !== actorId);

          return { 
              ...r, 
              selectedActorIds: isSelecting ? [actorId] : [], // Forcing Single Cast for now to match DB
              selectedActorId: isSelecting ? actorId : null 
          };
      }));

      // DB Update
      // Note: Baserow expects Person ID, not Audition ID.
      try {
          const payload = isSelecting ? { "Assigned Actor": [actor.personId] } : { "Assigned Actor": [] };
          await updateRole(parseInt(roleId), payload);
      } catch (err) {
          alert("Failed to save assignment to database.");
          console.error(err);
      }
  };

  const handleToggleScene = async (roleId: string, sceneId: number) => {
      // 1. Update Local State
      let newSceneIds: number[] = [];
      setRoles(prev => prev.map(r => {
          if (r.id.toString() !== roleId.toString()) return r;
          
          if (r.sceneIds.includes(sceneId)) {
              newSceneIds = r.sceneIds.filter((id: number) => id !== sceneId);
          } else {
              newSceneIds = [...r.sceneIds, sceneId];
          }
          return { ...r, sceneIds: newSceneIds };
      }));

      // 2. Save to Baserow 
      // *** FIX: Update the Link Field with an ARRAY OF IDs, not a JSON string ***
      await updateRole(parseInt(roleId), { "Active Scenes": newSceneIds });
  };

  const handleDuplicateRole = async (roleId: string) => {
     alert("Feature: Duplicate Role " + roleId);
  };
  
  const handleRemoveRole = async (roleId: string) => {
     if(confirm("Remove this role?")) {
         // Add DB delete logic here
         setRoles(prev => prev.filter(r => r.id.toString() !== roleId.toString()));
     }
  };

  // --- 3. DERIVED DATA FOR INSPECTOR ---
  const inspectorActor = useMemo(() => {
      if (!inspectingActorId) return null;
      return actors.find(a => a.id === inspectingActorId);
  }, [inspectingActorId, actors]);

  const inspectorStats = useMemo(() => {
      // Create a map of { sceneId: "Role Name + Role Name" } for the conflict checker
      const assignments: Record<number, string> = {};
      
      roles.forEach(role => {
          if (role.selectedActorIds.includes(inspectingActorId)) {
              role.sceneIds.forEach((sid: number) => {
                  assignments[sid] = assignments[sid] ? `${assignments[sid]} + ${role.name}` : role.name;
              });
          }
      });

      return {
          assignments, // Scenes this actor is in
          assignedRoleNames: roles.filter(r => r.selectedActorIds.includes(inspectingActorId)).map(r => r.name)
      };
  }, [roles, inspectingActorId]);


  if (loading) return <div className="h-screen bg-zinc-950 flex items-center justify-center text-white"><Loader2 className="animate-spin text-blue-500"/></div>;

  return (
    <div className="h-screen flex flex-col bg-zinc-950 text-white overflow-hidden">
        
        {/* TOP BAR */}
        <header className="h-14 border-b border-white/10 flex items-center justify-between px-4 bg-zinc-900 shrink-0 z-20">
            <div className="flex gap-4">
                 <button 
                    onClick={() => setViewMode('workspace')}
                    className={`text-xs font-black uppercase tracking-widest px-3 py-1.5 rounded transition-all ${viewMode === 'workspace' ? 'bg-white text-black' : 'text-zinc-500 hover:text-white'}`}
                 >
                    Workspace
                 </button>
                 <button 
                    onClick={() => setViewMode('chemistry')}
                    className={`text-xs font-black uppercase tracking-widest px-3 py-1.5 rounded transition-all ${viewMode === 'chemistry' ? 'bg-purple-600 text-white' : 'text-zinc-500 hover:text-purple-400'}`}
                 >
                    Chemistry
                 </button>
            </div>
            
            {/* ACTOR DRAWER (Sidebar Source) */}
            <div className="flex items-center gap-2 overflow-x-auto max-w-[50vw] no-scrollbar">
                 <span className="text-[9px] font-bold text-zinc-600 uppercase mr-2 shrink-0">Cast Drawer:</span>
                 {actors.map(actor => (
                     <div 
                        key={actor.id}
                        draggable
                        onDragStart={(e) => e.dataTransfer.setData("actorId", actor.id.toString())}
                        onClick={() => setInspectingActorId(actor.id)}
                        className={`w-8 h-8 rounded-full border border-white/10 shrink-0 overflow-hidden cursor-grab active:cursor-grabbing hover:border-blue-500 transition-colors
                            ${inspectingActorId === actor.id ? 'ring-2 ring-blue-500' : ''}
                        `}
                        title={actor.Performer}
                     >
                        <img src={actor.Headshot} className="w-full h-full object-cover" />
                     </div>
                 ))}
            </div>
        </header>

        <div className="flex-1 overflow-hidden relative flex">
            {/* MAIN WORKSPACE */}
            <div className="flex-1 relative z-0 h-full">
                {viewMode === 'workspace' ? (
                    <CastWorkspace 
                        roles={roles}
                        scenes={scenes}
                        onAddRole={() => alert("Add Role logic")}
                        onRemoveRole={handleRemoveRole}
                        onDuplicateRole={handleDuplicateRole}
                        onDropActor={handleDropActor}
                        onRemoveActor={handleRemoveActor}
                        onToggleScene={handleToggleScene}
                        onSelectRole={(r) => { /* Optional: Highlight logic */ }}
                        onConfirmRole={(rId, aId) => handleConfirmRole(rId, aId)}
                    />
                ) : (
                    <ChemistryWorkspace 
                        roles={roles}
                        onDropActor={handleDropActor}
                        onRemoveActor={handleRemoveActor}
                        onSelectRole={() => {}}
                        onConfirmRole={(rId, aId) => handleConfirmRole(rId, aId)}
                    />
                )}
            </div>

            {/* INSPECTOR (Right Sidebar) */}
            {inspectingActorId && (
                <CastingInspector 
                    actor={inspectorActor}
                    allScenes={scenes}
                    stats={inspectorStats}
                    onClose={() => setInspectingActorId(null)}
                />
            )}
        </div>

    </div>
  );
}
</file>

<file path="app/(casting)/layout.tsx">
import CastingSidebar from '@/components/CastingSidebar'; // The one you already have

export default function CastingLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="flex h-screen">
      <CastingSidebar /> 
      <main className="flex-1 overflow-auto bg-zinc-900/50">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="app/(staff)/committees/page.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import React, { useState, useEffect, useMemo } from 'react';
import { 
  Printer, Loader2, Crown, Phone, Mail, ShieldAlert, Baby, 
  Wand2, RotateCcw, ChevronDown, ChevronUp, AlertTriangle, AlertCircle // <--- Added here
} from 'lucide-react';
import { getCommitteePreferences, getAuditionSlots } from '@/app/lib/baserow'; 

// --- CONFIG ---
const COMMITTEES = {
    'Pre-Show': [
        "Publicity", "Sets", "Set Dressing", "Raffles", "Green Room", 
        "Costumes", "Props", "Makeup", "Hair", "Tech"
    ],
    'Show Week': [
        "Raffles", "Green Room", "Costumes", "Props", "Makeup", "Hair", 
        "Tech", "Ninjas/Set Movers", "Box Office", "Concessions", "Security"
    ]
};

const MIN_STAFFING = 2; 

export default function CommitteeDashboard() {
  const [rawData, setRawData] = useState<any[]>([]);
  const [students, setStudents] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [assignments, setAssignments] = useState<Record<string, string>>({});
  const [history, setHistory] = useState<Record<string, string>>({}); 
  const [groupBy, setGroupBy] = useState<'Pre-Show' | 'Show Week'>('Pre-Show');
  const [expandedCard, setExpandedCard] = useState<number | null>(null);

  useEffect(() => {
    async function loadData() {
        try {
            const [prefData, studentData] = await Promise.all([
                getCommitteePreferences(),
                getAuditionSlots()
            ]);
            
            const processed = prefData.map((p: any) => {
                const age = parseInt(p["Age"] || "0"); 
                const chairInterests = p["Chair Interest"]?.map((c: any) => c.value) || [];
                
                // ROBUST NAME FINDER: Checks all common column names
                const pName = p["Parent Name"] || p["Parent/Guardian Name"] || p["Full Name"] || p["First and Last Name"] || p["Name"] || "Unknown Volunteer";

                return {
                    ...p,
                    id: p.id,
                    preShow1: p["Pre-Show 1st"]?.value,
                    preShow2: p["Pre-Show 2nd"]?.value,
                    preShow3: p["Pre-Show 3rd"]?.value,
                    showWeek1: p["Show Week 1st"]?.value,
                    showWeek2: p["Show Week 2nd"]?.value,
                    showWeek3: p["Show Week 3rd"]?.value,
                    chairInterests: chairInterests,
                    
                    // Handle Student ID (Number or String)
                    studentIdLink: parseInt(p["Student ID"]) || null,
                    
                    parentName: pName, 
                    email: p["Email"] || "",
                    phone: p["Phone"] || "",
                    notes: p["Notes/Constraints"] || "",
                    
                    age: age,
                    isAdult: age >= 18,
                    isParent: !!p["Student ID"], // True if ID exists
                    bgStatus: p["Background Check Status"]?.value || "Pending", 
                };
            });

            const initialAssignments: Record<string, string> = {};
            processed.forEach((p: any) => {
                 if (p.preShow1) initialAssignments[`pre-${p.id}`] = p.preShow1;
                 if (p.showWeek1) initialAssignments[`show-${p.id}`] = p.showWeek1;
            });

            setRawData(processed);
            setStudents(studentData);
            setAssignments(initialAssignments);
            setHistory(initialAssignments);
        } catch (error) {
            console.error("Failed to load dashboard:", error);
        } finally {
            setLoading(false);
        }
    }
    loadData();
  }, []); 

  // --- HELPERS ---

  const getLinkedStudentName = (linkId: number) => {
      if (!linkId) return null;
      
      // 1. Find the Student Record
      const match = students.find(s => s.id === linkId || s["Student ID"] === linkId);
      if (!match) return null;

      // 2. Extract Name (Handles Array or String)
      if (Array.isArray(match["Performer"])) {
          return match["Performer"][0]?.value;
      }
      return match["Performer"]?.value || match["Full Name"] || match["Name"] || "Unknown Student";
  };

  const handleAutoBalance = () => {
      if(!confirm("Auto-Balance will move volunteers to their 2nd/3rd choices if their 1st choice is overcrowded. Proceed?")) return;

      const newAssignments = { ...assignments };
      const currentCommittees = COMMITTEES[groupBy];
      let movedCount = 0;

      const getCount = (comm: string) => {
          return rawData.filter(p => {
              const key = groupBy === 'Pre-Show' ? `pre-${p.id}` : `show-${p.id}`;
              return newAssignments[key] === comm;
          }).length;
      };

      currentCommittees.forEach(targetComm => {
          if (getCount(targetComm) < MIN_STAFFING) {
               rawData.forEach(p => {
                   const key = groupBy === 'Pre-Show' ? `pre-${p.id}` : `show-${p.id}`;
                   const currentComm = newAssignments[key];
                   if (currentComm && getCount(currentComm) > MIN_STAFFING) {
                       const c2 = groupBy === 'Pre-Show' ? p.preShow2 : p.showWeek2;
                       const c3 = groupBy === 'Pre-Show' ? p.preShow3 : p.showWeek3;
                       if (c2 === targetComm || c3 === targetComm) {
                           newAssignments[key] = targetComm;
                           movedCount++;
                       }
                   }
               });
          }
      });
      setAssignments(newAssignments);
      alert(`Auto-Balance Complete: Optimized ${movedCount} assignments.`);
  };

  const groupedData = useMemo(() => {
      const groups: Record<string, any[]> = {};
      COMMITTEES[groupBy].forEach(c => groups[c] = []);
      groups["Unassigned"] = [];

      rawData.forEach(p => {
          const key = groupBy === 'Pre-Show' ? `pre-${p.id}` : `show-${p.id}`;
          const assignedVal = assignments[key];
          if (assignedVal && groups[assignedVal]) {
              groups[assignedVal].push(p);
          } else {
              groups["Unassigned"].push(p);
          }
      });
      return groups;
  }, [rawData, assignments, groupBy]);

  if (loading) return <div className="h-screen bg-zinc-950 flex items-center justify-center text-white"><Loader2 className="animate-spin text-blue-500"/></div>;

  return (
    <div className="min-h-screen bg-zinc-950 text-white font-sans p-4 md:p-6 flex flex-col">
        
        {/* HEADER */}
        <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 mb-6 print:hidden">
            <div>
                <h1 className="text-2xl font-black uppercase italic tracking-tighter text-white">Committee Manager</h1>
                <p className="text-zinc-500 text-xs font-medium">{rawData.length} Volunteers â€¢ {groupBy} View</p>
            </div>
            
            <div className="flex flex-wrap gap-2 w-full xl:w-auto">
                <div className="bg-zinc-900 border border-white/10 rounded-lg p-1 flex">
                    <button onClick={() => setGroupBy('Pre-Show')} className={`px-4 py-2 rounded text-xs font-bold uppercase transition-all ${groupBy === 'Pre-Show' ? 'bg-blue-600 text-white shadow-lg' : 'text-zinc-500 hover:text-white'}`}>Pre-Show</button>
                    <button onClick={() => setGroupBy('Show Week')} className={`px-4 py-2 rounded text-xs font-bold uppercase transition-all ${groupBy === 'Show Week' ? 'bg-blue-600 text-white shadow-lg' : 'text-zinc-500 hover:text-white'}`}>Show Week</button>
                </div>

                <button onClick={handleAutoBalance} className="bg-emerald-600/10 hover:bg-emerald-600/20 text-emerald-500 border border-emerald-600/50 px-4 py-2 rounded-lg text-xs font-black uppercase flex items-center gap-2 transition-all">
                    <Wand2 size={14}/> Auto-Balance
                </button>
                <button onClick={() => setAssignments(history)} className="bg-zinc-800 hover:bg-zinc-700 text-zinc-400 px-3 py-2 rounded-lg transition-all" title="Reset">
                    <RotateCcw size={14}/>
                </button>
                <button onClick={() => window.print()} className="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 px-4 py-2 rounded-lg text-xs font-bold uppercase flex items-center gap-2 transition-all">
                    <Printer size={14}/> Print
                </button>
            </div>
        </div>

        {/* PRINT HEADER */}
        <div className="hidden print:block mb-8 text-black">
             <h1 className="text-4xl font-black uppercase mb-2">{groupBy} Assignments</h1>
             <p className="text-sm text-gray-600">Generated from Open Backstage</p>
        </div>

        {/* GRID */}
        <div className="columns-1 md:columns-2 xl:columns-3 gap-6 space-y-6 print:block print:columns-2">
            {Object.keys(groupedData).map(committee => {
                const team = groupedData[committee];
                const isStarving = team.length < MIN_STAFFING && committee !== "Unassigned";
                
                if (team.length === 0 && committee !== "Unassigned") return (
                    <div key={committee} className="break-inside-avoid mb-4 print:hidden opacity-40 hover:opacity-100 transition-opacity">
                         <div className="border border-dashed border-zinc-800 rounded-xl p-3 flex justify-between items-center">
                            <span className="text-zinc-600 font-bold uppercase text-xs">{committee}</span>
                            <span className="text-zinc-700 text-[10px] font-mono">0</span>
                         </div>
                    </div>
                );

                return (
                    <div key={committee} className={`break-inside-avoid mb-6 rounded-xl overflow-hidden border ${isStarving ? 'border-amber-500/50 bg-amber-900/10' : 'border-white/10 bg-zinc-900/40'} print:border-black print:bg-white print:mb-8`}>
                        <div className={`p-3 border-b flex justify-between items-center ${isStarving ? 'border-amber-500/30 bg-amber-500/10' : 'border-white/5 bg-zinc-900'} print:border-b-2 print:border-black print:bg-gray-100`}>
                            <div className="flex items-center gap-2">
                                {isStarving && <AlertTriangle size={14} className="text-amber-500 print:hidden"/>}
                                <h3 className={`font-black uppercase text-sm tracking-wider ${isStarving ? 'text-amber-400' : 'text-zinc-200'} print:text-black`}>{committee}</h3>
                            </div>
                            <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${isStarving ? 'bg-amber-500 text-black' : 'bg-zinc-800 text-zinc-400'} print:bg-black print:text-white`}>
                                {team.length}
                            </span>
                        </div>

                        <div className="divide-y divide-white/5 print:divide-gray-300">
                            {team.map((p: any) => {
                                const isExpanded = expandedCard === p.id;
                                const studentName = getLinkedStudentName(p.studentIdLink);
                                const wantsToChair = p.chairInterests.some((ci: string) => ci.includes(committee));
                                const isMoved = (groupBy === 'Pre-Show' ? p.preShow1 : p.showWeek1) !== committee;

                                return (
                                    <div key={p.id} className="group hover:bg-white/5 transition-colors print:hover:bg-transparent">
                                        <div 
                                            className="p-3 cursor-pointer"
                                            onClick={() => setExpandedCard(isExpanded ? null : p.id)}
                                        >
                                            <div className="flex justify-between items-start">
                                                <div className="flex flex-col">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`font-bold text-sm ${p.isParent ? 'text-zinc-200' : 'text-purple-300'} print:text-black`}>
                                                            {p.parentName}
                                                        </span>
                                                        {wantsToChair && <Crown size={12} className="text-amber-500 fill-amber-500/20" />}
                                                        {isMoved && <span className="text-[8px] border border-zinc-700 text-zinc-500 px-1 rounded uppercase print:border-gray-400">Moved</span>}
                                                    </div>
                                                    
                                                    <div className="flex items-center gap-2 mt-0.5">
                                                        {p.isParent ? (
                                                            studentName ? (
                                                                <span className="text-[10px] text-zinc-500 flex items-center gap-1 print:text-gray-600">
                                                                    <Baby size={10} /> {studentName}
                                                                </span>
                                                            ) : (
                                                                <span className="text-[10px] text-amber-500/80 font-bold uppercase tracking-wide print:text-gray-500 flex items-center gap-1">
                                                                    <AlertCircle size={8}/> Linking...
                                                                </span>
                                                            )
                                                        ) : (
                                                            <span className="text-[10px] text-purple-400/60 font-bold uppercase tracking-wide print:text-gray-500">
                                                                Community
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="print:hidden">
                                                    {isExpanded ? <ChevronUp size={14} className="text-zinc-600"/> : <ChevronDown size={14} className="text-zinc-700 group-hover:text-zinc-500"/>}
                                                </div>
                                            </div>
                                        </div>

                                        {isExpanded && (
                                            <div className="px-3 pb-3 bg-zinc-950/30 shadow-inner border-t border-white/5 print:hidden">
                                                <div className="flex gap-4 py-2 mb-2 border-b border-white/5">
                                                     <a href={`mailto:${p.email}`} className="flex items-center gap-2 text-xs text-blue-400 hover:text-blue-300"><Mail size={12}/> {p.email}</a>
                                                     <a href={`tel:${p.phone}`} className="flex items-center gap-2 text-xs text-blue-400 hover:text-blue-300"><Phone size={12}/> {p.phone}</a>
                                                </div>
                                                
                                                {p.notes && (
                                                    <div className="mb-3 bg-blue-900/10 border border-blue-500/20 p-2 rounded text-[10px] text-blue-200 italic">
                                                        "{p.notes}"
                                                    </div>
                                                )}

                                                <div className="flex items-center gap-2">
                                                    <span className="text-[10px] uppercase font-bold text-zinc-500">Move to:</span>
                                                    <select 
                                                        className="bg-zinc-800 border border-zinc-700 rounded text-xs text-white p-1 outline-none focus:border-blue-500"
                                                        value={committee}
                                                        onChange={(e) => {
                                                            const newAssignments = { ...assignments };
                                                            const key = groupBy === 'Pre-Show' ? `pre-${p.id}` : `show-${p.id}`;
                                                            newAssignments[key] = e.target.value;
                                                            setAssignments(newAssignments);
                                                        }}
                                                    >
                                                        {COMMITTEES[groupBy].map(c => (
                                                            <option key={c} value={c}>{c}</option>
                                                        ))}
                                                    </select>
                                                </div>

                                                <div className="mt-3 grid grid-cols-3 gap-2 text-[10px]">
                                                    <div className="bg-zinc-900 p-1.5 rounded border border-white/5 opacity-50">
                                                        <span className="block text-zinc-500 uppercase text-[8px]">1st Choice</span>
                                                        {groupBy === 'Pre-Show' ? p.preShow1 : p.showWeek1}
                                                    </div>
                                                    <div className="bg-zinc-900 p-1.5 rounded border border-white/5 opacity-50">
                                                        <span className="block text-zinc-500 uppercase text-[8px]">2nd Choice</span>
                                                        {groupBy === 'Pre-Show' ? p.preShow2 : p.showWeek2}
                                                    </div>
                                                    <div className="bg-zinc-900 p-1.5 rounded border border-white/5 opacity-50">
                                                        <span className="block text-zinc-500 uppercase text-[8px]">3rd Choice</span>
                                                        {groupBy === 'Pre-Show' ? p.preShow3 : p.showWeek3}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            })}
        </div>
    </div>
  );
}
</file>

<file path="app/api/upload/route.ts">
import { NextResponse } from 'next/server';
import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';

const s3Client = new S3Client({
  region: process.env.DO_SPACES_REGION || "us-east-1",
  endpoint: process.env.DO_SPACES_ENDPOINT,
  credentials: {
    accessKeyId: process.env.DO_SPACES_KEY || "",
    secretAccessKey: process.env.DO_SPACES_SECRET || "",
  },
});

export async function POST(request: Request) {
  try {
    const { filename, fileType } = await request.json();

    // 1. Create a unique file name (e.g., 17156223-video.mp4)
    const uniqueFilename = `${Date.now()}-${filename.replace(/\s/g, '-')}`;

    // 2. Prepare the command
    const command = new PutObjectCommand({
      Bucket: process.env.DO_SPACES_BUCKET,
      Key: uniqueFilename,
      ContentType: fileType,
      ACL: 'public-read', // Makes the video viewable by your staff
    });

    // 3. Generate the Pre-Signed URL (Valid for 60 seconds)
    const uploadUrl = await getSignedUrl(s3Client, command, { expiresIn: 60 });

    // 4. Construct the final public URL for Baserow
    const publicUrl = `${process.env.DO_SPACES_ENDPOINT}/${process.env.DO_SPACES_BUCKET}/${uniqueFilename}`;

    return NextResponse.json({ uploadUrl, publicUrl });
  } catch (error) {
    console.error("Presign Error:", error);
    return NextResponse.json({ error: "Failed to sign URL" }, { status: 500 });
  }
}
</file>

<file path="app/components/casting/CastingInspector.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import { useState } from "react";
import { X, CheckCircle2, Mic2, Move, FileText, ExternalLink, Clock } from "lucide-react";
import ActorProfileModal from "@/app/components/ActorProfileModal";

// Helper to generate consistent colors for roles
const getRoleColor = (roleName: string) => {
  if (!roleName) return "bg-zinc-800 border-zinc-700";
  const name = roleName.toLowerCase();
  if (name.includes("ariel") || name.includes("lead")) return "bg-blue-500 border-blue-400 shadow-[0_0_10px_rgba(59,130,246,0.4)]";
  if (name.includes("ursula") || name.includes("villain")) return "bg-purple-600 border-purple-400 shadow-[0_0_10px_rgba(147,51,234,0.4)]";
  if (name.includes("ensemble")) return "bg-emerald-600 border-emerald-400";
  if (name.includes("new role")) return "bg-amber-600 border-amber-400";
  // Default hash-like fallback
  const colors = [
    "bg-cyan-600 border-cyan-400", 
    "bg-indigo-600 border-indigo-400", 
    "bg-pink-600 border-pink-400",
    "bg-lime-600 border-lime-400"
  ];
  return colors[roleName.length % colors.length];
};

export default function CastingInspector({ actor, allScenes, stats, onClose }: any) {
  const [showFullProfile, setShowFullProfile] = useState(false);

  if (!actor) return null;

  return (
    <>
      {/* MOBILE: Fixed full screen overlay (z-50)
          DESKTOP: Relative sidebar (z-20) 
      */}
      <div className="fixed inset-0 md:static md:inset-auto z-50 md:z-20 w-full md:w-[350px] h-full flex flex-col bg-zinc-900 md:border-l border-white/5 shadow-2xl transition-all">
        
        {/* HEADER */}
        <div className="p-6 pb-4 border-b border-white/5 relative bg-zinc-900 z-10 shrink-0">
          <button onClick={onClose} className="absolute top-4 right-4 text-zinc-500 hover:text-white transition-colors p-2 bg-black/20 rounded-full md:bg-transparent"><X size={20} /></button>
          
          <div className="flex items-start gap-4">
             <div className="w-16 h-16 rounded-full overflow-hidden border-2 border-white/10 shrink-0">
               <img src={actor.Headshot} className="w-full h-full object-cover" />
             </div>
             <div>
                <h2 className="text-lg font-black text-white leading-tight">{actor.Performer}</h2>
                <div className="flex items-center gap-2 mt-1">
                    {actor.Gender && actor.Gender !== "N/A" && (
                        <span className="px-2 py-0.5 bg-zinc-800 text-zinc-400 text-[10px] font-bold uppercase rounded border border-white/5">{actor.Gender}</span>
                    )}
                    <span className="px-2 py-0.5 bg-zinc-800 text-zinc-400 text-[10px] font-bold uppercase rounded border border-white/5">{actor.Age || "Age ?"}</span>
                </div>
                <div className="flex gap-2 mt-3">
                   {actor.grades?.actingNotes && <FileText size={14} className="text-blue-500" title="Has Acting Notes" />}
                   {actor.grades?.vocalNotes && <Mic2 size={14} className="text-purple-500" title="Has Vocal Notes" />}
                   {actor.grades?.danceNotes && <Move size={14} className="text-emerald-500" title="Has Dance Notes" />}
                </div>
             </div>
          </div>
        </div>

        {/* SCROLLABLE TIMELINE BODY */}
        <div className="flex-1 overflow-y-auto custom-scrollbar relative bg-zinc-950/50">
            {/* Timeline Line */}
            <div className="absolute left-[27px] top-0 bottom-0 w-px bg-white/5 z-0" />

            <div className="p-4 space-y-1 relative z-10">
                 {allScenes.map((scene: any) => {
                     const roleInScene = stats.assignments[scene.id];
                     const isCast = !!roleInScene;
                     const isConflict = roleInScene && roleInScene.includes('+'); 
                     const dotColor = isConflict ? "bg-red-500 border-red-400 animate-pulse" : getRoleColor(roleInScene);

                     return (
                         <div 
                            key={scene.id} 
                            className={`group flex items-center gap-3 py-2 px-2 rounded-lg transition-all
                                ${isCast ? 'bg-zinc-800/80 border border-white/10 my-1 shadow-sm' : 'opacity-40 hover:opacity-80 hover:bg-white/5'}`
                            }
                         >
                             <div className="w-8 flex flex-col items-end shrink-0">
                                 <span className={`text-[9px] font-black uppercase ${isCast ? 'text-white' : 'text-zinc-600'}`}>{scene.Act}</span>
                             </div>

                             <div className={`w-3 h-3 rounded-full border-2 shrink-0 transition-transform ${isCast ? dotColor : 'bg-zinc-900 border-zinc-700'}`} />

                             <div className="min-w-0 flex-1">
                                 <div className="flex justify-between items-baseline">
                                     <p className={`text-xs font-bold truncate ${isCast ? 'text-zinc-200' : 'text-zinc-500'}`}>{scene["Scene Name"]}</p>
                                     {!isCast && <span className="text-[9px] text-zinc-700 uppercase hidden group-hover:block">{scene["Scene Type"]}</span>}
                                 </div>
                                 
                                 {isCast && (
                                     <div className="flex items-center gap-1.5 mt-0.5 animate-in slide-in-from-left-2 duration-300">
                                         <span className={`text-[9px] font-black uppercase px-1.5 rounded-sm bg-zinc-950 text-white border border-white/5 truncate max-w-full ${isConflict ? 'text-red-400 border-red-500/30' : ''}`}>
                                            {roleInScene}
                                         </span>
                                         {isConflict && <Clock size={10} className="text-red-500" />}
                                     </div>
                                 )}
                             </div>
                         </div>
                     );
                 })}
            </div>
            <div className="h-20" />
        </div>

        {/* FOOTER ACTIONS */}
        <div className="p-4 border-t border-white/5 bg-zinc-900 z-20 shrink-0 space-y-3 pb-safe">
             {stats.assignedRoleNames.length > 0 && (
                <div className="flex flex-wrap gap-1.5 pb-2">
                    {stats.assignedRoleNames.map((role: string) => (
                        <span key={role} className="text-[9px] font-bold text-zinc-300 bg-zinc-800 px-2 py-1 rounded border border-white/5 flex items-center gap-1">
                            <div className={`w-1.5 h-1.5 rounded-full ${getRoleColor(role).split(' ')[0]}`} />
                            {role}
                        </span>
                    ))}
                </div>
             )}

            <button 
                onClick={() => setShowFullProfile(true)}
                className="w-full flex items-center justify-center gap-2 py-3 bg-white text-black text-xs font-black uppercase tracking-widest rounded-xl hover:scale-[1.02] active:scale-[0.98] transition-all"
            >
                <ExternalLink size={14} />
                View Full Profile
            </button>
        </div>

      </div>

      {/* MODAL (Now matches Callback Logic EXACTLY) */}
      {showFullProfile && (
        <ActorProfileModal 
          actor={{
            ...actor,
            name: actor.Performer,  // Modal expects 'name', we have 'Performer'
            avatar: actor.Headshot, // Modal expects 'avatar', we have 'Headshot'
          }}
          grades={actor.grades} 
          onClose={() => setShowFullProfile(false)}
        />
      )}
    </>
  );
}
</file>

<file path="app/components/casting/CastWorkspace.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import { Plus, Trash2, X, Copy } from "lucide-react";

interface Props {
  roles: any[];
  scenes: any[];
  onAddRole: () => void;
  onRemoveRole: (id: string) => void;
  onDuplicateRole: (id: string) => void;
  onDropActor: (e: React.DragEvent, roleId: string) => void;
  onRemoveActor: (roleId: string, actorId: number) => void;
  onToggleScene: (roleId: string, sceneId: number) => void;
  onSelectRole: (role: any) => void;
  onConfirmRole: (roleId: string, actorId: number) => void;
}

export default function CastWorkspace({ 
  roles, scenes, onAddRole, onRemoveRole, onDuplicateRole, onDropActor, onRemoveActor, onToggleScene, onSelectRole, onConfirmRole 
}: Props) {

  const safeString = (val: any): string => {
    if (val === null || val === undefined) return "";
    if (typeof val === 'string') return val;
    if (typeof val === 'number') return String(val);
    if (Array.isArray(val)) return val.length > 0 ? safeString(val[0].value || val[0]) : "";
    if (typeof val === 'object') return val.value ? safeString(val.value) : "";
    return String(val);
  };

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  };

  const getSceneColor = (type: string) => {
    const t = String(type).toLowerCase();
    if (t.includes('song')) return 'bg-blue-500 border-blue-400';
    if (t.includes('dance')) return 'bg-purple-500 border-purple-400';
    return 'bg-emerald-600 border-emerald-500'; 
  };

  return (
    <main className="bg-zinc-950 flex flex-col overflow-hidden relative h-full">
      <header className="p-4 border-b border-white/5 bg-zinc-900/80 backdrop-blur-md z-10 flex justify-between items-center shrink-0">
        <div className="flex items-center gap-4">
            <h1 className="text-xl font-black italic uppercase hidden md:block">Cast Grid</h1>
            <div className="flex items-center gap-3 px-3 py-1 bg-zinc-900 rounded-full border border-white/5 overflow-x-auto">
                <div className="flex items-center gap-1.5 shrink-0"><div className="w-2 h-2 rounded-full bg-emerald-500"></div><span className="text-[9px] font-bold text-zinc-400 uppercase">Scene</span></div>
                <div className="flex items-center gap-1.5 shrink-0"><div className="w-2 h-2 rounded-full bg-blue-500"></div><span className="text-[9px] font-bold text-zinc-400 uppercase">Song</span></div>
                <div className="flex items-center gap-1.5 shrink-0"><div className="w-2 h-2 rounded-full bg-purple-500"></div><span className="text-[9px] font-bold text-zinc-400 uppercase">Dance</span></div>
            </div>
        </div>

        <button onClick={onAddRole} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wide transition-all shadow-lg shadow-blue-900/20">
           <Plus size={14} /> <span className="hidden md:inline">Add Role</span>
        </button>
      </header>

      <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
        <div className="space-y-4 pb-20">
            <div className="grid grid-cols-[140px_1fr_30px] md:grid-cols-[280px_1fr_30px] gap-4 mb-2 sticky top-0 z-20 pr-2">
                <div className="bg-zinc-950/80 backdrop-blur-sm rounded-lg"></div> 
                <div className="flex gap-0.5 h-8">
                    {scenes.map((scene, i) => (
                        <div key={scene.id} className="flex-1 min-w-0 group relative bg-zinc-800 border border-white/5 hover:bg-zinc-700 transition-colors cursor-help rounded-sm flex flex-col items-center justify-end pb-1">
                            <span className="text-[9px] font-bold text-zinc-500 group-hover:text-white truncate px-0.5">{i + 1}</span>
                            <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max max-w-[180px] hidden group-hover:block bg-black border border-white/20 text-white text-[10px] p-2 rounded shadow-2xl z-50 pointer-events-none">
                                <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-black border-t border-l border-white/20 rotate-45"></div>
                                <p className="font-bold text-blue-200">{safeString(scene["Scene Name"])}</p>
                                <div className="h-px bg-white/10 my-1"></div>
                                <div className="flex justify-between gap-4 text-[9px] text-zinc-400">
                                    <span>{safeString(scene.Act)}</span>
                                    <span className={`${getSceneColor(safeString(scene["Scene Type"])).split(' ')[0]} bg-clip-text text-transparent font-black uppercase`}>{safeString(scene["Scene Type"])}</span>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
                <div></div> 
            </div>

            {roles.map((role) => (
                <div key={role.id} className="group grid grid-cols-[140px_1fr_30px] md:grid-cols-[280px_1fr_30px] gap-4 p-2 bg-zinc-900/30 border border-white/5 rounded-xl hover:bg-zinc-900 transition-all items-start">
                    
                    {/* LEFT: ROLE CARD */}
                    <div 
                        onDragOver={handleDragOver}
                        onDrop={(e) => onDropActor(e, role.id)}
                        onClick={() => onSelectRole(role)}
                        className={`min-h-[4rem] rounded-lg border-2 border-dashed transition-all cursor-pointer flex flex-col p-2 gap-2 relative
                             ${role.actors.length > 0 ? 'bg-zinc-800 border-white/10' : 'bg-black/20 border-white/5 hover:border-blue-500/50 hover:bg-blue-500/5'}
                             ${role.selectedActorIds.length > 0 ? 'ring-1 ring-purple-500/50' : ''}
                        `}
                    >
                         <div className="flex justify-between items-center mb-1">
                            <span className="text-xs font-black uppercase text-zinc-400 truncate max-w-[120px] md:max-w-[180px]" title={safeString(role.name)}>{safeString(role.name)}</span>
                            <span className="text-[9px] font-bold px-1.5 rounded bg-black/40 text-zinc-500 shrink-0 hidden md:block">{role.sceneIds.length} Scn</span>
                         </div>

                        <div className="flex flex-wrap gap-1.5">
                            {role.actors.length === 0 && <p className="text-[10px] text-zinc-600 italic py-1 w-full text-center hidden md:block">Drag actors here...</p>}
                            
                            {role.actors.map((actor: any) => {
                                const isSelected = role.selectedActorIds.includes(actor.id);
                                return (
                                    <div 
                                        key={actor.id} 
                                        onClick={(e) => { e.stopPropagation(); onConfirmRole(role.id, actor.id); }} 
                                        className={`flex items-center gap-1.5 rounded-full pr-2 pl-1 py-0.5 shadow-sm max-w-full cursor-pointer transition-all border
                                            ${isSelected 
                                                ? 'bg-purple-600 border-purple-400 text-white shadow-lg shadow-purple-900/50' 
                                                : 'bg-zinc-900 border-white/10 text-zinc-400 hover:border-white/30 hover:text-white'
                                            }
                                        `}
                                        title={isSelected ? "Cast (Click to Uncast)" : "Candidate (Click to Cast)"}
                                    >
                                        <img src={actor.Headshot || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-4 h-4 rounded-full object-cover shrink-0" />
                                        <span className="text-[9px] font-bold truncate max-w-[60px] md:max-w-full">{safeString(actor.Performer)}</span>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); onRemoveActor(role.id, actor.id); }}
                                            className={`hover:text-red-400 shrink-0 ${isSelected ? 'text-purple-200' : 'text-zinc-500'}`}
                                        >
                                            <X size={10} />
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* MIDDLE: BARCODE */}
                    <div className="flex gap-0.5 h-auto min-h-[4rem] relative bg-zinc-950/30 p-1 rounded-lg border border-white/5">
                        {scenes.map((scene) => {
                            const isActive = role.sceneIds.includes(scene.id);
                            return (
                                <button
                                    key={scene.id}
                                    onClick={() => onToggleScene(role.id, scene.id)}
                                    className={`flex-1 min-w-0 transition-all rounded-sm relative overflow-hidden border
                                        ${isActive ? `opacity-100 ${getSceneColor(safeString(scene["Scene Type"]))}` : 'bg-zinc-800/30 border-white/5 hover:bg-zinc-700/50 hover:border-white/20'}
                                    `}
                                >
                                    {isActive && <div className="absolute inset-0 bg-gradient-to-b from-white/30 to-transparent"></div>}
                                </button>
                            );
                        })}
                    </div>
                    
                    <div className="flex flex-col gap-1 items-center opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity pt-1">
                         <button onClick={() => onDuplicateRole(role.id)} className="p-1.5 text-zinc-500 hover:text-blue-400 hover:bg-blue-500/10 rounded"><Copy size={14} /></button>
                        <button onClick={() => onRemoveRole(role.id)} className="p-1.5 text-zinc-500 hover:text-red-500 hover:bg-red-500/10 rounded"><Trash2 size={14} /></button>
                    </div>
                </div>
            ))}
        </div>
      </div>
    </main>
  );
}
</file>

<file path="app/components/casting/ChemistryWorkspace.tsx">
"use client";

import { useState } from "react";
import { Users, Filter, X, Check, Ruler, Scale, AlertOctagon, Trophy } from "lucide-react";
import { usePeople } from "@/components/PeopleProvider";
import { Role } from "@/lib/types"; 

// --- ðŸ› ï¸ UTILITIES ---
// Keeps the component clean by moving data extraction logic out
const safeVal = (val: any, fallback: string | number = "-") => {
  if (!val) return fallback;
  if (Array.isArray(val)) return val[0]?.value ?? val[0] ?? fallback;
  if (typeof val === "object") return val.value ?? val.id ?? fallback;
  return val;
};

// Configuration for the metric rows (Easily extensible)
const METRICS = [
  { 
    label: "Score", 
    // Logic: Look for 'grades.vocal' or 'Score'
    getValue: (a: any) => a.grades?.vocal || safeVal(a.Score, 0),
    format: (v: any) => (
      <span className={`px-2 py-1 rounded ${v >= 9 ? 'bg-emerald-500/20 text-emerald-400' : v >= 8 ? 'bg-blue-500/20 text-blue-400' : 'text-zinc-400'}`}>
        {Number(v).toFixed(1)}
      </span>
    )
  },
  { 
    label: "Height", 
    getValue: (a: any) => safeVal(a.Height, "-"),
    format: (v: any) => <div className="flex justify-center items-center gap-1 font-mono text-zinc-400"><Ruler size={10} className="opacity-50" /> {v}</div> 
  },
  { 
    label: "Age", 
    getValue: (a: any) => safeVal(a.Age, "?"),
    format: (v: any) => <span className="text-zinc-400">{v}</span> 
  },
  { 
    label: "Exp", 
    getValue: (a: any) => safeVal(a.Experience, "New"),
    format: (v: any) => <div className="flex justify-center items-center gap-1 text-zinc-400"><Trophy size={10} className="text-amber-500" /> {v}</div> 
  }
];

// --- ðŸ§© SUB-COMPONENT: The Role Card ---
// Handles the logic for a single role comparison
function RoleComparisonCard({ 
  role, 
  onDropActor, 
  onRemoveActor, 
  onConfirmRole 
}: { 
  role: any; // Use Role type + extended props
  onDropActor: (e: React.DragEvent, id: string) => void;
  onRemoveActor: (roleId: string, actorId: number) => void;
  onConfirmRole: (roleId: string, actorId: number) => void;
}) {
  const { getName } = usePeople(); // <--- âš¡ï¸ NEW: Instant Name Hydration
  
  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  };

  return (
    <div 
      onDragOver={handleDragOver}
      onDrop={(e) => onDropActor(e, String(role.id))}
      className="group relative"
    >
      {/* HEADER */}
      <div className="flex items-center gap-3 mb-4 pl-2">
         <h2 className="text-xl md:text-2xl font-black uppercase text-white tracking-tighter italic">{role.name}</h2>
         <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-zinc-800 text-zinc-400 border border-white/5">{role.type}</span>
         <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-zinc-800 text-zinc-500 border border-white/5">{role.actors?.length || 0} Cand.</span>
      </div>

      {/* TABLE CONTAINER */}
      <div className={`rounded-xl border border-white/5 bg-zinc-900/20 overflow-hidden transition-all ${(!role.actors || role.actors.length === 0) ? 'border-dashed border-zinc-800 h-32 flex items-center justify-center' : ''}`}>
        
        {(!role.actors || role.actors.length === 0) ? (
             <div className="text-zinc-600 flex items-center gap-2">
                <Users size={20} />
                <span className="text-xs font-bold uppercase tracking-wider">Drag candidates here</span>
             </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr>
                  <th className="p-4 w-24 md:w-32 bg-zinc-900/50 border-b border-r border-white/5 text-[10px] font-black uppercase text-zinc-500 tracking-wider text-right align-bottom sticky left-0 z-10 backdrop-blur-sm">Candidate</th>
                  {role.actors.map((actor: any) => {
                    const isSelected = role.selectedActorId === actor.id;
                    return (
                      <th key={actor.id} className={`p-4 border-b border-r border-white/5 min-w-[140px] w-[160px] relative group/col ${isSelected ? 'bg-purple-900/10' : ''}`}>
                         {/* HEADSHOT & ACTIONS */}
                         <div className={`relative aspect-[3/4] rounded-lg overflow-hidden border shadow-lg mb-2 transition-all ${isSelected ? 'border-purple-500 ring-2 ring-purple-500/50' : 'border-white/10'}`}>
                            <img src={safeVal(actor.Headshot, "https://placehold.co/400x600/111/444?text=?")} className="w-full h-full object-cover" />
                            <button onClick={() => onRemoveActor(String(role.id), actor.id)} className="absolute top-1 right-1 p-1.5 bg-black/60 text-zinc-400 hover:text-red-400 rounded-full opacity-0 group-hover/col:opacity-100 transition-opacity"><X size={14} /></button>
                            
                            {/* SELECT BUTTON */}
                            <div className={`absolute inset-x-0 bottom-0 p-2 flex justify-center bg-gradient-to-t from-black/80 to-transparent transition-opacity ${isSelected ? 'opacity-100' : 'opacity-0 group-hover/col:opacity-100'}`}>
                                <button onClick={() => onConfirmRole(String(role.id), actor.id)} className={`rounded-full p-1.5 shadow-xl flex items-center gap-1 px-3 ${isSelected ? 'bg-purple-500 text-white' : 'bg-white/20 text-white hover:bg-emerald-500'}`}>
                                    <Check size={14} /> {isSelected && <span className="text-[9px] font-black uppercase">Cast</span>}
                                </button>
                            </div>
                         </div>
                         {/* HYDRATED NAME VIA HOOK */}
                         <div className="text-center">
                            <p className={`text-sm font-black leading-tight ${isSelected ? 'text-purple-300' : 'text-white'}`}>
                                {getName(actor.id)} 
                            </p>
                         </div>
                      </th>
                  )})}
                  <th className="p-4 border-b border-white/5 min-w-[50px] bg-zinc-900/30 border-dashed border-l border-white/10"></th>
                </tr>
              </thead>
              <tbody className="text-xs font-bold text-zinc-300">
                  {/* DYNAMIC METRIC ROWS */}
                  {METRICS.map((metric, i) => (
                      <tr key={i} className="hover:bg-zinc-800/30 transition-colors">
                          <td className="p-3 border-b border-r border-white/5 text-right text-zinc-500 uppercase text-[10px] sticky left-0 bg-zinc-900/90 backdrop-blur-sm z-10">{metric.label}</td>
                          {role.actors.map((actor: any) => (
                              <td key={actor.id} className="p-3 border-b border-r border-white/5 text-center">
                                  {metric.format(metric.getValue(actor))}
                              </td>
                          ))}
                          <td className="border-b border-white/5 bg-zinc-900/30 border-l border-dashed border-white/10"></td>
                      </tr>
                  ))}
                  
                  {/* CONFLICTS (Hard to genericize, kept custom) */}
                  <tr className="bg-red-900/5">
                      <td className="p-3 border-r border-white/5 text-right text-red-500/70 font-black uppercase text-[10px] align-top pt-4 sticky left-0 bg-zinc-900/90 backdrop-blur-sm z-10">Conflicts</td>
                      {role.actors.map((actor: any) => {
                          const conflicts = safeVal(actor.Conflicts, "").split(',').filter((c: string) => c && !c.includes("No known"));
                          return (
                              <td key={actor.id} className="p-3 border-r border-white/5 text-center align-top">
                                  {conflicts.length > 0 ? (
                                      <div className="flex flex-col gap-1 items-center">
                                          {conflicts.map((c: string, i: number) => (
                                              <div key={i} className="flex items-center gap-1 text-[9px] bg-red-500/10 text-red-400 border border-red-500/20 px-1.5 py-0.5 rounded w-fit">
                                                  <AlertOctagon size={8} /> {c}
                                              </div>
                                          ))}
                                      </div>
                                  ) : <span className="text-[10px] text-emerald-500/50 flex items-center justify-center gap-1"><Check size={10}/> Clear</span>}
                              </td>
                          )
                      })}
                      <td className="bg-zinc-900/30 border-l border-dashed border-white/10"></td>
                  </tr>
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}

// --- ðŸš€ MAIN COMPONENT ---
interface Props {
  roles: any[]; // Replace 'any' with your Role type + populated actors
  onDropActor: (e: React.DragEvent, roleId: string) => void;
  onRemoveActor: (roleId: string, actorId: number) => void;
  onSelectRole: (role: any) => void;
  onConfirmRole: (roleId: string, actorId: number) => void;
}

export default function ChemistryWorkspace({ roles, onDropActor, onRemoveActor, onConfirmRole }: Props) {
  const [activeFilter, setActiveFilter] = useState("Lead");

  const visibleRoles = roles.filter(r => 
    activeFilter === "All" || safeVal(r.type).includes(activeFilter)
  );

  return (
    <div className="h-full flex flex-col bg-zinc-950 relative overflow-hidden">
      
      {/* HEADER */}
      <header className="p-4 border-b border-white/5 bg-zinc-900/50 flex flex-col md:flex-row justify-between items-center gap-4 shrink-0">
         <div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
            <h1 className="text-xl font-black italic uppercase flex items-center gap-2">
                <Scale className="text-purple-500" /> Head-to-Head
            </h1>
            
            <div className="flex bg-zinc-900 p-1 rounded-lg border border-white/5 overflow-x-auto max-w-[200px] md:max-w-none scrollbar-hide">
                {["Lead", "Supporting", "Featured", "Ensemble", "All"].map(filter => (
                    <button
                        key={filter}
                        onClick={() => setActiveFilter(filter)}
                        className={`px-3 py-1 text-[10px] font-bold uppercase rounded transition-all whitespace-nowrap ${activeFilter === filter ? 'bg-purple-600 text-white shadow-lg' : 'text-zinc-500 hover:text-zinc-300'}`}
                    >
                        {filter}
                    </button>
                ))}
            </div>
         </div>
      </header>

      {/* COMPARISON STAGE */}
      <div className="flex-1 overflow-x-auto overflow-y-auto p-4 md:p-8 custom-scrollbar bg-zinc-950 space-y-12 pb-24 md:pb-8">
            {visibleRoles.length === 0 && (
                <div className="w-full h-full flex flex-col items-center justify-center text-zinc-600 opacity-50 min-h-[300px]">
                    <Filter size={48} className="mb-4" />
                    <p>No roles match this filter.</p>
                </div>
            )}

            {visibleRoles.map(role => (
               <RoleComparisonCard 
                  key={role.id}
                  role={role}
                  onDropActor={onDropActor}
                  onRemoveActor={onRemoveActor}
                  onConfirmRole={onConfirmRole}
               />
            ))}
      </div>
    </div>
  );
}
</file>

<file path="app/components/GlobalHeader.tsx">
"use client";
import Link from 'next/link';
import { LayoutGrid, LogOut } from 'lucide-react'; // LayoutGrid looks like the "App" button

export default function GlobalHeader() {
  return (
    <header className="h-14 bg-zinc-950 border-b border-white/10 flex items-center justify-between px-4 shrink-0">
      
      {/* LEFT: App Switcher */}
      <div className="flex items-center gap-4">
        <Link 
            href="/" 
            className="flex items-center gap-2 text-zinc-400 hover:text-white transition-colors"
            title="Back to Hub"
        >
            <LayoutGrid size={20} />
            <span className="font-bold text-sm uppercase tracking-wider hidden sm:block">CYT Hub</span>
        </Link>

        {/* Vertical Divider */}
        <div className="h-4 w-px bg-white/10 mx-2" />

        {/* Current Context (Optional - could hook into your Show Context) */}
        <span className="text-zinc-500 text-xs font-mono truncate max-w-[200px]">
            Wizard of Oz (2026)
        </span>
      </div>

      {/* RIGHT: User & Logout */}
      <div className="flex items-center gap-4">
        {/* You can add a user avatar here later */}
        <div className="h-8 w-8 rounded-full bg-blue-600/20 flex items-center justify-center text-blue-400 text-xs font-bold border border-blue-600/30">
            AF
        </div>
        
        <button 
            onClick={() => {
                localStorage.clear();
                window.location.href = "/login";
            }}
            className="text-zinc-500 hover:text-red-400 transition-colors"
            title="Logout"
        >
            <LogOut size={18} />
        </button>
      </div>

    </header>
  );
}
</file>

<file path="app/components/StaffSidebar.tsx">
"use client";
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { HeartHandshake, FileText, ClipboardList } from 'lucide-react'; // Make sure you have these icons or swap them

const STAFF_NAV_ITEMS = [
  { name: 'Committees', href: '/committees', icon: HeartHandshake },
  { name: 'Attendance', href: '/attendance', icon: ClipboardList },
  { name: 'Reports', href: '/reports', icon: FileText },
];

export default function StaffSidebar() {
  const pathname = usePathname();

  return (
    <aside className="hidden md:flex flex-col w-20 lg:w-64 bg-zinc-900 border-r border-white/5 h-screen shrink-0">
      <div className="p-6">
        <h1 className="text-xl font-black italic uppercase text-emerald-500 hidden lg:block">Staff Deck</h1>
        <h1 className="text-xl font-black italic uppercase text-emerald-500 lg:hidden">SD</h1>
      </div>
      
      <nav className="flex-1 px-4 space-y-2">
        {STAFF_NAV_ITEMS.map((item) => {
          const isActive = pathname.startsWith(item.href);
          return (
            <Link 
              key={item.name} 
              href={item.href}
              className={`flex items-center gap-4 p-3 rounded-xl transition-all ${isActive ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/20' : 'text-zinc-400 hover:bg-white/5 hover:text-white'}`}
            >
              <item.icon size={20} />
              <span className="font-bold hidden lg:block">{item.name}</span>
            </Link>
          );
        })}
      </nav>
    </aside>
  );
}
</file>

<file path="app/globals.css">
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}
</file>

<file path="app/lib/CastingContext.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";
import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import { getAuditionees, submitAudition } from './baserow';

// 1. Define the shape of our data to kill the "redlines"
export interface Performer {
  id: number;
  name: string;
  age: number | string;
  height: string;
  dob: string;
  headshotUrl: string | null;
  tenure: string;
  conflicts: string;
  pastRoles: string[];
}

interface CastingContextType {
  performers: Performer[];
  grades: Record<number, any>;
  loading: boolean;
  saveAssessment: (performerId: number, productionId: number, newGrades: any) => Promise<void>;
  refreshData: () => Promise<void>;
}

const CastingContext = createContext<CastingContextType | null>(null);

export function CastingProvider({ children }: { children: React.ReactNode }) {
  const [performers, setPerformers] = useState<Performer[]>([]);
  const [grades, setGrades] = useState<Record<number, any>>({});
  const [loading, setLoading] = useState(true);

  const refreshData = useCallback(async () => {
    setLoading(true);
    try {
      const data = await getAuditionees();
      
      // 2. Map raw Baserow People (599) fields to our App's Performer interface
      const mapped: Performer[] = data.map((row: any) => ({
        id: row.id,
        // Match these exactly to your Baserow field names
        name: row["Full Name"] || "Unnamed Performer",
        age: row["Age"] || "N/A",
        height: row["Height (Feet)"] || "-", 
        dob: row["Date of Birth"] || "",
        headshotUrl: row["Headshot"]?.[0]?.url || null,
        // Status is often a single-select in Baserow, which returns an object
        tenure: typeof row["Status"] === 'object' ? row["Status"]?.value : row["Status"] || "Student",
        conflicts: row["Rehearsal Conflicts"] || "No known conflicts",
        pastRoles: row["Cast/Crew Assignments"] 
          ? row["Cast/Crew Assignments"].map((a: any) => a.value) 
          : [],
      }));

      setPerformers(mapped);
    } catch (e) {
      console.error("Baserow Sync Error:", e);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    refreshData();
  }, [refreshData]);

  // 3. The new "Save" logic that creates a record in the Auditions (630) table
  const saveAssessment = async (performerId: number, productionId: number, newGrades: any) => {
    // Optimistic Update: Show the score in the UI immediately
    setGrades(prev => ({
      ...prev,
      [performerId]: newGrades
    }));

    try {
      // POSTs a new row to the Auditions table
      await submitAudition(performerId, productionId, newGrades);
      console.log(`Audition record created for performer ${performerId}`);
    } catch (e) {
      console.error("Failed to save audition record:", e);
      alert("Error saving to Baserow. Check console.");
    }
  };

  return (
    <CastingContext.Provider value={{ 
      performers, 
      grades, 
      saveAssessment, 
      loading, 
      refreshData 
    }}>
      {children}
    </CastingContext.Provider>
  );
}

export const useCasting = () => {
  const context = useContext(CastingContext);
  if (!context) {
    throw new Error("useCasting must be used within a CastingProvider");
  }
  return context;
};
</file>

<file path="app/plan.md">
# PROJECT: Open Backstage (CYT Fredericksburg)

## 1. CORE MISSION
Build a localized, self-hosted operational dashboard to bypass the limitations of the legacy National website.
**Goal:** Relieve staff burnout, ensure data safety, and create a mobile-friendly "Home Hub" for operations.

## 2. THE TECH STACK
- **Backend:** Self-Hosted Baserow (Docker).
- **Frontend:** React / Next.js (Mobile-first).
- **Payment:** Payment Agnostic. We use external links (Zeffy/Square). We do NOT process credit cards in-app.
- **Hosting:** DigitalOcean (Coolify/Portainer).

## 3. POLITICAL & COMPLIANCE CONSTRAINTS (Non-Negotiable)
1.  **The "National" Wall:** We cannot integrate with the National Website via API. The legacy system is fragile and unmaintained.
2.  **The "CSV" Rule:** We must eventually export data to CSV to satisfy National's royalty/insurance requirements. The National DB is the "Legal Source of Truth." Open Backstage is the "Operational Source of Truth."
3.  **The "Zeffy" Protocol:** We use Zeffy for payments to save fees. We must explicitly warn parents about the "Optional Tip" model.
4.  **No "Shadow" Accounts:** We do not create "new" accounts. We map to the existing National ID (manually if needed) to prevent data fragmentation.

## 4. BRANDING
- **Name:** Open Backstage
- **Metaphor:** "Front of House" is the National Site (Public/Tickets). "Backstage" is our tool (Staff/Operations).
- **Domain:** open-backstage.org

## 5. CURRENT STATUS (Jan 2026)
- **Phase:** Spring Pilot.
- **Scope:** Casting, Class Registration, Payment Tracking, Rosters.
- **Not in Scope:** Automated Emails, Costume Inventory (Push to Summer).
</file>

<file path="app/test-sync/page.tsx">
/* eslint-disable react-hooks/rules-of-hooks */
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import { useState } from 'react';
import { 
  getAuditionees, 
  getSeasonsAndShows, 
  getAuditionSlots, 
  updateAuditionSlot 
} from '@/app/lib/baserow';

export default function TestSyncPage() {
  const [results, setResults] = useState<any>(null);
  const [lastAction, setLastAction] = useState<string>(""); // To track what we pulled
  const [loading, setLoading] = useState(false);
  const [status, setStatus] = useState<string>("Idle");

  // TEST 1: Pull People (Table 599)
  const runPullPeople = async () => {
    setLoading(true);
    setStatus("Pulling People (Table 599)...");
    try {
      const data = await getAuditionees();
      setResults(data);
      setLastAction("people");
      setStatus(`âœ… Success! Loaded ${data.length} people.`);
    } catch (e: any) {
      setResults({ error: e.message });
      setStatus("âŒ Pull Failed");
    } finally {
      setLoading(false);
    }
  };

  // TEST 2: Pull Audition Slots (Table 630)
  const runPullSlots = async () => {
    setLoading(true);
    setStatus("Pulling Audition Slots (Table 630)...");
    try {
      const data = await getAuditionSlots();
      setResults(data);
      setLastAction("slots");
      setStatus(`âœ… Success! Loaded ${data.length} slots.`);
    } catch (e: any) {
      setResults({ error: e.message });
      setStatus("âŒ Pull Failed");
    } finally {
      setLoading(false);
    }
  };

  // TEST 3: Verify Show ID (Table 600)
  const verifyWonkaID = async () => {
    setLoading(true);
    setStatus("Searching for 'Little Mermaid' in Table 600...");
    try {
      const { productions } = await getSeasonsAndShows();
      
      // Note: Baserow usually uses "Title" or "Name". We check both.
      const show = productions.find((p: any) => {
        const name = p.Title || p.Name || "";
        return name.toLowerCase().includes("mermaid");
      });

      if (show) {
        setResults(show);
        setStatus(`âœ… Found it! ID: ${show.id} | Title: ${show.Title || show.Name}`);
      } else {
        setResults({ available_productions: productions });
        setStatus("âŒ Could not find 'Mermaid' in the list.");
      }
    } catch (e: any) {
      setResults({ error: e.message });
      setStatus("âŒ Error fetching productions.");
    } finally {
      setLoading(false);
    }
  };

  // TEST 4: Patch (Table 630)
  const runPatchTest = async () => {
    // Safety Check: Force user to pull SLOTS first
    if (lastAction !== "slots" || !results || !results[0]?.id) {
      alert("âš ï¸ STOP: Please click 'Test PULL (Slots)' first.\n\nWe need a valid Audition Slot ID to patch. Patching a Person ID will break things!");
      return;
    }

    const targetId = results[0].id; // Patch the first slot in the list
    
    setLoading(true);
    setStatus(`Patching Slot #${targetId} (Table 630)...`);
    
    try {
      const testGrades = {
        acting: 5,
        vocal: 5,
        dance: 5,
        notes: "DIAGNOSTIC TEST: " + new Date().toLocaleTimeString()
      };
      
      const response = await updateAuditionSlot(targetId, testGrades);
      setResults(response);
      setStatus("âœ… Patch Successful! Check Baserow for update.");
    } catch (e: any) {
      setResults({ error: e.message });
      setStatus("âŒ Patch Failed");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="p-10 space-y-8 bg-zinc-950 min-h-screen text-white overflow-auto">
      <header>
        <h1 className="text-3xl font-black uppercase italic text-blue-500">Baserow Diagnostics</h1>
        <div className={`mt-2 inline-block px-3 py-1 rounded-full text-xs font-bold ${status.includes('âœ…') ? 'bg-emerald-500/20 text-emerald-400' : 'bg-zinc-800 text-zinc-400'}`}>
          Status: {status}
        </div>
      </header>

      <div className="flex flex-wrap gap-4">
        <button onClick={runPullPeople} disabled={loading} className="px-6 py-3 bg-zinc-800 text-white font-black uppercase text-xs rounded-xl hover:bg-zinc-700 disabled:opacity-50">
          1. Test PULL (People)
        </button>

        <button onClick={runPullSlots} disabled={loading} className="px-6 py-3 bg-white text-black font-black uppercase text-xs rounded-xl hover:bg-zinc-200 disabled:opacity-50">
          2. Test PULL (Slots)
        </button>
        
        <button onClick={runPatchTest} disabled={loading} className="px-6 py-3 bg-blue-600 text-white font-black uppercase text-xs rounded-xl hover:bg-blue-500 disabled:opacity-50">
          3. Test PATCH (First Slot)
        </button>

        <button onClick={verifyWonkaID} disabled={loading} className="px-6 py-3 bg-amber-500 text-black font-black uppercase text-xs rounded-xl hover:bg-amber-400 disabled:opacity-50">
          4. Verify Show ID
        </button>
      </div>

      <div className="bg-black border border-white/10 rounded-2xl p-6">
        <h2 className="text-xs font-bold uppercase text-zinc-500 mb-4 tracking-widest">API Response</h2>
        <pre className="text-[10px] text-blue-300 overflow-auto max-h-[500px] p-4 bg-zinc-900/50 rounded-lg whitespace-pre-wrap font-mono">
          {JSON.stringify(results, null, 2)}
        </pre>
      </div>
    </div>
  );
}
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="LICENSE">
MIT License

Copyright (c) 2025 Austin James Fitzhugh

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="middleware.ts">
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  // 1. Check if user has the "auth_cookie"
  const authCookie = request.cookies.get('cyt_auth');
  const { pathname } = request.nextUrl;

  // 2. If they are already on the login page, let them stay
  if (pathname === '/login') {
    if (authCookie?.value === process.env.APP_PASSWORD) {
      return NextResponse.redirect(new URL('/', request.url));
    }
    return NextResponse.next();
  }

  // 3. If they are trying to access app pages without the cookie, boot them to login
  if (!authCookie || authCookie.value !== process.env.APP_PASSWORD) {
    const loginUrl = new URL('/login', request.url);
    return NextResponse.redirect(loginUrl);
  }

  return NextResponse.next();
}

// Protect these routes
export const config = {
  matcher: ['/', '/auditions/:path*', '/casting/:path*', '/callbacks/:path*'],
};
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="app/(staff)/layout.tsx">
import StaffSidebar from '../components/StaffSidebar'; // A NEW, simpler sidebar

export default function StaffLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="flex h-screen">
      <StaffSidebar /> {/* Contains only: Committees, Roster, Attendance */}
      <main className="flex-1 overflow-auto bg-zinc-900/50">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="lib/CastingContext.tsx">
"use client";
import React, { createContext, useContext, useState } from 'react';
import { Performer, Role, Scene, Assignment, SceneAssignment } from './types';
const generateMockStudents = () => {
  const names = ["James", "Emma", "Liam", "Olivia", "Noah", "Ava", "Lucas", "Mia", "Ethan", "Sophia"];
  const lastNames = ["Smith", "Johnson", "Brown", "Taylor", "Miller", "Wilson", "Moore", "Anderson"];
  const tenures = ["New Student", "1-2 Shows", "3+ Shows"];
  const ranges = ["Soprano", "Alto", "Tenor", "Bass"];
  const songs = ["Part of Your World", "Giants in the Sky", "Tomorrow", "Santa Fe", "On My Own"];

  return Array.from({ length: 80 }).map((_, i) => ({
    id: i + 1,
    name: `${names[i % 10]} ${lastNames[i % 8]}`,
    age: Math.floor(Math.random() * 10) + 8, // Ages 8-18
    vocalRange: ranges[i % 4],
    tenure: tenures[i % 3],
    batch: (i < 30) ? 1 : (i < 60) ? 2 : 3, // Grouped by 30s
    auditionDetails: {
      song: songs[i % 5],
      monologue: i % 2 === 0 ? "Comedic A" : "Dramatic B"
    }
  }));
};
interface CastingContextType {
  performers: Performer[];
  roles: Role[];
  scenes: Scene[];
  assignments: Assignment[];
  sceneAssignments: SceneAssignment[];
  getPerformerStats: (personId: number) => Performer['stats'];
}

const CastingContext = createContext<CastingContextType | undefined>(undefined);

export function CastingProvider({ children }: { children: React.ReactNode }) {
  // Mock Data for Phase 1 - We will replace with Baserow API later
const [performers] = useState(generateMockStudents());
  
  const [scenes] = useState<Scene[]>([
    { id: 101, name: "Kansas", act: 1, weight: 'Medium' },
    { id: 102, name: "Munchkinland", act: 1, weight: 'Large' },
    { id: 201, name: "Emerald City", act: 2, weight: 'Large' }
  ]);

  const [assignments] = useState<Assignment[]>([
    { id: 1, personId: 1, roleId: 501 }
  ]);

  const [sceneAssignments] = useState<SceneAssignment[]>([
    { id: 1, roleId: 501, sceneId: 101 },
    { id: 2, roleId: 501, sceneId: 201 }
  ]);

  const getPerformerStats = (personId: number) => {
    const roles = assignments.filter(a => a.personId === personId).map(a => a.roleId);
    const sceneIds = sceneAssignments.filter(sa => roles.includes(sa.roleId)).map(sa => sa.sceneId);
    const assignedScenes = scenes.filter(s => sceneIds.includes(s.id));

    return {
      sceneCount: assignedScenes.length,
      act1: assignedScenes.some(s => s.act === 1),
      act2: assignedScenes.some(s => s.act === 2)
    };
  };

  return (
    <CastingContext.Provider value={{ performers, roles: [], scenes, assignments, sceneAssignments, getPerformerStats }}>
      {children}
    </CastingContext.Provider>
  );
}

export const useCasting = () => {
  const context = useContext(CastingContext);
  if (!context) throw new Error('useCasting must be used within CastingProvider');
  return context;
};
</file>

<file path="lib/types.ts">
// lib/types.ts

export interface Performer {
  id: number; // Table 599
  name: string;
  age: number;
  headshot?: string; // URL to Baserow file
  vocalRange: string;
  tenure: string; // "New Student", "3+ Shows", etc.
  batch: number; // IMPORTANT: Needed for the Batch 1/2/3 filtering
  auditionDetails?: {
    song: string;
    monologue: string;
  };
  danceLevel?: string;
  stats?: {
    sceneCount: number;
    act1: boolean;
    act2: boolean;
  };
}

export interface Role {
  id: number; // Table 609
  name: string;
  productionId: number;
  isEnsemble: boolean;
}

export interface Scene {
  id: number; // Table 627
  name: string;
  act: 1 | 2;
  weight: 'Small' | 'Medium' | 'Large';
}

export interface Assignment {
  id: number; // Table 603
  personId: number;
  roleId: number;
}

export interface SceneAssignment {
  id: number; // Table 628
  roleId: number;
  sceneId: number;
}
</file>

<file path="next.config.ts">
/** @type {import('next').NextConfig} */
const nextConfig = {
  typescript: {
    // !! WARN !!
    // Dangerously allow production builds to successfully complete even if
    // your project has type errors.
    ignoreBuildErrors: true,
  },
  eslint: {
    // Warning: This allows production builds to successfully complete even if
    // your project has ESLint errors.
    ignoreDuringBuilds: true,
  },
  // Ensure images from external sources (like Baserow) work
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'files.baserow.io', // Or your self-hosted domain
        port: '',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'cdn.pixabay.com',
        port: '',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'open-backstage.org', // Add your self-hosted domain here!
        port: '',
        pathname: '/**',
      },
    ],
  },
};

export default nextConfig;
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="app/components/ActorProfileModal.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import React, { useState, useMemo } from "react";
import { 
  X, Star, History, Calendar, Ruler, AlertCircle, User, 
  AlertOctagon, Clock, Mic2, Move, FileText, Clapperboard, CheckCircle2
} from "lucide-react";
import { 
  Radar, RadarChart, PolarGrid, PolarAngleAxis, 
  ResponsiveContainer, RadarProps 
} from "recharts";

// Fix for Recharts TS error
const RechartsRadar = Radar as unknown as React.FC<RadarProps>;

interface ActorProfileModalProps {
  actor: any;
  grades: any; // Expected keys: actingNotes, vocalNotes, danceNotes, adminNotes
  onClose: () => void;
}

export default function ActorProfileModal({ actor, grades, onClose }: ActorProfileModalProps) {
  const [activeTab, setActiveTab] = useState<"insights" | "history">("insights");

  // --- CHART DATA ---
  const chartData = [
    { subject: "Vocal", A: grades?.vocal || 0 },
    { subject: "Acting", A: grades?.acting || 0 },
    { subject: "Dance", A: grades?.dance || 0 },
    { subject: "Presence", A: grades?.presence || 0 },
  ];

  // --- DATA HELPERS ---
  const getRolesList = (roles: any) => {
    if (!roles) return ["No previous productions listed"];
    if (Array.isArray(roles)) return roles; 
    if (typeof roles === 'string') return roles.split(',').map((s: string) => s.trim());
    return [String(roles)];
  };

  const pastRolesList = getRolesList(actor.pastRoles);

  return (
    <div className="fixed inset-0 z-[200] bg-black/95 backdrop-blur-sm flex items-center justify-center p-0 md:p-4">
      <div className="bg-zinc-950 w-full h-full md:max-w-4xl md:h-[700px] md:rounded-3xl md:border md:border-white/10 overflow-hidden shadow-2xl flex flex-col md:flex-row relative">
        
        {/* CLOSE BUTTON (Mobile: Top Right floating, Desktop: Inside content area) */}
        <button 
            onClick={onClose} 
            className="absolute top-4 right-4 z-50 p-2 bg-black/50 backdrop-blur rounded-full text-zinc-400 hover:text-white md:hidden"
        >
            <X size={24} />
        </button>

        {/* --- LEFT (MOBILE: TOP): IDENTITY & RADAR --- */}
        <div className="p-6 md:p-8 border-b md:border-b-0 md:border-r border-white/5 bg-zinc-900/50 w-full md:w-[35%] flex flex-row md:flex-col items-center md:justify-start gap-6 shrink-0">
          
          {/* Avatar */}
          <div className="relative w-20 h-20 md:w-32 md:h-32 shrink-0">
            {actor.avatar ? (
              <img 
                src={actor.avatar} 
                alt={actor.name} 
                className="w-full h-full object-cover rounded-2xl border-2 border-white/10 shadow-xl"
              />
            ) : (
              <div className="w-full h-full bg-zinc-800 rounded-2xl flex items-center justify-center border-2 border-dashed border-white/10">
                <User size={32} className="text-zinc-600 md:w-12 md:h-12" />
              </div>
            )}
          </div>
          
          <div className="flex-1 md:w-full md:text-center">
              <h2 className="text-xl md:text-2xl font-black italic uppercase tracking-tight leading-tight">{actor.name}</h2>
              
              {/* Vitals Grid */}
              <div className="flex md:grid md:grid-cols-3 gap-2 mt-2 md:mt-6">
                 <div className="bg-black/40 px-3 py-1 md:p-2 rounded-lg text-center border border-white/5">
                    <p className="text-[8px] md:text-[9px] text-zinc-500 font-black uppercase tracking-widest">Height</p>
                    <p className="text-xs font-bold text-white">{actor.height || "-"}</p>
                 </div>
                 <div className="bg-black/40 px-3 py-1 md:p-2 rounded-lg text-center border border-white/5">
                    <p className="text-[8px] md:text-[9px] text-zinc-500 font-black uppercase tracking-widest">Age</p>
                    <p className="text-xs font-bold text-white">{actor.age}</p>
                 </div>
                 <div className="bg-black/40 px-3 py-1 md:p-2 rounded-lg text-center border border-white/5 hidden md:block">
                    <p className="text-[9px] text-zinc-500 font-black uppercase tracking-widest">Range</p>
                    <p className="text-xs font-bold text-white">{actor.vocalRange || "-"}</p>
                 </div>
              </div>
          </div>

          {/* Radar Chart (Hidden on small phones in landscape, visible on portrait/desktop) */}
          <div className="hidden md:block w-full h-40 mt-auto relative">
             <p className="absolute -top-2 w-full text-[9px] text-center text-zinc-500 font-black uppercase tracking-[0.2em]">Live Analysis</p>
             <ResponsiveContainer width="100%" height="100%">
              <RadarChart cx="50%" cy="55%" outerRadius="70%" data={chartData}>
                <PolarGrid stroke="#27272a" />
                <PolarAngleAxis dataKey="subject" tick={{ fill: '#71717a', fontSize: 10, fontWeight: '900' }} />
                <RechartsRadar dataKey="A" stroke="#3b82f6" fill="#3b82f6" fillOpacity={0.4} />
              </RadarChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* --- RIGHT (MOBILE: BOTTOM): CONTENT AREA --- */}
        <div className="flex-1 flex flex-col bg-zinc-950 relative min-w-0 overflow-hidden">
          
          {/* Desktop Close Button */}
          <button onClick={onClose} className="absolute top-6 right-6 text-zinc-500 hover:text-white z-10 transition-colors hidden md:block">
            <X size={20} />
          </button>

          {/* Tabs */}
          <div className="flex border-b border-white/5 p-4 gap-4 shrink-0 bg-zinc-950 sticky top-0 z-10">
            <button 
              onClick={() => setActiveTab("insights")}
              className={`pb-2 text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'insights' ? 'text-white border-b-2 border-blue-500' : 'text-zinc-500 hover:text-zinc-300'}`}
            >
              Casting Insights
            </button>
            <button 
              onClick={() => setActiveTab("history")}
              className={`pb-2 text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'history' ? 'text-white border-b-2 border-blue-500' : 'text-zinc-500 hover:text-zinc-300'}`}
            >
              Bio & Logistics
            </button>
          </div>

          <div className="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar pb-24 md:pb-8">
            {activeTab === "insights" ? (
              <div className="space-y-6 md:space-y-8">
                
                {/* 1. Song & Monologue Info */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="p-3 bg-zinc-900 rounded-xl border border-white/5">
                    <p className="text-[9px] font-black text-purple-400 uppercase mb-1 tracking-tighter">Planned Song</p>
                    <p className="text-xs font-bold text-zinc-300 line-clamp-1">{actor.song}</p>
                  </div>
                  <div className="p-3 bg-zinc-900 rounded-xl border border-white/5">
                    <p className="text-[9px] font-black text-emerald-400 uppercase mb-1 tracking-tighter">Monologue</p>
                    <p className="text-xs font-bold text-zinc-300 line-clamp-1">{actor.monologue}</p>
                  </div>
                </div>

                {/* 2. FEEDBACK GRID */}
                <section>
                   <div className="flex items-center gap-2 text-zinc-400 mb-4">
                    <Star size={14} className="text-blue-500" />
                    <span className="text-[10px] font-black uppercase tracking-widest">Panel Feedback</span>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {/* Acting Notes */}
                    <div className="bg-zinc-900/40 p-4 rounded-xl border border-white/5 hover:bg-zinc-900/60 transition-colors">
                        <div className="flex items-center gap-2 mb-2">
                            <Clapperboard size={12} className="text-blue-400" />
                            <p className="text-[10px] font-bold text-blue-400 uppercase">Director (Acting)</p>
                        </div>
                        <p className="text-xs text-zinc-300 italic leading-relaxed">
                            "{grades?.actingNotes || "No notes logged."}"
                        </p>
                    </div>

                    {/* Vocal Notes */}
                    <div className="bg-zinc-900/40 p-4 rounded-xl border border-white/5 hover:bg-zinc-900/60 transition-colors">
                        <div className="flex items-center gap-2 mb-2">
                            <Mic2 size={12} className="text-purple-400" />
                            <p className="text-[10px] font-bold text-purple-400 uppercase">Musical Director</p>
                        </div>
                        <p className="text-xs text-zinc-300 italic leading-relaxed">
                            "{grades?.vocalNotes || "No notes logged."}"
                        </p>
                    </div>

                    {/* Dance Notes */}
                    <div className="bg-zinc-900/40 p-4 rounded-xl border border-white/5 hover:bg-zinc-900/60 transition-colors">
                        <div className="flex items-center gap-2 mb-2">
                            <Move size={12} className="text-emerald-400" />
                            <p className="text-[10px] font-bold text-emerald-400 uppercase">Choreographer</p>
                        </div>
                        <p className="text-xs text-zinc-300 italic leading-relaxed">
                            "{grades?.choreoNotes || "No notes logged."}"
                        </p>
                    </div>

                    {/* Admin/Drop-In */}
                    <div className="bg-zinc-900/40 p-4 rounded-xl border border-white/5 hover:bg-zinc-900/60 transition-colors">
                        <div className="flex items-center gap-2 mb-2">
                            <FileText size={12} className="text-amber-400" />
                            <p className="text-[10px] font-bold text-amber-400 uppercase">Admin / Drop-In</p>
                        </div>
                        <p className="text-xs text-zinc-300 italic leading-relaxed">
                            "{grades?.adminNotes || "No flags."}"
                        </p>
                    </div>
                  </div>
                </section>

                {/* 3. CONFLICTS DASHBOARD */}
                <section className="pt-2">
                  <h4 className="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                    <AlertCircle size={14} /> Schedule Conflicts
                  </h4>
                  <ConflictAnalyzer conflicts={actor.conflicts} />
                </section>

              </div>
            ) : (
              <div className="space-y-8">
                {/* Bio Details */}
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-zinc-900 p-4 rounded-2xl border border-white/5">
                    <p className="text-[10px] font-black text-zinc-500 uppercase flex items-center gap-2 mb-1">
                      <Calendar size={12} /> Birthdate
                    </p>
                    <p className="text-sm font-bold text-white">{actor.dob || "N/A"}</p>
                  </div>
                  <div className="bg-zinc-900 p-4 rounded-2xl border border-white/5">
                    <p className="text-[10px] font-black text-zinc-500 uppercase flex items-center gap-2 mb-1">
                      <Ruler size={12} /> CYT Experience
                    </p>
                    <p className="text-sm font-bold text-white">{actor.tenure}</p>
                  </div>
                </div>

                {/* History */}
                <section>
                  <h4 className="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                    <History size={14} /> Production History
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {pastRolesList.map((role: string, i: number) => (
                      <div key={i} className="text-[11px] bg-zinc-900 text-zinc-300 px-3 py-2 rounded-lg border border-white/5 font-bold">
                        {role}
                      </div>
                    ))}
                  </div>
                </section>
              </div>
            )}
          </div>

          <div className="p-4 md:p-6 border-t border-white/5 bg-zinc-900/20 shrink-0 absolute bottom-0 w-full md:relative">
            <button 
              onClick={onClose}
              className="w-full bg-white text-black py-4 rounded-2xl font-black uppercase text-[10px] tracking-[0.2em] hover:invert transition-all active:scale-[0.98]"
            >
              Return to Deck
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// --- SUB-COMPONENT: SMART CONFLICT ANALYZER ---
function ConflictAnalyzer({ conflicts }: { conflicts: any }) {
  const data = useMemo(() => {
    let rawList: string[] = [];
    if (Array.isArray(conflicts)) {
        rawList = conflicts.map(c => typeof c === 'object' ? c.value : String(c));
    } else if (typeof conflicts === 'string') {
        rawList = conflicts.split(',').map(s => s.trim()).filter(Boolean);
    }

    if (rawList.length === 0 || (rawList.length === 1 && rawList[0].toLowerCase().includes("no known"))) {
        return { severe: 0, minor: 0, items: [] };
    }

    const items = rawList.map((str, i) => {
        const lower = str.toLowerCase();
        const isSevere = lower.includes("absent") || lower.includes("missing") || lower.includes("vacation") || lower.includes("out of town");
        const isMinor = lower.includes("late") || lower.includes("early") || lower.includes("leave") || lower.includes("tardy");
        
        return {
            id: i,
            text: str,
            severity: isSevere ? 'severe' : (isMinor ? 'minor' : 'unknown')
        };
    });

    return { 
        severe: items.filter(i => i.severity === 'severe').length, 
        minor: items.filter(i => i.severity !== 'severe').length, 
        items 
    };
  }, [conflicts]);

  if (data.items.length === 0) {
      return (
        <div className="p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-2xl flex items-center gap-3">
            <CheckCircle2 size={18} className="text-emerald-500" />
            <p className="text-xs font-bold text-emerald-400">No known conflicts</p>
        </div>
      );
  }

  return (
    <div className="space-y-4">
        {/* Summary Dashboard */}
        <div className="flex gap-3">
            <div className={`flex-1 p-3 rounded-xl border flex items-center gap-3 ${data.severe > 0 ? 'bg-red-500/10 border-red-500/30' : 'bg-zinc-900 border-white/5'}`}>
                <div className={`p-2 rounded-lg ${data.severe > 0 ? 'bg-red-500 text-white' : 'bg-zinc-800 text-zinc-500'}`}>
                    <AlertOctagon size={16} />
                </div>
                <div>
                    <p className="text-[10px] uppercase font-black tracking-widest opacity-60">Severe</p>
                    <p className={`text-xl font-black leading-none ${data.severe > 0 ? 'text-red-400' : 'text-zinc-600'}`}>{data.severe}</p>
                </div>
            </div>

            <div className={`flex-1 p-3 rounded-xl border flex items-center gap-3 ${data.minor > 0 ? 'bg-amber-500/10 border-amber-500/30' : 'bg-zinc-900 border-white/5'}`}>
                <div className={`p-2 rounded-lg ${data.minor > 0 ? 'bg-amber-500 text-black' : 'bg-zinc-800 text-zinc-500'}`}>
                    <Clock size={16} />
                </div>
                <div>
                    <p className="text-[10px] uppercase font-black tracking-widest opacity-60">Minor</p>
                    <p className={`text-xl font-black leading-none ${data.minor > 0 ? 'text-amber-400' : 'text-zinc-600'}`}>{data.minor}</p>
                </div>
            </div>
        </div>

        {/* Detailed List */}
        <div className="bg-zinc-900/50 border border-white/5 rounded-xl overflow-hidden">
            <div className="px-4 py-2 bg-zinc-900 border-b border-white/5">
                <p className="text-[9px] uppercase font-bold text-zinc-500">Conflict Details</p>
            </div>
            <div className="max-h-[120px] overflow-y-auto p-2 space-y-1 custom-scrollbar">
                {data.items.map((item) => (
                    <div key={item.id} className="flex items-start gap-2 p-2 rounded hover:bg-white/5 transition-colors">
                        <div className={`mt-1 w-1.5 h-1.5 rounded-full flex-shrink-0 ${item.severity === 'severe' ? 'bg-red-500' : 'bg-amber-500'}`} />
                        <p className="text-xs text-zinc-300 leading-snug">{item.text}</p>
                    </div>
                ))}
            </div>
        </div>
    </div>
  );
}
</file>

<file path="app/login/page.tsx">
"use client";
import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Lock, Loader2 } from 'lucide-react';

export default function LoginPage() {
  const [password, setPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false); // New: Visual feedback
  const router = useRouter();

const handleLogin = async (e) => {
    e.preventDefault(); 
    if (!password) return; 

    setIsLoading(true); 

    // 1. Set the cookie
    document.cookie = `cyt_auth=${password}; path=/; max-age=86400;`; 
    
    // 2. THE NUCLEAR OPTION
    // Instead of router.push('/'), use this:
    window.location.href = '/'; 
  };

  return (
    <div className="h-screen bg-zinc-950 flex items-center justify-center p-4">
      <div className="w-full max-w-sm bg-zinc-900 border border-white/10 p-8 rounded-2xl shadow-2xl text-center space-y-6">
        
        <div className="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto border border-blue-500/20">
            <Lock size={32} className="text-blue-500" />
        </div>
        
        <h1 className="text-2xl font-black uppercase italic text-white tracking-tight">Staff Access</h1>
        
        {/* NEW: Wrapping in a form makes 'Enter' key work automatically */}
        <form onSubmit={handleLogin} className="space-y-4">
            <input 
                type="password" 
                placeholder="Enter Access Code..." 
                className="w-full bg-black border border-zinc-700 p-4 rounded-xl text-white text-center focus:border-blue-500 outline-none text-lg tracking-widest placeholder:text-zinc-600 transition-all"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                disabled={isLoading} // Prevent double-clicks
            />
            
            <button 
                type="submit" 
                disabled={isLoading || !password}
                className="w-full bg-white text-black font-black uppercase py-4 rounded-xl hover:bg-zinc-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
                {isLoading ? (
                    <>
                        <Loader2 className="animate-spin" size={20} />
                        Verifying...
                    </>
                ) : (
                    "Enter Deck"
                )}
            </button>
        </form>

      </div>
    </div>
  );
}
</file>

<file path="package.json">
{
  "name": "open-backstage-casting",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@aws-sdk/client-s3": "^3.958.0",
    "@aws-sdk/s3-request-presigner": "^3.958.0",
    "lucide-react": "^0.562.0",
    "next": "16.1.1",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "recharts": "^3.6.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="app/page.tsx">
"use client";
import { useEffect, useState } from 'react';
import { getActiveProduction } from '@/app/lib/baserow'; // Assuming this import path is correct
import { Loader2, Users, ClipboardList, Settings } from 'lucide-react'; // Added icons for the menu

export default function RootPage() {
  const [loading, setLoading] = useState(true);
  const [showName, setShowName] = useState("");

  useEffect(() => {
    async function init() {
      try {
        const show = await getActiveProduction();
        if (show) {
            // 1. Still save the ID for context
            localStorage.setItem('activeShowId', show.id.toString());
            setShowName(show.Name || "Current Production"); // Adjust '.Name' to match your Baserow column
        }
      } catch (e) {
        console.error("Failed to fetch show:", e);
      } finally {
        // 2. STOP the loader, but DO NOT redirect.
        setLoading(false); 
      }
    }
    init();
  }, []);

  // STATE 1: LOADING (Keep your original cool spinner)
  if (loading) {
    return (
      <div className="h-screen bg-zinc-950 flex flex-col items-center justify-center text-white gap-4">
          <Loader2 className="animate-spin text-blue-500" size={48} />
          <h2 className="text-sm font-bold uppercase tracking-widest text-zinc-500">Loading Context...</h2>
      </div>
    );
  }

  // STATE 2: THE DASHBOARD (This is what they see when loading finishes)
  return (
    <div className="min-h-screen bg-zinc-950 text-white p-8 font-sans flex flex-col items-center">
      
      {/* Header */}
      <div className="max-w-4xl w-full mb-12 border-b border-zinc-800 pb-6 flex justify-between items-end">
        <div>
            <h1 className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">
                CYT PRODUCTION HUB
            </h1>
            <p className="text-zinc-400 mt-2">
                Active Context: <span className="text-emerald-400 font-mono">{showName}</span>
            </p>
        </div>
      </div>

      {/* The Menu Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-4xl w-full">
        
        {/* Card 1: Link to Auditions (The page you were redirecting to) */}
        <a 
          href="/auditions" 
          className="group block p-6 bg-zinc-900 rounded-xl border border-zinc-800 hover:border-blue-500 hover:bg-zinc-800/50 transition-all duration-200"
        >
          <div className="mb-4 p-3 bg-blue-500/10 w-fit rounded-lg text-blue-400 group-hover:text-blue-300">
            <Users size={24} />
          </div>
          <h2 className="text-xl font-bold mb-2 group-hover:text-blue-400">Casting & Auditions</h2>
          <p className="text-zinc-500 text-sm">Process audition forms, manage callbacks, and build the cast list.</p>
        </a>

        {/* Card 2: Placeholder for future tools */}
        <div className="p-6 bg-zinc-900/40 rounded-xl border border-zinc-800/50 opacity-60 cursor-not-allowed">
          <div className="mb-4 p-3 bg-zinc-700/20 w-fit rounded-lg text-zinc-600">
            <ClipboardList size={24} />
          </div>
          <h2 className="text-xl font-bold mb-2 text-zinc-600">Stage Management</h2>
          <p className="text-zinc-600 text-sm">Reports and attendance tracking. (Coming Phase 2)</p>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="app/components/Sidebar.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { Users, Mic2, Layers, LogOut, HeartHandshake } from 'lucide-react';

const NAV_ITEMS = [
  { name: 'Auditions', href: '/auditions', icon: Mic2 },
  { name: 'Callbacks', href: '/callbacks', icon: Layers },
  { name: 'Casting', href: '/casting', icon: Users },
  { name: 'Committees', href: '/committees', icon: HeartHandshake },
];

export default function ResponsiveNav() {
  const pathname = usePathname();

  // --- THE FIX STARTS HERE ---
  // If we are on the Dashboard (/) or Login page, hide the sidebar completely.
  if (pathname === "/" || pathname === "/login") {
    return null;
  }
  // --- THE FIX ENDS HERE ---

  return (
    <>
      {/* --- DESKTOP SIDEBAR (Hidden on Mobile) --- */}
      <aside className="hidden md:flex flex-col w-20 lg:w-64 bg-zinc-900 border-r border-white/5 h-screen shrink-0">
        <div className="p-6">
          <h1 className="text-xl font-black italic uppercase text-blue-500 hidden lg:block">Production Deck</h1>
          <h1 className="text-xl font-black italic uppercase text-blue-500 lg:hidden">PD</h1>
        </div>
        
        <nav className="flex-1 px-4 space-y-2">
          {NAV_ITEMS.map((item) => {
            const isActive = pathname.startsWith(item.href);
            return (
              <Link 
                key={item.name} 
                href={item.href}
                className={`flex items-center gap-4 p-3 rounded-xl transition-all ${isActive ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'text-zinc-400 hover:bg-white/5 hover:text-white'}`}
              >
                <item.icon size={20} />
                <span className="font-bold hidden lg:block">{item.name}</span>
              </Link>
            );
          })}
        </nav>

        <div className="p-4 border-t border-white/5">
            {/* Note: I changed href to /login here since that seems to be your auth page */}
           <Link href="/login" className="flex items-center gap-4 p-3 text-zinc-500 hover:text-red-400 transition-colors">
              <LogOut size={20} />
              <span className="font-bold hidden lg:block text-xs uppercase tracking-widest">Logout</span>
           </Link>
        </div>
      </aside>

      {/* --- MOBILE BOTTOM NAV --- */}
      <nav className="md:hidden fixed bottom-0 left-0 right-0 h-20 bg-zinc-950 border-t border-white/10 z-[100] flex justify-around items-center px-2 pb-safe">
        {NAV_ITEMS.map((item) => {
            const isActive = pathname.startsWith(item.href);
            return (
              <Link 
                key={item.name} 
                href={item.href}
                className={`flex flex-col items-center justify-center w-full h-full gap-1 transition-all ${isActive ? 'text-blue-500' : 'text-zinc-500'}`}
              >
                <div className={`p-1.5 rounded-full ${isActive ? 'bg-blue-500/20' : 'bg-transparent'}`}>
                    <item.icon size={24} strokeWidth={isActive ? 2.5 : 2} />
                </div>
                <span className="text-[8px] font-bold uppercase tracking-wide">{item.name}</span>
              </Link>
            );
        })}
      </nav>
    </>
  );
}
</file>

<file path="app/layout.tsx">
import GlobalHeader from './components/GlobalHeader'; // Import it
import './globals.css';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" className="dark">
      <body className="bg-zinc-950 text-zinc-100 flex flex-col h-screen overflow-hidden">
        
        {/* The Top Bar - Always visible */}
        <GlobalHeader />

        {/* The "Page Body" - This is where your Route Groups (Sidebars) will load */}
        <div className="flex-1 flex overflow-hidden">
            {children}
        </div>

      </body>
    </html>
  );
}
</file>

<file path="app/lib/baserow.ts">
/* eslint-disable @typescript-eslint/no-explicit-any */

// --- CONFIGURATION ---
const BASE_URL = process.env.NEXT_PUBLIC_BASEROW_URL || "https://api.baserow.io";
const HEADERS = {
  "Authorization": `Token ${process.env.NEXT_PUBLIC_BASEROW_TOKEN}`,
  "Content-Type": "application/json",
};

// TABLE IDS
const TABLES = {
  PEOPLE: process.env.NEXT_PUBLIC_BASEROW_TABLE_PEOPLE || "599",
  PRODUCTIONS: "600",
  ASSIGNMENTS: process.env.NEXT_PUBLIC_BASEROW_TABLE_ASSIGNMENTS || "603",
  ROLES: "605",
  VOLUNTEERS: "619",
  COMMITTEE_PREFS: "620",
  SCENES: "627",
  AUDITIONS: process.env.NEXT_PUBLIC_BASEROW_TABLE_AUDITIONS || "630",
  ASSETS: "631" 
};

// --- HELPER: NAME MAPPER ---
// This function fixes the "Digital ID" issue by creating a dictionary of ID -> Name
async function getPersonNameMap() {
  // Fetch up to 200 people (Increase size if you have more actors)
  const res = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.PEOPLE}/?user_field_names=true&size=200`, {
    headers: HEADERS,
    cache: "no-store",
  });
  
  if (!res.ok) return new Map(); // Return empty map on fail
  
  const data = await res.json();
  // Create a Map: Row ID (e.g. 195) => "Jackson Smith"
  // Note: We map the internal 'id', not the 'Digital ID'
  return new Map(data.results.map((p: any) => [p.id, p["Full Name"]]));
}

// --- READ FUNCTIONS (AUDITIONS & CASTING) ---

export async function getAuditionSlots() {
  const res = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.AUDITIONS}/?user_field_names=true&size=200`, {
    headers: HEADERS,
    cache: "no-store", 
  });
  if (!res.ok) throw new Error("Failed to fetch audition slots");
  const data = await res.json();
  return data.results;
}

export async function getAuditionees() {
  // 1. Fetch the raw Audition data (which currently has numbers like "1" in the name field)
  const auditionRes = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.AUDITIONS}/?user_field_names=true&size=200`, {
    headers: HEADERS,
    cache: "no-store",
  });
  if (!auditionRes.ok) throw new Error("Failed to fetch auditionees");
  const auditionData = await auditionRes.json();

  // 2. Fetch the People data to get the real names
  const nameMap = await getPersonNameMap();

  // 3. "Hydrate" the data: Replace the number with the name
  const hydratedResults = auditionData.results.map((row: any) => {
    // Check if there is a Performer linked
    if (row.Performer && row.Performer.length > 0) {
      const personId = row.Performer[0].id; // This is the Row ID (e.g. 195)
      const realName = nameMap.get(personId); // Look up "Jackson Smith"
      
      // If we found a name, overwrite the "1" with "Jackson Smith"
      if (realName) {
        row.Performer[0].value = realName;
      }
    }
    return row;
  });

  return hydratedResults;
}

export async function getScenes() {
  const res = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.SCENES}/?user_field_names=true&size=200`, {
    headers: HEADERS,
  });
  if (!res.ok) return [];
  const data = await res.json();
  return data.results;
}

export async function getRoles() {
  const res = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.ROLES}/?user_field_names=true&size=200`, {
    headers: HEADERS,
    cache: "no-store",
  });
  if (!res.ok) return [];
  const data = await res.json();
  return data.results;
}

export async function getSeasonsAndShows() {
  const res = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.PRODUCTIONS}/?user_field_names=true&size=200`, {
    headers: HEADERS,
    cache: "no-store",
  });
  if (!res.ok) throw new Error("Failed to fetch productions");
  const data = await res.json();
  return {
    seasons: Array.from(new Set(data.results.map((r: any) => r.Season?.value).filter(Boolean))).sort().reverse(),
    productions: data.results
  };
}

export async function getActiveProduction() {
  const res = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.PRODUCTIONS}/?user_field_names=true&size=50`, {
    headers: HEADERS,
    cache: "no-store",
  });
  if (!res.ok) return null;
  const data = await res.json();
  return data.results.find((r: any) => r["Is Active"] === true) || data.results[0];
}

// --- READ FUNCTIONS (COMMITTEES & PEOPLE) ---

export async function getPeople() {
  const res = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.PEOPLE}/?user_field_names=true&size=200`, {
    headers: HEADERS,
    cache: "no-store",
  });
  if (!res.ok) return [];
  const data = await res.json();
  return data.results;
}

export async function getCommitteePreferences() {
  const res = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.COMMITTEE_PREFS}/?user_field_names=true&size=200`, {
    headers: HEADERS,
    cache: "no-store",
  });
  if (!res.ok) throw new Error("Failed to fetch committee preferences");
  const data = await res.json();
  return data.results;
}

export async function getVolunteers() {
  const res = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.VOLUNTEERS}/?user_field_names=true&size=200`, {
    headers: HEADERS,
    cache: "no-store",
  });
  if (!res.ok) return []; 
  const data = await res.json();
  return data.results;
}

// --- WRITE FUNCTIONS (AUDITIONS) ---

export async function updateAuditionSlot(rowId: number, data: any) {
  const cleanData = { ...data };
  ["Vocal Score", "Acting Score", "Dance Score", "Stage Presence Score"].forEach(key => {
      if (key in cleanData) cleanData[key] = Number(cleanData[key]) || 0; 
  });

  const response = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.AUDITIONS}/${rowId}/?user_field_names=true`, {
    method: "PATCH",
    headers: HEADERS,
    body: JSON.stringify(cleanData),
  });
  return await response.json();
}

export async function submitAudition(personId: number, productionId: number, data: any) {
  const payload = {
    ...data,
    // Note: Baserow always expects the Row ID (e.g. 195) for links, NOT the primary field.
    // As long as personId is the Row ID, this will work regardless of the Primary Field change.
    "Performer": [personId], 
    "Production": [productionId],
    "Date": new Date().toISOString()
  };

  const response = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.AUDITIONS}/?user_field_names=true`, {
    method: "POST",
    headers: HEADERS,
    body: JSON.stringify(payload),
  });
  return await response.json();
}

// --- WRITE FUNCTIONS (CASTING / ROLES) ---

export async function createRole(name: string) {
  const response = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.ROLES}/?user_field_names=true`, {
    method: "POST",
    headers: HEADERS,
    body: JSON.stringify({ "Role Name": name, "Scene Data": "{}" }) 
  });
  return await response.json();
}

export async function updateRole(id: number, data: any) {
  await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.ROLES}/${id}/?user_field_names=true`, {
    method: "PATCH",
    headers: HEADERS,
    body: JSON.stringify(data)
  });
}

export async function deleteRole(id: number) {
  await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.ROLES}/${id}/`, {
    method: "DELETE",
    headers: HEADERS
  });
}

export async function createCastAssignment(actorId: number, roleId: number, productionName: string) {
  const response = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.ASSIGNMENTS}/?user_field_names=true`, {
    method: "POST",
    headers: HEADERS,
    body: JSON.stringify({
      "Person": [actorId], // Must be Row ID (195), not Digital ID (1)
      "Performance Identity": [roleId], 
    }),
  });
  if (!response.ok) throw new Error("Failed to assign role");
  return await response.json();
}

// --- WRITE FUNCTIONS (COMMITTEES) ---

export async function linkVolunteerToPerson(preferenceRowId: number, personRowId: number) {
  const response = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.COMMITTEE_PREFS}/${preferenceRowId}/?user_field_names=true`, {
    method: "PATCH",
    headers: HEADERS,
    body: JSON.stringify({
      "Linked Person": [personRowId] 
    })
  });
  if (!response.ok) throw new Error("Failed to link volunteer profile");
}

// --- ASSET LIBRARY FUNCTIONS ---

export async function getProductionAssets(productionId: number) {
  const res = await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.ASSETS}/?user_field_names=true&size=200`, {
    headers: HEADERS
  });
  if(!res.ok) return [];
  const data = await res.json();
  
  return data.results.filter((row: any) => 
    row.Production && row.Production.some((p: any) => p.id === productionId)
  );
}

export async function createProductionAsset(name: string, url: string, type: string, productionId: number) {
  await fetch(`${BASE_URL}/api/database/rows/table/${TABLES.ASSETS}/?user_field_names=true`, {
    method: "POST",
    headers: HEADERS,
    body: JSON.stringify({
      "Name": name,
      "Link": url,
      "Type": type, 
      "Production": [productionId] 
    })
  });
}
</file>

<file path="app/components/ChoreoWorkspace.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import React, { useState, useEffect, useRef, useMemo } from "react";
import { 
  ArrowLeft, ArrowRight, Move, 
  AlertTriangle, Star, Zap, Smile, ThumbsUp, MessageSquare,
  Video, Users, Loader2, RefreshCw, ChevronDown, Trash2, Eraser
} from "lucide-react";

// --- CONFIG ---
const STANDARD_TAGS = [
  { id: "#Featured", label: "Featured", icon: Star, color: "bg-purple-600 border-purple-400" },
  { id: "#Tap", label: "Tap", icon: Zap, color: "bg-blue-600 border-blue-400" },
  { id: "#Acro", label: "Acro", icon: Move, color: "bg-emerald-600 border-emerald-400" },
];

const LEVELS = [
  { val: 2, label: "Non-Mover", color: "bg-zinc-800 text-zinc-400 border-zinc-600" },
  { val: 3, label: "Mover", color: "bg-blue-900/30 text-blue-300 border-blue-500/50" },
  { val: 4, label: "Dancer", color: "bg-purple-900/30 text-purple-300 border-purple-500/50" },
  { val: 5, label: "Advanced", color: "bg-emerald-900/30 text-emerald-300 border-emerald-500/50" },
];

export default function ChoreoWorkspace({ 
  people, 
  initialGrades, 
  onSave 
}: { 
  people: any[]; 
  initialGrades: any; 
  onSave: (id: number, score: number, tags: string, videoUrl?: string) => void;
}) {
  // --- STATE ---
  const [activeSlot, setActiveSlot] = useState<string>("");
  const [viewMode, setViewMode] = useState<'group' | 'grade'>('group');
  const [selectedIndex, setSelectedIndex] = useState(0);
  const [localNotes, setLocalNotes] = useState("");
  
  // UPLOAD STATE
  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState("0%");

  // SWIPE REFS
  const touchStartX = useRef<number | null>(null);
  const touchEndX = useRef<number | null>(null);

  // --- GROUPING LOGIC ---
  const groupedPeople = useMemo(() => {
      const groups: Record<string, any[]> = {};
      people.forEach(p => {
          const slot = p.timeSlot || "Unscheduled";
          if (!groups[slot]) groups[slot] = [];
          groups[slot].push(p);
      });
      return groups;
  }, [people]);

  const slots = Object.keys(groupedPeople).sort();
  
  useEffect(() => {
      if (slots.length > 0 && !activeSlot) setActiveSlot(slots[0]);
  }, [slots, activeSlot]);

  const currentGroup = groupedPeople[activeSlot] || [];
  const activeStudent = currentGroup[selectedIndex];
  const activeGrade = initialGrades[activeStudent?.id] || {};

  const groupVideoUrl = currentGroup.length > 0 
      ? (initialGrades[currentGroup[0].id]?.video || currentGroup[0].video) 
      : null;

  useEffect(() => {
      setLocalNotes(activeGrade.choreoNotes || "");
  }, [activeStudent?.id, activeGrade.choreoNotes]);


  // --- ACTIONS ---
  const handleScore = (score: number) => onSave(activeStudent.id, score, localNotes);
  
  // NEW: Full Reset Handler
  const handleClear = () => {
      setLocalNotes(""); // Wipe text UI
      onSave(activeStudent.id, 0, ""); // Wipe DB
  };

  const handleManualNoteChange = (text: string) => setLocalNotes(text);
  const saveNotes = () => onSave(activeStudent.id, activeGrade.dance || 0, localNotes);

  const handleToggleTag = (tag: string) => {
    let newNotes = localNotes;
    if (newNotes.includes(tag)) newNotes = newNotes.replace(tag, "").trim();
    else newNotes = `${newNotes} ${tag}`.trim();
    setLocalNotes(newNotes); 
    onSave(activeStudent.id, activeGrade.dance || 0, newNotes); 
  };

  const handleAttitudeCycle = () => {
    let newNotes = localNotes;
    if (newNotes.includes("#GreatAttitude")) newNotes = newNotes.replace("#GreatAttitude", "#BadAttitude");
    else if (newNotes.includes("#BadAttitude")) newNotes = newNotes.replace("#BadAttitude", "").trim();
    else newNotes = `${newNotes} #GreatAttitude`.trim();
    setLocalNotes(newNotes);
    onSave(activeStudent.id, activeGrade.dance || 0, newNotes);
  };

  const getAttitudeState = () => {
      if (localNotes.includes("#GreatAttitude")) return "good";
      if (localNotes.includes("#BadAttitude")) return "bad";
      return "none";
  };
  const attState = getAttitudeState();

  const handleBatchVideoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
      const file = e.target.files?.[0];
      if (!file) return;
      setIsUploading(true);
      setUploadProgress("Start");
      try {
          const res = await fetch('/api/upload', {
              method: 'POST',
              body: JSON.stringify({ filename: `GROUP-${activeSlot}-${file.name}`, fileType: file.type }),
          });
          if (!res.ok) throw new Error("Failed to sign");
          const { uploadUrl, publicUrl } = await res.json();

          setUploadProgress("Uploading...");
          const uploadRes = await fetch(uploadUrl, {
              method: 'PUT',
              body: file,
              headers: { "Content-Type": file.type, "x-amz-acl": "public-read" },
          });
          if (!uploadRes.ok) throw new Error("Upload failed");

          alert("Video Uploaded! Linking to all dancers in this group...");
          currentGroup.forEach(student => {
              const oldNotes = initialGrades[student.id]?.choreoNotes || "";
              const oldScore = initialGrades[student.id]?.dance || 0;
              if (!oldNotes.includes(publicUrl)) {
                  const newNotes = `${oldNotes} [GROUP VIDEO]`.trim();
                  onSave(student.id, oldScore, newNotes, publicUrl);
              }
          });
      } catch (err) {
          console.error(err);
          alert("Upload failed. Use Camera Roll.");
      } finally {
          setIsUploading(false);
          setUploadProgress("0%");
      }
  };

  const handleDeleteVideo = () => {
      if(!confirm("Delete this group video? This cannot be undone.")) return;
      currentGroup.forEach(student => {
          const oldScore = initialGrades[student.id]?.dance || 0;
          const oldNotes = initialGrades[student.id]?.choreoNotes || "";
          const cleanNotes = oldNotes.replace("[GROUP VIDEO]", "").trim();
          onSave(student.id, oldScore, cleanNotes, "DELETE");
      });
  };

  const changeStudent = (delta: number) => {
      const newIndex = selectedIndex + delta;
      if (newIndex >= 0 && newIndex < currentGroup.length) setSelectedIndex(newIndex);
  };

  const handleTouchStart = (e: React.TouchEvent) => { touchStartX.current = e.targetTouches[0].clientX; };
  const handleTouchMove = (e: React.TouchEvent) => { touchEndX.current = e.targetTouches[0].clientX; };
  const handleTouchEnd = () => {
      if (!touchStartX.current || !touchEndX.current) return;
      const distance = touchStartX.current - touchEndX.current;
      if (distance > 50) changeStudent(1);
      if (distance < -50) changeStudent(-1);
      touchStartX.current = null;
      touchEndX.current = null;
  };

  if (!activeSlot) return <div className="p-8 text-center text-zinc-500">Loading Groups...</div>;

  return (
    <div className="flex flex-col h-full bg-black overflow-hidden relative">
      
      {/* 0. TIME SLOTS */}
      <div className={`h-14 bg-zinc-900 border-b border-white/5 flex items-center px-2 gap-2 overflow-x-auto shrink-0 custom-scrollbar transition-all duration-300 ${viewMode === 'grade' ? 'h-0 opacity-0 overflow-hidden border-none' : ''}`}>
          {slots.map((slot) => {
              const isActive = slot === activeSlot;
              const count = groupedPeople[slot].length;
              return (
                  <button
                    key={slot}
                    onClick={() => { setActiveSlot(slot); setViewMode('group'); setSelectedIndex(0); }}
                    className={`px-4 py-2 rounded-full text-[11px] font-black uppercase whitespace-nowrap transition-all flex-shrink-0 flex flex-col items-center leading-none gap-1
                        ${isActive ? 'bg-blue-600 text-white shadow-lg' : 'bg-zinc-800 text-zinc-500 border border-white/5'}
                    `}
                  >
                      <span>{slot}</span>
                      <span className={`text-[8px] ${isActive ? 'text-blue-200' : 'text-zinc-600'}`}>{count} Dancers</span>
                  </button>
              )
          })}
      </div>

      {/* === PERSISTENT VIDEO PLAYER === */}
      <div className={`w-full bg-black border-b border-white/10 shrink-0 relative transition-all duration-500 ease-in-out
          ${viewMode === 'group' ? 'flex-1 max-h-[40vh]' : 'h-36 md:h-64'}
      `}>
          {groupVideoUrl ? (
              <div className="relative w-full h-full group">
                  <video 
                      src={groupVideoUrl} 
                      controls 
                      playsInline
                      className="w-full h-full object-contain bg-zinc-950"
                  />
                  <div className="absolute top-2 right-2 flex gap-2 z-10">
                     <label className="flex items-center gap-2 bg-black/60 hover:bg-black/80 backdrop-blur text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase cursor-pointer border border-white/10 transition-colors">
                         <RefreshCw size={12} /> Retake
                         <input type="file" accept="video/*" capture="environment" className="hidden" onChange={handleBatchVideoUpload} disabled={isUploading} />
                     </label>
                     <button 
                        onClick={handleDeleteVideo}
                        className="flex items-center gap-2 bg-red-600/80 hover:bg-red-600 backdrop-blur text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase cursor-pointer border border-white/10 transition-colors"
                     >
                         <Trash2 size={12} /> Delete
                     </button>
                  </div>
              </div>
          ) : (
              <label className={`w-full h-full flex flex-col items-center justify-center gap-3 transition-all cursor-pointer bg-zinc-900 ${isUploading ? 'opacity-50 cursor-wait' : ''}`}>
                  {isUploading ? (
                      <>
                        <Loader2 size={32} className="text-blue-500 animate-spin" />
                        <span className="text-blue-500 font-black uppercase tracking-widest text-xs">{uploadProgress}</span>
                      </>
                  ) : (
                      <>
                        <div className="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center shadow-lg shadow-red-900/40">
                            <Video size={24} className="text-white" />
                        </div>
                        <div className="text-center">
                            <p className="text-white font-black uppercase tracking-wider text-xs">Record Group Video</p>
                        </div>
                        <input type="file" accept="video/*" capture="environment" className="hidden" onChange={handleBatchVideoUpload} disabled={isUploading} />
                      </>
                  )}
              </label>
          )}

          {viewMode === 'grade' && (
              <button 
                  onClick={() => setViewMode('group')}
                  className="absolute top-2 left-2 z-20 flex items-center gap-1 text-white text-[10px] font-black uppercase bg-black/60 px-3 py-1.5 rounded-full backdrop-blur border border-white/10 hover:bg-black/80"
              >
                  <ChevronDown size={12} /> Show Roster
              </button>
          )}
      </div>

      {/* === CONTENT AREA === */}
      <div className="flex-1 overflow-y-auto relative bg-zinc-950 flex flex-col">
          
          {viewMode === 'group' && (
              <div className="p-4">
                  <div className="flex justify-between items-end mb-3">
                      <h3 className="text-zinc-400 font-black uppercase text-xs tracking-widest flex items-center gap-2">
                          <Users size={14} /> {activeSlot} Roster
                      </h3>
                      {currentGroup.length > 0 && (
                          <button 
                            onClick={() => { setSelectedIndex(0); setViewMode('grade'); }} 
                            className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wide flex items-center gap-2"
                          >
                              Start Grading
                          </button>
                      )}
                  </div>
                  <div className="grid grid-cols-4 gap-2 pb-24">
                      {currentGroup.map((p, i) => {
                          const grade = initialGrades[p.id]?.dance || 0;
                          return (
                              <div 
                                key={p.id} 
                                onClick={() => { setSelectedIndex(i); setViewMode('grade'); }}
                                className={`aspect-square relative rounded-lg overflow-hidden border cursor-pointer transition-all
                                    ${grade > 0 ? 'border-blue-500/50' : 'border-white/10 hover:border-white/30'}
                                `}
                              >
                                  <img src={p.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-full h-full object-cover" />
                                  {grade > 0 && (
                                      <div className="absolute inset-0 bg-blue-900/60 flex items-center justify-center">
                                          <span className="text-xl font-black text-white">{grade}</span>
                                      </div>
                                  )}
                                  <div className="absolute bottom-0 inset-x-0 bg-black/60 p-1">
                                      <p className="text-[8px] font-bold text-white truncate text-center">{p.name}</p>
                                  </div>
                              </div>
                          )
                      })}
                  </div>
              </div>
          )}

          {viewMode === 'grade' && activeStudent && (
              <div className="flex flex-col flex-1 h-full min-h-0">
                  
                  {/* COMPACT STUDENT HEADER */}
                  <div className="flex items-center justify-between p-3 border-b border-white/5 bg-zinc-900/50 shrink-0">
                      <button onClick={() => changeStudent(-1)} disabled={selectedIndex === 0} className="p-2 text-zinc-400 hover:text-white disabled:opacity-20"><ArrowLeft size={20} /></button>
                      
                      <div className="flex items-center gap-3">
                          <div className="w-10 h-10 rounded-full overflow-hidden border border-white/10 shrink-0">
                              <img src={activeStudent.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-full h-full object-cover" />
                          </div>
                          <div className="text-center">
                              <h2 className="text-sm font-black uppercase text-white leading-none">{activeStudent.name}</h2>
                              <p className="text-[9px] text-zinc-500 font-bold uppercase mt-0.5">#{activeStudent.id.toString().slice(-3)} â€¢ {activeStudent.age}</p>
                          </div>
                          {activeGrade.dance > 0 && (
                             <div className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center border-2 border-black shadow-lg ml-2">
                                 <span className="text-sm font-black text-white">{activeGrade.dance}</span>
                             </div>
                          )}
                      </div>

                      <button onClick={() => changeStudent(1)} disabled={selectedIndex === currentGroup.length - 1} className="p-2 text-zinc-400 hover:text-white disabled:opacity-20"><ArrowRight size={20} /></button>
                  </div>

                  {/* CONTROL PAD */}
                  <div 
                    className="flex-1 bg-zinc-900 border-t border-white/10 p-4 pb-48 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)] flex flex-col justify-start"
                    onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}
                  >
                      <div className="grid grid-cols-4 gap-2 mb-1 mt-2">
                          {LEVELS.map((lvl) => (
                              <button key={lvl.val} onClick={() => handleScore(lvl.val)} className={`h-14 rounded-xl flex flex-col items-center justify-center border-2 transition-all active:scale-95 ${activeGrade.dance === lvl.val ? `${lvl.color.replace('/30', '')} text-white shadow-lg scale-105` : `bg-transparent border-white/5 text-zinc-500 hover:bg-white/5`}`}>
                                  <span className="text-lg font-black">{lvl.val}</span>
                                  <span className="text-[8px] font-bold uppercase whitespace-nowrap">{lvl.label}</span>
                              </button>
                          ))}
                      </div>

                      {/* FULL RESET BUTTON */}
                      <div className="flex justify-end mb-3 h-5">
                          {activeGrade.dance > 0 && (
                              <button 
                                  onClick={handleClear} 
                                  className="flex items-center gap-1 text-[10px] font-bold uppercase text-zinc-500 hover:text-red-400 transition-colors"
                              >
                                  <Eraser size={12} /> Clear All (Score & Notes)
                              </button>
                          )}
                      </div>

                      <div className="mb-3 relative">
                          <input value={localNotes} onChange={(e) => handleManualNoteChange(e.target.value)} onBlur={saveNotes} placeholder="Type note..." className="w-full bg-black/40 border border-white/5 rounded-lg pl-9 pr-4 py-3 text-sm text-white placeholder:text-zinc-600 focus:border-blue-500 outline-none" />
                          <MessageSquare size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-600" />
                      </div>

                      <div className="flex flex-wrap justify-center gap-2">
                          {STANDARD_TAGS.map((tag) => {
                              const isActive = (localNotes || "").includes(tag.id);
                              return (
                                  <button key={tag.id} onClick={() => handleToggleTag(tag.id)} className={`flex items-center gap-1.5 px-3 py-3 rounded-full border transition-all active:scale-95 flex-grow justify-center ${isActive ? `${tag.color} text-white shadow-lg` : "bg-zinc-950 border-white/10 text-zinc-400"}`}>
                                      <tag.icon size={14} fill={isActive ? "currentColor" : "none"} />
                                      <span className="text-[10px] font-bold uppercase tracking-wide">{tag.label}</span>
                                  </button>
                              );
                          })}
                          <button onClick={handleAttitudeCycle} className={`flex items-center gap-1.5 px-3 py-3 rounded-full border transition-all active:scale-95 flex-grow justify-center ${attState === 'good' ? "bg-emerald-600 border-emerald-400 text-white shadow-lg" : attState === 'bad' ? "bg-red-600 border-red-400 text-white shadow-lg" : "bg-zinc-950 border-white/10 text-zinc-400"}`}>
                              {attState === 'good' ? <ThumbsUp size={14} fill="currentColor" /> : attState === 'bad' ? <AlertTriangle size={14} fill="currentColor" /> : <Smile size={14} />}
                              <span className="text-[10px] font-bold uppercase tracking-wide">{attState === 'good' ? "Good Att." : attState === 'bad' ? "Bad Att." : "Attitude"}</span>
                          </button>
                      </div>
                  </div>
              </div>
          )}
      </div>
    </div>
  );
}
</file>

</files>
