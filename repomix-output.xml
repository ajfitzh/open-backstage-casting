This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/
  (main)/
    (casting)/
      auditions/
        page.tsx
      callbacks/
        page.tsx
      casting/
        page.tsx
      conflicts/
        page.tsx
      layout.tsx
    (creative)/
      production/
        page.tsx
    (production)/
      analysis/
        page.tsx
        SceneAnalysisClient.tsx
    (staff)/
      committees/
        page.tsx
      reports/
        page.tsx
      roster/
        page.tsx
      layout.tsx
      page.tsx
    analytics/
      analytics-client.tsx
      page.tsx
    education/
      AcademyClient.tsx
      EducationGrid.tsx
      page.tsx
    schedule/
      page.tsx
    settings/
      page.tsx
    layout.tsx
    loading.tsx
    page.tsx
  actions/
    casting.ts
  api/
    auth/
      [...nextauth]/
        route.ts
    upload/
      route.ts
  components/
    auditions/
      AuditionsClient.tsx
    casting/
      CallbackClient.tsx
      CastingClient.tsx
      CastingInspector.tsx
      CastWorkspace.tsx
      ChemistryWorkspace.tsx
    charts/
      SalesChart.tsx
    committees/
      CommitteeClient.tsx
    conflicts/
      ConflictAnalysisDashboard.tsx
      ConflictsClient.tsx
    dashboard/
      CreativeTeam.tsx
      DashboardClient.tsx
      ProductionOverview.tsx
      ProductionTracker.tsx
      SeasonContext.tsx
      WorkflowProgress.tsx
    education/
      AttendanceSheet.tsx
      ClassManager.tsx
      ClassManagerModal.tsx
    globalappheader/
      client.tsx
      globalappheader.tsx
      index.tsx
    production/
      ProductionClient.tsx
    reports/
      ReportsClient.tsx
    schedule/
      AutoSchedulerModal.tsx
      CallboardView.tsx
      SchedulerClient.tsx
    settings/
      SettingsClient.tsx
    staff/
      StaffClient.tsx
    ActorProfileModal.tsx
    ChoreoWorkspace.tsx
    ComplianceDashboard.tsx
    ConflictMatrix.tsx
    ContextSwitcher.tsx
    logo.svg
    logo.tsx
    StaffSidebar.tsx
  context/
    SimulationContext.tsx
  lib/
    actions.ts
    baserow.ts
    CastingContext.tsx
    educationFillerData.ts
    permissions.ts
    schema.ts
  login/
    page.tsx
  privacy/
    page.tsx
  terms/
    page.tsx
  actions.ts
  favicon.ico
  globals.css
  layout.tsx
  plan.md
  providers.tsx
lib/
  CastingContext.tsx
  PeopleContext.tsx
  types.ts
public/
  file.svg
  globe.svg
  next.svg
  vercel.svg
  window.svg
.gitignore
auth.ts
eslint.config.mjs
get-schema.js
LICENSE
middleware.ts
next.config.ts
package.json
postcss.config.mjs
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/(main)/(casting)/auditions/page.tsx">
import { cookies } from 'next/headers';
import { getShowById, getActiveProduction } from '@/app/lib/baserow';
import AuditionsClient from '@/app/components/auditions/AuditionsClient';

export default async function AuditionsPage() {
  // 1. Try to get ID from Cookie
  const cookieStore = await cookies();
  let activeId = Number(cookieStore.get('active_production_id')?.value);
  let showTitle = "Select a Production";

  // 2. Resolve the ID
  if (activeId) {
    const showData = await getShowById(activeId);
    if (showData) {
      showTitle = showData.Title;
    }
  } 
  
  // 3. FALLBACK: If no cookie, fetch the default Active Show
  if (!activeId || showTitle === "Select a Production") {
    const defaultShow = await getActiveProduction();
    if (defaultShow) {
      activeId = defaultShow.id;
      showTitle = defaultShow.Title;
    }
  }

  // 4. Render Client
  return (
    <main className="min-h-screen bg-black">
      <AuditionsClient productionId={activeId} productionTitle={showTitle} />
    </main>
  );
}
</file>

<file path="app/(main)/(casting)/layout.tsx">
export default function CastingLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="flex h-full w-full"> {/* CHANGED: h-screen -> h-full */}
      <main className="flex-1 overflow-auto bg-zinc-900/50 relative">
        {children}
      </main>
    </div>  
  );
}
</file>

<file path="app/(main)/(staff)/layout.tsx">
export default function StaffLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="flex h-full w-full"> {/* CHANGED: h-screen -> h-full */}
      <main className="flex-1 overflow-auto bg-zinc-900/50 relative">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="app/(main)/(staff)/page.tsx">
import { cookies } from 'next/headers';
import { getActiveProduction } from '@/app/lib/baserow';
import StaffClient from '@/app/components/staff/StaffClient';

export default async function StaffPage() {
  const cookieStore = await cookies();
  const activeId = Number(cookieStore.get('active_production_id')?.value);
  
  let productionTitle = "Production Team";
  
  // Default to 0 if no active ID found, Client handles the rest
  let productionId = activeId || 0; 

  if (activeId) {
      const prod = await getActiveProduction(); 
      if(prod) productionTitle = prod.Title;
  }

  return (
    <main className="h-screen bg-zinc-950 overflow-hidden">
      <StaffClient productionTitle={productionTitle} productionId={productionId} />
    </main>
  );
}
</file>

<file path="app/(main)/loading.tsx">
import { Loader2 } from 'lucide-react';

export default function Loading() {
  return (
    <div className="h-full w-full flex flex-col items-center justify-center bg-zinc-950">
      <div className="flex flex-col items-center gap-6">
        
        {/* Spinning Icon */}
        <div className="relative">
            <div className="absolute inset-0 bg-blue-500/20 blur-xl rounded-full" />
            <Loader2 size={48} className="text-blue-500 animate-spin relative z-10" />
        </div>

        {/* Text */}
        <div className="text-center space-y-2">
          <h2 className="text-lg font-black uppercase italic text-white tracking-widest animate-pulse">
            Loading Data
          </h2>
          <p className="text-[10px] font-bold text-zinc-600 uppercase tracking-[0.3em]">
            Syncing with Baserow...
          </p>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="app/api/upload/route.ts">
import { NextResponse } from 'next/server';
import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';

const s3Client = new S3Client({
  region: process.env.DO_SPACES_REGION || "us-east-1",
  endpoint: process.env.DO_SPACES_ENDPOINT,
  credentials: {
    accessKeyId: process.env.DO_SPACES_KEY || "",
    secretAccessKey: process.env.DO_SPACES_SECRET || "",
  },
});

export async function POST(request: Request) {
  try {
    const { filename, fileType } = await request.json();

    // 1. Create a unique file name (e.g., 17156223-video.mp4)
    const uniqueFilename = `${Date.now()}-${filename.replace(/\s/g, '-')}`;

    // 2. Prepare the command
    const command = new PutObjectCommand({
      Bucket: process.env.DO_SPACES_BUCKET,
      Key: uniqueFilename,
      ContentType: fileType,
      ACL: 'public-read', // Makes the video viewable by your staff
    });

    // 3. Generate the Pre-Signed URL (Valid for 60 seconds)
    const uploadUrl = await getSignedUrl(s3Client, command, { expiresIn: 60 });

    // 4. Construct the final public URL for Baserow
    const publicUrl = `${process.env.DO_SPACES_ENDPOINT}/${process.env.DO_SPACES_BUCKET}/${uniqueFilename}`;

    return NextResponse.json({ uploadUrl, publicUrl });
  } catch (error) {
    console.error("Presign Error:", error);
    return NextResponse.json({ error: "Failed to sign URL" }, { status: 500 });
  }
}
</file>

<file path="app/components/dashboard/CreativeTeam.tsx">
"use client";

import { useState } from 'react';
import { User, X, Crown, Mic2, Music, GraduationCap, ClipboardList, Megaphone, Lightbulb, Hammer, Users } from 'lucide-react';

interface TeamMember {
  id: number;
  name: string;
  role: string;
  initials: string;
  color: string;
}

export default function CreativeTeam({ team }: { team: TeamMember[] }) {
  const [isOpen, setIsOpen] = useState(false);

  // Fallback for empty state (prevents UI collapse)
  if (!team || team.length === 0) {
      return (
          <div className="flex items-center gap-3 opacity-60 py-2 border border-white/10 rounded-full px-3 bg-black/20">
              <Users size={14} />
              <span className="text-[10px] font-bold text-zinc-400 uppercase tracking-wide">Staff Not Assigned</span>
          </div>
      );
  }

  // --- 1. SORTING LOGIC ---
  // We want the Director first, then MD/Choreo, then SM/Assistants
  const sortedTeam = [...team].sort((a, b) => {
      const score = (role: string) => {
          const r = (role || "").toLowerCase();
          if (r === 'director') return 10;
          if (r.includes('artistic')) return 9;
          if (r.includes('music') || r.includes('vocal')) return 8;
          if (r.includes('choreographer')) return 7;
          if (r.includes('stage manager') && !r.includes('assistant')) return 6;
          return 0;
      };
      return score(b.role) - score(a.role);
  });

  // Display Top 3 + Counter
  const coreTeam = sortedTeam.slice(0, 3);
  const remainingCount = Math.max(0, sortedTeam.length - 3);

  const getIcon = (role: string) => {
      const r = (role || "").toLowerCase();
      if (r.includes('music') || r.includes('vocal')) return <Mic2 size={14}/>;
      if (r.includes('choreographer')) return <Music size={14}/>;
      if (r.includes('stage manager')) return <ClipboardList size={14}/>;
      if (r.includes('assistant')) return <Megaphone size={14}/>;
      if (r.includes('director')) return <Crown size={14}/>;
      if (r.includes('light')) return <Lightbulb size={14}/>;
      if (r.includes('set') || r.includes('tech')) return <Hammer size={14}/>;
      return <User size={14}/>;
  };

  return (
    <>
      {/* --- DASHBOARD PREVIEW ROW --- */}
      <div className="flex flex-col gap-2 mt-4 xl:mt-0">
        <div className="flex flex-wrap items-center gap-3">
            
            {coreTeam.map((member) => (
                <div key={member.id} className="flex items-center gap-2 bg-black/30 p-1.5 pr-3 rounded-full border border-white/5 backdrop-blur-md shadow-sm hover:bg-black/50 transition-colors">
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-black text-white shadow-lg ${member.color}`}>
                        {member.initials}
                    </div>
                    <div className="flex flex-col leading-none">
                        <span className="text-[10px] font-bold text-white whitespace-nowrap">{member.name.split(' ')[0]}</span>
                        <span className="text-[8px] font-bold text-zinc-400 uppercase tracking-wider truncate max-w-[90px]">{member.role}</span>
                    </div>
                </div>
            ))}
            
            {/* "More" Button */}
            {remainingCount > 0 && (
                <button 
                    onClick={() => setIsOpen(true)}
                    className="w-8 h-8 rounded-full bg-zinc-800 border border-white/10 flex items-center justify-center text-zinc-400 hover:text-white hover:bg-zinc-700 transition-all shadow-lg shrink-0"
                    title="View Full Staff"
                >
                    <span className="text-[10px] font-black">+{remainingCount}</span>
                </button>
            )}
        </div>
      </div>

      {/* --- MOBILE MODAL --- */}
      {isOpen && (
        <div className="fixed inset-0 z-[100] flex items-end md:items-center justify-center p-4 md:p-8">
            <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setIsOpen(false)} />
            
            <div className="relative bg-zinc-900 w-full max-w-lg rounded-3xl border border-white/10 shadow-2xl overflow-hidden animate-in slide-in-from-bottom-10 duration-300 max-h-[80vh] flex flex-col">
                <div className="p-6 border-b border-white/10 bg-zinc-950 flex justify-between items-center shrink-0">
                    <div>
                        <h2 className="text-xl font-black uppercase italic tracking-tighter text-white">Creative Team</h2>
                        <p className="text-xs text-zinc-500 font-bold uppercase tracking-widest mt-1">Full Staff Roster</p>
                    </div>
                    <button onClick={() => setIsOpen(false)} className="p-2 bg-zinc-800 rounded-full text-zinc-400 hover:text-white transition-colors">
                        <X size={18} />
                    </button>
                </div>

                <div className="p-6 grid grid-cols-1 sm:grid-cols-2 gap-3 overflow-y-auto custom-scrollbar">
                    {sortedTeam.map((member) => (
                        <div key={member.id} className="flex items-center gap-3 p-3 rounded-xl bg-zinc-800/30 border border-white/5">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xs font-black text-white shadow-inner shrink-0 ${member.color}`}>
                                {member.initials}
                            </div>
                            <div className="min-w-0">
                                <h3 className="text-sm font-bold text-white truncate">{member.name}</h3>
                                <div className="flex items-center gap-1.5 text-[10px] font-bold text-zinc-400 uppercase tracking-wider mt-0.5">
                                    {getIcon(member.role)} 
                                    <span className="truncate">{member.role}</span>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
      )}
    </>
  );
}
</file>

<file path="app/components/education/ClassManager.tsx">
"use client";

import React, { useState, useMemo } from 'react';
import { 
  Users, Search, ArrowLeft, 
  Building2, Waves, Compass, Anchor, Navigation, 
  Filter, X, CalendarDays,
  Map as MapIcon, LayoutGrid, CheckCircle2, Clock, UserX, MoreHorizontal, ChevronRight
} from 'lucide-react';

// --- MOCK CONFIG ---
const SESSIONS = [
    { id: 'winter2026', label: 'Winter 2026', current: true },
    { id: 'fall2025', label: 'Fall 2025', current: false },
    { id: 'spring2025', label: 'Spring 2025', current: false },
];

const AGE_GROUPS = ["5-8", "8-12", "13-18"];
const DAYS = ["Monday", "Tuesday", "Thursday"];

// --- üó∫Ô∏è VENUE MAP DATA ---
const VENUE_LAYOUTS: Record<string, any[]> = {
    "River of Life": [
        { id: "main", name: "Sanctuary", capacity: 400, type: "large", col: "col-span-2" },
        { id: "lobby", name: "Lobby", capacity: 50, type: "common", col: "col-span-2" },
        { id: "101", name: "Rm 101", capacity: 20, type: "small", col: "col-span-1" },
        { id: "102", name: "Rm 102", capacity: 20, type: "small", col: "col-span-1" },
        { id: "hall", name: "Hall", capacity: 100, type: "medium", col: "col-span-2" },
    ],
    // Add others as needed
};

// --- MOCK STUDENTS FOR ATTENDANCE ---
const MOCK_ROSTER = [
    { id: 1, name: "Sarah Smith", status: 'present' },
    { id: 2, name: "James Johnson", status: 'present' },
    { id: 3, name: "Emily Davis", status: 'absent' },
    { id: 4, name: "Michael Brown", status: 'present' },
    { id: 5, name: "Jessica Wilson", status: 'late' },
];

export default function ClassManager({ classes }: any) {
  const [selectedLocation, setSelectedLocation] = useState<string | null>(null);
  const [selectedClass, setSelectedClass] = useState<any>(null);
  
  // Filters
  const [currentSession, setCurrentSession] = useState(SESSIONS[0]); 
  const [filterDay, setFilterDay] = useState<string | null>(null);
  const [filterAge, setFilterAge] = useState<string | null>(null);
  const [searchTerm, setSearchTerm] = useState("");

  // --- üß† SMART VIEW LOGIC ---
  // If a User filters/searches, we break out of "Location Mode" and show a "Master List"
  const isGlobalSearch = !!(searchTerm || filterDay || filterAge);
  
  const filteredClasses = useMemo(() => {
      let data = classes;
      if (currentSession.id !== 'winter2026') return []; 

      // 1. Location Filter (Only if NOT searching globally)
      if (selectedLocation && !isGlobalSearch) {
          data = data.filter((c:any) => c.location === selectedLocation);
      }

      // 2. Global Filters
      if (filterDay) data = data.filter((c:any) => c.day === filterDay);
      if (filterAge) data = data.filter((c:any) => c.ages.includes(filterAge));
      if (searchTerm) {
          const lower = searchTerm.toLowerCase();
          data = data.filter((c:any) => 
            c.name.toLowerCase().includes(lower) || 
            c.teacher.toLowerCase().includes(lower) ||
            c.location.toLowerCase().includes(lower)
          );
      }
      return data;
  }, [classes, selectedLocation, searchTerm, filterDay, filterAge, isGlobalSearch, currentSession]);

  // --- STATS FOR CAMPUS CARDS ---
  const locationStats = useMemo(() => {
    const stats: Record<string, { count: number, students: number }> = {};
    classes.forEach((c: any) => {
        const loc = c.location || "Unknown Location";
        if (!stats[loc]) stats[loc] = { count: 0, students: 0 };
        stats[loc].count++;
        stats[loc].students += c.enrolled;
    });
    return Object.entries(stats).map(([name, data]) => ({ name, ...data }));
  }, [classes]);

  // --- THEME ENGINE ---
  const getLocationTheme = (name: string) => {
    const n = name?.toLowerCase() || "";
    if (n.includes('river of life')) return { icon: <Waves size={32} />, color: 'text-cyan-400', bg: 'bg-cyan-500/10', border: 'border-cyan-500/20' };
    if (n.includes('hope')) return { icon: <Compass size={32} />, color: 'text-purple-400', bg: 'bg-purple-500/10', border: 'border-purple-500/20' };
    if (n.includes('river club')) return { icon: <Anchor size={32} />, color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20' };
    if (n.includes('highway')) return { icon: <Navigation size={32} />, color: 'text-amber-400', bg: 'bg-amber-500/10', border: 'border-amber-500/20' };
    return { icon: <Building2 size={32} />, color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20' };
  };

  return (
    <div className="flex flex-col h-full bg-zinc-950 text-white font-sans selection:bg-blue-500/30 overflow-hidden relative">
        
        {/* --- HEADER & FILTERS --- */}
        <div className="p-6 shrink-0 border-b border-white/5 bg-zinc-900/50 backdrop-blur-xl z-20">
            <div className="flex flex-col xl:flex-row xl:items-center justify-between gap-6">
                
                {/* Title Area */}
                <div>
                    <div className="flex items-center gap-2 mb-1">
                        <button 
                            onClick={() => { setSelectedLocation(null); setSearchTerm(""); setFilterDay(null); setFilterAge(null); }}
                            className="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500 hover:text-white transition-colors flex items-center gap-1"
                        >
                           CLASS MANAGER {selectedLocation && <><ChevronRight size={10}/> {selectedLocation}</>}
                        </button>
                    </div>
                    <h1 className="text-3xl font-black uppercase italic tracking-tighter text-white">
                        {isGlobalSearch ? "Class Search" : selectedLocation ? selectedLocation : "Campus Overview"}
                    </h1>
                </div>

                {/* Filter Bar */}
                <div className="flex flex-col md:flex-row gap-4 items-start md:items-center">
                    
                    {/* Search Input */}
                    <div className="relative w-full md:w-64">
                        <Search size={16} className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500"/>
                        <input 
                            value={searchTerm} 
                            onChange={(e) => setSearchTerm(e.target.value)} 
                            placeholder="Find class, teacher..." 
                            className="w-full bg-black/40 border border-white/10 rounded-xl pl-12 pr-4 py-2.5 text-sm focus:border-blue-500 outline-none transition-all placeholder:text-zinc-600"
                        />
                    </div>

                    {/* Filter Pills */}
                    <div className="flex items-center gap-2 bg-zinc-900 p-1.5 rounded-xl border border-white/5 overflow-x-auto max-w-full">
                        <div className="px-2 text-zinc-500"><Filter size={14}/></div>
                        {DAYS.map(day => (
                            <button key={day} onClick={() => setFilterDay(filterDay === day ? null : day)} className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all whitespace-nowrap ${filterDay === day ? 'bg-blue-600 text-white' : 'text-zinc-500 hover:text-zinc-300'}`}>{day.substring(0, 3)}</button>
                        ))}
                        <div className="w-px h-4 bg-white/10 mx-1"></div>
                        {AGE_GROUPS.map(age => (
                            <button key={age} onClick={() => setFilterAge(filterAge === age ? null : age)} className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all whitespace-nowrap ${filterAge === age ? 'bg-emerald-600 text-white' : 'text-zinc-500 hover:text-zinc-300'}`}>{age}</button>
                        ))}
                        {(filterDay || filterAge || searchTerm) && (
                            <button onClick={() => {setFilterDay(null); setFilterAge(null); setSearchTerm("")}} className="px-2 text-zinc-500 hover:text-red-400 transition-colors ml-auto"><X size={14} /></button>
                        )}
                    </div>
                </div>
            </div>
        </div>

        {/* --- MAIN CONTENT AREA --- */}
        <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
            
            {/* STATE 1: CAMPUS OVERVIEW (No filters, No selection) */}
            {!selectedLocation && !isGlobalSearch && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-in fade-in zoom-in-95 duration-300">
                    {locationStats.map((loc: any) => {
                        const theme = getLocationTheme(loc.name);
                        return (
                            <button key={loc.name} onClick={() => setSelectedLocation(loc.name)} className={`relative overflow-hidden bg-zinc-900 border ${theme.border} p-8 rounded-[2rem] text-left group hover:bg-zinc-800 transition-all shadow-2xl h-64 flex flex-col justify-between`}>
                                <div className={`absolute -right-6 -bottom-6 opacity-10 group-hover:opacity-20 transition-all duration-500 ${theme.color} rotate-12 scale-150`}>
                                    {React.cloneElement(theme.icon as React.ReactElement, { size: 180 })}
                                </div>
                                <div className="flex justify-between items-start relative z-10">
                                    <div className={`p-4 ${theme.bg} ${theme.color} rounded-2xl`}>{theme.icon}</div>
                                    <div className="text-right">
                                        <div className="text-4xl font-black text-white">{loc.count}</div>
                                        <div className="text-[10px] font-bold uppercase text-zinc-500 tracking-wider">Active Classes</div>
                                    </div>
                                </div>
                                <div className="relative z-10">
                                    <h3 className="text-2xl font-black text-white mb-1 tracking-tight truncate">{loc.name}</h3>
                                    <p className="text-xs text-zinc-500 font-medium">{loc.students} Students Enrolled</p>
                                </div>
                            </button>
                        );
                    })}
                </div>
            )}

            {/* STATE 2: CLASS LIST (Filtered or Location Selected) */}
            {(selectedLocation || isGlobalSearch) && (
                <div className="animate-in slide-in-from-bottom-4 duration-500 space-y-6">
                    
                    {/* OPTIONAL: Heads-Up Map (Only show if Specific Location is selected, NOT on global search) */}
                    {selectedLocation && !isGlobalSearch && VENUE_LAYOUTS[selectedLocation] && (
                        <div className="bg-black/20 border border-white/5 rounded-2xl p-6 mb-8 overflow-x-auto">
                            <div className="flex items-center gap-2 mb-4 text-[10px] font-black uppercase text-zinc-500 tracking-widest">
                                <LayoutGrid size={14} className="text-blue-500"/> Facility Map
                            </div>
                            <div className="grid grid-cols-4 gap-4 min-w-[600px]">
                                {VENUE_LAYOUTS[selectedLocation].map((room) => (
                                    <div key={room.id} className={`p-4 rounded-xl border border-white/5 bg-zinc-800/50 flex flex-col justify-between h-24 ${room.col}`}>
                                        <span className="text-[10px] font-bold uppercase text-zinc-400">{room.name}</span>
                                        <div className="flex justify-end">
                                            <span className="text-lg font-black text-zinc-600">{room.capacity}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-1 gap-3">
                        {filteredClasses.length === 0 && (
                            <div className="text-center py-20 border-2 border-dashed border-zinc-800 rounded-3xl text-zinc-600">
                                <Search size={48} className="mx-auto mb-4 opacity-20"/>
                                <p>No classes found matching your criteria.</p>
                            </div>
                        )}

                        {filteredClasses.map((c: any) => (
                            <div 
                                key={c.id} 
                                onClick={() => setSelectedClass(c)}
                                className="group bg-zinc-900 border border-white/5 p-4 rounded-2xl flex flex-col md:flex-row md:items-center gap-6 hover:bg-zinc-800 hover:border-white/10 transition-all cursor-pointer relative overflow-hidden"
                            >
                                {/* Left Color Bar */}
                                <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-blue-500 to-purple-500 opacity-0 group-hover:opacity-100 transition-opacity"/>

                                <div className="flex-1 min-w-0">
                                    <div className="flex items-center gap-3 mb-1">
                                        <span className="text-[10px] font-black uppercase tracking-widest text-zinc-500 bg-black/20 px-2 py-1 rounded">{c.day} ‚Ä¢ {c.time}</span>
                                        {isGlobalSearch && <span className="text-[10px] font-bold text-blue-400 border border-blue-500/20 px-2 py-1 rounded">{c.location}</span>}
                                    </div>
                                    <h3 className="text-xl font-black text-white truncate">{c.name}</h3>
                                    <div className="flex items-center gap-3 text-xs text-zinc-400 mt-1">
                                        <span className="flex items-center gap-1"><Users size={12}/> {c.teacher}</span>
                                        <span className="w-1 h-1 rounded-full bg-zinc-700"/>
                                        <span>Ages {c.ages}</span>
                                    </div>
                                </div>

                                <div className="flex items-center gap-6 pl-6 border-l border-white/5 md:border-l-0">
                                    <div className="text-right">
                                        <div className="text-2xl font-black text-white">{c.enrolled}</div>
                                        <div className="text-[9px] font-black text-zinc-600 uppercase tracking-wider">Students</div>
                                    </div>
                                    <div className="bg-white text-black p-2 rounded-full opacity-0 group-hover:opacity-100 transition-all transform translate-x-4 group-hover:translate-x-0">
                                        <ChevronRight size={20}/>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>

        {/* --- ATTENDANCE DRAWER (The "Kiosk" for Elizabeth) --- */}
        {selectedClass && (
            <div className="fixed inset-0 z-50 flex justify-end">
                <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setSelectedClass(null)} />
                
                <aside className="relative w-full max-w-2xl bg-zinc-950 border-l border-white/10 shadow-2xl flex flex-col animate-in slide-in-from-right duration-300">
                    
                    {/* Header */}
                    <div className="p-8 border-b border-white/10 bg-zinc-900 shrink-0">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h2 className="text-3xl font-black uppercase italic tracking-tighter text-white leading-none mb-2">{selectedClass.name}</h2>
                                <div className="flex items-center gap-3 text-zinc-400 text-sm font-medium">
                                    <span className="flex items-center gap-1"><Clock size={14}/> {selectedClass.time}</span>
                                    <span className="w-1 h-1 rounded-full bg-zinc-600"/>
                                    <span className="flex items-center gap-1"><MapIcon size={14}/> {selectedClass.location}</span>
                                </div>
                            </div>
                            <button onClick={() => setSelectedClass(null)} className="p-2 bg-black/40 rounded-full hover:bg-white/10 transition-colors"><X size={20}/></button>
                        </div>

                        {/* Action Tabs */}
                        <div className="flex gap-2">
                            <button className="flex-1 bg-blue-600 text-white py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-blue-500 transition-colors shadow-lg shadow-blue-900/20">
                                Take Attendance
                            </button>
                            <button className="px-6 bg-zinc-800 text-zinc-300 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-zinc-700 transition-colors">
                                View Roster
                            </button>
                            <button className="px-4 bg-zinc-800 text-zinc-300 py-3 rounded-xl hover:bg-zinc-700 transition-colors">
                                <MoreHorizontal size={16}/>
                            </button>
                        </div>
                    </div>

                    {/* Attendance List */}
                    <div className="flex-1 overflow-y-auto p-8 custom-scrollbar space-y-4">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-xs font-black uppercase tracking-widest text-zinc-500">Student List ({MOCK_ROSTER.length})</h3>
                            <button className="text-[10px] text-blue-400 font-bold uppercase hover:text-white">Mark All Present</button>
                        </div>

                        {MOCK_ROSTER.map((student) => (
                            <div key={student.id} className="flex items-center justify-between p-4 bg-zinc-900 border border-white/5 rounded-2xl group hover:border-white/10 transition-all">
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center text-sm font-bold text-zinc-400">
                                        {student.name.charAt(0)}
                                    </div>
                                    <span className="font-bold text-zinc-200 text-lg">{student.name}</span>
                                </div>
                                
                                <div className="flex items-center gap-2">
                                    <button className="w-10 h-10 rounded-full bg-emerald-500/10 text-emerald-500 flex items-center justify-center border border-emerald-500/20 hover:bg-emerald-500 hover:text-white transition-all">
                                        <CheckCircle2 size={20}/>
                                    </button>
                                    <button className="w-10 h-10 rounded-full bg-amber-500/10 text-amber-500 flex items-center justify-center border border-amber-500/20 hover:bg-amber-500 hover:text-white transition-all">
                                        <Clock size={20}/>
                                    </button>
                                    <button className="w-10 h-10 rounded-full bg-red-500/10 text-red-500 flex items-center justify-center border border-red-500/20 hover:bg-red-500 hover:text-white transition-all">
                                        <UserX size={20}/>
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {/* Footer */}
                    <div className="p-6 bg-zinc-900 border-t border-white/10 flex justify-between items-center text-xs text-zinc-500 font-mono">
                        <span>Session: {currentSession.label}</span>
                        <span>ID: {selectedClass.id}</span>
                    </div>

                </aside>
            </div>
        )}

    </div>
  );
}
</file>

<file path="app/components/globalappheader/index.tsx">
// app/components/global-header/index.tsx
import { cookies } from 'next/headers';
import { getServerSession } from "next-auth";
import { authOptions } from "@/app/api/auth/[...nextauth]/route";
import { getActiveShows } from '@/app/lib/baserow';
import GlobalHeaderClient from './client'; 

export default async function GlobalHeader() {
  const cookieStore = await cookies();
  const activeId = Number(cookieStore.get('active_production_id')?.value);
  const shows = await getActiveShows();
  const session = await getServerSession(authOptions);

  // Extract User Data including the Image
  const user = session?.user ? {
    name: session.user.name || "Cast Member",
    role: (session.user as any).role || "Guest",
    // Pass the image URL from the session (which comes from Baserow if your auth is set up that way)
    image: session.user.image || null, 
    initials: (session.user.name || "Guest")
      .split(' ')
      .map((n: string) => n[0])
      .join('')
      .substring(0, 2)
      .toUpperCase()
  } : null;

  return <GlobalHeaderClient shows={shows} activeId={activeId} user={user} />;
}
</file>

<file path="app/components/schedule/AutoSchedulerModal.tsx">
"use client";

import React, { useState } from 'react';
import { 
    Wand2, X, CheckCircle2, 
    Calendar, Users, Loader2,
    Clock, Layers, Music, Mic2, Theater,
    ArrowUp, ArrowDown, Timer, TrendingUp, AlertTriangle, Gauge,
    Printer, FileText
} from 'lucide-react';

// --- CONFIGURATION ---
const FRI_START = 18; // 6 PM
const FRI_END = 21;   // 9 PM
const SAT_START = 10; // 10 AM
const SAT_END = 17;   // 5 PM 

// --- TYPES ---
interface ScheduleStats {
    totalSlots: number;
    uniqueActors: number;
    concurrency: number; 
    conflictsAvoided: number;
    pointsCleared: number;   
    velocityTarget: number;  
    isOnTrack: boolean;
}

type TrackType = "Acting" | "Music" | "Dance";

export default function AutoSchedulerModal({ isOpen, onClose, scenes, people, onCommit }: any) {
    const [isGenerating, setIsGenerating] = useState(false);
    const [previewSchedule, setPreviewSchedule] = useState<any[]>([]);
    const [stats, setStats] = useState<ScheduleStats | null>(null);

    // ‚ö°Ô∏è CONTROLS
    const [trackPriority, setTrackPriority] = useState<TrackType[]>(['Music', 'Dance', 'Acting']);
    const [slotDuration, setSlotDuration] = useState(30); 

    // --- HELPER: Move items up/down ---
    const movePriority = (index: number, direction: 'up' | 'down') => {
        const newOrder = [...trackPriority];
        if (direction === 'up') {
            if (index === 0) return;
            [newOrder[index - 1], newOrder[index]] = [newOrder[index], newOrder[index - 1]];
        } else {
            if (index === newOrder.length - 1) return;
            [newOrder[index + 1], newOrder[index]] = [newOrder[index], newOrder[index + 1]];
        }
        setTrackPriority(newOrder);
    };

    // --- üßÆ THE ALGORITHM ---
    const generateSchedule = () => {
        setIsGenerating(true);
        
        // 1. Setup Time Slots based on DYNAMIC Duration
        const timeSlots: { day: 'Fri' | 'Sat', time: number }[] = [];
        const increment = slotDuration / 60; 
        
        // Fri: 6-9
        for (let t = FRI_START; t < FRI_END; t += increment) timeSlots.push({ day: 'Fri', time: t });
        // Sat: 10-5
        for (let t = SAT_START; t < SAT_END; t += increment) {
            if (t >= 13 && t < 14) continue; // Lunch
            timeSlots.push({ day: 'Sat', time: t });
        }

        const proposedSchedule: any[] = [];
        const scheduledCast = new Set<string>(); 
        const completedScenes = new Set<string>(); 
        let conflictsAvoided = 0;
        let totalActiveRooms = 0;
        let pointsCleared = 0;

        // 2. THE LOOP
        timeSlots.forEach((slot) => {
            const busyActorsInThisSlot = new Set<string>(); 
            let roomsActive = 0;

            trackPriority.forEach((track) => {
                const candidates = scenes.filter((scene: any) => {
                    // Rule: Don't repeat work this specific weekend
                    if (completedScenes.has(`${scene.id}-${track}`)) return false;
                    
                    // Skill Check
                    const type = (scene.type || "").toLowerCase();
                    if (track === 'Music' && !type.includes('song') && !type.includes('mixed')) return false;
                    if (track === 'Dance' && !type.includes('dance') && !type.includes('mixed')) return false;
                    
                    return true;
                });

                const scored = candidates.map((scene: any) => {
                    let score = 0;
                    
                    // Conflict Check
                    const hasConflict = scene.cast.some((c: any) => busyActorsInThisSlot.has(c.name));
                    if (hasConflict) {
                        conflictsAvoided++;
                        return { ...scene, score: -9999 };
                    }

                    // üöÄ BURN-DOWN WEIGHT: Prioritize "New" items to hit velocity
                    if (scene.status === 'New') score += 50; 
                    if (scene.status === 'Worked') score += 10;

                    // Equity Weight
                    const newFaces = scene.cast.filter((c:any) => !scheduledCast.has(c.name)).length;
                    score += (newFaces * 15);

                    // Efficiency
                    score += scene.cast.length;

                    return { ...scene, score };
                });

                scored.sort((a: any, b: any) => b.score - a.score);
                const winner = scored[0];

                if (winner && winner.score > 0) {
                    proposedSchedule.push({
                        id: Math.random().toString(),
                        sceneId: winner.id,
                        sceneName: winner.name,
                        track: track,
                        day: slot.day,
                        weekOffset: 0,
                        startTime: slot.time,
                        duration: slotDuration, // <--- Uses selected duration
                        status: 'New',
                        castSize: winner.cast.length
                    });

                    winner.cast.forEach((c:any) => {
                        busyActorsInThisSlot.add(c.name);
                        scheduledCast.add(c.name);
                    });

                    completedScenes.add(`${winner.id}-${track}`);
                    if (winner.status === 'New') pointsCleared++;
                    roomsActive++;
                }
            });
            totalActiveRooms += roomsActive;
        });

        // 3. STATS & VELOCITY CALC
        setTimeout(() => {
            const allCastCount = new Set(scenes.flatMap((s:any) => s.cast.map((c:any) => c.name))).size;
            const velocityTarget = 15; // Example target

            setPreviewSchedule(proposedSchedule);
            setStats({
                totalSlots: proposedSchedule.length,
                uniqueActors: scheduledCast.size,
                castCoverage: allCastCount > 0 ? Math.round((scheduledCast.size / allCastCount) * 100) : 0,
                concurrency: parseFloat((totalActiveRooms / timeSlots.length).toFixed(1)),
                conflictsAvoided,
                pointsCleared,
                velocityTarget,
                isOnTrack: pointsCleared >= velocityTarget
            });
            setIsGenerating(false);
        }, 800);
    };

    // --- RENDER HELPERS ---
    const getTrackIcon = (t: string) => {
        if (t === 'Music') return <Mic2 size={14} className="text-pink-400"/>;
        if (t === 'Dance') return <Music size={14} className="text-emerald-400"/>;
        return <Theater size={14} className="text-blue-400"/>;
    };
    
    const formatTime = (t: number) => {
        const h = Math.floor(t);
        const m = Math.round((t % 1) * 60).toString().padStart(2, '0');
        const suffix = h >= 12 ? 'PM' : 'AM';
        const h12 = h > 12 ? h - 12 : h;
        return `${h12}:${m} ${suffix}`;
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
            <div className="bg-zinc-900 border border-white/10 w-full max-w-6xl h-[85vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden">
                
                {/* HEADER */}
                <div className="p-6 border-b border-white/10 bg-zinc-900 flex justify-between items-center shrink-0">
                    <div>
                        <h2 className="text-2xl font-black uppercase italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 flex items-center gap-2">
                            <Wand2 size={24} className="text-purple-400" /> Multi-Track Auto-Scheduler
                        </h2>
                        <p className="text-xs text-zinc-500 font-bold uppercase tracking-widest mt-1">Velocity & Constraint Solver</p>
                    </div>
                    <button onClick={onClose} className="p-2 bg-zinc-800 rounded-full hover:bg-zinc-700 text-zinc-400 hover:text-white"><X size={20}/></button>
                </div>

                <div className="flex flex-1 overflow-hidden">
                    
                    {/* LEFT: Controls */}
                    <div className="w-80 bg-zinc-900/50 border-r border-white/5 p-6 flex flex-col gap-6 overflow-y-auto custom-scrollbar">
                        
                        {/* 1. DURATION "FUDGE FACTOR" */}
                        <div className="bg-black/20 p-5 rounded-2xl border border-white/5 space-y-4">
                             <h3 className="text-xs font-black uppercase text-zinc-500 tracking-widest flex items-center gap-2">
                                <Timer size={14}/> Slot Duration
                            </h3>
                            <div className="flex bg-zinc-900 rounded-lg p-1 border border-white/10">
                                {[45, 30, 20, 15].map(min => (
                                    <button 
                                        key={min}
                                        onClick={() => setSlotDuration(min)}
                                        className={`flex-1 py-1.5 text-[10px] font-bold rounded transition-all ${slotDuration === min ? 'bg-blue-600 text-white shadow' : 'text-zinc-500 hover:text-white'}`}
                                    >
                                        {min}m
                                    </button>
                                ))}
                            </div>
                            <p className="text-[10px] text-zinc-500 italic leading-tight">
                                Shorter slots = Higher Velocity.
                            </p>
                        </div>

                        {/* 2. PRIORITY SORTER */}
                        <div className="bg-black/20 p-5 rounded-2xl border border-white/5 space-y-4">
                            <div className="flex justify-between items-center">
                                <h3 className="text-xs font-black uppercase text-zinc-500 tracking-widest flex items-center gap-2">
                                    <Layers size={14}/> Priority Order
                                </h3>
                            </div>
                            
                            <div className="space-y-2">
                                {trackPriority.map((track, i) => (
                                    <div key={track} className="flex items-center gap-3 p-2 bg-zinc-800/50 rounded-lg border border-white/5 group">
                                        <div className="text-[10px] font-mono text-zinc-600 w-4">{i + 1}</div>
                                        <div className="flex-1 flex items-center gap-2">
                                            <div className="p-1.5 bg-black/40 rounded">{getTrackIcon(track)}</div>
                                            <span className="text-xs font-bold text-zinc-300">{track}</span>
                                        </div>
                                        <div className="flex flex-col opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => movePriority(i, 'up')} disabled={i === 0} className="hover:text-white text-zinc-500 disabled:opacity-0"><ArrowUp size={10}/></button>
                                            <button onClick={() => movePriority(i, 'down')} disabled={i === trackPriority.length - 1} className="hover:text-white text-zinc-500 disabled:opacity-0"><ArrowDown size={10}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* GENERATE */}
                        <div className="mt-auto">
                            <button 
                                onClick={generateSchedule} 
                                disabled={isGenerating}
                                className="w-full py-4 bg-purple-600 hover:bg-purple-500 rounded-xl text-white font-black uppercase tracking-widest shadow-lg shadow-purple-900/20 flex items-center justify-center gap-2 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {isGenerating ? <Loader2 className="animate-spin"/> : <Wand2 size={18}/>}
                                {isGenerating ? "Optimizing..." : "Generate Weekend"}
                            </button>
                        </div>
                    </div>

                    {/* RIGHT: Results Preview */}
                    <div className="flex-1 bg-zinc-950 p-8 overflow-y-auto custom-scrollbar">
                        {previewSchedule.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-zinc-600 opacity-50">
                                <Calendar size={64} className="mb-4"/>
                                <p className="text-sm font-bold uppercase">Ready to Schedule</p>
                                <p className="text-xs">Adjust duration and priority, then click Generate.</p>
                            </div>
                        ) : (
                            <div className="space-y-8">
                                
                                {/* üöÄ BURN-DOWN / VELOCITY SCOREBOARD */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <div className={`p-5 rounded-2xl border flex items-center justify-between ${stats?.isOnTrack ? 'bg-emerald-900/10 border-emerald-500/20' : 'bg-red-900/10 border-red-500/20'}`}>
                                        <div>
                                            <div className="flex items-center gap-2 mb-1">
                                                <Gauge size={16} className={stats?.isOnTrack ? "text-emerald-500" : "text-red-500"}/>
                                                <span className="text-xs font-black uppercase tracking-widest text-zinc-400">Burn Velocity</span>
                                            </div>
                                            <div className="text-3xl font-black text-white">
                                                {stats?.pointsCleared} <span className="text-sm text-zinc-500 font-bold">/ {stats?.velocityTarget} Items</span>
                                            </div>
                                        </div>
                                        <div className={`px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider border ${stats?.isOnTrack ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20'}`}>
                                            {stats?.isOnTrack ? "Ahead of Schedule" : "Behind Schedule"}
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-3 gap-2">
                                        <div className="bg-zinc-900 border border-white/10 p-3 rounded-xl text-center flex flex-col justify-center">
                                            <div className="text-xl font-black text-blue-400">{stats?.concurrency}</div>
                                            <div className="text-[8px] font-bold uppercase text-zinc-500">Rooms Active</div>
                                        </div>
                                        <div className="bg-zinc-900 border border-white/10 p-3 rounded-xl text-center flex flex-col justify-center">
                                            <div className="text-xl font-black text-emerald-400">{stats?.castCoverage}%</div>
                                            <div className="text-[8px] font-bold uppercase text-zinc-500">Cast Equity</div>
                                        </div>
                                        <div className="bg-zinc-900 border border-white/10 p-3 rounded-xl text-center flex flex-col justify-center">
                                            <div className="text-xl font-black text-amber-500">{stats?.conflictsAvoided}</div>
                                            <div className="text-[8px] font-bold uppercase text-zinc-500">Conflicts Fixed</div>
                                        </div>
                                    </div>
                                </div>

                                {/* Timeline Preview */}
                                <div className="space-y-6">
                                    {['Fri', 'Sat'].map(day => {
                                        const dayItems = previewSchedule.filter(i => i.day === day);
                                        const timeMap: Record<number, any[]> = {};
                                        dayItems.forEach(i => {
                                            if(!timeMap[i.startTime]) timeMap[i.startTime] = [];
                                            timeMap[i.startTime].push(i);
                                        });
                                        const times = Object.keys(timeMap).sort((a,b) => Number(a) - Number(b));

                                        return (
                                            <div key={day}>
                                                <h4 className="text-sm font-black uppercase text-white mb-4 flex items-center gap-2 border-b border-white/10 pb-2">
                                                    <Calendar size={16}/> {day === 'Fri' ? 'Friday' : 'Saturday'}
                                                </h4>
                                                <div className="space-y-2">
                                                    {times.map((t: any) => {
                                                        const timeNum = Number(t);
                                                        const slotItems = timeMap[timeNum];
                                                        return (
                                                            <div key={t} className="flex gap-4">
                                                                <div className="w-12 pt-3 text-right text-xs font-mono text-zinc-500 shrink-0">{formatTime(timeNum)}</div>
                                                                <div className="flex-1 grid grid-cols-3 gap-2">
                                                                    {trackPriority.map(track => {
                                                                        const item = slotItems.find((i:any) => i.track === track);
                                                                        if (!item) return <div key={track} className="h-10 rounded-lg border border-dashed border-white/5 bg-transparent" />;
                                                                        
                                                                        const color = track === 'Acting' ? 'bg-blue-900/10 text-blue-200 border-blue-500/30' 
                                                                                    : track === 'Music' ? 'bg-pink-900/10 text-pink-200 border-pink-500/30' 
                                                                                    : 'bg-emerald-900/10 text-emerald-200 border-emerald-500/30';
                                                                        
                                                                        return (
                                                                            <div key={track} className={`h-10 rounded-lg border px-3 flex flex-col justify-center ${color}`}>
                                                                                <div className="text-[10px] font-bold truncate">{item.sceneName}</div>
                                                                                <div className="text-[8px] opacity-60 uppercase">{track} ‚Ä¢ {item.castSize} Kids</div>
                                                                            </div>
                                                                        )
                                                                    })}
                                                                </div>
                                                            </div>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                                
                                <div className="flex justify-end pt-4 border-t border-white/10">
                                    <button 
                                        onClick={() => { onCommit(previewSchedule); onClose(); }} 
                                        className="px-8 py-3 bg-white text-black hover:bg-zinc-200 rounded-xl text-xs font-black uppercase tracking-widest shadow-xl flex items-center gap-2 transition-all"
                                    >
                                        <CheckCircle2 size={16}/> Confirm Schedule
                                    </button>
                                </div>

                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="app/components/schedule/CallboardView.tsx">
"use client";

import React, { useMemo, useState } from 'react';
import { 
    Printer, Clock, AlertTriangle, Car, 
    ChevronDown, ChevronUp, MapPin, Info
} from 'lucide-react';

// --- CONFIG ---
const GAP_THRESHOLD_HOURS = 2; // Split call if gap is > 2 hours

export default function CallboardView({ schedule, productionTitle, generalNotes }: any) {
    const [expandedActor, setExpandedActor] = useState<string | null>(null);

    // --- üß† THE MERGE ENGINE ---
    const processedCalls = useMemo(() => {
        const actorMap: Record<string, { fri: any[], sat: any[] }> = {};

        // 1. Group by Actor & Day
        schedule.forEach((slot: any) => {
            // Assume we can get actor names from the slot (in a real app, you'd join with the People table)
            // For this demo, we assume the scheduler saves "castNames" or we derived it.
            // Let's assume the schedule items have a 'castList' array attached for this view.
            if (!slot.castList) return; 

            slot.castList.forEach((actorName: string) => {
                if (!actorMap[actorName]) actorMap[actorName] = { fri: [], sat: [] };
                const target = slot.day === 'Fri' ? actorMap[actorName].fri : actorMap[actorName].sat;
                
                target.push({
                    start: slot.startTime,
                    end: slot.startTime + (slot.duration / 60),
                    scene: slot.sceneName,
                    type: slot.track
                });
            });
        });

        // 2. Sort & Merge Logic
        const processDay = (slots: any[]) => {
            if (slots.length === 0) return null;
            slots.sort((a, b) => a.start - b.start);

            const calls: any[] = [];
            let currentCall = { 
                start: slots[0].start, 
                end: slots[0].end, 
                segments: [slots[0]] 
            };

            for (let i = 1; i < slots.length; i++) {
                const next = slots[i];
                const gap = next.start - currentCall.end;

                // IF gap is small (< 2 hours), merge it (keep them in building)
                if (gap < GAP_THRESHOLD_HOURS) {
                    currentCall.end = Math.max(currentCall.end, next.end);
                    currentCall.segments.push(next);
                } else {
                    // IF gap is huge, push current call and start a new one (Split Call)
                    calls.push(currentCall);
                    currentCall = { 
                        start: next.start, 
                        end: next.end, 
                        segments: [next] 
                    };
                }
            }
            calls.push(currentCall);
            return calls;
        };

        const result = Object.entries(actorMap).map(([name, days]) => ({
            name,
            fri: processDay(days.fri),
            sat: processDay(days.sat)
        })).sort((a, b) => a.name.localeCompare(b.name));

        return result;
    }, [schedule]);


    // --- HELPERS ---
    const formatTime = (t: number) => {
        const h = Math.floor(t);
        const m = Math.round((t % 1) * 60).toString().padStart(2, '0');
        const suffix = h >= 12 ? 'PM' : 'AM';
        const h12 = h > 12 ? h - 12 : h;
        return `${h12}:${m}${suffix}`;
    };

    const renderCall = (calls: any[]) => {
        if (!calls) return <span className="text-zinc-500 italic">No Call</span>;
        
        return calls.map((call, i) => (
            <div key={i} className="flex flex-col">
                <span className="font-bold text-white bg-zinc-800 px-2 py-1 rounded border border-white/5 inline-block w-fit mb-1">
                    {formatTime(call.start)} - {formatTime(call.end)}
                </span>
                {calls.length > 1 && i < calls.length - 1 && (
                    <span className="text-[10px] text-amber-500 font-bold my-1 flex items-center gap-1">
                        <Car size={10}/> Split Call (Break: {(calls[i+1].start - call.end).toFixed(1)} hrs)
                    </span>
                )}
            </div>
        ));
    };

    return (
        <div className="flex flex-col h-full">
            
            {/* TOOLBAR (Hidden on Print) */}
            <div className="p-4 bg-zinc-900 border-b border-white/10 flex justify-between items-center print:hidden">
                <div>
                    <h2 className="text-lg font-black uppercase text-white tracking-widest flex items-center gap-2">
                        <Info size={18} className="text-blue-500"/> Weekly Callboard
                    </h2>
                    <p className="text-xs text-zinc-500">Auto-generated based on current schedule</p>
                </div>
                <button onClick={() => window.print()} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-xs uppercase flex items-center gap-2 transition-all">
                    <Printer size={16}/> Print for Parents
                </button>
            </div>

            {/* SCROLLABLE CONTENT */}
            <div className="flex-1 overflow-y-auto custom-scrollbar p-8 print:p-0 print:overflow-visible bg-zinc-950 print:bg-white">
                
                {/* PRINT HEADER */}
                <div className="hidden print:block mb-8 border-b-2 border-black pb-4">
                    <div className="flex justify-between items-end">
                        <div>
                            <h1 className="text-4xl font-black uppercase">{productionTitle}</h1>
                            <p className="text-lg font-bold text-gray-600">Weekly Callboard</p>
                        </div>
                        <div className="text-right">
                            <p className="text-sm font-bold">{new Date().toLocaleDateString()}</p>
                            <p className="text-xs text-gray-500">cytfred.org</p>
                        </div>
                    </div>
                </div>

                {/* NOTICES SECTION */}
                <div className="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6 print:grid-cols-2 print:gap-4">
                    <div className="bg-amber-900/10 border border-amber-500/20 p-4 rounded-xl print:border-gray-300 print:bg-gray-50">
                        <h3 className="text-amber-500 font-black uppercase text-xs tracking-widest mb-2 flex items-center gap-2 print:text-black">
                            <AlertTriangle size={14}/> Important Reminders
                        </h3>
                        <ul className="text-xs text-zinc-300 space-y-2 print:text-black list-disc pl-4">
                            <li>Drivers &lt;18 cannot leave during lunch but CAN leave if break &gt; 2 hours (with permission).</li>
                            <li>No hanging out in hallways or costume areas.</li>
                            <li><strong>Hair/Makeup:</strong> Check in with Ms. Tiffany this Saturday during lunch.</li>
                        </ul>
                    </div>

                    <div className="bg-blue-900/10 border border-blue-500/20 p-4 rounded-xl print:border-gray-300 print:bg-gray-50">
                        <h3 className="text-blue-400 font-black uppercase text-xs tracking-widest mb-2 flex items-center gap-2 print:text-black">
                            <MapPin size={14}/> Location & Logistics
                        </h3>
                        <div className="text-xs text-zinc-300 space-y-1 print:text-black">
                            <p><strong className="text-white print:text-black">Friday:</strong> 6:00 PM - 9:00 PM @ CYT Studio</p>
                            <p><strong className="text-white print:text-black">Saturday:</strong> 10:00 AM - 5:00 PM @ CYT Studio</p>
                            <p className="mt-2 text-zinc-500 print:text-gray-600 italic">Cleanup Crew: Ellie C, Sandi D, Chance H, Riley H.</p>
                        </div>
                    </div>
                </div>

                {/* THE TABLE */}
                <div className="bg-zinc-900 border border-white/10 rounded-xl overflow-hidden print:border-2 print:border-black print:rounded-none">
                    <table className="w-full text-left border-collapse">
                        <thead className="bg-zinc-800 text-zinc-400 text-[10px] font-black uppercase tracking-widest print:bg-gray-200 print:text-black print:border-b-2 print:border-black">
                            <tr>
                                <th className="p-4 border-b border-white/5 print:border-black">Cast Member</th>
                                <th className="p-4 border-b border-white/5 print:border-black">Friday Call</th>
                                <th className="p-4 border-b border-white/5 print:border-black">Saturday Call</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-white/5 print:divide-gray-300">
                            {processedCalls.map((row) => (
                                <React.Fragment key={row.name}>
                                    <tr 
                                        className="group hover:bg-zinc-800/50 transition-colors cursor-pointer print:hover:bg-transparent"
                                        onClick={() => setExpandedActor(expandedActor === row.name ? null : row.name)}
                                    >
                                        <td className="p-4 font-bold text-sm text-zinc-200 print:text-black flex items-center gap-2">
                                            {row.name}
                                            <ChevronDown size={14} className={`text-zinc-600 transition-transform print:hidden ${expandedActor === row.name ? 'rotate-180' : ''}`}/>
                                        </td>
                                        <td className="p-4 text-xs font-mono text-zinc-400 print:text-black">
                                            {renderCall(row.fri)}
                                        </td>
                                        <td className="p-4 text-xs font-mono text-zinc-400 print:text-black">
                                            {renderCall(row.sat)}
                                        </td>
                                    </tr>
                                    
                                    {/* EXPANDED DETAILS (Hidden on Print usually, but you might want to toggle this) */}
                                    {expandedActor === row.name && (
                                        <tr className="bg-zinc-950/50 print:hidden">
                                            <td colSpan={3} className="p-4 pl-8 border-t border-white/5 shadow-inner">
                                                <div className="grid grid-cols-2 gap-8">
                                                    <div>
                                                        <h4 className="text-[10px] font-black uppercase text-zinc-500 mb-2">Friday Breakdown</h4>
                                                        {row.fri ? row.fri.flatMap((c:any) => c.segments).map((s:any, i:number) => (
                                                            <div key={i} className="flex justify-between text-xs text-zinc-400 py-1 border-b border-white/5">
                                                                <span>{formatTime(s.startTime)} - {s.sceneName}</span>
                                                                <span className="text-[9px] bg-zinc-800 px-1 rounded uppercase">{s.type}</span>
                                                            </div>
                                                        )) : <span className="text-xs italic text-zinc-600">None</span>}
                                                    </div>
                                                    <div>
                                                        <h4 className="text-[10px] font-black uppercase text-zinc-500 mb-2">Saturday Breakdown</h4>
                                                        {row.sat ? row.sat.flatMap((c:any) => c.segments).map((s:any, i:number) => (
                                                            <div key={i} className="flex justify-between text-xs text-zinc-400 py-1 border-b border-white/5">
                                                                <span>{formatTime(s.startTime)} - {s.sceneName}</span>
                                                                <span className="text-[9px] bg-zinc-800 px-1 rounded uppercase">{s.type}</span>
                                                            </div>
                                                        )) : <span className="text-xs italic text-zinc-600">None</span>}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    )}
                                </React.Fragment>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="app/components/ActorProfileModal.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import React, { useState, useMemo } from "react";
import { 
  X, Star, History, Calendar, Ruler, AlertCircle, User, 
  AlertOctagon, Clock, Mic2, Move, FileText, Clapperboard, CheckCircle2
} from "lucide-react";
import { 
  Radar, RadarChart, PolarGrid, PolarAngleAxis, 
  ResponsiveContainer, RadarProps 
} from "recharts";

// Fix for Recharts TS error
const RechartsRadar = Radar as unknown as React.FC<RadarProps>;

interface ActorProfileModalProps {
  actor: any;
  grades: any; // Expected keys: actingNotes, vocalNotes, danceNotes, adminNotes
  onClose: () => void;
}

export default function ActorProfileModal({ actor, grades, onClose }: ActorProfileModalProps) {
  const [activeTab, setActiveTab] = useState<"insights" | "history">("insights");

  // --- CHART DATA ---
  const chartData = [
    { subject: "Vocal", A: grades?.vocal || 0 },
    { subject: "Acting", A: grades?.acting || 0 },
    { subject: "Dance", A: grades?.dance || 0 },
    { subject: "Presence", A: grades?.presence || 0 },
  ];

  // --- DATA HELPERS ---
  const getRolesList = (roles: any) => {
    if (!roles) return ["No previous productions listed"];
    if (Array.isArray(roles)) return roles; 
    if (typeof roles === 'string') return roles.split(',').map((s: string) => s.trim());
    return [String(roles)];
  };

  const pastRolesList = getRolesList(actor.pastRoles);

  return (
    <div className="fixed inset-0 z-[200] bg-black/95 backdrop-blur-sm flex items-center justify-center p-0 md:p-4">
      <div className="bg-zinc-950 w-full h-full md:max-w-4xl md:h-[700px] md:rounded-3xl md:border md:border-white/10 overflow-hidden shadow-2xl flex flex-col md:flex-row relative">
        
        {/* CLOSE BUTTON (Mobile: Top Right floating, Desktop: Inside content area) */}
        <button 
            onClick={onClose} 
            className="absolute top-4 right-4 z-50 p-2 bg-black/50 backdrop-blur rounded-full text-zinc-400 hover:text-white md:hidden"
        >
            <X size={24} />
        </button>

        {/* --- LEFT (MOBILE: TOP): IDENTITY & RADAR --- */}
        <div className="p-6 md:p-8 border-b md:border-b-0 md:border-r border-white/5 bg-zinc-900/50 w-full md:w-[35%] flex flex-row md:flex-col items-center md:justify-start gap-6 shrink-0">
          
          {/* Avatar */}
          <div className="relative w-20 h-20 md:w-32 md:h-32 shrink-0">
            {actor.avatar ? (
              <img 
                src={actor.avatar} 
                alt={actor.name} 
                className="w-full h-full object-cover rounded-2xl border-2 border-white/10 shadow-xl"
              />
            ) : (
              <div className="w-full h-full bg-zinc-800 rounded-2xl flex items-center justify-center border-2 border-dashed border-white/10">
                <User size={32} className="text-zinc-600 md:w-12 md:h-12" />
              </div>
            )}
          </div>
          
          <div className="flex-1 md:w-full md:text-center">
              <h2 className="text-xl md:text-2xl font-black italic uppercase tracking-tight leading-tight">{actor.name}</h2>
              
              {/* Vitals Grid */}
              <div className="flex md:grid md:grid-cols-3 gap-2 mt-2 md:mt-6">
                 <div className="bg-black/40 px-3 py-1 md:p-2 rounded-lg text-center border border-white/5">
                    <p className="text-[8px] md:text-[9px] text-zinc-500 font-black uppercase tracking-widest">Height</p>
                    <p className="text-xs font-bold text-white">{actor.height || "-"}</p>
                 </div>
                 <div className="bg-black/40 px-3 py-1 md:p-2 rounded-lg text-center border border-white/5">
                    <p className="text-[8px] md:text-[9px] text-zinc-500 font-black uppercase tracking-widest">Age</p>
                    <p className="text-xs font-bold text-white">{actor.age}</p>
                 </div>
                 <div className="bg-black/40 px-3 py-1 md:p-2 rounded-lg text-center border border-white/5 hidden md:block">
                    <p className="text-[9px] text-zinc-500 font-black uppercase tracking-widest">Range</p>
                    <p className="text-xs font-bold text-white">{actor.vocalRange || "-"}</p>
                 </div>
              </div>
          </div>

          {/* Radar Chart (Hidden on small phones in landscape, visible on portrait/desktop) */}
          <div className="hidden md:block w-full h-40 mt-auto relative">
             <p className="absolute -top-2 w-full text-[9px] text-center text-zinc-500 font-black uppercase tracking-[0.2em]">Live Analysis</p>
             <ResponsiveContainer width="100%" height="100%">
              <RadarChart cx="50%" cy="55%" outerRadius="70%" data={chartData}>
                <PolarGrid stroke="#27272a" />
                <PolarAngleAxis dataKey="subject" tick={{ fill: '#71717a', fontSize: 10, fontWeight: '900' }} />
                <RechartsRadar dataKey="A" stroke="#3b82f6" fill="#3b82f6" fillOpacity={0.4} />
              </RadarChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* --- RIGHT (MOBILE: BOTTOM): CONTENT AREA --- */}
        <div className="flex-1 flex flex-col bg-zinc-950 relative min-w-0 overflow-hidden">
          
          {/* Desktop Close Button */}
          <button onClick={onClose} className="absolute top-6 right-6 text-zinc-500 hover:text-white z-10 transition-colors hidden md:block">
            <X size={20} />
          </button>

          {/* Tabs */}
          <div className="flex border-b border-white/5 p-4 gap-4 shrink-0 bg-zinc-950 sticky top-0 z-10">
            <button 
              onClick={() => setActiveTab("insights")}
              className={`pb-2 text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'insights' ? 'text-white border-b-2 border-blue-500' : 'text-zinc-500 hover:text-zinc-300'}`}
            >
              Casting Insights
            </button>
            <button 
              onClick={() => setActiveTab("history")}
              className={`pb-2 text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'history' ? 'text-white border-b-2 border-blue-500' : 'text-zinc-500 hover:text-zinc-300'}`}
            >
              Bio & Logistics
            </button>
          </div>

          <div className="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar pb-24 md:pb-8">
            {activeTab === "insights" ? (
              <div className="space-y-6 md:space-y-8">
                
                {/* 1. Song & Monologue Info */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="p-3 bg-zinc-900 rounded-xl border border-white/5">
                    <p className="text-[9px] font-black text-purple-400 uppercase mb-1 tracking-tighter">Planned Song</p>
                    <p className="text-xs font-bold text-zinc-300 line-clamp-1">{actor.song}</p>
                  </div>
                  <div className="p-3 bg-zinc-900 rounded-xl border border-white/5">
                    <p className="text-[9px] font-black text-emerald-400 uppercase mb-1 tracking-tighter">Monologue</p>
                    <p className="text-xs font-bold text-zinc-300 line-clamp-1">{actor.monologue}</p>
                  </div>
                </div>

                {/* 2. FEEDBACK GRID */}
                <section>
                   <div className="flex items-center gap-2 text-zinc-400 mb-4">
                    <Star size={14} className="text-blue-500" />
                    <span className="text-[10px] font-black uppercase tracking-widest">Panel Feedback</span>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {/* Acting Notes */}
                    <div className="bg-zinc-900/40 p-4 rounded-xl border border-white/5 hover:bg-zinc-900/60 transition-colors">
                        <div className="flex items-center gap-2 mb-2">
                            <Clapperboard size={12} className="text-blue-400" />
                            <p className="text-[10px] font-bold text-blue-400 uppercase">Director (Acting)</p>
                        </div>
                        <p className="text-xs text-zinc-300 italic leading-relaxed">
                            "{grades?.actingNotes || "No notes logged."}"
                        </p>
                    </div>

                    {/* Vocal Notes */}
                    <div className="bg-zinc-900/40 p-4 rounded-xl border border-white/5 hover:bg-zinc-900/60 transition-colors">
                        <div className="flex items-center gap-2 mb-2">
                            <Mic2 size={12} className="text-purple-400" />
                            <p className="text-[10px] font-bold text-purple-400 uppercase">Musical Director</p>
                        </div>
                        <p className="text-xs text-zinc-300 italic leading-relaxed">
                            "{grades?.vocalNotes || "No notes logged."}"
                        </p>
                    </div>

                    {/* Dance Notes */}
                    <div className="bg-zinc-900/40 p-4 rounded-xl border border-white/5 hover:bg-zinc-900/60 transition-colors">
                        <div className="flex items-center gap-2 mb-2">
                            <Move size={12} className="text-emerald-400" />
                            <p className="text-[10px] font-bold text-emerald-400 uppercase">Choreographer</p>
                        </div>
                        <p className="text-xs text-zinc-300 italic leading-relaxed">
                            "{grades?.choreoNotes || "No notes logged."}"
                        </p>
                    </div>

                    {/* Admin/Drop-In */}
                    <div className="bg-zinc-900/40 p-4 rounded-xl border border-white/5 hover:bg-zinc-900/60 transition-colors">
                        <div className="flex items-center gap-2 mb-2">
                            <FileText size={12} className="text-amber-400" />
                            <p className="text-[10px] font-bold text-amber-400 uppercase">Admin / Drop-In</p>
                        </div>
                        <p className="text-xs text-zinc-300 italic leading-relaxed">
                            "{grades?.adminNotes || "No flags."}"
                        </p>
                    </div>
                  </div>
                </section>

                {/* 3. CONFLICTS DASHBOARD */}
                <section className="pt-2">
                  <h4 className="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                    <AlertCircle size={14} /> Schedule Conflicts
                  </h4>
                  <ConflictAnalyzer conflicts={actor.conflicts} />
                </section>

              </div>
            ) : (
              <div className="space-y-8">
                {/* Bio Details */}
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-zinc-900 p-4 rounded-2xl border border-white/5">
                    <p className="text-[10px] font-black text-zinc-500 uppercase flex items-center gap-2 mb-1">
                      <Calendar size={12} /> Birthdate
                    </p>
                    <p className="text-sm font-bold text-white">{actor.dob || "N/A"}</p>
                  </div>
                  <div className="bg-zinc-900 p-4 rounded-2xl border border-white/5">
                    <p className="text-[10px] font-black text-zinc-500 uppercase flex items-center gap-2 mb-1">
                      <Ruler size={12} /> CYT Experience
                    </p>
                    <p className="text-sm font-bold text-white">{actor.tenure}</p>
                  </div>
                </div>

                {/* History */}
                <section>
                  <h4 className="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                    <History size={14} /> Production History
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {pastRolesList.map((role: string, i: number) => (
                      <div key={i} className="text-[11px] bg-zinc-900 text-zinc-300 px-3 py-2 rounded-lg border border-white/5 font-bold">
                        {role}
                      </div>
                    ))}
                  </div>
                </section>
              </div>
            )}
          </div>

          <div className="p-4 md:p-6 border-t border-white/5 bg-zinc-900/20 shrink-0 absolute bottom-0 w-full md:relative">
            <button 
              onClick={onClose}
              className="w-full bg-white text-black py-4 rounded-2xl font-black uppercase text-[10px] tracking-[0.2em] hover:invert transition-all active:scale-[0.98]"
            >
              Return to Deck
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// --- SUB-COMPONENT: SMART CONFLICT ANALYZER ---
function ConflictAnalyzer({ conflicts }: { conflicts: any }) {
  const data = useMemo(() => {
    let rawList: string[] = [];
    if (Array.isArray(conflicts)) {
        rawList = conflicts.map(c => typeof c === 'object' ? c.value : String(c));
    } else if (typeof conflicts === 'string') {
        rawList = conflicts.split(',').map(s => s.trim()).filter(Boolean);
    }

    if (rawList.length === 0 || (rawList.length === 1 && rawList[0].toLowerCase().includes("no known"))) {
        return { severe: 0, minor: 0, items: [] };
    }

    const items = rawList.map((str, i) => {
        const lower = str.toLowerCase();
        const isSevere = lower.includes("absent") || lower.includes("missing") || lower.includes("vacation") || lower.includes("out of town");
        const isMinor = lower.includes("late") || lower.includes("early") || lower.includes("leave") || lower.includes("tardy");
        
        return {
            id: i,
            text: str,
            severity: isSevere ? 'severe' : (isMinor ? 'minor' : 'unknown')
        };
    });

    return { 
        severe: items.filter(i => i.severity === 'severe').length, 
        minor: items.filter(i => i.severity !== 'severe').length, 
        items 
    };
  }, [conflicts]);

  if (data.items.length === 0) {
      return (
        <div className="p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-2xl flex items-center gap-3">
            <CheckCircle2 size={18} className="text-emerald-500" />
            <p className="text-xs font-bold text-emerald-400">No known conflicts</p>
        </div>
      );
  }

  return (
    <div className="space-y-4">
        {/* Summary Dashboard */}
        <div className="flex gap-3">
            <div className={`flex-1 p-3 rounded-xl border flex items-center gap-3 ${data.severe > 0 ? 'bg-red-500/10 border-red-500/30' : 'bg-zinc-900 border-white/5'}`}>
                <div className={`p-2 rounded-lg ${data.severe > 0 ? 'bg-red-500 text-white' : 'bg-zinc-800 text-zinc-500'}`}>
                    <AlertOctagon size={16} />
                </div>
                <div>
                    <p className="text-[10px] uppercase font-black tracking-widest opacity-60">Severe</p>
                    <p className={`text-xl font-black leading-none ${data.severe > 0 ? 'text-red-400' : 'text-zinc-600'}`}>{data.severe}</p>
                </div>
            </div>

            <div className={`flex-1 p-3 rounded-xl border flex items-center gap-3 ${data.minor > 0 ? 'bg-amber-500/10 border-amber-500/30' : 'bg-zinc-900 border-white/5'}`}>
                <div className={`p-2 rounded-lg ${data.minor > 0 ? 'bg-amber-500 text-black' : 'bg-zinc-800 text-zinc-500'}`}>
                    <Clock size={16} />
                </div>
                <div>
                    <p className="text-[10px] uppercase font-black tracking-widest opacity-60">Minor</p>
                    <p className={`text-xl font-black leading-none ${data.minor > 0 ? 'text-amber-400' : 'text-zinc-600'}`}>{data.minor}</p>
                </div>
            </div>
        </div>

        {/* Detailed List */}
        <div className="bg-zinc-900/50 border border-white/5 rounded-xl overflow-hidden">
            <div className="px-4 py-2 bg-zinc-900 border-b border-white/5">
                <p className="text-[9px] uppercase font-bold text-zinc-500">Conflict Details</p>
            </div>
            <div className="max-h-[120px] overflow-y-auto p-2 space-y-1 custom-scrollbar">
                {data.items.map((item) => (
                    <div key={item.id} className="flex items-start gap-2 p-2 rounded hover:bg-white/5 transition-colors">
                        <div className={`mt-1 w-1.5 h-1.5 rounded-full flex-shrink-0 ${item.severity === 'severe' ? 'bg-red-500' : 'bg-amber-500'}`} />
                        <p className="text-xs text-zinc-300 leading-snug">{item.text}</p>
                    </div>
                ))}
            </div>
        </div>
    </div>
  );
}
</file>

<file path="app/components/ComplianceDashboard.tsx">
"use client";

import React from 'react';
import { 
  CheckCircle2, 
  Circle, 
  User, 
  DollarSign, 
  FileText, 
  Camera, 
  Ruler,
  AlertCircle
} from 'lucide-react';

interface Student {
  id: string | number;
  performerName: string;
  signedAgreement: boolean;
  paidFees: boolean;
  headshotSubmitted: boolean;
  measurementsTaken: boolean;
}

interface ComplianceDashboardProps {
  students?: Student[];
  productionTitle: string; 
}

const ComplianceDashboard = ({ students = [], productionTitle = "Select a Production" }: ComplianceDashboardProps) => {
  
  // 1. Safety Check: If no students exist, show a specific message for THIS production
  if (!students || students.length === 0) {
    return (
      <div className="bg-zinc-950 text-zinc-50 p-6 min-h-screen flex flex-col items-center justify-center">
        <header className="mb-8 text-center">
          <h1 className="text-2xl font-bold tracking-tight">Staff Portal: Compliance & Onboarding</h1>
          <p className="text-zinc-400 mt-1">
            Production: <span className="text-emerald-500 font-medium">{productionTitle}</span>
          </p>
        </header>
        <div className="p-12 text-center text-zinc-500 border border-zinc-800 rounded-lg bg-zinc-900/50 max-w-md">
          <AlertCircle className="mx-auto h-12 w-12 text-zinc-600 mb-4" />
          <h3 className="text-lg font-medium text-zinc-300">No Cast Members Found</h3>
          <p className="text-sm mt-2">
            We couldn&apos;t find any cast members for <strong className="text-zinc-300">{productionTitle}</strong>.
          </p>
          <p className="text-xs mt-4 text-zinc-600">
             Ensure you have assigned roles in the <strong>Assignments</strong> table and linked them to this specific production.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-zinc-950 text-zinc-50 p-6 min-h-screen">
      <header className="mb-8 border-b border-zinc-900 pb-6">
        <div className="flex justify-between items-end">
          <div>
            <h1 className="text-2xl font-bold tracking-tight">Staff Portal: Compliance & Onboarding</h1>
            <p className="text-zinc-400 mt-1">
              Production: <span className="text-emerald-500 font-medium">{productionTitle}</span>
            </p>
          </div>
          <div className="text-right">
             <div className="text-xs text-zinc-500 uppercase font-bold tracking-wider">Total Cast</div>
             <div className="text-2xl font-mono text-zinc-200">{students.length}</div>
          </div>
        </div>
      </header>

      <div className="overflow-x-auto rounded-lg border border-zinc-800 shadow-xl shadow-black/20">
        <table className="w-full text-left text-sm">
          <thead className="bg-zinc-900 text-zinc-400 uppercase text-xs font-semibold">
            <tr>
              <th className="px-4 py-3">Performer</th>
              <th className="px-4 py-3 text-center">Agreement</th>
              <th className="px-4 py-3 text-center">Fees</th>
              <th className="px-4 py-3 text-center">Headshot</th>
              <th className="px-4 py-3 text-center">Measurements</th>
              <th className="px-4 py-3 text-right">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-zinc-800 bg-zinc-950/50">
            {students.map((student) => (
              <tr key={student.id} className="hover:bg-zinc-900/80 transition-colors group">
                <td className="px-4 py-4 font-medium flex items-center gap-3">
                  <div className="h-8 w-8 rounded-full bg-zinc-800 flex items-center justify-center text-zinc-400 group-hover:bg-zinc-700 group-hover:text-emerald-500 transition-colors">
                    <User size={16} />
                  </div>
                  <span className="text-zinc-200 group-hover:text-white transition-colors">
                    {student.performerName || "Unknown Performer"}
                  </span>
                </td>
                
                {/* Compliance Checkboxes */}
                <ComplianceCell checked={student.signedAgreement} icon={<FileText size={16}/>} />
                <ComplianceCell checked={student.paidFees} icon={<DollarSign size={16}/>} />
                <ComplianceCell checked={student.headshotSubmitted} icon={<Camera size={16}/>} />
                <ComplianceCell checked={student.measurementsTaken} icon={<Ruler size={16}/>} />

                <td className="px-4 py-4 text-right">
                  <button className="text-zinc-500 hover:text-white text-xs hover:bg-zinc-800 px-3 py-1.5 rounded transition-colors border border-transparent hover:border-zinc-700">
                    Details
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

const ComplianceCell = ({ checked, icon }: { checked: boolean; icon: React.ReactNode }) => (
  <td className="px-4 py-4 text-center">
    <button 
      className={`inline-flex items-center justify-center p-2 rounded-full transition-all duration-300 ${
        checked 
          ? 'bg-emerald-500/10 text-emerald-500 hover:bg-emerald-500/20' 
          : 'text-zinc-700 hover:text-zinc-500 hover:bg-zinc-800'
      }`}
      title={checked ? "Completed" : "Pending"}
    >
      {checked ? (
        <CheckCircle2 size={18} />
      ) : (
        <Circle size={18} />
      )}
    </button>
  </td>
);

export default ComplianceDashboard;
</file>

<file path="app/components/ConflictMatrix.tsx">
"use client";

import React, { useMemo, useState } from "react";
import { 
  AlertTriangle, 
  Check, 
  ChevronDown, 
  ChevronRight, 
  Search, 
  Calendar,
  XCircle
} from "lucide-react";

// --- TYPES (Based on your Schema) ---
interface Scene {
  id: number;
  name: string; // "Scene Name"
  act: string;  // "Act"
  roles: number[]; // Derived from "Blueprint Roles" or "Active Scenes" logic
}

interface Actor {
  id: number;
  name: string;
  conflicts: string[]; // Hydrated text from "Rehearsal Conflicts"
}

interface Assignment {
  roleId: number;
  actorId: number;
}

interface Props {
  scenes: any[];      // Raw Table 627
  roles: any[];       // Raw Table 605
  assignments: any[]; // Raw Table 603
  people: any[];      // Raw Table 599
}

export default function ConflictMatrix({ scenes, roles, assignments, people }: Props) {
  const [filterText, setFilterText] = useState("");
  const [showClear, setShowClear] = useState(true);

  // --- 1. DATA PREP & HYDRATION ---
  const processedData = useMemo(() => {
    // A. Map People to a Dictionary for O(1) lookup
    const actorMap = new Map<number, Actor>();
    people.forEach((p) => {
      // Handle the Link Row structure for conflicts
      const conflictRaw = p["Rehearsal Conflicts"];
      let conflictList: string[] = [];
      
      if (Array.isArray(conflictRaw)) {
        conflictList = conflictRaw.map((c: any) => c.value);
      }

      // Name Hydration Logic
      const name = p["Full Name"] || `Student ${p["Digital ID"]}`;
      
      actorMap.set(p.id, { id: p.id, name, conflicts: conflictList });
    });

    // B. Map Roles to Actors
    // We look at the ASSIGNMENTS table to see who plays what
    const roleActorMap = new Map<number, number[]>(); // RoleID -> [ActorID]
    
    assignments.forEach((a) => {
      const roleId = a["Performance Identity"]?.[0]?.id;
      const personId = a["Person"]?.[0]?.id;
      
      if (roleId && personId) {
        const current = roleActorMap.get(roleId) || [];
        if (!current.includes(personId)) {
          roleActorMap.set(roleId, [...current, personId]);
        }
      }
    });

    // C. Map Scenes to Actors (The "Who is in this scene?" logic)
    // Logic: Scene -> Linked Roles -> Assigned Actors
    const matrixRows = scenes
      .map((scene) => {
        const sceneName = scene["Scene Name"];
        // Check both directions: "Blueprint Roles" on Scene OR "Active Scenes" on Role
        // Assuming "Active Scenes" on Role is the source of truth based on your Casting Page code
        const rolesInScene = roles.filter((r) => {
          const activeScenes = r["Active Scenes"] || [];
          return activeScenes.some((s: any) => s.id === scene.id);
        });

        const actorsInScene = new Set<number>();
        rolesInScene.forEach((r) => {
          const actorIds = roleActorMap.get(r.id) || [];
          actorIds.forEach((id) => actorsInScene.add(id));
        });

        return {
          id: scene.id,
          name: sceneName,
          act: scene["Act"]?.value || "1",
          actors: Array.from(actorsInScene), // List of Actor IDs present
        };
      })
      .sort((a, b) => a.id - b.id); // Keep scenes in order

    // D. Get Unique Actors who are actually cast
    const uniqueActorIds = Array.from(new Set(matrixRows.flatMap((r) => r.actors)));
    const gridColumns = uniqueActorIds
      .map((id) => actorMap.get(id))
      .filter((a): a is Actor => !!a) // Remove undefined
      .sort((a, b) => a.name.localeCompare(b.name));

    return { rows: matrixRows, columns: gridColumns, actorMap };
  }, [scenes, roles, assignments, people]);

  const { rows, columns, actorMap } = processedData;

  // --- 2. FILTERING ---
  const visibleColumns = columns.filter(c => 
    c.name.toLowerCase().includes(filterText.toLowerCase())
  );

  return (
    <div className="flex flex-col h-full bg-zinc-950 text-white overflow-hidden">
      {/* HEADER BAR */}
      <div className="p-4 border-b border-white/10 bg-zinc-900 flex justify-between items-center shrink-0">
        <h2 className="text-lg font-black uppercase italic tracking-wider flex items-center gap-2">
          <Calendar className="text-red-500" /> Conflict Matrix
        </h2>
        
        <div className="flex items-center gap-4">
          <label className="flex items-center gap-2 text-xs font-bold uppercase text-zinc-400 cursor-pointer hover:text-white">
            <input 
              type="checkbox" 
              checked={showClear} 
              onChange={(e) => setShowClear(e.target.checked)}
              className="accent-blue-500"
            />
            Show Cleared Cells
          </label>
          
          <div className="relative">
            <Search size={14} className="absolute left-2 top-1/2 -translate-y-1/2 text-zinc-500" />
            <input 
              value={filterText}
              onChange={(e) => setFilterText(e.target.value)}
              placeholder="Filter Actors..." 
              className="bg-zinc-950 border border-white/10 rounded-lg pl-8 pr-3 py-1.5 text-xs text-white focus:border-blue-500 outline-none w-48 transition-all"
            />
          </div>
        </div>
      </div>

      {/* MATRIX CONTAINER */}
      <div className="flex-1 overflow-auto custom-scrollbar relative">
        <table className="w-full border-collapse">
          {/* TABLE HEAD: ACTORS */}
          <thead className="sticky top-0 z-20 bg-zinc-900 shadow-xl">
            <tr>
              <th className="sticky left-0 z-30 bg-zinc-900 border-b border-r border-white/10 p-4 min-w-[200px] text-left">
                <span className="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Scene / Actor</span>
              </th>
              {visibleColumns.map((actor) => (
                <th key={actor.id} className="p-2 border-b border-r border-white/10 min-w-[100px] w-[100px] align-bottom pb-4 relative group">
                  <div className="writing-vertical-lr rotate-180 text-xs font-bold text-zinc-300 uppercase tracking-wide whitespace-nowrap h-32 flex items-center">
                    {actor.name}
                  </div>
                  {/* Conflict Tooltip Header */}
                  {actor.conflicts.length > 0 && (
                    <div className="absolute top-2 left-1/2 -translate-x-1/2">
                      <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
                    </div>
                  )}
                </th>
              ))}
            </tr>
          </thead>

          {/* TABLE BODY: SCENES */}
          <tbody className="divide-y divide-white/5">
            {rows.map((scene) => (
              <tr key={scene.id} className="hover:bg-white/5 transition-colors group/row">
                {/* SCENE NAME */}
                <td className="sticky left-0 z-10 bg-zinc-950 group-hover/row:bg-zinc-900 border-r border-white/10 p-3">
                  <div className="flex items-baseline justify-between">
                    <span className="text-xs font-bold text-white truncate max-w-[180px]" title={scene.name}>
                      {scene.name}
                    </span>
                    <span className="text-[9px] font-black text-zinc-600 uppercase ml-2">Act {scene.act}</span>
                  </div>
                </td>

                {/* CELLS */}
                {visibleColumns.map((actor) => {
                  const isInScene = scene.actors.includes(actor.id);
                  const hasConflicts = actor.conflicts.length > 0;
                  // Note: In a real app, you'd check if the conflict DATE matches the scene DATE.
                  // For now, per rules, we highlight IF they are in the scene AND have ANY conflicts listed.
                  
                  if (!isInScene) {
                    return <td key={actor.id} className="bg-black/40 border-r border-white/5"></td>;
                  }

                  if (hasConflicts) {
                    return (
                      <td key={actor.id} className="bg-red-900/20 border-r border-white/5 p-2 text-center relative group/cell cursor-help hover:bg-red-900/40 transition-colors">
                        <AlertTriangle size={16} className="text-red-500 mx-auto" />
                        <span className="text-[9px] font-bold text-red-400 mt-1 block">Conflict</span>
                        
                        {/* HOVER DETAILS */}
                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-black border border-red-500/50 p-3 rounded-xl shadow-2xl z-50 hidden group-hover/cell:block">
                          <p className="text-[10px] font-black uppercase text-red-500 mb-1">Conflicts Listed:</p>
                          <ul className="text-[10px] text-zinc-300 list-disc pl-3 space-y-1">
                            {actor.conflicts.map((c, i) => (
                              <li key={i}>{c}</li>
                            ))}
                          </ul>
                        </div>
                      </td>
                    );
                  }

                  return (
                    <td key={actor.id} className={`border-r border-white/5 p-2 text-center ${!showClear ? 'opacity-20' : ''}`}>
                      <div className="flex justify-center">
                        <Check size={16} className="text-emerald-500/50" />
                      </div>
                    </td>
                  );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="app/components/ContextSwitcher.tsx">
"use client";

import { useFormStatus } from 'react-dom';
import { Check, Sparkles } from 'lucide-react';
import { switchProduction } from '@/app/actions'; // Import the action we just made

// Define the shape of a Production based on your new Baserow setup
type Production = {
  id: number;
  title: string;
  branch: string; // 'Fredericksburg' | 'Stafford'
  type: string;   // 'Main Stage' | 'Lite'
};

export default function ContextSwitcher({ 
  shows, 
  activeId 
}: { 
  shows: Production[], 
  activeId: number 
}) {
  
  return (
    <div className="p-2 space-y-1">
      <div className="px-2 pt-2 pb-1 flex justify-between items-center">
        <span className="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">
          Switch Context
        </span>
      </div>
      
      {shows.map((prod) => {
        const isActive = activeId === prod.id;
        
        return (
          <form key={prod.id} action={switchProduction}>
            <input type="hidden" name="productionId" value={prod.id} />
            <SubmitButton prod={prod} isActive={isActive} />
          </form>
        );
      })}
    </div>
  );
}

// Small helper to handle the "Pending" state during the switch
function SubmitButton({ prod, isActive }: { prod: Production, isActive: boolean }) {
  const { pending } = useFormStatus();

  return (
    <button
      disabled={pending}
      className={`w-full flex items-center gap-3 p-2 rounded-lg transition-colors text-left group
        ${isActive ? 'bg-zinc-800/80 border border-zinc-700' : 'hover:bg-zinc-800 border border-transparent'}
        ${pending ? 'opacity-50 cursor-wait' : ''}
      `}
    >
      {/* Visual Indicator of Branch */}
      <div className={`h-8 w-1 rounded-full shrink-0 
        ${prod.branch === 'Stafford' ? 'bg-amber-500' : 'bg-emerald-500'}
      `} />
      
      <div className="flex-1 min-w-0">
        <div className={`text-sm font-medium truncate ${isActive ? 'text-white' : 'text-zinc-400 group-hover:text-zinc-200'}`}>
          {prod.title}
        </div>
        <div className="flex gap-2 text-[10px] uppercase font-bold text-zinc-600 group-hover:text-zinc-500">
          <span>{prod.branch}</span>
          <span>‚Ä¢</span>
          <span>{prod.type}</span>
        </div>
      </div>
      
      {isActive && <Check size={14} className="text-emerald-500" />}
      {pending && <Sparkles size={14} className="text-zinc-500 animate-spin" />}
    </button>
  );
}
</file>

<file path="app/components/logo.svg">
<svg width="512" height="512" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect width="512" height="512" rx="128" fill="#09090b"/>
  
  <defs>
    <linearGradient id="showGradient" x1="156" y1="200" x2="356" y2="200" gradientUnits="userSpaceOnUse">
      <stop offset="0%" stop-color="#60a5fa" /> <stop offset="50%" stop-color="#c084fc" /> <stop offset="100%" stop-color="#34d399" /> </linearGradient>
  </defs>

  <path d="M165 140H125V180C125 195 135 205 150 205H165" stroke="white" stroke-width="35" stroke-linecap="round"/>
  <path d="M256 205V140M220 140H292" stroke="white" stroke-width="35" stroke-linecap="round"/>
  <path d="M347 140H387V140" stroke="white" stroke-width="35" stroke-linecap="round"/>
  <path d="M367 140V205" stroke="white" stroke-width="35" stroke-linecap="round"/>

  <path d="M140 380V280C140 230 180 230 256 230C332 230 372 230 372 280V380" stroke="#27272a" stroke-width="25" stroke-linecap="round"/>
  <rect x="120" y="380" width="272" height="20" rx="10" fill="#27272a"/>

  <path d="M256 250 L200 380 H312 L256 250Z" fill="url(#showGradient)" opacity="0.9"/>
  <path d="M256 250 L160 380 H180 L256 250Z" fill="#60a5fa" opacity="0.4"/>
  <path d="M256 250 L352 380 H332 L256 250Z" fill="#34d399" opacity="0.4"/>

</svg>
</file>

<file path="app/components/logo.tsx">
import React from 'react';

export const OpenBackstageLogo = ({ className = "w-10 h-10" }: { className?: string }) => (
  <svg 
    viewBox="0 0 512 512" 
    fill="none" 
    xmlns="http://www.w3.org/2000/svg" 
    className={className}
    aria-label="Open Backstage Logo"
  >
    <rect width="512" height="512" rx="128" className="fill-zinc-950"/>
    
    <defs>
      <linearGradient id="showGradient" x1="156" y1="200" x2="356" y2="200" gradientUnits="userSpaceOnUse">
        <stop offset="0%" className="stop-blue-400" stopColor="#60a5fa" />
        <stop offset="50%" className="stop-purple-400" stopColor="#c084fc" />
        <stop offset="100%" className="stop-emerald-400" stopColor="#34d399" />
      </linearGradient>
    </defs>

    {/* CYT Letters */}
    <path d="M165 140H125V180C125 195 135 205 150 205H165" stroke="white" strokeWidth="35" strokeLinecap="round"/>
    <path d="M256 205V140M220 140H292" stroke="white" strokeWidth="35" strokeLinecap="round"/>
    <path d="M347 140H387V140" stroke="white" strokeWidth="35" strokeLinecap="round"/>
    <path d="M367 140V205" stroke="white" strokeWidth="35" strokeLinecap="round"/>

    {/* Stage Arch */}
    <path d="M140 380V280C140 230 180 230 256 230C332 230 372 230 372 280V380" stroke="#27272a" strokeWidth="25" strokeLinecap="round"/>
    <rect x="120" y="380" width="272" height="20" rx="10" fill="#27272a"/>

    {/* Spotlight Beams */}
    <path d="M256 250 L200 380 H312 L256 250Z" fill="url(#showGradient)" opacity="0.9"/>
    <path d="M256 250 L160 380 H180 L256 250Z" fill="#60a5fa" opacity="0.4"/>
    <path d="M256 250 L352 380 H332 L256 250Z" fill="#34d399" opacity="0.4"/>
  </svg>
);
</file>

<file path="app/lib/CastingContext.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";
import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import { getAuditionees, submitAudition } from './baserow';

// 1. Define the shape of our data to kill the "redlines"
export interface Performer {
  id: number;
  name: string;
  age: number | string;
  height: string;
  dob: string;
  headshotUrl: string | null;
  tenure: string;
  conflicts: string;
  pastRoles: string[];
}

interface CastingContextType {
  performers: Performer[];
  grades: Record<number, any>;
  loading: boolean;
  saveAssessment: (performerId: number, productionId: number, newGrades: any) => Promise<void>;
  refreshData: () => Promise<void>;
}

const CastingContext = createContext<CastingContextType | null>(null);

export function CastingProvider({ children }: { children: React.ReactNode }) {
  const [performers, setPerformers] = useState<Performer[]>([]);
  const [grades, setGrades] = useState<Record<number, any>>({});
  const [loading, setLoading] = useState(true);

  const refreshData = useCallback(async () => {
    setLoading(true);
    try {
      const data = await getAuditionees();
      
      // 2. Map raw Baserow People (599) fields to our App's Performer interface
      const mapped: Performer[] = data.map((row: any) => ({
        id: row.id,
        // Match these exactly to your Baserow field names
        name: row["Full Name"] || "Unnamed Performer",
        age: row["Age"] || "N/A",
        height: row["Height (Feet)"] || "-", 
        dob: row["Date of Birth"] || "",
        headshotUrl: row["Headshot"]?.[0]?.url || null,
        // Status is often a single-select in Baserow, which returns an object
        tenure: typeof row["Status"] === 'object' ? row["Status"]?.value : row["Status"] || "Student",
        conflicts: row["Rehearsal Conflicts"] || "No known conflicts",
        pastRoles: row["Cast/Crew Assignments"] 
          ? row["Cast/Crew Assignments"].map((a: any) => a.value) 
          : [],
      }));

      setPerformers(mapped);
    } catch (e) {
      console.error("Baserow Sync Error:", e);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    refreshData();
  }, [refreshData]);

  // 3. The new "Save" logic that creates a record in the Auditions (630) table
  const saveAssessment = async (performerId: number, productionId: number, newGrades: any) => {
    // Optimistic Update: Show the score in the UI immediately
    setGrades(prev => ({
      ...prev,
      [performerId]: newGrades
    }));

    try {
      // POSTs a new row to the Auditions table
      await submitAudition(performerId, productionId, newGrades);
      console.log(`Audition record created for performer ${performerId}`);
    } catch (e) {
      console.error("Failed to save audition record:", e);
      alert("Error saving to Baserow. Check console.");
    }
  };

  return (
    <CastingContext.Provider value={{ 
      performers, 
      grades, 
      saveAssessment, 
      loading, 
      refreshData 
    }}>
      {children}
    </CastingContext.Provider>
  );
}

export const useCasting = () => {
  const context = useContext(CastingContext);
  if (!context) {
    throw new Error("useCasting must be used within a CastingProvider");
  }
  return context;
};
</file>

<file path="app/lib/educationFillerData.ts">
// app/lib/mockEducation.ts

export const MOCK_CLASSES = [
  { id: 101, name: "AVL Control Freaks", teacher: "Javier Negron", day: "Tuesday", time: "6:00pm - 8:00pm", location: "River of Life", enrolled: 7, ages: "13-18" },
  { id: 102, name: "Conquering the Craft of Choreography", teacher: "Ellie Jany", day: "Tuesday", time: "6:00pm - 8:00pm", location: "Hope Presbyterian Church", enrolled: 5, ages: "13-18" },
  { id: 103, name: "Dancing Through Life: Musical Theater", teacher: "Emily Williams", day: "Monday", time: "6:00pm - 8:00pm", location: "River Club Church", enrolled: 9, ages: "8-12" },
  { id: 104, name: "Double Take - Ultimate Performance", teacher: "Rebecca Moffitt & Pam King", day: "Monday", time: "6:00pm - 8:00pm", location: "River Club Church", enrolled: 16, ages: "13-18" },
  { id: 105, name: "Double Take: Sing It, Dance It!", teacher: "Pam King & Rebecca Moffitt", day: "Monday", time: "6:00pm - 8:00pm", location: "River Club Church", enrolled: 12, ages: "8-12" },
  { id: 106, name: "Giving the Go: Stage Management", teacher: "Brittany Walters", day: "Monday", time: "6:00pm - 8:00pm", location: "River Club Church", enrolled: 7, ages: "14-18" },
  { id: 107, name: "Happily Ever Laughter", teacher: "Jacob Ramirez", day: "Tuesday", time: "6:00pm - 8:00pm", location: "Hope Presbyterian Church", enrolled: 10, ages: "8-12" },
  { id: 108, name: "Harmonies and Heartbeats!", teacher: "Jacob Ramirez", day: "Monday", time: "6:00pm - 8:00pm", location: "Highway Assembly", enrolled: 14, ages: "13-18" },
  { id: 109, name: "Improv-aganza!", teacher: "Connor Worthington", day: "Tuesday", time: "6:00pm - 8:00pm", location: "Hope Presbyterian Church", enrolled: 16, ages: "12-18" },
  { id: 110, name: "Lion King KIDS - CYT Lite", teacher: "Anna H, Brianne C, Hailey B", day: "Tuesday", time: "6:00pm - 8:00pm", location: "River of Life", enrolled: 40, ages: "8-12" },
  { id: 111, name: "Our Gang - Minions", teacher: "Tiffany Jeffris", day: "Tuesday", time: "6:00pm - 7:30pm", location: "River of Life", enrolled: 12, ages: "5-8" },
  { id: 112, name: "Very Punny!", teacher: "Candace Johnson", day: "Monday", time: "6:00pm - 8:00pm", location: "Highway Assembly", enrolled: 6, ages: "13-18" },
];

// --- HELPER: MOCK STUDENT ENROLLMENT ---
// This ensures that when you look at the Cast List, random actors are assigned to these real classes.
export function getStudentClassData(personId: number) {
    // 1. Determine if enrolled (Let's say 40% of cast is in a class)
    const isEnrolled = (personId % 5) !== 0; 
    if (!isEnrolled) return null;

    // 2. Assign a class based on ID to keep it consistent
    const classIndex = personId % MOCK_CLASSES.length;
    const assignedClass = MOCK_CLASSES[classIndex];

    // 3. Simulate Attendance
    // Make Person ID #32 and #15 "At Risk" (Truant)
    const isAtRisk = personId === 32 || personId === 15; 

    return {
        className: assignedClass.name,
        teacher: assignedClass.teacher,
        // If at risk, they have 3 absences. Otherwise 0 or 1.
        absences: isAtRisk ? 3 : (personId % 7 === 0 ? 1 : 0),
        history: [
            { date: "Dec 2", status: isAtRisk ? "Absent" : "Present" },
            { date: "Dec 9", status: "Present" },
            { date: "Dec 16", status: isAtRisk ? "Absent" : "Present" },
            { date: "Jan 6", status: isAtRisk ? "Absent" : "Present" },
        ]
    };
}
</file>

<file path="app/privacy/page.tsx">
import React from 'react';
import Link from 'next/link';
import { Shield, ArrowLeft, Mail, Lock } from 'lucide-react';

export default function PrivacyPolicy() {
  const lastUpdated = "January 28, 2026"; // Update this date manually when you change the policy

  return (
    <div className="min-h-screen bg-zinc-950 text-zinc-300 font-sans selection:bg-emerald-500/30">
      
      {/* Header */}
      <header className="border-b border-white/5 bg-zinc-900/50 backdrop-blur-xl sticky top-0 z-50">
        <div className="max-w-4xl mx-auto px-6 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3 text-white font-bold tracking-tight">
            <Shield className="text-emerald-500" size={20} />
            <span>Open Backstage <span className="text-zinc-500 font-medium">Privacy</span></span>
          </div>
          <Link href="/" className="text-xs font-bold text-zinc-400 hover:text-white flex items-center gap-2 transition-colors">
            <ArrowLeft size={14} /> Back to App
          </Link>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-3xl mx-auto px-6 py-16">
        
        <div className="mb-12">
          <h1 className="text-4xl font-black text-white tracking-tighter mb-4">Privacy Policy</h1>
          <p className="text-zinc-500 text-sm">Last Updated: {lastUpdated}</p>
        </div>

        <div className="space-y-12">
          
          {/* Section 1: Introduction */}
          <section>
            <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
              1. Introduction
            </h2>
            <p className="leading-relaxed text-zinc-400">
              Open Backstage (&quot;we,&quot; &quot;our,&quot; or &quot;us&quot;) is committed to protecting your privacy. 
              This Privacy Policy explains how we collect, use, and safeguard your information when you use 
              our application tailored for CYT Fredericksburg. By accessing or using our Service, you agree 
              to the collection and use of information in accordance with this policy.
            </p>
          </section>

          {/* Section 2: Data Collection (Google OAuth Specifics) */}
          <section className="bg-zinc-900/50 p-6 rounded-2xl border border-white/5">
            <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
              <Lock size={18} className="text-emerald-500"/>
              2. Information We Collect
            </h2>
            <p className="mb-4 text-zinc-400">
              When you choose to sign in using <strong>Google OAuth</strong>, we collect the minimum amount of data required to create your account and verify your identity within our organization:
            </p>
            <ul className="space-y-3">
              <li className="flex gap-3 items-start">
                <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-2 shrink-0" />
                <span className="text-zinc-300"><strong>Email Address:</strong> Used as your unique identifier and for system notifications.</span>
              </li>
              <li className="flex gap-3 items-start">
                <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-2 shrink-0" />
                <span className="text-zinc-300"><strong>Full Name:</strong> Used to display your identity to stage managers and directors.</span>
              </li>
              <li className="flex gap-3 items-start">
                <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-2 shrink-0" />
                <span className="text-zinc-300"><strong>Profile Picture:</strong> Used for your user avatar within the dashboard.</span>
              </li>
            </ul>
          </section>

          {/* Section 3: How We Use Data */}
          <section>
            <h2 className="text-xl font-bold text-white mb-4">3. How We Use Your Information</h2>
            <p className="leading-relaxed text-zinc-400 mb-4">
              We use the information we collect for the following specific purposes:
            </p>
            <ul className="list-disc list-inside space-y-2 text-zinc-400 ml-2">
              <li>To provide, operate, and maintain the Open Backstage application.</li>
              <li>To match your account with existing family records in our production database.</li>
              <li>To manage cast and crew assignments, attendance, and production communication.</li>
              <li>To prevent fraudulent use of our services.</li>
            </ul>
          </section>

          {/* Section 4: Data Sharing */}
          <section>
            <h2 className="text-xl font-bold text-white mb-4">4. Data Sharing & Disclosure</h2>
            <p className="leading-relaxed text-zinc-400">
              We do <strong>not</strong> sell, trade, or otherwise transfer your personally identifiable information to outside parties. 
              Your data is strictly used for internal organizational management within CYT Fredericksburg. 
              We may share generic aggregated demographic information not linked to any personal identification information regarding visitors and users with our business partners and trusted affiliates.
            </p>
          </section>

          {/* Section 5: Data Security */}
          <section>
            <h2 className="text-xl font-bold text-white mb-4">5. Data Retention & Deletion</h2>
            <p className="leading-relaxed text-zinc-400 mb-4">
              We retain your personal information only for as long as is necessary for the purposes set out in this Privacy Policy. 
            </p>
            <p className="leading-relaxed text-zinc-400">
              <strong>Right to Delete:</strong> You have the right to request the deletion of your account and personal data. 
              If you wish to delete your data, please contact us at the email provided below, and we will remove your information from our active databases within 30 days.
            </p>
          </section>

          {/* Section 6: Contact */}
          <section className="border-t border-white/10 pt-8 mt-12">
            <h2 className="text-xl font-bold text-white mb-4">6. Contact Us</h2>
            <p className="text-zinc-400 mb-6">
              If you have any questions about this Privacy Policy, please contact us:
            </p>
            <div className="flex items-center gap-3 text-zinc-300 bg-zinc-900 w-fit px-4 py-3 rounded-xl border border-white/5">
              <Mail size={18} className="text-emerald-500" />
              <a href="mailto:database@cytfred.org" className="hover:text-white transition-colors">
                database@cytfred.org
              </a>
            </div>
          </section>

        </div>
      </main>

      {/* Footer */}
      <footer className="py-12 border-t border-white/5 text-center">
        <p className="text-zinc-600 text-xs">
          ¬© {new Date().getFullYear()} Open Backstage. Built for CYT Fredericksburg.
        </p>
      </footer>
    </div>
  );
}
</file>

<file path="app/terms/page.tsx">
import React from 'react';
import Link from 'next/link';
import { Shield, ArrowLeft, Scale, AlertCircle } from 'lucide-react';

export default function TermsOfService() {
  const lastUpdated = "January 28, 2026";

  return (
    <div className="min-h-screen bg-zinc-950 text-zinc-300 font-sans selection:bg-emerald-500/30">
      
      {/* Header */}
      <header className="border-b border-white/5 bg-zinc-900/50 backdrop-blur-xl sticky top-0 z-50">
        <div className="max-w-4xl mx-auto px-6 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3 text-white font-bold tracking-tight">
            <Shield className="text-emerald-500" size={20} />
            <span>Open Backstage <span className="text-zinc-500 font-medium">Terms</span></span>
          </div>
          <Link href="/" className="text-xs font-bold text-zinc-400 hover:text-white flex items-center gap-2 transition-colors">
            <ArrowLeft size={14} /> Back to App
          </Link>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-3xl mx-auto px-6 py-16">
        
        <div className="mb-12">
          <h1 className="text-4xl font-black text-white tracking-tighter mb-4">Terms of Service</h1>
          <p className="text-zinc-500 text-sm">Last Updated: {lastUpdated}</p>
        </div>

        <div className="space-y-12">
          
          {/* Section 1: Acceptance */}
          <section>
            <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
              <Scale size={18} className="text-emerald-500"/>
              1. Acceptance of Terms
            </h2>
            <p className="leading-relaxed text-zinc-400">
              By accessing and using <strong>Open Backstage</strong>, you agree to be bound by these Terms of Service. 
              If you do not agree to these terms, please do not use our services. These terms apply to all visitors, 
              users, and others who access or use the Service within the CYT Fredericksburg organization.
            </p>
          </section>

          {/* Section 2: Accounts */}
          <section>
            <h2 className="text-xl font-bold text-white mb-4">2. User Accounts</h2>
            <p className="leading-relaxed text-zinc-400 mb-4">
              When you create an account with us, you must provide information that is accurate, complete, and current at all times. 
              Failure to do so constitutes a breach of the Terms, which may result in immediate termination of your account on our Service.
            </p>
            <div className="bg-zinc-900/50 p-6 rounded-2xl border border-white/5">
                <h3 className="text-white font-bold text-sm mb-2">Your Responsibilities</h3>
                <ul className="space-y-2 text-sm text-zinc-400">
                    <li>‚Ä¢ You are responsible for safeguarding the Google account you use to access the Service.</li>
                    <li>‚Ä¢ You agree not to disclose your password to any third party.</li>
                    <li>‚Ä¢ You must notify us immediately upon becoming aware of any breach of security or unauthorized use of your account.</li>
                </ul>
            </div>
          </section>

          {/* Section 3: Acceptable Use */}
          <section>
            <h2 className="text-xl font-bold text-white mb-4">3. Acceptable Use</h2>
            <p className="leading-relaxed text-zinc-400 mb-2">
              You agree not to use the Service:
            </p>
            <ul className="list-disc list-inside space-y-2 text-zinc-400 ml-2">
              <li>In any way that violates any applicable national or international law.</li>
              <li>To exploit, harm, or attempt to exploit or harm minors in any way.</li>
              <li>To transmit any unsolicited or unauthorized advertising (spam).</li>
              <li>To impersonate or attempt to impersonate CYT Fredericksburg staff, another user, or any other person or entity.</li>
            </ul>
          </section>

          {/* Section 4: Intellectual Property */}
          <section>
            <h2 className="text-xl font-bold text-white mb-4">4. Intellectual Property</h2>
            <p className="leading-relaxed text-zinc-400">
              The Service and its original content (excluding Content provided by users), features, and functionality are and will remain 
              the exclusive property of Open Backstage and its licensors. The Service is protected by copyright, trademark, and other laws 
              of both the United States and foreign countries.
            </p>
          </section>

          {/* Section 5: Termination */}
          <section>
            <h2 className="text-xl font-bold text-white mb-4">5. Termination</h2>
            <p className="leading-relaxed text-zinc-400">
              We may terminate or suspend access to our Service immediately, without prior notice or liability, for any reason whatsoever, 
              including without limitation if you breach the Terms. All provisions of the Terms which by their nature should survive 
              termination shall survive termination, including, without limitation, ownership provisions, warranty disclaimers, indemnity, and limitations of liability.
            </p>
          </section>

          {/* Section 6: Limitation of Liability */}
          <section className="bg-red-500/5 p-6 rounded-2xl border border-red-500/10">
            <h2 className="text-xl font-bold text-red-400 mb-4 flex items-center gap-2">
              <AlertCircle size={18}/>
              6. Limitation of Liability
            </h2>
            <p className="leading-relaxed text-zinc-400 text-sm">
              In no event shall Open Backstage, nor its directors, employees, partners, agents, suppliers, or affiliates, be liable for any indirect, 
              incidental, special, consequential or punitive damages, including without limitation, loss of profits, data, use, goodwill, or other 
              intangible losses, resulting from (i) your access to or use of or inability to access or use the Service; (ii) any conduct or content 
              of any third party on the Service; (iii) any content obtained from the Service; and (iv) unauthorized access, use or alteration of your 
              transmissions or content, whether based on warranty, contract, tort (including negligence) or any other legal theory.
            </p>
          </section>

           {/* Section 7: Changes */}
           <section>
            <h2 className="text-xl font-bold text-white mb-4">7. Changes</h2>
            <p className="leading-relaxed text-zinc-400">
              We reserve the right, at our sole discretion, to modify or replace these Terms at any time. If a revision is material, we will try to 
              provide at least 30 days&apos; notice prior to any new terms taking effect. What constitutes a material change will be determined at our sole discretion.
            </p>
          </section>

          {/* Section 8: Contact */}
          <section className="border-t border-white/10 pt-8 mt-12">
            <h2 className="text-xl font-bold text-white mb-4">8. Contact Us</h2>
            <p className="text-zinc-400">
              If you have any questions about these Terms, please contact us at: 
              <a href="mailto:database@cytfred.org" className="text-emerald-500 hover:text-emerald-400 ml-1 font-bold transition-colors">
                database@cytfred.org
              </a>
            </p>
          </section>

        </div>
      </main>

      {/* Footer */}
      <footer className="py-12 border-t border-white/5 text-center">
        <p className="text-zinc-600 text-xs">
          ¬© {new Date().getFullYear()} Open Backstage. Built for CYT Fredericksburg.
        </p>
      </footer>
    </div>
  );
}
</file>

<file path="app/actions.ts">
'use server'

import { cookies } from 'next/headers'
import { redirect } from 'next/navigation'
import { revalidatePath } from 'next/cache'

export async function switchProduction(formData: FormData) {
  const productionId = formData.get('productionId')
  // 1. Capture the path the user is currently on
  const path = formData.get('redirectPath') as string || '/'

  if (productionId) {
     const cookieStore = await cookies()
     // Set the cookie
     cookieStore.set('active_production_id', productionId.toString())
  }

  // 2. Revalidate the specific page so it re-fetches data with the new ID
  revalidatePath(path)
  
  // 3. Redirect back to the same page
  redirect(path)
}
</file>

<file path="app/globals.css">
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}
</file>

<file path="app/layout.tsx">
import './globals.css';
import type { Metadata } from 'next';

// üõë THIS IS THE FIX FOR VERCEL
// This tells Next.js: "Do not try to build static HTML. 
// Render everything fresh on every request."
export const dynamic = 'force-dynamic';

export const metadata: Metadata = {
  title: 'Open Backstage',
  description: 'CYT Production Hub',
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" className="dark">
      {/* 1. suppressHydrationWarning: Keeps extensions like ColorZilla happy.
          2. NO Header here: This ensures the Login page gets the full, empty screen.
      */}
      <body 
        className="bg-zinc-950 text-zinc-100 h-screen w-screen overflow-hidden"
        suppressHydrationWarning={true}
      >
        {children}
      </body>
    </html>
  );
}
</file>

<file path="app/plan.md">
# PROJECT: Open Backstage (CYT Fredericksburg)

## 1. CORE MISSION
Build a localized, self-hosted operational dashboard to bypass the limitations of the legacy National website.
**Goal:** Relieve staff burnout, ensure data safety, and create a mobile-friendly "Home Hub" for operations.

## 2. THE TECH STACK
- **Backend:** Self-Hosted Baserow (Docker).
- **Frontend:** React / Next.js (Mobile-first).
- **Payment:** Payment Agnostic. We use external links (Zeffy/Square). We do NOT process credit cards in-app.
- **Hosting:** DigitalOcean (Coolify/Portainer).

## 3. POLITICAL & COMPLIANCE CONSTRAINTS (Non-Negotiable)
1.  **The "National" Wall:** We cannot integrate with the National Website via API. The legacy system is fragile and unmaintained.
2.  **The "CSV" Rule:** We must eventually export data to CSV to satisfy National's royalty/insurance requirements. The National DB is the "Legal Source of Truth." Open Backstage is the "Operational Source of Truth."
3.  **The "Zeffy" Protocol:** We use Zeffy for payments to save fees. We must explicitly warn parents about the "Optional Tip" model.
4.  **No "Shadow" Accounts:** We do not create "new" accounts. We map to the existing National ID (manually if needed) to prevent data fragmentation.

## 4. BRANDING
- **Name:** Open Backstage
- **Metaphor:** "Front of House" is the National Site (Public/Tickets). "Backstage" is our tool (Staff/Operations).
- **Domain:** open-backstage.org

## 5. CURRENT STATUS (Jan 2026)
- **Phase:** Spring Pilot.
- **Scope:** Casting, Class Registration, Payment Tracking, Rosters.
- **Not in Scope:** Automated Emails, Costume Inventory (Push to Summer).
</file>

<file path="app/providers.tsx">
// app/providers.tsx
"use client";

import { SessionProvider } from "next-auth/react";

export function Providers({ children }: { children: React.ReactNode }) {
  return <SessionProvider>{children}</SessionProvider>;
}
</file>

<file path="lib/CastingContext.tsx">
"use client";
import React, { createContext, useContext, useState } from 'react';
import { Performer, Role, Scene, Assignment, SceneAssignment } from './types';
const generateMockStudents = () => {
  const names = ["James", "Emma", "Liam", "Olivia", "Noah", "Ava", "Lucas", "Mia", "Ethan", "Sophia"];
  const lastNames = ["Smith", "Johnson", "Brown", "Taylor", "Miller", "Wilson", "Moore", "Anderson"];
  const tenures = ["New Student", "1-2 Shows", "3+ Shows"];
  const ranges = ["Soprano", "Alto", "Tenor", "Bass"];
  const songs = ["Part of Your World", "Giants in the Sky", "Tomorrow", "Santa Fe", "On My Own"];

  return Array.from({ length: 80 }).map((_, i) => ({
    id: i + 1,
    name: `${names[i % 10]} ${lastNames[i % 8]}`,
    age: Math.floor(Math.random() * 10) + 8, // Ages 8-18
    vocalRange: ranges[i % 4],
    tenure: tenures[i % 3],
    batch: (i < 30) ? 1 : (i < 60) ? 2 : 3, // Grouped by 30s
    auditionDetails: {
      song: songs[i % 5],
      monologue: i % 2 === 0 ? "Comedic A" : "Dramatic B"
    }
  }));
};
interface CastingContextType {
  performers: Performer[];
  roles: Role[];
  scenes: Scene[];
  assignments: Assignment[];
  sceneAssignments: SceneAssignment[];
  getPerformerStats: (personId: number) => Performer['stats'];
}

const CastingContext = createContext<CastingContextType | undefined>(undefined);

export function CastingProvider({ children }: { children: React.ReactNode }) {
  // Mock Data for Phase 1 - We will replace with Baserow API later
const [performers] = useState(generateMockStudents());
  
  const [scenes] = useState<Scene[]>([
    { id: 101, name: "Kansas", act: 1, weight: 'Medium' },
    { id: 102, name: "Munchkinland", act: 1, weight: 'Large' },
    { id: 201, name: "Emerald City", act: 2, weight: 'Large' }
  ]);

  const [assignments] = useState<Assignment[]>([
    { id: 1, personId: 1, roleId: 501 }
  ]);

  const [sceneAssignments] = useState<SceneAssignment[]>([
    { id: 1, roleId: 501, sceneId: 101 },
    { id: 2, roleId: 501, sceneId: 201 }
  ]);

  const getPerformerStats = (personId: number) => {
    const roles = assignments.filter(a => a.personId === personId).map(a => a.roleId);
    const sceneIds = sceneAssignments.filter(sa => roles.includes(sa.roleId)).map(sa => sa.sceneId);
    const assignedScenes = scenes.filter(s => sceneIds.includes(s.id));

    return {
      sceneCount: assignedScenes.length,
      act1: assignedScenes.some(s => s.act === 1),
      act2: assignedScenes.some(s => s.act === 2)
    };
  };

  return (
    <CastingContext.Provider value={{ performers, roles: [], scenes, assignments, sceneAssignments, getPerformerStats }}>
      {children}
    </CastingContext.Provider>
  );
}

export const useCasting = () => {
  const context = useContext(CastingContext);
  if (!context) throw new Error('useCasting must be used within CastingProvider');
  return context;
};
</file>

<file path="lib/PeopleContext.tsx">
"use client";
import React, { createContext, useContext, useMemo } from 'react';
import { Performer } from './types';

interface PeopleContextType {
  people: Performer[];
  getName: (id: number) => string;
}

const PeopleContext = createContext<PeopleContextType | undefined>(undefined);

export function PeopleProvider({
  children,
  people,
}: {
  children: React.ReactNode;
  people: Performer[];
}) {
  // Create a map for faster lookups (O(1) access)
  const peopleMap = useMemo(() => {
    const map = new Map<number, Performer>();
    people.forEach((p) => map.set(p.id, p));
    return map;
  }, [people]);

  const getName = (id: number) => {
    return peopleMap.get(id)?.name ?? 'Unknown';
  };

  return (
    <PeopleContext.Provider value={{ people, getName }}>
      {children}
    </PeopleContext.Provider>
  );
}

export function usePeople() {
  const context = useContext(PeopleContext);
  if (context === undefined) {
    throw new Error('usePeople must be used within a PeopleProvider');
  }
  return context;
}
</file>

<file path="lib/types.ts">
// lib/types.ts

export interface Performer {
  id: number; // Table 599
  name: string;
  age: number;
  headshot?: string; // URL to Baserow file
  vocalRange: string;
  tenure: string; // "New Student", "3+ Shows", etc.
  batch: number; // IMPORTANT: Needed for the Batch 1/2/3 filtering
  auditionDetails?: {
    song: string;
    monologue: string;
  };
  danceLevel?: string;
  stats?: {
    sceneCount: number;
    act1: boolean;
    act2: boolean;
  };
}

export interface Role {
  id: number; // Table 609
  name: string;
  productionId: number;
  isEnsemble: boolean;
}

export interface Scene {
  id: number; // Table 627
  name: string;
  act: 1 | 2;
  weight: 'Small' | 'Medium' | 'Large';
}

export interface Assignment {
  id: number; // Table 603
  personId: number;
  roleId: number;
}

export interface SceneAssignment {
  id: number; // Table 628
  roleId: number;
  sceneId: number;
}
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="eslint.config.mjs">
import { defineConfig } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";

export default defineConfig([
  ...nextVitals,
  {
    rules: {
      // Disable the specific accessibility warnings cluttering your screen
      "jsx-a11y/alt-text": "off",
      "jsx-a11y/role-has-required-aria-props": "off",
      "@next/next/no-img-element": "off"
    }
  }
]);
</file>

<file path="LICENSE">
MIT License

Copyright (c) 2025 Austin James Fitzhugh

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="next.config.ts">
/** @type {import('next').NextConfig} */
const nextConfig = {
  typescript: {
    // !! WARN !!
    // Dangerously allow production builds to successfully complete even if
    // your project has type errors.
    ignoreBuildErrors: true,
  },
  // Images config
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'files.baserow.io',
        port: '',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'cdn.pixabay.com',
        port: '',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'open-backstage.org',
        port: '',
        pathname: '/**',
      },
    ],
  },
};

export default nextConfig;
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="app/(main)/(casting)/callbacks/page.tsx">
import { cookies } from 'next/headers';
import { getAuditionees, getShowById, getActiveProduction } from '@/app/lib/baserow';
import CallbackManager from '@/app/components/casting/CallbackClient';

export default async function CallbacksPage() {
  const cookieStore = await cookies();
  const activeId = cookieStore.get('active_production_id')?.value;
  
  let show = null;
  if (activeId) show = await getShowById(activeId);
  if (!show) show = await getActiveProduction();

  if (!show) return <div>No active production found.</div>;

  // Just one fetch!
  const auditionees = await getAuditionees(show.id);

  return (
    <main className="h-screen bg-black overflow-hidden">
      <CallbackManager 
        initialAuditionees={auditionees} 
        productionTitle={show.title}
      />
    </main>
  );
}
</file>

<file path="app/(main)/(production)/analysis/page.tsx">
// app/(production)/analysis/page.tsx
import { getActiveProduction, getScenes } from '@/app/lib/baserow';
import SceneAnalysisClient from './SceneAnalysisClient';

export default async function AnalysisPage() {
  const production = await getActiveProduction();
  
  if (!production) return <div className="p-10 text-zinc-500">No Active Production found.</div>;

  const scenes = await getScenes(production.id);

  return (
    <main className="min-h-screen bg-zinc-950 flex flex-col text-white">
      <header className="p-8 border-b border-white/10 flex justify-between items-center bg-zinc-900/50">
        <div>
           <h1 className="text-2xl font-black uppercase tracking-tight">Production Assessment</h1>
           <p className="text-zinc-400 text-sm mt-1">
             Step 4 of 5: Rate the difficulty of each scene to calibrate the schedule.
           </p>
        </div>
      </header>
      
      <SceneAnalysisClient scenes={scenes} />
    </main>
  );
}
</file>

<file path="app/(main)/(production)/analysis/SceneAnalysisClient.tsx">
"use client";

import React, { useState } from 'react';
import { Save, AlertCircle, ArrowLeft } from 'lucide-react';
import { useRouter } from 'next/navigation';
import { updateSceneLoads } from '@/app/lib/actions'; 
import Link from 'next/link';

export default function SceneAnalysisClient({ scenes }: { scenes: any[] }) {
  const router = useRouter();
  const [localScenes, setLocalScenes] = useState(scenes);
  const [saving, setSaving] = useState(false);
  const [dirtyIds, setDirtyIds] = useState<Set<number>>(new Set());

  const handleUpdate = (id: number, type: 'music' | 'dance' | 'block', value: number) => {
    setLocalScenes(prev => prev.map(s => {
        if (s.id !== id) return s;
        return {
            ...s,
            load: { ...s.load, [type]: value }
        };
    }));
    setDirtyIds(prev => new Set(prev).add(id));
  };

  const saveChanges = async () => {
    if (dirtyIds.size === 0) return;
    setSaving(true);
    
    // Filter updates
    const updates = localScenes
      .filter(s => dirtyIds.has(s.id))
      .map(s => ({ id: s.id, load: s.load }));

    await updateSceneLoads(updates);
    
    setSaving(false);
    setDirtyIds(new Set());
    router.refresh();
  };

  return (
    <div className="flex-1 overflow-y-auto custom-scrollbar p-8 pb-32">
      
      {/* Sticky Save Bar */}
      <div className={`fixed bottom-8 right-8 z-50 transition-all duration-300 ${dirtyIds.size > 0 ? 'translate-y-0 opacity-100' : 'translate-y-20 opacity-0'}`}>
         <button 
           onClick={saveChanges}
           disabled={saving}
           className={`px-6 py-3 rounded-full font-bold shadow-2xl flex items-center gap-3 transition-colors ${saving ? 'bg-zinc-700 text-zinc-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-500 text-white'}`}
         >
           {saving ? (
             <>
               <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
               Saving...
             </>
           ) : (
             <>
               <Save size={18} /> Save {dirtyIds.size} Updates
             </>
           )}
         </button>
      </div>

      <div className="max-w-5xl mx-auto space-y-8">
        <Link href="/" className="flex items-center gap-2 text-zinc-500 hover:text-white transition-colors text-sm font-bold mb-4">
            <ArrowLeft size={16} /> Back to Dashboard
        </Link>

        {/* Intro Card */}
        <div className="bg-zinc-900 border border-white/10 rounded-xl p-6 flex gap-4">
           <AlertCircle className="text-blue-500 shrink-0" />
           <div>
              <h3 className="font-bold text-white">Calibration Mode</h3>
              <p className="text-zinc-400 text-sm mt-1">
                Drag the sliders (0-5) to estimate the teaching difficulty for each scene. 
                This data powers the &ldquo;Show Readiness&quot; burn-up chart on your dashboard.
              </p>
           </div>
        </div>

        {/* The Grid */}
        <div className="grid grid-cols-1 gap-4">
           {localScenes.map((scene) => (
             <div key={scene.id} className={`bg-zinc-900/50 border p-6 rounded-xl transition-all ${dirtyIds.has(scene.id) ? 'border-blue-500/30 bg-blue-500/5' : 'border-white/5 hover:border-white/10'}`}>
                <div className="flex justify-between items-start mb-6">
                    <div>
                        <span className="text-xs font-mono text-zinc-500">#{scene.order}</span>
                        <h3 className="text-lg font-bold text-white">{scene.name}</h3>
                        <span className="text-xs uppercase font-bold text-zinc-600">{scene.type}</span>
                    </div>
                    {dirtyIds.has(scene.id) && (
                        <div className="flex items-center gap-1.5 text-[10px] text-blue-400 font-bold uppercase tracking-wider bg-blue-500/10 px-2 py-1 rounded">
                            <div className="w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse" />
                            Unsaved
                        </div>
                    )}
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <Slider label="Music" value={scene.load.music} color="bg-blue-600" onChange={(v:number) => handleUpdate(scene.id, 'music', v)} />
                    <Slider label="Dance" value={scene.load.dance} color="bg-purple-600" onChange={(v:number) => handleUpdate(scene.id, 'dance', v)} />
                    <Slider label="Blocking" value={scene.load.block} color="bg-emerald-600" onChange={(v:number) => handleUpdate(scene.id, 'block', v)} />
                </div>
             </div>
           ))}
        </div>
      </div>
    </div>
  );
}

function Slider({ label, value, color, onChange }: any) {
    const descriptions = ["None", "Very Easy", "Easy", "Moderate", "Hard", "Complex"];
    return (
        <div>
            <div className="flex justify-between mb-2">
                <span className="text-xs font-bold text-zinc-400 uppercase tracking-wider">{label}</span>
                <span className={`text-xs font-bold ${value > 0 ? 'text-white' : 'text-zinc-600'}`}>
                    {value} - {descriptions[value]}
                </span>
            </div>
            <input 
                type="range" min="0" max="5" step="1" value={value}
                onChange={(e) => onChange(parseInt(e.target.value))}
                className={`w-full h-2 rounded-lg appearance-none cursor-pointer bg-zinc-800 accent-${color.replace('bg-', '')}`}
                style={{ background: `linear-gradient(to right, var(--tw-color-${color.replace('bg-', '')}-500) 0%, var(--tw-color-${color.replace('bg-', '')}-500) ${(value/5)*100}%, #27272a ${(value/5)*100}%, #27272a 100%)` }}
            />
        </div>
    );
}
</file>

<file path="app/(main)/(staff)/committees/page.tsx">
import { cookies } from 'next/headers';
import { 
    getCommitteeData, 
    getAuditionees, // <--- CHANGE THIS (was getAuditionSlots)
    getShowById, 
    getActiveProduction 
} from '@/app/lib/baserow';
import CommitteeClient from '@/app/components/committees/CommitteeClient'; // Ensuring path matches your error

export const dynamic = 'force-dynamic';

export default async function CommitteesPage() {
  const cookieStore = await cookies();
  const activeId = cookieStore.get('active_production_id')?.value;
  
  let show = null;
  if (activeId) show = await getShowById(activeId);
  if (!show) show = await getActiveProduction();

  if (!show) return <div className="p-20 text-center text-zinc-500">No active production found.</div>;

  // Fetch BOTH datasets securely on the server
  // We use getAuditionees() because it returns the list of students/actors
  const [volunteers, students] = await Promise.all([
      getCommitteeData(show.id),
      getAuditionees(show.id) 
  ]);

  return (
    <main className="h-screen bg-zinc-950 flex flex-col overflow-hidden">
      <CommitteeClient 
        volunteers={volunteers || []} // Safety fallback
        students={students || []}     // Safety fallback
        activeId={show.id}
      />
    </main>
  );
}
</file>

<file path="app/(main)/(staff)/reports/page.tsx">
import { cookies } from 'next/headers';
import { 
    getAuditionees, 
    getShowById, 
    getActiveProduction 
} from '@/app/lib/baserow';
import ReportsClient from '@/app/components/reports/ReportsClient';

// Force dynamic rendering so cookies work on Vercel
export const dynamic = 'force-dynamic';

export default async function ReportsPage() {
  const cookieStore = await cookies();
  const activeId = cookieStore.get('active_production_id')?.value;
  
  // 1. Resolve Active Show (Clean Logic)
  let show = null;
  if (activeId) {
      show = await getShowById(activeId);
  }
  // Fallback if cookie is missing or invalid
  if (!show) {
      show = await getActiveProduction();
  }

  // Handle "No Show" state gracefully
  if (!show) {
    return (
        <div className="h-screen flex items-center justify-center text-zinc-500 font-bold uppercase tracking-widest">
            No active production selected.
        </div>
    );
  }

  // 2. Fetch Report Data
  // We use getAuditionees because it contains Name, Status (New/Returning), and Student ID.
  const reportData = await getAuditionees(show.id);

  return (
    <main className="min-h-screen bg-zinc-950 p-8 text-white">
      <h1 className="text-3xl font-black uppercase italic mb-8 tracking-tighter">
        Production Report <span className="text-zinc-600 not-italic">/ {show.title}</span>
      </h1>

      {/* 3. Pass to Client Component */}
      <ReportsClient 
        data={reportData}
        showTitle={show.title}
      />
    </main>
  );
}
</file>

<file path="app/(main)/(staff)/roster/page.tsx">
import { cookies } from 'next/headers';
import { 
    getActiveProduction, 
    getShowById, // <--- 1. Import this!
    getAssignments, 
    getComplianceData, 
    getPeople 
} from '@/app/lib/baserow';
import StaffClient from '@/app/components/staff/StaffClient';

export default async function RosterPage() {
  const cookieStore = await cookies();
  const activeId = Number(cookieStore.get('active_production_id')?.value);
  
  let productionTitle = "Cast Roster";
  let productionId = activeId || 0;

  // 2. LOGIC FIX:
  if (activeId) {
      // If we have a cookie, fetch THAT specific show
      const showData = await getShowById(activeId);
      
      // Baserow sometimes returns an array [obj] or just obj depending on the endpoint
      const prod = Array.isArray(showData) ? showData[0] : showData;
      
      if (prod) productionTitle = prod.Title;
  } else {
      // Fallback: If no cookie, get the default "Active" show
      const prod = await getActiveProduction(); 
      if (prod) {
          productionTitle = prod.title;
          productionId = prod.id;
      }
  }

  // 3. Fetch Data using the determined ID
  const [assignments, people, compliance] = await Promise.all([
      getAssignments(productionId),
      getPeople(),
      getComplianceData(productionId)
  ]);

  return (
    <main className="h-full bg-zinc-950 overflow-hidden">
      <StaffClient 
        productionTitle={productionTitle} 
        assignments={assignments}
        people={people}
        compliance={compliance}
      />
    </main>
  );
}
</file>

<file path="app/(main)/analytics/analytics-client.tsx">
"use client";

import { useState, useMemo } from 'react';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, 
  ResponsiveContainer, Legend, Cell, LineChart, Line, AreaChart, Area 
} from 'recharts';
import { LayoutGrid, BarChart2, CalendarDays, Zap, Info, Landmark } from 'lucide-react';

export default function AnalyticsDashboard({ performanceData, showData, ticketPrice }: { performanceData: any[], showData: any[], ticketPrice: number }) {
  const [activeTab, setActiveTab] = useState<'shows' | 'velocity' | 'seasons'>('shows');

  // SIMULATED VELOCITY DATA (The "S-Curve" Industry Standard)
  const velocityData = useMemo(() => {
    // We mock a 6-week sales cycle (T-minus 42 days to Opening)
    const points = [];
    for (let i = 0; i <= 42; i++) {
      const day = 42 - i;
      // Logistic Growth Formula (The S-Curve)
      const targetPace = Math.floor(100 / (1 + Math.exp(-0.15 * (i - 30))));
      // Mock "Actual" based on the target with some random variance
      // eslint-disable-next-line react-hooks/purity
      const actualPace = i > 35 ? null : Math.max(0, targetPace - 5 + Math.random() * 10);
      
      points.push({
        name: `T-${day}`,
        target: targetPace,
        actual: actualPace ? Math.min(100, Math.round(actualPace)) : null,
      });
    }
    return points;
  }, []);

  const seasonData = useMemo(() => {
    const seasons: Record<string, any> = {};
    showData.forEach(show => {
      const s = show.season || "Other";
      if (!seasons[s]) seasons[s] = { name: s, totalSold: 0, totalCapacity: 0 };
      seasons[s].totalSold += show.totalSold;
      seasons[s].totalCapacity += show.totalCapacity;
    });
    return Object.values(seasons).sort((a: any, b: any) => b.name.localeCompare(a.name));
  }, [showData]);

  return (
    <div className="h-full flex flex-col">
      <div className="px-8 py-4 bg-zinc-950 flex gap-2 border-b border-white/5">
        <TabButton active={activeTab === 'shows'} onClick={() => setActiveTab('shows')} icon={<BarChart2 size={14}/>} label="Efficiency" />
        <TabButton active={activeTab === 'velocity'} onClick={() => setActiveTab('velocity')} icon={<Zap size={14}/>} label="Sales Velocity" />
        <TabButton active={activeTab === 'seasons'} onClick={() => setActiveTab('seasons')} icon={<Landmark size={14}/>} label="Market History" />
      </div>

      <div className="flex-1 p-8 overflow-y-auto custom-scrollbar bg-black/20">
        
        {/* VIEW: SHOW VS SHOW */}
        {activeTab === 'shows' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in fade-in slide-in-from-bottom-4">
            <div className="lg:col-span-2 bg-zinc-900/50 border border-white/5 p-8 rounded-[2.5rem]">
              <h3 className="text-xs font-black text-white uppercase tracking-widest mb-8 flex items-center gap-2">
                <LayoutGrid size={16} className="text-emerald-500" /> Revenue & Fill Rate by Production
              </h3>
              <div className="h-[400px]">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={showData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#18181b" vertical={false} />
                    <XAxis dataKey="name" stroke="#3f3f46" tick={{fill: '#71717a', fontSize: 10}} hide />
                    <YAxis stroke="#3f3f46" tick={{fill: '#71717a', fontSize: 10}} />
                    <Tooltip contentStyle={{ backgroundColor: '#09090b', borderColor: '#27272a', borderRadius: '16px' }} />
                    <Bar dataKey="avgFill" name="Fill %" radius={[6, 6, 0, 0]}>
                      {showData.map((e, i) => <Cell key={i} fill={e.avgFill > 75 ? '#10b981' : '#3b82f6'} />)}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="space-y-4">
               {showData.slice(0, 5).map(show => (
                 <div key={show.name} className="bg-zinc-900 border border-white/5 p-4 rounded-2xl">
                    <p className="text-[10px] font-black text-zinc-600 uppercase mb-1">{show.name}</p>
                    <div className="flex justify-between items-end">
                       <span className="text-xl font-black text-white italic">${(show.totalSold * ticketPrice).toLocaleString()}</span>
                       <span className="text-xs font-bold text-emerald-500">{show.avgFill}% Full</span>
                    </div>
                 </div>
               ))}
            </div>
          </div>
        )}

        {/* VIEW: SALES VELOCITY (Simulated S-Curve) */}
        {activeTab === 'velocity' && (
          <div className="bg-zinc-900/50 border border-white/5 p-8 rounded-[2.5rem] animate-in fade-in slide-in-from-bottom-4">
             <div className="flex items-center justify-between mb-8">
               <h3 className="text-xs font-black text-white uppercase tracking-widest flex items-center gap-2">
                 <Zap size={16} className="text-amber-500" /> Standard Ticket Velocity (Industry Benchmark)
               </h3>
               <div className="flex gap-4 text-[10px] font-bold uppercase tracking-widest">
                  <div className="flex items-center gap-2 text-zinc-500"><div className="w-2 h-2 rounded-full bg-zinc-700" /> Target Pace</div>
                  <div className="flex items-center gap-2 text-emerald-500"><div className="w-2 h-2 rounded-full bg-emerald-500" /> Current Avg</div>
               </div>
             </div>
             
             <div className="h-[450px]">
                <ResponsiveContainer width="100%" height="100%">
                  <AreaChart data={velocityData}>
                    <defs>
                      <linearGradient id="colorTarget" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#27272a" stopOpacity={0.3}/>
                        <stop offset="95%" stopColor="#27272a" stopOpacity={0}/>
                      </linearGradient>
                      <linearGradient id="colorActual" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#10b981" stopOpacity={0.3}/>
                        <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke="#18181b" />
                    <XAxis dataKey="name" stroke="#3f3f46" tick={{fill: '#71717a', fontSize: 9}} />
                    <YAxis stroke="#3f3f46" tick={{fill: '#71717a', fontSize: 10}} label={{ value: '% Capacity Sold', angle: -90, position: 'insideLeft', fill: '#52525b', fontSize: 10, fontWeight: 'bold' }} />
                    <Tooltip contentStyle={{ backgroundColor: '#09090b', borderColor: '#27272a', borderRadius: '16px' }} />
                    <Area type="monotone" dataKey="target" stroke="#52525b" strokeWidth={2} strokeDasharray="5 5" fillOpacity={1} fill="url(#colorTarget)" />
                    <Area type="monotone" dataKey="actual" stroke="#10b981" strokeWidth={4} fillOpacity={1} fill="url(#colorActual)" />
                  </AreaChart>
                </ResponsiveContainer>
             </div>
             <p className="mt-6 text-[10px] text-zinc-600 font-bold uppercase tracking-widest text-center flex items-center justify-center gap-2">
               <Info size={12} /> Target based on industry standard 6-week youth theatre sales cycle
             </p>
          </div>
        )}

        {/* VIEW: SEASONS */}
        {activeTab === 'seasons' && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-in fade-in slide-in-from-bottom-4">
             {seasonData.map(season => (
               <div key={season.name} className="bg-zinc-900/50 border border-white/5 p-6 rounded-3xl">
                  <div className="flex justify-between items-center mb-4">
                    <h4 className="text-sm font-black text-white italic">{season.name}</h4>
                    <span className="text-[10px] font-black text-emerald-500 bg-emerald-500/10 px-2 py-1 rounded tracking-widest">
                        ${(season.totalSold * ticketPrice).toLocaleString()}
                    </span>
                  </div>
                  <div className="space-y-2">
                    <div className="flex justify-between text-[10px] font-bold text-zinc-500 uppercase">
                        <span>Fill Rate</span>
                        <span>{Math.round((season.totalSold / season.totalCapacity) * 100)}%</span>
                    </div>
                    <div className="h-1.5 w-full bg-zinc-800 rounded-full overflow-hidden">
                        <div className="h-full bg-blue-500" style={{ width: `${(season.totalSold / season.totalCapacity) * 100}%` }} />
                    </div>
                  </div>
               </div>
             ))}
          </div>
        )}
      </div>
    </div>
  );
}

function TabButton({ active, onClick, icon, label }: { active: boolean, onClick: () => void, icon: any, label: string }) {
  return (
    <button 
      onClick={onClick}
      className={`px-5 py-2.5 rounded-2xl flex items-center gap-2 text-[10px] font-black uppercase tracking-widest transition-all ${active ? 'bg-zinc-100 text-black shadow-xl scale-[1.02]' : 'text-zinc-500 hover:text-zinc-300 hover:bg-zinc-900'}`}
    >
      {icon} {label}
    </button>
  );
}
</file>

<file path="app/(main)/education/EducationGrid.tsx">
"use client";

import { useState, useMemo } from "react";
import { 
  Users, MapPin, Clock, Filter, ChevronDown, Calendar, Search, X, 
  LayoutGrid, Building2, BarChart3, Church, School, Warehouse, DollarSign
} from "lucide-react";
import ClassManagerModal from "@/app/components/education/ClassManagerModal";

// --- HELPERS ---

function getSessionValue(sessionName: string) {
  if (!sessionName) return 0;
  const parts = sessionName.split(' ');
  let year = 0;
  let term = 0;
  parts.forEach(p => {
    if (p.match(/^\d{4}$/)) year = parseInt(p);
    if (p.includes('Winter')) term = 1;
    if (p.includes('Spring')) term = 4;
    if (p.includes('Summer')) term = 6;
    if (p.includes('Fall')) term = 9;
  });
  return (year * 100) + term;
}

// Extract "River Club Church" from "River Club Church - Dance Room"
function getVenueName(cls: any) {
    if (!cls.spaceName) return "TBD Location";
    // Split by " - " and take the first part, or just return spaceName if no hyphen
    return cls.spaceName.split(' - ')[0].trim();
}

// Generate a deterministic "Brand Color" for each venue
function getVenueTheme(venueName: string) {
    const name = venueName.toLowerCase();
    if (name.includes('river club')) return { color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20', icon: <Church size={14}/> };
    if (name.includes('hope')) return { color: 'text-orange-400', bg: 'bg-orange-500/10', border: 'border-orange-500/20', icon: <School size={14}/> };
    if (name.includes('highway')) return { color: 'text-purple-400', bg: 'bg-purple-500/10', border: 'border-purple-500/20', icon: <Building2 size={14}/> };
    if (name.includes('life')) return { color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20', icon: <Users size={14}/> };
    return { color: 'text-zinc-400', bg: 'bg-zinc-800', border: 'border-white/5', icon: <MapPin size={14}/> };
}

export default function EducationGrid({ classes }: { classes: any[] }) {
  const [selectedClass, setSelectedClass] = useState<any>(null);
  const [isSessionMenuOpen, setIsSessionMenuOpen] = useState(false);
  const [viewMode, setViewMode] = useState<'grid' | 'campus' | 'metrics'>('grid');
  
  // 1. EXTRACT & SORT SESSIONS
  const sessions = useMemo(() => {
    const unique = Array.from(new Set(classes.map(c => c.session).filter(Boolean)));
    return unique.sort((a, b) => getSessionValue(b) - getSessionValue(a));
  }, [classes]);

  const [activeSession, setActiveSession] = useState<string>(sessions[0] || "");

  // 2. DERIVED DATA FOR CURRENT SESSION
  const sessionClasses = useMemo(() => {
    return classes.map(c => ({
        ...c,
        venue: getVenueName(c) // Inject Venue Name here for easy filtering
    })).filter(c => c.session === activeSession);
  }, [classes, activeSession]);

  // 3. EXTRACT FILTERS FROM CURRENT DATA
  const availableVenues = useMemo(() => Array.from(new Set(sessionClasses.map(c => c.venue))).sort(), [sessionClasses]);
  const availableDays = useMemo(() => Array.from(new Set(sessionClasses.map(c => c.day).filter(Boolean))).sort(), [sessionClasses]);
  const availableAges = useMemo(() => Array.from(new Set(sessionClasses.map(c => c.ageRange).filter(Boolean))).sort(), [sessionClasses]);

  // 4. FILTERS STATE
  const [filterVenue, setFilterVenue] = useState<string | null>(null);
  const [filterDay, setFilterDay] = useState<string | null>(null);
  const [filterAge, setFilterAge] = useState<string | null>(null);
  const [searchQuery, setSearchQuery] = useState("");

  // 5. APPLY FILTERS
  const visibleClasses = sessionClasses.filter(c => {
    const matchesVenue = filterVenue ? c.venue === filterVenue : true;
    const matchesDay = filterDay ? c.day === filterDay : true;
    const matchesAge = filterAge ? c.ageRange === filterAge : true;
    const matchesSearch = c.name.toLowerCase().includes(searchQuery.toLowerCase()) || 
                          c.teacher.toLowerCase().includes(searchQuery.toLowerCase());
    return matchesVenue && matchesDay && matchesAge && matchesSearch;
  });

  // 6. METRICS
  const metrics = useMemo(() => {
    const totalStudents = sessionClasses.reduce((acc, c) => acc + c.students, 0);
    const totalRevenue = totalStudents * 275; 
    const byTeacher = Object.entries(sessionClasses.reduce((acc: any, c) => {
        if (!acc[c.teacher]) acc[c.teacher] = { count: 0, students: 0 };
        acc[c.teacher].count++;
        acc[c.teacher].students += c.students;
        return acc;
    }, {})).sort((a: any, b: any) => b[1].students - a[1].students);

    const byVenue = Object.entries(sessionClasses.reduce((acc: any, c) => {
        if (!acc[c.venue]) acc[c.venue] = { classes: 0, students: 0 };
        acc[c.venue].classes++;
        acc[c.venue].students += c.students;
        return acc;
    }, {})).sort((a: any, b: any) => b[1].students - a[1].students);

    return { totalStudents, totalRevenue, byTeacher, byVenue };
  }, [sessionClasses]);

  // Group by Venue for "Campus View"
  const classesByVenue = useMemo(() => {
    return visibleClasses.reduce((acc: any, c) => {
      if (!acc[c.venue]) acc[c.venue] = [];
      acc[c.venue].push(c);
      return acc;
    }, {});
  }, [visibleClasses]);

  return (
    <>
      {/* --- TOP CONTROL BAR --- */}
      <div className="space-y-6 mb-8">
        
        <div className="flex flex-col xl:flex-row justify-between gap-6">
            {/* Session & View Switcher */}
            <div className="flex flex-col md:flex-row gap-4 flex-1">
                <div className="relative z-20 min-w-[240px]">
                    <button 
                        onClick={() => setIsSessionMenuOpen(!isSessionMenuOpen)}
                        className="flex items-center gap-3 bg-white text-black px-6 py-3 rounded-2xl font-black uppercase tracking-widest shadow-xl hover:bg-zinc-200 transition-colors w-full justify-between"
                    >
                        <span className="flex items-center gap-2 truncate">
                            <Calendar size={16} className="text-blue-600"/> 
                            {activeSession || "Select Session"}
                        </span>
                        <ChevronDown size={16} className={`transition-transform duration-300 ${isSessionMenuOpen ? 'rotate-180' : ''}`} />
                    </button>
                    {isSessionMenuOpen && (
                        <div className="absolute top-full left-0 mt-2 w-full bg-zinc-900 border border-white/10 rounded-2xl shadow-2xl overflow-hidden max-h-80 overflow-y-auto custom-scrollbar ring-1 ring-black/50">
                            {sessions.map((s, i) => (
                                <button key={s} onClick={() => { setActiveSession(s); setIsSessionMenuOpen(false); }} className={`w-full text-left px-5 py-3 text-xs font-bold uppercase tracking-widest border-b border-white/5 hover:bg-white/5 transition-colors ${activeSession === s ? 'text-blue-400 bg-blue-500/10' : 'text-zinc-400'}`}>
                                    {s}
                                </button>
                            ))}
                        </div>
                    )}
                </div>

                <div className="bg-zinc-900 border border-white/10 rounded-2xl p-1 flex items-center shrink-0">
                    <button onClick={() => setViewMode('grid')} className={`p-2.5 rounded-xl transition-all ${viewMode === 'grid' ? 'bg-zinc-800 text-white shadow-sm' : 'text-zinc-500 hover:text-zinc-300'}`} title="Grid View"><LayoutGrid size={18} /></button>
                    <button onClick={() => setViewMode('campus')} className={`p-2.5 rounded-xl transition-all ${viewMode === 'campus' ? 'bg-zinc-800 text-white shadow-sm' : 'text-zinc-500 hover:text-zinc-300'}`} title="Venue View"><Building2 size={18} /></button>
                    <div className="w-px h-6 bg-white/5 mx-1"></div>
                    <button onClick={() => setViewMode('metrics')} className={`p-2.5 rounded-xl transition-all ${viewMode === 'metrics' ? 'bg-blue-600 text-white shadow-lg' : 'text-zinc-500 hover:text-blue-400'}`} title="Analytics"><BarChart3 size={18} /></button>
                </div>

                {viewMode !== 'metrics' && (
                    <div className="relative flex-1">
                        <Search size={16} className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500" />
                        <input type="text" placeholder="Search..." className="w-full bg-zinc-900/50 border border-white/5 rounded-2xl pl-12 pr-4 py-3 text-sm text-white focus:outline-none focus:border-blue-500/50 transition-all focus:bg-zinc-900" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                        {searchQuery && <button onClick={() => setSearchQuery('')} className="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500 hover:text-white"><X size={14} /></button>}
                    </div>
                )}
            </div>
        </div>

        {/* --- VENUE STRIP (The "Pretty Color-Coded" Feature) --- */}
        {viewMode !== 'metrics' && (
            <div className="space-y-4">
                {/* Venue Pills */}
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    {/* "All Venues" Pill */}
                    <button 
                        onClick={() => setFilterVenue(null)}
                        className={`flex flex-col items-center justify-center p-3 rounded-2xl border transition-all ${
                            filterVenue === null 
                            ? 'bg-zinc-100 border-white text-black shadow-lg scale-105' 
                            : 'bg-zinc-900/50 border-white/5 text-zinc-500 hover:bg-zinc-800'
                        }`}
                    >
                        <LayoutGrid size={18} className="mb-2"/>
                        <span className="text-[9px] font-black uppercase tracking-widest">All Venues</span>
                        <span className="text-[9px] font-medium opacity-60">{sessionClasses.length} Classes</span>
                    </button>

                    {/* Dynamic Venue Pills */}
                    {availableVenues.map(venue => {
                        const theme = getVenueTheme(venue);
                        const count = sessionClasses.filter(c => c.venue === venue).length;
                        const isActive = filterVenue === venue;

                        return (
                            <button
                                key={venue}
                                onClick={() => setFilterVenue(isActive ? null : venue)}
                                className={`flex flex-col items-center justify-center p-3 rounded-2xl border transition-all relative overflow-hidden group ${
                                    isActive 
                                    ? `bg-zinc-950 ${theme.border} ${theme.color} shadow-lg scale-105 ring-1 ring-inset ${theme.color}` 
                                    : 'bg-zinc-900/50 border-white/5 text-zinc-500 hover:bg-zinc-800 hover:text-zinc-300'
                                }`}
                            >
                                <div className={`mb-2 p-2 rounded-full ${isActive ? theme.bg : 'bg-zinc-950'}`}>
                                    {theme.icon}
                                </div>
                                <span className="text-[9px] font-black uppercase tracking-widest text-center truncate w-full px-1">{venue}</span>
                                <span className="text-[9px] font-medium opacity-60 mt-0.5">{count} Classes</span>
                                
                                {isActive && <div className={`absolute inset-0 opacity-10 ${theme.bg}`} />}
                            </button>
                        )
                    })}
                </div>

                {/* Secondary Filters (Day/Age) */}
                <div className="flex flex-wrap items-center gap-2 pt-2 border-t border-white/5">
                    <span className="text-[10px] font-black uppercase text-zinc-600 tracking-widest mr-2 flex items-center gap-1"><Filter size={12}/> Refine:</span>
                    {availableDays.map(day => (
                        <button key={day} onClick={() => setFilterDay(filterDay === day ? null : day)} className={`px-4 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wide border transition-all ${filterDay === day ? 'bg-zinc-100 text-black border-white' : 'bg-zinc-900/30 border-white/5 text-zinc-500 hover:text-white'}`}>
                            {day}
                        </button>
                    ))}
                    <div className="w-px h-4 bg-white/10 mx-1 hidden sm:block"></div>
                    {availableAges.map(age => (
                        <button key={age} onClick={() => setFilterAge(filterAge === age ? null : age)} className={`px-4 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wide border transition-all ${filterAge === age ? 'bg-zinc-100 text-black border-white' : 'bg-zinc-900/30 border-white/5 text-zinc-500 hover:text-white'}`}>
                            {age}
                        </button>
                    ))}
                </div>
            </div>
        )}
      </div>

      {/* --- VIEW: GRID --- */}
      {viewMode === 'grid' && (
        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 pb-20">
            {visibleClasses.map((cls) => (
                <ClassCard key={cls.id} cls={cls} onClick={() => setSelectedClass(cls)} />
            ))}
            {visibleClasses.length === 0 && <EmptyState />}
        </div>
      )}

      {/* --- VIEW: VENUE (Grouped) --- */}
      {viewMode === 'campus' && (
        <div className="space-y-8 pb-20">
            {Object.keys(classesByVenue).sort().map(venue => {
                const theme = getVenueTheme(venue);
                return (
                    <div key={venue} className="space-y-4">
                        <div className={`flex items-center gap-3 sticky top-0 bg-zinc-950/95 backdrop-blur-md p-4 z-10 border-y border-white/5 ${theme.color}`}>
                            {theme.icon}
                            <h3 className="text-lg font-black uppercase tracking-tight text-white">{venue}</h3>
                            <span className="ml-auto text-xs font-bold text-zinc-500 bg-zinc-900 border border-white/5 px-3 py-1 rounded-full">
                                {classesByVenue[venue].length} Classes
                            </span>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 px-2">
                            {classesByVenue[venue].map((cls: any) => (
                                <ClassCard key={cls.id} cls={cls} onClick={() => setSelectedClass(cls)} />
                            ))}
                        </div>
                    </div>
                )
            })}
            {visibleClasses.length === 0 && <EmptyState />}
        </div>
      )}

      {/* --- VIEW: METRICS --- */}
      {viewMode === 'metrics' && (
        <div className="space-y-8 pb-20 animate-in fade-in slide-in-from-bottom-4">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <MetricCard icon={<Users className="text-blue-400"/>} label="Total Enrollment" value={metrics.totalStudents} sub="Students Active" color="bg-blue-500/10 border-blue-500/20"/>
                <MetricCard icon={<School className="text-purple-400"/>} label="Total Classes" value={sessionClasses.length} sub="Active Courses" color="bg-purple-500/10 border-purple-500/20"/>
                <MetricCard icon={<DollarSign className="text-emerald-400"/>} label="Est. Revenue" value={`$${(metrics.totalRevenue / 1000).toFixed(1)}k`} sub="Based on $275 avg" color="bg-emerald-500/10 border-emerald-500/20"/>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="bg-zinc-900/50 border border-white/5 rounded-3xl p-6">
                    <h3 className="text-sm font-black uppercase text-zinc-500 tracking-widest mb-6 flex items-center gap-2"><Building2 size={16} className="text-emerald-500"/> Venue Utilization</h3>
                    <div className="space-y-4">
                        {metrics.byVenue.map(([loc, data]: any) => {
                             const theme = getVenueTheme(loc);
                             return (
                                <div key={loc} className="flex-1">
                                    <div className="flex justify-between mb-1 items-center">
                                        <span className={`font-bold text-sm ${theme.color} flex items-center gap-2`}>{theme.icon} {loc}</span>
                                        <span className="text-xs font-mono text-zinc-400">{data.students} students</span>
                                    </div>
                                    <div className="h-2 w-full bg-zinc-950 rounded-full overflow-hidden border border-white/5">
                                        <div className={`h-full rounded-full ${theme.bg.replace('/10', '')}`} style={{ width: `${(data.students / metrics.totalStudents) * 100}%` }} />
                                    </div>
                                </div>
                             )
                        })}
                    </div>
                </div>

                <div className="bg-zinc-900/50 border border-white/5 rounded-3xl p-6">
                    <h3 className="text-sm font-black uppercase text-zinc-500 tracking-widest mb-6 flex items-center gap-2"><Users size={16} className="text-blue-500"/> Teacher Performance</h3>
                    <div className="space-y-3 max-h-[300px] overflow-y-auto custom-scrollbar pr-2">
                        {metrics.byTeacher.map(([teacher, data]: any) => (
                            <div key={teacher} className="flex items-center justify-between p-3 bg-zinc-950 border border-white/5 rounded-xl">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-full bg-zinc-900 flex items-center justify-center text-[10px] font-black text-zinc-500 border border-white/5">{teacher.substring(0,2).toUpperCase()}</div>
                                    <div><div className="font-bold text-white text-sm">{teacher}</div><div className="text-[10px] text-zinc-500 uppercase tracking-wider">{data.count} Classes</div></div>
                                </div>
                                <div className="text-right"><div className="font-black text-white">{data.students}</div><div className="text-[9px] text-zinc-600 font-black uppercase">Students</div></div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
      )}

      {selectedClass && <ClassManagerModal cls={selectedClass} onClose={() => setSelectedClass(null)} />}
    </>
  );
}

function ClassCard({ cls, onClick }: any) {
    const theme = getVenueTheme(cls.venue);
    return (
        <div onClick={onClick} className="group cursor-pointer bg-zinc-900/50 border border-white/5 hover:bg-zinc-900 hover:border-white/10 transition-all p-6 rounded-3xl relative overflow-hidden flex flex-col h-full shadow-sm hover:shadow-2xl">
            <div className={`absolute top-0 right-0 p-24 ${theme.bg} blur-3xl rounded-full opacity-0 group-hover:opacity-40 transition-opacity duration-500`} />
            <div className="relative z-10 flex flex-col h-full">
                <div className="flex justify-between items-start mb-4">
                    <span className={`px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border transition-colors ${cls.students > 0 ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : 'bg-zinc-950 text-zinc-600 border-white/5'}`}>{cls.students > 0 ? `${cls.students} Students` : 'Empty'}</span>
                    <span className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest flex items-center gap-1">{cls.ageRange}</span>
                </div>
                <h3 className="text-lg font-black text-white leading-tight mb-1 group-hover:text-blue-100 transition-colors line-clamp-2">{cls.name}</h3>
                <p className="text-xs font-bold text-zinc-500 mb-6">{cls.teacher}</p>
                <div className="mt-auto flex flex-col gap-2 text-xs text-zinc-400 font-medium border-t border-white/5 pt-4 group-hover:border-white/10 transition-colors">
                    <div className="flex items-center gap-2"><div className={theme.color}>{theme.icon}</div> <span className="truncate">{cls.venue}</span></div>
                    <div className="flex items-center gap-2"><Clock size={14} className="text-zinc-600"/> {cls.day} ‚Ä¢ {cls.time}</div>
                </div>
            </div>
        </div>
    )
}

function MetricCard({ icon, label, value, sub, color }: any) {
    return (
        <div className={`p-6 rounded-3xl border ${color} flex items-center gap-5`}>
            <div className="p-3 bg-zinc-950 rounded-xl border border-white/5">{icon}</div>
            <div>
                <div className="text-3xl font-black text-white tracking-tighter">{value}</div>
                <div className="text-xs font-bold uppercase text-zinc-500 tracking-widest mb-0.5">{label}</div>
                <div className="text-[10px] text-zinc-600">{sub}</div>
            </div>
        </div>
    )
}

function EmptyState() {
    return (
        <div className="col-span-full py-20 text-center border-2 border-dashed border-zinc-800 rounded-3xl bg-zinc-900/20">
            <Search size={48} className="mx-auto text-zinc-700 mb-4" />
            <p className="text-zinc-500 font-bold">No classes found.</p>
            <p className="text-zinc-600 text-xs mt-1">Try adjusting your filters or search terms.</p>
        </div>
    )
}
</file>

<file path="app/api/auth/[...nextauth]/route.ts">
import { handlers } from "@/auth"
export const { GET, POST } = handlers
</file>

<file path="app/components/auditions/AuditionsClient.tsx">
"use client";

import React, { useState, useEffect, useMemo } from "react";
import {
  User, Star, Music, Move, X, Save, Clock, CheckCircle2, 
  MessageSquare, Search, UserPlus, PlayCircle, Film, Loader2
} from "lucide-react";
import { getAuditionees, updateAuditionSlot, submitAudition } from "@/app/lib/baserow";
import ActorProfileModal from "@/app/components/ActorProfileModal";
import ChoreoWorkspace from "@/app/components/ChoreoWorkspace";

// --- TYPES ---
interface Performer {
  id: number;
  originalId: number;
  performerId?: number;
  name: string;
  avatar: string | null;
  age: string;
  video: string | null;
  height: string;
  vocalRange: string;
  dob: string;
  conflicts: string;
  tenure: string;
  pastRoles: string | string[];
  song: string;
  monologue: string;
  timeSlot: string;
  session: AuditionSession;
  vocal: number;
  acting: number;
  dance: number;
  presence: number;
  actingNotes: string;
  musicNotes: string;
  choreoNotes: string;
  dropInNotes: string;
  adminNotes: string;
  isWalkIn: boolean;
}

type AuditionSession = "Thursday" | "Friday" | "Video/Remote" | "Walk-In";
type JudgeRole = "Director" | "Music" | "Choreographer" | "Drop-In" | "Admin";

const ROLE_THEMES: Record<JudgeRole, { color: string; text: string; glow: string; weight: string }> = {
  Director: { color: "border-blue-500", text: "text-blue-400", glow: "shadow-blue-500/20", weight: "Acting 60% | Vocal 20% | Dance 20%" },
  Music: { color: "border-purple-500", text: "text-purple-400", glow: "shadow-purple-500/20", weight: "Vocal 80% | Acting 20%" },
  Choreographer: { color: "border-emerald-500", text: "text-emerald-400", glow: "shadow-emerald-500/20", weight: "Dance 80% | Presence 20%" },
  "Drop-In": { color: "border-amber-500", text: "text-amber-400", glow: "shadow-amber-500/20", weight: "Impression Only" },
  Admin: { color: "border-zinc-100", text: "text-zinc-100", glow: "shadow-white/5", weight: "Full Access" },
};

// --- HELPER COMPONENT: RUBRIC SLIDER ---
const RubricSlider = ({ label, val, setVal, disabled }: { label: string, val: number, setVal: (n: number) => void, disabled: boolean }) => (
  <div className={`space-y-3 ${disabled ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
    <div className="flex justify-between items-end">
      <label className="text-xs font-black uppercase tracking-widest text-zinc-400 flex items-center gap-2">
        {label === "Vocal Ability" && <Music size={14} className="text-purple-500" />}
        {label === "Acting / Reads" && <Star size={14} className="text-blue-500" />}
        {label === "Dance / Movement" && <Move size={14} className="text-emerald-500" />}
        {label}
      </label>
      <span className={`text-xl font-black ${val > 0 ? 'text-white' : 'text-zinc-700'}`}>{val || "-"}</span>
    </div>
    <input 
      type="range" min="0" max="5" step="1" value={val} 
      onChange={(e) => setVal(Number(e.target.value))} 
      className="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-blue-500" 
      aria-label={`Score for ${label}`} 
    />
    <div className="flex justify-between text-[9px] font-bold uppercase text-zinc-600 px-1">
      <span>N/A</span>
      <span>Weak</span>
      <span>Fair</span>
      <span>Good</span>
      <span>Great</span>
      <span>Exc.</span>
    </div>
  </div>
);

interface AuditionsClientProps {
  productionId: number;
  productionTitle: string;
}

export default function AuditionsClient({ productionId, productionTitle }: AuditionsClientProps) {
  const [isMounted, setIsMounted] = useState(false); 
  
  // Judge State (Stored in LocalStorage as it's device-specific)
  const [judgeName, setJudgeName] = useState("");
  const [judgeRole, setJudgeRole] = useState<JudgeRole | null>(null);
  const [isReady, setIsReady] = useState(false);

  // App State
  const [searchQuery, setSearchQuery] = useState("");
  const [activeSession, setActiveSession] = useState<AuditionSession>("Thursday");
  const [selectedPerson, setSelectedPerson] = useState<Performer | null>(null);
  const [inspectingActor, setInspectingActor] = useState<Performer | null>(null);
  const [loading, setLoading] = useState(false);

  // Data
  const [scheduledPerformers, setScheduledPerformers] = useState<Performer[]>([]);
  const [allStudents, setAllStudents] = useState<any[]>([]); 
  const [grades, setGrades] = useState<Record<number, any>>({});
  
  // Current Editing Score
  const [currentScores, setCurrentScores] = useState({
    vocal: 0, acting: 0, dance: 0, presence: 0, notes: "",
  });

  const reopenJudgeSetup = () => setIsReady(false);

  // ‚úÖ UPDATED INITIALIZATION LOGIC
  useEffect(() => {
    setIsMounted(true); 
    const savedName = localStorage.getItem("judgeName");
    const savedRole = localStorage.getItem("judgeRole") as JudgeRole | null;
    
    if (savedName && savedRole) {
      // Case A: User has used this before
      setJudgeName(savedName);
      setJudgeRole(savedRole);
      setIsReady(true);
    } else {
      // Case B: First time (or cleared cache) -> Default to Austin/Director
      const defaultName = "Austin Fitzhugh";
      const defaultRole: JudgeRole = "Director";

      setJudgeName(defaultName);
      setJudgeRole(defaultRole);
      
      // Save defaults so we don't have to set them again
      localStorage.setItem("judgeName", defaultName);
      localStorage.setItem("judgeRole", defaultRole);
      
      setIsReady(true); // Skip the modal!
    }
  }, []);

/* ---------- Data Fetching ---------- */
  useEffect(() => {
    const loadData = async () => {
      if (!isReady || !productionId) return;
      
      setLoading(true);
      console.log(`üöÄ Loading Auditions for ${productionTitle} (ID: ${productionId})...`);
      
      try {
        // 1. Fetch CLEAN data (The new baserow.ts handles the ugly extraction)
        const slots = await getAuditionees(productionId);

        console.log(`‚úÖ Loaded ${slots.length} actors.`);
        
        // Helper to format height if needed
        const formatHeight = (val: any) => {
          if (!val) return "N/A";
          if (String(val).includes("'")) return val; 
          const num = Number(val);
          if (isNaN(num)) return val;
          return `${Math.floor(num / 12)}'${num % 12}"`;
        };

        const formattedSchedule: Performer[] = slots.map((row: any) => {
   let session: AuditionSession = "Video/Remote";
   let displayTime = "TBD";

   if (row.date) {
     const dateObj = new Date(row.date); // "03/05/2026 17:00" parses correctly in JS
     const dayOfWeek = dateObj.getDay(); 
     
     // 4 = Thursday, 5 = Friday
     if (dayOfWeek === 4) session = "Thursday";
     else if (dayOfWeek === 5) session = "Friday";
     
     displayTime = dateObj.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
   } else if (row.video) {
               session = "Video/Remote";
           }

           // Check for Walk-In status
           if (row.status === "Walk-In") session = "Walk-In";

           return {
             id: row.id,
             originalId: row.id, 
             performerId: row.studentId, // Mapped in baserow.ts
             name: row.name || "Unknown Actor", // Mapped in baserow.ts
             avatar: row.headshot || null,      // Mapped in baserow.ts
             age: row.age || "?",
             video: row.video || null,
             height: formatHeight(row.height),
             vocalRange: row.vocalRange || "",
             dob: row.dob || "",
             conflicts: row.conflicts || "",
             tenure: row.status || "Unknown", // "New" or "Returning"
             pastRoles: row.pastRoles || [],
             song: row.song || "",
             monologue: row.monologue || "",
             timeSlot: displayTime,
             session: session,
             vocal: parseFloat(row.vocalScore) || 0,
             acting: parseFloat(row.actingScore) || 0,
             dance: parseFloat(row.danceScore) || 0,
             presence: parseFloat(row.presenceScore) || 0,
             actingNotes: row.actingNotes || "",
             musicNotes: row.musicNotes || "",
             choreoNotes: row.choreoNotes || "",
             dropInNotes: row.dropInNotes || "",
             adminNotes: row.adminNotes || "",
             isWalkIn: row.status === "Walk-In"
           };
        });

        setScheduledPerformers(formattedSchedule);

        const initialGrades: Record<number, any> = {};
        formattedSchedule.forEach(p => {
          if (p.vocal > 0 || p.dance > 0 || p.acting > 0 || p.video) initialGrades[p.id] = p;
        });
        setGrades(initialGrades);

        // Store full list for walk-in search
        setAllStudents(slots);

      } catch (err) {
        console.error("‚ùå CRITICAL LOAD ERROR:", err);
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, [isReady, productionId, productionTitle]);
  const handleChoreoSave = (actorId: number, score: number, notes: string, videoUrl?: string) => {
    const isDelete = videoUrl === "DELETE";

    setGrades(prev => ({
        ...prev,
        [actorId]: {
            ...prev[actorId],
            dance: score,
            choreoNotes: notes,
            video: isDelete ? null : (videoUrl || prev[actorId]?.video)
        }
    }));

    const payload: any = {
        "Dance Score": score > 0 ? score : null, 
        "Choreography Notes": notes
    };
    
    if (isDelete) {
        payload["Dance Video"] = ""; 
    } else if (videoUrl) {
        payload["Dance Video"] = videoUrl; 
    }
    
    updateAuditionSlot(actorId, payload).catch(err => console.error("Auto-save failed", err));
  };

  /* ---------- STANDARD SAVE ACTION ---------- */
  const handleCommit = async () => {
    if (!selectedPerson) return;
    
    const personId = selectedPerson.id;
    const originalId = selectedPerson.originalId;
    const isWalkIn = selectedPerson.isWalkIn;
    const scoresToSave = { ...currentScores };

    let noteField = "";
    switch (judgeRole) {
        case "Director": noteField = "actingNotes"; break; 
        case "Music": noteField = "musicNotes"; break;
        case "Choreographer": noteField = "choreoNotes"; break;
        case "Drop-In": noteField = "dropInNotes"; break;
        default: noteField = "adminNotes"; break;
    }

    setGrades((prev) => {
        const existingData = prev[personId] || {};
        return {
            ...prev,
            [personId]: {
                ...existingData,        
                ...scoresToSave,       
                [noteField]: scoresToSave.notes 
            }
        };
    });

    try {
      const payload: any = {
          "Vocal Score": scoresToSave.vocal > 0 ? scoresToSave.vocal : null,
          "Acting Score": scoresToSave.acting > 0 ? scoresToSave.acting : null,
          "Dance Score": scoresToSave.dance > 0 ? scoresToSave.dance : null,
          "Stage Presence Score": scoresToSave.presence > 0 ? scoresToSave.presence : null,
      };

      switch (judgeRole) {
          case "Director": payload["Acting Notes"] = scoresToSave.notes; break;
          case "Music": payload["Music Notes"] = scoresToSave.notes; break;
          case "Choreographer": payload["Choreography Notes"] = scoresToSave.notes; break;
          case "Drop-In": payload["Drop-In Notes"] = scoresToSave.notes; break;
          case "Admin": payload["Admin Notes"] = scoresToSave.notes; break;
      }

      if (isWalkIn) {
        // Use the SERVER ID provided via props
        await submitAudition(originalId, productionId, payload);
        alert("Walk-In Created!");
      } else {
        await updateAuditionSlot(personId, payload);
      }
      
      setSelectedPerson((current) => (current?.id === personId ? null : current));
      
    } catch (err) {
      console.error(err);
      alert("Save failed! Check connection.");
    }
  };

  /* ---------- Logic: Grouping & Scoring ---------- */
  const calculateWeightedScore = (scores: any) => {
    if (!judgeRole) return 0;
    const s = {
      vocal: Number(scores.vocal) || 0,
      acting: Number(scores.acting) || 0,
      dance: Number(scores.dance) || 0,
      presence: Number(scores.presence) || 0,
    };
    switch(judgeRole) {
      case "Director": return (s.acting * 0.7) + (s.vocal * 0.3); 
      case "Music": return (s.vocal * 0.8) + (s.acting * 0.2);
      case "Choreographer": return (s.dance * 0.8) + (s.presence * 0.2);
      default: return (s.vocal + s.acting + s.dance + s.presence) / 4;
    }
  };

  const visibleList = useMemo(() => {
    if (activeSession === "Walk-In") {
      if (!searchQuery) return [];
      return allStudents
        .filter(s => s["Full Name"]?.toLowerCase().includes(searchQuery.toLowerCase()))
        .map(s => ({
          id: -1, 
          originalId: s.id, 
          name: s["Full Name"],
          avatar: s.Headshot?.[0]?.url || null, 
          age: s.Age,
          timeSlot: "WALK-IN", 
          session: "Walk-In" as AuditionSession, 
          isWalkIn: true,
          vocal: 0, acting: 0, dance: 0, presence: 0, 
          actingNotes: "", musicNotes: "", choreoNotes: "", dropInNotes: "", adminNotes: "",
          height: "", vocalRange: "", dob: "", conflicts: "", tenure: "", pastRoles: [], song: "", monologue: "", video: null
        }));
    }
    return scheduledPerformers.filter((p) => {
        const matchesSession = p.session === activeSession;
        const matchesSearch = searchQuery ? p.name.toLowerCase().includes(searchQuery.toLowerCase()) : true;
        return matchesSession && matchesSearch;
    });
  }, [scheduledPerformers, allStudents, activeSession, searchQuery]);

  const grouped = useMemo(() => {
    if (activeSession === "Walk-In") return { "Walk-In Results": visibleList };
    const groups: Record<string, Performer[]> = {};
    visibleList.forEach((p) => {
      if (!groups[p.timeSlot]) groups[p.timeSlot] = [];
      groups[p.timeSlot].push(p);
    });
    return Object.keys(groups).sort().reduce((acc, key) => { acc[key] = groups[key]; return acc; }, {} as Record<string, Performer[]>);
  }, [visibleList, activeSession]);


 return (
  <>
    {/* --- JUDGE SETUP MODAL --- */}
    {!isReady && (
      <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-xl flex items-center justify-center p-4">
        <div className="w-full max-w-[420px] bg-zinc-950 border border-white/10 rounded-2xl p-6 md:p-8 space-y-6 shadow-2xl">
          <h2 className="text-2xl font-black uppercase tracking-tight">Judge Setup</h2>
          <div>
            <label className="block text-[10px] font-bold uppercase text-zinc-500 mb-1">Judge Name</label>
            <input value={judgeName} onChange={(e) => setJudgeName(e.target.value)} className="w-full bg-zinc-900 border border-white/10 rounded-lg p-3 text-sm focus:border-blue-500 outline-none transition-all" placeholder="Enter your name" />
          </div>
          <div>
            <label className="block text-[10px] font-bold uppercase text-zinc-500 mb-2">Judge Role</label>
            <div className="grid grid-cols-2 gap-2">
              {(Object.keys(ROLE_THEMES) as JudgeRole[]).map((role) => (
                <button key={role} onClick={() => setJudgeRole(role)} className={`p-3 rounded-lg border text-xs font-black uppercase transition-all ${judgeRole === role ? "bg-white text-black border-white shadow-lg" : "bg-zinc-900 border-zinc-800 text-zinc-400 hover:border-zinc-600"}`}>{role}</button>
              ))}
            </div>
          </div>
          <div className="flex gap-3 pt-2">
            {isMounted && localStorage.getItem("judgeName") && (
              <button onClick={() => setIsReady(true)} className="px-6 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-xl font-bold uppercase text-[10px] tracking-widest transition-colors">Cancel</button>
            )}
            <button disabled={!judgeName || !judgeRole} onClick={() => { localStorage.setItem("judgeName", judgeName); localStorage.setItem("judgeRole", judgeRole!); setIsReady(true); }} className="flex-1 bg-blue-600 hover:bg-blue-500 disabled:bg-zinc-800 disabled:text-zinc-500 py-4 rounded-xl font-black uppercase tracking-widest transition-colors shadow-lg shadow-blue-900/20">{isMounted && localStorage.getItem("judgeName") ? "Update Profile" : "Start Judging"}</button>
          </div>
        </div>
      </div>
    )}

    {/* --- MAIN UI --- */}
    {isReady && (
      judgeRole === 'Choreographer' ? (
        // === CHOREOGRAPHER WORKSPACE ===
        <div className="h-screen bg-black flex flex-col">
            <div className="h-14 bg-zinc-900 border-b border-white/5 flex items-center justify-between px-4 shrink-0">
                <button onClick={reopenJudgeSetup} className="text-[10px] font-black uppercase text-zinc-500 hover:text-white transition-colors">
                    Exit Dance Mode
                </button>
                <div className="flex gap-2">
                      {(["Thursday", "Friday", "Walk-In"] as const).map((s) => (
                        <button
                          key={s}
                          onClick={() => setActiveSession(s)}
                          className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase transition-all ${
                            activeSession === s ? "bg-white text-black" : "bg-zinc-800 text-zinc-500"
                          }`}
                        >
                          {s}
                        </button>
                      ))}
                </div>
            </div>
            
            <div className="flex-1 overflow-hidden">
                <ChoreoWorkspace 
                    people={visibleList} 
                    initialGrades={grades} 
                    onSave={handleChoreoSave} 
                />
            </div>
        </div>
      ) : (
        // === STANDARD AUDITION DECK ===
        <div className={`flex h-full bg-black text-white shadow-[0_0_50px_-12px_rgba(255,255,255,0.1)]`}>
          <div className="flex-1 flex flex-col min-w-0">
            
            {/* HEADER */}
            <header className={`p-4 md:p-6 border-b-2 bg-zinc-950 ${ROLE_THEMES[judgeRole!].color} shrink-0`}>
              <div className="flex flex-col md:flex-row justify-between md:items-center gap-4">
                <button onClick={reopenJudgeSetup} className="text-left group shrink-0">
                  <h1 className="text-xl md:text-2xl font-black italic uppercase">Audition Deck</h1>
                  <div className="flex items-center gap-2">
                      <p className="text-[9px] uppercase text-zinc-500">{judgeName} ‚Ä¢ {judgeRole}</p>
                      <span className="text-[9px] uppercase text-blue-500 font-bold ml-2">
                        {productionTitle}
                      </span>
                  </div>
                </button>

                {/* SCROLLABLE TABS */}
                <div className="flex gap-2 overflow-x-auto pb-2 md:pb-0 w-full md:w-auto no-scrollbar mask-linear-fade">
                  {(["Thursday", "Friday", "Video/Remote", "Walk-In"] as const).map((s) => (
                    <button key={s} onClick={() => { setActiveSession(s); setSearchQuery(""); }} className={`px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-colors whitespace-nowrap border border-transparent ${activeSession === s ? "bg-white text-black" : "bg-zinc-900 text-zinc-500 hover:text-zinc-300 border-white/5"}`}>
                      {s === "Walk-In" ? <span className="flex items-center gap-1"><UserPlus size={12}/> Walk-In</span> : s}
                    </button>
                  ))}
                </div>
              </div>

              <div className="mt-4 relative w-full md:w-64">
                <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-600" />
                <input value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full bg-zinc-900 rounded-lg py-2 pl-10 text-xs focus:ring-1 ring-white/10 outline-none text-white" placeholder={activeSession === "Walk-In" ? "Type student name..." : "Find in schedule..."} autoFocus={activeSession === "Walk-In"} />
              </div>
            </header>

            {/* LIST AREA */}
            <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
              {loading && <div className="text-center text-zinc-500 mt-20"><Loader2 className="animate-spin mx-auto mb-2"/> Loading Auditions...</div>}

              {activeSession === "Walk-In" && visibleList.length === 0 && !loading && (
                <div className="text-center text-zinc-500 mt-20"><UserPlus size={48} className="mx-auto mb-4 opacity-20" /><p className="text-sm">Start typing to find a student...</p></div>
              )}

              {Object.entries(grouped).map(([time, people]) => (
                <div key={time}>
                  {activeSession !== "Walk-In" && <h3 className="text-xs uppercase text-blue-500 mb-2 flex items-center gap-1 sticky top-0 bg-black/90 backdrop-blur py-2 z-10"><Clock size={12} /> {time}</h3>}
                  {people.map((person) => (
                    <div key={person.id} className="flex gap-2 mb-3 group">
                        <button
                          onClick={() => {
                            setSelectedPerson(person);
                            const saved = grades[person.id] || {};
                            let loadedNote = "";
                            if (saved.notes) {
                                loadedNote = saved.notes;
                            } else {
                                switch(judgeRole) {
                                    case "Director": loadedNote = person.actingNotes; break;
                                    case "Music": loadedNote = person.musicNotes; break;
                                    case "Drop-In": loadedNote = person.dropInNotes; break;
                                    case "Admin": loadedNote = person.adminNotes; break;
                                    default: loadedNote = ""; break;
                                }
                            }

                            setCurrentScores({
                                vocal: saved.vocal || person.vocal || 0,
                                acting: saved.acting || person.acting || 0,
                                dance: saved.dance || person.dance || 0,
                                presence: saved.presence || person.presence || 0,
                                notes: loadedNote || "", 
                            });
                          }}
                          className={`flex-1 flex items-center gap-3 md:gap-4 p-3 rounded-xl transition-all border min-w-0 ${selectedPerson?.id === person.id ? "bg-zinc-800 border-blue-500 ring-1 ring-blue-500" : "bg-zinc-900 border-white/5 hover:bg-zinc-800"}`}
                        >
                            <div className="relative flex-shrink-0">
                                {person.avatar ? <img src={person.avatar} className="w-10 h-10 md:w-12 md:h-12 rounded-full object-cover" alt="" /> : <div className="w-10 h-10 md:w-12 md:h-12 rounded-full bg-zinc-800 flex items-center justify-center"><User size={20} className="text-zinc-600"/></div>}
                                {grades[person.id] && !person.isWalkIn && <div className="absolute -top-1 -right-1 bg-black rounded-full"><CheckCircle2 size={14} className="text-emerald-500" /></div>}
                            </div>
                            <div className="text-left min-w-0 flex-1">
                                <p className="font-bold text-sm flex items-center gap-2 truncate">
                                  <span className="truncate">{person.name}</span>
                                  {person.video && <Film size={12} className="text-blue-500 shrink-0" />}
                                </p>
                                <p className="text-[10px] text-zinc-500 truncate">{person.isWalkIn ? "Click to Audition Now" : `Age ${person.age}`}</p>
                            </div>
                        </button>
                        
                        {person.video && (
                            <button
                                onClick={(e) => { e.stopPropagation(); window.open(person.video!, "_blank"); }}
                                className="w-10 md:px-4 bg-zinc-900 hover:bg-zinc-800 rounded-xl transition-colors border border-white/5 flex items-center justify-center text-blue-500 hover:text-blue-400 group-hover:border-blue-500/30 shrink-0"
                                title="Watch Audition"
                            >
                                <PlayCircle size={18} />
                            </button>
                        )}
                        
                        <button 
                          onClick={() => setInspectingActor(person)} 
                          className="w-10 md:px-4 bg-zinc-900 hover:bg-zinc-800 rounded-xl transition-colors border border-white/5 flex items-center justify-center text-zinc-400 hover:text-white shrink-0" 
                        >
                          <User size={18} />
                        </button>
                    </div>
                  ))}
                </div>
              ))}
            </div>
          </div>

          {/* SCORING SIDEBAR */}
          {selectedPerson && (
            <aside className="fixed inset-0 z-[200] w-full bg-zinc-950 flex flex-col md:relative md:w-[420px] md:border-l md:border-white/10 md:z-50">
                <div className="p-6 pb-4 border-b border-white/5 bg-zinc-900/50">
                  <div className="flex justify-between items-start mb-4">
                    <div className="flex gap-4">
                      <div className="w-20 h-20 rounded-2xl bg-zinc-800 overflow-hidden shadow-inner border border-white/10 shrink-0">
                        {selectedPerson.avatar ? <img src={selectedPerson.avatar} className="w-full h-full object-cover" alt={selectedPerson.name} /> : <div className="w-full h-full flex items-center justify-center text-zinc-600"><User size={32} /></div>}
                      </div>
                      <div>
                        <h2 className="text-2xl font-black italic uppercase leading-none tracking-tight">{selectedPerson.name}</h2>
                        <div className="flex items-center gap-2 mt-2">
                            <span className="bg-zinc-800 text-zinc-300 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide">{selectedPerson.isWalkIn ? "Walk-In" : `Age ${selectedPerson.age}`}</span>
                            {!selectedPerson.isWalkIn && <span className="border border-zinc-700 text-zinc-500 px-2 py-1 rounded text-[10px] font-bold uppercase">{selectedPerson.timeSlot}</span>}
                        </div>
                      </div>
                    </div>
                    <button onClick={() => setSelectedPerson(null)} className="text-zinc-500 hover:text-white transition-colors" aria-label="Close Panel"><X size={24}/></button>
                 </div>
               </div>

               <div className="p-6 space-y-6 flex-1 overflow-y-auto custom-scrollbar">
                  {selectedPerson.video && (
                     <div className="rounded-xl overflow-hidden border border-white/10 bg-black aspect-video relative group shadow-2xl">
                        <video src={selectedPerson.video} controls className="w-full h-full object-contain" poster={selectedPerson.avatar || undefined} />
                        <div className="absolute top-2 left-2 bg-black/60 backdrop-blur px-2 py-1 rounded text-[10px] font-bold uppercase text-white pointer-events-none border border-white/10">Audition Tape</div>
                     </div>
                  )}

                  <div className={`p-4 rounded-xl border ${ROLE_THEMES[judgeRole!].color} bg-zinc-900/50`}>
                      <div className="flex justify-between items-center">
                        <div>
                            <p className="text-[10px] font-black uppercase text-zinc-400 tracking-widest mb-1">Your Rating</p>
                            <p className="text-3xl font-black tabular-nums leading-none">{calculateWeightedScore(currentScores).toFixed(1)} <span className="text-sm text-zinc-600 font-normal">/ 5.0</span></p>
                        </div>
                        <div className="text-right">
                          <p className="text-[9px] uppercase text-zinc-500 font-bold leading-relaxed">{judgeRole} Priority:<br/><span className="text-zinc-300">{judgeRole === "Director" ? "Acting 70% | Vocal 30%" : ROLE_THEMES[judgeRole!].weight}</span></p>
                        </div>
                      </div>
                  </div>

                  <div className="space-y-6">
                      <RubricSlider label="Vocal Ability" val={currentScores.vocal} setVal={(v) => setCurrentScores((s) => ({ ...s, vocal: v }))} disabled={judgeRole !== "Music" && judgeRole !== "Admin"} />
                      <RubricSlider label="Acting / Reads" val={currentScores.acting} setVal={(v) => setCurrentScores((s) => ({ ...s, acting: v }))} disabled={judgeRole !== "Director" && judgeRole !== "Admin"} />
                      {(judgeRole === "Choreographer" || judgeRole === "Admin") && (
                        <RubricSlider label="Dance / Movement" val={currentScores.dance} setVal={(v) => setCurrentScores((s) => ({ ...s, dance: v }))} disabled={false} />
                      )}
                      <RubricSlider label="Stage Presence" val={currentScores.presence} setVal={(v) => setCurrentScores((s) => ({ ...s, presence: v }))} disabled={judgeRole !== "Director" && judgeRole !== "Admin"} />
                  </div>

                  <div className="pt-2 border-t border-white/5">
                    <label className="text-xs uppercase text-zinc-500 font-bold mb-3 block tracking-widest flex items-center gap-2"><MessageSquare size={12}/> Notes</label>
                    <textarea className="w-full bg-zinc-900 border border-white/10 p-4 rounded-xl text-sm min-h-[100px] focus:border-blue-500 outline-none resize-none transition-all placeholder:text-zinc-700" placeholder={`Internal notes for ${selectedPerson.name}...`} value={currentScores.notes} onChange={(e) => setCurrentScores((s) => ({ ...s, notes: e.target.value }))} />
                  </div>
               </div>

               <div className="p-6 border-t border-white/10 bg-zinc-900/50">
                 <button onClick={handleCommit} className="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-black uppercase tracking-widest shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 transition-transform active:scale-95">
                   <Save size={18} />
                   {selectedPerson.isWalkIn ? "Submit Walk-In" : "Save Score"}
                 </button>
               </div>
            </aside>
          )}
        </div>
      )
    )}

    {inspectingActor && <ActorProfileModal actor={inspectingActor} grades={grades[inspectingActor.id]} onClose={() => setInspectingActor(null)} />}
  </>
);
}
</file>

<file path="app/components/casting/CallbackClient.tsx">
"use client";

import React, { useState, useMemo } from 'react';
import { Users, Clock, Plus, Trash2, LayoutGrid, CheckCircle2 } from 'lucide-react';

export default function CallbackManager({ initialAuditionees, productionTitle }: any) {
  // We keep the "Slots" in local state since they aren't in the DB
  const [slots, setSlots] = useState([
    { id: 'dance-1', time: '10:00 AM', title: 'General Dance Call', type: 'Movement' },
    { id: 'vocals-1', time: '1:00 PM', title: 'Lead Vocals', type: 'Singing' }
  ]);

  // Local assignments (PerformerID -> SlotID)
  const [localAssignments, setLocalAssignments] = useState<Record<number, string>>({});

  const bench = useMemo(() => {
    return initialAuditionees.filter((p: any) => !localAssignments[p.id]);
  }, [initialAuditionees, localAssignments]);

  const handleDragOver = (e: React.DragEvent) => e.preventDefault();
  
  const handleDrop = (slotId: string, performerId: number) => {
    setLocalAssignments(prev => ({ ...prev, [performerId]: slotId }));
  };

  return (
    <div className="flex h-screen bg-black text-white">
      {/* SIDEBAR: BENCH */}
      <aside className="w-80 border-r border-white/10 flex flex-col bg-zinc-950">
        <div className="p-6 border-b border-white/10 bg-zinc-900/20">
          <h2 className="text-xs font-black uppercase tracking-widest text-zinc-500">Audition Pool</h2>
          <div className="text-2xl font-black italic uppercase tracking-tighter">{bench.length} Remaining</div>
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-2">
          {bench.map((p: any) => (
            <div 
              key={p.id} 
              draggable 
              onDragStart={(e) => e.dataTransfer.setData("performerId", p.id.toString())}
              className="bg-zinc-900 border border-white/5 p-3 rounded-xl flex items-center gap-3 cursor-grab hover:bg-zinc-800 transition-colors"
            >
               <img src={p.headshot} className="w-8 h-8 rounded-full object-cover border border-white/10" />
               <div className="text-xs font-bold truncate">{p.name}</div>
            </div>
          ))}
        </div>
      </aside>

      {/* MAIN: SLOTS */}
      <main className="flex-1 flex flex-col p-8 overflow-x-auto">
        <div className="flex gap-6 items-start h-full">
          {slots.map(slot => {
            const assigned = initialAuditionees.filter((p: any) => localAssignments[p.id] === slot.id);
            return (
              <div 
                key={slot.id} 
                onDragOver={handleDragOver}
                onDrop={(e) => handleDrop(slot.id, parseInt(e.dataTransfer.getData("performerId")))}
                className="w-80 shrink-0 bg-zinc-900/50 border border-white/5 rounded-[2rem] flex flex-col max-h-full"
              >
                <div className="p-6 border-b border-white/10">
                    <span className="text-[10px] font-black bg-blue-500/10 text-blue-400 px-2 py-1 rounded mb-2 block w-fit">{slot.time}</span>
                    <h3 className="text-lg font-black uppercase italic tracking-tight">{slot.title}</h3>
                </div>
                <div className="p-4 space-y-2 overflow-y-auto flex-1">
                    {assigned.map((p: any) => (
                        <div key={p.id} className="flex items-center gap-3 bg-zinc-950 p-2 rounded-xl border border-white/5 group">
                            <img src={p.headshot} className="w-6 h-6 rounded-full object-cover" />
                            <span className="text-xs font-bold flex-1">{p.name}</span>
                            <button onClick={() => {
                                const n = {...localAssignments};
                                delete n[p.id];
                                setLocalAssignments(n);
                            }} className="opacity-0 group-hover:opacity-100 text-zinc-600 hover:text-red-500"><Trash2 size={12}/></button>
                        </div>
                    ))}
                    <div className="h-20 border-2 border-dashed border-zinc-800 rounded-2xl flex items-center justify-center text-zinc-700 text-[10px] font-black uppercase">Drop Here</div>
                </div>
              </div>
            )
          })}
          <button onClick={() => setSlots([...slots, { id: Date.now().toString(), time: 'TBD', title: 'New Call', type: 'General' }])} className="w-80 shrink-0 h-20 border-2 border-dashed border-zinc-900 rounded-[2rem] flex items-center justify-center text-zinc-600 hover:text-white hover:border-zinc-700 transition-all uppercase font-black text-xs gap-2">
            <Plus size={16}/> Add Call Slot
          </button>
        </div>
      </main>
    </div>
  );
}
</file>

<file path="app/components/casting/CastingInspector.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import { useState } from "react";
import { X, Mic2, Move, FileText, ExternalLink, Clock } from "lucide-react";
import ActorProfileModal from "@/app/components/ActorProfileModal";

// Helper to generate consistent colors for roles
const getRoleColor = (roleName: string) => {
  if (!roleName) return "bg-zinc-800 border-zinc-700";
  const name = roleName.toLowerCase();
  if (name.includes("ariel") || name.includes("lead")) return "bg-blue-500 border-blue-400 shadow-[0_0_10px_rgba(59,130,246,0.4)]";
  if (name.includes("ursula") || name.includes("villain")) return "bg-purple-600 border-purple-400 shadow-[0_0_10px_rgba(147,51,234,0.4)]";
  if (name.includes("ensemble")) return "bg-emerald-600 border-emerald-400";
  if (name.includes("new role")) return "bg-amber-600 border-amber-400";
  
  const colors = [
    "bg-cyan-600 border-cyan-400", 
    "bg-indigo-600 border-indigo-400", 
    "bg-pink-600 border-pink-400",
    "bg-lime-600 border-lime-400"
  ];
  return colors[roleName.length % colors.length];
};

export default function CastingInspector({ actor, allScenes = [], stats = { assignments: {}, assignedRoleNames: [] }, onClose }: any) {
  const [showFullProfile, setShowFullProfile] = useState(false);

  if (!actor) return null;

  return (
    <>
      <div className="fixed inset-0 md:static md:inset-auto z-50 md:z-20 w-full md:w-[350px] h-full flex flex-col bg-zinc-900 md:border-l border-white/5 shadow-2xl transition-all">
        
        {/* HEADER */}
        <div className="p-6 pb-4 border-b border-white/5 relative bg-zinc-900 z-10 shrink-0">
          <button onClick={onClose} className="absolute top-4 right-4 text-zinc-500 hover:text-white transition-colors p-2 bg-black/20 rounded-full md:bg-transparent"><X size={20} /></button>
          
          <div className="flex items-start gap-4">
             <div className="w-16 h-16 rounded-full overflow-hidden border-2 border-white/10 shrink-0 bg-zinc-800">
               {/* üö® FIX: Using 'headshot' instead of 'Headshot' */}
               <img src={actor.headshot} className="w-full h-full object-cover" alt={actor.name} />
             </div>
             <div>
                {/* üö® FIX: Using 'name' instead of 'Performer' */}
                <h2 className="text-lg font-black text-white leading-tight">{actor.name}</h2>
                <div className="flex items-center gap-2 mt-1">
                    {actor.gender && actor.gender !== "N/A" && (
                        <span className="px-2 py-0.5 bg-zinc-800 text-zinc-400 text-[10px] font-bold uppercase rounded border border-white/5">{actor.gender}</span>
                    )}
                    <span className="px-2 py-0.5 bg-zinc-800 text-zinc-400 text-[10px] font-bold uppercase rounded border border-white/5">{actor.age || "Age ?"}</span>
                </div>
                <div className="flex gap-2 mt-3">
                   {/* üö® FIX: Updated paths to match getAuditionees clean object */}
                   {actor.actingNotes && <FileText size={14} className="text-blue-500" title="Has Acting Notes" />}
                   {actor.musicNotes && <Mic2 size={14} className="text-purple-500" title="Has Vocal Notes" />}
                   {actor.choreoNotes && <Move size={14} className="text-emerald-500" title="Has Dance Notes" />}
                </div>
             </div>
          </div>
        </div>

        {/* SCROLLABLE TIMELINE BODY */}
        <div className="flex-1 overflow-y-auto custom-scrollbar relative bg-zinc-950/50">
            <div className="absolute left-[27px] top-0 bottom-0 w-px bg-white/5 z-0" />

            <div className="p-4 space-y-1 relative z-10">
                 {allScenes.map((scene: any) => {
                     // Check if your scene data uses "id" or "Scene Name"
                     const roleInScene = stats.assignments?.[scene.id];
                     const isCast = !!roleInScene;
                     const isConflict = roleInScene && typeof roleInScene === 'string' && roleInScene.includes('+'); 
                     const dotColor = isConflict ? "bg-red-500 border-red-400 animate-pulse" : getRoleColor(roleInScene);

                     return (
                         <div 
                            key={scene.id} 
                            className={`group flex items-center gap-3 py-2 px-2 rounded-lg transition-all
                                ${isCast ? 'bg-zinc-800/80 border border-white/10 my-1 shadow-sm' : 'opacity-40 hover:opacity-80 hover:bg-white/5'}`
                            }
                         >
                             <div className="w-8 flex flex-col items-end shrink-0">
                                 <span className={`text-[9px] font-black uppercase ${isCast ? 'text-white' : 'text-zinc-600'}`}>{scene.act || scene.Act}</span>
                             </div>

                             <div className={`w-3 h-3 rounded-full border-2 shrink-0 transition-transform ${isCast ? dotColor : 'bg-zinc-900 border-zinc-700'}`} />

                             <div className="min-w-0 flex-1">
                                 <div className="flex justify-between items-baseline">
                                     <p className={`text-xs font-bold truncate ${isCast ? 'text-zinc-200' : 'text-zinc-500'}`}>{scene.name || scene["Scene Name"]}</p>
                                 </div>
                                 
                                 {isCast && (
                                     <div className="flex items-center gap-1.5 mt-0.5 animate-in slide-in-from-left-2 duration-300">
                                         <span className={`text-[9px] font-black uppercase px-1.5 rounded-sm bg-zinc-950 text-white border border-white/5 truncate max-w-full ${isConflict ? 'text-red-400 border-red-500/30' : ''}`}>
                                            {roleInScene}
                                         </span>
                                         {isConflict && <Clock size={10} className="text-red-500" />}
                                     </div>
                                 )}
                             </div>
                         </div>
                     );
                 })}
            </div>
            <div className="h-20" />
        </div>

        {/* FOOTER ACTIONS */}
        <div className="p-4 border-t border-white/5 bg-zinc-900 z-20 shrink-0 space-y-3 pb-safe">
            {stats.assignedRoleNames?.length > 0 && (
                <div className="flex flex-wrap gap-1.5 pb-2">
                    {stats.assignedRoleNames.map((role: string) => (
                        <span key={role} className="text-[9px] font-bold text-zinc-300 bg-zinc-800 px-2 py-1 rounded border border-white/5 flex items-center gap-1">
                            <div className={`w-1.5 h-1.5 rounded-full ${getRoleColor(role).split(' ')[0]}`} />
                            {role}
                        </span>
                    ))}
                </div>
            )}

            <button 
                onClick={() => setShowFullProfile(true)}
                className="w-full flex items-center justify-center gap-2 py-3 bg-white text-black text-xs font-black uppercase tracking-widest rounded-xl hover:scale-[1.02] active:scale-[0.98] transition-all"
            >
                <ExternalLink size={14} />
                View Full Profile
            </button>
        </div>

      </div>

      {showFullProfile && (
        <ActorProfileModal 
          actor={{
            ...actor,
            // üö® FIX: Already clean from getAuditionees, just passing through
            avatar: actor.headshot, 
          }}
          onClose={() => setShowFullProfile(false)}
        />
      )}
    </>
  );
}
</file>

<file path="app/components/casting/CastWorkspace.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import { Plus, Trash2, X, Copy } from "lucide-react";

interface Props {
  roles: any[];
  scenes: any[];
  onAddRole: () => void;
  onRemoveRole: (id: string) => void;
  onDuplicateRole: (id: string) => void;
  onDropActor: (e: React.DragEvent, roleId: string) => void;
  onRemoveActor: (roleId: string, actorId: number) => void;
  onToggleScene: (roleId: string, sceneId: number) => void;
  onSelectRole: (role: any) => void;
  onConfirmRole: (roleId: string, actorId: number) => void;
}

export default function CastWorkspace({ 
  roles, scenes, onAddRole, onRemoveRole, onDuplicateRole, onDropActor, onRemoveActor, onToggleScene, onSelectRole, onConfirmRole 
}: Props) {

  // üõ°Ô∏è REFACTORED: Use cleaner mapping for scene properties
  // Assuming your scenes come from a 'getScenes' that maps IDs to these keys
// üõ°Ô∏è REFACTORED HELPERS
const getSceneName = (scene: any) => {
  const val = scene.name || scene["Scene Name"];
  return typeof val === 'object' ? val.value : (val || "Untitled Scene");
};

const getSceneType = (scene: any) => {
  const val = scene.type || scene["Scene Type"];
  // If Baserow returns a Select object, grab the .value
  return typeof val === 'object' ? val.value : (val || "Scene");
};

const getSceneAct = (scene: any) => {
  const val = scene.act || scene.Act;
  return typeof val === 'object' ? val.value : (val || "");
};
  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  };

  const getSceneColor = (type: string) => {
    const t = String(type).toLowerCase();
    if (t.includes('song')) return 'bg-blue-500 border-blue-400';
    if (t.includes('dance')) return 'bg-purple-500 border-purple-400';
    return 'bg-emerald-600 border-emerald-500'; 
  };

  return (
    <main className="bg-zinc-950 flex flex-col overflow-hidden relative h-full">
      <header className="p-4 border-b border-white/5 bg-zinc-900/80 backdrop-blur-md z-10 flex justify-between items-center shrink-0">
        <div className="flex items-center gap-4">
            <h1 className="text-xl font-black italic uppercase hidden md:block text-white">Cast Grid</h1>
            <div className="flex items-center gap-3 px-3 py-1 bg-zinc-900 rounded-full border border-white/5 overflow-x-auto">
                <div className="flex items-center gap-1.5 shrink-0"><div className="w-2 h-2 rounded-full bg-emerald-500"></div><span className="text-[9px] font-bold text-zinc-400 uppercase">Scene</span></div>
                <div className="flex items-center gap-1.5 shrink-0"><div className="w-2 h-2 rounded-full bg-blue-500"></div><span className="text-[9px] font-bold text-zinc-400 uppercase">Song</span></div>
                <div className="flex items-center gap-1.5 shrink-0"><div className="w-2 h-2 rounded-full bg-purple-500"></div><span className="text-[9px] font-bold text-zinc-400 uppercase">Dance</span></div>
            </div>
        </div>

        <button onClick={onAddRole} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wide transition-all shadow-lg shadow-blue-900/20">
           <Plus size={14} /> <span className="hidden md:inline">Add Role</span>
        </button>
      </header>

      <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
        <div className="space-y-4 pb-20">
            {/* COLUMN HEADERS (SCENE NUMBERS) */}
            <div className="grid grid-cols-[140px_1fr_30px] md:grid-cols-[280px_1fr_30px] gap-4 mb-2 sticky top-0 z-20 pr-2">
                <div className="bg-zinc-950/80 backdrop-blur-sm rounded-lg"></div> 
                <div className="flex gap-0.5 h-8">
                    {scenes.map((scene, i) => (
                        <div key={scene.id} className="flex-1 min-w-0 group relative bg-zinc-800 border border-white/5 hover:bg-zinc-700 transition-colors cursor-help rounded-sm flex flex-col items-center justify-end pb-1">
                            <span className="text-[9px] font-bold text-zinc-500 group-hover:text-white truncate px-0.5">{i + 1}</span>
                            
                            {/* TOOLTIP */}
                            <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max max-w-[180px] hidden group-hover:block bg-black border border-white/20 text-white text-[10px] p-2 rounded shadow-2xl z-50 pointer-events-none">
                                <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-black border-t border-l border-white/20 rotate-45"></div>
                                <p className="font-bold text-blue-200">{getSceneName(scene)}</p>
                                <div className="h-px bg-white/10 my-1"></div>
                                <div className="flex justify-between gap-4 text-[9px] text-zinc-400">
                                    <span>{getSceneAct(scene)}</span>
                                    <span className={`${getSceneColor(getSceneType(scene)).split(' ')[0]} bg-clip-text text-transparent font-black uppercase`}>
                                      {getSceneType(scene)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
                <div></div> 
            </div>

            {roles.map((role) => (
                <div key={role.id} className="group grid grid-cols-[140px_1fr_30px] md:grid-cols-[280px_1fr_30px] gap-4 p-2 bg-zinc-900/30 border border-white/5 rounded-xl hover:bg-zinc-900 transition-all items-start">
                    
                    {/* LEFT: ROLE CARD */}
                    <div 
                        onDragOver={handleDragOver}
                        onDrop={(e) => onDropActor(e, role.id)}
                        onClick={() => onSelectRole(role)}
                        className={`min-h-[4rem] rounded-lg border-2 border-dashed transition-all cursor-pointer flex flex-col p-2 gap-2 relative
                             ${role.actors?.length > 0 ? 'bg-zinc-800 border-white/10' : 'bg-black/20 border-white/5 hover:border-blue-500/50 hover:bg-blue-500/5'}
                             ${role.selectedActorIds?.length > 0 ? 'ring-1 ring-purple-500/50' : ''}
                        `}
                    >
                         <div className="flex justify-between items-center mb-1">
                            <span className="text-xs font-black uppercase text-zinc-400 truncate max-w-[120px] md:max-w-[180px]" title={role.name}>{role.name}</span>
                            <span className="text-[9px] font-bold px-1.5 rounded bg-black/40 text-zinc-500 shrink-0 hidden md:block">{role.sceneIds?.length || 0} Scn</span>
                         </div>

                        <div className="flex flex-wrap gap-1.5">
                            {!role.actors?.length && <p className="text-[10px] text-zinc-600 italic py-1 w-full text-center hidden md:block">Drag actors here...</p>}
                            
                            {role.actors?.map((actor: any) => {
                                const isSelected = role.selectedActorIds?.includes(actor.id);
                                return (
                                    <div 
                                        key={actor.id} 
                                        onClick={(e) => { e.stopPropagation(); onConfirmRole(role.id, actor.id); }} 
                                        className={`flex items-center gap-1.5 rounded-full pr-2 pl-1 py-0.5 shadow-sm max-w-full cursor-pointer transition-all border
                                            ${isSelected 
                                                ? 'bg-purple-600 border-purple-400 text-white shadow-lg shadow-purple-900/50' 
                                                : 'bg-zinc-900 border-white/10 text-zinc-400 hover:border-white/30 hover:text-white'
                                            }
                                        `}
                                        title={isSelected ? "Cast (Click to Uncast)" : "Candidate (Click to Cast)"}
                                    >
                                        <img src={actor.headshot || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-4 h-4 rounded-full object-cover shrink-0" alt="" />
                                        {/* üö® FIX: actor.name instead of actor.Performer */}
                                        <span className="text-[9px] font-bold truncate max-w-[60px] md:max-w-full">{actor.name}</span>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); onRemoveActor(role.id, actor.id); }}
                                            className={`hover:text-red-400 shrink-0 ${isSelected ? 'text-purple-200' : 'text-zinc-500'}`}
                                        >
                                            <X size={10} />
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* MIDDLE: BARCODE GRID */}
                    <div className="flex gap-0.5 h-auto min-h-[4rem] relative bg-zinc-950/30 p-1 rounded-lg border border-white/5">
                        {scenes.map((scene) => {
                            const isActive = role.sceneIds?.includes(scene.id);
                            const type = getSceneType(scene);
                            return (
                                <button
                                    key={scene.id}
                                    onClick={() => onToggleScene(role.id, scene.id)}
                                    className={`flex-1 min-w-0 transition-all rounded-sm relative overflow-hidden border
                                        ${isActive ? `opacity-100 ${getSceneColor(type)}` : 'bg-zinc-800/30 border-white/5 hover:bg-zinc-700/50 hover:border-white/20'}
                                    `}
                                >
                                    {isActive && <div className="absolute inset-0 bg-gradient-to-b from-white/30 to-transparent"></div>}
                                </button>
                            );
                        })}
                    </div>
                    
                    <div className="flex flex-col gap-1 items-center opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity pt-1">
                         <button onClick={() => onDuplicateRole(role.id)} className="p-1.5 text-zinc-500 hover:text-blue-400 hover:bg-blue-500/10 rounded"><Copy size={14} /></button>
                        <button onClick={() => onRemoveRole(role.id)} className="p-1.5 text-zinc-500 hover:text-red-500 hover:bg-red-500/10 rounded"><Trash2 size={14} /></button>
                    </div>
                </div>
            ))}
        </div>
      </div>
    </main>
  );
}
</file>

<file path="app/components/casting/ChemistryWorkspace.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import { useState } from "react";
import { Users, Filter, X, Check, Ruler, Scale, AlertOctagon } from "lucide-react";

// --- üõ†Ô∏è UTILITIES ---
const safeVal = (val: any, fallback: string | number = "-") => {
  if (val === undefined || val === null) return fallback;
  if (Array.isArray(val)) return val[0]?.value ?? val[0] ?? fallback;
  if (typeof val === "object") return val.value ?? val.id ?? fallback;
  return val;
};
// üõ°Ô∏è REFACTORED HELPERS
const getSceneName = (scene: any) => {
  const val = scene.name || scene["Scene Name"];
  return typeof val === 'object' ? val.value : (val || "Untitled Scene");
};

const getSceneType = (scene: any) => {
  const val = scene.type || scene["Scene Type"];
  // If Baserow returns a Select object, grab the .value
  return typeof val === 'object' ? val.value : (val || "Scene");
};

const getSceneAct = (scene: any) => {
  const val = scene.act || scene.Act;
  return typeof val === 'object' ? val.value : (val || "");
};
// --- üìä METRICS CONFIGURATION ---
// üö® REFACTORED: Now uses lowercase clean keys from your baserow.ts getAuditionees()
const METRICS = [
  { 
    label: "Vocal", 
    getValue: (a: any) => a.vocalScore, // matched to F.VOCAL_SCORE
    format: (v: any) => (
      <span className={`px-2 py-1 rounded font-mono text-xs ${v >= 4 ? 'bg-emerald-500/20 text-emerald-400' : v >= 3 ? 'bg-blue-500/20 text-blue-400' : 'text-zinc-500'}`}>
        {Number(v || 0).toFixed(1)}
      </span>
    )
  },
  { 
    label: "Acting", 
    getValue: (a: any) => a.actingScore, // matched to F.ACTING_SCORE
    format: (v: any) => (
      <span className={`px-2 py-1 rounded font-mono text-xs ${v >= 4 ? 'bg-purple-500/20 text-purple-400' : v >= 3 ? 'bg-blue-500/20 text-blue-400' : 'text-zinc-500'}`}>
        {Number(v || 0).toFixed(1)}
      </span>
    )
  },
  { 
    label: "Height", 
    getValue: (a: any) => a.height || "-", 
    format: (v: any) => <div className="flex justify-center items-center gap-1 font-mono text-zinc-400 text-xs"><Ruler size={10} className="opacity-50" /> {v}</div> 
  },
  { 
    label: "Age", 
    getValue: (a: any) => a.age || "?", 
    format: (v: any) => <span className="text-zinc-400 text-xs">{v}</span> 
  }
];

// --- üß© SUB-COMPONENT: The Role Card ---
function RoleComparisonCard({ 
  role, 
  onDropActor, 
  onRemoveActor, 
  onConfirmRole 
}: { 
  role: any; 
  onDropActor: (e: React.DragEvent, id: string) => void;
  onRemoveActor: (roleId: string, actorId: number) => void;
  onConfirmRole: (roleId: string, actorId: number) => void;
}) {
  
  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  };

  return (
    <div 
      onDragOver={handleDragOver}
      onDrop={(e) => onDropActor(e, String(role.id))}
      className="group relative"
    >
      {/* ROLE HEADER */}
      <div className="flex items-center gap-3 mb-4 pl-2 border-l-2 border-purple-500/50">
         <h2 className="text-xl font-black uppercase text-white tracking-tighter italic">{role.name}</h2>
         <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-zinc-800 text-zinc-400 border border-white/5">{role.type || "Role"}</span>
         <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-zinc-800 text-zinc-500 border border-white/5">{role.actors?.length || 0} Candidates</span>
      </div>

      {/* TABLE CONTAINER */}
      <div className={`rounded-xl border border-white/5 bg-zinc-900/20 overflow-hidden transition-all ${(!role.actors || role.actors.length === 0) ? 'border-dashed border-zinc-800 h-32 flex items-center justify-center' : ''}`}>
        
        {(!role.actors || role.actors.length === 0) ? (
             <div className="text-zinc-600 flex items-center gap-2">
                <Users size={20} />
                <span className="text-xs font-bold uppercase tracking-wider">Drag candidates here</span>
             </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr>
                  <th className="p-4 w-24 md:w-32 bg-zinc-900/50 border-b border-r border-white/5 text-[10px] font-black uppercase text-zinc-500 tracking-wider text-right align-bottom sticky left-0 z-10 backdrop-blur-sm">
                    Candidate
                  </th>
                  
                  {role.actors.map((actor: any) => {
                    const isSelected = role.selectedActorIds?.includes(actor.id);
                    return (
                      <th key={actor.id} className={`p-4 border-b border-r border-white/5 min-w-[140px] w-[160px] relative group/col ${isSelected ? 'bg-purple-900/10' : ''}`}>
                         <div className={`relative aspect-[3/4] rounded-lg overflow-hidden border shadow-lg mb-2 transition-all ${isSelected ? 'border-purple-500 ring-2 ring-purple-500/50' : 'border-white/10'}`}>
                            {/* üö® FIX: Using actor.headshot */}
                            <img 
                                title={actor.name} 
                                src={actor.headshot || "https://placehold.co/400x600/111/444?text=No+Img"} 
                                className="w-full h-full object-cover" 
                                alt=""
                            />
                            
                            <button onClick={() => onRemoveActor(String(role.id), actor.id)} className="absolute top-1 right-1 p-1.5 bg-black/60 text-zinc-400 hover:text-red-400 rounded-full opacity-0 group-hover/col:opacity-100 transition-opacity z-20">
                                <X size={14} />
                            </button>
                            
                            <div className={`absolute inset-x-0 bottom-0 p-2 flex justify-center bg-gradient-to-t from-black/90 to-transparent transition-opacity ${isSelected ? 'opacity-100' : 'opacity-0 group-hover/col:opacity-100'}`}>
                                <button onClick={() => onConfirmRole(String(role.id), actor.id)} className={`rounded-full shadow-xl flex items-center justify-center gap-1 px-3 py-1.5 transition-all text-xs font-bold ${isSelected ? 'bg-purple-600 text-white' : 'bg-white text-black hover:bg-emerald-400'}`}>
                                    {isSelected ? <><Check size={12} /> CAST</> : "SELECT"}
                                </button>
                            </div>
                         </div>
                         
                         <div className="text-center px-1">
                            {/* üö® FIX: Using actor.name */}
                            <p className={`text-sm font-black leading-tight line-clamp-2 ${isSelected ? 'text-purple-300' : 'text-white'}`}>
                                {actor.name || "Unknown"} 
                            </p>
                         </div>
                      </th>
                    )})}
                  <th className="p-4 border-b border-white/5 min-w-[50px] bg-zinc-900/30 border-dashed border-l border-white/10"></th>
                </tr>
              </thead>
              <tbody className="text-xs font-bold text-zinc-300">
                  {METRICS.map((metric, i) => (
                      <tr key={i} className="hover:bg-zinc-800/30 transition-colors">
                          <td className="p-3 border-b border-r border-white/5 text-right text-zinc-500 uppercase text-[10px] sticky left-0 bg-zinc-900/90 backdrop-blur-sm z-10">
                            {metric.label}
                          </td>
                          {role.actors.map((actor: any) => (
                              <td key={actor.id} className="p-3 border-b border-r border-white/5 text-center">
                                  {metric.format(metric.getValue(actor))}
                              </td>
                          ))}
                          <td className="border-b border-white/5 bg-zinc-900/30 border-l border-dashed border-white/10"></td>
                      </tr>
                  ))}
                  
                  <tr className="bg-red-900/5">
                      <td className="p-3 border-r border-white/5 text-right text-red-500/70 font-black uppercase text-[10px] align-top pt-4 sticky left-0 bg-zinc-900/90 backdrop-blur-sm z-10">
                        Conflicts
                      </td>
                      {role.actors.map((actor: any) => {
                          const conflictStr = actor.conflicts || "";
                          const conflicts = typeof conflictStr === 'string' 
                            ? conflictStr.split(',').filter((c: string) => c && !c.includes("No known")) 
                            : [];

                          return (
                              <td key={actor.id} className="p-3 border-r border-white/5 text-center align-top">
                                  {conflicts.length > 0 ? (
                                      <div className="flex flex-col gap-1 items-center">
                                          {conflicts.slice(0, 3).map((c: string, i: number) => (
                                              <div key={i} className="flex items-center gap-1 text-[9px] bg-red-500/10 text-red-400 border border-red-500/20 px-1.5 py-0.5 rounded w-fit max-w-[140px] truncate">
                                                  <AlertOctagon size={8} className="shrink-0" /> {c}
                                              </div>
                                          ))}
                                          {conflicts.length > 3 && <span className="text-[9px] text-red-500/50">+{conflicts.length - 3} more</span>}
                                      </div>
                                  ) : <span className="text-[10px] text-emerald-500/50 flex items-center justify-center gap-1"><Check size={10}/> Clear</span>}
                              </td>
                          )
                      })}
                      <td className="bg-zinc-900/30 border-l border-dashed border-white/10"></td>
                  </tr>
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}

// --- üöÄ MAIN COMPONENT ---
// (Remains largely the same, but ensure props match CastingClient)
export default function ChemistryWorkspace({ roles = [], onDropActor, onRemoveActor, onConfirmRole }: Props) {
  const [activeFilter, setActiveFilter] = useState("Lead");

  const visibleRoles = roles.filter(r => 
    activeFilter === "All" || (r.type && String(r.type).includes(activeFilter))
  );

  return (
    <div className="h-full flex flex-col bg-zinc-950 relative overflow-hidden">
      <header className="p-4 border-b border-white/5 bg-zinc-900/50 flex flex-col md:flex-row justify-between items-center gap-4 shrink-0 backdrop-blur-md z-30">
         <div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
            <h1 className="text-xl font-black italic uppercase flex items-center gap-2 text-white">
                <Scale className="text-purple-500" /> Head-to-Head
            </h1>
            
            <div className="flex bg-zinc-900 p-1 rounded-lg border border-white/5 overflow-x-auto max-w-[200px] md:max-w-none scrollbar-hide">
                {["Lead", "Supporting", "Featured", "Ensemble", "All"].map(filter => (
                    <button
                        key={filter}
                        onClick={() => setActiveFilter(filter)}
                        className={`px-3 py-1 text-[10px] font-bold uppercase rounded transition-all whitespace-nowrap ${activeFilter === filter ? 'bg-purple-600 text-white shadow-lg' : 'text-zinc-500 hover:text-zinc-300'}`}
                    >
                        {filter}
                    </button>
                ))}
            </div>
         </div>
      </header>

      <div className="flex-1 overflow-x-auto overflow-y-auto p-4 md:p-8 custom-scrollbar bg-zinc-950 space-y-12 pb-24 md:pb-8">
            {visibleRoles.length === 0 && (
                <div className="w-full h-full flex flex-col items-center justify-center text-zinc-600 opacity-50 min-h-[300px]">
                    <Filter size={48} className="mb-4" />
                    <p>No roles match this filter.</p>
                </div>
            )}

            {visibleRoles.map(role => (
               <RoleComparisonCard 
                  key={role.id}
                  role={role}
                  onDropActor={onDropActor}
                  onRemoveActor={onRemoveActor}
                  onConfirmRole={onConfirmRole}
               />
            ))}
      </div>
    </div>
  );
}
</file>

<file path="app/components/charts/SalesChart.tsx">
"use client";

import React, { useMemo } from 'react';
import {
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell
} from 'recharts';
import { Ticket, Users, TrendingUp, AlertCircle } from 'lucide-react';

export default function SalesChart({ data }) {
  // Memoize calculations to prevent unnecessary re-renders
  const stats = useMemo(() => {
    if (!data?.length) return null;
    const totalSold = data.reduce((acc, curr) => acc + curr.sold, 0);
    const avgFill = Math.round(data.reduce((acc, curr) => acc + curr.fillRate, 0) / data.length);
    const maxCapacity = data.reduce((acc, curr) => acc + curr.capacity, 0);
    return { totalSold, avgFill, maxCapacity };
  }, [data]);

  if (!data || data.length === 0) {
    return (
      <div className="h-64 flex flex-col items-center justify-center border-2 border-dashed border-zinc-800 rounded-3xl bg-zinc-900/20">
        <AlertCircle className="text-zinc-700 mb-2" size={32} />
        <p className="text-zinc-500 font-medium">No sales data available for this production.</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* üìä TOP-LEVEL SUMMARY METRICS */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <StatCard 
          label="Total Tickets Sold" 
          value={stats?.totalSold.toLocaleString()} 
          sub={`Out of ${stats?.maxCapacity.toLocaleString()} available`}
          icon={<Ticket className="text-emerald-500" size={20} />} 
        />
        <StatCard 
          label="Avg. House Fill" 
          value={`${stats?.avgFill}%`} 
          sub="Across all performances"
          icon={<Users className="text-blue-500" size={20} />} 
        />
        <StatCard 
          label="Performance Count" 
          value={data.length} 
          sub="Scheduled shows"
          icon={<TrendingUp className="text-purple-500" size={20} />} 
        />
      </div>

      {/* üéüÔ∏è MAIN CAPACITY CHART */}
      <div className="bg-zinc-900/40 border border-white/5 p-6 rounded-3xl backdrop-blur-sm">
        <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
          <div>
            <h2 className="text-xl font-black text-white tracking-tight italic">PERFORMANCE LOAD</h2>
            <p className="text-xs text-zinc-500 uppercase tracking-widest font-bold">Inventory vs. Actuals</p>
          </div>
          <div className="flex gap-4 text-[10px] font-bold uppercase tracking-tighter text-zinc-400">
             <div className="flex items-center gap-1.5"><span className="w-2 h-2 rounded-full bg-emerald-500"></span> Sold</div>
             <div className="flex items-center gap-1.5"><span className="w-2 h-2 rounded-full bg-zinc-800"></span> Empty</div>
          </div>
        </div>

        <div className="h-[350px] w-full">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={data} margin={{ top: 0, right: 0, left: -25, bottom: 0 }}>
              <CartesianGrid strokeDasharray="4 4" stroke="#18181b" vertical={false} />
              <XAxis 
                dataKey="name" 
                stroke="#3f3f46" 
                fontSize={9}
                fontWeight={700}
                tickLine={false}
                axisLine={false}
                tickFormatter={(val) => val.split('@')[0]} 
              />
              <YAxis 
                stroke="#3f3f46" 
                fontSize={9} 
                fontWeight={700}
                tickLine={false}
                axisLine={false} 
              />
              <Tooltip 
                cursor={{ fill: '#27272a', opacity: 0.4 }}
                content={<CustomTooltip />}
              />
              <Bar dataKey="sold" stackId="a" fill="#10b981" radius={[0, 0, 0, 0]} />
              <Bar dataKey="empty" stackId="a" fill="#27272a" radius={[6, 6, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </div>
    </div>
  );
}

// Sub-components for a cleaner main export
function StatCard({ label, value, sub, icon }) {
  return (
    <div className="p-5 bg-zinc-900/40 border border-white/5 rounded-2xl relative overflow-hidden group">
      <div className="absolute right-[-10px] top-[-10px] opacity-5 group-hover:scale-110 transition-transform">
        {React.cloneElement(icon, { size: 80 })}
      </div>
      <div className="flex items-center gap-3 mb-2">
        <div className="p-2 bg-zinc-950 rounded-lg border border-white/5">{icon}</div>
        <p className="text-[10px] font-black text-zinc-500 uppercase tracking-widest">{label}</p>
      </div>
      <p className="text-3xl font-black text-white tracking-tighter">{value}</p>
      <p className="text-[10px] text-zinc-600 font-bold mt-1">{sub}</p>
    </div>
  );
}

function CustomTooltip({ active, payload, label }) {
  if (active && payload && payload.length) {
    const sold = payload[0].value;
    const empty = payload[1].value;
    const total = sold + empty;
    const rate = Math.round((sold / total) * 100);

    return (
      <div className="bg-zinc-950 border border-zinc-800 p-4 rounded-xl shadow-2xl">
        <p className="text-[10px] font-black text-emerald-500 uppercase mb-2 tracking-widest">{label}</p>
        <div className="space-y-1.5">
          <div className="flex justify-between gap-8">
            <span className="text-xs text-zinc-500 font-bold">Sold:</span>
            <span className="text-xs text-white font-black">{sold}</span>
          </div>
          <div className="flex justify-between gap-8">
            <span className="text-xs text-zinc-500 font-bold">Remaining:</span>
            <span className="text-xs text-white font-black">{empty}</span>
          </div>
          <div className="pt-2 mt-2 border-t border-zinc-800 flex justify-between">
            <span className="text-xs text-blue-400 font-bold tracking-tighter uppercase">House Fill:</span>
            <span className="text-xs text-blue-400 font-black">{rate}%</span>
          </div>
        </div>
      </div>
    );
  }
  return null;
}
</file>

<file path="app/components/committees/CommitteeClient.tsx">
/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import React, { useState, useMemo } from 'react';
import { 
  Printer, Crown, Wand2, RotateCcw, X, 
  Trash2, Sliders, Info, CheckCircle2
} from 'lucide-react';

// --- CONFIG ---
const COMMITTEES = {
    'Pre-Show': ["Publicity", "Sets", "Set Dressing", "Raffles", "Green Room", "Costumes", "Props", "Makeup", "Hair", "Tech"],
    'Show Week': ["Raffles", "Green Room", "Costumes", "Props", "Makeup", "Hair", "Tech", "Ninjas/Set Movers", "Box Office", "Concessions", "Security"]
};

const DEFAULT_RULES: Record<string, { type: 'fixed' | 'ratio', val: number, min?: number, reason: string }> = {
    "Green Room": { type: 'ratio', val: 8, min: 2, reason: "Safety: 1 Adult per 8 Students" }, 
    "Costumes": { type: 'ratio', val: 6, min: 3, reason: "Labor: 1 per 6 Actors" },   
    "Makeup": { type: 'ratio', val: 7, min: 2, reason: "Speed: 1 per 7 Actors" },
    "Tech": { type: 'fixed', val: 5, reason: "Booth + Deck Crew" },              
    "Sets": { type: 'fixed', val: 8, reason: "Heavy Lifting Team" },              
    "Security": { type: 'fixed', val: 3, reason: "Door & Perimeter" },
    "Box Office": { type: 'fixed', val: 3, reason: "Ticket Window & Will Call" },
    "Concessions": { type: 'fixed', val: 4, reason: "Prep & Sales" },
    "Publicity": { type: 'fixed', val: 3, reason: "Social Media & Posters" },
    "default": { type: 'fixed', val: 3, reason: "Standard Committee Size" }
};

export default function CommitteeDashboard({ 
    volunteers = [], // Default to empty array
    students = [],   // Default to empty array
    activeId 
}: { 
    volunteers?: any[], 
    students?: any[], 
    activeId: number 
}) {
  
  const [groupBy, setGroupBy] = useState<'Pre-Show' | 'Show Week'>('Pre-Show');
  const [rawData] = useState<any[]>(volunteers);
  
  // üö® FIX: Smart Initial Assignments
  // If we are in Pre-Show mode, we default to Pre-Show 1st choice, etc.
  // Since assignments are "session based" in this view, we track them separately per mode effectively.
  const [assignments, setAssignments] = useState<Record<string, string>>({});
  const [leadership, setLeadership] = useState<Record<string, { chair: number | null, coChair: number | null }>>({});
  const [selectedCommittee, setSelectedCommittee] = useState<string | null>(null);
  const [rules, setRules] = useState(DEFAULT_RULES);
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);

  // --- HELPER: Get Preferences based on current View ---
  const getPrefs = (p: any) => {
      if (groupBy === 'Pre-Show') {
          return { first: p.preShow1, second: p.preShow2, third: p.preShow3 };
      } else {
          return { first: p.showWeek1, second: p.showWeek2, third: p.showWeek3 };
      }
  };

  // --- HELPER: CALCULATE TARGETS ---
  const getCommitteeTarget = (committeeName: string) => {
      const castSize = students.length || 40; 
      const rule = rules[committeeName] || rules["default"];
      if (rule.type === 'fixed') return rule.val;
      let calculated = Math.ceil(castSize / rule.val);
      if (rule.min && calculated < rule.min) calculated = rule.min;
      return calculated;
  };

  const updateRuleValue = (key: string, newVal: number) => {
      setRules(prev => ({ ...prev, [key]: { ...prev[key], val: newVal } }));
  };

  // --- ACTIONS ---
  const handleClearBoard = () => {
      if(!confirm(`Are you sure you want to clear assignments for ${groupBy}?`)) return;
      // In a real app, you might want to separate "Pre-Show Assignments" from "Show Week Assignments"
      // For now, we just clear the current in-memory state
      setAssignments({});
  };

  const handleAutoBalance = () => {
      if(!confirm(`Auto-Balance ${groupBy}?`)) return;
      
      const newAssignments = { ...assignments };
      // @ts-ignore
      const currentCommittees = COMMITTEES[groupBy];
      let movedCount = 0;

      const getCount = (comm: string) => rawData.filter(p => newAssignments[p.id] === comm).length;

      currentCommittees.forEach((targetComm: string) => {
          const targetLimit = getCommitteeTarget(targetComm); 
          if (getCount(targetComm) < targetLimit) {
               rawData.forEach(p => {
                   if (getCount(targetComm) >= targetLimit) return; 
                   
                   const prefs = getPrefs(p);
                   const currentComm = newAssignments[p.id];
                   
                   // Logic: If unassigned OR assigned to something over-full
                   // AND they want this committee
                   if (!currentComm || (getCount(currentComm) > getCommitteeTarget(currentComm))) {
                       if (prefs.first === targetComm || prefs.second === targetComm) {
                           newAssignments[p.id] = targetComm;
                           movedCount++;
                       }
                   }
               });
          }
      });
      setAssignments(newAssignments);
  };

  const handleSetLeader = (committee: string, role: 'chair' | 'coChair', personId: number | null) => {
      const key = `${groupBy}:${committee}`;
      setLeadership(prev => ({
          ...prev, [key]: { ...(prev[key] || { chair: null, coChair: null }), [role]: personId }
      }));
  };

  // Group Logic
  const groupedData = useMemo(() => {
      const groups: Record<string, any[]> = {};
      // @ts-ignore
      COMMITTEES[groupBy].forEach(c => groups[c] = []);
      groups["Unassigned"] = [];

      rawData.forEach(p => {
          // Check if manual assignment exists
          let assignedVal = assignments[p.id];
          
          // If NOT manually assigned, Default to their 1st Choice for this phase
          if (!assignedVal) {
              const prefs = getPrefs(p);
              // Only auto-assign if it's a valid committee for this phase
              // @ts-ignore
              if (COMMITTEES[groupBy].includes(prefs.first)) {
                  assignedVal = prefs.first;
              }
          }

          if (assignedVal && groups[assignedVal]) groups[assignedVal].push(p);
          else groups["Unassigned"].push(p);
      });
      return groups;
  }, [rawData, assignments, groupBy]);

  const currentTeam = selectedCommittee ? groupedData[selectedCommittee] : [];
  const leadershipKey = `${groupBy}:${selectedCommittee}`;
  const currentLeaders = leadership[leadershipKey] || { chair: null, coChair: null };

  return (
    <div className="min-h-screen bg-zinc-950 text-white font-sans p-4 md:p-6 flex flex-col">
        {/* HEADER */}
        <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 mb-6 print:hidden">
            <div>
                <h1 className="text-2xl font-black uppercase italic tracking-tighter text-white">Committee Manager</h1>
                <p className="text-zinc-500 text-xs font-medium">
                    {rawData.length} Volunteers ‚Ä¢ Cast Size: <span className="text-blue-400 font-bold">{students.length}</span>
                </p>
            </div>
            <div className="flex flex-wrap gap-2 w-full xl:w-auto">
                <div className="bg-zinc-900 border border-white/10 rounded-lg p-1 flex shadow-inner">
                    <button onClick={() => setGroupBy('Pre-Show')} className={`px-4 py-2 rounded text-xs font-bold uppercase transition-all ${groupBy === 'Pre-Show' ? 'bg-blue-600 text-white shadow-lg' : 'text-zinc-500 hover:text-white'}`}>Pre-Show</button>
                    <button onClick={() => setGroupBy('Show Week')} className={`px-4 py-2 rounded text-xs font-bold uppercase transition-all ${groupBy === 'Show Week' ? 'bg-blue-600 text-white shadow-lg' : 'text-zinc-500 hover:text-white'}`}>Show Week</button>
                </div>
                <button onClick={() => setIsSettingsOpen(true)} className="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 border border-white/5 px-4 py-2 rounded-lg text-xs font-bold uppercase flex items-center gap-2 transition-all"><Sliders size={14}/> Rules</button>
                <button onClick={handleAutoBalance} className="bg-emerald-600/10 hover:bg-emerald-600/20 text-emerald-500 border border-emerald-600/50 px-4 py-2 rounded-lg text-xs font-black uppercase flex items-center gap-2 transition-all"><Wand2 size={14}/> Balance</button>
                <button onClick={handleClearBoard} className="bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/50 px-4 py-2 rounded-lg text-xs font-black uppercase flex items-center gap-2 transition-all"><Trash2 size={14}/> Clear</button>
                <button onClick={() => setAssignments({})} className="bg-zinc-800 hover:bg-zinc-700 text-zinc-400 px-3 py-2 rounded-lg transition-all"><RotateCcw size={14}/></button>
                <button onClick={() => window.print()} className="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-xs font-black uppercase flex items-center gap-2 transition-all shadow-xl"><Printer size={14}/> Print</button>
            </div>
        </div>

        {/* BOARD GRID */}
        <div className="columns-1 md:columns-2 xl:columns-3 gap-6 space-y-6 print:block print:columns-2">
            {Object.keys(groupedData).map(committee => {
                const team = groupedData[committee];
                const target = getCommitteeTarget(committee);
                const isUnderstaffed = team.length < target;
                const statusColor = isUnderstaffed ? 'text-amber-500' : 'text-emerald-500';
                const lKey = `${groupBy}:${committee}`;
                const leaders = leadership[lKey] || { chair: null, coChair: null };
                const chairName = rawData.find(p => p.id === leaders.chair)?.name;

                if (team.length === 0 && committee !== "Unassigned") return null;

                return (
                    <div key={committee} className={`break-inside-avoid mb-6 rounded-2xl overflow-hidden border shadow-2xl border-white/10 bg-zinc-900/40 print:border-black print:bg-white print:mb-8`}>
                        <div onClick={() => setSelectedCommittee(committee)} className="p-4 border-b border-white/5 flex justify-between items-center cursor-pointer hover:bg-white/5 transition-colors">
                            <div>
                                <h3 className={`font-black uppercase text-sm tracking-widest ${statusColor} print:text-black`}>{committee}</h3>
                                {chairName && <p className="text-[9px] text-blue-400 font-bold mt-0.5 flex items-center gap-1"><Crown size={10}/> {chairName}</p>}
                            </div>
                            <span className={`text-[10px] font-bold px-2 py-1 rounded-md border border-white/10 bg-zinc-950 text-zinc-400`}>{team.length} / {target}</span>
                        </div>
                        <div className="p-3 space-y-1">
                            {team.slice(0, 3).map((p: any) => {
                                const prefs = getPrefs(p);
                                return (
                                    <div key={p.id} className="text-xs text-zinc-400 flex justify-between">
                                        <span>{p.name}</span>
                                        {prefs.first === committee && <CheckCircle2 size={10} className="text-emerald-500"/>}
                                    </div>
                                )
                            })}
                            {team.length > 3 && <div className="text-[10px] text-zinc-600 italic pt-1">+{team.length - 3} more...</div>}
                        </div>
                    </div>
                );
            })}
        </div>

        {/* --- DRAWER (Simplified for brevity) --- */}
        {selectedCommittee && (
            <div className="fixed inset-0 z-50 flex justify-end">
                <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setSelectedCommittee(null)} />
                <aside className="relative w-full max-w-3xl bg-zinc-900 border-l border-white/10 shadow-2xl flex flex-col animate-in slide-in-from-right duration-300">
                    <div className="p-6 border-b border-white/10 flex justify-between items-start bg-zinc-950">
                        <div>
                            <h2 className="text-3xl font-black uppercase italic tracking-tighter text-white">{selectedCommittee}</h2>
                            <p className="text-zinc-500 text-xs font-bold uppercase tracking-widest mt-1">{groupBy} ‚Ä¢ {currentTeam.length} Members</p>
                        </div>
                        <button onClick={() => setSelectedCommittee(null)} className="p-2 hover:bg-white/10 rounded-full"><X/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-8">
                         {/* Roster List */}
                         <div className="bg-zinc-950 border border-white/5 rounded-xl divide-y divide-white/5">
                            {currentTeam.map((p: any) => {
                                const prefs = getPrefs(p);
                                return (
                                    <div key={p.id} className="p-3 hover:bg-white/5 transition-colors group flex justify-between items-center">
                                        <div>
                                            <div className="text-sm font-bold text-zinc-200">{p.name}</div>
                                            <div className="text-[10px] text-zinc-500">{p.studentName && `Parent of ${p.studentName}`}</div>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <div className="flex gap-2">
                                                <PreferenceBadge rank="1" value={prefs.first} current={selectedCommittee}/>
                                                <PreferenceBadge rank="2" value={prefs.second} current={selectedCommittee}/>
                                            </div>
                                            <select 
                                                className="bg-zinc-900 border border-zinc-800 rounded px-2 py-1 text-[10px] text-zinc-400 outline-none focus:text-white"
                                                value={assignments[p.id] || ((prefs.first === selectedCommittee) ? selectedCommittee : "Unassigned")}
                                                onChange={(e) => { const n = {...assignments}; n[p.id] = e.target.value; setAssignments(n); }}
                                            >
                                                {/* @ts-ignore */}
                                                {COMMITTEES[groupBy].map((c: string) => <option key={c} value={c}>{c}</option>)}
                                                <option value="Unassigned">Unassigned</option>
                                            </select>
                                        </div>
                                    </div>
                                )
                            })}
                         </div>
                    </div>
                </aside>
            </div>
        )}
    </div>
  );
}

function PreferenceBadge({ rank, value, current }: any) {
    const isMatch = value === current;
    return (
        <div className={`flex items-center gap-1.5 px-2 py-1 rounded border text-[9px] font-bold uppercase ${isMatch ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30' : 'bg-zinc-900 border-zinc-800 text-zinc-600'}`}>
            <span className="opacity-50">{rank}:</span>
            <span>{value || "-"}</span>
        </div>
    )
}
</file>

<file path="app/components/conflicts/ConflictAnalysisDashboard.tsx">
"use client";

import React, { useMemo } from 'react';
import { Calendar, AlertTriangle, Clock, Users, CheckCircle2 } from 'lucide-react';

// Define the shape of the clean data coming from baserow.ts
interface Props {
  conflicts: any[]; // The clean array from getProductionConflicts
  events: any[];    // The clean array of events
  castSize: number; // Total number of actors
}

export default function ConflictAnalysisDashboard({ conflicts, events, castSize }: Props) {

  // --- üß† THE BRAIN: EVENT-BASED ANALYTICS ---
  const analytics = useMemo(() => {
    
    // 1. Sort Events Chronologically
    const sortedEvents = [...events].sort((a: any, b: any) => 
        new Date(a.date).getTime() - new Date(b.date).getTime()
    );

    // 2. Map Conflicts to specific Event IDs
    const eventConflictMap = new Map<number, Set<number>>();

    conflicts.forEach((c: any) => {
        // If the conflict is linked to a specific event ID
        if (c.eventId && c.personId) {
            if (!eventConflictMap.has(c.eventId)) eventConflictMap.set(c.eventId, new Set());
            eventConflictMap.get(c.eventId)?.add(c.personId);
        }
        
        // OPTIONAL: If you have logic to map date-based conflicts to events, add it here
        // e.g. if c.date === event.date
    });

    // 3. Build Event Objects
    const processedEvents = sortedEvents.map((evt: any) => {
        const dateObj = new Date(evt.date);
        const absentees = eventConflictMap.get(evt.id) || new Set();
        const absentCount = absentees.size;
        
        // üßÆ Calculate Availability
        const availability = castSize > 0 
            ? Math.round(((castSize - absentCount) / castSize) * 100)
            : 100;
        
        const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
        const dateStr = dateObj.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
        
        // Format Times (assuming ISO strings or HH:MM)
        const formatTime = (t: string) => {
            if(!t) return "";
            // Handle "18:00:00" format or ISO
            const d = t.includes('T') ? new Date(t) : new Date(`1970-01-01T${t}`);
            return d.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
        };

        return {
            id: evt.id,
            label: dayName,
            date: dateStr,
            fullDate: dateObj,
            time: `${formatTime(evt.startTime)} - ${formatTime(evt.endTime)}`,
            type: evt.type || "Rehearsal",
            absentCount,
            availability,
            weekNum: getWeekNumber(dateObj) 
        };
    });

    // 4. Group by Week
    const groupedWeeks: any[] = [];
    let currentWeek: any[] = [];
    let lastWeekNum = -1;

    processedEvents.forEach((evt: any) => {
        if (evt.weekNum !== lastWeekNum && currentWeek.length > 0) {
            groupedWeeks.push(currentWeek);
            currentWeek = [];
        }
        currentWeek.push(evt);
        lastWeekNum = evt.weekNum;
    });
    if (currentWeek.length > 0) groupedWeeks.push(currentWeek);

    return { weeks: groupedWeeks };
  }, [conflicts, events, castSize]);


  return (
    <div className="grid grid-cols-1 lg:grid-cols-1 gap-6 mb-6">
        
        {/* üìÖ REHEARSAL FLOW STRIP */}
        <div className="bg-zinc-900 border border-white/10 rounded-xl flex flex-col overflow-hidden shadow-xl max-h-[400px]">
            <div className="p-4 border-b border-white/10 bg-zinc-900 z-10 flex justify-between items-center shadow-sm">
                <h3 className="text-sm font-black uppercase tracking-widest text-zinc-400 flex items-center gap-2">
                    <Calendar size={16} className="text-blue-500"/> Rehearsal Attendance Forecast
                </h3>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-zinc-950/50">
                {analytics.weeks.length === 0 && <div className="text-zinc-500 italic text-sm p-4">No events found linked to this production.</div>}

                {analytics.weeks.map((weekEvents: any[], i: number) => {
                    const firstEvt = weekEvents[0];
                    const isHeavyWeek = weekEvents.length > 4; 

                    return (
                        <div key={i} className="animate-in fade-in slide-in-from-bottom-2 duration-500" style={{animationDelay: `${i * 50}ms`}}>
                            {/* Week Header */}
                            <div className="flex items-center gap-2 mb-2 ml-1">
                                <span className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">
                                    Week of {firstEvt.fullDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                </span>
                                {isHeavyWeek && (
                                    <span className="text-[9px] bg-purple-500/10 text-purple-400 border border-purple-500/20 px-1.5 rounded uppercase font-bold tracking-wider">
                                        Heavy Week
                                    </span>
                                )}
                            </div>

                            {/* The Grid of Cards for this Week */}
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
                                {weekEvents.map((evt: any) => {
                                    // Color Coding Logic
                                    let color = "bg-emerald-900/10 border-emerald-500/20 hover:border-emerald-500/50";
                                    let textC = "text-emerald-500";
                                    let barC = "bg-emerald-500";
                                    
                                    if (evt.availability < 90) { 
                                        color = "bg-amber-900/10 border-amber-500/20 hover:border-amber-500/50"; 
                                        textC = "text-amber-500"; 
                                        barC = "bg-amber-500";
                                    }
                                    if (evt.availability < 75) { 
                                        color = "bg-red-900/10 border-red-500/20 hover:border-red-500/50"; 
                                        textC = "text-red-500"; 
                                        barC = "bg-red-500";
                                    }

                                    return (
                                        <div key={evt.id} className={`border rounded-lg p-2.5 relative overflow-hidden group transition-all ${color}`}>
                                            
                                            {/* Date/Time */}
                                            <div className="flex justify-between items-start mb-2 relative z-10">
                                                <div>
                                                    <div className="text-xs font-black text-zinc-300 uppercase">{evt.label}</div>
                                                    <div className="text-[10px] text-zinc-500 font-bold">{evt.date}</div>
                                                </div>
                                                <div className={`text-[9px] font-bold px-1.5 py-0.5 rounded bg-black/40 ${textC}`}>
                                                    {evt.availability}%
                                                </div>
                                            </div>

                                            {/* Details */}
                                            <div className="relative z-10">
                                                <div className="text-[9px] text-zinc-500 flex items-center gap-1 mb-1.5">
                                                    <Clock size={10}/> {evt.time.split(' ')[0]}
                                                </div>
                                                
                                                {evt.absentCount > 0 ? (
                                                    <div className="text-[10px] font-bold text-zinc-400 flex items-center gap-1">
                                                        <Users size={10} className={textC}/> 
                                                        {evt.absentCount} Missing
                                                    </div>
                                                ) : (
                                                    <div className="text-[10px] font-bold text-zinc-600 flex items-center gap-1">
                                                        <CheckCircle2 size={10} className="text-emerald-600"/> Full Cast
                                                    </div>
                                                )}
                                            </div>

                                            {/* Subtle Bar at bottom */}
                                            <div className={`absolute bottom-0 left-0 h-0.5 w-full ${barC} opacity-50`}/>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    </div>
  );
}

// Helper to get ISO Week Number
function getWeekNumber(d: Date) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
    var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    var weekNo = Math.ceil(( ( (d.getTime() - yearStart.getTime()) / 86400000) + 1)/7);
    return weekNo;
}
</file>

<file path="app/components/dashboard/ProductionOverview.tsx">
"use client";

import React, { useMemo } from 'react';
import { User, Ruler, Sparkles, PieChart } from 'lucide-react';

export default function ProductionOverview({ demographics }: { demographics: any[] }) {
  
  // üß† STATS ENGINE
  const stats = useMemo(() => {
    if (!demographics.length) return null;

    const total = demographics.length;
    
    // 1. Average Age
    const validAges = demographics.filter(p => p.age > 0);
    const avgAge = validAges.length > 0 
      ? Math.round(validAges.reduce((acc, p) => acc + p.age, 0) / validAges.length) 
      : 0;

    // 2. Average Height (Inches to Ft'In")
    const validHeights = demographics.filter(p => p.height > 0);
    const avgHeightInches = validHeights.length > 0
        ? Math.round(validHeights.reduce((acc, p) => acc + p.height, 0) / validHeights.length)
        : 0;
    const feet = Math.floor(avgHeightInches / 12);
    const inches = avgHeightInches % 12;

    // 3. Experience (Show Count)
    const avgShows = Math.round(demographics.reduce((acc, p) => acc + p.showCount, 0) / total);

    // 4. Gender Breakdown
    const genderMap = new Map();
    demographics.forEach(p => {
        const g = p.gender?.value || "Unknown";
        genderMap.set(g, (genderMap.get(g) || 0) + 1);
    });
    
    // Convert to simplified chart data
    const chartData = Array.from(genderMap.entries()).map(([k, v]: any) => ({
        label: k,
        value: v,
        percent: Math.round((v / total) * 100)
    }));

    return { total, avgAge, feet, inches, avgShows, chartData };
  }, [demographics]);

  if (!stats) return <div className="text-zinc-500 italic">No cast data available.</div>;

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 animate-in fade-in duration-500">
        
        {/* CARD 1: AGE */}
        <div className="bg-zinc-900 border border-white/10 rounded-xl p-6 relative overflow-hidden group hover:border-blue-500/30 transition-colors">
            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <User size={64} />
            </div>
            <div className="relative z-10">
                <h3 className="text-3xl font-black text-white">{stats.avgAge}</h3>
                <p className="text-xs uppercase font-bold text-zinc-500 tracking-wider mt-1">Average Age</p>
                <div className="mt-4 text-xs text-zinc-400">
                    Youngest: <span className="text-white">{Math.min(...demographics.map(p => p.age || 99))}</span> ‚Ä¢ 
                    Oldest: <span className="text-white">{Math.max(...demographics.map(p => p.age || 0))}</span>
                </div>
            </div>
        </div>

        {/* CARD 2: HEIGHT */}
        <div className="bg-zinc-900 border border-white/10 rounded-xl p-6 relative overflow-hidden group hover:border-emerald-500/30 transition-colors">
            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <Ruler size={64} />
            </div>
            <div className="relative z-10">
                <h3 className="text-3xl font-black text-white">{stats.feet}&apos; {stats.inches}&quot;</h3>
                <p className="text-xs uppercase font-bold text-zinc-500 tracking-wider mt-1">Average Height</p>
                <div className="mt-4 h-1 w-full bg-zinc-800 rounded-full overflow-hidden">
                    <div className="h-full bg-emerald-500 w-[60%]" />
                </div>
            </div>
        </div>

        {/* CARD 3: EXPERIENCE */}
        <div className="bg-zinc-900 border border-white/10 rounded-xl p-6 relative overflow-hidden group hover:border-amber-500/30 transition-colors">
            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <Sparkles size={64} />
            </div>
            <div className="relative z-10">
                <h3 className="text-3xl font-black text-white">{stats.avgShows}</h3>
                <p className="text-xs uppercase font-bold text-zinc-500 tracking-wider mt-1">Avg. Past Shows</p>
                <div className="mt-4 text-xs text-zinc-400">
                    Total collective experience: <br/>
                    <span className="text-white font-bold">{demographics.reduce((acc, p) => acc + p.showCount, 0)} productions</span>
                </div>
            </div>
        </div>

        {/* CARD 4: BREAKDOWN */}
        <div className="bg-zinc-900 border border-white/10 rounded-xl p-6 relative overflow-hidden group hover:border-purple-500/30 transition-colors">
            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <PieChart size={64} />
            </div>
            <div className="relative z-10">
                <h3 className="text-3xl font-black text-white">{stats.total}</h3>
                <p className="text-xs uppercase font-bold text-zinc-500 tracking-wider mt-1">Cast Size</p>
                <div className="mt-4 flex gap-1 h-2 rounded-full overflow-hidden">
                    {stats.chartData.map((d, i) => (
                        <div 
                            key={d.label} 
                            style={{ width: `${d.percent}%` }} 
                            className={`h-full ${i % 2 === 0 ? 'bg-purple-500' : 'bg-blue-500'}`} 
                            title={`${d.label}: ${d.value}`}
                        />
                    ))}
                </div>
            </div>
        </div>

    </div>
  );
}
</file>

<file path="app/components/dashboard/ProductionTracker.tsx">
"use client";

import React, { useMemo } from 'react';
import { Check, Circle, Minus } from 'lucide-react';

export default function ProductionTracker({ scenes }: { scenes: any[] }) {

  // --- üìä ANALYTICS ENGINE (WEIGHTED) ---
  const stats = useMemo(() => {
    let totalPoints = 0;
    let earnedPoints = 0;
    
    scenes.forEach(scene => {
      // 1. MUSIC
      if (scene.load.music > 0) {
        totalPoints += scene.load.music; 
        if (scene.status.music === 'polished' || scene.status.music === 'done') earnedPoints += scene.load.music;
        else if (scene.status.music === 'draft') earnedPoints += (scene.load.music * 0.5);
      }

      // 2. DANCE
      if (scene.load.dance > 0) {
        totalPoints += scene.load.dance;
        if (scene.status.dance === 'polished' || scene.status.dance === 'done') earnedPoints += scene.load.dance;
        else if (scene.status.dance === 'draft') earnedPoints += (scene.load.dance * 0.5);
      }

      // 3. BLOCKING
      if (scene.load.block > 0) {
        totalPoints += scene.load.block;
        if (scene.status.block === 'polished' || scene.status.block === 'done') earnedPoints += scene.load.block;
        else if (scene.status.block === 'draft') earnedPoints += (scene.load.block * 0.5);
      }
    });

    const percent = totalPoints > 0 ? Math.round((earnedPoints / totalPoints) * 100) : 0;
    
    // Velocity Estimate (e.g., 4 points per week)
    const remaining = totalPoints - earnedPoints;
    const velocity = 3.8; 
    const weeksLeft = Math.ceil(remaining / velocity);

    return { percent, weeksLeft, earnedPoints, totalPoints, velocity };
  }, [scenes]);

  return (
    <div className="space-y-6">
      
      {/* üìà BURN-UP HEADER */}
      <div className="bg-zinc-900 border border-white/10 rounded-xl p-6 flex flex-col md:flex-row items-center justify-between gap-6">
        
        {/* Progress Circle */}
        <div className="flex items-center gap-6">
            <div className="relative w-20 h-20 flex items-center justify-center">
                <svg className="w-full h-full -rotate-90" viewBox="0 0 36 36">
                    <path className="text-zinc-800" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="4" />
                    <path className="text-blue-500 transition-all duration-1000 ease-out" strokeDasharray={`${stats.percent}, 100`} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="4" />
                </svg>
                <span className="absolute text-xl font-bold text-white">{stats.percent}%</span>
            </div>
            <div>
                <h3 className="text-lg font-bold text-white">Show Readiness</h3>
                <p className="text-sm text-zinc-400">
                    Velocity: <span className="text-white font-mono">{stats.velocity} pts/wk</span>
                </p>
                <p className="text-xs text-zinc-500 mt-1">Est. Completion: {stats.weeksLeft} weeks</p>
            </div>
        </div>

        {/* Stats Grid */}
        <div className="grid grid-cols-2 gap-8 text-center border-l border-white/10 pl-8">
            <div>
                <div className="text-2xl font-black text-white">{stats.earnedPoints} <span className="text-zinc-600 text-lg">/ {stats.totalPoints}</span></div>
                <div className="text-[10px] uppercase font-bold text-zinc-500 tracking-wider">Total Effort Points</div>
            </div>
            <div>
                <div className="text-2xl font-black text-emerald-400">Wk {8 + stats.weeksLeft}</div>
                <div className="text-[10px] uppercase font-bold text-zinc-500 tracking-wider">Target Finish</div>
            </div>
        </div>
      </div>

      {/* üìã TRACKER TABLE */}
      <div className="bg-zinc-900 border border-white/10 rounded-xl overflow-hidden">
        <table className="w-full text-left text-sm">
          <thead className="bg-zinc-950 border-b border-white/10 text-xs uppercase font-black text-zinc-500 tracking-wider">
            <tr>
              <th className="p-4 w-12 text-center">#</th>
              <th className="p-4">Scene / Segment</th>
              <th className="p-4 w-32 text-center">Music</th>
              <th className="p-4 w-32 text-center">Dance</th>
              <th className="p-4 w-32 text-center">Block</th>
              <th className="p-4 w-24 text-center">Ready?</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-white/5">
            {scenes.map((scene) => {
              // Row Readiness Check
              const isReady = ['music', 'dance', 'block'].every(k => 
                scene.status[k] === 'polished' || scene.status[k] === 'done' || scene.status[k] === 'n/a'
              );

              return (
                <tr key={scene.id} className="hover:bg-white/5 transition-colors">
                  <td className="p-4 text-center font-mono text-zinc-500">{scene.order}</td>
                  <td className="p-4">
                    <div className="font-bold text-zinc-200">{scene.name}</div>
                    <div className="text-[10px] uppercase font-bold text-zinc-500 mt-0.5">{scene.type}</div>
                  </td>
                  
                  {/* Status Cells with Difficulty Dots */}
                  <StatusCell status={scene.status.music} load={scene.load.music} />
                  <StatusCell status={scene.status.dance} load={scene.load.dance} />
                  <StatusCell status={scene.status.block} load={scene.load.block} />

                  {/* Ready Check */}
                  <td className="p-4 text-center">
                    <div className={`mx-auto w-6 h-6 rounded flex items-center justify-center transition-all ${isReady ? 'bg-emerald-500 text-zinc-900 shadow-[0_0_10px_rgba(16,185,129,0.5)]' : 'bg-zinc-800 text-zinc-600'}`}>
                        {isReady ? <Check size={14} strokeWidth={4} /> : <Circle size={8} fill="currentColor" className="opacity-20" />}
                    </div>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// Helper: Status Pill + Difficulty Dots
function StatusCell({ status, load }: { status: string, load: number }) {
    if (load === 0 && (status === 'n/a' || status === 'new')) {
        return <td className="p-4 text-center"><Minus size={12} className="text-zinc-800 mx-auto"/></td>;
    }

    const styles: any = {
        new: "bg-red-500/10 text-red-500 border-red-500/20",
        draft: "bg-amber-500/10 text-amber-500 border-amber-500/20",
        polished: "bg-emerald-500/10 text-emerald-500 border-emerald-500/20",
        done: "bg-emerald-500/10 text-emerald-500 border-emerald-500/20",
        "n/a": "bg-zinc-800 text-zinc-500 border-zinc-700"
    };

    const labels: any = {
        new: "New",
        draft: "Draft",
        polished: "Polished",
        done: "Done",
        "n/a": "N/A"
    };

    return (
        <td className="p-4 text-center align-middle">
            <div className="flex flex-col items-center gap-1.5">
                <span className={`px-2 py-0.5 rounded border text-[10px] font-black uppercase tracking-wider ${styles[status] || styles.new}`}>
                    {labels[status] || "New"}
                </span>
                
                {/* üîµ Difficulty Dots (0-5) */}
                {load > 0 && (
                  <div className="flex gap-0.5" title={`Effort: ${load} pts`}>
                      {[...Array(5)].map((_, i) => (
                          <div key={i} className={`w-1 h-1 rounded-full ${i < load ? 'bg-blue-600' : 'bg-zinc-800'}`} />
                      ))}
                  </div>
                )}
            </div>
        </td>
    );
}
</file>

<file path="app/components/dashboard/SeasonContext.tsx">
"use client";

import { useState, useMemo } from 'react';
import { 
  Crown, Users, Megaphone, GraduationCap, 
  LayoutGrid, ChevronDown, Heart, TrendingUp, 
  Home, Sparkles 
} from 'lucide-react';

const SEASON_STAFF = [
  { name: "Aimee Mestler", role: "Executive Director", initials: "AM", color: "bg-indigo-600", icon: <Crown size={12}/> },
  { name: "Krista McKinley", role: "Business Manager", initials: "KM", color: "bg-emerald-600", icon: <Users size={12}/> },
  { name: "Jenny Adler", role: "Production Coord", initials: "JA", color: "bg-pink-600", icon: <Megaphone size={12}/> },
  { name: "Elizabeth Davis", role: "Education Coord", initials: "ED", color: "bg-blue-600", icon: <GraduationCap size={12}/> },
];

// --- HELPER: SMART SORT ---
function getSessionValue(sessionName: string) {
  if (!sessionName) return 0;
  const parts = sessionName.split(' ');
  let year = 0;
  let term = 0;
  parts.forEach(p => {
    if (p.match(/^\d{4}$/)) year = parseInt(p);
    if (p.includes('Winter')) term = 1;  // Winter is early in the year
    if (p.includes('Spring')) term = 4;
    if (p.includes('Summer')) term = 6;
    if (p.includes('Fall')) term = 9;    // Fall is late in the year
  });
  // Result: 202601 (Winter 26), 202509 (Fall 25)
  return (year * 100) + term;
}

export default function SeasonContext({ 
  initialSeason, 
  allClasses = [], 
  activeShowStats 
}: any) {
  
  // 1. EXTRACT & SORT SEASONS (Chronological)
  const sessions = useMemo(() => {
    const unique = Array.from(new Set(allClasses.map((c: any) => c.session).filter(Boolean)));
    // üö® FIX: Use the smart sorter (Newest First)
    return unique.sort((a: any, b: any) => getSessionValue(b) - getSessionValue(a));
  }, [allClasses]);

  // Default to the Active Show's season, or the newest one found
  const [selectedSeason, setSelectedSeason] = useState(initialSeason || sessions[0]);
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  // 2. CALCULATE REAL STATS
  const stats = useMemo(() => {
    // Filter classes for this specific season
    const seasonClasses = allClasses.filter((c: any) => c.session === selectedSeason);
    
    // A. Total Class Enrollment (Sum of all student counts)
    const academyCount = seasonClasses.reduce((acc: number, c: any) => acc + (c.students || 0), 0);
    
    // B. Cast Count (Only accurate if selected season == active show season)
    const isCurrentSeason = selectedSeason === initialSeason;
    const castCount = isCurrentSeason ? (activeShowStats?.castCount || 0) : 0; 

    // C. Total "Active" Students
    const totalStudents = academyCount + castCount;
    
    // D. Family Estimate (We don't have family IDs in the class list, so we estimate)
    // To get this exact, we'd need to fetch 1000+ student records. Estimate is faster.
    const familyCount = Math.floor(totalStudents * 0.75); 

    return { academyCount, familyCount, totalStudents, castCount };
  }, [allClasses, selectedSeason, initialSeason, activeShowStats]);

  return (
    <div className="bg-zinc-900/50 border border-white/5 rounded-3xl p-6 md:p-8 relative overflow-hidden transition-all">
        {/* Background Decor */}
        <div className="absolute top-0 right-0 p-12 opacity-5 pointer-events-none">
            <Heart size={300} className="text-pink-500 rotate-12"/>
        </div>

        {/* HEADER: Pivot Control */}
        <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-6 relative z-10">
            <div>
                <div className="flex items-center gap-2 mb-1">
                    <h2 className="text-xs font-black uppercase tracking-widest text-zinc-500 flex items-center gap-2">
                        <LayoutGrid size={14} className="text-blue-500" /> Organization
                    </h2>
                    <span className="text-zinc-700">/</span>
                    
                    {/* THE SEASON PICKER */}
                    <div className="relative">
                        <button 
                            onClick={() => setIsMenuOpen(!isMenuOpen)}
                            className="flex items-center gap-1 text-xs font-black uppercase tracking-widest text-blue-400 hover:text-blue-300 transition-colors"
                        >
                            {selectedSeason} <ChevronDown size={12} className={`transition-transform ${isMenuOpen ? 'rotate-180' : ''}`}/>
                        </button>
                        
                        {isMenuOpen && (
                            <div className="absolute top-full left-0 mt-2 w-56 bg-zinc-950 border border-white/10 rounded-xl shadow-2xl z-50 overflow-hidden max-h-60 overflow-y-auto custom-scrollbar ring-1 ring-white/10">
                                {sessions.map((s: any) => (
                                    <button
                                        key={s}
                                        onClick={() => { setSelectedSeason(s); setIsMenuOpen(false); }}
                                        className={`w-full text-left px-4 py-3 text-[10px] font-bold uppercase tracking-widest hover:bg-white/5 transition-colors border-b border-white/5 ${selectedSeason === s ? 'text-blue-400 bg-blue-500/10' : 'text-zinc-400'}`}
                                    >
                                        {s}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
                
                <h3 className="text-2xl font-black italic text-white tracking-tight">
                    Season Overview
                </h3>
            </div>
            
            {/* Staff Strip */}
            <div className="flex flex-wrap gap-3">
                {SEASON_STAFF.map((staff, i) => (
                    <div key={i} className="flex items-center gap-3 bg-zinc-950 border border-white/5 rounded-full p-1.5 pr-4 shadow-sm hover:border-white/10 transition-colors cursor-default">
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-black text-white shadow-md ${staff.color}`}>
                            {staff.initials}
                        </div>
                        <div className="flex flex-col leading-none">
                            <span className="text-[10px] font-bold text-zinc-300">{staff.name.split(' ')[0]}</span>
                            <span className="text-[8px] font-bold text-zinc-600 uppercase tracking-wider">{staff.role.split(' ')[0]}</span>
                        </div>
                    </div>
                ))}
            </div>
        </div>

        {/* METRICS GRID */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 relative z-10">
            {/* 1. Class Enrollment (Real) */}
            <MetricBox 
                icon={<GraduationCap size={20} />} 
                color="blue" 
                value={stats.academyCount} 
                label="Class Enrollment" 
            />
            {/* 2. Show Cast (Real for current, 0 for past) */}
             <MetricBox 
                icon={<Sparkles size={20} />} 
                color="purple" 
                value={stats.castCount > 0 ? stats.castCount : "N/A"} 
                label="Show Cast" 
            />
            {/* 3. Families (Estimated) */}
            <MetricBox 
                icon={<Home size={20} />} 
                color="emerald" 
                value={`~${stats.familyCount}`} 
                label="Est. Families" 
            />
            {/* 4. Total Reach (Sum) */}
            <MetricBox 
                icon={<TrendingUp size={20} />} 
                color="pink" 
                value={stats.totalStudents} 
                label="Total Reach" 
            />
        </div>
    </div>
  );
}

function MetricBox({ icon, color, value, label }: any) {
    const colors: any = {
        blue: "bg-blue-500/10 text-blue-400 group-hover:bg-blue-500/20",
        emerald: "bg-emerald-500/10 text-emerald-400 group-hover:bg-emerald-500/20",
        pink: "bg-pink-500/10 text-pink-400 group-hover:bg-pink-500/20",
        purple: "bg-purple-500/10 text-purple-400 group-hover:bg-purple-500/20",
    };

    return (
        <div className="bg-black/40 rounded-2xl p-5 border border-white/5 flex flex-col justify-between h-32 hover:bg-black/60 transition-colors group">
            <div className={`p-2 w-fit rounded-lg mb-2 transition-colors ${colors[color]}`}>
                {icon}
            </div>
            <div>
                <div className="text-3xl font-black text-white">{value}</div>
                <div className="text-[10px] font-bold uppercase text-zinc-500 tracking-wider">{label}</div>
            </div>
        </div>
    )
}
</file>

<file path="app/components/education/AttendanceSheet.tsx">
"use client";

import { useState } from 'react';
import { Check, X, Clock, Save, MoreHorizontal } from 'lucide-react';

export default function AttendanceSheet({ students }: { students: any[] }) {
  const [status, setStatus] = useState<Record<string, 'present' | 'absent' | 'late' | null>>({});

  const toggleStatus = (id: string, newStatus: 'present' | 'absent' | 'late') => {
    setStatus(prev => ({
      ...prev,
      [id]: prev[id] === newStatus ? null : newStatus
    }));
  };

  const markAll = () => {
    const next = { ...status };
    students.forEach(s => next[s.id] = 'present');
    setStatus(next);
  };

  return (
    <div className="bg-zinc-900 border border-white/5 rounded-3xl overflow-hidden">
      {/* Toolbar */}
      <div className="p-4 border-b border-white/5 flex justify-between items-center bg-zinc-950/30">
        <div className="flex gap-2">
            <button onClick={markAll} className="text-[10px] font-bold uppercase tracking-wider bg-zinc-800 hover:bg-zinc-700 px-3 py-1.5 rounded-lg transition-colors text-zinc-300">
                Mark All Present
            </button>
        </div>
        <button className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide transition-all shadow-lg shadow-blue-900/20">
            <Save size={14} /> Save Record
        </button>
      </div>

      {/* List */}
      <div className="divide-y divide-white/5">
        {students.map((student) => {
            const s = status[student.id];
            return (
                <div key={student.id} className="p-4 flex items-center justify-between hover:bg-white/[0.02] transition-colors">
                    <div className="flex items-center gap-4">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xs font-black ${student.photo ? '' : 'bg-zinc-800 text-zinc-500'}`}>
                            {student.photo ? (
                                <img src={student.photo} alt={student.name} className="w-full h-full object-cover rounded-full" />
                            ) : (
                                student.name.substring(0, 2).toUpperCase()
                            )}
                        </div>
                        <div>
                            <div className="text-sm font-bold text-white">{student.name}</div>
                            <div className="text-[10px] font-medium text-zinc-500 uppercase tracking-wider">ID: {student.id}</div>
                        </div>
                    </div>

                    <div className="flex gap-1">
                        <StatusBtn active={s === 'present'} color="bg-emerald-500" icon={<Check size={14} />} onClick={() => toggleStatus(student.id, 'present')} />
                        <StatusBtn active={s === 'late'} color="bg-amber-500" icon={<Clock size={14} />} onClick={() => toggleStatus(student.id, 'late')} />
                        <StatusBtn active={s === 'absent'} color="bg-red-500" icon={<X size={14} />} onClick={() => toggleStatus(student.id, 'absent')} />
                    </div>
                </div>
            );
        })}
        {students.length === 0 && (
            <div className="p-12 text-center text-zinc-500 italic text-sm">No students found in roster.</div>
        )}
      </div>
    </div>
  );
}

function StatusBtn({ active, color, icon, onClick }: any) {
    return (
        <button 
            onClick={onClick}
            className={`w-9 h-9 rounded-xl flex items-center justify-center transition-all ${active ? `${color} text-white shadow-lg scale-105` : 'bg-zinc-800 text-zinc-600 hover:bg-zinc-700'}`}
        >
            {icon}
        </button>
    )
}
</file>

<file path="app/components/education/ClassManagerModal.tsx">
"use client";

import { useState, useEffect } from 'react';
import { 
  X, Users, Calendar, Phone, Mail, 
  CheckCircle2, Clock, XCircle, Loader2, 
  Save, ChevronRight, Search 
} from 'lucide-react';
import { fetchRosterAction } from "@/app/lib/actions";

export default function ClassManagerModal({ cls, onClose }: { cls: any, onClose: () => void }) {
  const [activeTab, setActiveTab] = useState<'roster' | 'attendance'>('roster');
  const [students, setStudents] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Attendance State
  const [attendance, setAttendance] = useState<Record<string, string>>({});

  // Fetch data when modal opens
  useEffect(() => {
    async function load() {
      const data = await fetchRosterAction(cls.id);
      setStudents(data);
      setLoading(false);
    }
    load();
  }, [cls.id]);

  const toggleAttendance = (studentId: string) => {
    const current = attendance[studentId];
    const next = current === 'present' ? 'late' : current === 'late' ? 'absent' : 'present';
    setAttendance(prev => ({ ...prev, [studentId]: next }));
  };

  const markAllPresent = () => {
    const update: any = {};
    students.forEach(s => update[s.id] = 'present');
    setAttendance(update);
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-zinc-900 border border-white/10 rounded-3xl w-full max-w-4xl h-[80vh] flex flex-col shadow-2xl overflow-hidden">
        
        {/* HEADER */}
        <div className="p-6 border-b border-white/5 bg-zinc-950 flex justify-between items-start shrink-0">
          <div>
            <h2 className="text-2xl font-black text-white tracking-tight">{cls.name}</h2>
            <div className="flex items-center gap-3 mt-2 text-sm font-medium text-zinc-400">
              <span className="flex items-center gap-1"><Calendar size={14}/> {cls.day}</span>
              <span className="w-1 h-1 rounded-full bg-zinc-700"></span>
              <span>{cls.time}</span>
              <span className="w-1 h-1 rounded-full bg-zinc-700"></span>
              <span className="text-blue-400">{cls.teacher}</span>
            </div>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-colors">
            <X size={24} className="text-zinc-400" />
          </button>
        </div>

        {/* TABS */}
        <div className="flex border-b border-white/5 bg-black/20 shrink-0">
          <TabButton 
            active={activeTab === 'roster'} 
            onClick={() => setActiveTab('roster')} 
            icon={<Users size={16}/>} 
            label={`Roster (${students.length})`} 
          />
          <TabButton 
            active={activeTab === 'attendance'} 
            onClick={() => setActiveTab('attendance')} 
            icon={<CheckCircle2 size={16}/>} 
            label="Attendance" 
          />
        </div>

        {/* CONTENT AREA */}
        <div className="flex-1 overflow-y-auto p-6 bg-zinc-900/50 custom-scrollbar relative">
          {loading ? (
            <div className="absolute inset-0 flex items-center justify-center">
              <Loader2 className="animate-spin text-blue-500" size={32} />
            </div>
          ) : students.length === 0 ? (
            <div className="text-center py-20 opacity-50">
              <Users size={48} className="mx-auto mb-4 text-zinc-600" />
              <p>No students found in this roster.</p>
            </div>
          ) : (
            <>
              {activeTab === 'roster' && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {students.map(student => (
                    <div key={student.id} className="bg-zinc-950 border border-white/5 p-4 rounded-xl flex items-start gap-4 hover:border-white/10 transition-colors">
                      <div className="w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center text-xs font-black text-zinc-500 shrink-0">
                        {student.name.substring(0,2).toUpperCase()}
                      </div>
                      <div className="min-w-0">
                        <div className="font-bold text-white truncate">{student.name}</div>
                        <div className="text-[10px] text-zinc-500 uppercase font-bold tracking-wider mb-2">Age: {student.age || '?'}</div>
                        <div className="space-y-1">
                          {student.email && (
                            <div className="flex items-center gap-2 text-xs text-zinc-400">
                              <Mail size={12} className="text-zinc-600"/> <span className="truncate">{student.email}</span>
                            </div>
                          )}
                          {student.phone && (
                            <div className="flex items-center gap-2 text-xs text-zinc-400">
                              <Phone size={12} className="text-zinc-600"/> <span>{student.phone}</span>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {activeTab === 'attendance' && (
                <div className="space-y-2">
                   <div className="flex justify-between items-center mb-4 bg-blue-500/10 border border-blue-500/20 p-3 rounded-xl">
                      <div className="text-xs font-bold text-blue-300 uppercase tracking-wide flex items-center gap-2">
                        <Calendar size={14} /> Today: {new Date().toLocaleDateString()}
                      </div>
                      <button onClick={markAllPresent} className="text-[10px] font-black uppercase text-blue-400 hover:text-white transition-colors">
                        Mark All Present
                      </button>
                   </div>

                   {students.map(student => {
                     const status = attendance[student.id];
                     return (
                       <div key={student.id} onClick={() => toggleAttendance(student.id)} className="group cursor-pointer bg-zinc-950 border border-white/5 p-3 rounded-xl flex items-center justify-between hover:bg-zinc-800 transition-colors select-none">
                         <div className="flex items-center gap-3">
                           <div className={`w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-black transition-colors ${
                             status === 'present' ? 'bg-emerald-500 text-black' : 
                             status === 'late' ? 'bg-amber-500 text-black' :
                             status === 'absent' ? 'bg-red-500 text-white' : 'bg-zinc-800 text-zinc-600'
                           }`}>
                             {student.name.substring(0,2).toUpperCase()}
                           </div>
                           <span className={`font-bold transition-colors ${status ? 'text-white' : 'text-zinc-400'}`}>{student.name}</span>
                         </div>
                         
                         <div className="flex gap-1">
                            <StatusIndicator active={status === 'present'} color="bg-emerald-500" icon={<CheckCircle2 size={14}/>} />
                            <StatusIndicator active={status === 'late'} color="bg-amber-500" icon={<Clock size={14}/>} />
                            <StatusIndicator active={status === 'absent'} color="bg-red-500" icon={<XCircle size={14}/>} />
                         </div>
                       </div>
                     )
                   })}
                </div>
              )}
            </>
          )}
        </div>

        {/* FOOTER (Attendance Only) */}
        {activeTab === 'attendance' && (
          <div className="p-4 border-t border-white/5 bg-zinc-950 flex justify-end">
            <button className="bg-white text-black px-6 py-3 rounded-xl font-bold text-xs uppercase tracking-widest hover:bg-zinc-200 transition-colors flex items-center gap-2">
              <Save size={16} /> Save Record
            </button>
          </div>
        )}
      </div>
    </div>
  );
}

function TabButton({ active, onClick, icon, label }: any) {
  return (
    <button 
      onClick={onClick}
      className={`flex-1 flex items-center justify-center gap-2 py-4 text-xs font-bold uppercase tracking-widest transition-all ${
        active 
          ? 'bg-zinc-900 text-white border-b-2 border-blue-500' 
          : 'text-zinc-500 hover:text-zinc-300 hover:bg-white/5'
      }`}
    >
      {icon} {label}
    </button>
  )
}

function StatusIndicator({ active, color, icon }: any) {
  return (
    <div className={`w-8 h-8 rounded-lg flex items-center justify-center transition-all ${active ? `${color} text-white shadow-lg scale-110` : 'bg-transparent text-zinc-700'}`}>
      {icon}
    </div>
  )
}
</file>

<file path="app/components/reports/ReportsClient.tsx">
"use client";

import { useState } from 'react';
import { 
  BarChart3, PieChart, TrendingUp, Users, 
  Download, Filter, ChevronDown 
} from 'lucide-react';

export default function ReportsClient({ data, showTitle }: { data: any[], showTitle: string }) {
  const [activeTab, setActiveTab] = useState<'overview' | 'cast' | 'financial'>('overview');

  // Calculate Metrics safely
  const totalCast = data.length;
  const newStudents = data.filter(d => (d.status || "").toLowerCase().includes('new')).length;
  const returningStudents = totalCast - newStudents;
  const retentionRate = totalCast > 0 ? Math.round((returningStudents / totalCast) * 100) : 0;

  return (
    <div className="space-y-6">
      {/* Header Stats */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <StatCard 
          label="Total Cast" 
          value={totalCast} 
          icon={<Users size={20}/>} 
          color="bg-blue-500/10 text-blue-400 border-blue-500/20" 
        />
        <StatCard 
          label="New Students" 
          value={newStudents} 
          icon={<TrendingUp size={20}/>} 
          color="bg-emerald-500/10 text-emerald-400 border-emerald-500/20" 
        />
        <StatCard 
          label="Retention Rate" 
          value={`${retentionRate}%`} 
          icon={<PieChart size={20}/>} 
          color="bg-purple-500/10 text-purple-400 border-purple-500/20" 
        />
      </div>

      {/* Main Content Area */}
      <div className="bg-zinc-900/50 border border-white/5 rounded-3xl p-6">
        <div className="flex justify-between items-center mb-6">
            <h3 className="text-xl font-black text-white italic tracking-tight flex items-center gap-2">
                <BarChart3 className="text-zinc-500" size={24} />
                Cast Composition
            </h3>
            <button className="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-zinc-500 hover:text-white transition-colors bg-zinc-900 border border-white/5 px-4 py-2 rounded-xl">
                <Download size={14} /> Export CSV
            </button>
        </div>

        {/* Cast List Table */}
        <div className="overflow-hidden rounded-xl border border-white/5 bg-zinc-950/50">
            <table className="w-full text-left text-sm">
                <thead className="bg-zinc-900/50 text-xs font-black uppercase tracking-widest text-zinc-500">
                    <tr>
                        <th className="p-4">Performer</th>
                        <th className="p-4">Status</th>
                        <th className="p-4 text-right">Role ID</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-white/5">
                    {data.map((student: any) => (
                        <tr key={student.id} className="hover:bg-white/5 transition-colors">
                            <td className="p-4">
                                <div className="flex items-center gap-3">
                                    {/* üö® FIX: Safety check for name */}
                                    <div className="w-8 h-8 rounded-full bg-zinc-800 text-zinc-400 flex items-center justify-center text-xs font-black border border-white/5">
                                        {(student.name || "?").charAt(0).toUpperCase()}
                                    </div>
                                    <span className="font-bold text-zinc-200">
                                        {student.name || "Unknown Name"}
                                    </span>
                                </div>
                            </td>
                            <td className="p-4">
                                <span className={`px-2 py-1 rounded-md text-[10px] font-black uppercase tracking-wide border ${
                                    (student.status || "").toLowerCase().includes('new') 
                                    ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' 
                                    : 'bg-zinc-800 text-zinc-500 border-white/5'
                                }`}>
                                    {student.status || "Unknown"}
                                </span>
                            </td>
                            <td className="p-4 text-right font-mono text-xs text-zinc-600">
                                {student.id}
                            </td>
                        </tr>
                    ))}
                    {data.length === 0 && (
                        <tr>
                            <td colSpan={3} className="p-8 text-center text-zinc-500 italic">
                                No data found for {showTitle}
                            </td>
                        </tr>
                    )}
                </tbody>
            </table>
        </div>
      </div>
    </div>
  );
}

function StatCard({ label, value, icon, color }: any) {
    return (
        <div className={`p-6 rounded-2xl border ${color} flex items-center gap-4`}>
            <div className="p-3 bg-zinc-950 rounded-xl border border-white/5 opacity-80">
                {icon}
            </div>
            <div>
                <div className="text-3xl font-black">{value}</div>
                <div className="text-[10px] font-black uppercase tracking-widest opacity-60">{label}</div>
            </div>
        </div>
    )
}
</file>

<file path="app/components/ChoreoWorkspace.tsx">
"use client";

import React, { useState, useEffect, useRef, useMemo } from "react";
import { 
  ArrowLeft, ArrowRight, Move, 
  AlertTriangle, Star, Zap, Smile, ThumbsUp, MessageSquare,
  Video, Users, Loader2, RefreshCw, ChevronDown, Trash2, Eraser
} from "lucide-react";

// --- CONFIG ---
const STANDARD_TAGS = [
  { id: "#Featured", label: "Featured", icon: Star, color: "bg-purple-600 border-purple-400" },
  { id: "#Tap", label: "Tap", icon: Zap, color: "bg-blue-600 border-blue-400" },
  { id: "#Acro", label: "Acro", icon: Move, color: "bg-emerald-600 border-emerald-400" },
];

const LEVELS = [
  { val: 2, label: "Non-Mover", color: "bg-zinc-800 text-zinc-400 border-zinc-600" },
  { val: 3, label: "Mover", color: "bg-blue-900/30 text-blue-300 border-blue-500/50" },
  { val: 4, label: "Dancer", color: "bg-purple-900/30 text-purple-300 border-purple-500/50" },
  { val: 5, label: "Advanced", color: "bg-emerald-900/30 text-emerald-300 border-emerald-500/50" },
];

export default function ChoreoWorkspace({ 
  people, 
  initialGrades, 
  onSave 
}: { 
  people: any[]; 
  initialGrades: any; 
  onSave: (id: number, score: number, tags: string, videoUrl?: string) => void;
}) {
  // --- STATE ---
  const [activeSlot, setActiveSlot] = useState<string>("");
  const [viewMode, setViewMode] = useState<'group' | 'grade'>('group');
  const [selectedIndex, setSelectedIndex] = useState(0);
  const [localNotes, setLocalNotes] = useState("");
  
  // UPLOAD STATE
  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState("0%");

  // SWIPE REFS
  const touchStartX = useRef<number | null>(null);
  const touchEndX = useRef<number | null>(null);

  // --- GROUPING LOGIC ---
  const groupedPeople = useMemo(() => {
      const groups: Record<string, any[]> = {};
      people.forEach(p => {
          const slot = p.timeSlot || "Unscheduled";
          if (!groups[slot]) groups[slot] = [];
          groups[slot].push(p);
      });
      return groups;
  }, [people]);

  const slots = Object.keys(groupedPeople).sort();
  
  useEffect(() => {
      if (slots.length > 0 && !activeSlot) setActiveSlot(slots[0]);
  }, [slots, activeSlot]);

  const currentGroup = groupedPeople[activeSlot] || [];
  const activeStudent = currentGroup[selectedIndex];
  const activeGrade = initialGrades[activeStudent?.id] || {};

  const groupVideoUrl = currentGroup.length > 0 
      ? (initialGrades[currentGroup[0].id]?.video || currentGroup[0].video) 
      : null;

  useEffect(() => {
      setLocalNotes(activeGrade.choreoNotes || "");
  }, [activeStudent?.id, activeGrade.choreoNotes]);


  // --- ACTIONS ---
  const handleScore = (score: number) => onSave(activeStudent.id, score, localNotes);
  
  // NEW: Full Reset Handler
  const handleClear = () => {
      setLocalNotes(""); // Wipe text UI
      onSave(activeStudent.id, 0, ""); // Wipe DB
  };

  const handleManualNoteChange = (text: string) => setLocalNotes(text);
  const saveNotes = () => onSave(activeStudent.id, activeGrade.dance || 0, localNotes);

  const handleToggleTag = (tag: string) => {
    let newNotes = localNotes;
    if (newNotes.includes(tag)) newNotes = newNotes.replace(tag, "").trim();
    else newNotes = `${newNotes} ${tag}`.trim();
    setLocalNotes(newNotes); 
    onSave(activeStudent.id, activeGrade.dance || 0, newNotes); 
  };

  const handleAttitudeCycle = () => {
    let newNotes = localNotes;
    if (newNotes.includes("#GreatAttitude")) newNotes = newNotes.replace("#GreatAttitude", "#BadAttitude");
    else if (newNotes.includes("#BadAttitude")) newNotes = newNotes.replace("#BadAttitude", "").trim();
    else newNotes = `${newNotes} #GreatAttitude`.trim();
    setLocalNotes(newNotes);
    onSave(activeStudent.id, activeGrade.dance || 0, newNotes);
  };

  const getAttitudeState = () => {
      if (localNotes.includes("#GreatAttitude")) return "good";
      if (localNotes.includes("#BadAttitude")) return "bad";
      return "none";
  };
  const attState = getAttitudeState();

  const handleBatchVideoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
      const file = e.target.files?.[0];
      if (!file) return;
      setIsUploading(true);
      setUploadProgress("Start");
      try {
          const res = await fetch('/api/upload', {
              method: 'POST',
              body: JSON.stringify({ filename: `GROUP-${activeSlot}-${file.name}`, fileType: file.type }),
          });
          if (!res.ok) throw new Error("Failed to sign");
          const { uploadUrl, publicUrl } = await res.json();

          setUploadProgress("Uploading...");
          const uploadRes = await fetch(uploadUrl, {
              method: 'PUT',
              body: file,
              headers: { "Content-Type": file.type, "x-amz-acl": "public-read" },
          });
          if (!uploadRes.ok) throw new Error("Upload failed");

          alert("Video Uploaded! Linking to all dancers in this group...");
          currentGroup.forEach(student => {
              const oldNotes = initialGrades[student.id]?.choreoNotes || "";
              const oldScore = initialGrades[student.id]?.dance || 0;
              if (!oldNotes.includes(publicUrl)) {
                  const newNotes = `${oldNotes} [GROUP VIDEO]`.trim();
                  onSave(student.id, oldScore, newNotes, publicUrl);
              }
          });
      } catch (err) {
          console.error(err);
          alert("Upload failed. Use Camera Roll.");
      } finally {
          setIsUploading(false);
          setUploadProgress("0%");
      }
  };

  const handleDeleteVideo = () => {
      if(!confirm("Delete this group video? This cannot be undone.")) return;
      currentGroup.forEach(student => {
          const oldScore = initialGrades[student.id]?.dance || 0;
          const oldNotes = initialGrades[student.id]?.choreoNotes || "";
          const cleanNotes = oldNotes.replace("[GROUP VIDEO]", "").trim();
          onSave(student.id, oldScore, cleanNotes, "DELETE");
      });
  };

  const changeStudent = (delta: number) => {
      const newIndex = selectedIndex + delta;
      if (newIndex >= 0 && newIndex < currentGroup.length) setSelectedIndex(newIndex);
  };

  const handleTouchStart = (e: React.TouchEvent) => { touchStartX.current = e.targetTouches[0].clientX; };
  const handleTouchMove = (e: React.TouchEvent) => { touchEndX.current = e.targetTouches[0].clientX; };
  const handleTouchEnd = () => {
      if (!touchStartX.current || !touchEndX.current) return;
      const distance = touchStartX.current - touchEndX.current;
      if (distance > 50) changeStudent(1);
      if (distance < -50) changeStudent(-1);
      touchStartX.current = null;
      touchEndX.current = null;
  };

  if (!activeSlot) return <div className="p-8 text-center text-zinc-500">Loading Groups...</div>;

  return (
    <div className="flex flex-col h-full bg-black overflow-hidden relative">
      
      {/* 0. TIME SLOTS */}
      <div className={`h-14 bg-zinc-900 border-b border-white/5 flex items-center px-2 gap-2 overflow-x-auto shrink-0 custom-scrollbar transition-all duration-300 ${viewMode === 'grade' ? 'h-0 opacity-0 overflow-hidden border-none' : ''}`}>
          {slots.map((slot) => {
              const isActive = slot === activeSlot;
              const count = groupedPeople[slot].length;
              return (
                  <button
                    key={slot}
                    onClick={() => { setActiveSlot(slot); setViewMode('group'); setSelectedIndex(0); }}
                    className={`px-4 py-2 rounded-full text-[11px] font-black uppercase whitespace-nowrap transition-all flex-shrink-0 flex flex-col items-center leading-none gap-1
                        ${isActive ? 'bg-blue-600 text-white shadow-lg' : 'bg-zinc-800 text-zinc-500 border border-white/5'}
                    `}
                  >
                      <span>{slot}</span>
                      <span className={`text-[8px] ${isActive ? 'text-blue-200' : 'text-zinc-600'}`}>{count} Dancers</span>
                  </button>
              )
          })}
      </div>

      {/* === PERSISTENT VIDEO PLAYER === */}
      <div className={`w-full bg-black border-b border-white/10 shrink-0 relative transition-all duration-500 ease-in-out
          ${viewMode === 'group' ? 'flex-1 max-h-[40vh]' : 'h-36 md:h-64'}
      `}>
          {groupVideoUrl ? (
              <div className="relative w-full h-full group">
                  <video 
                      src={groupVideoUrl} 
                      controls 
                      playsInline
                      className="w-full h-full object-contain bg-zinc-950"
                  />
                  <div className="absolute top-2 right-2 flex gap-2 z-10">
                     <label className="flex items-center gap-2 bg-black/60 hover:bg-black/80 backdrop-blur text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase cursor-pointer border border-white/10 transition-colors">
                         <RefreshCw size={12} /> Retake
                         <input type="file" accept="video/*" capture="environment" className="hidden" onChange={handleBatchVideoUpload} disabled={isUploading} />
                     </label>
                     <button 
                        onClick={handleDeleteVideo}
                        className="flex items-center gap-2 bg-red-600/80 hover:bg-red-600 backdrop-blur text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase cursor-pointer border border-white/10 transition-colors"
                     >
                         <Trash2 size={12} /> Delete
                     </button>
                  </div>
              </div>
          ) : (
              <label className={`w-full h-full flex flex-col items-center justify-center gap-3 transition-all cursor-pointer bg-zinc-900 ${isUploading ? 'opacity-50 cursor-wait' : ''}`}>
                  {isUploading ? (
                      <>
                        <Loader2 size={32} className="text-blue-500 animate-spin" />
                        <span className="text-blue-500 font-black uppercase tracking-widest text-xs">{uploadProgress}</span>
                      </>
                  ) : (
                      <>
                        <div className="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center shadow-lg shadow-red-900/40">
                            <Video size={24} className="text-white" />
                        </div>
                        <div className="text-center">
                            <p className="text-white font-black uppercase tracking-wider text-xs">Record Group Video</p>
                        </div>
                        <input type="file" accept="video/*" capture="environment" className="hidden" onChange={handleBatchVideoUpload} disabled={isUploading} />
                      </>
                  )}
              </label>
          )}

          {viewMode === 'grade' && (
              <button 
                  onClick={() => setViewMode('group')}
                  className="absolute top-2 left-2 z-20 flex items-center gap-1 text-white text-[10px] font-black uppercase bg-black/60 px-3 py-1.5 rounded-full backdrop-blur border border-white/10 hover:bg-black/80"
              >
                  <ChevronDown size={12} /> Show Roster
              </button>
          )}
      </div>

      {/* === CONTENT AREA === */}
      <div className="flex-1 overflow-y-auto relative bg-zinc-950 flex flex-col">
          
          {viewMode === 'group' && (
              <div className="p-4">
                  <div className="flex justify-between items-end mb-3">
                      <h3 className="text-zinc-400 font-black uppercase text-xs tracking-widest flex items-center gap-2">
                          <Users size={14} /> {activeSlot} Roster
                      </h3>
                      {currentGroup.length > 0 && (
                          <button 
                            onClick={() => { setSelectedIndex(0); setViewMode('grade'); }} 
                            className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wide flex items-center gap-2"
                          >
                              Start Grading
                          </button>
                      )}
                  </div>
                  <div className="grid grid-cols-4 gap-2 pb-24">
                      {currentGroup.map((p, i) => {
                          const grade = initialGrades[p.id]?.dance || 0;
                          return (
                              <div 
                                key={p.id} 
                                onClick={() => { setSelectedIndex(i); setViewMode('grade'); }}
                                className={`aspect-square relative rounded-lg overflow-hidden border cursor-pointer transition-all
                                    ${grade > 0 ? 'border-blue-500/50' : 'border-white/10 hover:border-white/30'}
                                `}
                              >
                                  <img src={p.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-full h-full object-cover" />
                                  {grade > 0 && (
                                      <div className="absolute inset-0 bg-blue-900/60 flex items-center justify-center">
                                          <span className="text-xl font-black text-white">{grade}</span>
                                      </div>
                                  )}
                                  <div className="absolute bottom-0 inset-x-0 bg-black/60 p-1">
                                      <p className="text-[8px] font-bold text-white truncate text-center">{p.name}</p>
                                  </div>
                              </div>
                          )
                      })}
                  </div>
              </div>
          )}

          {viewMode === 'grade' && activeStudent && (
              <div className="flex flex-col flex-1 h-full min-h-0">
                  
                  {/* COMPACT STUDENT HEADER */}
                  <div className="flex items-center justify-between p-3 border-b border-white/5 bg-zinc-900/50 shrink-0">
                      <button onClick={() => changeStudent(-1)} disabled={selectedIndex === 0} className="p-2 text-zinc-400 hover:text-white disabled:opacity-20"><ArrowLeft size={20} /></button>
                      
                      <div className="flex items-center gap-3">
                          <div className="w-10 h-10 rounded-full overflow-hidden border border-white/10 shrink-0">
                              <img src={activeStudent.avatar || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"} className="w-full h-full object-cover" />
                          </div>
                          <div className="text-center">
                              <h2 className="text-sm font-black uppercase text-white leading-none">{activeStudent.name}</h2>
                              <p className="text-[9px] text-zinc-500 font-bold uppercase mt-0.5">#{activeStudent.id.toString().slice(-3)} ‚Ä¢ {activeStudent.age}</p>
                          </div>
                          {activeGrade.dance > 0 && (
                             <div className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center border-2 border-black shadow-lg ml-2">
                                 <span className="text-sm font-black text-white">{activeGrade.dance}</span>
                             </div>
                          )}
                      </div>

                      <button onClick={() => changeStudent(1)} disabled={selectedIndex === currentGroup.length - 1} className="p-2 text-zinc-400 hover:text-white disabled:opacity-20"><ArrowRight size={20} /></button>
                  </div>

                  {/* CONTROL PAD */}
                  <div 
                    className="flex-1 bg-zinc-900 border-t border-white/10 p-4 pb-48 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)] flex flex-col justify-start"
                    onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}
                  >
                      <div className="grid grid-cols-4 gap-2 mb-1 mt-2">
                          {LEVELS.map((lvl) => (
                              <button key={lvl.val} onClick={() => handleScore(lvl.val)} className={`h-14 rounded-xl flex flex-col items-center justify-center border-2 transition-all active:scale-95 ${activeGrade.dance === lvl.val ? `${lvl.color.replace('/30', '')} text-white shadow-lg scale-105` : `bg-transparent border-white/5 text-zinc-500 hover:bg-white/5`}`}>
                                  <span className="text-lg font-black">{lvl.val}</span>
                                  <span className="text-[8px] font-bold uppercase whitespace-nowrap">{lvl.label}</span>
                              </button>
                          ))}
                      </div>

                      {/* FULL RESET BUTTON */}
                      <div className="flex justify-end mb-3 h-5">
                          {activeGrade.dance > 0 && (
                              <button 
                                  onClick={handleClear} 
                                  className="flex items-center gap-1 text-[10px] font-bold uppercase text-zinc-500 hover:text-red-400 transition-colors"
                              >
                                  <Eraser size={12} /> Clear All (Score & Notes)
                              </button>
                          )}
                      </div>

                      <div className="mb-3 relative">
                          <input value={localNotes} onChange={(e) => handleManualNoteChange(e.target.value)} onBlur={saveNotes} placeholder="Type note..." className="w-full bg-black/40 border border-white/5 rounded-lg pl-9 pr-4 py-3 text-sm text-white placeholder:text-zinc-600 focus:border-blue-500 outline-none" />
                          <MessageSquare size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-600" />
                      </div>

                      <div className="flex flex-wrap justify-center gap-2">
                          {STANDARD_TAGS.map((tag) => {
                              const isActive = (localNotes || "").includes(tag.id);
                              return (
                                  <button key={tag.id} onClick={() => handleToggleTag(tag.id)} className={`flex items-center gap-1.5 px-3 py-3 rounded-full border transition-all active:scale-95 flex-grow justify-center ${isActive ? `${tag.color} text-white shadow-lg` : "bg-zinc-950 border-white/10 text-zinc-400"}`}>
                                      <tag.icon size={14} fill={isActive ? "currentColor" : "none"} />
                                      <span className="text-[10px] font-bold uppercase tracking-wide">{tag.label}</span>
                                  </button>
                              );
                          })}
                          <button onClick={handleAttitudeCycle} className={`flex items-center gap-1.5 px-3 py-3 rounded-full border transition-all active:scale-95 flex-grow justify-center ${attState === 'good' ? "bg-emerald-600 border-emerald-400 text-white shadow-lg" : attState === 'bad' ? "bg-red-600 border-red-400 text-white shadow-lg" : "bg-zinc-950 border-white/10 text-zinc-400"}`}>
                              {attState === 'good' ? <ThumbsUp size={14} fill="currentColor" /> : attState === 'bad' ? <AlertTriangle size={14} fill="currentColor" /> : <Smile size={14} />}
                              <span className="text-[10px] font-bold uppercase tracking-wide">{attState === 'good' ? "Good Att." : attState === 'bad' ? "Bad Att." : "Attitude"}</span>
                          </button>
                      </div>
                  </div>
              </div>
          )}
      </div>
    </div>
  );
}
</file>

<file path="app/context/SimulationContext.tsx">
"use client";

import React, { createContext, useContext, useState } from 'react';

interface SimulationContextType {
  // The "Effective" roles (Simulated if active, otherwise Real)
  role: string;
  productionRole: string | null;
  
  // Controls
  isSimulating: boolean;
  simulate: (global: string | null, prod: string | null) => void;
  reset: () => void;
}

const SimulationContext = createContext<SimulationContextType | null>(null);

export function SimulationProvider({ 
  children, 
  realGlobalRole, 
  realProductionRole 
}: { 
  children: React.ReactNode, 
  realGlobalRole: string, 
  realProductionRole: string | null 
}) {
  const [simGlobal, setSimGlobal] = useState<string | null>(null);
  const [simProd, setSimProd] = useState<string | null>(null);

  // LOGIC: Use Sim if it exists, otherwise use Real
  const effectiveGlobal = simGlobal || realGlobalRole;
  const effectiveProd = simProd !== null ? simProd : realProductionRole;

  const simulate = (global: string | null, prod: string | null) => {
    setSimGlobal(global);
    setSimProd(prod);
  };

  const reset = () => {
    setSimGlobal(null);
    setSimProd(null);
  };

  return (
    <SimulationContext.Provider value={{
      role: effectiveGlobal,
      productionRole: effectiveProd,
      isSimulating: !!(simGlobal || simProd),
      simulate,
      reset
    }}>
      {children}
    </SimulationContext.Provider>
  );
}

export function useSimulation() {
  const context = useContext(SimulationContext);
  if (!context) throw new Error("useSimulation must be used within a SimulationProvider");
  return context;
}
</file>

<file path="get-schema.js">
// get-schema.js
// Run with: node --env-file=.env.local get-schema.js

const https = require('https');

// IDs updated based on your provided list
const TABLES = {
  PEOPLE: "599",
  PRODUCTIONS: "600",
  MASTER_SHOW_DB: "601",
  ASSIGNMENTS: "603",    // Cast/Crew Assignments
  ROLES: "605",          // Blueprint Roles
  SIGNATURES: "607",
  STATS: "608",
  ROLES_POSITIONS: "609",
  TEAM_ASSIGNMENTS: "610",
  MEASUREMENTS: "616",
  GARMENT_INVENTORY: "617",
  STUDENT_BIO: "618",
  COMMITTEE_PREFS: "620",
  ATTENDANCE: "622",
  CONFLICTS: "623",      // Rehearsal Event Conflicts
  REQUIREMENTS: "624",
  EVENTS: "625",         // Rehearsal/Production Events (The Parent Container)
  SCENES: "627",
  SCENE_ASSIGNMENTS: "628",
  AUDITIONS: "630",
  RESOURCES: "631",
  SESSIONS: "632",
  CLASSES: "633",
  FAMILIES: "634",
  VENUES: "635",
  SEATS: "636",
  PERFORMANCES: "637",
  SPACES: "638",
  RATES: "639",
  SLOTS: "640",          // Schedule Slots (The Child/Time Blocks)
};

const BASE_URL = process.env.NEXT_PUBLIC_BASEROW_URL || "https://api.baserow.io";
const TOKEN = process.env.NEXT_PUBLIC_BASEROW_TOKEN;

// Remove trailing slash if present for the fetch URL
const CLEAN_BASE_URL = BASE_URL.replace(/\/$/, "");

async function fetchFields(tableId, tableName) {
  const url = `${CLEAN_BASE_URL}/api/database/fields/table/${tableId}/`;
  
  try {
    const res = await fetch(url, {
      headers: {
        'Authorization': `Token ${TOKEN}`
      }
    });

    if (!res.ok) {
        console.error(`\n‚ùå Error fetching ${tableName} (${tableId}): ${res.status} ${res.statusText}`);
        return { table: tableName, fields: ["ERROR_FETCHING"] };
    }

    const fields = await res.json();
    // Simplify output to just Name + Type + ID (Tokens save space)
    const simplified = fields.map(f => `${f.name} (ID: field_${f.id}, Type: ${f.type})`);
    return { table: tableName, id: tableId, fields: simplified };

  } catch (e) {
    console.error(`\n‚ùå Network Error for ${tableName}:`, e.message);
    return { table: tableName, fields: ["NETWORK_ERROR"] };
  }
}

(async () => {
  if (!TOKEN) {
      console.error("‚ùå FATAL: No Token found. Make sure .env.local exists and has NEXT_PUBLIC_BASEROW_TOKEN.");
      process.exit(1);
  }

  console.log("--- BASEROW SCHEMA CONTEXT ---");
  console.log(`Target: ${CLEAN_BASE_URL}`);
  
  for (const [name, id] of Object.entries(TABLES)) {
    const data = await fetchFields(id, name);
    if (data.fields[0] !== "ERROR_FETCHING") {
        console.log(`\nTABLE: ${name} (ID: ${id})`);
        console.log(data.fields.join("\n"));
    }
  }
  console.log("\n--- END CONTEXT ---");
})();
</file>

<file path="package.json">
{
  "name": "open-backstage-casting",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@aws-sdk/client-s3": "^3.958.0",
    "@aws-sdk/s3-request-presigner": "^3.958.0",
    "axios": "^1.7.9",
    "clsx": "^2.1.0",
    "lucide-react": "^0.562.0",
    "next": "16.1.1",
    "next-auth": "^5.0.0-beta.30",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "recharts": "^3.6.0",
    "tailwind-merge": "^2.2.1"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="app/(main)/(casting)/conflicts/page.tsx">
import React from 'react';
import { cookies } from 'next/headers';
import { 
  getActiveProduction, 
  getShowById, 
  getConflicts, 
  getProductionEvents,
  getAssignments 
} from '@/app/lib/baserow';
import { Users, Calendar, AlertTriangle } from 'lucide-react';
import ConflictsClient from '@/app/components/conflicts/ConflictsClient'; // Assuming you have a client component for the filters/log

export const dynamic = 'force-dynamic';

export default async function ConflictsPage() {
  // 1. üîç RESOLVE CONTEXT (The Fix)
  const cookieStore = await cookies();
  const cookieId = cookieStore.get('active_production_id')?.value;
  
  let production = null;
  if (cookieId) production = await getShowById(cookieId);
  if (!production) production = await getActiveProduction();

  if (!production) return <div className="p-10 text-zinc-500">No Active Production found.</div>;

  // 2. üì° FETCH DATA FOR THIS SPECIFIC SHOW
  const [conflicts, events, assignments] = await Promise.all([
    getConflicts(production.id),
    getProductionEvents(production.id),
    getAssignments(production.id) // Fetches the specific cast list for this show
  ]);

  // 3. üßπ CLEAN DATA FOR UI
  // Create a unique list of actors for the sidebar filter
  const actors = Array.from(new Set(
    assignments
      .filter((a: any) => a.personName)
      .map((a: any) => ({ id: a.personId, name: a.personName }))
  )).sort((a: any, b: any) => a.name.localeCompare(b.name));

  return (
    <main className="h-screen flex flex-col bg-zinc-950 text-white overflow-hidden">
      
      {/* HEADER */}
      <header className="px-8 py-6 border-b border-white/10 shrink-0 bg-zinc-900/50 backdrop-blur-md flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-black uppercase tracking-tight flex items-center gap-3">
            <AlertTriangle className="text-amber-500" /> 
            Conflict Matrix
          </h1>
          <p className="text-zinc-400 text-sm mt-1">
             Managing attendance for <span className="text-white font-bold">{production.title}</span>
          </p>
        </div>
        
        {/* Quick Stats */}
        <div className="flex gap-6 text-right">
           <div>
              <div className="text-2xl font-black text-white">{conflicts.length}</div>
              <div className="text-[10px] uppercase font-bold text-zinc-500 tracking-wider">Total Entries</div>
           </div>
        </div>
      </header>

      {/* CLIENT COMPONENT (Handles Filtering & Layout) */}
      <ConflictsClient 
        initialConflicts={conflicts} 
        actors={actors} // Pass the correct cast list here
        events={events}
        showTitle={production.title}
      />

    </main>
  );
}
</file>

<file path="app/(main)/analytics/page.tsx">
// app/analytics/page.jsx
import { getPerformanceAnalytics } from '@/app/lib/baserow';
import SalesChart from '@/app/components/charts/SalesChart';
import { LayoutDashboard, FileWarning, RefreshCcw } from 'lucide-react';

export default async function AnalyticsPage() {
  const chartData = await getPerformanceAnalytics();
  const hasData = chartData && chartData.length > 0;

  return (
    <div className="p-8 bg-zinc-950 min-h-screen text-white selection:bg-blue-500/30">
      <header className="flex flex-col md:flex-row md:items-end justify-between mb-12 gap-6">
        <div>
          <div className="flex items-center gap-2 mb-2">
            <LayoutDashboard className="text-blue-500" size={18} />
            <span className="text-[10px] font-black text-zinc-500 uppercase tracking-[0.2em]">Open Backstage Core</span>
          </div>
          <h1 className="text-5xl font-black tracking-tighter">
            SHOW <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-emerald-500">ANALYTICS</span>
          </h1>
          <p className="text-zinc-500 text-sm font-medium mt-3 max-w-lg leading-relaxed">
            Real-time house management and ticket velocity tracking for Fredericksburg production cycles.
          </p>
        </div>

        {hasData && (
          <div className="flex items-center gap-3 px-4 py-2 bg-zinc-900/50 border border-white/5 rounded-full">
            <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
            <span className="text-[10px] font-black uppercase tracking-widest text-zinc-300">
              {chartData.length} Performances Tracked
            </span>
          </div>
        )}
      </header>

      <main>
        {hasData ? (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-1000">
            <SalesChart data={chartData} />
          </div>
        ) : (
          <EmptyState />
        )}
      </main>
    </div>
  );
}

function EmptyState() {
  return (
    <div className="flex flex-col items-center justify-center py-32 px-6 border-2 border-dashed border-zinc-900 rounded-[3rem] text-center">
      <div className="p-6 bg-zinc-900/50 rounded-3xl mb-6">
        <FileWarning className="text-zinc-700" size={48} />
      </div>
      <h3 className="text-xl font-bold text-white mb-2 tracking-tight">No Financial Identity Found</h3>
      <p className="text-zinc-500 text-sm max-w-sm mb-8 leading-relaxed">
        We couldn&apos;t retrieve records from Table 637. Ensure your environment tokens have read access to the Performance Database.
      </p>
      <button className="flex items-center gap-2 px-6 py-3 bg-white text-black text-xs font-black uppercase tracking-widest rounded-full hover:bg-blue-500 hover:text-white transition-all active:scale-95">
        <RefreshCcw size={14} />
        Check Connection
      </button>
    </div>
  );
}
</file>

<file path="app/(main)/schedule/page.tsx">
import { cookies } from 'next/headers';
import { 
    getShowById, 
    getActiveProduction,
    getScenes,
    getRoles,
    getAssignments,
    getPeople,
    getScheduleSlots // üü¢ NEW IMPORT
} from '@/app/lib/baserow';
import SchedulerClient from '@/app/components/schedule/SchedulerClient';

export const dynamic = 'force-dynamic';

export default async function SchedulerPage() {
  const cookieStore = await cookies();
  let activeId = Number(cookieStore.get('active_production_id')?.value);
  let showTitle = "Select a Production";

  if (activeId) {
    const showData = await getShowById(activeId);
    if (showData && !Array.isArray(showData)) showTitle = showData.title;
  } else {
    const defaultShow = await getActiveProduction();
    if (defaultShow) {
      activeId = defaultShow.id;
      showTitle = defaultShow.title;
    }
  }

  // Fetch ALL necessary data
  const [scenes, roles, assignments, people, existingSlots] = await Promise.all([
      getScenes(activeId),      
      getRoles(),               
      getAssignments(activeId), 
      getPeople(),
      getScheduleSlots(activeId) // üü¢ Fetch the saved slots
  ]);

  return (
    <main className="h-screen bg-zinc-950 overflow-hidden">
      <SchedulerClient 
        scenes={scenes || []}
        roles={roles || []}
        assignments={assignments || []}
        people={people || []}
        productionTitle={showTitle}
        productionId={activeId}
        initialSchedule={existingSlots || []} // üü¢ Pass them to Client
      />
    </main>
  );
}
</file>

<file path="app/(main)/layout.tsx">
import React from 'react';
import { auth } from "@/auth"; 
import { cookies } from "next/headers";
import { getUserProfile, getUserProductionRole, getActiveProduction } from "@/app/lib/baserow"; 
import { SimulationProvider } from '@/app/context/SimulationContext'; 

import GlobalHeader from '@/app/components/globalappheader/globalappheader';
import StaffSidebar from '@/app/components/StaffSidebar';

export default async function MainLayout({ children }: { children: React.ReactNode }) {
  // 1. Fetch Session & User
  const session = await auth();
  const email = session?.user?.email;
  const userProfile = email ? await getUserProfile(email) : null;

  // 2. Determine Active Production (Context)
  const cookieStore = await cookies();
  const activeId = Number(cookieStore.get('active_production_id')?.value);
  
  // 3. Fetch Context-Aware Role
  // "What is this user's job on THIS specific show?"
  let productionRole = null;
  
  if (userProfile) {
      if (activeId) {
          // If a specific show is selected in cookies
          productionRole = await getUserProductionRole(Number(userProfile.id), activeId);
      } else {
          // Fallback: Check the default active production
          const defaultShow = await getActiveProduction();
          if (defaultShow) {
              productionRole = await getUserProductionRole(Number(userProfile.id), defaultShow.id);
          }
      }
  }

  // Define defaults if no user found
  const globalRole = userProfile?.role || "Student";

  return (
    <div className="flex h-screen bg-zinc-950 text-white overflow-hidden font-sans">
      
      {/* üöÄ WRAPPER: Makes God Mode possible across the entire app */}
      <SimulationProvider realGlobalRole={globalRole} realProductionRole={productionRole}>
      
          {/* 1. PERSISTENT SIDEBAR (Desktop Only) */}
          <aside className="hidden md:flex h-full shrink-0 z-20">
            {/* Sidebar now pulls from Context, so we don't pass props */}
            <StaffSidebar />
          </aside>

          {/* 2. MAIN CONTENT AREA */}
          <div className="flex-1 flex flex-col min-w-0 relative">
            
            <div className="shrink-0 z-30">
              <GlobalHeader />
            </div>
            
            <main className="flex-1 overflow-y-auto relative custom-scrollbar bg-zinc-950">
              {children}
            </main>
            
          </div>

      </SimulationProvider>
    </div>
  );
}
</file>

<file path="app/actions/casting.ts">
"use server";

import { fetchBaserow, DB } from "@/app/lib/baserow";
import { revalidatePath } from "next/cache";

export async function generateCastingRows(productionId: number) {
  console.log(`Generating casting rows for Production ${productionId}...`);

  // 1. Fetch ALL Blueprint Roles
  // üü¢ SCHEMA MATCH: Using DB.BLUEPRINT_ROLES
  const roles = await fetchBaserow(`/database/rows/table/${DB.BLUEPRINT_ROLES.ID}/`, {}, {
    size: "200", 
    "user_field_names": "true" 
  });

  if (!roles || roles.length === 0) throw new Error("No Blueprint Roles found!");

  // 2. Prepare the Batch Create requests
  const newRows = roles.map((role: any) => ({
    [DB.ASSIGNMENTS.FIELDS.PRODUCTION]: [productionId],
    
    // üü¢ SCHEMA MATCH: Linking to 'Performance Identity'
    [DB.ASSIGNMENTS.FIELDS.PERFORMANCE_IDENTITY]: [role.id],
    
    // üü¢ SCHEMA MATCH: Linking to 'Scene Assignments'
    // We grab the default scenes from the Blueprint's 'Active Scenes' field
    [DB.ASSIGNMENTS.FIELDS.SCENE_ASSIGNMENTS]: role['Active Scenes']?.map((s:any) => s.id) || [] 
  }));

  // 3. Send to Baserow (Batch create)
  await fetchBaserow(`/database/rows/table/${DB.ASSIGNMENTS.ID}/batch/`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ items: newRows })
  });

  // 4. Refresh the UI
  revalidatePath('/casting');
  return { success: true, count: newRows.length };
}
</file>

<file path="app/components/dashboard/DashboardClient.tsx">
"use client";

import React, { useState, useTransition } from 'react';
import { updateSceneStatus } from '@/app/lib/actions'; 
import { Search, Loader2 } from 'lucide-react';

export default function DashboardClient({ scenes, demographics }: any) {
  const [filter, setFilter] = useState('');
  
  // Filter scenes based on search
  const filteredScenes = scenes.filter((s: any) => 
    s.name.toLowerCase().includes(filter.toLowerCase()) || 
    s.id.toString().includes(filter)
  );

  return (
    <div className="space-y-6">
       
       {/* 1. SEARCH BAR */}
       <div className="flex gap-4 mb-6">
          <div className="relative flex-1">
             <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500" size={18} />
             <input 
               type="text" 
               placeholder="Search scenes..." 
               value={filter}
               onChange={(e) => setFilter(e.target.value)}
               className="w-full bg-zinc-900 border border-white/10 rounded-xl py-3 pl-12 pr-4 text-white focus:outline-none focus:border-blue-500 transition-colors"
             />
          </div>
       </div>

       {/* 2. THE SCENE LIST */}
       <div className="bg-zinc-900/50 border border-white/5 rounded-2xl overflow-hidden">
          <table className="w-full text-left border-collapse">
             <thead>
                <tr className="border-b border-white/5 text-xs font-black text-zinc-500 uppercase tracking-widest">
                   <th className="p-4 w-16 text-center">#</th>
                   <th className="p-4">Scene Name</th>
                   <th className="p-4 text-center w-32">Music</th>
                   <th className="p-4 text-center w-32">Dance</th>
                   <th className="p-4 text-center w-32">Block</th>
                </tr>
             </thead>
             <tbody className="divide-y divide-white/5">
                {filteredScenes.map((scene: any) => (
                   <SceneRow key={scene.id} scene={scene} />
                ))}
             </tbody>
          </table>
          
          {filteredScenes.length === 0 && (
             <div className="p-12 text-center text-zinc-500">No scenes found matching &ldquo;{filter}&ldquo;</div>
          )}
       </div>
    </div>
  );
}

// --- SUB-COMPONENT: ROW & CLICK LOGIC ---

function SceneRow({ scene }: any) {
  
  // Helper to render a clickable status dot
  const StatusCell = ({ type, value, load }: any) => {
    let [isPending, startTransition] = useTransition();

    // If load is 0 (e.g., No Dance in this scene), show nothing
    if (load === 0) return <div className="text-zinc-800">-</div>;

    // Cycle Logic: New -> Draft -> Polished -> New
    const getNextStatus = (current: string) => {
       if (!current || current === 'New') return 'Draft';
       if (current === 'Draft') return 'Polished';
       return 'New';
    };

    // Color Logic
    const getColor = (status: string) => {
       if (status === 'Polished') return 'bg-emerald-500 text-emerald-950 shadow-[0_0_15px_rgba(16,185,129,0.4)]';
       if (status === 'Draft') return 'bg-amber-500 text-amber-950 shadow-[0_0_15px_rgba(245,158,11,0.2)]';
       return 'bg-zinc-800 text-zinc-500 hover:bg-zinc-700'; // "New"
    };

    const label = value || "New";

    return (
       <button 
         disabled={isPending}
         onClick={() => startTransition(() => updateSceneStatus(scene.id, type, getNextStatus(value)))}
         className={`
            w-24 py-1.5 rounded-full text-[10px] font-black uppercase tracking-wider transition-all transform active:scale-95
            flex items-center justify-center gap-2
            ${getColor(value)}
            ${isPending ? 'opacity-50 cursor-not-allowed' : ''}
         `}
       >
         {isPending ? <Loader2 size={10} className="animate-spin" /> : label}
       </button>
    );
  };

  return (
    <tr className="hover:bg-white/[0.02] transition-colors group">
       <td className="p-4 text-center font-mono text-zinc-600 text-xs">{scene.order}</td>
       <td className="p-4">
          <div className="font-bold text-white group-hover:text-blue-200 transition-colors">{scene.name}</div>
          <div className="text-[10px] text-zinc-500 uppercase font-bold tracking-wider">{scene.pages ? `p. ${scene.pages}` : ''}</div>
       </td>
       <td className="p-4 text-center flex justify-center"><StatusCell type="music" value={scene.status.music} load={scene.load.music} /></td>
       <td className="p-4 text-center"><div className="flex justify-center"><StatusCell type="dance" value={scene.status.dance} load={scene.load.dance} /></div></td>
       <td className="p-4 text-center"><div className="flex justify-center"><StatusCell type="block" value={scene.status.block} load={scene.load.block} /></div></td>
    </tr>
  );
}
</file>

<file path="app/components/globalappheader/globalappheader.tsx">
import { cookies } from 'next/headers';
import { auth } from "@/auth"; // <--- NEW: Import from your root auth.ts
import { getAllShows } from '@/app/lib/baserow';
import GlobalHeaderClient from './client';

export default async function GlobalHeader() {
  // 1. Get the Session (The V5 Way)
  const session = await auth();

  // 2. Get Cookies & Data
  const cookieStore = await cookies();
  const activeId = Number(cookieStore.get('active_production_id')?.value);
  const shows = await getAllShows();

  // 3. Pass the user to the client
  return (
    <GlobalHeaderClient 
      shows={shows} 
      activeId={activeId} 
      user={session?.user} // <--- Pass real user data
    />
  );
}
</file>

<file path="app/login/page.tsx">
"use client";

import { useState, FormEvent } from 'react';
import { useRouter } from 'next/navigation';
import { signIn } from 'next-auth/react';
import { Lock, Loader2, AlertCircle, Chrome } from 'lucide-react';

export default function LoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');
  const router = useRouter();

  // 1. Handle Google Login
  const handleGoogleLogin = () => {
      setIsLoading(true);
      // "google" must match the provider ID in route.ts
      signIn("google", { callbackUrl: "/" });
  };

// 2. Handle Password Login
  const handleCredentialsLogin = async (e: FormEvent) => {
    e.preventDefault(); 
    setIsLoading(true); 
    setError('');

    const result = await signIn('credentials', {
      email,
      password,
      redirect: false, // üö® FIX: Must be false to get the 'result' object back!
    });

    if (result?.error) {
      // Now TypeScript knows 'result' exists and has an 'error' property
      setError("Invalid credentials. Please check your email and app password.");
      setIsLoading(false);
    } else {
      router.refresh(); 
      router.push('/'); // We handle the redirect manually here on success
    }
  };

  return (
    <div className="h-screen bg-zinc-950 flex items-center justify-center p-4">
      <div className="w-full max-w-sm bg-zinc-900 border border-white/10 p-8 rounded-2xl shadow-2xl text-center space-y-6">
        
        <div className="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto border border-blue-500/20">
            <Lock size={32} className="text-blue-500" />
        </div>
        
        <h1 className="text-2xl font-black uppercase italic text-white tracking-tight">Casting Portal</h1>
        
        {error && (
          <div className="bg-red-500/10 border border-red-500/20 text-red-400 p-3 rounded-xl flex items-center justify-center gap-2 text-sm font-medium">
            <AlertCircle size={16} />
            {error}
          </div>
        )}

        <div className="space-y-4">
            
            {/* --- NEW: GOOGLE SSO BUTTON --- */}
            <button 
                onClick={handleGoogleLogin}
                type="button"
                disabled={isLoading}
                className="w-full bg-white text-black font-bold py-3 rounded-xl hover:bg-zinc-200 transition-colors flex items-center justify-center gap-3"
            >
                <Chrome size={20} className="text-blue-600" />
                Sign in with Google
            </button>

            {/* Divider */}
            <div className="relative py-2">
                <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-zinc-800"></div></div>
                <div className="relative flex justify-center text-xs uppercase"><span className="bg-zinc-900 px-2 text-zinc-500">Or use password</span></div>
            </div>

            {/* Email/Password Form */}
            <form onSubmit={handleCredentialsLogin} className="space-y-3">
                <input 
                    type="email" 
                    placeholder="Email Address" 
                    className="w-full bg-black border border-zinc-700 p-4 rounded-xl text-white text-center focus:border-blue-500 outline-none transition-all"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    disabled={isLoading}
                    required
                />
                <input 
                    type="password" 
                    placeholder="App Password" 
                    className="w-full bg-black border border-zinc-700 p-4 rounded-xl text-white text-center focus:border-blue-500 outline-none transition-all"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    disabled={isLoading}
                    required
                />
                <button 
                    type="submit" 
                    disabled={isLoading || !email || !password}
                    className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-500 transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
                >
                    {isLoading ? <Loader2 className="animate-spin" size={20} /> : "Enter Deck"}
                </button>
            </form>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/components/dashboard/WorkflowProgress.tsx">
"use client";

import React, { useTransition } from 'react';
import Link from 'next/link';
import { 
  CheckCircle2, 
  ArrowRight, 
  Mic2, 
  Users, 
  SlidersHorizontal, 
  Calendar, 
  Megaphone, 
  CheckSquare, 
  Loader2 
} from 'lucide-react';
// Make sure this action exists in your app/lib/actions.ts!
import { markStepComplete } from '@/app/lib/actions'; 

export default function WorkflowProgress({ status }: any) {
  let [isPending, startTransition] = useTransition();

  const steps = [
    {
      id: 'auditions',
      label: 'Auditions',
      desc: 'Log auditionees',
      link: '/auditions',
      icon: <Mic2 size={16} />,
      isComplete: status.hasAuditions,
    },
    {
      id: 'callbacks',
      label: 'Callbacks',
      desc: 'Review talent',
      link: '/callbacks',
      icon: <Megaphone size={16} />,
      isComplete: status.hasCallbacks,
    },
    {
      id: 'casting',
      label: 'Casting',
      desc: 'Assign roles',
      link: '/casting',
      icon: <Users size={16} />,
      isComplete: status.hasCast,
    },
    {
      id: 'points',
      label: 'Calibration',
      desc: 'Set difficulty',
      link: '/analysis',
      icon: <SlidersHorizontal size={16} />,
      isComplete: status.hasPoints,
    },
    {
      id: 'schedule',
      label: 'Scheduling',
      desc: 'First rehearsal',
      link: '/schedule',
      icon: <Calendar size={16} />,
      isComplete: status.hasSchedule,
    }
  ];

  // Calculate Progress
  const completedCount = steps.filter(s => s.isComplete).length;
  const progressPercent = (completedCount / steps.length) * 100;
  
  // Find the "Active" step (first incomplete one)
  // If all are done, default to nothing or the last one
  const currentStepIndex = steps.findIndex(s => !s.isComplete);
  const currentStep = steps[currentStepIndex] || { label: "Production Active" };

  return (
    <div className="w-full bg-zinc-900 border border-white/10 rounded-xl p-6 mb-8 shadow-xl">
      
      {/* Header */}
      <div className="flex justify-between items-end mb-6">
        <div>
            <h2 className="text-lg font-black uppercase text-white tracking-wide">Production Roadmap</h2>
            <p className="text-zinc-400 text-sm mt-1">Current Phase: <span className="text-blue-400 font-bold">{currentStep.label}</span></p>
        </div>
        <div className="text-right">
            <div className="text-2xl font-black text-white">{Math.round(progressPercent)}%</div>
            <div className="text-[10px] uppercase font-bold text-zinc-500 tracking-wider">Setup Complete</div>
        </div>
      </div>

      {/* Progress Bar */}
      <div className="h-2 w-full bg-zinc-800 rounded-full mb-8 overflow-hidden">
         <div className="h-full bg-blue-600 transition-all duration-1000 ease-out" style={{ width: `${progressPercent}%` }} />
      </div>

      {/* Steps Grid */}
      <div className="grid grid-cols-2 md:grid-cols-5 gap-3 md:gap-4 relative">
         {/* Desktop Connector Line */}
         <div className="hidden md:block absolute top-6 left-10 right-10 h-0.5 bg-zinc-800 -z-10" />

         {steps.map((step, i) => {
            const isNext = !step.isComplete && (i === 0 || steps[i-1].isComplete);
            
            return (
                <div key={step.id} className="relative group h-full">
                    <Link 
                        href={step.link}
                        className={`flex flex-col items-center text-center p-3 md:p-4 rounded-xl transition-all border h-full ${
                            isNext 
                            ? 'bg-blue-600/10 border-blue-500/50 shadow-[0_0_20px_rgba(37,99,235,0.2)]' 
                            : 'bg-zinc-900 border-zinc-800 hover:border-zinc-700'
                        }`}
                    >
                        {/* Icon Bubble */}
                        <div className={`w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center mb-3 transition-colors ${
                            step.isComplete ? 'bg-emerald-500 text-white' : 
                            isNext ? 'bg-blue-600 text-white' : 'bg-zinc-800 text-zinc-500'
                        }`}>
                            {step.isComplete ? <CheckCircle2 size={20} /> : step.icon}
                        </div>

                        <h3 className={`text-xs md:text-sm font-bold ${step.isComplete ? 'text-zinc-400' : 'text-white'}`}>{step.label}</h3>
                        <p className="hidden md:block text-xs text-zinc-500 mt-1">{step.desc}</p>
                    </Link>

                    {/* üÜï THE "MARK DONE" BUTTONS */}
                    {isNext && (
                        <div className="absolute -bottom-3 left-1/2 -translate-x-1/2 flex gap-2 z-20">
                             {/* 1. Open Page Button */}
                             <Link 
                                href={step.link} 
                                className="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold px-3 py-1 rounded-full flex items-center gap-1 shadow-lg shadow-black/50 whitespace-nowrap transition-transform hover:scale-105"
                             >
                                Open <ArrowRight size={10} />
                            </Link>
                            
                            {/* 2. Manual Complete Button */}
                            <button 
                                onClick={(e) => {
                                    e.preventDefault(); // Stop link click if nested
                                    startTransition(() => markStepComplete(step.id));
                                }}
                                disabled={isPending}
                                className="bg-zinc-800 hover:bg-emerald-600 text-zinc-400 hover:text-white border border-zinc-600 hover:border-emerald-500 text-[10px] font-bold px-2 py-1 rounded-full flex items-center justify-center shadow-lg shadow-black/50 transition-all hover:scale-105"
                                title="Mark this step as done manually (Skip)"
                            >
                                {isPending ? <Loader2 size={12} className="animate-spin" /> : <CheckSquare size={12} />}
                            </button>
                        </div>
                    )}
                </div>
            )
         })}
      </div>
    </div>
  );
}
</file>

<file path="app/components/staff/StaffClient.tsx">
"use client";

import React, { useState, useMemo } from 'react';
import { 
  Search, User, Users, X,
  ShieldCheck, ClipboardCheck, CircleDollarSign,
  Check, AlertTriangle
} from 'lucide-react';

// --- üó∫Ô∏è CONFIGURATION ---
const LEGACY_MAP = {
  legal: { 
    title: "Legal & Safety", 
    forms: [
      { id: "medical", label: "Medical Release", key: "Medical" }, 
      { id: "liability", label: "Liability Waiver", key: "Liability" }, 
      { id: "photo", label: "Photo Release", key: "Photo" }
    ] 
  },
  financial: { 
    title: "Financials", 
    forms: [
      { id: "fee", label: "Production Fee", key: "Fee" }, 
      { id: "tickets", label: "Ticket Quota", key: "Tickets" } 
    ] 
  },
  production: { 
    title: "Production Ops", 
    forms: [
      { id: "bio", label: "Performer Bio", key: "Bio" }, 
      { id: "measurements", label: "Measurements", key: "Measurements" }
    ] 
  },
  family: { 
    title: "Family Commitment", 
    forms: [
      { id: "committee", label: "Committee Prefs", key: "Committee" }, 
    ] 
  }
};

export default function StaffClient({ productionTitle, assignments, people, compliance }: any) {
  const [filter, setFilter] = useState("");
  const [selectedMember, setSelectedMember] = useState<any>(null);
  
  // --- üß† REAL DATA ENGINE ---
  const roster = useMemo(() => {
    if (!Array.isArray(assignments)) return [];

    // 1. Create Lookup Maps
    const complianceMap = new Map();
    if (Array.isArray(compliance)) {
        compliance.forEach((row: any) => complianceMap.set(row.id.toString(), row));
    }
    
    // Helper to find headshot in raw Baserow data
    const getHeadshot = (row: any) => {
        if (!row) return null;
        // Try Common Field Names (Baserow user_field_names=true)
        const fileArr = row["Headshot"] || row["headshot"] || row["Avatar"] || row["Profile Picture"];
        // Try Schema ID if known (from your previous schema: field_5776)
        const fileArrById = row["field_5776"]; 
        
        const target = fileArr || fileArrById;
        if (Array.isArray(target) && target.length > 0) return target[0].url;
        return null;
    };

    const uniqueActors = new Map();

    assignments.forEach((a: any) => {
      const personId = a.personId?.toString();
      if (!personId) return;

      if (!uniqueActors.has(personId)) {
        // --- üîç DATA LOOKUP ---
        const rawPersonData = complianceMap.get(personId) || {};
        const peopleListMatch = people.find((p: any) => p.id.toString() === personId);
        
        // Helper: Check Lookup Arrays
        const hasSignature = (keyword: string) => {
           const docs = rawPersonData["Signed Doc Types"] || []; 
           if (!Array.isArray(docs)) return false;
           return docs.some((d: any) => d.value && d.value.includes(keyword));
        };

        const hasBio = () => {
           const bio = rawPersonData["Original Bio"]; 
           if (Array.isArray(bio) && bio.length > 0) return true;
           if (typeof bio === 'string' && bio.length > 10) return true;
           return false;
        };

        const hasMeasurements = () => {
            const m = rawPersonData["Measurements"];
            return Array.isArray(m) && m.length > 0;
        };
        
        // üì∏ IMAGE FIX: Try finding image in Compliance row OR People list
        const avatarUrl = getHeadshot(rawPersonData) || getHeadshot(peopleListMatch);

        uniqueActors.set(personId, {
          id: personId,
          name: a.personName || "Unknown Actor",
          roles: [a.name],
          avatar: avatarUrl, // <--- Using the robust helper
          
          // --- üèóÔ∏è AUDIT LOGIC ---
          audit: {
            medical: hasSignature("Medical"),
            liability: hasSignature("Liability"),
            photo: hasSignature("Photo"),
            fees: rawPersonData["Paid Fees"] === true,
            ticketsMet: false, 
            bio: hasBio(),
            measurements: hasMeasurements(),
            committee: Array.isArray(rawPersonData["Form Committee Preferences"]) && rawPersonData["Form Committee Preferences"].length > 0
          },
          ticketsSold: 0, 
          committeeName: "Unassigned", 
        });
      } else {
        const existing = uniqueActors.get(personId);
        if (!existing.roles.includes(a.name)) {
            existing.roles.push(a.name);
        }
      }
    });

    return Array.from(uniqueActors.values()).sort((a: any, b: any) => a.name.localeCompare(b.name));
  }, [assignments, people, compliance]);

  // Stats
  const stats = useMemo(() => {
    const total = roster.length || 1;
    const calc = (fn: (p: any) => boolean) => Math.round((roster.filter(fn).length / total) * 100);
    return {
      count: roster.length,
      legal: calc(p => p.audit.medical && p.audit.liability),
      prod: calc(p => p.audit.bio && p.audit.measurements),
      money: calc(p => p.audit.fees),
    };
  }, [roster]);

  return (
    <div className="flex flex-col h-full bg-zinc-950 text-white font-sans">
       
        {/* HEADER */}
        <header className="sticky top-0 z-20 h-20 border-b border-white/10 flex items-center justify-between px-8 bg-zinc-950/80 backdrop-blur-xl shrink-0">
            <div className="flex flex-col justify-center">
              <h1 className="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500 mb-1">Production Dashboard</h1>
              <h2 className="text-xl font-bold tracking-tighter truncate max-w-[300px] text-zinc-100">{productionTitle}</h2>
            </div>
            
            <div className="hidden xl:flex items-center gap-8">
               <HeaderStat label="Cast Size" value={stats.count} color="text-white" icon={<Users size={14}/>} />
               <HeaderStat label="Legal Compliance" value={`${stats.legal}%`} color={stats.legal === 100 ? "text-emerald-400" : "text-zinc-300"} icon={<ShieldCheck size={14}/>} />
               <HeaderStat label="Ops Readiness" value={`${stats.prod}%`} color="text-blue-400" icon={<ClipboardCheck size={14}/>} />
               <HeaderStat label="Fees Paid" value={`${stats.money}%`} color="text-amber-400" icon={<CircleDollarSign size={14}/>} />
            </div>

            <div className="relative w-64 ml-8">
              <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"/>
              <input 
                onChange={(e) => setFilter(e.target.value)} 
                placeholder="Search actor..." 
                className="w-full bg-black/40 border border-white/10 rounded-xl pl-10 pr-4 py-2 text-sm text-zinc-200 outline-none focus:border-blue-500 focus:bg-zinc-900 transition-all placeholder:text-zinc-600" 
              />
            </div>
        </header>

        {/* MAIN ROSTER GRID */}
        <main className="flex-1 overflow-y-auto custom-scrollbar p-8 bg-[radial-gradient(circle_at_20%_20%,rgba(24,24,27,1)_0%,rgba(9,9,11,1)_100%)]">
          {roster.length === 0 ? (
             <div className="h-full flex flex-col items-center justify-center text-zinc-500">
                <Users size={48} className="mb-4 opacity-20" />
                <p>No cast members found in this production.</p>
                <p className="text-xs mt-2">Check the &quot;Assignments&quot; table in Baserow.</p>
             </div>
          ) : (
            // üö® REMOVE OVERFLOW-HIDDEN FROM GRID PARENT IF IT EXISTS, 
            // BUT USUALLY THE ISSUE IS ON THE CARD ITSELF.
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-6 pb-20">
              {roster.filter((p: any) => p.name.toLowerCase().includes(filter.toLowerCase())).map((member: any) => (
                <div 
                  key={member.id} 
                  onClick={() => setSelectedMember(member)}
                  // üö® TOOLTIP FIX 1: Removed 'overflow-hidden'. Added 'hover:z-10' so hovered card is on top.
                  className="group bg-zinc-900/40 border border-white/5 rounded-2xl p-5 hover:border-white/20 hover:bg-zinc-900/60 transition-all cursor-pointer relative hover:z-10"
                >
                  {/* Status Bar Top */}
                  {/* üö® TOOLTIP FIX 2: Added rounded-t-2xl manually here since parent doesn't clip anymore */}
                  <div className="absolute top-0 left-0 w-full h-1 bg-white/5 rounded-t-2xl">
                    <div 
                        className={`h-full transition-all duration-1000 rounded-tl-2xl ${member.audit.medical && member.audit.liability ? 'bg-emerald-500' : 'bg-red-500'} ${member.audit.medical && member.audit.liability ? 'rounded-tr-2xl' : ''}`} 
                        style={{ width: member.audit.medical && member.audit.liability ? '100%' : '50%' }} 
                    />
                  </div>

                  <div className="flex justify-between items-start mb-4">
                    <div className="flex gap-4 min-w-0">
                      {/* Avatar */}
                      <div className="w-14 h-14 rounded-2xl bg-zinc-800 border border-white/5 overflow-hidden shadow-inner shrink-0 relative">
                        {member.avatar ? (
                            <img src={member.avatar} className="object-cover w-full h-full grayscale group-hover:grayscale-0 transition-all duration-500" />
                        ) : (
                            <div className="w-full h-full flex items-center justify-center text-zinc-700">
                                <User size={24}/>
                            </div>
                        )}
                      </div>

                      {/* Name & Role */}
                      <div className="min-w-0 pt-1">
                        <h3 className="font-bold text-lg text-zinc-100 truncate pr-2 group-hover:text-white transition-colors">{member.name}</h3>
                        <p className="text-[10px] text-zinc-500 font-black uppercase tracking-[0.1em] truncate">
                            {member.roles[0]} {member.roles.length > 1 && <span className="opacity-50">+{member.roles.length - 1}</span>}
                        </p>
                      </div>
                    </div>

                    {/* Quick Status Icons */}
                    <div className="flex flex-col gap-1.5 shrink-0 z-20">
                        <div className="flex gap-1 bg-black/40 p-1 rounded-lg border border-white/5">
                          <RichStatusIcon type="legal" member={member} />
                          <RichStatusIcon type="financial" member={member} />
                        </div>
                        <div className="flex gap-1 bg-black/40 p-1 rounded-lg border border-white/5">
                          <RichStatusIcon type="production" member={member} />
                          <RichStatusIcon type="family" member={member} />
                        </div>
                    </div>
                  </div>

                  {/* Footer Info */}
                  <div className="mt-2 flex justify-between items-end border-t border-white/5 pt-4">
                      <div className="flex flex-col">
                        <span className="text-[8px] font-black text-zinc-600 uppercase mb-1">Status</span>
                        <div className="flex gap-1">
                            {member.audit.medical ? (
                                <span className="text-[10px] text-emerald-500 bg-emerald-500/10 px-1.5 py-0.5 rounded border border-emerald-500/20">Cleared</span>
                            ) : (
                                <span className="text-[10px] text-red-500 bg-red-500/10 px-1.5 py-0.5 rounded border border-red-500/20">Missing Docs</span>
                            )}
                        </div>
                      </div>
                      
                      {member.audit.committee ? (
                         <div className="px-3 py-1 rounded-lg text-[10px] font-bold bg-zinc-800 text-zinc-400 border border-white/5">
                            Committee Set
                         </div>
                      ) : (
                         <div className="px-3 py-1 rounded-lg text-[10px] font-bold bg-red-500/10 text-red-500 border border-red-500/20 animate-pulse">
                            No Committee
                         </div>
                      )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </main>
      
      {/* üü¢ DRAWER COMPONENT */}
      {selectedMember && (
         <div className="fixed inset-0 z-50 flex justify-end">
            <div className="absolute inset-0 bg-black/80 backdrop-blur-md animate-in fade-in duration-300" onClick={() => setSelectedMember(null)} />
            <aside className="relative w-full max-w-md bg-zinc-900 border-l border-white/10 shadow-2xl p-8 flex flex-col animate-in slide-in-from-right duration-300">
               <button onClick={() => setSelectedMember(null)} className="absolute top-6 right-6 p-2 hover:bg-white/10 rounded-full text-zinc-400 hover:text-white transition-colors"><X/></button>
               
               <div className="flex items-center gap-4 mb-8">
                   <div className="w-16 h-16 rounded-2xl bg-zinc-800 overflow-hidden shadow-lg border border-white/10">
                        {selectedMember.avatar ? (
                            <img src={selectedMember.avatar} className="w-full h-full object-cover"/>
                        ) : <div className="w-full h-full flex items-center justify-center text-zinc-600"><User size={24}/></div>}
                   </div>
                   <div>
                       <h3 className="text-2xl font-black uppercase tracking-tighter text-white">{selectedMember.name}</h3>
                       <div className="flex flex-wrap gap-2 mt-2">
                           {selectedMember.roles.map((r: string) => (
                               <span key={r} className="text-[10px] font-bold bg-blue-600/20 text-blue-400 border border-blue-500/30 px-2 py-0.5 rounded-full uppercase tracking-wider">
                                   {r}
                               </span>
                           ))}
                       </div>
                   </div>
               </div>

               <div className="space-y-8 overflow-y-auto custom-scrollbar pr-2">
                  {Object.entries(LEGACY_MAP).map(([key, section]) => (
                    <div key={key}>
                      <h4 className="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-3 border-b border-white/10 pb-1 flex items-center gap-2">
                          {section.title}
                      </h4>
                      <div className="bg-white/5 rounded-xl overflow-hidden border border-white/5">
                          {section.forms.map((form) => {
                             const isDone = selectedMember.audit[form.id as keyof typeof selectedMember.audit];
                             return (
                               <div key={form.label} className="flex justify-between items-center px-4 py-3 border-b border-white/5 last:border-0 hover:bg-white/5 transition-colors">
                                 <span className="text-sm text-zinc-300 font-medium">{form.label}</span>
                                 {isDone ? (
                                     <div className="flex items-center gap-2 text-emerald-500">
                                         <span className="text-[10px] font-bold uppercase tracking-wider">Complete</span>
                                         <Check size={16}/>
                                     </div>
                                 ) : (
                                     <div className="flex items-center gap-2 text-red-500">
                                         <span className="text-[10px] font-bold uppercase tracking-wider">Missing</span>
                                         <AlertTriangle size={16}/>
                                     </div>
                                 )}
                               </div>
                             )
                          })}
                      </div>
                    </div>
                  ))}
               </div>
            </aside>
         </div>
      )}
    </div>
  );
}

// --- HELPER COMPONENTS ---

function RichStatusIcon({ type, member }: any) {
  const config = LEGACY_MAP[type as keyof typeof LEGACY_MAP];
  const icons = { 
    legal: <ShieldCheck size={12}/>, 
    financial: <CircleDollarSign size={12}/>, 
    production: <ClipboardCheck size={12}/>, 
    family: <Users size={12}/> 
  };
  
  // Status Logic
  let status = 'valid';
  const audit = member.audit;
  
  if ((type === 'legal' && (!audit.medical || !audit.liability)) || 
      (type === 'financial' && !audit.fees) || 
      (type === 'production' && (!audit.bio || !audit.measurements)) ||
      (type === 'family' && !audit.committee)) {
      status = 'emergency';
  }

  const colors = {
    emergency: "text-red-500 bg-red-500/10 border-red-500/40",
    valid: "text-emerald-500 bg-emerald-500/10 border-emerald-500/30",
  };

  return (
    <div className={`group/icon relative p-1.5 rounded-md border transition-all cursor-help hover:z-50 hover:scale-110 ${colors[status as keyof typeof colors]}`}>
      
      {icons[type as keyof typeof icons]}

      {/* TOOLTIP: FLIPPED TO BOTTOM */}
      {/* Changed 'bottom-full mb-2' to 'top-full mt-2' */}
      <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-48 bg-zinc-950/95 backdrop-blur-xl border border-white/10 rounded-xl shadow-[0_10px_40px_-10px_rgba(0,0,0,1)] opacity-0 group-hover/icon:opacity-100 transition-opacity pointer-events-none z-50 p-3">
        
        {/* Little Arrow pointing UP now */}
        <div className="absolute bottom-full left-1/2 -translate-x-1/2 -mb-px border-4 border-transparent border-b-zinc-950/95"></div>

        <div className="text-[9px] font-black uppercase text-zinc-500 tracking-widest mb-2 border-b border-white/10 pb-1">
            {config.title}
        </div>
        <div className="space-y-1.5">
            {config.forms.map((f: any) => {
                const isDone = member.audit[f.id];
                return (
                    <div key={f.label} className="flex justify-between items-center text-[10px] text-zinc-400">
                        <span>{f.label}</span> 
                        <div className={`w-1.5 h-1.5 rounded-full ${isDone ? 'bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.8)]' : 'bg-red-500 shadow-[0_0_5px_rgba(239,68,68,0.8)]'}`}/>
                    </div>
                )
            })}
        </div>
      </div>
    </div>
  );
}

function HeaderStat({ label, value, color, icon }: any) {
  return (
    <div className="flex items-center gap-3">
      <div className="p-2 bg-white/5 rounded-lg text-zinc-500 border border-white/5">{icon}</div>
      <div>
        <div className={`text-xl font-black leading-none ${color}`}>{value}</div>
        <div className="text-[9px] font-black uppercase text-zinc-600 tracking-wider mt-0.5">{label}</div>
      </div>
    </div>
  );
}
</file>

<file path="app/lib/permissions.ts">
export type Permission = 
  | 'view_financials' 
  | 'edit_compliance' 
  | 'view_sensitive_reports' 
  | 'manage_casting'
  | 'view_cast_list'
  | 'view_billing'
  | 'view_auditions'; // üëà Added this missing key

// 1. GLOBAL ROLES
const GLOBAL_ROLES: Record<string, Permission[]> = {
  // Aimee & Admins: See Everything
  'Executive Director': [
      'view_financials', 'edit_compliance', 'view_sensitive_reports', 
      'manage_casting', 'view_cast_list', 'view_billing', 'view_auditions'
  ],
  'Admin': [
      'view_financials', 'edit_compliance', 'view_sensitive_reports', 
      'manage_casting', 'view_cast_list', 'view_billing', 'view_auditions'
  ],

  // Krista: Money & Risk
  'Finance Manager': [
      'view_financials', 'view_billing', 'view_sensitive_reports'
  ],

  // Jenny: Logistics + Casting
  'Production Coordinator': [
      'edit_compliance', 'manage_casting', 'view_cast_list', 'view_sensitive_reports', 'view_auditions'
  ],
  
  // Elizabeth: Education + Casting Visibility
  'Education Coordinator': [
      'edit_compliance', 'view_cast_list', 'view_sensitive_reports', 'view_auditions'
  ],

  // Generic Staff
  'Staff': [
      'view_cast_list', 'manage_casting', 'edit_compliance', 'view_auditions'
  ], 
  
  // Parents
  'Parent/Guardian': ['view_billing']
};

// 2. PRODUCTION ROLES
const PRODUCTION_ROLES: Record<string, Permission[]> = {
  'Director': [
      'manage_casting', 'view_cast_list', 'view_sensitive_reports', 'view_auditions'
  ],
  'Music Director': [
      'manage_casting', 'view_cast_list', 'view_auditions'
  ],
  'Choreographer': [
      'manage_casting', 'view_cast_list', 'view_auditions'
  ],
  'Stage Manager': [
      'view_cast_list', 'edit_compliance', 'view_auditions'
  ],
  'Producer': [
      'view_financials', 'view_sensitive_reports', 'view_cast_list', 'edit_compliance', 'view_auditions'
  ]
};

export function hasPermission(
  globalRole: string, 
  productionRole: string | null, 
  permission: Permission
): boolean {
  const globalPerms = GLOBAL_ROLES[globalRole] || [];
  if (globalPerms.includes(permission)) return true;

  if (productionRole) {
    const prodPerms = PRODUCTION_ROLES[productionRole] || [];
    if (prodPerms.includes(permission)) return true;
  }

  return false;
}
</file>

<file path="auth.ts">
import NextAuth from "next-auth"
import Credentials from "next-auth/providers/credentials"
import Google from "next-auth/providers/google"
import { verifyUserCredentials, findUserByEmail } from "@/app/lib/baserow"

export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [
    // 1. Google One-Click
    Google({
      clientId: process.env.GOOGLE_CLIENT_ID,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET,
    }),
    // 2. Custom Password
    Credentials({
      name: "Casting Portal",
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) return null;
        // Verify against Baserow
        const user = await verifyUserCredentials(credentials.email as string, credentials.password as string);
        return user;
      }
    })
  ],
  callbacks: {
    // SECURITY GATE: Check if Google user exists in Baserow
    async signIn({ user, account }) {
      if (account?.provider === "google") {
        const baserowUser = await findUserByEmail(user.email || "");
        if (baserowUser) {
          // Attach Baserow ID/Role to the transient user object
          user.id = baserowUser.id;
          (user as any).role = baserowUser.role;
          return true; 
        }
        return false; // Deny access (Not in roster)
      }
      return true; // Credentials login is already verified in authorize()
    },
    // TOKEN: Persist the ID/Role from signIn into the Token
    async jwt({ token, user, account }) {
      if (user) {
        token.id = user.id;
        token.role = (user as any).role;
        // Double check Google role if needed
        if (account?.provider === "google" && !token.role) {
             const baserowUser = await findUserByEmail(user.email || "");
             if (baserowUser) token.role = baserowUser.role;
        }
      }
      return token;
    },
    // SESSION: Pass the ID/Role from Token to the Client
    async session({ session, token }) {
      if (session.user) {
        (session.user as any).id = token.id;
        (session.user as any).role = token.role;
      }
      return session;
    }
  },
pages: {
    signIn: '/login',
    signOut: '/login',
    error: '/login', // Error code will be passed as a query param
  },
  secret: process.env.NEXTAUTH_SECRET,
})
</file>

<file path="app/(main)/(casting)/casting/page.tsx">
import { auth } from "@/auth";
import { redirect } from "next/navigation";
import { 
  getActiveProduction, 
  fetchBaserow, 
  DB 
} from "@/app/lib/baserow"; 
import CastingClient from "@/app/components/casting/CastingClient";

// Helpers
const safeValue = (field: any) => field?.value || field || "";
const safeId = (field: any) => field?.[0]?.id || null;
const safeName = (field: any) => field?.[0]?.value || "";

export default async function CastingPage() {
  const session = await auth();
  if (!session) redirect("/login");

  const show = await getActiveProduction();
  
  if (!show) {
    return (
      <div className="p-12 text-center text-zinc-500">
        <h2 className="text-xl font-bold text-white">No Active Production</h2>
        <p>Please select a production in the global header.</p>
      </div>
    );
  }

  // 1. Fetch Data
  const [rawAssignments, rawRoles, rawAuditions, rawScenes] = await Promise.all([
     
     // A. ASSIGNMENTS
     fetchBaserow(`/database/rows/table/${DB.ASSIGNMENTS.ID}/`, {}, {
        [`filter__${DB.ASSIGNMENTS.FIELDS.PRODUCTION}__link_row_has`]: show.id,
        "user_field_names": "true"
     }),
     
     // B. ROLES (Using BLUEPRINT_ROLES)
     fetchBaserow(`/database/rows/table/${DB.BLUEPRINT_ROLES.ID}/`, {}, {
        "user_field_names": "true",
        "size": "200"
     }),
     
     // C. AUDITIONS
     fetchBaserow(`/database/rows/table/${DB.AUDITIONS.ID}/`, {}, {
        [`filter__${DB.AUDITIONS.FIELDS.PRODUCTION}__link_row_has`]: show.id,
        "user_field_names": "true"
     }),

     // D. SCENES
     fetchBaserow(`/database/rows/table/${DB.SCENES.ID}/`, {}, {
        [`filter__${DB.SCENES.FIELDS.PRODUCTION}__link_row_has`]: show.id,
        "user_field_names": "true"
     })
  ]);

  // 2. Transform Data using EXACT Schema Keys
  const assignments = rawAssignments.map((a: any) => ({
      id: a.id,
      // üü¢ Mapping 'Performance Identity'
      roleId: safeId(a[DB.ASSIGNMENTS.FIELDS.PERFORMANCE_IDENTITY]), 
      roleName: safeName(a[DB.ASSIGNMENTS.FIELDS.PERFORMANCE_IDENTITY]), 
      
      // üü¢ Mapping 'Person'
      studentId: safeId(a[DB.ASSIGNMENTS.FIELDS.PERSON]),
      studentName: safeName(a[DB.ASSIGNMENTS.FIELDS.PERSON]),
      
      // üü¢ Mapping 'Scene Assignments'
      sceneIds: a[DB.ASSIGNMENTS.FIELDS.SCENE_ASSIGNMENTS]?.map((s:any) => s.id) || []
  }));

  const roles = rawRoles.map((r: any) => ({
      id: r.id,
      name: r['Role Name'] || "Unknown Role", 
      category: safeValue(r['Role Type']), // Schema field 5792
      gender: "Any", // Blueprint Roles doesn't seem to have a Gender field in your schema, defaulting
      // üü¢ Mapping 'Active Scenes' from Blueprint
      defaultSceneIds: r['Active Scenes']?.map((s:any) => s.id) || [] 
  }));

  const scenes = rawScenes.map((s: any) => ({
      id: s.id,
      name: s['Scene Name'] || `Scene ${s.id}`
  }));

  const auditionees = rawAuditions.map((s: any) => ({
      id: s.id,
      // üü¢ Auditions table links to 'Performer' (field_6052)
      name: safeName(s[DB.AUDITIONS.FIELDS.PERFORMER]) || "Unknown Auditionee"
  }));

  const showStatus = typeof show.status === 'object' ? show.status?.value : show.status;

  return (
    <main className="h-full overflow-hidden">
      <CastingClient 
        assignments={assignments}
        roles={roles}
        auditionees={auditionees}
        scenes={scenes}
        activeId={show.id}
        showStatus={showStatus || "Pre-Production"} 
      />
    </main>
  );
}
</file>

<file path="app/components/casting/CastingClient.tsx">
"use client";

import React, { useState, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { 
  Search, Filter, ChevronDown, ChevronRight, 
  UserPlus, X, Check, Save, Layers,
  AlertCircle, Wand2, RefreshCw, Lock,
  AlertTriangle
} from 'lucide-react';
import { updateCastAssignment } from '@/app/lib/baserow'; 
import { generateCastingRows } from '@/app/actions/casting'; // Ensure you created this action

// --- TYPES ---
interface Role {
  id: number;
  name: string;
  category: string; // Lead, Supporting, Ensemble
  gender: string;
  defaultSceneIds: number[]; // The Blueprint Defaults
}

interface Assignment {
  id: number;
  roleId: number;
  roleName: string;
  studentId: number | null;
  studentName: string | null;
  sceneIds: number[]; // The specific scenes for THIS show
}

interface Auditionee {
  id: number;
  name: string;
}

interface Scene {
  id: number;
  name: string;
}

interface CastingClientProps {
  assignments: Assignment[];
  roles: Role[];
  auditionees: Auditionee[];
  scenes: Scene[];
  activeId: number; // Needed for the "Initialize" action
  showStatus: string; // e.g. "Pre-Production", "In Production", "Archived"
}

export default function CastingClient({ 
  assignments = [], 
  roles = [], 
  auditionees = [], 
  scenes = [],
  activeId,
  showStatus = "Pre-Production"
}: CastingClientProps) {
  
  const router = useRouter();
  const [localAssignments, setLocalAssignments] = useState<Assignment[]>(assignments);
  const [isSyncing, setIsSyncing] = useState<number | null>(null); // Track which row is updating
  const [isGenerating, setIsGenerating] = useState(false); // Track massive generation

  // 1. DEFINE THE LOCK STATE
  // If the show is running or over, we freeze the casting grid to preserve history.
  const isLocked = useMemo(() => {
      const lockedStatuses = ['In Production', 'Post-Production', 'Archived', 'Closed'];
      return lockedStatuses.includes(showStatus);
  }, [showStatus]);

  // 2. CRASH RECOVERY: INITIALIZE GRID
  const handleInitialize = async () => {
    if (!confirm("This will generate empty assignment rows for all Blueprint Roles. Continue?")) return;
    setIsGenerating(true);
    try {
      await generateCastingRows(activeId); 
      router.refresh(); 
    } catch (e) {
      alert("Failed to generate rows. Check console for details.");
      console.error(e);
    } finally {
      setIsGenerating(false);
    }
  };

  // 3. SCENE SYNC LOGIC (Fixes "0 Actors" Bug)
  const handleSyncScenes = async (assignmentId: number, roleId: number) => {
    if (isLocked) return; // Security Guard üõ°Ô∏è

    setIsSyncing(assignmentId);
    
    // A. Find the Blueprint Default Scenes
    const roleBlueprint = roles.find((r) => r.id === roleId);
    if (!roleBlueprint) {
        setIsSyncing(null);
        return; 
    }

    const defaultScenes = roleBlueprint.defaultSceneIds || [];

    // B. Optimistic Update
    setLocalAssignments(prev => prev.map(a => 
      a.id === assignmentId ? { ...a, sceneIds: defaultScenes } : a
    ));

    // C. Server Update
    try {
        await updateCastAssignment(assignmentId, null, defaultScenes); 
    } catch (e) {
        console.error("Sync failed", e);
    } finally {
        setIsSyncing(null);
    }
  };

  // 4. HELPER: Get Scene Names
  const getSceneNames = (ids: number[]) => {
      if(!ids || ids.length === 0) return <span className="text-zinc-600 italic">No Scenes Assigned</span>;
      
      const names = ids.map(id => {
          const s = scenes.find(sc => sc.id === id);
          return s ? s.name : null;
      }).filter(Boolean);

      return names.join(", ");
  };

  // --- RENDER: EMPTY STATE (CRASH RECOVERY) ---
  if (localAssignments.length === 0 && !isLocked) {
    return (
        <div className="h-full flex flex-col items-center justify-center bg-zinc-950 text-zinc-500 space-y-6">
            <div className="p-6 bg-zinc-900 rounded-full border border-zinc-800 shadow-2xl">
                <Wand2 size={48} className="text-zinc-700" />
            </div>
            <div className="text-center space-y-2">
                <h2 className="text-xl font-black text-white italic tracking-tighter">GRID EMPTY</h2>
                <p className="max-w-md mx-auto text-sm text-zinc-400">
                    No assignment rows found for this production. <br/>
                    The database may have been cleared or this is a new show.
                </p>
            </div>
            <button 
                onClick={handleInitialize}
                disabled={isGenerating}
                className="bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-3 rounded-xl font-bold uppercase tracking-widest flex items-center gap-3 transition-all hover:scale-105 active:scale-95 disabled:opacity-50 disabled:scale-100"
            >
                {isGenerating ? <RefreshCw className="animate-spin"/> : <Layers />}
                {isGenerating ? "Generating..." : "Initialize Grid from Roles"}
            </button>
        </div>
    );
  }

  // --- RENDER: MAIN GRID ---
  return (
    <div className="h-full flex flex-col bg-zinc-950 text-white relative">
      
      {/* LOCKED BANNER */}
      {isLocked && (
          <div className="bg-amber-900/20 border-b border-amber-500/20 px-4 py-2 flex items-center justify-center gap-3 text-[10px] font-bold uppercase tracking-widest text-amber-500 animate-in slide-in-from-top-2">
              <Lock size={12} /> 
              <span>Production Locked ‚Ä¢ Read-Only Mode</span>
          </div>
      )}

      {/* HEADER TOOLBAR */}
      <div className="h-16 border-b border-white/10 flex items-center justify-between px-6 shrink-0 bg-zinc-900/50 backdrop-blur-md sticky top-0 z-20">
        <div className="flex items-center gap-4">
            <h1 className="text-lg font-black italic tracking-tighter text-zinc-200">CASTING GRID</h1>
            <div className="hidden md:flex bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 items-center gap-2 text-xs text-zinc-400">
                <Filter size={14}/>
                <span>Filter: All Roles</span>
            </div>
        </div>
        
        {/* HIDE ACTION BUTTONS IF LOCKED */}
        {!isLocked && (
            <div className="flex items-center gap-4">
                <div className="text-xs text-zinc-500 font-mono hidden md:block">
                    {localAssignments.filter(a => a.studentId).length} / {localAssignments.length} Roles Filled
                </div>
                <button className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider flex items-center gap-2 transition-all shadow-lg shadow-emerald-900/20 active:scale-95">
                    <Save size={16}/> Publish
                </button>
            </div>
        )}
      </div>

      {/* GRID CONTENT */}
      <div className="flex-1 overflow-y-auto custom-scrollbar p-6">
        <div className="grid gap-2 max-w-7xl mx-auto">
            
            {/* TABLE HEADER */}
            <div className="hidden md:grid grid-cols-12 gap-4 px-4 py-2 text-[10px] font-black uppercase text-zinc-500 tracking-widest border-b border-white/5 mb-2">
                <div className="col-span-3">Role / Character</div>
                <div className="col-span-3">Cast Actor</div>
                <div className="col-span-5">Assigned Scenes</div>
                <div className="col-span-1 text-center">Sync</div>
            </div>

            {/* ROWS */}
            {localAssignments.map((assignment) => {
                const role = roles.find((r) => r.id === assignment.roleId);
                const assignedStudent = auditionees.find((s) => s.id === assignment.studentId);
                
                const hasScenes = assignment.sceneIds && assignment.sceneIds.length > 0;
                const hasBlueprintScenes = role?.defaultSceneIds && role.defaultSceneIds.length > 0;
                
                // Show warning if Role has scenes but Assignment is empty
                const needsSync = !hasScenes && hasBlueprintScenes;

                return (
                    <div key={assignment.id} className={`group grid grid-cols-1 md:grid-cols-12 gap-4 items-center px-4 py-3 rounded-xl transition-all border ${isLocked ? 'bg-zinc-900/20 border-white/5 opacity-75' : 'bg-zinc-900/40 border-white/5 hover:border-white/10 hover:bg-zinc-800/50'}`}>
                        
                        {/* 1. ROLE INFO */}
                        <div className="col-span-3 flex flex-col justify-center">
                            <div className="font-bold text-sm text-zinc-200">{assignment.roleName}</div>
                            <div className="text-[10px] text-zinc-500 uppercase font-bold tracking-wide flex items-center gap-2">
                                <span className={role?.category === 'Lead' ? 'text-amber-500' : 'text-zinc-500'}>{role?.category || "Ensemble"}</span>
                                <span className="text-zinc-700">‚Ä¢</span> 
                                <span>{role?.gender || "Any"}</span>
                            </div>
                        </div>

                        {/* 2. ACTOR SELECTOR */}
                        <div className="col-span-3">
                            {assignedStudent ? (
                                <div className={`flex items-center gap-3 p-1.5 pr-3 rounded-lg border ${isLocked ? 'bg-transparent border-transparent' : 'bg-zinc-950/50 border-white/5'}`}>
                                    <div className="w-6 h-6 rounded-full bg-zinc-800 flex items-center justify-center text-[10px] font-bold text-zinc-500 border border-white/5">
                                        {assignedStudent.name.charAt(0)}
                                    </div>
                                    <span className="text-xs font-bold text-emerald-400 truncate">{assignedStudent.name}</span>
                                    
                                    {!isLocked && (
                                        <button 
                                            className="ml-auto text-zinc-600 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100"
                                            onClick={() => {/* Remove Logic Would Go Here */}}
                                        >
                                            <X size={12}/>
                                        </button>
                                    )}
                                </div>
                            ) : (
                                isLocked ? (
                                    <span className="text-xs text-zinc-600 italic px-2">Unassigned</span>
                                ) : (
                                    <button className="flex items-center gap-2 text-xs text-zinc-500 hover:text-blue-400 transition-colors border border-dashed border-zinc-700 hover:border-blue-500/50 px-3 py-1.5 rounded-lg w-full group/btn">
                                        <UserPlus size={14} className="group-hover/btn:scale-110 transition-transform"/> 
                                        <span>Select Actor...</span>
                                    </button>
                                )
                            )}
                        </div>

                        {/* 3. SCENES (With Warning) */}
                        <div className="col-span-5 relative min-h-[1.5rem] flex items-center">
                            <div className={`text-xs leading-relaxed line-clamp-2 ${hasScenes ? 'text-zinc-400' : 'text-zinc-600 italic'}`}>
                                {getSceneNames(assignment.sceneIds)}
                            </div>
                            
                            {/* "Sync Required" Warning */}
                            {needsSync && !isLocked && (
                                <div className="hidden md:flex absolute right-0 top-1/2 -translate-y-1/2 items-center gap-2 animate-pulse">
                                    <span className="text-[9px] text-amber-500 font-bold uppercase tracking-wider bg-amber-500/10 border border-amber-500/20 px-2 py-0.5 rounded shadow-sm cursor-help" title="This actor is missing scene data found in the blueprint.">
                                        <AlertTriangle size={10} className="inline mr-1 mb-0.5"/>
                                        Sync Needed
                                    </span>
                                </div>
                            )}
                        </div>

                        {/* 4. ACTIONS (Sync Button) */}
                        <div className="col-span-1 flex justify-end md:justify-center">
                            {!isLocked && (
                                <button 
                                    onClick={() => handleSyncScenes(assignment.id, assignment.roleId)}
                                    disabled={isSyncing === assignment.id}
                                    className={`p-2 rounded-lg transition-all ${needsSync ? 'text-amber-500 bg-amber-500/10 hover:bg-amber-500 hover:text-white' : 'text-zinc-600 hover:text-blue-400 hover:bg-blue-500/10'}`}
                                    title="Reset Scenes to Blueprint Defaults"
                                >
                                    <RefreshCw size={16} className={isSyncing === assignment.id ? "animate-spin" : ""} />
                                </button>
                            )}
                        </div>

                    </div>
                );
            })}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/components/conflicts/ConflictsClient.tsx">
"use client";

import React, { useState, useMemo } from 'react';
import { Search, User, Calendar, X } from 'lucide-react';

// üü¢ FIX 2: Update the Interface to include 'actors'
interface Props {
  initialConflicts: any[];
  events: any[];
  showTitle: string;
  actors: { id: number; name: string }[]; // <--- ADD THIS LINE
}

export default function ConflictsClient({ initialConflicts, events, showTitle, actors }: Props) {
  
  const [selectedActorId, setSelectedActorId] = useState<number | null>(null);
  const [filterType, setFilterType] = useState<string>('all');

  // Filter Logic
  const filteredConflicts = useMemo(() => {
    return initialConflicts.filter(c => {
      const matchesActor = selectedActorId ? c.personId === selectedActorId : true;
      const matchesType = filterType === 'all' ? true : c.type.toLowerCase() === filterType.toLowerCase();
      return matchesActor && matchesType;
    });
  }, [initialConflicts, selectedActorId, filterType]);

  return (
    <div className="flex h-full">
      
      {/* SIDEBAR FILTERS */}
      <div className="w-64 border-r border-white/10 bg-zinc-900/30 overflow-y-auto custom-scrollbar p-4 space-y-8">
         
         {/* Type Filters */}
         <div>
            <h3 className="text-xs font-black text-zinc-500 uppercase tracking-widest mb-3">Conflict Type</h3>
            <div className="space-y-1">
                {['All', 'Absent', 'Late', 'Leave Early'].map(type => (
                    <button
                        key={type}
                        onClick={() => setFilterType(type.toLowerCase())}
                        className={`w-full text-left px-3 py-2 rounded text-xs font-bold transition-colors ${filterType === type.toLowerCase() ? 'bg-blue-600 text-white' : 'text-zinc-400 hover:bg-white/5'}`}
                    >
                        {type}
                    </button>
                ))}
            </div>
         </div>

         {/* Actor Filters */}
         <div>
            <div className="flex justify-between items-center mb-3">
                <h3 className="text-xs font-black text-zinc-500 uppercase tracking-widest">Filter by Actor</h3>
                {selectedActorId && (
                    <button onClick={() => setSelectedActorId(null)} className="text-[10px] text-blue-400 hover:text-blue-300">
                        Clear
                    </button>
                )}
            </div>
            
            <div className="space-y-1">
                {/* üü¢ USE THE NEW ACTORS PROP HERE */}
                {actors.map(actor => (
                    <button
                        key={actor.id}
                        onClick={() => setSelectedActorId(actor.id)}
                        className={`w-full text-left px-3 py-1.5 rounded text-xs transition-colors flex items-center gap-2 ${selectedActorId === actor.id ? 'bg-zinc-800 text-white border border-white/10' : 'text-zinc-500 hover:text-zinc-300'}`}
                    >
                        <User size={12} />
                        <span className="truncate">{actor.name}</span>
                    </button>
                ))}
            </div>
         </div>

      </div>

      {/* MAIN CONTENT AREA (The List) */}
      <div className="flex-1 overflow-y-auto custom-scrollbar p-8">
          {/* ... (Keep your existing Conflict List rendering code here) ... */}
          <div className="grid grid-cols-1 gap-4">
             {filteredConflicts.map(c => (
                 <div key={c.id} className="bg-zinc-900 border border-white/5 p-4 rounded-lg flex justify-between items-center">
                    <div className="flex items-center gap-4">
                        <div className={`w-2 h-12 rounded-full ${c.type === 'Absent' ? 'bg-red-500' : 'bg-amber-500'}`} />
                        <div>
                            <div className="font-bold text-white">{c.personName}</div>
                            <div className="text-xs text-zinc-400">{c.date} ‚Ä¢ {c.type}</div>
                        </div>
                    </div>
                    <div className="text-sm text-zinc-500 max-w-xs text-right truncate">
                        {c.notes || "No notes"}
                    </div>
                 </div>
             ))}
             
             {filteredConflicts.length === 0 && (
                <div className="text-center py-20 text-zinc-500">
                    No conflicts match these filters.
                </div>
             )}
          </div>
      </div>
    </div>
  );
}
</file>

<file path="app/components/production/ProductionClient.tsx">
"use client";

import React, { useMemo, useState } from 'react';
import { 
    Theater, Users, Image as ImageIcon, 
    Video, FileText, BarChart3, Palette, Box, Layers,
    ArrowUpRight, Target, CalendarClock, CheckCircle2,
    TrendingUp, AlertTriangle, LayoutGrid, Timer,
    Ruler, GraduationCap, Sparkles
} from 'lucide-react';

// --- CONSTANTS ---
const WEEKS_TOTAL = 10;
const CURRENT_WEEK = 4; // Mocking that we are in Week 4
const GOAL_WEEK_8 = 8;  // Super Saturday Target

export default function ProductionClient({ show, assignments, auditionees, scenes, assets, population = [] }: any) {
    const [activeTab, setActiveTab] = useState<'overview' | 'progress'>('overview');
    
    // Safety check
    if (!show) return <div className="h-screen flex items-center justify-center text-zinc-500 font-mono">Loading Show Data...</div>;

    return (
        <div className="flex flex-col h-full bg-zinc-950 text-white font-sans overflow-y-auto custom-scrollbar">
            
            {/* HEADER */}
            <header className="p-8 border-b border-white/10 bg-zinc-900/50 backdrop-blur-md sticky top-0 z-20">
                <div className="flex justify-between items-end">
                    <div className="flex items-center gap-4">
                        <div className="p-3 bg-purple-500/10 rounded-xl border border-purple-500/20 text-purple-400">
                            <Theater size={24} />
                        </div>
                        <div>
                            <div className="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500">Creative Control</div>
                            <h1 className="text-2xl font-black italic uppercase tracking-tighter text-white">{show.title}</h1>
                        </div>
                    </div>
                    
                    {/* TABS */}
                    <div className="flex bg-zinc-900 p-1 rounded-lg border border-white/5">
                        <button 
                            onClick={() => setActiveTab('overview')}
                            className={`px-4 py-2 rounded-md text-[10px] font-black uppercase transition-all ${activeTab === 'overview' ? 'bg-zinc-700 text-white shadow' : 'text-zinc-500 hover:text-white'}`}
                        >
                            Overview
                        </button>
                        <button 
                            onClick={() => setActiveTab('progress')}
                            className={`px-4 py-2 rounded-md text-[10px] font-black uppercase transition-all flex items-center gap-2 ${activeTab === 'progress' ? 'bg-blue-600 text-white shadow' : 'text-zinc-500 hover:text-white'}`}
                        >
                            <TrendingUp size={14}/> Progress
                        </button>
                    </div>
                </div>
            </header>

            <div className="p-8">
                {activeTab === 'overview' ? (
                    <OverviewView 
                        show={show}
                        assignments={assignments} 
                        population={population} 
                        scenes={scenes} 
                        assets={assets} 
                    />
                ) : (
                    <ProgressView scenes={scenes} />
                )}
            </div>
        </div>
    );
}

// ============================================================================
// 1. OVERVIEW TAB (Analytics & Assets)
// ============================================================================
function OverviewView({ assignments, population, scenes, assets }: any) {
    const [assetFilter, setAssetFilter] = useState("All");

    // --- LOGIC: CAST ANALYTICS ---
    const stats = useMemo(() => {
        // 1. Filter Population
        const activeIds = new Set(assignments.map((a:any) => a.personId).filter(Boolean));
        const activeCast = population.filter((p:any) => activeIds.has(p.id));
        
        const total = activeCast.length;

        // 2. Gender
        const males = activeCast.filter((p:any) => (p.gender || "").trim() === 'Male').length;
        const females = activeCast.filter((p:any) => (p.gender || "").trim() === 'Female').length;
        
        // 3. Experience
        const exp = { green: 0, journey: 0, pro: 0 };
        activeCast.forEach((p:any) => {
            const count = p.showCount || 0;
            if (count <= 2) exp.green++;
            else if (count <= 5) exp.journey++;
            else exp.pro++;
        });

        // 4. Age
        const validAges = activeCast.map((p:any) => p.age).filter((a:number) => a > 0);
        const avgAge = validAges.length ? (validAges.reduce((a:number,b:number)=>a+b,0) / validAges.length).toFixed(1) : "N/A";
        const minAge = validAges.length ? Math.min(...validAges) : 0;
        const maxAge = validAges.length ? Math.max(...validAges) : 0;

        // 5. Height (Converted to Feet/Inches)
        const validHeights = activeCast.map((p:any) => p.height).filter((h:number) => h > 0);
        let avgHeightStr = "N/A";
        
        if (validHeights.length > 0) {
            const avgInches = validHeights.reduce((a:number,b:number)=>a+b,0) / validHeights.length;
            const feet = Math.floor(avgInches / 12);
            const inches = Math.round(avgInches % 12);
            avgHeightStr = `${feet}' ${inches}"`;
        }

        return { total, males, females, exp, avgAge, minAge, maxAge, avgHeightStr };
    }, [assignments, population]);

    // --- LOGIC: ASSETS ---
    const filteredAssets = useMemo(() => {
        if (!assets) return [];
        return assetFilter === "All" ? assets : assets.filter((a:any) => a.type === assetFilter);
    }, [assets, assetFilter]);

    return (
        <div className="space-y-8 animate-in slide-in-from-right-8 duration-500">
             
             {/* ROW 1: THE BIG NUMBERS */}
             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                
                {/* 1. CAST COUNT */}
                <div className="bg-zinc-900 border border-white/5 rounded-3xl p-6 relative overflow-hidden group hover:border-white/10 transition-all">
                    <div className="absolute right-0 top-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity text-blue-500"><Users size={80}/></div>
                    <div className="text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-1">Total Cast</div>
                    <div className="text-4xl font-black text-white mb-3">{stats.total}</div>
                    
                    {/* Gender Bar */}
                    <div className="w-full h-1.5 bg-zinc-800 rounded-full flex overflow-hidden mb-2">
                        <div style={{ width: `${stats.total ? (stats.males / stats.total) * 100 : 0}%` }} className="bg-blue-500"/>
                        <div style={{ width: `${stats.total ? (stats.females / stats.total) * 100 : 0}%` }} className="bg-pink-500"/>
                    </div>
                    <div className="flex justify-between text-[9px] font-bold text-zinc-500 uppercase tracking-wider">
                        <span><span className="text-blue-400">{stats.males}</span> Male</span>
                        <span><span className="text-pink-400">{stats.females}</span> Fem</span>
                    </div>
                </div>

                {/* 2. EXPERIENCE LEVEL */}
                <div className="bg-zinc-900 border border-white/5 rounded-3xl p-6 relative overflow-hidden group hover:border-white/10 transition-all">
                    <div className="absolute right-0 top-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity text-amber-500"><Sparkles size={80}/></div>
                    <div className="text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-1">Experience</div>
                    <div className="flex items-center gap-4">
                         <div className="text-4xl font-black text-white">{stats.exp.pro}</div>
                         <div className="text-xs text-purple-400 font-bold uppercase leading-tight">Veterans<br/>(6+ Shows)</div>
                    </div>

                    <div className="mt-4 flex gap-1 h-12 items-end">
                        {/* Green Bar */}
                        <div className="flex-1 flex flex-col justify-end gap-1 group/bar">
                            <span className="text-[9px] font-bold text-emerald-500 text-center opacity-0 group-hover/bar:opacity-100 transition-opacity">{stats.exp.green}</span>
                            <div className="w-full bg-emerald-500/20 border-t border-emerald-500 rounded-sm hover:bg-emerald-500 transition-all" style={{ height: stats.total ? `${(stats.exp.green / stats.total) * 100}%` : '0%' }}></div>
                            <span className="text-[8px] font-black text-zinc-600 text-center uppercase">Green</span>
                        </div>
                        {/* Journey Bar */}
                        <div className="flex-1 flex flex-col justify-end gap-1 group/bar">
                            <span className="text-[9px] font-bold text-amber-500 text-center opacity-0 group-hover/bar:opacity-100 transition-opacity">{stats.exp.journey}</span>
                            <div className="w-full bg-amber-500/20 border-t border-amber-500 rounded-sm hover:bg-amber-500 transition-all" style={{ height: stats.total ? `${(stats.exp.journey / stats.total) * 100}%` : '0%' }}></div>
                            <span className="text-[8px] font-black text-zinc-600 text-center uppercase">Mid</span>
                        </div>
                        {/* Pro Bar */}
                        <div className="flex-1 flex flex-col justify-end gap-1 group/bar">
                            <span className="text-[9px] font-bold text-purple-500 text-center opacity-0 group-hover/bar:opacity-100 transition-opacity">{stats.exp.pro}</span>
                            <div className="w-full bg-purple-500/20 border-t border-purple-500 rounded-sm hover:bg-purple-500 transition-all" style={{ height: stats.total ? `${(stats.exp.pro / stats.total) * 100}%` : '0%' }}></div>
                            <span className="text-[8px] font-black text-zinc-600 text-center uppercase">Pro</span>
                        </div>
                    </div>
                </div>

                {/* 3. AGE SPECS */}
                <div className="bg-zinc-900 border border-white/5 rounded-3xl p-6 relative overflow-hidden group hover:border-white/10 transition-all">
                    <div className="absolute right-0 top-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity text-emerald-500"><GraduationCap size={80}/></div>
                    <div className="text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-1">Avg Age</div>
                    <div className="text-4xl font-black text-white mb-2">{stats.avgAge}</div>
                    <div className="flex gap-2 mt-4">
                        <div className="bg-zinc-950 rounded-lg px-3 py-2 border border-white/5 flex-1">
                            <div className="text-[9px] text-zinc-500 font-bold uppercase">Youngest</div>
                            <div className="text-lg font-bold text-white">{stats.minAge}</div>
                        </div>
                        <div className="bg-zinc-950 rounded-lg px-3 py-2 border border-white/5 flex-1">
                            <div className="text-[9px] text-zinc-500 font-bold uppercase">Oldest</div>
                            <div className="text-lg font-bold text-white">{stats.maxAge}</div>
                        </div>
                    </div>
                </div>

                {/* 4. HEIGHT SPECS (UPDATED) */}
                <div className="bg-zinc-900 border border-white/5 rounded-3xl p-6 relative overflow-hidden group hover:border-white/10 transition-all">
                    <div className="absolute right-0 top-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity text-pink-500"><Ruler size={80}/></div>
                    <div className="text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-1">Avg Height</div>
                    
                    {/* üö® FIX: Display Feet/Inches String */}
                    <div className="text-4xl font-black text-white mb-2">{stats.avgHeightStr}</div>
                    
                    <p className="text-xs text-zinc-500 mt-2 leading-relaxed">
                        Data collected from {stats.total} cast members.
                    </p>
                </div>
            </div>

            {/* ROW 2: ASSETS & SCENES */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                {/* 1. ASSET GRID (Design Hub) */}
                <div className="lg:col-span-3">
                     <div className="flex justify-between items-end mb-4">
                        <h2 className="text-xl font-black uppercase italic tracking-tighter text-white flex items-center gap-2">
                            <Palette size={20} className="text-pink-500"/> Design Hub
                        </h2>
                        <div className="flex bg-zinc-900 p-1 rounded-lg border border-white/5">
                            {['All', 'Image', 'PDF', 'Audio'].map(type => (
                                <button key={type} onClick={() => setAssetFilter(type)} className={`px-4 py-1.5 rounded-md text-[10px] font-black uppercase transition-all ${assetFilter === type ? 'bg-zinc-700 text-white shadow' : 'text-zinc-500 hover:text-white'}`}>{type}</button>
                            ))}
                        </div>
                    </div>
                    {filteredAssets.length === 0 ? (
                         <div className="w-full h-32 border-2 border-dashed border-zinc-800 rounded-3xl flex flex-col items-center justify-center text-zinc-600 gap-2">
                            <Box size={24} className="opacity-20"/>
                            <p className="text-xs font-bold uppercase">No Design Assets Uploaded</p>
                         </div>
                    ) : (
                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            {filteredAssets.map((asset: any) => {
                                const isImage = asset.type === 'Image' || (asset.link && asset.link.match(/\.(jpeg|jpg|gif|png)$/i));
                                return (
                                    <a key={asset.id} href={asset.link} target="_blank" className="group relative aspect-square bg-zinc-900 border border-white/10 rounded-2xl overflow-hidden hover:border-white/30 transition-all">
                                        {isImage ? <img src={asset.link} className="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity" /> : <div className="w-full h-full flex items-center justify-center text-zinc-600 group-hover:text-white transition-colors bg-zinc-800/50"><Box size={32}/></div>}
                                        <div className="absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black/90 to-transparent">
                                            <p className="text-xs font-bold text-white truncate">{asset.name}</p>
                                            <p className="text-[9px] font-black text-zinc-400 uppercase">{asset.type}</p>
                                        </div>
                                    </a>
                                )
                            })}
                        </div>
                    )}
                </div>

                {/* 2. SCENE LIST */}
                <div className="lg:col-span-3 bg-zinc-900 border border-white/5 rounded-3xl p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="text-sm font-black uppercase tracking-widest text-zinc-400 flex items-center gap-2">Show Structure</h3>
                        <span className="text-xs font-mono text-zinc-500 bg-zinc-950 border border-white/10 px-3 py-1 rounded-full">{scenes.length} Scenes</span>
                    </div>
                    <div className="grid grid-cols-2 gap-8">
                         {['Act 1', 'Act 2'].map(act => (
                            <div key={act}>
                                <h4 className="text-[10px] font-black uppercase text-zinc-500 mb-3 border-b border-white/10 pb-1">{act}</h4>
                                <div className="space-y-1">
                                    {scenes.filter((s:any) => {
                                        return s.act === act || (act === 'Act 1' && s.act === 'I') || (act === 'Act 2' && s.act === 'II');
                                    }).map((s:any) => (
                                        <div key={s.id} className="flex justify-between text-xs py-2 px-3 bg-zinc-950/50 border border-white/5 rounded-lg">
                                            <span className="font-bold text-zinc-300">{s.name}</span>
                                            <span className="text-[10px] font-black text-zinc-600 uppercase">{s.type}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                         ))}
                    </div>
                </div>
            </div>
        </div>
    )
}

// ============================================================================
// 2. PROGRESS TAB
// ============================================================================
function ProgressView({ scenes }: any) {
    const [progress, setProgress] = useState<Record<string, Record<string, number>>>(() => {
        const initial: any = {};
        scenes.forEach((s: any) => {
            initial[s.id] = {
                music: Math.random() > 0.5 ? 2 : 0, 
                dance: Math.random() > 0.7 ? 1 : 0,
                block: Math.random() > 0.3 ? 2 : 0,
            }
        });
        return initial;
    });

    const toggleStatus = (sceneId: string, type: 'music' | 'dance' | 'block') => {
        setProgress(prev => ({
            ...prev,
            [sceneId]: {
                ...prev[sceneId],
                [type]: (prev[sceneId][type] + 1) % 3
            }
        }));
    };

    const getStatusColor = (val: number) => {
        if (val === 2) return 'bg-emerald-500 border-emerald-400 text-white shadow-[0_0_10px_rgba(16,185,129,0.4)]'; 
        if (val === 1) return 'bg-amber-500 border-amber-400 text-black'; 
        return 'bg-zinc-800 border-zinc-700 text-zinc-500 opacity-50'; 
    };

    // --- CALCULATE PACE METRICS ---
    const metrics = useMemo(() => {
        let totalUnits = 0;
        let completedUnits = 0;

        scenes.forEach((s: any) => {
            const type = s.type;
            const hasMusic = type === 'Song' || type === 'Mixed' || type === 'Dance';
            const hasDance = type === 'Dance' || type === 'Mixed';
            const hasBlock = true; 

            if (hasMusic) totalUnits++;
            if (hasDance) totalUnits++;
            if (hasBlock) totalUnits++;

            const p = progress[s.id];
            if (hasMusic && p?.music === 2) completedUnits++;
            if (hasDance && p?.dance === 2) completedUnits++;
            if (hasBlock && p?.block === 2) completedUnits++;
        });

        const percentComplete = totalUnits > 0 ? Math.round((completedUnits / totalUnits) * 100) : 0;
        
        const velocity = completedUnits / (CURRENT_WEEK || 1); 
        const remainingUnits = totalUnits - completedUnits;
        const weeksNeeded = velocity > 0 ? remainingUnits / velocity : 99;
        const projectedFinishWeek = CURRENT_WEEK + weeksNeeded;
        
        const isOnTrack = projectedFinishWeek <= GOAL_WEEK_8;

        return { totalUnits, completedUnits, percentComplete, velocity, projectedFinishWeek, isOnTrack };
    }, [scenes, progress]);

    return (
        <div className="space-y-8 animate-in slide-in-from-right-8 duration-500">
            {/* 1. PACE DASHBOARD */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                {/* VELOCITY CARD */}
                <div className={`col-span-2 rounded-3xl p-8 border relative overflow-hidden ${metrics.isOnTrack ? 'bg-zinc-900 border-white/10' : 'bg-red-900/10 border-red-500/20'}`}>
                    <div className="flex justify-between items-start mb-6 relative z-10">
                        <div>
                            <h3 className="text-sm font-black uppercase tracking-widest text-zinc-400 flex items-center gap-2">
                                <Target size={16} className={metrics.isOnTrack ? "text-blue-500" : "text-red-500"}/> 
                                Burn-Up Projection
                            </h3>
                            <h2 className="text-4xl font-black text-white mt-2">
                                {metrics.percentComplete}% <span className="text-lg text-zinc-500 font-bold">Show Ready</span>
                            </h2>
                        </div>
                        <div className="text-right">
                             <div className={`px-4 py-2 rounded-xl text-xs font-black uppercase tracking-wider ${metrics.isOnTrack ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'bg-red-500/10 text-red-400 border border-red-500/20'}`}>
                                {metrics.isOnTrack ? "On Track" : "Behind Schedule"}
                             </div>
                        </div>
                    </div>

                    {/* Timeline Bar */}
                    <div className="relative h-12 bg-black/40 rounded-xl border border-white/5 flex items-center px-4 mb-2 z-10">
                        <div className="absolute left-0 top-0 bottom-0 bg-blue-600/20 rounded-l-xl transition-all duration-1000" style={{ width: `${(CURRENT_WEEK / WEEKS_TOTAL) * 100}%` }}></div>
                        <div className="w-full flex justify-between text-[10px] font-black uppercase text-zinc-500 relative z-20">
                            <span>Start</span>
                            <span className={CURRENT_WEEK >= 4 ? "text-white" : ""}>Wk 4 (Now)</span>
                            <span>Wk 8 (Goal)</span>
                            <span>Wk 10 (Show)</span>
                        </div>
                        <div 
                            className="absolute top-0 bottom-0 w-1 bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.8)] z-30 transition-all duration-1000"
                            style={{ left: `${Math.min((metrics.projectedFinishWeek / WEEKS_TOTAL) * 100, 100)}%` }}
                        />
                    </div>
                    <p className="text-xs text-zinc-500 text-center relative z-10">
                        At current pace ({metrics.velocity.toFixed(1)} items/wk), we finish in <strong>Week {Math.round(metrics.projectedFinishWeek)}</strong>.
                        {metrics.projectedFinishWeek > 8 && <span className="text-red-400 ml-2 font-bold"><AlertTriangle size={12} className="inline mb-0.5"/> Risk: Missing Costume Parade target.</span>}
                    </p>
                </div>

                {/* STATS CARD */}
                <div className="bg-zinc-900 border border-white/5 rounded-3xl p-8 flex flex-col justify-center gap-4">
                     <div className="flex justify-between items-center pb-4 border-b border-white/5">
                        <span className="text-xs font-bold text-zinc-500 uppercase">Items Cleared</span>
                        <span className="text-xl font-black text-white">{metrics.completedUnits} <span className="text-sm text-zinc-600">/ {metrics.totalUnits}</span></span>
                     </div>
                     <div className="flex justify-between items-center pb-4 border-b border-white/5">
                        <span className="text-xs font-bold text-zinc-500 uppercase">Current Velocity</span>
                        <span className="text-xl font-black text-blue-400">{metrics.velocity.toFixed(1)} <span className="text-[10px] text-zinc-600 font-bold uppercase">/ Wk</span></span>
                     </div>
                     <div className="flex justify-between items-center">
                        <span className="text-xs font-bold text-zinc-500 uppercase">Target Date</span>
                        <span className="text-xl font-black text-emerald-400">Week {GOAL_WEEK_8}</span>
                     </div>
                </div>
            </div>

            {/* 2. THE MATRIX */}
            <div className="bg-zinc-900 border border-white/5 rounded-3xl overflow-hidden shadow-2xl">
                <div className="p-6 border-b border-white/5 bg-zinc-900/80 backdrop-blur-xl flex justify-between items-center sticky top-0 z-30">
                    <h3 className="text-lg font-black uppercase italic text-white flex items-center gap-2">
                        <CalendarClock size={20} className="text-purple-500"/> Production Tracker
                    </h3>
                    <div className="flex gap-4 text-[10px] font-bold uppercase text-zinc-500">
                        <div className="flex items-center gap-1"><div className="w-2 h-2 bg-zinc-800 rounded-full"/> New</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 bg-amber-500 rounded-full"/> Draft</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 bg-emerald-500 rounded-full"/> Polished</div>
                    </div>
                </div>

                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-zinc-950 text-zinc-500 uppercase text-[10px] font-black tracking-widest border-b border-white/5">
                            <tr>
                                <th className="px-6 py-4 w-12">#</th>
                                <th className="px-6 py-4">Scene</th>
                                <th className="px-6 py-4 text-center w-32">Music</th>
                                <th className="px-6 py-4 text-center w-32">Dance</th>
                                <th className="px-6 py-4 text-center w-32">Block</th>
                                <th className="px-6 py-4 text-center w-24">Ready?</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-white/5">
                            {scenes.map((s: any, i: number) => {
                                const type = s.type;
                                const hasMusic = type === 'Song' || type === 'Mixed' || type === 'Dance';
                                const hasDance = type === 'Dance' || type === 'Mixed';
                                const p = progress[s.id] || { music: 0, dance: 0, block: 0 };
                                const isReady = (!hasMusic || p.music === 2) && (!hasDance || p.dance === 2) && (p.block === 2);

                                return (
                                    <tr key={s.id} className="hover:bg-white/5 transition-colors group">
                                        <td className="px-6 py-4 font-mono text-zinc-600">{i + 1}</td>
                                        <td className="px-6 py-4 font-bold text-zinc-300">
                                            {s.name}
                                            <span className="ml-2 text-[9px] font-normal text-zinc-600 border border-zinc-800 px-1.5 py-0.5 rounded uppercase">{type}</span>
                                        </td>
                                        
                                        <td className="px-6 py-4 text-center">
                                            {hasMusic ? (
                                                <button onClick={() => toggleStatus(s.id, 'music')} className={`w-full py-1.5 rounded text-[10px] font-black uppercase transition-all ${getStatusColor(p.music)}`}>
                                                    {p.music === 2 ? "Done" : p.music === 1 ? "Draft" : "-"}
                                                </button>
                                            ) : <span className="text-zinc-800 text-xs">-</span>}
                                        </td>

                                        <td className="px-6 py-4 text-center">
                                            {hasDance ? (
                                                <button onClick={() => toggleStatus(s.id, 'dance')} className={`w-full py-1.5 rounded text-[10px] font-black uppercase transition-all ${getStatusColor(p.dance)}`}>
                                                    {p.dance === 2 ? "Done" : p.dance === 1 ? "Draft" : "-"}
                                                </button>
                                            ) : <span className="text-zinc-800 text-xs">-</span>}
                                        </td>

                                        <td className="px-6 py-4 text-center">
                                            <button onClick={() => toggleStatus(s.id, 'block')} className={`w-full py-1.5 rounded text-[10px] font-black uppercase transition-all ${getStatusColor(p.block)}`}>
                                                {p.block === 2 ? "Done" : p.block === 1 ? "Draft" : "-"}
                                            </button>
                                        </td>

                                        <td className="px-6 py-4 text-center">
                                            {isReady ? <CheckCircle2 size={18} className="mx-auto text-emerald-500"/> : <div className="w-1.5 h-1.5 rounded-full bg-zinc-800 mx-auto"/>}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    )
}
</file>

<file path="app/components/StaffSidebar.tsx">
/* eslint-disable react-hooks/set-state-in-effect */
"use client";

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { 
  Users, Calendar, UserSquare2, 
  AlertOctagon, BarChart3, VenetianMask, 
  Settings, ChevronDown, ChevronRight,
  Mic2, Megaphone, LayoutGrid, GraduationCap,
  Home, Theater, Banknote, SlidersHorizontal 
} from 'lucide-react';
import { hasPermission } from '@/app/lib/permissions'; 
import { useSimulation } from '@/app/context/SimulationContext'; 

export default function StaffSidebar() {
  const pathname = usePathname();
  
  // üöÄ HOOK: Grab roles from the Simulation Context
  const { role: globalRole, productionRole, isSimulating } = useSimulation();

  const isCastingRoute = pathname.includes('/auditions') || pathname.includes('/callbacks') || pathname.includes('/casting');
  const [isCastingOpen, setCastingOpen] = useState(isCastingRoute);

  useEffect(() => {
    if (isCastingRoute) setCastingOpen(true);
  }, [pathname, isCastingRoute]);

  // --- PERMISSION CHECKS ---
  const canViewCasting   = hasPermission(globalRole, productionRole, 'view_auditions');
  const canManageCasting = hasPermission(globalRole, productionRole, 'manage_casting');
  const canViewLogistics = hasPermission(globalRole, productionRole, 'view_cast_list');
  const canViewBusiness  = hasPermission(globalRole, productionRole, 'view_financials');
  const canViewAcademy   = hasPermission(globalRole, productionRole, 'edit_compliance');

  return (
    <nav className={`w-64 bg-zinc-900 border-r border-white/5 flex flex-col h-full shrink-0 transition-colors duration-500 ${isSimulating ? 'border-red-500/30' : ''}`}>
      
      <Link href="/" className="h-16 flex items-center px-6 border-b border-white/5 mb-4 shrink-0 hover:bg-white/5 transition-colors group">
        <div className="flex flex-col">
            <h1 className="text-sm font-black tracking-tighter text-blue-500 group-hover:text-blue-400 transition-colors">
            OPEN<span className="text-white">BACKSTAGE</span>
            </h1>
            <span className="text-[9px] font-bold text-zinc-600 uppercase tracking-widest group-hover:text-zinc-500">
                {isSimulating ? <span className="text-red-500 animate-pulse">GOD MODE ACTIVE</span> : "Staff Portal"}
            </span>
        </div>
      </Link>

      <div className="flex-1 overflow-y-auto px-4 space-y-8 custom-scrollbar">
        
        <div className="space-y-1">
             <NavItem href="/" icon={<Home size={18}/>} label="Dashboard" active={pathname === '/'} />
        </div>

        {/* ZONE 1: CREATIVE TEAM */}
        {canViewLogistics && (
            <div className="animate-in slide-in-from-left-2 duration-300">
                <div className="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-2 px-2 flex items-center gap-2">
                    Creative Team
                </div>
                <div className="space-y-1">
                    <NavItem href="/production" icon={<Theater size={18}/>} label="Show Hub" active={pathname === '/production'} />
                    <NavItem href="/schedule" icon={<Calendar size={18}/>} label="Scheduler" active={pathname === '/schedule'} />
                    
                    {/* üÜï NEW: Calibration Link (Hidden for non-directors) */}
                    {canManageCasting && (
                       <NavItem 
                          href="/analysis" 
                          icon={<SlidersHorizontal size={18}/>} 
                          label="Show Calibration" 
                          active={pathname === '/analysis'} 
                       />
                    )}

                    {/* Casting Suite */}
                    {canViewCasting && (
                        <div>
                            <button 
                                onClick={() => setCastingOpen(!isCastingOpen)}
                                className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-xs font-bold transition-all ${isCastingRoute ? 'text-white' : 'text-zinc-400 hover:bg-white/5 hover:text-zinc-200'}`}
                            >
                                <div className="flex items-center gap-3">
                                    <Users size={18} className={isCastingRoute ? "text-purple-400" : "text-zinc-500"}/>
                                    <span>Casting Suite</span>
                                </div>
                                {isCastingOpen ? <ChevronDown size={14}/> : <ChevronRight size={14}/>}
                            </button>

                            {isCastingOpen && (
                                <div className="mt-1 ml-4 pl-4 border-l border-white/10 space-y-1 animate-in slide-in-from-left-2 duration-200">
                                    <SubNavItem href="/auditions" icon={<Mic2 size={14}/>} label="Auditions" active={pathname === '/auditions'} />
                                    {canManageCasting && (
                                        <>
                                            <SubNavItem href="/callbacks" icon={<Megaphone size={14}/>} label="Callbacks" active={pathname === '/callbacks'} />
                                            <SubNavItem href="/casting" icon={<LayoutGrid size={14}/>} label="Cast Grid" active={pathname === '/casting'} />
                                        </>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        )}

        {/* ZONE 2: LOGISTICS & OPS */}
        {canViewLogistics && (
            <div className="animate-in slide-in-from-left-2 duration-300 delay-75">
                <div className="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-2 px-2 flex items-center gap-2">
                    Logistics & Ops
                </div>
                <div className="space-y-1">
                    <NavItem href="/roster" icon={<UserSquare2 size={18}/>} label="Master Roster" active={pathname === '/roster'} />
                    <NavItem href="/conflicts" icon={<AlertOctagon size={18}/>} label="Conflict Matrix" active={pathname === '/conflicts'} />
                    <NavItem href="/committees" icon={<VenetianMask size={18}/>} label="Committees" active={pathname === '/committees'} />
                </div>
            </div>
        )}

        {/* ZONE 3: BUSINESS OFFICE */}
        {canViewBusiness && (
            <div className="animate-in slide-in-from-left-2 duration-300 delay-100">
                <div className="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-2 px-2 flex items-center gap-2">
                    Business Office
                </div>
                <div className="space-y-1">
                    <NavItem href="/reports" icon={<BarChart3 size={18}/>} label="Reports & Fees" active={pathname === '/reports'} />
                    <NavItem href="/analytics" icon={<Banknote size={18}/>} label="Show Analytics" active={pathname === '/analytics'} />
                </div>
            </div>
        )}

        {/* ZONE 4: ACADEMY */}
        {canViewAcademy && (
            <div className="animate-in slide-in-from-left-2 duration-300 delay-150">
                <div className="text-[10px] font-black text-pink-500 uppercase tracking-widest mb-2 px-2 flex items-center gap-2">
                    Academy
                </div>
                <div className="space-y-1">
                    <NavItem href="/education" icon={<GraduationCap size={18}/>} label="Class Manager" active={pathname === '/education'} />
                </div>
            </div>
        )}

      </div>

      <div className="p-4 border-t border-white/5">
        <NavItem href="/settings" icon={<Settings size={18}/>} label="System Settings" active={pathname === '/settings'} />
      </div>

    </nav>
  );
}

function NavItem({ href, icon, label, active }: any) {
    return (
        <Link 
            href={href} 
            className={`
                flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-bold transition-all
                ${active 
                    ? 'bg-zinc-800 text-white border border-white/5 shadow-sm' 
                    : 'text-zinc-400 hover:bg-white/5 hover:text-zinc-200 border border-transparent'}
            `}
        >
            {icon}
            {label}
        </Link>
    )
}

function SubNavItem({ href, icon, label, active }: any) {
    return (
        <Link 
            href={href} 
            className={`
                flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-all
                ${active 
                    ? 'text-white bg-white/5' 
                    : 'text-zinc-500 hover:text-zinc-300'}
            `}
        >
            {icon}
            {label}
        </Link>
    )
}
</file>

<file path="middleware.ts">
import { auth } from "@/auth"
import { NextResponse } from "next/server"

export default auth((req) => {
  const { nextUrl } = req
  const isLoggedIn = !!req.auth
  const isOnLoginPage = nextUrl.pathname.startsWith("/login")

  // 1. If trying to access protected routes while logged out
  if (!isLoggedIn && !isOnLoginPage) {
    // Construct the URL manually to be safe
    return NextResponse.redirect(new URL("/login", nextUrl.origin))
  }

  // 2. If logged in but trying to go to login page
  if (isLoggedIn && isOnLoginPage) {
    return NextResponse.redirect(new URL("/", nextUrl.origin))
  }

  return NextResponse.next()
})

export const config = {
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"],
}
</file>

<file path="app/(main)/(creative)/production/page.tsx">
import { getActiveProduction, getScenes, getCastDemographics } from '@/app/lib/baserow';
import DashboardClient from '@/app/components/dashboard/DashboardClient';
import WorkflowProgress from '@/app/components/dashboard/WorkflowProgress';
import { getAuditionees, getAssignments, getProductionEvents } from '@/app/lib/baserow';

export const dynamic = 'force-dynamic';

export default async function ProductionHubPage() {
  const production = await getActiveProduction();
  
  if (!production) return <div className="p-10 text-zinc-500">No Active Production</div>;

  // 1. Fetch Data in Parallel
  // We need scenes for the Tracker, demographics for the Overview, 
  // and the others for the Workflow Progress bar (optional, but nice to have here too)
  const [scenes, demographics, auditionees, assignments, events] = await Promise.all([
      getScenes(production.id),
      getCastDemographics(),
      getAuditionees(production.id),
      getAssignments(production.id),
      getProductionEvents(production.id)
  ]);

  // 2. Workflow Status Logic (Same as Dashboard)
  const hasOverride = (key: string) => {
     return production.workflowOverrides?.some((tag: any) => tag.value === key);
  };

  const workflowStatus = {
      hasAuditions: auditionees.length > 5 || hasOverride('Auditions'),
      hasCallbacks: assignments.length > 0 || hasOverride('Callbacks'), 
      hasCast: assignments.length > 0 || hasOverride('Casting'),
      hasPoints: scenes.some((s: any) => s.load && (s.load.music > 0 || s.load.dance > 0 || s.load.block > 0)) || hasOverride('Calibration'),
      hasSchedule: events.length > 0 || hasOverride('Scheduling')
  };

  return (
    <main className="p-8 bg-zinc-950 min-h-screen text-white pb-24">
      
      {/* HEADER */}
      <div className="flex justify-between items-center mb-8">
         <div>
            <h1 className="text-3xl font-black uppercase tracking-tight">{production.title} Production Hub</h1>
            <p className="text-zinc-400 text-sm mt-1">Real-time status tracking and analytics</p>
         </div>
      </div>

      {/* TRACKER TABS (The Core Feature) */}
      <DashboardClient 
        scenes={scenes} 
        demographics={demographics} 
      />
      
      {/* Optional: Add the Roadmap at the bottom as a footer context */}
      <div className="mt-12 pt-12 border-t border-white/5 opacity-50 hover:opacity-100 transition-opacity">
         <h3 className="text-xs font-bold uppercase text-zinc-500 mb-4 tracking-widest">Global Progress</h3>
         <WorkflowProgress status={workflowStatus} />
      </div>

    </main>
  );
}
</file>

<file path="app/(main)/education/page.tsx">
import { getClasses } from "@/app/lib/baserow";
import EducationGrid from "./EducationGrid"; // We will make this component below

export const dynamic = "force-dynamic";

export default async function EducationPage() {
  const classes = await getClasses();

  return (
    <div className="flex flex-col h-full bg-zinc-950 text-white overflow-hidden">
      <div className="p-8 border-b border-white/5 bg-zinc-900/30 shrink-0">
        <h1 className="text-3xl font-black uppercase italic tracking-tighter">Academy Manager</h1>
        <p className="text-zinc-400">Manage rosters, attendance, and enrollment.</p>
      </div>

      <div className="flex-1 overflow-y-auto p-8 custom-scrollbar">
         {/* Pass data to Client Component to handle Modals */}
         <EducationGrid classes={classes} />
      </div>
    </div>
  );
}
</file>

<file path="app/components/settings/SettingsClient.tsx">
/* eslint-disable react-hooks/set-state-in-effect */
"use client";

import React, { useState, useEffect, useCallback } from 'react';
import { 
  User, Shield, Monitor, Lock, 
  LogOut, Mail, Fingerprint, 
  CheckCircle2, Users,
  CreditCard, ChevronRight, History, Phone, MapPin
} from 'lucide-react';
import { switchProduction } from '@/app/actions';
import { signOut } from "next-auth/react";
import { hasPermission, Permission } from '@/app/lib/permissions'; 
import { useSimulation } from '@/app/context/SimulationContext'; 

// --- Types (Same as before) ---
export interface FamilyMember {
  id: number;
  name: string;
  role: string;
  age: number;
  image: string | null;
}

export interface UserProfile {
  name: string;
  email: string;
  phone: string;
  role: string;
  id: string;
  address: string;
  familyMembers: FamilyMember[];
}

interface SettingsProps {
  shows: any[];
  activeId: number;
  initialUser: UserProfile;
  realProductionRole: string | null; 
}

export default function SettingsClient({ shows, activeId, initialUser, realProductionRole }: SettingsProps) {
  const [activeTab, setActiveTab] = useState('profile');
  
  const { 
    role: effectiveGlobalRole, 
    productionRole: effectiveProdRole, 
    simulate, 
    reset, 
    isSimulating 
  } = useSimulation();
  
  const activeShow = shows.find(s => s.id === activeId) || shows[0];

  // 1. FIX: Wrap in useCallback so it's stable and can be a dependency
  const checkAccess = useCallback((perm: Permission) => {
    const granted = hasPermission(effectiveGlobalRole, effectiveProdRole, perm);
    return {
      granted,
      level: granted ? (perm.includes('edit') || perm.includes('manage') ? 'write' : 'read') : 'locked'
    };
  }, [effectiveGlobalRole, effectiveProdRole]);

  // 2. FIX: Calculate "Safe Tab" DURING render (prevents cascading updates)
  // This logic runs before the UI paints. If the current tab is forbidden,
  // we default to 'profile' immediately for this render cycle.
  const canSeeBilling = checkAccess('view_billing').granted;
  const canSeeSystem = checkAccess('view_cast_list').granted;

  let safeTab = activeTab;
  if (activeTab === 'billing' && !canSeeBilling) safeTab = 'profile';
  if ((activeTab === 'permissions' || activeTab === 'context') && !canSeeSystem) safeTab = 'profile';

  // 3. Sync State (Optional cleanup)
  // If we had to force a safe tab, update the state for next time
  useEffect(() => {
    if (safeTab !== activeTab) {
        setActiveTab(safeTab);
    }
  }, [safeTab, activeTab]);

  return (
    <div className="flex flex-col lg:flex-row gap-6 h-full max-w-7xl mx-auto w-full relative">
        
        {/* INNER SIDEBAR NAVIGATION */}
        <nav className="w-full lg:w-64 flex flex-col gap-1 shrink-0">
            <div className="px-4 py-4 mb-2">
                <h1 className="text-xl font-black italic tracking-tighter text-white">SETTINGS</h1>
                <p className="text-xs text-zinc-500 font-medium">Manage your backstage identity</p>
            </div>

            <div className="space-y-1">
                <p className="px-4 text-[10px] font-bold uppercase text-zinc-600 tracking-widest mt-4 mb-2">Account</p>
                {/* USE safeTab INSTEAD OF activeTab */}
                <TabButton id="profile" label="My Profile" icon={<User size={18}/>} active={safeTab} onClick={setActiveTab} />
                <TabButton id="family" label="Family Members" icon={<Users size={18}/>} active={safeTab} onClick={setActiveTab} />
                
                {checkAccess('view_billing').granted && (
                    <TabButton id="billing" label="Billing & Donations" icon={<CreditCard size={18}/>} active={safeTab} onClick={setActiveTab} />
                )}
            </div>

            {checkAccess('view_cast_list').granted && (
                <div className="space-y-1 animate-in slide-in-from-left-2 fade-in duration-300">
                    <p className="px-4 text-[10px] font-bold uppercase text-zinc-600 tracking-widest mt-6 mb-2">System</p>
                    <TabButton id="context" label="Workspace Context" icon={<Monitor size={18}/>} active={safeTab} onClick={setActiveTab} />
                    <TabButton id="permissions" label="Permissions (RBAC)" icon={<Shield size={18}/>} active={safeTab} onClick={setActiveTab} />
                </div>
            )}
            
            <div className="mt-auto pt-6 px-4">
                <button 
                    onClick={() => signOut({ callbackUrl: '/' })}
                    className="flex items-center gap-3 px-4 py-3 rounded-xl text-xs font-bold text-red-400 bg-red-500/5 hover:bg-red-500/10 border border-red-500/10 transition-all w-full text-left"
                >
                    <LogOut size={16}/> Sign Out
                </button>
            </div>
        </nav>

        {/* MAIN CONTENT AREA */}
        <div className="flex-1 min-h-[600px] bg-zinc-900/50 border border-white/5 rounded-3xl p-8 overflow-y-auto custom-scrollbar relative">
            
            {/* RENDER BASED ON safeTab */}
            {safeTab === 'profile' && (
                <div className="space-y-8 animate-in fade-in slide-in-from-right-4 duration-300">
                    <div className="flex items-start justify-between">
                        <div>
                            <h2 className="text-2xl font-black uppercase italic tracking-tighter text-white">Profile & Contact</h2>
                            <p className="text-zinc-500 text-sm">Manage your personal contact information.</p>
                        </div>
                        <div className="px-3 py-1 bg-blue-600/20 border border-blue-500/30 text-blue-400 text-xs font-bold rounded-full uppercase tracking-wide">
                            {initialUser.role} 
                        </div>
                    </div>

                    <div className="flex items-center gap-6 pb-8 border-b border-white/5">
                        <div className="w-24 h-24 rounded-2xl bg-zinc-800 border border-white/10 flex items-center justify-center text-3xl font-black text-zinc-700 shadow-2xl relative overflow-hidden">
                            {initialUser.name ? (
                                initialUser.name.split(' ').map((n:string) => n[0]).join('').substring(0, 2).toUpperCase()
                            ) : 'AF'}
                        </div>
                        <div className="space-y-2">
                            <button className="px-4 py-2 bg-white text-black text-xs font-bold rounded-lg hover:bg-zinc-200 transition-colors">
                                Upload New Photo
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <InputGroup label="Full Name" value={initialUser.name} icon={<User size={16}/>} />
                        <InputGroup label="Email Address" value={initialUser.email} icon={<Mail size={16}/>} disabled />
                        <InputGroup label="Phone Number" value={initialUser.phone} icon={<Phone size={16}/>} />
                        <div className="md:col-span-2">
                             <InputGroup label="Mailing Address" value={initialUser.address} icon={<MapPin size={16}/>} />
                        </div>
                    </div>
                </div>
            )}

            {safeTab === 'family' && (
                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-300">
                    <div className="flex justify-between items-end">
                        <div>
                            <h2 className="text-2xl font-black uppercase italic tracking-tighter text-white">Family Members</h2>
                            <p className="text-zinc-500 text-sm">Manage dependants and medical forms.</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 gap-4">
                        {initialUser.familyMembers.length === 0 ? (
                             <div className="p-8 border border-dashed border-zinc-800 rounded-xl text-center text-zinc-500 text-sm">
                                No family members linked to your account.
                             </div>
                        ) : (
                            initialUser.familyMembers.map((member) => (
                                <div key={member.id} className="group p-4 bg-black/20 hover:bg-black/40 border border-white/5 hover:border-white/10 rounded-xl transition-all flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                        <div className="w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center text-sm font-bold text-zinc-400 overflow-hidden relative border border-white/5">
                                            {member.image ? <img src={member.image} alt={member.name} className="w-full h-full object-cover" /> : member.name.charAt(0)}
                                        </div>
                                        <div>
                                            <h3 className="text-white font-bold text-sm">{member.name}</h3>
                                            <p className="text-xs text-zinc-500">{member.role} ‚Ä¢ {member.age} yrs old</p>
                                        </div>
                                    </div>
                                    <button className="p-2 hover:bg-zinc-800 rounded-lg text-zinc-400 hover:text-white">
                                        <ChevronRight size={16} />
                                    </button>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            )}

            {safeTab === 'context' && (
                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-300">
                    <div>
                        <h2 className="text-2xl font-black uppercase italic tracking-tighter text-white">Workspace Context</h2>
                        <p className="text-zinc-500 text-sm">Select active production.</p>
                    </div>
                    <div className="grid grid-cols-1 gap-3">
                        {shows.map((show) => (
                            <form key={show.id} action={switchProduction}>
                                <input type="hidden" name="productionId" value={show.id} />
                                <input type="hidden" name="redirectPath" value="/settings" />
                                <button className={`w-full group relative overflow-hidden flex items-center justify-between p-4 rounded-xl border transition-all ${activeId === show.id ? 'bg-emerald-900/10 border-emerald-500/50' : 'bg-black/20 border-white/5 hover:bg-black/40 hover:border-white/10'}`}>
                                    <div className="flex items-center gap-4 z-10">
                                        <div className={`w-12 h-12 rounded-lg flex items-center justify-center text-lg font-black ${activeId === show.id ? 'bg-emerald-500 text-white' : 'bg-zinc-800 text-zinc-600'}`}>
                                            {show.title.charAt(0)}
                                        </div>
                                        <div className="text-left">
                                            <div className={`text-sm font-bold ${activeId === show.id ? 'text-white' : 'text-zinc-300'}`}>{show.title}</div>
                                            <div className="text-xs font-medium text-zinc-500">{show.location}</div>
                                        </div>
                                    </div>
                                    {activeId === show.id && <div className="flex items-center gap-2 text-emerald-500 text-xs font-bold uppercase tracking-widest z-10"><CheckCircle2 size={16}/> Active</div>}
                                </button>
                            </form>
                        ))}
                    </div>
                </div>
            )}

            {safeTab === 'permissions' && (
                <div className="space-y-8 animate-in fade-in slide-in-from-right-4 duration-300">
                    <div>
                        <h2 className="text-2xl font-black uppercase italic tracking-tighter text-white">Security Clearance</h2>
                        <p className="text-zinc-500 text-sm mb-4">
                            Your access level for <span className="text-white font-bold">{activeShow?.title}</span>.
                        </p>
                        
                        <div className="bg-zinc-900 border border-white/10 p-4 rounded-xl flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-blue-600/10 rounded-lg text-blue-400">
                                    <Shield size={20} />
                                </div>
                                <div>
                                    <h4 className="text-sm font-bold text-white">
                                        Global Role: {effectiveGlobalRole}
                                        {effectiveGlobalRole !== initialUser.role && <span className="text-red-400 ml-2 text-xs uppercase">(Simulated)</span>}
                                    </h4>
                                    <p className="text-xs text-zinc-500">
                                        Show Role: {effectiveProdRole || "None"}
                                        {effectiveProdRole !== realProductionRole && <span className="text-red-400 ml-2 uppercase">(Simulated)</span>}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 gap-6">
                        <PermissionSection 
                            title="Production Management" 
                            permissions={[
                                { label: "Cast Grid Access", desc: "View master cast list.", ...checkAccess('view_cast_list') },
                                { label: "Casting Management", desc: "Modify roles and assignments.", ...checkAccess('manage_casting') },
                                { label: "Compliance Data", desc: "Access medical forms.", ...checkAccess('edit_compliance') },
                            ]}
                        />
                        
                        <PermissionSection 
                            title="Financials & Sensitive Data" 
                            permissions={[
                                { label: "Budget Reports", desc: "View production budget.", ...checkAccess('view_financials') },
                                { label: "Billing & Invoices", desc: "View personal billing history.", ...checkAccess('view_billing') },
                                { label: "Sensitive Reports", desc: "View incident reports.", ...checkAccess('view_sensitive_reports') },
                            ]}
                        />
                    </div>
                </div>
            )}

            {safeTab === 'billing' && (
                <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-300">
                     <div className="flex justify-between items-end">
                        <div>
                            <h2 className="text-2xl font-black uppercase italic tracking-tighter text-white">Billing & Donations</h2>
                            <p className="text-zinc-500 text-sm">Manage payment methods.</p>
                        </div>
                    </div>
                     <div className="p-12 border border-dashed border-zinc-800 bg-black/20 rounded-2xl flex flex-col items-center justify-center text-center">
                        <CreditCard size={48} className="text-zinc-700 mb-4" />
                        <h3 className="text-zinc-400 font-bold mb-2">No Payment Methods</h3>
                        <button className="px-5 py-2.5 bg-zinc-800 hover:bg-zinc-700 text-white text-xs font-bold rounded-lg border border-white/5">
                            Add Payment Method
                        </button>
                     </div>
                </div>
            )}

        </div>

        {/* 3. THE DEV WIDGET (GOD MODE) */}
        {['Admin', 'Executive Director'].includes(initialUser.role) && (
            <div className="fixed bottom-6 right-6 z-50 animate-in slide-in-from-bottom-10">
                <div className="bg-zinc-950 border border-red-500/30 shadow-2xl rounded-xl p-4 w-72 backdrop-blur-md">
                    <div className="flex items-center gap-2 mb-3 text-red-400 border-b border-white/5 pb-2">
                        <Shield size={14} />
                        <span className="text-[10px] font-black uppercase tracking-widest">God Mode</span>
                        <button 
                            onClick={reset}
                            className="ml-auto text-[9px] underline text-zinc-500 hover:text-white"
                        >
                            Reset
                        </button>
                    </div>

                    <div className="space-y-3">
                        <div>
                            <label className="text-[9px] font-bold text-zinc-500 uppercase block mb-1">Simulate Global Role</label>
                            <select 
                                className="w-full bg-zinc-900 border border-white/10 rounded px-2 py-1 text-xs text-white"
                                value={isSimulating ? effectiveGlobalRole : ""}
                                onChange={(e) => simulate(e.target.value || null, effectiveProdRole)}
                            >
                                <option value="">Real ({initialUser.role})</option>
                                <option value="Executive Director">Executive Director (You)</option>
                                <option value="Finance Manager">Finance Manager</option>
                                <option value="Production Coordinator">Prod. Coordinator</option>
                                <option value="Staff">Generic Staff</option>
                                <option value="Contractor">Contractor</option>
                                <option value="Parent/Guardian">Parent</option>
                            </select>
                        </div>

                        <div>
                            <label className="text-[9px] font-bold text-zinc-500 uppercase block mb-1">Simulate Show Role</label>
                            <select 
                                className="w-full bg-zinc-900 border border-white/10 rounded px-2 py-1 text-xs text-white"
                                value={effectiveProdRole || ""}
                                onChange={(e) => simulate(effectiveGlobalRole === initialUser.role ? null : effectiveGlobalRole, e.target.value || null)}
                            >
                                <option value="">Real ({realProductionRole || "None"})</option>
                                <option value="Director">Director</option>
                                <option value="Choreographer">Choreographer</option>
                                <option value="Stage Manager">Stage Manager</option>
                                <option value="Producer">Producer</option>
                                <option value="None">None (Standard)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div className="mt-3 pt-3 border-t border-white/5 flex gap-2">
                        <div className={`h-2 w-2 rounded-full mt-0.5 ${checkAccess('view_financials').granted ? 'bg-emerald-500' : 'bg-red-500'}`} />
                        <div className="text-[10px] text-zinc-400">
                            {checkAccess('view_financials').granted ? "Can See Money" : "Cannot See Money"}
                        </div>
                    </div>
                </div>
            </div>
        )}

    </div>
  );
}

// --- SUB-COMPONENTS ---
function TabButton({ id, label, icon, active, onClick }: any) {
    const isActive = active === id;
    return (
        <button 
            onClick={() => onClick(id)}
            className={`
                group flex items-center gap-3 px-4 py-2.5 rounded-lg text-xs font-bold transition-all w-full text-left relative overflow-hidden
                ${isActive ? 'text-white bg-zinc-800' : 'text-zinc-500 hover:bg-zinc-800/50 hover:text-zinc-300'}
            `}
        >
            {isActive && <div className="absolute left-0 top-0 bottom-0 w-1 bg-blue-500 rounded-r-full" />}
            <span className={`${isActive ? 'text-blue-400' : 'group-hover:text-zinc-400'}`}>{icon}</span>
            {label}
        </button>
    )
}

function InputGroup({ label, value, icon, disabled }: any) {
    return (
        <div className="group">
            <label className="block text-[10px] font-bold uppercase text-zinc-500 tracking-widest mb-2">{label}</label>
            <div className={`
                flex items-center gap-3 px-4 py-3 rounded-xl border transition-all
                ${disabled 
                    ? 'bg-zinc-900/30 border-white/5 text-zinc-600 cursor-not-allowed' 
                    : 'bg-black/20 border-white/10 text-white group-hover:border-white/20 focus-within:border-blue-500/50 focus-within:bg-black/40'}
            `}>
                <div className={`${disabled ? 'text-zinc-700' : 'text-zinc-500'}`}>{icon}</div>
                <input 
                    defaultValue={value} 
                    disabled={disabled}
                    readOnly={disabled}
                    className="bg-transparent outline-none w-full text-sm font-medium placeholder-zinc-700"
                />
                {disabled && <Lock size={12} className="text-zinc-700"/>}
            </div>
        </div>
    )
}

function PermissionSection({ title, permissions }: { title: string, permissions: any[] }) {
    return (
        <div>
            <h3 className="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-3 border-b border-white/5 pb-2">{title}</h3>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                {permissions.map((p: any, i: number) => (
                    <div key={i} className={`p-4 rounded-xl border flex items-start gap-4 ${p.granted ? 'bg-zinc-900/80 border-white/10' : 'bg-transparent border-white/5 opacity-50'}`}>
                        <div className={`mt-0.5 ${p.granted ? 'text-emerald-500' : 'text-zinc-600'}`}>
                            {p.granted ? <CheckCircle2 size={18}/> : <Lock size={18}/>}
                        </div>
                        <div className="flex-1">
                            <div className="flex justify-between items-center mb-1">
                                <h4 className={`text-sm font-bold ${p.granted ? 'text-white' : 'text-zinc-500'}`}>{p.label}</h4>
                                {p.granted && (
                                    <span className="text-[10px] uppercase font-bold bg-zinc-800 text-zinc-400 px-2 py-0.5 rounded border border-white/5">
                                        {p.level}
                                    </span>
                                )}
                            </div>
                            <p className="text-xs text-zinc-500 leading-snug">{p.desc}</p>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    )
}
</file>

<file path="app/(main)/settings/page.tsx">
import { auth } from "@/auth";
import { redirect } from "next/navigation";
import { cookies } from "next/headers";
import { 
  getUserProfile, 
  getAllShows, 
  getActiveProduction, 
  getUserProductionRole 
} from "@/app/lib/baserow";
import SettingsClient from "@/app/components/settings/SettingsClient";

export default async function SettingsPage() {
  const session = await auth();
  
  // 1. Security Guard: Must be logged in
  if (!session?.user?.email) {
    redirect("/login");
  }

  const cookieStore = await cookies();
  const activeIdCookie = cookieStore.get('active_production_id')?.value;
  const activeId = activeIdCookie ? Number(activeIdCookie) : null;

  // 2. Fetch Data in Parallel
  // We fetch the User, All Shows, and the Default Show (if no cookie exists)
  const [userProfile, allShows, defaultShow] = await Promise.all([
    getUserProfile(session.user.email),
    getAllShows(),
    !activeId ? getActiveProduction() : Promise.resolve(null)
  ]);

  // Determine the effective Active Show ID (Cookie > Default > 0)
  const effectiveActiveId = activeId || defaultShow?.id || 0;

  // 3. Fetch Context-Aware RBAC Role
  // "Who is this user specifically for THIS show?"
  let productionRole = null;
  
  if (userProfile && effectiveActiveId) {
      // We pass the User's Baserow ID and the Show ID to find their job title
      productionRole = await getUserProductionRole(Number(userProfile.id), effectiveActiveId);
  }

  // Handle case where user isn't in Baserow at all
  if (!userProfile) {
    return (
        <div className="min-h-screen bg-zinc-950 flex items-center justify-center text-white">
            <div className="text-center">
                <h1 className="text-xl font-bold">Profile Not Found</h1>
                <p className="text-zinc-500">Could not find a record for {session.user.email}</p>
                <p className="text-xs text-zinc-600 mt-2">Please contact your administrator.</p>
            </div>
        </div>
    );
  }

  // 4. Render the Client
  return (
    <div className="min-h-screen bg-zinc-950 p-6 lg:p-12 text-white">
      <SettingsClient 
        shows={allShows} 
        activeId={effectiveActiveId} 
        initialUser={userProfile} 
        productionRole={productionRole} // üëà Passing the specific role down
      />
    </div>
  );
}
</file>

<file path="app/components/schedule/SchedulerClient.tsx">
"use client";

import React, { useState, useMemo } from 'react';
import { 
  Users, ChevronRight, ChevronLeft, Search,
  CheckCircle2, Plus, Minus,
  TrendingUp, Calendar as CalendarIcon, 
  LayoutGrid, Coffee, Umbrella, Wand2,
  FileText, Mic2, Music, Theater,
  Target, AlertTriangle, Clock,
  Save, Loader2, Maximize2, X
} from 'lucide-react';

// --- IMPORTS ---
import AutoSchedulerModal from './AutoSchedulerModal'; 
import CallboardView from './CallboardView'; 
import { saveScheduleBatch } from '@/app/lib/actions'; // üü¢ The new Action

// --- TYPES ---
type TrackType = "Acting" | "Music" | "Dance";
type SceneStatus = "New" | "Worked" | "Polished";

interface ScheduledItem {
  id: string;
  sceneId: number;
  track: TrackType;
  day: 'Fri' | 'Sat';
  weekOffset: number;
  startTime: number;
  duration: number;
  status: SceneStatus;
}

// --- CONFIG ---
const FRI_START = 18; 
const FRI_END = 21;   
const SAT_START = 10; 
const SAT_END = 17;   
const TOTAL_WEEKS = 10;
const CURRENT_WEEK = 4;
const TARGET_WEEK = 8; 

// ============================================================================
// MAIN COMPONENT
// ============================================================================
export default function SchedulerClient({ 
    scenes = [], 
    assignments = [], 
    people = [], 
    productionTitle = "Untitled Production",
    productionId // üü¢ Needed for the Save Action
}: any) {
  
  // --- STATE ---
  const [activeTab, setActiveTab] = useState<'calendar' | 'progress' | 'callboard'>('calendar');
  const [isAutoSchedulerOpen, setIsAutoSchedulerOpen] = useState(false);
  const [schedule, setSchedule] = useState<ScheduledItem[]>([]); 
  const [isSaving, setIsSaving] = useState(false); // üü¢ Loading State
  
  // --- SHARED DATA PREP ---
  const sceneData = useMemo(() => {
    if (!scenes || !assignments) return [];

    // 1. Create a Map: SceneID -> Set of Actor Names
    const sceneCastMap = new Map<number, Set<string>>();
    const normalize = (s: string) => s?.toLowerCase().replace(/[^a-z0-9]/g, "") || "";

    assignments.forEach((a: any) => {
        const actorName = a.personName;
        if (!actorName) return;

        // STRATEGY A: Direct ID Match (Fastest)
        if (a.sceneIds && a.sceneIds.length > 0) {
            a.sceneIds.forEach((sid: number) => {
                if (!sceneCastMap.has(sid)) sceneCastMap.set(sid, new Set());
                sceneCastMap.get(sid)?.add(actorName);
            });
            return;
        }

        // STRATEGY B: Text Fuzzy Match (Backup)
        if (a.scenes && typeof a.scenes === 'string') {
            const sceneNames = a.scenes.split(',').map(normalize);
            scenes.forEach((s: any) => {
                const sName = normalize(s.name);
                if (sceneNames.some((n:string) => n.includes(sName) || sName.includes(n))) {
                    if (!sceneCastMap.has(s.id)) sceneCastMap.set(s.id, new Set());
                    sceneCastMap.get(s.id)?.add(actorName);
                }
            });
        }
    });

    // 2. Hydrate Scenes
    return scenes.map((s: any) => {
        const castSet = sceneCastMap.get(s.id) || new Set();
        const castNames = Array.from(castSet);

        return {
            id: s.id,
            name: s.name || "Untitled Scene",
            act: s.act || "1",
            type: s.type || "Scene",
            cast: castNames.map(name => ({ name })),
            castNames: castNames, 
            status: 'New'
        };
    }).sort((a: any, b: any) => a.id - b.id);
  }, [scenes, assignments]);

  // --- DERIVED DATA FOR CALLBOARD ---
  const callboardSchedule = useMemo(() => {
      return schedule.map(slot => {
          const scene = sceneData.find((s: { id: number; }) => s.id === slot.sceneId);
          return {
              ...slot,
              sceneName: scene?.name || "Unknown",
              castList: scene?.castNames || []
          };
      });
  }, [schedule, sceneData]);


  // üü¢ SAVE LOGIC üü¢
  const handleSaveChanges = async () => {
    setIsSaving(true);

    // 1. Identify Unsaved Items
    // Client-side items have long Date.now() IDs (string length > 10)
    // Database items usually have shorter numeric IDs (though in Baserow row IDs are numbers)
    // We assume anything with a string ID > 10 chars is a "Draft"
    const newItems = schedule.filter(item => item.id.length > 10);

    if (newItems.length === 0) {
        setIsSaving(false);
        return;
    }

    // 2. Calculate Real Dates based on Week Offset
    const getRealDate = (day: 'Fri' | 'Sat', weekOffset: number) => {
        const today = new Date();
        // Find "Next Friday" from today
        const nextFri = new Date(today);
        nextFri.setDate(today.getDate() + (5 + 7 - today.getDay()) % 7 + (weekOffset * 7));
        
        if (day === 'Fri') return nextFri.toISOString().split('T')[0];
        
        // If Saturday, add 1 day
        const nextSat = new Date(nextFri);
        nextSat.setDate(nextFri.getDate() + 1);
        return nextSat.toISOString().split('T')[0];
    };

    // 3. Prepare Batch
    const batch = newItems.map(item => ({
        ...item,
        date: getRealDate(item.day, item.weekOffset),
    }));

    // 4. Send to Server
    await saveScheduleBatch(productionId, batch);

    // 5. Reset / Reload
    setIsSaving(false);
    window.location.reload(); // Hard reload to fetch the persisted data
  };


  return (
    <div className="flex flex-col h-screen bg-zinc-950 text-white overflow-hidden font-sans">
        
        {/* HEADER */}
        <header className="h-16 border-b border-white/10 bg-zinc-900 flex items-center justify-between px-6 shrink-0 z-30">
            <div className="flex items-center gap-6">
                <div>
                    <div className="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Production Schedule</div>
                    <h1 className="text-lg font-bold text-white">{productionTitle}</h1>
                </div>

                <div className="flex bg-black/40 p-1 rounded-lg border border-white/5">
                    <button 
                        onClick={() => setActiveTab('calendar')}
                        className={`px-4 py-1.5 rounded-md text-xs font-bold uppercase transition-all flex items-center gap-2 ${activeTab === 'calendar' ? 'bg-zinc-700 text-white shadow' : 'text-zinc-500 hover:text-white'}`}
                    >
                        <CalendarIcon size={14}/> Calendar
                    </button>
                    <button 
                        onClick={() => setActiveTab('progress')}
                        className={`px-4 py-1.5 rounded-md text-xs font-bold uppercase transition-all flex items-center gap-2 ${activeTab === 'progress' ? 'bg-blue-600 text-white shadow' : 'text-zinc-500 hover:text-white'}`}
                    >
                        <TrendingUp size={14}/> Burn-Up
                    </button>
                     <button 
                        onClick={() => setActiveTab('callboard')}
                        className={`px-4 py-1.5 rounded-md text-xs font-bold uppercase transition-all flex items-center gap-2 ${activeTab === 'callboard' ? 'bg-emerald-600 text-white shadow' : 'text-zinc-500 hover:text-white'}`}
                    >
                        <FileText size={14}/> Callboard
                    </button>
                </div>
            </div>
            
            <div className="flex items-center gap-4">
                 
                 {/* üü¢ SAVE BUTTON (Appears when changes exist) */}
                 {schedule.some(i => i.id.length > 10) && (
                     <div className="animate-in fade-in slide-in-from-top-2">
                        <button 
                            onClick={handleSaveChanges}
                            disabled={isSaving}
                            className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wider shadow-[0_0_20px_rgba(16,185,129,0.3)] transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {isSaving ? <Loader2 size={14} className="animate-spin" /> : <Save size={14} />}
                            {isSaving ? "Syncing..." : `Save ${schedule.filter(i => i.id.length > 10).length} Changes`}
                        </button>
                     </div>
                 )}

                 <div className="text-right hidden md:block border-l border-white/10 pl-4">
                    <div className="text-[10px] text-zinc-500 font-mono">Current Week</div>
                    <div className="text-sm font-black text-emerald-400">Week {CURRENT_WEEK} of {TOTAL_WEEKS}</div>
                 </div>
                 
                 <button 
                    onClick={() => setIsAutoSchedulerOpen(true)}
                    className="flex items-center gap-2 bg-purple-600/20 hover:bg-purple-600/40 text-purple-300 border border-purple-500/50 px-3 py-2 rounded-lg text-xs font-black uppercase tracking-wider transition-all"
                 >
                    <Wand2 size={14} /> Auto
                 </button>
            </div>
        </header>

        {/* CONTENT AREA */}
        <div className="flex-1 overflow-hidden relative">
            {activeTab === 'calendar' && (
                <CalendarView 
                    sceneData={sceneData} 
                    schedule={schedule} 
                    setSchedule={setSchedule} 
                />
            )}
            
            {activeTab === 'progress' && (
                <BurnUpView sceneData={sceneData} />
            )}

            {activeTab === 'callboard' && (
                <CallboardView 
                    schedule={callboardSchedule}
                    productionTitle={productionTitle}
                />
            )}
        </div>

        <AutoSchedulerModal 
            isOpen={isAutoSchedulerOpen} 
            onClose={() => setIsAutoSchedulerOpen(false)}
            scenes={sceneData}
            people={people}
            onCommit={(newItems: any[]) => {
                setSchedule(prev => [...prev, ...newItems]);
            }}
        />

    </div>
  );
}

// ============================================================================
// SUB-COMPONENT: CALENDAR VIEW
// ============================================================================
function CalendarView({ sceneData, schedule, setSchedule }: any) {
  const [draggedSceneId, setDraggedSceneId] = useState<number | null>(null);
  const [currentWeekOffset, setCurrentWeekOffset] = useState(0);
  const [searchQuery, setSearchQuery] = useState("");

  // üé® THEMATIC COLOR ENGINE
  const getTrackStyles = (track: TrackType) => {
    switch (track) {
      case 'Music':
        return 'bg-pink-900/40 border-pink-500 text-pink-100 shadow-[0_0_15px_rgba(236,72,153,0.15)]';
      case 'Dance':
        return 'bg-emerald-900/40 border-emerald-500 text-emerald-100 shadow-[0_0_15px_rgba(16,185,129,0.15)]';
      case 'Acting':
        return 'bg-blue-900/40 border-blue-500 text-blue-100 shadow-[0_0_15px_rgba(59,130,246,0.15)]';
      default:
        return 'bg-zinc-800 border-zinc-500 text-zinc-100';
    }
  };

  // üöÄ GRID INTERACTION HELPERS
  const handleDrop = (e: React.DragEvent, day: 'Fri' | 'Sat', hour: number, min: number, track: TrackType) => {
      e.preventDefault();
      const sceneId = parseInt(e.dataTransfer.getData("sceneId"));
      if(!sceneId) return;
      const startTime = hour + (min / 60);
      const newBlock: any = {
          id: Date.now().toString(),
          sceneId, track, day, weekOffset: currentWeekOffset, startTime, duration: 30, status: 'New',
          span: 1 
      };
      setSchedule((prev: any) => [...prev, newBlock]);
      setDraggedSceneId(null);
  };

  const deleteItem = (itemId: string) => {
      setSchedule((prev: any) => prev.filter((item: any) => item.id !== itemId));
  };

  const updateDuration = (itemId: string, change: number) => {
      setSchedule((prev: any) => prev.map((item: any) => 
        item.id === itemId ? { ...item, duration: Math.max(15, item.duration + change) } : item
      ));
  };

  const switchTrack = (itemId: string, direction: 'left' | 'right') => {
      const tracks: TrackType[] = ['Acting', 'Music', 'Dance'];
      setSchedule((prev: any) => prev.map((item: any) => {
          if (item.id !== itemId) return item;
          const currentIndex = tracks.indexOf(item.track);
          const newIndex = direction === 'left' ? currentIndex - 1 : currentIndex + 1;
          if (newIndex < 0 || newIndex >= tracks.length) return item;
          return { ...item, track: tracks[newIndex] };
      }));
  };

  const updateSpan = (itemId: string, direction: 'more' | 'less') => {
      setSchedule((prev: any) => prev.map((item: any) => {
          if (item.id !== itemId) return item;
          const currentSpan = item.span || 1;
          const tracks: TrackType[] = ['Acting', 'Music', 'Dance'];
          const startIndex = tracks.indexOf(item.track);
          
          let newSpan = direction === 'more' ? currentSpan + 1 : currentSpan - 1;
          
          // Edge logic: Prevent spanning out of the grid bounds
          if (startIndex + newSpan > tracks.length) newSpan = currentSpan;
          if (newSpan < 1) newSpan = 1;

          return { ...item, span: newSpan };
      }));
  };

  // üìÖ CALENDAR DATE LOGIC
  const weekLabel = useMemo(() => {
      const today = new Date();
      const nextFri = new Date(today);
      nextFri.setDate(today.getDate() + (5 + 7 - today.getDay()) % 7 + (currentWeekOffset * 7));
      return `Week of ${nextFri.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
  }, [currentWeekOffset]);

  const generateSlots = (start: number, end: number) => {
      const s: { h: number; m: number; val: number; }[] = [];
      for (let h = start; h < end; h++) { [0, 15, 30, 45].forEach(m => s.push({ h, m, val: h + m/60 })); }
      return s;
  };
  const friSlots = generateSlots(FRI_START, FRI_END);
  const satSlots = generateSlots(SAT_START, SAT_END);

  return (
    <div className="flex h-full">
         {/* SIDEBAR SCENE LIST */}
         <aside className="w-72 border-r border-white/10 flex flex-col bg-zinc-900 shrink-0 z-20 shadow-xl">
             <div className="p-4 border-b border-white/10">
                <div className="relative">
                    <Search size={12} className="absolute left-2.5 top-1/2 -translate-y-1/2 text-zinc-500"/>
                    <input 
                        value={searchQuery} 
                        onChange={(e) => setSearchQuery(e.target.value)} 
                        placeholder="Filter scenes..." 
                        className="w-full bg-black/20 border border-white/10 rounded-lg pl-8 pr-3 py-1.5 text-xs focus:border-blue-500 outline-none text-white"
                    />
                </div>
             </div>
             <div className="flex-1 overflow-y-auto px-2 space-y-1 custom-scrollbar pt-2">
                 {sceneData.filter((s:any) => (s.name || "").toLowerCase().includes(searchQuery.toLowerCase())).map((scene: any) => (
                     <div key={scene.id} draggable onDragStart={(e) => { e.dataTransfer.setData("sceneId", scene.id.toString()); setDraggedSceneId(scene.id); }} onDragEnd={() => setDraggedSceneId(null)}
                         className="border border-white/5 bg-zinc-900 p-2 rounded cursor-grab active:cursor-grabbing hover:bg-white/5 transition-all group">
                         <div className="flex justify-between items-center mb-1">
                             <span className="font-bold text-xs text-zinc-200 truncate">{scene.name}</span>
                         </div>
                         <div className="flex items-center gap-2 text-[10px] text-zinc-500">
                              <span className="bg-black/30 px-1 rounded px-1.5 py-0.5">Act {scene.act}</span>
                              <span className={scene.cast.length === 0 ? "text-red-500 font-bold" : "font-medium"}>
                                  {scene.cast.length} Actors
                              </span>
                         </div>
                     </div>
                 ))}
             </div>
         </aside>

         {/* MAIN CALENDAR WORKSPACE */}
         <main className="flex-1 flex flex-col min-w-0 bg-zinc-950 relative">
             <div className="h-12 border-b border-white/10 bg-zinc-900/50 flex items-center justify-center gap-4 shrink-0">
                 <button onClick={() => setCurrentWeekOffset(c => c - 1)} className="p-1.5 hover:bg-white/10 rounded-full transition-colors text-zinc-400 hover:text-white"><ChevronLeft size={18}/></button>
                 <span className="text-xs font-black uppercase tracking-widest text-zinc-300 w-48 text-center">{weekLabel}</span>
                 <button onClick={() => setCurrentWeekOffset(c => c + 1)} className="p-1.5 hover:bg-white/10 rounded-full transition-colors text-zinc-400 hover:text-white"><ChevronRight size={18}/></button>
             </div>
             
             <div className="flex-1 overflow-y-auto custom-scrollbar bg-zinc-950 p-4">
                 <div className="flex gap-4 h-full min-h-[850px]">
                     {[
                         { day: 'Fri', slots: friSlots, start: FRI_START }, 
                         { day: 'Sat', slots: satSlots, start: SAT_START }
                     ].map((col: any) => (
                         <div key={col.day} className="flex-1 flex flex-col bg-zinc-900/30 border border-white/10 rounded-2xl overflow-hidden">
                             <div className="p-3 bg-zinc-800/80 border-b border-white/5 text-center font-black uppercase text-zinc-400 text-[10px] tracking-[0.2em]">{col.day === 'Fri' ? 'Friday Evening' : 'Saturday Full-Day'}</div>
                             <div className="flex-1 relative flex">
                                 {/* Time Labels */}
                                 <div className="w-14 bg-black/20 border-r border-white/5 text-[10px] text-zinc-600 font-mono text-right py-2 shrink-0">
                                     {col.slots.filter((s:any) => s.m === 0).map((s:any) => (
                                         <div key={s.val} style={{ height: '128px' }} className="pr-3 pt-1">{s.h > 12 ? s.h-12 : s.h} {s.h >= 12 ? 'PM' : 'AM'}</div>
                                     ))}
                                 </div>
                                 
                                 {/* Track Matrix */}
                                 <div className="flex-1 grid grid-cols-3 divide-x divide-white/5 relative">
                                     {['Acting', 'Music', 'Dance'].map((track) => (
                                         <div key={track} className="relative group/lane">
                                              <div className="absolute top-0 inset-x-0 p-1 text-[9px] font-black uppercase text-center text-zinc-700 bg-zinc-900/40 z-10">{track}</div>
                                              {col.slots.map((slot:any) => (
                                                  <div key={slot.val} className={`h-8 border-b border-white/[0.02] ${draggedSceneId ? 'hover:bg-blue-500/10' : ''}`}
                                                       onDragOver={(e) => e.preventDefault()} onDrop={(e) => handleDrop(e, col.day, slot.h, slot.m, track as TrackType)}/>
                                              ))}
                                              
                                              {/* RENDER BLOCKS */}
                                              {schedule.filter((i: any) => i.day === col.day && i.track === track && i.weekOffset === currentWeekOffset).map((item: any) => {
                                                  const top = (item.startTime - col.start) * 128;
                                                  const height = (item.duration / 60) * 128;
                                                  const scene = sceneData.find((s:any) => s.id === item.sceneId);
                                                  const span = item.span || 1;
                                                  
                                                  return (
                                                      <div 
                                                        key={item.id} 
                                                        className={`absolute rounded-xl border-l-[6px] p-3 shadow-2xl text-xs overflow-hidden transition-all group hover:brightness-110 active:scale-[0.98]
                                                          ${getTrackStyles(item.track)}
                                                          ${span > 1 ? 'z-40 ring-2 ring-white/10' : 'z-20 left-1.5 right-1.5'}`}
                                                        style={{ 
                                                            top: `${top}px`, 
                                                            height: `${height}px`,
                                                            width: span > 1 ? `calc(${span * 100}% + ${(span - 1) * 0.25}rem - 0.75rem)` : 'auto' 
                                                        }}
                                                      >
                                                           {/* Block Header */}
                                                           <div className="flex justify-between items-start mb-2">
                                                              <div className="font-black truncate pr-2 uppercase tracking-tighter leading-tight text-[11px]">
                                                                {span === 3 ? 'üåé FULL RUN: ' : span === 2 ? 'ü§ù JOINT: ' : ''}{scene?.name}
                                                              </div>
                                                              <button onClick={() => deleteItem(item.id)} className="opacity-0 group-hover:opacity-100 p-1 bg-red-500/80 hover:bg-red-500 text-white rounded-lg transition-all transform hover:scale-110">
                                                                  <X size={12} />
                                                              </button>
                                                           </div>

                                                           {/* Track Teleport & Expansion HUD */}
                                                           <div className="flex items-center gap-1.5 opacity-0 group-hover:opacity-100 transition-all translate-y-1 group-hover:translate-y-0">
                                                                <button onClick={() => switchTrack(item.id, 'left')} disabled={item.track === 'Acting'} className="p-1.5 bg-black/40 hover:bg-black/60 rounded-md disabled:opacity-0 transition-colors"><ChevronLeft size={10}/></button>
                                                                
                                                                <div className="flex items-center bg-black/40 rounded-md overflow-hidden border border-white/5">
                                                                    <button onClick={() => updateSpan(item.id, 'less')} className="px-2 py-1 hover:bg-white/10 border-r border-white/5 transition-colors"><Minus size={10}/></button>
                                                                    <span className="px-2 py-1 text-[8px] font-black tracking-widest text-white/80">{span}x</span>
                                                                    <button onClick={() => updateSpan(item.id, 'more')} className="px-2 py-1 hover:bg-white/10 transition-colors"><Plus size={10}/></button>
                                                                </div>

                                                                <button onClick={() => switchTrack(item.id, 'right')} disabled={item.track === 'Dance' || (item.track === 'Music' && span === 2)} className="p-1.5 bg-black/40 hover:bg-black/60 rounded-md disabled:opacity-0 transition-colors"><ChevronRight size={10}/></button>
                                                           </div>

                                                           {/* Resize Handle / Time HUD */}
                                                           <div className="opacity-0 group-hover:opacity-100 absolute bottom-2 right-2 flex items-center gap-1.5 bg-black/60 backdrop-blur-md rounded-lg p-1 transition-all border border-white/10">
                                                               <button onClick={() => updateDuration(item.id, -15)} className="p-1 hover:bg-white/10 rounded transition-colors"><Minus size={10}/></button>
                                                               <span className="text-[9px] font-mono font-bold text-white px-1">{item.duration}m</span>
                                                               <button onClick={() => updateDuration(item.id, 15)} className="p-1 hover:bg-white/10 rounded transition-colors"><Plus size={10}/></button>
                                                           </div>
                                                      </div>
                                                  )
                                              })}
                                         </div>
                                     ))}
                                 </div>
                             </div>
                         </div>
                     ))}
                 </div>
             </div>
         </main>
    </div>
  );
}
// ... (BurnUpView remains same as previous step, no changes needed there)
function BurnUpView({ sceneData }: any) {
    const [progress, setProgress] = useState<Record<string, { music: number, dance: number, block: number }>>(() => {
        const initial: any = {};
        sceneData.forEach((s: any) => {
             initial[s.id] = { music: 0, dance: 0, block: 0 };
        });
        return initial;
    });

    const [blackoutWeeks, setBlackoutWeeks] = useState(0); 
    const [simulatedExtra, setSimulatedExtra] = useState(0); 

    const toggle = (id: string, type: 'music' | 'dance' | 'block') => {
        setProgress(prev => ({
            ...prev,
            [id]: { ...prev[id], [type]: (prev[id][type] + 1) % 3 }
        }));
    };

    const getStatusColor = (val: number) => {
        if (val === 2) return 'bg-emerald-500 border-emerald-400 text-white shadow-[0_0_10px_rgba(16,185,129,0.4)]';
        if (val === 1) return 'bg-amber-500 border-amber-400 text-black';
        return 'bg-zinc-800 border-zinc-700 text-zinc-600 hover:bg-zinc-700';
    };

    const getStatusLabel = (val: number) => val === 2 ? 'Done' : val === 1 ? 'Work' : 'New';

    const stats = useMemo(() => {
        let totalUnits = 0;
        let completedUnits = 0;

        sceneData.forEach((s: any) => {
            const type = (s.type || "").toLowerCase();
            const p = progress[s.id] || { music: 0, dance: 0, block: 0 };
            const needsMusic = type.includes('song') || type.includes('mixed');
            const needsDance = type.includes('dance') || type.includes('mixed');
            const needsBlock = true; 

            if (needsMusic) { totalUnits++; if (p.music === 2) completedUnits++; }
            if (needsDance) { totalUnits++; if (p.dance === 2) completedUnits++; }
            if (needsBlock) { totalUnits++; if (p.block === 2) completedUnits++; }
        });

        const velocity = CURRENT_WEEK > 0 ? (completedUnits / CURRENT_WEEK) : 0;
        const simulatedCompleted = completedUnits + simulatedExtra;
        const remaining = totalUnits - simulatedCompleted;
        const weeksLeftNeeded = velocity > 0 ? remaining / velocity : 99;
        const projectedEndWeek = CURRENT_WEEK + weeksLeftNeeded + blackoutWeeks;
        const bufferWeeks = TARGET_WEEK - projectedEndWeek;
        const isSafe = bufferWeeks >= 0;

        return { 
            totalUnits, completedUnits, 
            percent: totalUnits > 0 ? Math.round((simulatedCompleted / totalUnits) * 100) : 0, 
            velocity, projectedEndWeek, isSafe, bufferWeeks
        };
    }, [sceneData, progress, blackoutWeeks, simulatedExtra]);

    return (
        <div className="h-full overflow-y-auto custom-scrollbar p-8 bg-zinc-950">
            <div className="max-w-6xl mx-auto space-y-8">
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className={`col-span-2 rounded-3xl p-8 border relative overflow-hidden flex flex-col justify-between transition-colors duration-500 ${stats.isSafe ? 'bg-emerald-950/10 border-emerald-500/20' : 'bg-red-950/10 border-red-500/20'}`}>
                         <div className="relative z-10 flex justify-between items-start">
                             <div>
                                 <h2 className="text-sm font-black uppercase tracking-widest text-zinc-400 flex items-center gap-2">
                                     <Target size={18} className={stats.isSafe ? "text-emerald-500" : "text-red-500"}/> Pace Projection
                                 </h2>
                                 <div className="mt-2 text-5xl font-black text-white">
                                     {stats.percent}% <span className="text-xl text-zinc-600">Show Ready</span>
                                 </div>
                             </div>
                             <div className={`px-4 py-2 rounded-xl text-xs font-black uppercase tracking-wider border flex items-center gap-2 ${stats.isSafe ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20'}`}>
                                {stats.isSafe ? <Coffee size={14}/> : <AlertTriangle size={14}/>}
                                {stats.isSafe ? "You can Relax" : "Push Harder"}
                             </div>
                         </div>
                         <div className="relative z-10 mt-8">
                             <div className="flex justify-between text-[10px] font-black uppercase text-zinc-500 mb-2">
                                 <span>Start</span>
                                 <span className="text-white">Week {CURRENT_WEEK} (Now)</span>
                                 <span className={stats.isSafe ? "text-emerald-400" : "text-red-400"}>Est. Finish: Wk {stats.projectedEndWeek.toFixed(1)}</span>
                                 <span>Week {TOTAL_WEEKS}</span>
                             </div>
                             <div className="h-4 bg-black/40 rounded-full w-full overflow-hidden relative border border-white/5">
                                 <div className="absolute left-0 top-0 bottom-0 bg-emerald-500/10 border-r border-emerald-500/30" style={{ width: `${(TARGET_WEEK / TOTAL_WEEKS) * 100}%` }}></div>
                                 <div className="absolute left-0 top-0 bottom-0 bg-blue-600 rounded-full transition-all duration-1000" style={{ width: `${(CURRENT_WEEK / TOTAL_WEEKS) * 100}%` }}></div>
                                 <div className={`absolute top-0 bottom-0 w-1 shadow-[0_0_15px_rgba(255,255,255,0.8)] z-20 transition-all duration-500 ${stats.isSafe ? 'bg-emerald-400' : 'bg-red-500'}`} style={{ left: `${Math.min((stats.projectedEndWeek / TOTAL_WEEKS) * 100, 100)}%` }} />
                             </div>
                             <p className="text-xs text-zinc-400 text-center mt-3 bg-black/20 py-2 rounded-lg border border-white/5">
                                {stats.isSafe ? `‚úÖ You are ${stats.bufferWeeks.toFixed(1)} weeks ahead of schedule.` : `‚ö†Ô∏è You are ${Math.abs(stats.bufferWeeks).toFixed(1)} weeks behind target.`}
                             </p>
                         </div>
                    </div>

                    <div className="bg-zinc-900 border border-white/5 rounded-3xl p-6 flex flex-col justify-center gap-6">
                        <div className="text-[10px] font-black uppercase text-zinc-500 tracking-widest border-b border-white/5 pb-2">Reality Check Simulator</div>
                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs font-bold text-zinc-300 flex items-center gap-2"><Umbrella size={14} className="text-blue-400"/> Vacations / Breaks</span>
                                <span className="text-xl font-black text-white">{blackoutWeeks} <span className="text-[10px] text-zinc-600">WKS</span></span>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setBlackoutWeeks(Math.max(0, blackoutWeeks - 0.5))} className="flex-1 bg-zinc-800 hover:bg-zinc-700 py-2 rounded text-zinc-400 hover:text-white"><Minus size={14}/></button>
                                <button onClick={() => setBlackoutWeeks(blackoutWeeks + 0.5)} className="flex-1 bg-zinc-800 hover:bg-zinc-700 py-2 rounded text-zinc-400 hover:text-white"><Plus size={14}/></button>
                            </div>
                        </div>
                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs font-bold text-zinc-300 flex items-center gap-2"><TrendingUp size={14} className="text-emerald-400"/> If we finish...</span>
                                <span className="text-xl font-black text-emerald-400">+{simulatedExtra} <span className="text-[10px] text-zinc-600">ITEMS</span></span>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setSimulatedExtra(Math.max(0, simulatedExtra - 1))} className="flex-1 bg-zinc-800 hover:bg-zinc-700 py-2 rounded text-zinc-400 hover:text-white"><Minus size={14}/></button>
                                <button onClick={() => setSimulatedExtra(simulatedExtra + 1)} className="flex-1 bg-emerald-900/30 border border-emerald-500/30 hover:bg-emerald-500 hover:text-white py-2 rounded text-emerald-400 transition-all font-bold">+1 More Today</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="bg-zinc-900 border border-white/5 rounded-3xl overflow-hidden shadow-xl">
                    <div className="p-6 border-b border-white/5 bg-zinc-900/80 backdrop-blur-xl flex justify-between items-center sticky top-0 z-20">
                        <h3 className="text-lg font-black uppercase italic text-white flex items-center gap-2"><LayoutGrid size={18} className="text-purple-500"/> Scene Breakdown</h3>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left">
                            <thead className="bg-zinc-950 text-zinc-500 text-[10px] font-black uppercase tracking-widest border-b border-white/5">
                                <tr>
                                    <th className="px-6 py-4 w-16 text-center">#</th>
                                    <th className="px-6 py-4">Scene Name</th>
                                    <th className="px-6 py-4 w-32 text-center">Music</th>
                                    <th className="px-6 py-4 w-32 text-center">Dance</th>
                                    <th className="px-6 py-4 w-32 text-center">Blocking</th>
                                    <th className="px-6 py-4 w-24 text-center">Ready?</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-white/5 text-sm">
                                {sceneData.map((s: any, i: number) => {
                                    const type = (s.type || "").toLowerCase();
                                    const needsMusic = type.includes('song') || type.includes('mixed');
                                    const needsDance = type.includes('dance') || type.includes('mixed');
                                    const p = progress[s.id] || { music:0, dance:0, block:0 };
                                    const isReady = (!needsMusic || p.music===2) && (!needsDance || p.dance===2) && p.block===2;

                                    return (
                                        <tr key={s.id} className="hover:bg-white/5 transition-colors group">
                                            <td className="px-6 py-4 text-center font-mono text-zinc-600">{i+1}</td>
                                            <td className="px-6 py-4"><div className="font-bold text-zinc-300">{s.name}</div><div className="text-[10px] text-zinc-600 uppercase font-black tracking-wider">{s.type}</div></td>
                                            <td className="px-6 py-4">{needsMusic ? <button onClick={() => toggle(s.id, 'music')} className={`w-full py-1.5 rounded text-[10px] font-black uppercase border transition-all ${getStatusColor(p.music)}`}>{getStatusLabel(p.music)}</button> : <div className="text-center text-zinc-800">-</div>}</td>
                                            <td className="px-6 py-4">{needsDance ? <button onClick={() => toggle(s.id, 'dance')} className={`w-full py-1.5 rounded text-[10px] font-black uppercase border transition-all ${getStatusColor(p.dance)}`}>{getStatusLabel(p.dance)}</button> : <div className="text-center text-zinc-800">-</div>}</td>
                                            <td className="px-6 py-4"><button onClick={() => toggle(s.id, 'block')} className={`w-full py-1.5 rounded text-[10px] font-black uppercase border transition-all ${getStatusColor(p.block)}`}>{getStatusLabel(p.block)}</button></td>
                                            <td className="px-6 py-4 text-center">{isReady ? <CheckCircle2 size={20} className="mx-auto text-emerald-500 animate-in zoom-in"/> : <div className="w-1.5 h-1.5 rounded-full bg-zinc-800 mx-auto"/>}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="app/lib/actions.ts">
"use server";

import { cookies } from "next/headers";
import { redirect } from "next/navigation";
import { revalidatePath } from "next/cache";
import { getClassRoster, fetchBaserow, getActiveProduction } from "@/app/lib/baserow";
import { DB } from "@/app/lib/schema";

// --- HELPERS ---

// Converts decimal time (18.5) to HH:MM string ("18:30")
// Used to construct ISO strings for Baserow
const formatTimeHHMM = (decimal: number) => {
  const h = Math.floor(decimal);
  const m = Math.round((decimal % 1) * 60);
  return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
};

// --- EXISTING ACTIONS ---

export async function fetchRosterAction(classId: string) {
  const roster = await getClassRoster(classId);
  return roster;
}

export async function switchProduction(formData: FormData) {
  const productionId = formData.get("productionId")?.toString();
  const redirectPath = formData.get("redirectPath")?.toString() || "/dashboard";

  if (productionId) {
    (await cookies()).set("active_production_id", productionId, {
      maxAge: 60 * 60 * 24 * 30, 
      path: "/",
    });
  }
  
  redirect(redirectPath);
}

// --- PRODUCTION ANALYSIS ACTIONS ---

type SceneLoadUpdate = {
  id: number;
  load: {
    music: number;
    dance: number;
    block: number;
  };
};

export async function updateSceneLoads(updates: SceneLoadUpdate[]) {
  const F = DB.SCENES.FIELDS;

  const promises = updates.map(async (update) => {
    const body = {
      [F.MUSIC_LOAD]: update.load.music,
      [F.DANCE_LOAD]: update.load.dance,
      [F.BLOCKING_LOAD]: update.load.block,
    };

    await fetchBaserow(`/database/rows/table/${DB.SCENES.ID}/${update.id}/`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
  });

  await Promise.all(promises);

  revalidatePath("/dashboard");
  revalidatePath("/analysis");
  revalidatePath("/production");

  return { success: true };
}

// --- SHOW HUB STATUS ACTION ---

export async function updateSceneStatus(sceneId: number, field: 'music' | 'dance' | 'block', status: string) {
  const F = DB.SCENES.FIELDS;
  
  // Map "Traffic Light" names to Baserow Field IDs
  const fieldMap = {
    'music': F.MUSIC_STATUS,
    'dance': F.DANCE_STATUS,
    'block': F.BLOCK_STATUS // Matched to Schema
  };

  const targetField = fieldMap[field];
  
  await fetchBaserow(`/database/rows/table/${DB.SCENES.ID}/${sceneId}/`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      [targetField]: status 
    }),
  });

  revalidatePath("/production");
}

// --- WORKFLOW OVERRIDE ACTION ---

export async function markStepComplete(stepKey: string) {
  const production = await getActiveProduction();
  if (!production) return;

  const keyMap: Record<string, string> = {
    'auditions': 'Auditions',
    'callbacks': 'Callbacks',
    'casting': 'Casting',
    'points': 'Calibration',
    'schedule': 'Scheduling'
  };
  
  const targetTag = keyMap[stepKey];
  if (!targetTag) return;

  const currentTags = production.workflowOverrides || []; 
  const currentValues = currentTags.map((t: any) => t.value);

  if (!currentValues.includes(targetTag)) {
    const newValues = [...currentValues, targetTag];

    await fetchBaserow(`/database/rows/table/${DB.PRODUCTIONS.ID}/${production.id}/`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        [DB.PRODUCTIONS.FIELDS.WORKFLOW_OVERRIDES]: newValues
      }),
    });
  }

  revalidatePath("/");
}

// --- SCHEDULING ACTIONS (PARENT-CHILD LOGIC) ---

export async function saveScheduleBatch(productionId: number, items: any[]) {
  // 1. Group items by Day to handle Parents
  // items.date is "YYYY-MM-DD"
  const itemsByDate: Record<string, any[]> = {};
  
  items.forEach(item => {
      if (!itemsByDate[item.date]) itemsByDate[item.date] = [];
      itemsByDate[item.date].push(item);
  });

  const promises = Object.entries(itemsByDate).map(async ([date, dayItems]) => {
      
      // A. FIND OR CREATE PARENT EVENT ("The Container")
      // Logic: If no ID passed, we assume we need to create a new 
      // "Rehearsal Block" that spans the min/max time of these slots.
      
      let parentEventId = dayItems[0].existingParentEventId; 

      if (!parentEventId) {
          // Calculate container duration
          const minTime = Math.min(...dayItems.map((i:any) => i.startTime)); 
          const maxTime = Math.max(...dayItems.map((i:any) => i.startTime + (i.duration/60))); 
          
          // Construct Full ISO DateTimes for Baserow Date Fields
          const startDateTime = `${date}T${formatTimeHHMM(minTime)}:00`;
          const endDateTime = `${date}T${formatTimeHHMM(maxTime)}:00`;

          const parentRes = await fetchBaserow(`/database/rows/table/${DB.EVENTS.ID}/`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                  [DB.EVENTS.FIELDS.PRODUCTION]: [productionId],
                  [DB.EVENTS.FIELDS.DATE]: date,
                  [DB.EVENTS.FIELDS.START_TIME]: startDateTime,
                  [DB.EVENTS.FIELDS.END_TIME]: endDateTime,
                  [DB.EVENTS.FIELDS.EVENT_TYPE]: "Rehearsal"
              })
          });
          
          if (parentRes.ok) {
            const parentData = await parentRes.json();
            parentEventId = parentData.id;
          } else {
             console.error("Failed to create parent event:", await parentRes.text());
             return; // Stop if parent failed
          }
      }

      // B. CREATE THE SLOTS ("The 30-min Blocks")
      // These link to the Parent Event we just created
      if (parentEventId) {
        const slotPromises = dayItems.map(item => {
             const slotStartDateTime = `${date}T${formatTimeHHMM(item.startTime)}:00`;

             return fetchBaserow(`/database/rows/table/${DB.SLOTS.ID}/`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    [DB.SLOTS.FIELDS.EVENT_LINK]: [parentEventId], // Link to Parent
                    [DB.SLOTS.FIELDS.SCENE]: [item.sceneId],       // Link to Scene
                    [DB.SLOTS.FIELDS.TRACK]: item.track,           // e.g. "Music"
                    [DB.SLOTS.FIELDS.START_TIME]: slotStartDateTime,
                    [DB.SLOTS.FIELDS.DURATION]: item.duration
                })
             });
        });
        await Promise.all(slotPromises);
      }
  });

  await Promise.all(promises);
  revalidatePath("/schedule");
  return { success: true };
}
</file>

<file path="app/lib/schema.ts">
// app/lib/schema.ts

export const DB = {
  PEOPLE: {
    ID: "599",
    FIELDS: {
      FULL_NAME: "field_5735",
      FIRST_NAME: "field_5736",
      LAST_NAME: "field_5737",
      HEADSHOT: "field_5776",
      STATUS: "field_5782",
      PHONE_NUMBER: "field_5783",
      CYT_NATIONAL_INDIVIDUAL_EMAIL: "field_6131",
      CYT_ACCOUNT_PERSONAL_EMAIL: "field_6132",
      PARENT_1: "field_5779",
      PARENT_2: "field_5780",
      CAST_CREW_ASSIGNMENTS: "field_5788",
      BIO_ORIGINAL: "field_5821",
      BIO_EDITED: "field_5822",
      CONFLICTS: "field_5990",
      AUDITIONS: "field_6054",
      AGE: "field_5739",
      HEIGHT_TOTAL_INCHES: "field_5777",
      GENDER: "field_5775",
      SHOW_TEAM: "field_5850",
      CLASSES: "field_6123",
      CLASSES_STUDENTS: "field_6151",
      MEDICAL_NOTES: "field_6140",
      ADDRESS: "field_6133",
      CITY: "field_6135",
      FAMILIES: "field_6153"
    },
  },
  ASSIGNMENTS: {
    ID: "603",
    FIELDS: {
      ASSIGNMENT: "field_5785",
      PERSON: "field_5786",
      PRODUCTION: "field_5787",
      PERFORMANCE_IDENTITY: "field_5796",
      SCENE_ASSIGNMENTS: "field_6042",
    },
  },
  ROLES: {
    ID: "605",
    FIELDS: {
      NAME: "field_5791",
      TYPE: "field_5792",
      CONSTRAINTS: "field_5793",
      CAST_ASSIGNMENTS: "field_5797",
      ACTIVE_SCENES: "field_6077",
    },
  },
  // Alias for code that uses BLUEPRINT_ROLES
  BLUEPRINT_ROLES: {
    ID: "605",
    FIELDS: {}
  },
  SCENES: {
    ID: "627",
    FIELDS: {
      SCENE_NAME: "field_6022",
      PRODUCTION: "field_6023",
      ACT: "field_6025",
      SCENE_SIZE: "field_6026",
      SCENE_TYPE: "field_6030",
      CAST_ASSIGNMENTS: "field_6041",
      ORDER: "field_6218",
      MUSIC_STATUS: "field_6219",
      DANCE_STATUS: "field_6220",
      BLOCKING_STATUS: "field_6221",
      MUSIC_LOAD: "field_6222",
      DANCE_LOAD: "field_6223",
      BLOCKING_LOAD: "field_6224",
      PAGES: "field_6226",
      EVENTS: "field_6228",
      SLOTS: "field_6234",
    },
  },
  AUDITIONS: {
    ID: "630",
    FIELDS: {
      PERFORMER: "field_6052",
      PRODUCTION: "field_6053",
      DATE: "field_6061",
      SONG: "field_6062",
      MONOLOGUE: "field_6063",
      VOCAL_SCORE: "field_6056",
      ACTING_SCORE: "field_6057",
      DANCE_SCORE: "field_6059",
      STAGE_PRESENCE_SCORE: "field_6058",
      ACTING_NOTES: "field_6060",
      CHOREOGRAPHY_NOTES: "field_6073",
      MUSIC_NOTES: "field_6074",
      ADMIN_NOTES: "field_6076",
      DROP_IN_NOTES: "field_6075",
      HEADSHOT: "field_6064",
      AUDITION_VIDEO: "field_6082",
      DANCE_VIDEO: "field_6084",
      CALLBACKS: "field_6068",
      AGE: "field_6065",
      HEIGHT: "field_6066",
      CONFLICTS: "field_6068",
      GENDER: "field_6080"
    },
  },
  PRODUCTIONS: {
    ID: "600",
    FIELDS: {
      TITLE: "field_5743",
      FULL_TITLE: "field_5741",
      SEASON: "field_5742",
      IS_ACTIVE: "field_6083", 
      STATUS: "field_5746",
      SHOW_IMAGE: "field_6176",
      LOCATION: "field_6105",
      VENUE: "field_6180",
      WORKFLOW_OVERRIDES: "field_6225",
    }
  },
  EVENTS: {
    ID: "625", 
    FIELDS: {
      PRODUCTION: "field_6007",
      EVENT_DATE: "field_6008",
      START_TIME: "field_6010",
      END_TIME: "field_6011",
      EVENT_TYPE: "field_6012",
      IS_REQUIRED: "field_6013",
      SCENES: "field_6227",
      SLOTS: "field_6232",
    }
  },
  SLOTS: {
    ID: "640", 
    FIELDS: {
      EVENT_LINK: "field_6230",
      SCENE: "field_6233",
      TRACK: "field_6235",
      START_TIME: "field_6236",
      DURATION: "field_6238",
    }
  },
  // --- MISSING TABLES ADDED BELOW ---
  CLASSES: {
    ID: "633",
    FIELDS: {
        CLASS_NAME: "field_6115",
        SESSION: "field_6116",
        TEACHER: "field_6117",
        LOCATION: "field_6118",
        SPACE: "field_6196",
        DAY: "field_6119",
        TIME_SLOT: "field_6120",
        TYPE: "field_6217",
        AGE_RANGE: "field_6121",
        STUDENTS: "field_6150"
    }
  },
  VENUES: {
    ID: "635",
    FIELDS: {
        VENUE_NAME: "field_6154",
        TYPE: "field_6197",
        CONTACT_NAME: "field_6198"
    }
  },
  SPACES: {
    ID: "638",
    FIELDS: {
        ROOM_NAME: "field_6216",
        FULL_ROOM_NAME: "field_6200",
        CAPACITY: "field_6202",
        FLOOR_TYPE: "field_6204",
        VENUE: "field_6201"
    }
  },
  RENTAL_RATES: {
    ID: "639",
    FIELDS: {
        VENUE: "field_6208",
        HOURLY_RATE: "field_6211",
        WEEKEND_RATE: "field_6212",
        FLAT_RATE: "field_6209"
    }
  },
  ASSETS: { // Called RESOURCES in Baserow
    ID: "631",
    FIELDS: {
        NAME: "field_6085",
        LINK: "field_6086",
        TYPE: "field_6087",
        PRODUCTION: "field_6088"
    }
  },
  SHOW_TEAM: {
    ID: "610",
    FIELDS: {
        PERSON: "field_5848",
        POSITION: "field_5849",
        PRODUCTIONS: "field_5852"
    }
  },
  COMMITTEE_PREFS: {
    ID: "620",
    FIELDS: {
        STUDENT_NAME: "field_6103",
        STUDENT_ID: "field_6099",
        PRE_SHOW_1ST: "field_5955",
        PRE_SHOW_2ND: "field_6090",
        SHOW_WEEK_1ST: "field_5956",
        SHOW_WEEK_2ND: "field_6092",
        EMAIL: "field_6097",
        PHONE: "field_6098",
        SHOW_WEEK_COMMITTEES: "field_5962",
        PRODUCTION: "field_5952"
    }
  },
  CONFLICTS: {
    ID: "623",
    FIELDS: {
        PRODUCTION: "field_5989",
        DATE: "field_6072",
        PERSON: "field_5988",
        CONFLICT_TYPE: "field_5994",
        MINUTES_LATE_EARLY: "field_5995",
        SUBMITTED_VIA: "field_5996",
        NOTES: "field_5997",
        PRODUCTION_EVENT: "field_6070"
    }
  },
  PERFORMANCES: {
    ID: "637",
    FIELDS: {
        TICKETS_SOLD: "field_6184",
        TOTAL_INVENTORY: "field_6183",
        PERFORMANCE: "field_6182"
    }
  }
};
</file>

<file path="app/(main)/page.tsx">
import { cookies } from 'next/headers';
import Link from 'next/link';
import { auth } from "@/auth";
import { 
  Users, Calendar, BarChart3, Ticket, 
  ChevronRight, Sparkles, Cat, 
  Theater, Waves, GraduationCap
} from 'lucide-react';

// 1. Import Baserow Fetchers
import { 
  getActiveProduction, 
  getShowById, 
  getAssignments, 
  getCreativeTeam, 
  getClasses,
  getAuditionees,    
  getScenes,         
  getProductionEvents 
} from '@/app/lib/baserow';

// 2. Import Components
import CreativeTeam from '@/app/components/dashboard/CreativeTeam';
import SeasonContext from '@/app/components/dashboard/SeasonContext';
import WorkflowProgress from '@/app/components/dashboard/WorkflowProgress'; 

export const dynamic = 'force-dynamic';

export default async function DashboardPage() {
  const session = await auth();
  const userRole = (session?.user as any)?.role || "Guest";

  // --- RESOLVE SHOW ---
  const cookieStore = await cookies();
  const cookieId = cookieStore.get('active_production_id')?.value;
  let show = null;
  if (cookieId) show = await getShowById(cookieId);
  if (!show) show = await getActiveProduction();

  if (!show) {
     return <div className="p-20 text-center text-zinc-500 font-bold uppercase tracking-widest">No Active Show Found</div>;
  }

  // --- PARALLEL FETCH ---
  const [
    assignments, 
    creativeTeam, 
    allClasses,
    auditionees,
    scenes,
    events
  ] = await Promise.all([
      getAssignments(show.id),
      getCreativeTeam(show.id),
      getClasses(),
      getAuditionees(show.id),
      getScenes(show.id),
      getProductionEvents(show.id)
  ]);
  
  // --- SHOW STATS ---
  const uniqueCastIds = new Set(
    assignments
      .filter((a: any) => a.personId) 
      .map((a: any) => a.personId)
  );
  const castCount = uniqueCastIds.size;

  // --- WORKFLOW STATUS LOGIC (Database + Manual Override) ---
  const hasOverride = (key: string) => {
     // Check if the production's override list contains this specific key
     return show.workflowOverrides?.some((tag: any) => tag.value === key);
  };

  const workflowStatus = {
      // 1. Auditions: >5 people logged OR manual override
      hasAuditions: auditionees.length > 5 || hasOverride('Auditions'),
      
      // 2. Callbacks: Casting started OR manual override
      hasCallbacks: assignments.length > 0 || hasOverride('Callbacks'), 

      // 3. Casting: Assignments exist OR manual override
      hasCast: assignments.length > 0 || hasOverride('Casting'),
      
      // 4. Points: Scenes have difficulty scores OR manual override
      hasPoints: scenes.some((s: any) => s.load && (s.load.music > 0 || s.load.dance > 0 || s.load.block > 0)) || hasOverride('Calibration'),
      
      // 5. Schedule: Events exist OR manual override
      hasSchedule: events.length > 0 || hasOverride('Scheduling')
  };

  // --- THEME ENGINE ---
  const getShowTheme = (title: string) => {
    const t = (title || "").toLowerCase();
    if (t.includes('lion')) return { icon: <Cat size={220} />, color: 'text-orange-500', bg: 'from-orange-900/40 to-red-900/20', accent: 'text-orange-400' };
    if (t.includes('mermaid')) return { icon: <Waves size={220} />, color: 'text-cyan-500', bg: 'from-cyan-900/30 to-blue-900/20', accent: 'text-cyan-400' };
    return { icon: <Theater size={220} />, color: 'text-blue-500', bg: 'from-zinc-900 to-zinc-900', accent: 'text-blue-500' };
  };

  const theme = getShowTheme(show?.title);

  return (
    <div className="min-h-screen bg-zinc-950 p-6 pb-20 overflow-y-auto custom-scrollbar space-y-8">
      
      {/* 1. HERO */}
      <div className={`relative overflow-hidden bg-zinc-900 border border-white/10 rounded-[2.5rem] p-8 md:p-12 shadow-2xl transition-all duration-1000 bg-gradient-to-br ${theme.bg}`}>
         <div className={`absolute -top-12 -right-12 p-8 opacity-10 rotate-12 transition-all duration-1000 ${theme.color}`}>
            {theme.icon}
        </div>
        <div className="relative z-10 max-w-5xl">
            <div className="flex items-center gap-3 mb-4">
                <span className={`text-[10px] font-black uppercase tracking-[0.2em] transition-colors duration-1000 ${theme.accent}`}>Active Production</span>
                <span className="w-1 h-1 rounded-full bg-white/20"></span>
                <span className="text-[10px] font-bold text-zinc-400 uppercase tracking-widest">{show?.season}</span>
            </div>
            <h1 className="text-4xl md:text-7xl font-black uppercase italic tracking-tighter text-white mb-8 drop-shadow-2xl max-w-3xl leading-[0.9]">{show?.title}</h1>
            <div className="flex flex-col xl:flex-row xl:items-center gap-6 xl:gap-8">
                <div className="flex gap-2 shrink-0">
                    <div className="flex items-center gap-2.5 px-4 py-2 bg-black/30 rounded-full border border-white/10 backdrop-blur-xl shadow-lg">
                        <Users size={18} className="text-zinc-400"/>
                        <span className="text-sm font-black text-white">{castCount} Cast</span>
                    </div>
                     <div className="flex items-center gap-2.5 px-4 py-2 bg-black/30 rounded-full border border-white/10 backdrop-blur-xl shadow-lg">
                        <Ticket size={18} className={theme.accent}/>
                        <span className={`text-sm font-black ${theme.accent}`}>Box Office</span>
                    </div>
                </div>
                <div className="hidden xl:block w-px h-8 bg-white/10"></div>
                {creativeTeam && <CreativeTeam team={creativeTeam as any} />}
            </div>
        </div>
      </div>

      {/* 2. WORKFLOW TRACKER */}
      <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
         <WorkflowProgress status={workflowStatus} />
      </div>

      {/* 3. ACTION GRID */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div className="space-y-4">
             <h3 className="text-[10px] font-black uppercase tracking-widest text-zinc-500 ml-4 flex items-center gap-2"><div className="w-1 h-1 rounded-full bg-blue-500" /> Daily Workspace</h3>
             <ActionCard href="/schedule" title="Rehearsal Schedule" desc="View and create calls, times, and conflicts" icon={<Calendar className="text-blue-400"/>} color="bg-blue-400"/>
             <ActionCard href="/casting" title="Casting & Auditions" desc="Manage auditions, callbacks and cast grid" icon={<Users className="text-indigo-400"/>} color="bg-indigo-400"/>
        </div>
        <div className="space-y-4">
            <h3 className="text-[10px] font-black uppercase tracking-widest text-zinc-500 ml-4 flex items-center gap-2"><div className="w-1 h-1 rounded-full bg-emerald-500" /> Logistics</h3>
            <ActionCard href="/roster" title="Master Roster" desc="Contact info, compliance and status tracker" icon={<Users className="text-emerald-400"/>} color="bg-emerald-400"/>
            <ActionCard href="/reports" title="Director Reports" desc="Revenue, Cast breakdown, show health metrics" icon={<BarChart3 className="text-amber-400"/>} color="bg-amber-400"/>
        </div>
        <div className="space-y-4">
             <h3 className="text-[10px] font-black uppercase tracking-widest text-zinc-500 ml-4 flex items-center gap-2"><div className="w-1 h-1 rounded-full bg-pink-500" /> Academy & Season</h3>
             <ActionCard href="/education" title="Class Manager" desc="Weekly attendance status and enrollment" icon={<GraduationCap className="text-pink-400"/>} color="bg-pink-400"/>
             <div className="p-6 rounded-3xl border border-dashed border-zinc-800/50 flex flex-col items-center justify-center text-center group transition-all hover:bg-zinc-900/30">
                <Sparkles size={24} className="text-zinc-800 group-hover:text-purple-500/50 transition-all duration-500 mb-2"/>
                <span className="text-[10px] font-black uppercase text-zinc-700 tracking-tighter">Season Planning</span>
            </div>
        </div>
      </div>

      {/* 4. SEASON CONTEXT */}
      <SeasonContext 
         initialSeason={show?.season} 
         allClasses={allClasses} 
         activeShowStats={{ castCount }}
      />

      {/* FOOTER */}
      <div className="pt-6 border-t border-white/5 flex flex-col items-center gap-3">
          <div className="text-[10px] font-black uppercase tracking-[0.5em] text-zinc-800">Open Backstage Casting</div>
          <div className="flex gap-2">
            <div className="px-3 py-1 bg-zinc-900 border border-white/5 rounded-full text-[9px] text-zinc-500 font-black uppercase tracking-widest">Build 1.5.0</div>
            <div className="px-3 py-1 bg-blue-500/10 border border-blue-500/20 rounded-full text-[9px] text-blue-500 font-black uppercase tracking-widest">{userRole}</div>
          </div>
      </div>
    </div>
  );
}

function ActionCard({ href, title, desc, icon, color }: any) {
    return (
        <Link href={href} className="group relative block bg-zinc-900/50 border border-white/5 p-6 rounded-3xl hover:bg-zinc-900 hover:border-white/10 transition-all duration-300 shadow-xl overflow-hidden backdrop-blur-sm">
            <div className={`absolute -right-6 -bottom-6 w-24 h-24 rounded-full opacity-0 group-hover:opacity-10 blur-2xl transition-all duration-500 ${color}`} />
            <div className="flex items-center gap-5 relative z-10">
                <div className="p-4 bg-black/40 rounded-2xl border border-white/5 group-hover:scale-110 group-hover:bg-black/60 transition-all duration-500">{icon}</div>
                <div className="flex-1 min-w-0">
                    <h4 className="font-black text-white text-base group-hover:text-white transition-colors tracking-tight">{title}</h4>
                    <p className="text-xs text-zinc-500 font-medium line-clamp-1">{desc}</p>
                </div>
                <ChevronRight size={18} className="text-zinc-800 group-hover:text-white transition-all transform group-hover:translate-x-1" />
            </div>
        </Link>
    )
}
</file>

<file path="app/components/globalappheader/client.tsx">
"use client";

import { useState, useRef, useEffect, useMemo } from 'react';
import { useFormStatus } from 'react-dom';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { signOut } from "next-auth/react";
import { switchProduction } from '@/app/actions';
import { useSimulation } from '@/app/context/SimulationContext'; // üëà IMPORT THIS
import { 
  Menu, X, ChevronRight, ChevronsUpDown, Calendar, 
  Check, Sparkles, Archive, Clock, Rocket, Bug, Wrench, Settings, LogOut,
  Theater, UserSquare2, AlertOctagon, BarChart3, GraduationCap, LayoutGrid, Mic2, Megaphone
} from 'lucide-react';

export default function GlobalHeaderClient({ 
  shows, 
  activeId, 
  user 
}: { 
  shows: any[], 
  activeId: number, 
  user?: any 
}) {
  const [isNavOpen, setIsNavOpen] = useState(false);
  const [isContextOpen, setIsContextOpen] = useState(false);
  const [isProfileOpen, setIsProfileOpen] = useState(false);
  const [viewMode, setViewMode] = useState<'current' | 'archive'>('current');
  const [showDebug, setShowDebug] = useState(false);

  // üöÄ CONNECT TO THE MATRIX
  // We rename 'role' to 'effectiveRole' to avoid confusion
  const { role: effectiveRole, isSimulating } = useSimulation();

  const navRef = useRef<HTMLDivElement>(null);
  const contextRef = useRef<HTMLDivElement>(null);
  const profileRef = useRef<HTMLDivElement>(null);
  const pathname = usePathname();

  // Close menus on click outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (navRef.current && !navRef.current.contains(event.target as Node)) setIsNavOpen(false);
      if (contextRef.current && !contextRef.current.contains(event.target as Node)) setIsContextOpen(false);
      if (profileRef.current && !profileRef.current.contains(event.target as Node)) setIsProfileOpen(false);
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // --- DYNAMIC DATA BUCKETING ---
  const groupedData = useMemo(() => {
    const active: Record<string, any[]> = {};
    const upcoming: Record<string, any[]> = {};
    const archive: Record<string, any[]> = {};
    const allSeasons = new Set<string>();

    shows.forEach(show => {
      const season = show.season || 'Other';
      allSeasons.add(season);

      // Prioritize explicit Active flag
      if (show.isActive) {
        if (!active[season]) active[season] = [];
        active[season].push(show);
      } 
      // Then check for Upcoming/Pre-Production status
      else if (show.status === 'Upcoming' || show.status === 'Pre-Production') {
        if (!upcoming[season]) upcoming[season] = [];
        upcoming[season].push(show);
      } 
      // Everything else belongs in the history bin
      else {
        if (!archive[season]) archive[season] = [];
        archive[season].push(show);
      }
    });

    const seasons = Array.from(allSeasons).sort((a, b) => 
      b.localeCompare(a, undefined, { numeric: true })
    );

    return { active, upcoming, archive, seasons };
  }, [shows]);

  const activeShow = shows.find(s => s.id === activeId) || shows[0] || { title: "Select Production", location: "Unknown" };
  const userInitials = user?.name 
    ? user.name.split(' ').map((n:string) => n[0]).join('').substring(0,2).toUpperCase() 
    : "??";

  return (
    <>
      <header className="h-16 bg-zinc-950 border-b border-zinc-800 flex items-center justify-between px-4 shrink-0 relative z-50">
        
        {/* LEFT: NAV & CONTEXT */}
        <div className="flex items-center gap-4">
          <button onClick={() => setIsNavOpen(!isNavOpen)} className="p-2 -ml-2 text-zinc-400 md:hidden">
            {isNavOpen ? <X size={24} /> : <Menu size={24} />}
          </button>

          <div className="relative" ref={contextRef}>
            <button 
              onClick={() => setIsContextOpen(!isContextOpen)}
              className={`flex flex-col items-start p-2 rounded-lg transition-all ${isContextOpen ? 'bg-zinc-900' : 'hover:bg-zinc-900/50'}`}
            >
              <span className="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Production Context</span>
              <div className="flex items-center gap-2">
                <span className="text-sm font-bold text-white">{activeShow.title}</span>
                <ChevronsUpDown size={12} className="text-zinc-600"/>
              </div>
            </button>

            {isContextOpen && (
              <div className="absolute top-full left-0 mt-2 w-80 bg-zinc-900 border border-zinc-700 rounded-xl shadow-2xl overflow-hidden z-50 flex flex-col max-h-[75vh] animate-in fade-in slide-in-from-top-2">
                
                {/* TABS */}
                <div className="bg-zinc-950/80 p-3 border-b border-white/5 grid grid-cols-2 gap-2">
                   <button 
                     onClick={() => setViewMode('current')} 
                     className={`py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${viewMode === 'current' ? 'bg-emerald-600 text-white shadow-lg' : 'bg-zinc-800 text-zinc-500'}`}
                   >
                     Current
                   </button>
                   <button 
                     onClick={() => setViewMode('archive')} 
                     className={`py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${viewMode === 'archive' ? 'bg-blue-600 text-white shadow-lg' : 'bg-zinc-800 text-zinc-500'}`}
                   >
                     History
                   </button>
                </div>

                <div className="p-2 overflow-y-auto flex-1 custom-scrollbar">
                  {/* TAB: CURRENT (Active & Upcoming) */}
                  {viewMode === 'current' && (
                    <div className="space-y-6">
                      {groupedData.seasons.map(season => {
                        const hasActive = groupedData.active[season]?.length > 0;
                        const hasUpcoming = groupedData.upcoming[season]?.length > 0;

                        if (!hasActive && !hasUpcoming) return null;

                        return (
                          <div key={season} className="space-y-3">
                            <div className="px-3 py-1 text-[9px] font-black text-zinc-500 uppercase tracking-widest bg-zinc-950/50 rounded">
                              Season {season}
                            </div>
                            
                            {hasActive && (
                              <div className="space-y-1">
                                <div className="px-3 flex items-center gap-2 text-[8px] font-bold text-emerald-500 uppercase italic">
                                  <Clock size={10} /> Now Playing
                                </div>
                                {groupedData.active[season].map(prod => (
                                  <ProductionItem key={prod.id} prod={prod} activeId={activeId} pathname={pathname} />
                                ))}
                              </div>
                            )}

                            {hasUpcoming && (
                              <div className="space-y-1">
                                <div className="px-3 flex items-center gap-2 text-[8px] font-bold text-amber-500 uppercase italic">
                                  <Rocket size={10} /> Pre-Production
                                </div>
                                {groupedData.upcoming[season].map(prod => (
                                  <ProductionItem key={prod.id} prod={prod} activeId={activeId} pathname={pathname} />
                                ))}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {/* TAB: HISTORY (Archived) */}
                  {viewMode === 'archive' && (
                    <div className="space-y-2">
                      {groupedData.seasons.map(season => (
                        groupedData.archive[season] && (
                          <details key={season} className="group">
                            <summary className="flex items-center justify-between px-3 py-2 text-[10px] font-black text-zinc-500 uppercase bg-zinc-950/50 rounded-lg cursor-pointer hover:bg-zinc-800 list-none">
                              <div className="flex items-center gap-2"><Calendar size={12} /><span>{season}</span></div>
                              <ChevronRight size={12} className="group-open:rotate-90 transition-transform duration-200" />
                            </summary>
                            <div className="pt-2 pl-2 space-y-1">
                              {groupedData.archive[season].map(prod => (
                                <ProductionItem key={prod.id} prod={prod} activeId={activeId} pathname={pathname} />
                              ))}
                            </div>
                          </details>
                        )
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>

        {/* RIGHT: TOOLS & PROFILE */}
        <div className="flex items-center gap-4">
          <button 
            onClick={() => setShowDebug(!showDebug)} 
            className={`p-2 rounded-full transition-all ${showDebug ? 'text-amber-500 bg-amber-500/10' : 'text-zinc-700 hover:text-zinc-400'}`}
          >
            <Wrench size={18} />
          </button>
          
          <div className="relative" ref={profileRef}>
            <button onClick={() => setIsProfileOpen(!isProfileOpen)} className="flex items-center gap-3 group">
              <div className="hidden md:flex flex-col items-end leading-tight text-right">
                <span className="text-xs font-bold text-zinc-200 group-hover:text-white transition-colors">{user?.name || "Sign In"}</span>
                
                {/* üö® FIX: USE DYNAMIC ROLE FROM CONTEXT */}
                <span className={`text-[10px] font-black uppercase tracking-tighter ${isSimulating ? 'text-red-500 animate-pulse' : 'text-zinc-500'}`}>
                    {effectiveRole || "Guest"}
                </span>

              </div>
              <div className={`w-8 h-8 rounded-full bg-zinc-800 border flex items-center justify-center text-xs font-bold text-zinc-400 group-hover:border-emerald-500/50 transition-all ${isSimulating ? 'border-red-500/50 ring-2 ring-red-500/20' : 'border-zinc-700'}`}>
                {user?.image ? <img src={user.image} alt="User Avatar" className="w-full h-full rounded-full object-cover" /> : userInitials}
              </div>
            </button>

            {isProfileOpen && (
              <div className="absolute top-full right-0 mt-2 w-48 bg-zinc-900 border border-zinc-700 rounded-xl shadow-2xl p-1 z-50 animate-in fade-in slide-in-from-top-2">
                <div className="px-3 py-2 border-b border-white/5 bg-zinc-950/50 rounded-t-lg mb-1">
                  <p className="text-[9px] font-black text-zinc-500 uppercase tracking-widest mb-0.5">Session Account</p>
                  <p className="text-[11px] font-bold text-white truncate">{user?.email || "No email linked"}</p>
                </div>
                <Link href="/settings" className="flex items-center gap-2 w-full p-2 text-xs font-bold text-zinc-400 hover:bg-zinc-800 hover:text-white rounded-lg transition-colors">
                  <Settings size={14} /> Settings
                </Link>
                <button 
                  onClick={() => signOut({ callbackUrl: "/login" })} 
                  className="flex items-center gap-2 w-full p-2 text-xs font-bold text-red-400 hover:bg-red-500/10 rounded-lg transition-colors"
                >
                  <LogOut size={14} /> Sign Out
                </button>
              </div>
            )}
          </div>
        </div>
      </header>

      {/* MOBILE NAV DRAWER */}
      {isNavOpen && (
        <div className="fixed inset-0 z-[100] flex md:hidden">
          <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setIsNavOpen(false)} />
          <div ref={navRef} className="relative w-72 bg-zinc-900 h-full border-r border-zinc-800 shadow-2xl flex flex-col animate-in slide-in-from-left duration-300">
            <div className="flex-1 overflow-y-auto p-4 space-y-6 pt-10">
              <SectionHeader label="Workspace" />
              <div className="space-y-1">
                <MenuLink onClick={() => setIsNavOpen(false)} href="/schedule" icon={<Calendar size={18}/>} label="Scheduler" active={pathname === '/schedule'} />
                <MenuLink onClick={() => setIsNavOpen(false)} href="/auditions" icon={<Mic2 size={18}/>} label="Auditions" active={pathname === '/auditions'} />
                <MenuLink onClick={() => setIsNavOpen(false)} href="/casting" icon={<LayoutGrid size={18}/>} label="Cast Grid" active={pathname === '/casting'} />
              </div>
              <SectionHeader label="Company" />
              <div className="space-y-1">
                <MenuLink onClick={() => setIsNavOpen(false)} href="/roster" icon={<UserSquare2 size={18}/>} label="Roster" active={pathname === '/roster'} />
                <MenuLink onClick={() => setIsNavOpen(false)} href="/reports" icon={<BarChart3 size={18}/>} label="Analytics" active={pathname === '/reports'} />
              </div>
            </div>
            <div className="p-4 border-t border-white/5 bg-zinc-950/50">
               <button onClick={() => signOut({ callbackUrl: "/login" })} className="flex items-center gap-3 w-full p-2 text-zinc-500 hover:text-red-400 transition-colors">
                  <LogOut size={16} /> <span className="text-xs font-bold uppercase">Sign Out</span>
               </button>
            </div>
          </div>
        </div>
      )}

      {/* DEBUG CONSOLE */}
      {showDebug && (
        <div className="fixed bottom-4 right-4 w-80 bg-black/90 border border-amber-500/50 rounded-xl p-4 font-mono text-[10px] text-amber-500 z-[100] shadow-2xl backdrop-blur-xl animate-in zoom-in-95">
          <p className="font-black border-b border-amber-500/20 mb-2 pb-1 flex items-center gap-2"><Bug size={12}/> DATA STREAM DEBUG</p>
          <div className="space-y-1">
            <p>Total Records: {shows.length}</p>
            <p className="mt-2 text-white font-black italic">ACTIVE / UPCOMING MAP:</p>
            {shows.filter(s => s.isActive || s.status === 'Upcoming' || s.status === 'Pre-Production').map(s => (
              <div key={s.id}>‚Ä¢ {s.title} (Status: {s.status})</div>
            ))}
          </div>
        </div>
      )}
    </>
  );
}

// --- SUB COMPONENTS ---

function ProductionItem({ prod, activeId, pathname }: { prod: any, activeId: number, pathname: string }) {
  return (
    <form action={switchProduction}>
      <input type="hidden" name="productionId" value={prod.id} />
      <input type="hidden" name="redirectPath" value={pathname} />
      <ContextButton prod={prod} isActive={prod.id === activeId} />
    </form>
  )
}

function SectionHeader({ label }: { label: string }) {
  return <div className="px-3 mb-2 text-[10px] font-black text-zinc-600 uppercase tracking-widest">{label}</div>
}

function MenuLink({ href, icon, label, active, onClick }: any) {
  return (
    <Link 
      href={href} 
      onClick={onClick}
      className={`flex items-center gap-4 px-3 py-3 rounded-xl transition-all ${active ? 'bg-emerald-600 text-white shadow-lg' : 'text-zinc-400 hover:bg-zinc-800 hover:text-white'}`}
    >
      {icon}
      <span className="font-bold text-sm">{label}</span>
      {active && <ChevronRight size={14} className="ml-auto opacity-50"/>}
    </Link>
  )
}

function ContextButton({ prod, isActive }: { prod: any, isActive: boolean }) {
  const { pending } = useFormStatus();
  return (
    <button
      disabled={pending}
      className={`w-full flex items-start gap-3 p-2 rounded-lg transition-all text-left group ${isActive ? 'bg-zinc-800 ring-1 ring-zinc-700' : 'hover:bg-zinc-800/50'}`}
    >
      <div className={`w-1.5 h-1.5 rounded-full mt-1.5 shrink-0 ${prod.location?.includes('Fred') ? 'bg-emerald-500' : 'bg-zinc-500'}`} />
      <div className="flex-1 min-w-0">
        <div className={`text-xs truncate ${isActive ? 'text-white font-bold' : 'text-zinc-300'}`}>{prod.title}</div>
        <div className="text-[9px] font-black text-zinc-600 uppercase tracking-tight">
          {prod.location || "Unknown"} ‚Ä¢ {prod.status}
        </div>
      </div>
      {pending && <Sparkles size={12} className="text-emerald-500 animate-spin" />}
    </button>
  );
}
</file>

<file path="app/(main)/education/AcademyClient.tsx">
/* eslint-disable react-hooks/set-state-in-effect */
"use client";

import { useState, useMemo, useEffect } from 'react';
import Link from 'next/link';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, 
  ResponsiveContainer, Cell 
} from 'recharts';
import { 
  LayoutGrid, UserSquare2, MapPin, Search, 
  ClipboardList, Users, School, Building2, Calendar, 
  AlertTriangle, Info, ChevronDown, Filter, X,
  Music, Drama, Mic2, Palette, Monitor, Baby, Map
} from 'lucide-react';

// --- HELPERS ---

// 1. Season Sorter (Winter 2026 > Fall 2025)
const SEASON_ORDER: Record<string, number> = {
  "Winter": 1, "Spring": 2, "Summer": 3, "Fall": 4
};

const getSessionScore = (sessionName: string) => {
  const parts = sessionName.split(' ');
  if (parts.length < 2) return 0;
  const season = parts[0];
  const year = parseInt(parts[1]);
  if (isNaN(year)) return 0;
  // Score = Year * 10 + SeasonWeight (e.g. 2026 * 10 + 1 = 20261)
  return (year * 10) + (SEASON_ORDER[season] || 0);
};

// 2. Icon Helper
const getTypeIcon = (type: string) => {
    const t = (type || "").toLowerCase();
    if (t.includes('dance')) return <Music size={14}/>;
    if (t.includes('acting') || t.includes('drama')) return <Drama size={14}/>;
    if (t.includes('voice') || t.includes('musical')) return <Mic2 size={14}/>;
    if (t.includes('tech')) return <Monitor size={14}/>;
    if (t.includes('younger')) return <Baby size={14}/>;
    return <Palette size={14}/>; 
};

export default function AcademyClient({ classes = [], venues = [] }: { classes: any[], venues: any[] }) {
  
  // --- 1. DERIVE OPTIONS (SESSIONS, TYPES, AGES) ---
  const { sessions, ageRanges, types } = useMemo(() => {
    const s = new Set<string>();
    const a = new Set<string>();
    const t = new Set<string>();

    classes.forEach(c => {
      if (c.session) s.add(c.session);
      if (c.ageRange) a.add(c.ageRange);
      if (c.type && c.type !== "General") t.add(c.type);
    });

    // Sort Sessions Chronologically (Newest First)
    const sortedSessions = Array.from(s).sort((a, b) => getSessionScore(b) - getSessionScore(a));

    return { 
      sessions: sortedSessions, 
      ageRanges: Array.from(a).sort(),
      types: Array.from(t).sort()
    };
  }, [classes]);

  // --- 2. STATE ---
  const [activeTab, setActiveTab] = useState<'manager' | 'logistics' | 'overview' | 'teachers'>('manager');
  const [activeSession, setActiveSession] = useState(sessions[0] || "");
  const [search, setSearch] = useState("");
  
  // Filters
  const [activeDay, setActiveDay] = useState<string | null>(null);
  const [activeAge, setActiveAge] = useState<string | null>(null);
  const [activeType, setActiveType] = useState<string | null>(null);

  // Sync session if data loads late
  useEffect(() => {
    if (sessions.length > 0 && !sessions.includes(activeSession)) {
      setActiveSession(sessions[0]);
    }
  }, [sessions, activeSession]);

  // --- 3. MASTER FILTER LOGIC ---
  const filteredClasses = useMemo(() => {
    return classes.filter(c => {
      // A. Session Match
      if (c.session !== activeSession) return false;

      // B. Search Match (Name, Teacher, Location)
      if (search) {
        const term = search.toLowerCase();
        if (!c.name.toLowerCase().includes(term) && 
            !c.teacher.toLowerCase().includes(term) &&
            !c.location.toLowerCase().includes(term)) return false;
      }

      // C. Sidebar Filters
      if (activeDay && c.day !== activeDay) return false;
      if (activeAge && c.ageRange !== activeAge) return false;
      if (activeType && c.type !== activeType) return false;

      return true;
    });
  }, [classes, activeSession, search, activeDay, activeAge, activeType]);

  // --- 4. DERIVED DATA FOR TABS ---

  // Logistics: Map filtered classes to Venues
  const activeVenues = useMemo(() => {
    const activeClassIds = new Set(filteredClasses.map(c => c.id));
    
    return venues.map(venue => {
        const activeSpaces = venue.spaces.map((space: any) => {
            const relevantClasses = space.classes.filter((c: any) => activeClassIds.has(c.id));
            return { ...space, classes: relevantClasses };
        });

        // Only show venues that have classes matching the current filter
        const hasClasses = activeSpaces.some((s:any) => s.classes.length > 0);
        if (hasClasses) {
            return { ...venue, spaces: activeSpaces };
        }
        return null;
    }).filter(Boolean);
  }, [venues, filteredClasses]);

  // Analytics: Stats for Charts
  const stats = useMemo(() => {
    const teachers: Record<string, number> = {};
    const classTypes: Record<string, number> = {};
    
    filteredClasses.forEach(c => {
      teachers[c.teacher] = (teachers[c.teacher] || 0) + c.students;
      classTypes[c.name] = (classTypes[c.name] || 0) + c.students;
    });
    
    return {
      teacherData: Object.entries(teachers)
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count),
      classData: Object.entries(classTypes)
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 10) // Top 10
    };
  }, [filteredClasses]);

  // --- 5. RENDER ---
  return (
    <div className="h-full flex flex-col bg-zinc-950 text-white">
      
      {/* HEADER TOOLBAR */}
      <div className="px-6 py-4 border-b border-white/5 bg-zinc-900/50 backdrop-blur-md z-20 flex flex-col md:flex-row md:items-center justify-between gap-4">
        
        {/* Left: Tab Switcher */}
        <div className="flex gap-2 bg-zinc-950/50 p-1 rounded-xl border border-white/5 overflow-x-auto shrink-0">
          <TabButton active={activeTab === 'manager'} onClick={() => setActiveTab('manager')} icon={<ClipboardList size={14}/>} label="Classes" />
          <TabButton active={activeTab === 'logistics'} onClick={() => setActiveTab('logistics')} icon={<Map size={14}/>} label="Logistics" />
          <TabButton active={activeTab === 'overview'} onClick={() => setActiveTab('overview')} icon={<LayoutGrid size={14}/>} label="Trends" />
          <TabButton active={activeTab === 'teachers'} onClick={() => setActiveTab('teachers')} icon={<UserSquare2 size={14}/>} label="Faculty" />
        </div>

        {/* Right: Global Filters */}
        <div className="flex gap-4 items-center flex-1 justify-end">
             {/* Session Dropdown */}
             <div className="relative group">
                <select 
                  value={activeSession}
                  onChange={(e) => setActiveSession(e.target.value)}
                  className="appearance-none bg-transparent text-lg font-black italic tracking-tighter text-white pr-8 outline-none cursor-pointer text-right"
                >
                  {sessions.map(s => (
                    <option key={s} value={s} className="bg-zinc-900 text-sm font-sans not-italic">{s}</option>
                  ))}
                </select>
                <ChevronDown size={14} className="absolute right-0 top-1/2 -translate-y-1/2 text-zinc-500 pointer-events-none group-hover:text-white transition-colors" />
             </div>

             {/* Search */}
             <div className="relative">
                <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500" />
                <input 
                  type="text" 
                  placeholder="Search..." 
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                  className="bg-zinc-950 border border-white/10 rounded-full pl-9 pr-4 py-1.5 text-xs text-white focus:outline-none focus:border-blue-500/50 transition-all w-40 focus:w-64"
                />
             </div>
        </div>
      </div>

      <div className="flex-1 flex overflow-hidden">
        
        {/* SIDEBAR FILTERS (Always Visible) */}
        <aside className="w-64 border-r border-white/5 bg-zinc-900/30 overflow-y-auto custom-scrollbar p-6 space-y-8 shrink-0 hidden md:block">
            {/* TYPE FILTER */}
            <div>
                <h3 className="text-[10px] font-black uppercase text-zinc-500 tracking-widest mb-3 flex items-center gap-2">
                    <Filter size={10}/> Class Type
                </h3>
                <div className="space-y-1">
                    {types.map(type => (
                        <FilterButton 
                            key={type}
                            label={type} 
                            active={activeType === type} 
                            icon={getTypeIcon(type)} 
                            onClick={() => setActiveType(activeType === type ? null : type)} 
                        />
                    ))}
                </div>
            </div>

            {/* AGE FILTER */}
            <div>
                <h3 className="text-[10px] font-black uppercase text-zinc-500 tracking-widest mb-3">Age Range</h3>
                <div className="flex flex-wrap gap-2">
                    {ageRanges.map(age => (
                        <button
                            key={age}
                            onClick={() => setActiveAge(activeAge === age ? null : age)}
                            className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${
                                activeAge === age 
                                    ? 'bg-emerald-600 border-emerald-500 text-white' 
                                    : 'bg-zinc-900 border-white/5 text-zinc-400 hover:border-white/10 hover:text-white'
                            }`}
                        >
                            {age}
                        </button>
                    ))}
                </div>
            </div>

            {/* DAY FILTER */}
            <div>
                <h3 className="text-[10px] font-black uppercase text-zinc-500 tracking-widest mb-3">Day of Week</h3>
                <div className="space-y-1">
                    {['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].map(day => (
                        <button 
                            key={day}
                            onClick={() => setActiveDay(activeDay === day ? null : day)}
                            className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-xs font-bold transition-all ${
                                activeDay === day 
                                    ? 'bg-zinc-800 text-white' 
                                    : 'text-zinc-500 hover:bg-zinc-800/50 hover:text-zinc-300'
                            }`}
                        >
                            <span>{day}</span>
                            {activeDay === day && <X size={12} />}
                        </button>
                    ))}
                </div>
            </div>
            
            <div className="pt-4 border-t border-white/5">
                <button 
                    onClick={() => { setActiveDay(null); setActiveAge(null); setActiveType(null); setSearch(""); }}
                    className="w-full py-2 text-xs font-bold text-zinc-500 hover:text-white transition-colors flex items-center justify-center gap-2"
                >
                    <X size={12}/> Clear Filters
                </button>
            </div>
        </aside>

        {/* MAIN CONTENT AREA */}
        <main className="flex-1 overflow-y-auto custom-scrollbar p-6 bg-black/20">
            
            {/* TAB 1: CLASS MANAGER */}
            {activeTab === 'manager' && (
                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 animate-in fade-in slide-in-from-bottom-4">
                    {filteredClasses.length > 0 ? (
                        filteredClasses.map(cls => (
                            <ClassCard key={cls.id} cls={cls} />
                        ))
                    ) : (
                        <EmptyState session={activeSession} />
                    )}
                </div>
            )}

            {/* TAB 2: LOGISTICS */}
            {activeTab === 'logistics' && (
                <div className="grid grid-cols-1 xl:grid-cols-2 gap-8 animate-in fade-in slide-in-from-bottom-4">
                   {activeVenues.length > 0 ? (
                     activeVenues.map((venue: any) => (
                      <VenueCard key={venue.id} venue={venue} />
                     ))
                   ) : (
                     <EmptyState session={activeSession} />
                   )}
                </div>
            )}

            {/* TAB 3: TRENDS */}
            {activeTab === 'overview' && (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in fade-in slide-in-from-bottom-4">
                    <div className="lg:col-span-2 bg-zinc-900/50 border border-white/5 p-8 rounded-[2.5rem] min-w-0 relative overflow-hidden">
                        <h3 className="text-xs font-black text-white uppercase tracking-widest mb-8 flex items-center gap-2">
                            <LayoutGrid size={16} className="text-blue-500" /> Top Classes ({activeSession})
                        </h3>
                        <div className="h-[400px]">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={stats.classData} layout="vertical">
                                    <CartesianGrid strokeDasharray="3 3" stroke="#18181b" horizontal={false} />
                                    <XAxis type="number" stroke="#3f3f46" tick={{fill: '#71717a', fontSize: 10}} />
                                    <YAxis dataKey="name" type="category" width={140} stroke="#3f3f46" tick={{fill: '#71717a', fontSize: 10, fontWeight: 'bold'}} />
                                    <Tooltip cursor={{fill: '#27272a'}} contentStyle={{ backgroundColor: '#09090b', borderColor: '#27272a', borderRadius: '16px' }} />
                                    <Bar dataKey="count" radius={[0, 4, 4, 0]} barSize={24}>
                                        {stats.classData.map((e, i) => <Cell key={i} fill={i < 3 ? '#3b82f6' : '#27272a'} />)}
                                    </Bar>
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                    {/* Highlights */}
                    <div className="bg-zinc-900/50 border border-white/5 p-6 rounded-[2rem] flex flex-col">
                        <h3 className="text-xs font-black text-white uppercase tracking-widest mb-6">Highlights</h3>
                        <div className="p-4 bg-zinc-950 rounded-xl border border-white/5 mb-4">
                            <p className="text-[10px] font-bold text-zinc-500 uppercase">Top Class</p>
                            <p className="text-lg font-black text-white truncate">{stats.classData[0]?.name || "N/A"}</p>
                            <p className="text-xs text-blue-500 font-bold">{stats.classData[0]?.count || 0} Students</p>
                        </div>
                    </div>
                </div>
            )}

            {/* TAB 4: FACULTY */}
            {activeTab === 'teachers' && (
                <div className="bg-zinc-900/50 border border-white/5 p-8 rounded-[2.5rem] animate-in fade-in slide-in-from-bottom-4 min-w-0">
                    <h3 className="text-xs font-black text-white uppercase tracking-widest mb-8 flex items-center gap-2">
                        <UserSquare2 size={16} className="text-purple-500" /> Instructor Load ({activeSession})
                    </h3>
                    <div className="h-[400px]">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={stats.teacherData}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#18181b" vertical={false} />
                                <XAxis dataKey="name" stroke="#3f3f46" tick={{fill: '#71717a', fontSize: 10}} />
                                <YAxis stroke="#3f3f46" tick={{fill: '#71717a', fontSize: 10}} />
                                <Tooltip contentStyle={{ backgroundColor: '#09090b', borderColor: '#27272a', borderRadius: '16px' }} />
                                <Bar dataKey="count" fill="#8b5cf6" radius={[6, 6, 0, 0]} />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            )}

        </main>
      </div>
    </div>
  );
}

// --- SUB COMPONENTS ---

function FilterButton({ label, active, icon, onClick }: any) {
    return (
        <button 
            onClick={onClick}
            className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-xs font-bold transition-all ${
                active 
                    ? 'bg-emerald-600 text-white shadow-lg' 
                    : 'bg-zinc-900 text-zinc-400 hover:bg-zinc-800 hover:text-white'
            }`}
        >
            {icon}
            <span>{label}</span>
            {active && <X size={12} className="ml-auto"/>}
        </button>
    )
}

function TabButton({ active, onClick, icon, label }: { active: boolean, onClick: () => void, icon: any, label: string }) {
  return (
    <button onClick={onClick} className={`px-4 py-2 rounded-lg flex items-center gap-2 text-[10px] font-black uppercase tracking-widest transition-all ${active ? 'bg-zinc-100 text-black shadow-lg scale-[1.02]' : 'text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800'}`}>
      {icon} <span className="hidden sm:inline">{label}</span>
    </button>
  );
}

function EmptyState({ session }: { session: string }) {
    return (
        <div className="col-span-full py-20 text-center text-zinc-500 italic border-2 border-dashed border-zinc-800 rounded-3xl">
            <Info size={32} className="mx-auto text-zinc-700 mb-3" />
            <p className="text-sm font-bold">No data found</p>
            <p className="text-xs text-zinc-600 mt-1">Try adjusting filters or selecting a different season than <strong>{session}</strong>.</p>
        </div>
    )
}

function ClassCard({ cls }: { cls: any }) {
    // Determine color accent based on type
    const isDance = cls.type?.toLowerCase().includes('dance');
    const isActing = cls.type?.toLowerCase().includes('acting') || cls.type?.toLowerCase().includes('drama');
    
    return (
        <div className="group bg-zinc-900/40 border border-white/5 hover:border-white/10 hover:bg-zinc-900/60 rounded-2xl p-5 transition-all flex flex-col h-full relative overflow-hidden">
            <div className={`absolute top-0 right-0 w-24 h-24 bg-gradient-to-br rounded-bl-full -mr-8 -mt-8 pointer-events-none opacity-10 ${
                isDance ? 'from-pink-500 to-transparent' : isActing ? 'from-blue-500 to-transparent' : 'from-white to-transparent'
            }`} />

            <div className="mb-4">
                <div className="flex items-start justify-between gap-4">
                    <h3 className="font-bold text-zinc-100 leading-tight group-hover:text-emerald-400 transition-colors">
                        {cls.name}
                    </h3>
                    <div className="flex flex-col items-end gap-1">
                        <span className="shrink-0 px-2 py-1 bg-white/5 rounded text-[10px] font-bold text-zinc-500 border border-white/5 uppercase tracking-wide whitespace-nowrap">
                            {cls.ageRange}
                        </span>
                        {cls.type && cls.type !== "General" && (
                            <span className="text-[9px] font-black uppercase tracking-wider text-zinc-600">
                                {cls.type}
                            </span>
                        )}
                    </div>
                </div>
                <p className="text-xs text-zinc-500 font-medium mt-1 flex items-center gap-1">
                    <School size={10}/> {cls.teacher}
                </p>
            </div>

            <div className="mt-auto space-y-2 pt-4 border-t border-white/5">
                <div className="flex items-center justify-between">
                     <div className="flex items-center gap-2 text-xs text-zinc-400">
                        <Calendar size={14} className="text-zinc-600"/>
                        <span className="font-bold text-zinc-300">{cls.day}</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs text-zinc-500">
                        <Users size={14} className="text-zinc-600"/>
                        <span>{cls.students} Enrolled</span>
                    </div>
                </div>
                
                <div className="grid grid-cols-2 gap-2 mt-2">
                    <Link href={`/education/class/${cls.id}/attendance`} className="flex items-center justify-center gap-2 py-2 rounded-lg bg-black/20 text-zinc-500 hover:bg-black/40 hover:text-white text-[10px] font-bold uppercase transition-colors">
                        Attendance
                    </Link>
                    <Link href={`/education/class/${cls.id}`} className="flex items-center justify-center gap-2 py-2 rounded-lg bg-black/20 text-zinc-500 hover:bg-black/40 hover:text-white text-[10px] font-bold uppercase transition-colors">
                        Roster
                    </Link>
                </div>
            </div>
        </div>
    )
}

function VenueCard({ venue }: { venue: any }) {
    return (
        <div className="bg-zinc-900/50 border border-white/5 rounded-[2rem] overflow-hidden flex flex-col">
            <div className="p-6 border-b border-white/5 bg-zinc-950/30 flex justify-between items-start">
            <div className="flex gap-4">
                <div className="w-12 h-12 rounded-2xl bg-zinc-800 flex items-center justify-center text-purple-500"><Building2 size={24} /></div>
                <div>
                <h3 className="text-lg font-black text-white">{venue.name}</h3>
                <div className="flex gap-2 text-[10px] font-bold uppercase tracking-widest mt-1">
                    <span className="text-zinc-500">{venue.type}</span><span className="text-zinc-600">‚Ä¢</span>
                    <span className="text-zinc-500">{venue.spaces.length} Rooms</span>
                </div>
                </div>
            </div>
            <div className="text-right">
                <div className="px-3 py-1 bg-purple-500/10 rounded-lg text-[10px] font-bold text-purple-400 border border-purple-500/20">${venue.rates.hourly}/hr</div>
            </div>
            </div>

            <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            {venue.spaces.map((space: any) => {
                // Calculate utilization based on *filtered* classes
                const currentStudents = space.classes.reduce((acc:number, c:any) => acc + c.students, 0);
                const utilization = Math.round((currentStudents / (space.capacity * Math.max(1, space.classes.length))) * 100) || 0;
                const isOver = utilization > 100;
                const hasClasses = space.classes.length > 0;

                return (
                <div key={space.id} className={`p-4 rounded-2xl border transition-all ${hasClasses ? 'bg-zinc-950 border-white/5 hover:border-purple-500/30' : 'bg-zinc-950/30 border-dashed border-zinc-800'}`}>
                    <div className="flex justify-between items-start mb-4">
                    <div>
                        <h4 className={`text-sm font-bold ${hasClasses ? 'text-white' : 'text-zinc-600'}`}>{space.name}</h4>
                        {hasClasses ? (
                        <div className="mt-1 flex flex-col gap-1">
                            {space.classes.map((cls:any) => (
                            <span key={cls.id} className="text-[9px] text-zinc-400 truncate max-w-[150px] block">‚Ä¢ {cls.name}</span>
                            ))}
                        </div>
                        ) : (
                        <span className="text-[9px] text-zinc-700 italic mt-1 block">Empty</span>
                        )}
                    </div>
                    {hasClasses && <div className={`text-xs font-black ${isOver ? 'text-red-500' : 'text-emerald-500'}`}>{utilization}%</div>}
                    </div>
                    
                    {hasClasses && (
                    <div className="space-y-1.5 mt-2">
                        <div className="h-2 w-full bg-zinc-900 rounded-full overflow-hidden border border-white/5">
                        <div className={`h-full rounded-full ${isOver ? 'bg-red-500' : 'bg-purple-500'}`} style={{ width: `${Math.min(100, utilization)}%` }} />
                        </div>
                        {isOver && <div className="flex items-center gap-1 text-[9px] font-bold text-red-500 mt-1 animate-pulse"><AlertTriangle size={10} /> OVERFLOW</div>}
                    </div>
                    )}
                </div>
                );
            })}
            </div>
        </div>
    )
}
</file>

<file path="app/lib/baserow.ts">
// app/lib/baserow.ts

import { notFound } from "next/navigation";
import { DB } from "@/app/lib/schema"; 

// --- CONFIGURATION ---
const BASE_URL = (process.env.NEXT_PUBLIC_BASEROW_URL || "https://api.baserow.io").replace(/\/$/, "");
const API_TOKEN = process.env.NEXT_PUBLIC_BASEROW_TOKEN || process.env.BASEROW_API_TOKEN || process.env.BASEROW_API_KEY;

const HEADERS = {
  "Authorization": `Token ${API_TOKEN}`,
  "Content-Type": "application/json",
};

// ==============================================================================
// üõ°Ô∏è HELPERS
// ==============================================================================

export async function fetchBaserow(endpoint: string, options: RequestInit = {}, queryParams: Record<string, any> = {}) {
  try {
    const params = new URLSearchParams(queryParams);
    let path = endpoint;
    if (!path.startsWith("http") && !path.startsWith("/api")) {
        if (!path.startsWith("/")) path = `/${path}`;
        path = `/api${path}`;
    }
    const finalUrl = `${BASE_URL}${path}${path.includes('?') ? '&' : '?'}${params.toString()}`;

    const res = await fetch(finalUrl, {
      ...options,
      headers: { ...HEADERS, ...options.headers },
      cache: options.cache || "no-store", 
    });

    if (!res.ok) {
      if (res.status === 404) return []; 
      console.error(`‚ùå [Baserow] API Error [${res.status}] at ${finalUrl}`);
      return []; 
    }

    const data = await res.json();
    if (data && data.results && Array.isArray(data.results)) return data.results;
    return data;

  } catch (error) {
    console.error("‚ùå [Baserow] Network/Fetch Error:", error);
    return [];
  }
}

function safeGet(field: any, fallback: string | number = ""): any {
  if (field === null || field === undefined) return fallback;
  if (typeof field === 'string' || typeof field === 'number' || typeof field === 'boolean') return field;
  if (Array.isArray(field)) {
    if (field.length === 0) return fallback;
    const first = field[0];
    return first.value || first.name || first.url || fallback;
  }
  if (typeof field === 'object') {
    return field.value || field.name || fallback;
  }
  return fallback;
}

function safeId(field: any): number | null {
  if (Array.isArray(field) && field.length > 0) return field[0].id;
  return null;
}

function extractName(field: any, fallback: string = ""): string {
  if (!field) return fallback;
  if (Array.isArray(field) && field.length > 0) return field[0].value || fallback;
  if (typeof field === "string") return field;
  return fallback;
}

export async function deleteRow(tableId: string, rowId: number | string) {
  const url = `/database/rows/table/${tableId}/${rowId}/`;
  const res = await fetchBaserow(url, { method: "DELETE" });
  return res !== null;
}

// ==============================================================================
// üéì EDUCATION (CLASSES & VENUES)
// ==============================================================================

export async function getClasses() {
  let allRows: any[] = [];
  let page = 1;
  let hasMore = true;

  while (hasMore) {
    const data = await fetchBaserow(
      `/database/rows/table/${DB.CLASSES.ID}/`, 
      {}, 
      { page: page.toString(), size: "200" } 
    );

    if (!Array.isArray(data) || data.length === 0) {
      hasMore = false;
    } else {
      allRows = [...allRows, ...data];
      if (data.length < 200) hasMore = false;
      else page++;
    }
  }

  return allRows.map((row: any) => ({
      id: row.id,
      name: safeGet(row[DB.CLASSES.FIELDS.CLASS_NAME], "Unnamed Class"),
      session: safeGet(row[DB.CLASSES.FIELDS.SESSION], "Unknown Session"),
      teacher: safeGet(row[DB.CLASSES.FIELDS.TEACHER], "TBA"),
      location: safeGet(row[DB.CLASSES.FIELDS.LOCATION], "Main Campus"),
      spaceId: safeId(row[DB.CLASSES.FIELDS.SPACE]),
      spaceName: safeGet(row[DB.CLASSES.FIELDS.SPACE]),
      day: safeGet(row[DB.CLASSES.FIELDS.DAY], "TBD"),
      time: safeGet(row[DB.CLASSES.FIELDS.TIME_SLOT], "TBD"),
      type: safeGet(row[DB.CLASSES.FIELDS.TYPE], "General"),
      ageRange: safeGet(row[DB.CLASSES.FIELDS.AGE_RANGE], "All Ages"),
      students: Array.isArray(row[DB.CLASSES.FIELDS.STUDENTS]) ? row[DB.CLASSES.FIELDS.STUDENTS].length : 0,
  }));
}

export async function getClassById(classId: string) {
  const row = await fetchBaserow(`/database/rows/table/${DB.CLASSES.ID}/${classId}/`);
  if (!row || row.error) return null;

  const students = row[DB.CLASSES.FIELDS.STUDENTS] || []; 
  
  return {
    id: row.id,
    name: safeGet(row[DB.CLASSES.FIELDS.CLASS_NAME], "Unnamed Class"),
    session: safeGet(row[DB.CLASSES.FIELDS.SESSION], "Unknown"),
    teacher: safeGet(row[DB.CLASSES.FIELDS.TEACHER], "TBA"),
    location: safeGet(row[DB.CLASSES.FIELDS.LOCATION], "Main Campus"),
    day: safeGet(row[DB.CLASSES.FIELDS.DAY], "TBD"),
    time: safeGet(row[DB.CLASSES.FIELDS.TIME_SLOT], "TBD"),
    description: "", 
    ageRange: safeGet(row[DB.CLASSES.FIELDS.AGE_RANGE], "All Ages"),
    spaceName: safeGet(row[DB.CLASSES.FIELDS.SPACE]),
    students: Array.isArray(students) ? students.length : 0,
  };
}

export async function getClassRoster(classId: string) {
  if (!classId) return [];

  const params = {
    filter_type: "OR",
    [`filter__${DB.PEOPLE.FIELDS.CLASSES}__link_row_has`]: classId,          
    [`filter__${DB.PEOPLE.FIELDS.CLASSES_STUDENTS}__link_row_has`]: classId, 
    size: "200"
  };

  const students = await fetchBaserow(`/database/rows/table/${DB.PEOPLE.ID}/`, {}, params);
  if (!Array.isArray(students)) return [];

  return students.map((s: any) => ({
    id: s.id,
    name: safeGet(s[DB.PEOPLE.FIELDS.FULL_NAME] || s[DB.PEOPLE.FIELDS.FIRST_NAME]),
    age: parseInt(safeGet(s[DB.PEOPLE.FIELDS.AGE], 0)),
    email: safeGet(s[DB.PEOPLE.FIELDS.CYT_ACCOUNT_PERSONAL_EMAIL] || s[DB.PEOPLE.FIELDS.CYT_NATIONAL_INDIVIDUAL_EMAIL]),
    phone: safeGet(s[DB.PEOPLE.FIELDS.PHONE_NUMBER]),
    photo: s[DB.PEOPLE.FIELDS.HEADSHOT]?.[0]?.url || null,
    status: s[DB.PEOPLE.FIELDS.CLASSES]?.some((c:any) => c.id == classId) ? "Instructor" : "Student",
    medical: safeGet(s[DB.PEOPLE.FIELDS.MEDICAL_NOTES], "None"),
  }));
}

export async function getVenueLogistics() {
  const [venuesData, spacesData, ratesData, classesData] = await Promise.all([
    fetchBaserow(`/database/rows/table/${DB.VENUES.ID}/`, {}, { size: "200" }),
    fetchBaserow(`/database/rows/table/${DB.SPACES.ID}/`, {}, { size: "200" }),
    fetchBaserow(`/database/rows/table/${DB.RENTAL_RATES.ID}/`, {}, { size: "200" }),
    getClasses()
  ]);

  if (!Array.isArray(venuesData) || !Array.isArray(spacesData)) return [];

  return venuesData.map((venue: any) => {
    const activeRate = ratesData.find((r: any) => {
        const linkedVenues = r[DB.RENTAL_RATES.FIELDS.VENUE] || [];
        return linkedVenues.some((v: any) => v.id === venue.id);
    });

    const venueSpaces = spacesData
      .filter((space: any) => {
          const linkedVenues = space[DB.SPACES.FIELDS.VENUE] || [];
          return linkedVenues.some((v: any) => v.id === venue.id);
      })
      .map((space: any) => {
        const occupiedBy = classesData.filter((cls: any) => cls.spaceId === space.id);
        return {
          id: space.id,
          name: safeGet(space[DB.SPACES.FIELDS.ROOM_NAME] || space[DB.SPACES.FIELDS.FULL_ROOM_NAME], "Unnamed Room"),
          capacity: parseInt(safeGet(space[DB.SPACES.FIELDS.CAPACITY], 0)),
          floorType: safeGet(space[DB.SPACES.FIELDS.FLOOR_TYPE], "Unknown"),
          classes: occupiedBy
        };
      });

    return {
      id: venue.id,
      name: safeGet(venue[DB.VENUES.FIELDS.VENUE_NAME], "Unknown Venue"),
      type: safeGet(venue[DB.VENUES.FIELDS.TYPE], "General"),
      contact: safeGet(venue[DB.VENUES.FIELDS.CONTACT_NAME], "N/A"),
      spaces: venueSpaces,
      rates: {
        hourly: parseFloat(safeGet(activeRate?.[DB.RENTAL_RATES.FIELDS.HOURLY_RATE], 0)),
        weekend: parseFloat(safeGet(activeRate?.[DB.RENTAL_RATES.FIELDS.WEEKEND_RATE], 0)),
        flat: parseFloat(safeGet(activeRate?.[DB.RENTAL_RATES.FIELDS.FLAT_RATE], 0)),
      }
    };
  });
}

// ==============================================================================
// üé≠ PRODUCTION & CASTING
// ==============================================================================

function mapShow(row: any) {
  const rawStatus = safeGet(row[DB.PRODUCTIONS.FIELDS.STATUS], "Archived");
  return {
    id: row.id,
    title: safeGet(row[DB.PRODUCTIONS.FIELDS.TITLE] || row[DB.PRODUCTIONS.FIELDS.FULL_TITLE], "Untitled Show"),
    season: safeGet(row[DB.PRODUCTIONS.FIELDS.SEASON], "Unknown Season"),
    status: rawStatus,
    isActive: safeGet(row[DB.PRODUCTIONS.FIELDS.IS_ACTIVE]) === true || rawStatus === "Active",
    image: row[DB.PRODUCTIONS.FIELDS.SHOW_IMAGE]?.[0]?.url || null,
    location: safeGet(row[DB.PRODUCTIONS.FIELDS.LOCATION]) || safeGet(row[DB.PRODUCTIONS.FIELDS.VENUE]) || "TBD",
    workflowOverrides: row[DB.PRODUCTIONS.FIELDS.WORKFLOW_OVERRIDES] || [] 
  };
}

export async function getActiveProduction() {
  const data = await fetchBaserow(`/database/rows/table/${DB.PRODUCTIONS.ID}/`, {}, { size: "50" });
  if (!Array.isArray(data)) return null;
  
  const activeRow = data.find((r: any) => 
    safeGet(r[DB.PRODUCTIONS.FIELDS.IS_ACTIVE]) === true || 
    safeGet(r[DB.PRODUCTIONS.FIELDS.STATUS]) === 'Active'
  ) || data[0];

  return activeRow ? mapShow(activeRow) : null;
}

export async function getShowById(id: string | number) {
  const data = await fetchBaserow(`/database/rows/table/${DB.PRODUCTIONS.ID}/${id}/`);
  if (!data || data.error) return null;
  return mapShow(data);
}

export async function getAllShows() {
  const data = await fetchBaserow(`/database/rows/table/${DB.PRODUCTIONS.ID}/`, {}, { size: "200" });
  if (!Array.isArray(data)) return [];
  return data.map(mapShow).sort((a: any, b: any) => b.id - a.id);
}

// ==============================================================================
// üëØ CASTING & PEOPLE (READ & WRITE)
// ==============================================================================

export async function getPeople() {
  const F = DB.PEOPLE.FIELDS;
  const params = { size: "200", user_field_names: "true" };
  const data = await fetchBaserow(`/database/rows/table/${DB.PEOPLE.ID}/`, {}, params);
  if (!Array.isArray(data)) return [];

  return data.map((row: any) => ({
    id: row.id,
    name: `${row[F.FIRST_NAME]} ${row[F.LAST_NAME]}`.trim(),
    headshot: row[F.HEADSHOT]?.[0]?.url || null
  }));
}

export async function getRoles() {
  const F = DB.ROLES.FIELDS;
  const data = await fetchBaserow(`/database/rows/table/${DB.ROLES.ID}/`, {}, { size: "200", user_field_names: "true" });
  if (!Array.isArray(data)) return [];

  return data.map((row: any) => ({
    id: row.id,
    name: row[F.NAME],
    type: row[F.TYPE]
  }));
}

export async function getAssignments(productionId?: number) {
  const F = DB.ASSIGNMENTS.FIELDS;
  const params: any = { size: "200", user_field_names: "true" };

  if (productionId) {
    params[`filter__field_${F.PRODUCTION}__link_row_has`] = productionId;
  }

  const data = await fetchBaserow(`/database/rows/table/${DB.ASSIGNMENTS.ID}/`, {}, params);
  if (!Array.isArray(data)) return [];

  return data.map((row: any) => {
    const personObj = row[F.PERSON]?.[0]; 
    return {
      id: row.id,
      assignment: safeGet(row[F.ASSIGNMENT]),
      personId: personObj ? personObj.id : 0,
      personName: personObj ? personObj.value : "Unknown Actor",
    };
  });
}

export async function createCastAssignment(personId: number, roleId: number, productionId: number) {
  const body = {
    [DB.ASSIGNMENTS.FIELDS.PERSON]: [personId],
    [DB.ASSIGNMENTS.FIELDS.PERFORMANCE_IDENTITY]: [roleId],
    [DB.ASSIGNMENTS.FIELDS.PRODUCTION]: [productionId]
  };
  return await fetchBaserow(`/database/rows/table/${DB.ASSIGNMENTS.ID}/`, { 
    method: "POST", 
    body: JSON.stringify(body) 
  });
}

export async function updateCastAssignment(assignmentId: number, personId: number | null, sceneIds?: number[]) {
  const F = DB.ASSIGNMENTS.FIELDS;
  const body: any = {};

  if (personId !== undefined) {
    body[F.PERSON] = personId ? [personId] : [];
  }

  if (sceneIds !== undefined) {
    body[F.SCENE_ASSIGNMENTS] = sceneIds; 
  }

  return await fetchBaserow(`/database/rows/table/${DB.ASSIGNMENTS.ID}/${assignmentId}/`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
}

// ==============================================================================
// üìÖ SCHEDULING & SCENES
// ==============================================================================

export async function getScheduleSlots(productionId: number) {
  const F = DB.SLOTS.FIELDS;
  const events = await getProductionEvents(productionId);
  if (events.length === 0) return [];
  const eventIds = events.map((e: any) => e.id);

  const slotsData = await fetchBaserow(`/database/rows/table/${DB.SLOTS.ID}/`, {}, { size: "200", user_field_names: "true" });
  if (!Array.isArray(slotsData)) return [];

  return slotsData
    .filter((row: any) => {
        const linkedEventId = row[F.EVENT_LINK]?.[0]?.id;
        return eventIds.includes(linkedEventId);
    })
    .map((row: any) => {
      const dateDate = new Date(row[F.START_TIME]);
      const hours = dateDate.getHours() + (dateDate.getMinutes() / 60);
      const dayName = dateDate.getDay() === 5 ? 'Fri' : 'Sat';

      return {
        id: row.id.toString(),
        sceneId: row[F.SCENE]?.[0]?.id || 0,
        track: row[F.TRACK]?.value || "Acting",
        day: dayName, 
        weekOffset: 0, 
        startTime: hours,
        duration: parseInt(row[F.DURATION]) || 30,
        status: 'New'
      };
    });
}

export async function getScenes(productionId?: number) {
  const params: any = { size: "200" };
  const F = DB.SCENES.FIELDS;

  if (productionId) {
    params[`filter__${F.PRODUCTION}__link_row_has`] = productionId;
    params['order_by'] = `field_${F.ORDER}`; 
  }

  const data = await fetchBaserow(`/database/rows/table/${DB.SCENES.ID}/`, {}, params);
  if (!Array.isArray(data)) return [];

  return data.map((row: any) => ({
      id: row.id,
      order: parseInt(safeGet(row[F.ORDER], row.id)), 
      name: safeGet(row[F.SCENE_NAME], "Untitled Scene"),
      type: safeGet(row[F.SCENE_TYPE], "Scene").value || "Scene",
      status: {
        music: safeGet(row[F.MUSIC_STATUS])?.value?.toLowerCase() || "new",
        dance: safeGet(row[F.DANCE_STATUS])?.value?.toLowerCase() || "new",
        block: safeGet(row[F.BLOCKING_STATUS])?.value?.toLowerCase() || "new",
      },
      load: {
        music: parseInt(safeGet(row[F.MUSIC_LOAD], 0)),
        dance: parseInt(safeGet(row[F.DANCE_LOAD], 0)),
        block: parseInt(safeGet(row[F.BLOCKING_LOAD], 0)),
      }
  })).sort((a: any, b: any) => a.order - b.order);
}

export async function getProductionEvents(productionId: number) {
  const F = DB.EVENTS.FIELDS;
  const params = {
    size: "200",
    [`filter__${F.PRODUCTION}__link_row_has`]: productionId,
    order_by: `field_${F.EVENT_DATE}`
  };

  const data = await fetchBaserow(`/database/rows/table/${DB.EVENTS.ID}/`, {}, params);
  if (!Array.isArray(data)) return [];

  return data.map((row: any) => ({
    id: row.id,
    date: row[F.EVENT_DATE],
    startTime: row[F.START_TIME],
    endTime: row[F.END_TIME],
    type: safeGet(row[F.EVENT_TYPE], "Rehearsal"),
    isRequired: safeGet(row[F.IS_REQUIRED]),
  }));
}

// ==============================================================================
// üõ†Ô∏è ASSETS & RESOURCES
// ==============================================================================

export async function getProductionAssets(productionId?: number) {
  const params: any = { size: "200" };
  const F = DB.ASSETS.FIELDS;
  if (productionId) {
    params[`filter__${F.PRODUCTION}__link_row_has`] = productionId;
  }

  const data = await fetchBaserow(`/database/rows/table/${DB.ASSETS.ID}/`, {}, params);
  if (!Array.isArray(data)) return [];

  return data.map((row: any) => ({
    id: row.id,
    name: safeGet(row[F.NAME], "Untitled Asset"),
    link: safeGet(row[F.LINK], "#"),
    type: safeGet(row[F.TYPE], "Prop"),
  }));
}

export async function createProductionAsset(name: string, url: string, type: string, productionId: number) {
  const body = {
    [DB.ASSETS.FIELDS.NAME]: name,
    [DB.ASSETS.FIELDS.LINK]: url,
    [DB.ASSETS.FIELDS.TYPE]: type,
    [DB.ASSETS.FIELDS.PRODUCTION]: [productionId]
  };
  return await fetchBaserow(`/database/rows/table/${DB.ASSETS.ID}/`, { 
    method: "POST", 
    body: JSON.stringify(body) 
  });
}

// ==============================================================================
// üë• PEOPLE, STAFF & COMMITTEES
// ==============================================================================

export async function getCastDemographics() {
  const data = await fetchBaserow(`/database/rows/table/${DB.PEOPLE.ID}/`, {}, { size: "200" });
  if (!Array.isArray(data)) return [];

  return data.map((row: any) => ({
    id: row.id,
    name: safeGet(row[DB.PEOPLE.FIELDS.FULL_NAME] || row[DB.PEOPLE.FIELDS.FIRST_NAME]),
    age: parseFloat(safeGet(row[DB.PEOPLE.FIELDS.AGE], 0)),
    height: parseFloat(safeGet(row[DB.PEOPLE.FIELDS.HEIGHT_TOTAL_INCHES], 0)),
    showCount: Array.isArray(row[DB.PEOPLE.FIELDS.CAST_CREW_ASSIGNMENTS]) ? row[DB.PEOPLE.FIELDS.CAST_CREW_ASSIGNMENTS].length : 0,
    gender: safeGet(row[DB.PEOPLE.FIELDS.GENDER], "Unknown"),
  }));
}

export async function getCreativeTeam(productionId?: number) {
  const params: any = { size: "100" };
  if (productionId) {
    params[`filter__${DB.SHOW_TEAM.FIELDS.PRODUCTIONS}__link_row_has`] = productionId;
  }

  const data = await fetchBaserow(`/database/rows/table/${DB.SHOW_TEAM.ID}/`, {}, params);
  if (!Array.isArray(data)) return [];

  return data.map((row: any) => {
      const name = safeGet(row[DB.SHOW_TEAM.FIELDS.PERSON], "");
      const role = safeGet(row[DB.SHOW_TEAM.FIELDS.POSITION], "Volunteer");
      if (!name) return null;
      return {
        id: row.id,
        name: name,
        role: role,
        initials: name.split(' ').map((n:string) => n[0]).join('').substring(0, 2).toUpperCase(),
        color: role.toLowerCase().includes('director') ? 'bg-blue-600' : 'bg-zinc-600'
      };
    }).filter(Boolean); 
}

export async function getProductionConflicts(productionId: number) {
  const F = DB.CONFLICTS.FIELDS;
  const params = {
    size: "200",
    [`filter__${F.PRODUCTION}__link_row_has`]: productionId,
  };

  const data = await fetchBaserow(`/database/rows/table/${DB.CONFLICTS.ID}/`, {}, params);
  if (!Array.isArray(data)) return [];

  return data.map((row: any) => ({
      id: row.id,
      personId: safeId(row[F.PERSON]),
      personName: extractName(row[F.PERSON], "Unknown Person"),
      type: safeGet(row[F.CONFLICT_TYPE], "Absent"),
      minutes: parseInt(safeGet(row[F.MINUTES_LATE_EARLY], 0)),
      notes: safeGet(row[F.NOTES], ""),
      date: Array.isArray(row[F.DATE]) ? row[F.DATE][0]?.value : row[F.DATE],
  }));
}

export async function getCommitteeData(productionId?: number) {
  const params: any = { size: "200" };
  const F = DB.COMMITTEE_PREFS.FIELDS;
  
  if(productionId) params[`filter__${F.PRODUCTION}__link_row_has`] = productionId;

  const data = await fetchBaserow(`/database/rows/table/${DB.COMMITTEE_PREFS.ID}/`, {}, params);
  if (!Array.isArray(data)) return [];

  return data.map((row: any) => ({
    id: row.id,
    name: extractName(row[F.STUDENT_NAME] || row[F.STUDENT_ID]),
    studentName: extractName(row[F.STUDENT_NAME] || row[F.STUDENT_ID]),
    preShow1: safeGet(row[F.PRE_SHOW_1ST]),
    preShow2: safeGet(row[F.PRE_SHOW_2ND]), 
    showWeek1: safeGet(row[F.SHOW_WEEK_1ST]),
    showWeek2: safeGet(row[F.SHOW_WEEK_2ND]),
    email: safeGet(row[F.EMAIL]),
    phone: safeGet(row[F.PHONE]),
    assigned: safeGet(row[F.SHOW_WEEK_COMMITTEES], ""), 
  }));
}

export async function getCommitteePreferences() {
  return fetchBaserow(`/database/rows/table/${DB.COMMITTEE_PREFS.ID}/`);
}

export async function getConflicts(id?: any) {
  return fetchBaserow(`/database/rows/table/${DB.CONFLICTS.ID}/`);
}

export async function getComplianceData(productionId?: number) {
  return fetchBaserow(`/database/rows/table/${DB.PEOPLE.ID}/`);
}

// ==============================================================================
// üé§ AUDITIONS (READ & WRITE)
// ==============================================================================

export async function getAuditionees(productionId?: number) {
  const params: any = { size: "200" };
  const F = DB.AUDITIONS.FIELDS;
  
  if(productionId) params[`filter__${F.PRODUCTION}__link_row_has`] = productionId;
  
  const data = await fetchBaserow(`/database/rows/table/${DB.AUDITIONS.ID}/`, {}, params);
  if (!Array.isArray(data)) return [];

  return data.map((row: any) => ({
      id: row.id,
      name: extractName(row[F.PERFORMER], "Unknown Actor"),
      studentId: safeId(row[F.PERFORMER]),
      date: row[F.DATE] || null, 
      headshot: row[F.HEADSHOT]?.[0]?.url || null,
      video: row[F.AUDITION_VIDEO]?.[0]?.url || row[F.DANCE_VIDEO] || null,
      vocalScore: safeGet(row[F.VOCAL_SCORE], 0),
      actingScore: safeGet(row[F.ACTING_SCORE], 0),
      danceScore: safeGet(row[F.DANCE_SCORE], 0),
      presenceScore: safeGet(row[F.STAGE_PRESENCE_SCORE], 0),
      age: safeGet(row[F.AGE], "?"),
      height: safeGet(row[F.HEIGHT], ""),
      conflicts: safeGet(row[F.CONFLICTS], "No known conflicts"),
      gender: safeGet(row[F.GENDER], "Unknown"),
      actingNotes: safeGet(row[F.ACTING_NOTES], "No notes."),
      musicNotes: safeGet(row[F.MUSIC_NOTES], "No notes."),
      choreoNotes: safeGet(row[F.CHOREOGRAPHY_NOTES], "No notes."),
      status: !row[F.DATE] ? "Walk-In" : "Scheduled",
  }));
}

export async function submitAudition(studentId: number, productionId: number, extraData: any) {
    const F = DB.AUDITIONS.FIELDS;
    
    const payload: any = {
        [F.PERFORMER]: [studentId],
        [F.PRODUCTION]: [productionId],
        [F.DATE]: new Date().toISOString(),
        [F.VOCAL_SCORE]: extraData.vocal || 0,
        [F.ACTING_SCORE]: extraData.acting || 0,
        [F.DANCE_SCORE]: extraData.dance || 0,
        [F.STAGE_PRESENCE_SCORE]: extraData.presence || 0,
        [F.ACTING_NOTES]: extraData.notes || "" 
    };
    
    return await fetchBaserow(`/database/rows/table/${DB.AUDITIONS.ID}/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });
}

export async function updateAuditionSlot(rowId: number, data: any) {
    return await fetchBaserow(`/database/rows/table/${DB.AUDITIONS.ID}/${rowId}/?user_field_names=true`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });
}

export async function updateRole(roleId: number, data: any) {
  return await fetchBaserow(`/database/rows/table/${DB.ROLES.ID}/${roleId}/`, { 
    method: "PATCH", 
    body: JSON.stringify(data) 
  });
}

// ==============================================================================
// üîê AUTHENTICATION & USER
// ==============================================================================

export async function findUserByEmail(email: string) {
  const params = {
    filter_type: "OR",
    size: "1",
    [`filter__${DB.PEOPLE.FIELDS.CYT_ACCOUNT_PERSONAL_EMAIL}__equal`]: email,
    [`filter__${DB.PEOPLE.FIELDS.CYT_NATIONAL_INDIVIDUAL_EMAIL}__equal`]: email,
  };

  const results = await fetchBaserow(`/database/rows/table/${DB.PEOPLE.ID}/`, {}, params);
  
  if (!results || results.length === 0) return null;
  
  const row = results[0];
  return {
    id: row.id.toString(),
    name: safeGet(row[DB.PEOPLE.FIELDS.FULL_NAME]),
    email: email,
    image: row[DB.PEOPLE.FIELDS.HEADSHOT]?.[0]?.url || null,
    role: safeGet(row[DB.PEOPLE.FIELDS.STATUS]),
  };
}

export async function verifyUserCredentials(email: string, password: string) {
  const user = await findUserByEmail(email);
  if (!user) return null;
  return user; 
}

export async function getUserProfile(email: string) {
  const userRows = await fetchBaserow(`/database/rows/table/${DB.PEOPLE.ID}/`, {}, {
    filter_type: "OR",
    size: "1",
    [`filter__${DB.PEOPLE.FIELDS.CYT_ACCOUNT_PERSONAL_EMAIL}__equal`]: email,
    [`filter__${DB.PEOPLE.FIELDS.CYT_NATIONAL_INDIVIDUAL_EMAIL}__equal`]: email,
  });

  if (!userRows || userRows.length === 0) return null;

  const user = userRows[0];
  const familyLink = user[DB.PEOPLE.FIELDS.FAMILIES]; 
  
  const profile = {
    id: user.id.toString(),
    name: safeGet(user[DB.PEOPLE.FIELDS.FULL_NAME]),
    email: email,
    phone: safeGet(user[DB.PEOPLE.FIELDS.PHONE_NUMBER]),
    address: `${safeGet(user[DB.PEOPLE.FIELDS.ADDRESS])}, ${safeGet(user[DB.PEOPLE.FIELDS.CITY])}`,
    role: safeGet(user[DB.PEOPLE.FIELDS.STATUS], "User"),
    image: user[DB.PEOPLE.FIELDS.HEADSHOT]?.[0]?.url || null,
    familyMembers: [] as any[]
  };

  if (Array.isArray(familyLink) && familyLink.length > 0) {
    const familyId = familyLink[0].id;
    const familyData = await fetchBaserow(`/database/rows/table/${DB.PEOPLE.ID}/`, {}, {
      [`filter__${DB.PEOPLE.FIELDS.FAMILIES}__link_row_has`]: familyId,
      size: "20"
    });

    if (Array.isArray(familyData)) {
      profile.familyMembers = familyData
        .filter((member: any) => member.id !== user.id) 
        .map((member: any) => ({
          id: member.id,
          name: safeGet(member[DB.PEOPLE.FIELDS.FULL_NAME]),
          role: safeGet(member[DB.PEOPLE.FIELDS.STATUS], "Student"),
          age: parseInt(safeGet(member[DB.PEOPLE.FIELDS.AGE], 0)),
          image: member[DB.PEOPLE.FIELDS.HEADSHOT]?.[0]?.url || null,
        }));
    }
  }

  return profile;
}

export async function getUserProductionRole(userId: number, productionId: number) {
  const params = {
    filter_type: "AND",
    [`filter__${DB.SHOW_TEAM.FIELDS.PERSON}__link_row_has`]: userId,
    [`filter__${DB.SHOW_TEAM.FIELDS.PRODUCTIONS}__link_row_has`]: productionId,
  };

  const rows = await fetchBaserow(`/database/rows/table/${DB.SHOW_TEAM.ID}/`, {}, params);

  if (!rows || rows.length === 0) return null;
  return safeGet(rows[0][DB.SHOW_TEAM.FIELDS.POSITION]); 
}

// ==============================================================================
// üìä ANALYTICS
// ==============================================================================

export async function getPerformanceAnalytics(productionId?: number) {
  const data = await fetchBaserow(`/database/rows/table/${DB.PERFORMANCES.ID}/`, {}, { size: "200" });
  if (!Array.isArray(data)) return [];

  return data.map((row: any) => {
    const sold = parseFloat(safeGet(row[DB.PERFORMANCES.FIELDS.TICKETS_SOLD], 0));
    const capacity = parseFloat(safeGet(row[DB.PERFORMANCES.FIELDS.TOTAL_INVENTORY], 0));
    return {
      name: safeGet(row[DB.PERFORMANCES.FIELDS.PERFORMANCE], "Show"),
      sold: sold,
      capacity: capacity,
      empty: Math.max(0, capacity - sold),
      fillRate: capacity > 0 ? Math.round((sold / capacity) * 100) : 0,
    };
  });
}

export async function getGlobalSalesSummary() {
  const data = await getPerformanceAnalytics();
  if (data.length === 0) return { totalSold: 0, avgFill: 0 };
  
  const totalSold = data.reduce((sum: number, p: any) => sum + p.sold, 0);
  const avgFill = Math.round(data.reduce((sum: number, p: any) => sum + p.fillRate, 0) / data.length);
  
  return { totalSold, avgFill, performanceCount: data.length };
}

export { DB };
</file>

</files>
